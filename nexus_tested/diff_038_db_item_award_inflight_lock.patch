--- a/server/metin2/Source/Server/db/src/ClientManager.cpp
+++ b/server/metin2/Source/Server/db/src/ClientManager.cpp
@@ -1,4 +1,5 @@
 #include "stdafx.h"

+#include <set>

 

 #include "../../common/building.h"

 #include "../../common/VnumHelper.h"

@@ -726,6 +727,37 @@
 		CreateItemTableFromRes(msg->Get()->pSQLResult, &s_items, pi->account_id);

 

 		ItemAwardSet* pSet = ItemAwardManager::instance().GetByLogin(pi->login);

+

+		// Anti-dupe hardening: prevent duplicate/concurrent processing of item_award for the same login.

+		struct _ItemAwardCheckoutGuard

+		{

+			static std::set<std::string>& Set()

+			{

+				static std::set<std::string> s_inflight;

+				return s_inflight;

+			}

+			std::string login;

+			bool active;

+			_ItemAwardCheckoutGuard(const char* szLogin) : login(szLogin ? szLogin : ""), active(false)

+			{

+				auto& s = Set();

+				if (!login.empty() && s.insert(login).second)

+					active = true;

+			}

+			~_ItemAwardCheckoutGuard()

+			{

+				if (!active) return;

+				auto& s = Set();

+				s.erase(login);

+			}

+			operator bool() const { return active; }

+		};

+		_ItemAwardCheckoutGuard _award_guard(pi->login);

+		if (pSet && !_award_guard)

+		{

+			sys_log(0, "ItemAward checkout skipped (already in progress): %s", pi->login);

+			pSet = NULL;

+		}

 

 		if (pSet && !m_vec_itemTable.empty())

 		{
