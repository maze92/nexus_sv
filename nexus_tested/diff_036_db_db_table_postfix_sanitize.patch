--- a/server/metin2/Source/Server/db/src/Main.cpp
+++ b/server/metin2/Source/Server/db/src/Main.cpp
@@ -1,4 +1,5 @@
 #include "stdafx.h"

+#include <cctype>

 #include "Config.h"

 #include "Peer.h"

 #include "DBManager.h"

@@ -25,8 +26,37 @@
 #endif

 

 void SetPlayerDBName(const char* c_pszPlayerDBName);

-void SetTablePostfix(const char* c_pszTablePostfix);

-int Start();

+void SetTablePostfix(const char* c_pszTablePostfix)

+{

+	if (!c_pszTablePostfix)

+	{

+		s_szTablePostfix[0] = '\0';

+		return;

+	}

+

+	// Security: table postfix must be short and strictly alnum/underscore to prevent SQL injection via table names.

+	// (Even if you do not expose this value to clients, config tampering should not be able to inject SQL.)

+	const size_t len = strnlen(c_pszTablePostfix, 32);

+	if (len == 0 || len > 10)

+	{

+		sys_err("Table postfix rejected (len=%zu): '%s'", len, c_pszTablePostfix);

+		s_szTablePostfix[0] = '\0';

+		return;

+	}

+

+	for (size_t i = 0; i < len; ++i)

+	{

+		const unsigned char c = static_cast<unsigned char>(c_pszTablePostfix[i]);

+		if (!(isalnum(c) || c == '_'))

+		{

+			sys_err("Table postfix rejected (bad char 0x%02X): '%s'", c, c_pszTablePostfix);

+			s_szTablePostfix[0] = '\0';

+			return;

+		}

+	}

+

+	strlcpy(s_szTablePostfix, c_pszTablePostfix, sizeof(s_szTablePostfix));

+}

 

 std::string g_stTablePostfix;

 std::string g_stLocaleNameColumn = "name";
