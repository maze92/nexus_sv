--- a/server/metin2/Source/Server/game/src/shop.cpp
+++ b/server/metin2/Source/Server/game/src/shop.cpp
@@ -1,4 +1,5 @@
 #include "stdafx.h"

+#include <limits>

 #include "../../libgame/include/grid.h"

 #include "constants.h"

 #include "utils.h"

@@ -310,12 +311,24 @@
 	DWORD dwCheque = r_item.cheque;

 #endif

 

+	// Overflow-safe price scaling (DWORD wraps at ~4.29B)

+	uint64_t ullPrice = static_cast<uint64_t>(dwPrice);

 	if (it->second) // if other empire, price is triple

-		dwPrice *= 3;

-

-	if (ch->GetGold() < dwPrice)

-	{

-		sys_log(1, "Shop::Buy : Not enough money : %s has %lld, price %u", ch->GetName(), ch->GetGold(), dwPrice);

+		ullPrice *= 3;

+	if (ullPrice > static_cast<uint64_t>(std::numeric_limits<DWORD>::max()))

+	{

+		LogManager::instance().HackLog("SHOP_BUY_PRICE_OVERFLOW", ch);

+		return SHOP_SUBHEADER_GC_NOT_ENOUGH_MONEY;

+	}

+	DWORD dwBuyerPrice = static_cast<DWORD>(ullPrice);

+	

+	// Preserve dwPrice as buyer price for checks; dwPrice will later be reused as seller gain (after tax)

+	dwPrice = dwBuyerPrice;

+

+

+	if (ch->GetGold() < dwBuyerPrice)

+	{

+		sys_log(1, "Shop::Buy : Not enough money : %s has %lld, price %u", ch->GetName(), ch->GetGold(), dwBuyerPrice);

 		return SHOP_SUBHEADER_GC_NOT_ENOUGH_MONEY;

 	}

 

@@ -377,7 +390,7 @@
 	}

 

 	if (dwPrice)

-		ch->PointChange(POINT_GOLD, -dwPrice, false);

+		ch->PointChange(POINT_GOLD, -static_cast<long long>(dwBuyerPrice), false);

 

 #if defined(__CHEQUE_SYSTEM__)

 	if (dwCheque)

@@ -395,13 +408,19 @@
 			if (iVal > 100)

 				iVal = 100;

 

-			dwTax = dwPrice * iVal / 100;

+			{

+				const uint64_t ullTax = (static_cast<uint64_t>(dwPrice) * static_cast<uint64_t>(iVal)) / 100;

+				dwTax = static_cast<DWORD>(MIN(ullTax, static_cast<uint64_t>(dwPrice)));

+			}

 			dwPrice = dwPrice - dwTax;

 		}

 		else

 		{

 			iVal = 3;

-			dwTax = dwPrice * iVal / 100;

+			{

+				const uint64_t ullTax = (static_cast<uint64_t>(dwPrice) * static_cast<uint64_t>(iVal)) / 100;

+				dwTax = static_cast<DWORD>(MIN(ullTax, static_cast<uint64_t>(dwPrice)));

+			}

 			dwPrice = dwPrice - dwTax;

 		}

 	}

@@ -414,7 +433,10 @@
 			if (iVal > 100)

 				iVal = 100;

 

-			dwTax = dwPrice * iVal / 100;

+			{

+				const uint64_t ullTax = (static_cast<uint64_t>(dwPrice) * static_cast<uint64_t>(iVal)) / 100;

+				dwTax = static_cast<DWORD>(MIN(ullTax, static_cast<uint64_t>(dwPrice)));

+			}

 			dwPrice = dwPrice - dwTax;

 		}

 		else
