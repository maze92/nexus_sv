diff -ruN baseline/server/server/home/metin2/Server/db/item_names.txt final/server/server/home/metin2/Server/db/item_names.txt
--- baseline/server/server/home/metin2/Server/db/item_names.txt	1970-01-01 00:00:00.000000000 +0000
+++ final/server/server/home/metin2/Server/db/item_names.txt	2026-02-20 18:06:38.029130578 +0000
@@ -0,0 +1,62 @@
+55001	Protein Snack
+55002	Transport Box
+55003	Young Pet Book
+55004	Wild Pet Book
+55005	Valiant Pet Book
+55006	NoNAme
+55007	NoNAme
+55008	Pet Name Scroll
+55009	Pet Book Chest
+55010	Resistance (Warrior)
+55011	Resistance (Sura)
+55012	Resistance (Ninja)
+55013	Resistance (Shaman)
+55014	Resistance (Lycan)
+55015	Berserker Book
+55016	Anti-Magic Book
+55017	Haste Book
+55018	Drill Book
+55019	Restoration Book
+55020	Vampirism Book
+55021	Spiritualism Book
+55022	Bulwark Book
+55023	Reflection Book
+55024	Yang Drop Book
+55025	Range Book
+55026	Immortal Book
+55027	Panacea Book
+55028	Tasty Treat
+55029	Pet Reverti
+55030	Pet Revertus
+55031	Tasty Treat+
+55032	Pet Destiny Orb
+55033	Enchant Pet
+55034	Master Brewer Book
+55035	Monster Hunter Book
+55036	Eagle Eyes Book
+55037	Life Drain Book
+55038	Light as a Feather Book
+55100	Divine Protein Bites
+55400	Mystery Box
+55401	Monkey Egg
+55402	Spider Egg
+55403	Razador's Egg
+55404	Nemere's Egg
+55405	Blue Dragon Egg
+55406	Red Dragon Egg
+55407	Mini Azrael's Egg
+55408	Fat Mini Executor Egg
+55409	Baby Baashido's Egg
+55410	Nessie Egg
+55411	Exedyar's Egg
+55701	Mini Monkey
+55702	Mini Spider
+55703	Mini Razador
+55704	Mini Nemere
+55705	Dragonette
+55706	Mini Meley
+55707	Mini Azrael
+55708	Fat Mini Executor
+55709	Baby Baashido
+55710	Nessie
+55711	Exedyar Brood
\ No newline at end of file
diff -ruN baseline/server/server/home/metin2/Server/db/item_proto.txt final/server/server/home/metin2/Server/db/item_proto.txt
--- baseline/server/server/home/metin2/Server/db/item_proto.txt	1970-01-01 00:00:00.000000000 +0000
+++ final/server/server/home/metin2/Server/db/item_proto.txt	2026-02-20 18:06:38.029584908 +0000
@@ -0,0 +1,62 @@
+55001	Æê »ç·á	ITEM_PET	PET_FEEDSTUFF	1	ANTI_DROP | ANTI_SELL | ANTI_PKDROP	ITEM_STACKABLE	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	0	0	0	0	0	0	0	0	0
+55002	Æê °¡¹æ	ITEM_PET	PET_BAG	1	ANTI_DROP | ANTI_SELL | ANTI_PKDROP | ANTI_STACK | ANTI_MYSHOP | ANTI_RT_REMOVE	LOG	NONE	NONE	0	0	0	0	0	REAL_TIME_FIRST_USE	2592000	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	0	0	0	0	0	0	0	0	0
+55003	»çÀ°ºñ¼­-1Æí	ITEM_MATERIAL	MATERIAL_LEATHER	1	NONE	ITEM_STACKABLE	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	0	0	0	0	0	0	0	0	0
+55004	»çÀ°ºñ¼­-2Æí	ITEM_MATERIAL	MATERIAL_LEATHER	1	NONE	ITEM_STACKABLE	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	0	0	0	0	0	0	0	0	0
+55005	Á¶·Ãºñ¼­-1Æí	ITEM_MATERIAL	MATERIAL_LEATHER	1	NONE	ITEM_STACKABLE	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	0	0	0	0	0	0	0	0	0
+55006	Á¶·Ãºñ¼­-2Æí	ITEM_MATERIAL	MATERIAL_LEATHER	1	NONE	ITEM_STACKABLE	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	0	0	0	0	0	0	0	0	0
+55007	Á¶·Ãºñ¼­-3Æí	ITEM_MATERIAL	MATERIAL_LEATHER	1	NONE	ITEM_STACKABLE	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	0	0	0	0	0	0	0	0	0
+55008	Æê ÀÌ¸§ º¯°æ±Ç	ITEM_PET	PET_NAME_CHANGE	1	ANTI_DROP | ANTI_PKDROP | ANTI_STACK | ANTI_QUICKSLOT	NONE	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	0	0	0	0	0	0	0	0	0
+55009	Æê ½ºÅ³ºÏ »óÀÚ	ITEM_GIFTBOX	0	1	NONE	ITEM_STACKABLE	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	2	0	0	0	0	0	0	0	0
+55010	Æê ½ºÅ³ºÏ(ÁöÁß)-¹«»ç	ITEM_PET	PET_SKILL	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	1	0	0	0	0	0	0	0	0
+55011	Æê ½ºÅ³ºÏ(ÁöÁß)-¼ö¶ó	ITEM_PET	PET_SKILL	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	2	0	0	0	0	0	0	0	0
+55012	Æê ½ºÅ³ºÏ(ÁöÁß)-ÀÚ°´	ITEM_PET	PET_SKILL	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	3	0	0	0	0	0	0	0	0
+55013	Æê ½ºÅ³ºÏ(ÁöÁß)-¹«´ç	ITEM_PET	PET_SKILL	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	4	0	0	0	0	0	0	0	0
+55014	Æê ½ºÅ³ºÏ(ÁöÁß)-¼öÀÎ	ITEM_PET	PET_SKILL	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	5	0	0	0	0	0	0	0	0
+55015	Æê ½ºÅ³ºÏ(ÆÄÃµ)	ITEM_PET	PET_SKILL	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	6	0	0	0	0	0	0	0	0
+55016	Æê ½ºÅ³ºÏ(Ãµ·É)	ITEM_PET	PET_SKILL	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	7	0	0	0	0	0	0	0	0
+55017	Æê ½ºÅ³ºÏ(¹Ý¾ß)	ITEM_PET	PET_SKILL	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	8	0	0	0	0	0	0	0	0
+55018	Æê ½ºÅ³ºÏ(ÃÊÈ¥ºñ¹«)	ITEM_PET	PET_SKILL	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	9	0	0	0	0	0	0	0	0
+55019	Æê ½ºÅ³ºÏ(È¸º¹)	ITEM_PET	PET_SKILL	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	10	0	0	0	0	0	0	0	0
+55020	Æê ½ºÅ³ºÏ(ÈíÀÎ)	ITEM_PET	PET_SKILL	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	11	0	0	0	0	0	0	0	0
+55021	Æê ½ºÅ³ºÏ(Èí¼ö)	ITEM_PET	PET_SKILL	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	12	0	0	0	0	0	0	0	0
+55022	Æê ½ºÅ³ºÏ(ºí·°)	ITEM_PET	PET_SKILL	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	13	0	0	0	0	0	0	0	0
+55023	Æê ½ºÅ³ºÏ(¹Ý»ç)	ITEM_PET	PET_SKILL	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	14	0	0	0	0	0	0	0	0
+55024	Æê ½ºÅ³ºÏ(µå¶ø)	ITEM_PET	PET_SKILL	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	15	0	0	0	0	0	0	0	0
+55025	Æê ½ºÅ³ºÏ(°Å¸®)	ITEM_PET	PET_SKILL	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	16	0	0	0	0	0	0	0	0
+55026	Æê ½ºÅ³ºÏ(¹«Àû)	ITEM_PET	PET_SKILL	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	17	0	0	0	0	0	0	0	0
+55027	Æê ½ºÅ³ºÏ(Á¦°Å)	ITEM_PET	PET_SKILL	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	18	0	0	0	0	0	0	0	0
+55028	Æê ¸ÔÀÌ	ITEM_PET	PET_EXPFOOD	1	ANTI_DROP | ANTI_SELL | ANTI_PKDROP	ITEM_STACKABLE	NONE	NONE	8000000	4000000	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	0	0	0	0	0	0	0	0	0
+55029	Æê ½ºÅ³ ÃÊ±âÈ­(ÀüÃ¼)	ITEM_PET	PET_SKILL_ALL_DEL_BOOK	1	NONE	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	0	0	0	0	0	0	0	0	0
+55030	Æê ½ºÅ³ ÃÊ±âÈ­(´ÜÀÏ)	ITEM_PET	PET_SKILL_DEL_BOOK	1	NONE	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	0	0	0	0	0	0	0	0	0
+55031	Æê ¸ÔÀÌ+	ITEM_PET	PET_EXPFOOD_PER	1	ANTI_DROP | ANTI_SELL | ANTI_PKDROP | ANTI_STACK	LOG	NONE	NONE	5	5	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	0	0	0	0	0	0	0	0	0
+55032	Æê °¨º°	ITEM_PET	PET_ATTR_DETERMINE	1	NONE	ITEM_STACKABLE	NONE	NONE	10000	5000	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	0	0	0	0	0	0	0	0	0
+55033	Æê ¼Ó¼ºº¯°æ	ITEM_PET	PET_ATTR_CHANGE	1	ANTI_DROP | ANTI_PKDROP	ITEM_STACKABLE	NONE	NONE	5	5	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	0	0	0	0	0	0	0	0	0
+55034	Æê ½ºÅ³ºÏ(¹°¾à)	ITEM_PET	PET_SKILL	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	19	0	0	0	0	0	0	0	0
+55035	Æê ½ºÅ³ºÏ(¸ó½ºÅÍ°­ÇÔ)	ITEM_PET	PET_SKILL	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	20	0	0	0	0	0	0	0	0
+55036	Æê ½ºÅ³ºÏ(°æÇèÄ¡)	ITEM_PET	PET_SKILL	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	21	0	0	0	0	0	0	0	0
+55037	Æê ½ºÅ³ºÏ(»ý¸í±¸)	ITEM_PET	PET_SKILL	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	22	0	0	0	0	0	0	0	0
+55038	Æê ½ºÅ³ºÏ(°æ°ø¼ú)	ITEM_PET	PET_SKILL	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	23	0	0	0	0	0	0	0	0
+55100	ÇÁ¸®¹Ì¾ö Æê»ç·á	ITEM_PET	PET_PRIMIUM_FEEDSTUFF	1	ANTI_DROP | ANTI_SELL | ANTI_PKDROP	ITEM_STACKABLE	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	0	0	0	0	0	0	0	0	0
+55400	Æê Àç·á ·£´ý¹Ú½º	ITEM_GIFTBOX	0	1	NONE	ITEM_STACKABLE	NONE	NONE	0	0	0	0	0	LIMIT_NONE	0	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	2	0	0	0	0	0	0	0	0
+55401	¿ø¼þÀÌ ¾Ë	ITEM_PET	PET_EGG	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	REAL_TIME	604800	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	55701	3	2	100000	0	0	0	0	0
+55402	°Å¹Ì ¾Ë	ITEM_PET	PET_EGG	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	REAL_TIME	604800	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	55702	3	2	100000	0	0	0	0	0
+55403	¾ß¸¶Ãµ ¾Ë	ITEM_PET	PET_EGG	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	REAL_TIME	604800	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	55703	3	2	100000	0	0	0	0	0
+55404	ÇÑ¸¶ÀÇ ¾Ë	ITEM_PET	PET_EGG	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	REAL_TIME	604800	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	55704	3	2	100000	0	0	0	0	0
+55405	¼ö·æ ¾Ë	ITEM_PET	PET_EGG	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	REAL_TIME	604800	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	55705	3	2	100000	0	0	0	0	0
+55406	Àû·æ ¾Ë	ITEM_PET	PET_EGG	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	REAL_TIME	604800	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	55706	3	2	100000	0	0	0	0	0
+55407	ÆÄÈ² ¾Ë	ITEM_PET	PET_EGG	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	REAL_TIME	604800	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	55707	3	2	100000	0	0	0	0	0
+55408	ºÓÀºµµÀû´Ü ¾Ë	ITEM_PET	PET_EGG	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	REAL_TIME	604800	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	55708	3	2	100000	0	0	0	0	0
+55409	¹é¾ç ¾Ë	ITEM_PET	PET_EGG	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	REAL_TIME	604800	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	55709	3	2	100000	0	0	0	0	0
+55410	È÷µå¶ó ¾Ë	ITEM_PET	PET_EGG	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	REAL_TIME	604800	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	55710	3	2	100000	0	0	0	0	0
+55411	¿ë¿Õ ¾Ë	ITEM_PET	PET_EGG	1	ANTI_STACK	LOG	NONE	NONE	0	0	0	0	0	REAL_TIME	604800	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	55711	3	2	100000	0	0	0	0	0
+55701	¾Æ±â ¿ø¼þÀÌ	ITEM_PET	PET_UPBRINGING	1	ANTI_DROP | ANTI_GIVE | ANTI_PKDROP | ANTI_STACK | ANTI_MYSHOP | ANTI_RT_REMOVE	LOG	NONE	NONE	0	0	0	0	0	REAL_TIME	604800	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	34041	3	2	34042	0	0	0	0	0
+55702	¾Æ±â °Å¹Ì	ITEM_PET	PET_UPBRINGING	1	ANTI_DROP | ANTI_GIVE | ANTI_PKDROP | ANTI_STACK | ANTI_MYSHOP | ANTI_RT_REMOVE	LOG	NONE	NONE	0	0	0	0	0	REAL_TIME	604800	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	34045	3	2	34046	0	0	0	0	0
+55703	¾Æ±â ¾ß¸¶Ãµ	ITEM_PET	PET_UPBRINGING	1	ANTI_DROP | ANTI_GIVE | ANTI_PKDROP | ANTI_STACK | ANTI_MYSHOP | ANTI_RT_REMOVE	LOG	NONE	NONE	0	0	0	0	0	REAL_TIME	604800	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	34049	3	2	34050	0	0	0	0	0
+55704	¾Æ±â ÇÑ¸¶ÀÇ	ITEM_PET	PET_UPBRINGING	1	ANTI_DROP | ANTI_GIVE | ANTI_PKDROP | ANTI_STACK | ANTI_MYSHOP | ANTI_RT_REMOVE	LOG	NONE	NONE	0	0	0	0	0	REAL_TIME	604800	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	34053	3	2	34054	0	0	0	0	0
+55705	¾Æ±â ¼ö·æ	ITEM_PET	PET_UPBRINGING	1	ANTI_DROP | ANTI_GIVE | ANTI_PKDROP | ANTI_STACK | ANTI_MYSHOP | ANTI_RT_REMOVE	LOG	NONE	NONE	0	0	0	0	0	REAL_TIME	604800	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	34036	3	2	34037	0	0	0	0	0
+55706	¾Æ±â Àû·æ	ITEM_PET	PET_UPBRINGING	1	ANTI_DROP | ANTI_GIVE | ANTI_PKDROP | ANTI_STACK | ANTI_MYSHOP | ANTI_RT_REMOVE	LOG	NONE	NONE	0	0	0	0	0	REAL_TIME	604800	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	34064	3	2	34065	0	0	0	0	0
+55707	¾Æ±â ÆÄÈ²	ITEM_PET	PET_UPBRINGING	1	ANTI_DROP | ANTI_GIVE | ANTI_PKDROP | ANTI_STACK | ANTI_MYSHOP | ANTI_RT_REMOVE	LOG	NONE	NONE	0	0	0	0	0	REAL_TIME	604800	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	34073	3	2	34074	0	0	0	0	0
+55708	¾Æ±â ºÓÀºµµÀû´Ü	ITEM_PET	PET_UPBRINGING	1	ANTI_DROP | ANTI_GIVE | ANTI_PKDROP | ANTI_STACK | ANTI_MYSHOP | ANTI_RT_REMOVE	LOG	NONE	NONE	0	0	0	0	0	REAL_TIME	604800	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	34075	3	2	34076	0	0	0	0	0
+55709	¾Æ±â ¹é¾ç	ITEM_PET	PET_UPBRINGING	1	ANTI_DROP | ANTI_GIVE | ANTI_PKDROP | ANTI_STACK | ANTI_MYSHOP | ANTI_RT_REMOVE	LOG	NONE	NONE	0	0	0	0	0	REAL_TIME	604800	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	34080	3	2	34081	0	0	0	0	0
+55710	¾Æ±â È÷µå¶ó	ITEM_PET	PET_UPBRINGING	1	ANTI_DROP | ANTI_GIVE | ANTI_PKDROP | ANTI_STACK | ANTI_MYSHOP | ANTI_RT_REMOVE	LOG	NONE	NONE	0	0	0	0	0	REAL_TIME	604800	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	34082	3	2	34083	0	0	0	0	0
+55711	¾Æ±â ¿ë¿Õ	ITEM_PET	PET_UPBRINGING	1	ANTI_DROP | ANTI_GIVE | ANTI_STACK | ANTI_MYSHOP | ANTI_RT_REMOVE	LOG	NONE	NONE	0	0	0	0	0	REAL_TIME	604800	LIMIT_NONE	0	APPLY_NONE	0	APPLY_NONE	0	APPLY_NONE	0	34047	3	2	34048	0	0	0	0	0
\ No newline at end of file
diff -ruN baseline/server/server/home/metin2/Server/db/mob_names.txt final/server/server/home/metin2/Server/db/mob_names.txt
--- baseline/server/server/home/metin2/Server/db/mob_names.txt	1970-01-01 00:00:00.000000000 +0000
+++ final/server/server/home/metin2/Server/db/mob_names.txt	2026-02-20 18:06:38.030058460 +0000
@@ -0,0 +1,22 @@
+34036	Dragonette
+34037	Dragonette (Hero)
+34041	Mini Monkey
+34042	Mini Monkey (Hero)
+34045	Mini Spider
+34046	Mini Spider (Hero)
+34047	Exedyar Brood
+34048	Exedyar Rare Brood
+34049	Mini Razador
+34050	Mini Razador (Hero)
+34053	Mini Nemere
+34054	Mini Nemere (Hero)
+34064	Mini Meley
+34065	Mini Meley
+34073	Mini Azrael
+34074	Mini Azrael (Hero)
+34075	Fat Mini Executor
+34076	Fat Mini Executor (Hero)
+34080	Baby Baashido
+34081	Baby Baashido (Hero)
+34082	Nessie
+34083	Nessie (Hero)
\ No newline at end of file
diff -ruN baseline/server/server/home/metin2/Server/db/mob_proto.txt final/server/server/home/metin2/Server/db/mob_proto.txt
--- baseline/server/server/home/metin2/Server/db/mob_proto.txt	1970-01-01 00:00:00.000000000 +0000
+++ final/server/server/home/metin2/Server/db/mob_proto.txt	2026-02-20 18:06:38.030603668 +0000
@@ -0,0 +1,22 @@
+34036	¾Æ±â ¼ö·æ	KING	PET	MELEE	1	100			0		STUN,SLOW,CURSE,TERROR	0		2	0	0	0	0	0	0	120	3	1	0	0	40	4	100	100	0	2000	150	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
+34037	Æ¯¼ö ¾Æ±â ¼ö·æ	KING	PET	MELEE	1	100			0		STUN,SLOW,CURSE,TERROR	0		2	0	0	0	0	0	0	120	3	1	0	0	40	4	100	100	0	2000	150	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
+34041	¾Æ±â ¿ø¼þÀÌ	KING	PET	MELEE	1	100			0		STUN,SLOW,CURSE,TERROR	0		2	0	0	0	0	0	0	120	3	1	0	0	40	4	100	100	0	2000	150	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
+34042	Æ¯¼ö ¾Æ±â ¿ø¼þÀÌ	KING	PET	MELEE	1	100			0		STUN,SLOW,CURSE,TERROR	0		2	0	0	0	0	0	0	120	3	1	0	0	40	4	100	100	0	2000	150	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
+34045	¾Æ±â °Å¹Ì	KING	PET	MELEE	1	100			0		STUN,SLOW,CURSE,TERROR	0		2	0	0	0	0	0	0	120	3	1	0	0	40	4	100	100	0	2000	150	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
+34046	Æ¯¼ö ¾Æ±â °Å¹Ì	KING	PET	MELEE	1	100			0		STUN,SLOW,CURSE,TERROR	0		2	0	0	0	0	0	0	120	3	1	0	0	40	4	100	100	0	2000	150	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
+34047	¾Æ±â ¿ë¿Õ	KING	PET	MELEE	1	100			0		STUN,SLOW,TERROR	0		2	0	0	0	0	0	0	120	3	1	0	0	10	4	100	100	0	2000	150	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
+34048	Æ¯¼ö ¾Æ±â ¿ë¿Õ	KING	PET	MELEE	1	100			0		STUN,SLOW,TERROR	0		2	0	0	0	0	0	0	120	3	1	0	0	10	4	100	100	0	2000	150	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
+34049	¾Æ±â ¾ß¸¶Ãµ	KING	PET	MELEE	1	100			0		STUN,SLOW,CURSE,TERROR	0		2	0	0	0	0	0	0	120	3	1	0	0	40	4	100	100	0	2000	150	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
+34050	Æ¯¼ö ¾Æ±â ¾ß¸¶Ãµ	KING	PET	MELEE	1	100			0		STUN,SLOW,CURSE,TERROR	0		2	0	0	0	0	0	0	120	3	1	0	0	40	4	100	100	0	2000	150	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
+34053	¾Æ±â ÇÑ¸¶ÀÇ	KING	PET	MELEE	1	100			0		STUN,SLOW,CURSE,TERROR	0		2	0	0	0	0	0	0	120	3	1	0	0	40	4	100	100	0	2000	150	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
+34054	Æ¯¼ö ¾Æ±â ÇÑ¸¶ÀÇ	KING	PET	MELEE	1	100			0		STUN,SLOW,CURSE,TERROR	0		2	0	0	0	0	0	0	120	3	1	0	0	40	4	100	100	0	2000	150	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
+34064	¾Æ±â Àû·æ	KING	PET	MELEE	1	100			0		STUN,SLOW,TERROR	0		2	0	0	0	0	0	0	120	3	1	0	0	40	4	100	100	0	2000	150	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
+34065	Æ¯¼ö ¾Æ±â Àû·æ	KING	PET	MELEE	1	100			0		STUN,SLOW,TERROR	0		2	0	0	0	0	0	0	120	3	1	0	0	40	4	100	100	0	2000	150	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
+34073	¾Æ±â ÆÄÈ²	KING	PET	MELEE	1	100			0		STUN,SLOW,TERROR	0		2	0	0	0	0	0	0	120	3	1	0	0	40	4	100	100	0	2000	150	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
+34074	Æ¯¼ö ¾Æ±â ÆÄÈ²	KING	PET	MELEE	1	100			0		STUN,SLOW,TERROR	0		2	0	0	0	0	0	0	120	3	1	0	0	40	4	100	100	0	2000	150	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
+34075	¾Æ±â ºÓÀºµµÀû´Ü	KING	PET	MELEE	1	100			0		STUN,SLOW,TERROR	0		2	0	0	0	0	0	0	120	3	1	0	0	40	4	100	100	0	2000	150	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
+34076	Æ¯¼ö ¾Æ±â ºÓÀºµµÀû´Ü	KING	PET	MELEE	1	100			0		STUN,SLOW,TERROR	0		2	0	0	0	0	0	0	120	3	1	0	0	40	4	100	100	0	2000	150	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
+34080	¾Æ±â ¹é¾ç	KING	PET	MELEE	1	100			0		STUN,SLOW,TERROR	0		2	0	0	0	0	0	0	120	3	1	0	0	40	4	100	100	0	2000	150	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
+34081	Æ¯¼ö ¾Æ±â ¹é¾ç	KING	PET	MELEE	1	100			0		STUN,SLOW,TERROR	0		2	0	0	0	0	0	0	120	3	1	0	0	40	4	100	100	0	2000	150	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
+34082	¾Æ±â È÷µå¶ó	KING	PET	MELEE	1	100			0		STUN,SLOW,TERROR	0		2	0	0	0	0	0	0	120	3	1	0	0	40	4	100	100	0	2000	150	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
+34083	Æ¯¼ö ¾Æ±â È÷µå¶ó	KING	PET	MELEE	1	100			0		STUN,SLOW,TERROR	0		2	0	0	0	0	0	0	120	3	1	0	0	40	4	100	100	0	2000	150	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0.0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0
diff -ruN baseline/server/server/home/metin2/Server/share/locale/uk/quest/growth_pet_system.quest final/server/server/home/metin2/Server/share/locale/uk/quest/growth_pet_system.quest
--- baseline/server/server/home/metin2/Server/share/locale/uk/quest/growth_pet_system.quest	1970-01-01 00:00:00.000000000 +0000
+++ final/server/server/home/metin2/Server/share/locale/uk/quest/growth_pet_system.quest	2026-02-20 18:06:17.487485653 +0000
@@ -0,0 +1,52 @@
+quest growth_pet_system begin
+	state start begin
+		function get_pet_info(itemVnum)
+			pet_info_map = {
+				[55701] = {34041, " - "..mob_name(34041).." ", 0},
+				[55702] = {34045, " - "..mob_name(34045).." ", 0},
+				[55703] = {34049, " - "..mob_name(34049).." ", 0},
+				[55704] = {34053, " - "..mob_name(34053).." ", 0},
+				[55705] = {34036, " - "..mob_name(34036).." ", 0},
+				[55706] = {34064, " - "..mob_name(34064).." ", 0},
+				[55707] = {34073, " - "..mob_name(34073).." ", 0},
+				[55708] = {34075, " - "..mob_name(34075).." ", 0},
+				[55709] = {34080, " - "..mob_name(34080).." ", 0},
+				[55710] = {34082, " - "..mob_name(34082).." ", 0},
+				[55711] = {34047, " - "..mob_name(34082).." ", 0},
+			}
+
+			itemVnum = tonumber(itemVnum)
+			return pet_info_map[itemVnum]
+		end
+
+		when
+			55701.use or
+			55702.use or
+			55703.use or
+			55704.use or
+			55705.use or
+			55706.use or
+			55707.use or
+			55708.use or
+			55709.use or
+			55710.use or
+			55711.use
+		begin
+			local pet_info = growth_pet_system.get_pet_info(item.get_vnum())
+			if nil != pet_info then
+				local mobVnum = pet_info[1]
+				local petName = pet_info[2]
+
+				if true == growth_pet.is_summon(mobVnum) then
+					growth_pet.unsummon(mobVnum)
+				else
+					if growth_pet.count_summoned() < 1 then
+						growth_pet.summon(mobVnum, petName, false)
+					else
+						syschat(gameforge[LC()][7638])
+					end
+				end
+			end
+		end
+	end
+end
diff -ruN baseline/server/server/home/metin2/Server/share/locale/uk/special_item_group.txt final/server/server/home/metin2/Server/share/locale/uk/special_item_group.txt
--- baseline/server/server/home/metin2/Server/share/locale/uk/special_item_group.txt	2024-12-28 03:09:36.000000000 +0000
+++ final/server/server/home/metin2/Server/share/locale/uk/special_item_group.txt	2026-02-20 18:06:09.530628112 +0000
@@ -12418,3 +12418,33 @@
 	18	27987	1	5 -- Clam
 	19	71082	1	3 -- Metin Stone(H)
 }
+
+
+# --- Growth Pet System ---
+Group PetBookChest
+{
+	Vnum	55009
+	1	55010	1	1 --**Resistance (Warrior) Book
+	2	55011	1	1 --**Resistance (Sura) Book
+	3	55012	1	1 --**Resistance (Assassin) Book
+	4	55013	1	1 --**Resistance (Shaman) Book
+	5	55015	1	1 --**Berserker Book
+	6	55016	1	1 --**Anti-Magic Book
+	7	55017	1	1 --**Haste Book
+	8	55018	1	1 --**Drill Book
+	9	55019	1	1 --**Restoration Book
+	10	55020	1	1 --**Vampirism Book
+	11	55021	1	1 --**Spiritualism Book
+	12	55022	1	1 --**Bulwark Book
+	13	55023	1	1 --**Reflection Book
+	14	55024	1	1 --**Yang Drop Book
+	15	55025	1	1 --**Range Book
+	16	55026	1	1 --**Immortal Book
+	17	55027	1	1 --**Panacea Book
+	18	55034	1	1 --**Master Brewer Book
+	19	55035	1	1 --**Monster Hunter Book
+	20	55036	1	1 --**Eagle Eyes Book
+	21	55037	1	1 --**Life Drain Book
+	22	55038	1	1 --**Light as a Feather Book
+	--23	55014	1	1 --**Resistance (Lycan)
+}
diff -ruN baseline/server/server/home/metin2/Server/sql/growth_pet.sql final/server/server/home/metin2/Server/sql/growth_pet.sql
--- baseline/server/server/home/metin2/Server/sql/growth_pet.sql	1970-01-01 00:00:00.000000000 +0000
+++ final/server/server/home/metin2/Server/sql/growth_pet.sql	2026-02-20 18:06:38.045476132 +0000
@@ -0,0 +1,51 @@
+/*
+ Navicat MySQL Data Transfer
+
+ Source Server         : Dev_locale
+ Source Server Type    : MySQL
+ Source Server Version : 80027
+ Source Host           : 127.0.0.1:3306
+ Source Schema         : player
+
+ Target Server Type    : MySQL
+ Target Server Version : 80027
+ File Encoding         : 65001
+
+ Date: 16/04/2022 10:56:57
+*/
+
+SET NAMES utf8mb4;
+SET FOREIGN_KEY_CHECKS = 0;
+
+-- ----------------------------
+-- Table structure for growth_pet
+-- ----------------------------
+DROP TABLE IF EXISTS `growth_pet`;
+CREATE TABLE `growth_pet`  (
+  `id` int(0) NOT NULL,
+  `owner_id` int(0) NOT NULL,
+  `vnum` int(0) NOT NULL,
+  `state` enum('UPBRINGING','BAG','SAFEBOX') CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL DEFAULT 'UPBRINGING',
+  `name` varchar(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL DEFAULT NULL,
+  `size` tinyint(0) NOT NULL,
+  `level` int(0) NULL DEFAULT 1,
+  `level_step` tinyint(1) NULL DEFAULT 0,
+  `evolution` tinyint(1) NULL DEFAULT 1,
+  `type` tinyint(1) NULL DEFAULT NULL,
+  `hp` int(0) NULL DEFAULT 0,
+  `sp` int(0) NULL DEFAULT 0,
+  `def` int(0) NULL DEFAULT 0,
+  `hp_apply` tinyint(0) NULL DEFAULT 0,
+  `sp_apply` tinyint(0) NULL DEFAULT 0,
+  `def_apply` tinyint(0) NULL DEFAULT 0,
+  `age_apply` tinyint(0) NULL DEFAULT 0,
+  `skill_level` tinyblob NULL,
+  `exp` int(0) NULL DEFAULT NULL,
+  `item_exp` int(0) NULL DEFAULT NULL,
+  `birthday` datetime(0) NULL DEFAULT NULL,
+  `end_time` int(0) NULL DEFAULT 0,
+  `max_time` int(0) NULL DEFAULT NULL,
+  PRIMARY KEY (`id`) USING BTREE
+) ENGINE = MyISAM AUTO_INCREMENT = 1 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_0900_ai_ci ROW_FORMAT = Dynamic;
+
+SET FOREIGN_KEY_CHECKS = 1;
diff -ruN baseline/server/server/home/metin2/Server/sql/growth_pet_skill_proto.sql final/server/server/home/metin2/Server/sql/growth_pet_skill_proto.sql
--- baseline/server/server/home/metin2/Server/sql/growth_pet_skill_proto.sql	1970-01-01 00:00:00.000000000 +0000
+++ final/server/server/home/metin2/Server/sql/growth_pet_skill_proto.sql	2026-02-20 18:06:38.046286752 +0000
@@ -0,0 +1,302 @@
+/*
+ Navicat MySQL Data Transfer
+
+ Source Server         : Dev_locale
+ Source Server Type    : MySQL
+ Source Server Version : 80027
+ Source Host           : 127.0.0.1:3306
+ Source Schema         : player
+
+ Target Server Type    : MySQL
+ Target Server Version : 80027
+ File Encoding         : 65001
+
+ Date: 16/04/2022 10:56:57
+*/
+
+SET NAMES utf8mb4;
+SET FOREIGN_KEY_CHECKS = 0;
+
+-- ----------------------------
+-- Table structure for growth_pet_skill_proto
+-- ----------------------------
+DROP TABLE IF EXISTS `growth_pet_skill_proto`;
+CREATE TABLE `growth_pet_skill_proto`  (
+  `dwPetVnum` int(11) NOT NULL,
+  `dwSkillVnum` int(11) NOT NULL,
+  `szName` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+  `bType` enum('PASSIVE','AUTO') CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+  `dwCooldown` int(3) NOT NULL,
+  `setAffectFlag` enum('JIJOONG_WARRIOR','JIJOONG_SURA','JIJOONG_ASSASSIN','JIJOONG_SHAMAN','JIJOONG_WOLFMAN','PACHEON','BANYA','CHEONRYEONG','CHOEHOENBIMU','HEAL','STEALHP','STEALMP','BLOCK','REFLECT_MELEE','GOLD_DROP','BOW_DISTANCE','INVINCIBILITY','REMOVAL','POTION','MOB_BONUS','EXP','HP_RECOVER','FEATHER','') CHARACTER SET utf8 COLLATE utf8_general_ci DEFAULT NULL,
+  `szPointOn` enum('RESIST_WARRIOR','RESIST_SURA','RESIST_ASSASSIN','RESIST_SHAMAN','RESIST_WOLFMAN','RESIST_MAGIC_REDUCTION','MELEE_MAGIC_ATT_BONUS_PER','ATTBONUS_MONSTER','PENETRATE_PCT','CASTING_SPEED','BOW_DISTANCE','STEAL_SP','STEAL_HP','KILL_HP_RECOVERY','BLOCK','REFLECT_MELEE','GOLD_DOUBLE_BONUS','EXP_DOUBLE_BONUS','POTION_BONUS') CHARACTER SET utf8 COLLATE utf8_general_ci DEFAULT NULL,
+  `szPointPoly1` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+  `szPointPoly2` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+  `szPointPoly3` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+  `szPointPoly4` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+  `szPointPoly5` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+  `szPointPoly6` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+  `szPointPoly7` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+  `szPointPoly8` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+  `szActivatePctPoly` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+  `szDurationPoly` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+  PRIMARY KEY (`dwPetVnum`, `dwSkillVnum`) USING BTREE
+) ENGINE = MyISAM CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Dynamic;
+
+-- ----------------------------
+-- Records of growth_pet_skill_proto
+-- ----------------------------
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 1, 'Resistance (Warrior)', 'PASSIVE', 0, 'JIJOONG_WARRIOR', 'RESIST_WARRIOR', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 2, 'Resistance (Sura)', 'PASSIVE', 0, 'JIJOONG_SURA', 'RESIST_SURA', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 3, 'Resistance (Ninja)', 'PASSIVE', 0, 'JIJOONG_ASSASSIN', 'RESIST_ASSASSIN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 4, 'Resistance (Shaman)', 'PASSIVE', 0, 'JIJOONG_SHAMAN', 'RESIST_SHAMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 5, 'Resistance (Lycan)', 'PASSIVE', 0, 'JIJOONG_WOLFMAN', 'RESIST_WOLFMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 6, 'Berserker', 'PASSIVE', 0, 'PACHEON', 'MELEE_MAGIC_ATT_BONUS_PER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 7, 'Anti-Magic', 'PASSIVE', 0, 'BANYA', 'RESIST_MAGIC_REDUCTION', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 8, 'Haste', 'PASSIVE', 0, 'CHEONRYEONG', 'CASTING_SPEED', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 9, 'Drill', 'PASSIVE', 0, 'CHOEHOENBIMU', 'PENETRATE_PCT', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 10, 'Restoration', 'AUTO', 480, 'HEAL', '', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '58', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 11, 'Vampirism', 'PASSIVE', 0, 'STEALHP', 'STEAL_HP', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 12, 'Spiritualism', 'PASSIVE', 0, 'STEALMP', 'STEAL_SP', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 13, 'Bulwark', 'PASSIVE', 0, 'BLOCK', 'BLOCK', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 14, 'Reflection', 'PASSIVE', 0, 'REFLECT_MELEE', 'REFLECT_MELEE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 15, 'Yang Drop', 'PASSIVE', 0, 'GOLD_DROP', 'GOLD_DOUBLE_BONUS', '10.6 + (k*3.339 + lv*1.1925)', '10.8 + (k*3.402 + lv*1.215)', '10.8 + (k*3.402 + lv*1.215)', '11.2 + (k*3.528 + lv*1.26)', '11.2 + (k*3.528 + lv*1.26)', '11.6 + (k*3.654 + lv*1.305)', '11.6 + (k*3.654 + lv*1.305)', '11.6 + (k*3.654 + lv*1.305)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 16, 'Range', 'PASSIVE', 0, 'BOW_DISTANCE', 'BOW_DISTANCE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 17, 'Immortal', 'AUTO', 600, 'INVINCIBILITY', '', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '53', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 18, 'Panacea', 'AUTO', 480, 'REMOVAL', '', '0', '0', '0', '0', '0', '0', '0', '0', '41', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 19, 'Master Brewer', 'PASSIVE', 0, 'POTION', 'POTION_BONUS', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 20, 'Monster Hunter', 'PASSIVE', 0, 'MOB_BONUS', 'ATTBONUS_MONSTER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 21, 'Eagle Eyes', 'PASSIVE', 0, 'EXP', 'EXP_DOUBLE_BONUS', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 22, 'Life Drain', 'PASSIVE', 0, 'HP_RECOVER', 'KILL_HP_RECOVERY', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 23, 'Light as a Feather', 'AUTO', 10, 'FEATHER', '', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '44+ (k*0.455 + lv*0.1625)', '50 + (k*2.8 + lv*1)');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 1, 'Resistance (Warrior)', 'PASSIVE', 0, 'JIJOONG_WARRIOR', 'RESIST_WARRIOR', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 2, 'Resistance (Sura)', 'PASSIVE', 0, 'JIJOONG_SURA', 'RESIST_SURA', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 3, 'Resistance (Ninja)', 'PASSIVE', 0, 'JIJOONG_ASSASSIN', 'RESIST_ASSASSIN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 4, 'Resistance (Shaman)', 'PASSIVE', 0, 'JIJOONG_SHAMAN', 'RESIST_SHAMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 5, 'Resistance (Lycan)', 'PASSIVE', 0, 'JIJOONG_WOLFMAN', 'RESIST_WOLFMAN', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 6, 'Berserker', 'PASSIVE', 0, 'PACHEON', 'MELEE_MAGIC_ATT_BONUS_PER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 7, 'Anti-Magic', 'PASSIVE', 0, 'BANYA', 'RESIST_MAGIC_REDUCTION', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 8, 'Haste', 'PASSIVE', 0, 'CHEONRYEONG', 'CASTING_SPEED', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 9, 'Drill', 'PASSIVE', 0, 'CHOEHOENBIMU', 'PENETRATE_PCT', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 10, 'Restoration', 'AUTO', 480, 'HEAL', '', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '58', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 11, 'Vampirism', 'PASSIVE', 0, 'STEALHP', 'STEAL_HP', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 12, 'Spiritualism', 'PASSIVE', 0, 'STEALMP', 'STEAL_SP', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 13, 'Bulwark', 'PASSIVE', 0, 'BLOCK', 'BLOCK', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 14, 'Reflection', 'PASSIVE', 0, 'REFLECT_MELEE', 'REFLECT_MELEE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 15, 'Yang Drop', 'PASSIVE', 0, 'GOLD_DROP', 'GOLD_DOUBLE_BONUS', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 16, 'Range', 'PASSIVE', 0, 'BOW_DISTANCE', 'BOW_DISTANCE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 17, 'Immortal', 'AUTO', 600, 'INVINCIBILITY', '', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '10 + (k*0.665 + lv*0.2375)', '10 + (k*0.665 + lv*0.2375)', '10 + (k*0.665 + lv*0.2375)', '10 + (k*0.665 + lv*0.2375)', '53', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 18, 'Panacea', 'AUTO', 480, 'REMOVAL', '', '0', '0', '0', '0', '0', '0', '0', '0', '41', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 19, 'Master Brewer', 'PASSIVE', 0, 'POTION', 'POTION_BONUS', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 20, 'Monster Hunter', 'PASSIVE', 0, 'MOB_BONUS', 'ATTBONUS_MONSTER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 21, 'Eagle Eyes', 'PASSIVE', 0, 'EXP', 'EXP_DOUBLE_BONUS', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 22, 'Life Drain', 'PASSIVE', 0, 'HP_RECOVER', 'KILL_HP_RECOVERY', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 23, 'Light as a Feather', 'AUTO', 180, 'FEATHER', '', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '44+ (k*0.455 + lv*0.1625)', '50 + (k*2.8 + lv*1)');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 1, 'Resistance (Warrior)', 'PASSIVE', 0, 'JIJOONG_WARRIOR', 'RESIST_WARRIOR', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 2, 'Resistance (Sura)', 'PASSIVE', 0, 'JIJOONG_SURA', 'RESIST_SURA', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 3, 'Resistance (Ninja)', 'PASSIVE', 0, 'JIJOONG_ASSASSIN', 'RESIST_ASSASSIN', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 4, 'Resistance (Shaman)', 'PASSIVE', 0, 'JIJOONG_SHAMAN', 'RESIST_SHAMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 5, 'Resistance (Lycan)', 'PASSIVE', 0, 'JIJOONG_WOLFMAN', 'RESIST_WOLFMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 6, 'Berserker', 'PASSIVE', 0, 'PACHEON', 'MELEE_MAGIC_ATT_BONUS_PER', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 7, 'Anti-Magic', 'PASSIVE', 0, 'BANYA', 'RESIST_MAGIC_REDUCTION', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 8, 'Haste', 'PASSIVE', 0, 'CHEONRYEONG', 'CASTING_SPEED', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 9, 'Drill', 'PASSIVE', 0, 'CHOEHOENBIMU', 'PENETRATE_PCT', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 10, 'Restoration', 'AUTO', 480, 'HEAL', '', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '58', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 11, 'Vampirism', 'PASSIVE', 0, 'STEALHP', 'STEAL_HP', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 12, 'Spiritualism', 'PASSIVE', 0, 'STEALMP', 'STEAL_SP', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 13, 'Bulwark', 'PASSIVE', 0, 'BLOCK', 'BLOCK', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 14, 'Reflection', 'PASSIVE', 0, 'REFLECT_MELEE', 'REFLECT_MELEE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 15, 'Yang Drop', 'PASSIVE', 0, 'GOLD_DROP', 'GOLD_DOUBLE_BONUS', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 16, 'Range', 'PASSIVE', 0, 'BOW_DISTANCE', 'BOW_DISTANCE', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 17, 'Immortal', 'AUTO', 600, 'INVINCIBILITY', '', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '53', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 18, 'Panacea', 'AUTO', 480, 'REMOVAL', '', '0', '0', '0', '0', '0', '0', '0', '0', '41', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 19, 'Master Brewer', 'PASSIVE', 0, 'POTION', 'POTION_BONUS', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 20, 'Monster Hunter', 'PASSIVE', 0, 'MOB_BONUS', 'ATTBONUS_MONSTER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 21, 'Eagle Eyes', 'PASSIVE', 0, 'EXP', 'EXP_DOUBLE_BONUS', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 22, 'Life Drain', 'PASSIVE', 0, 'HP_RECOVER', 'KILL_HP_RECOVERY', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 23, 'Light as a Feather', 'AUTO', 180, 'FEATHER', '', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '44+ (k*0.455 + lv*0.1625)', '50 + (k*2.8 + lv*1)');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 1, 'Resistance (Warrior)', 'PASSIVE', 0, 'JIJOONG_WARRIOR', 'RESIST_WARRIOR', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 2, 'Resistance (Sura)', 'PASSIVE', 0, 'JIJOONG_SURA', 'RESIST_SURA', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 3, 'Resistance (Ninja)', 'PASSIVE', 0, 'JIJOONG_ASSASSIN', 'RESIST_ASSASSIN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 4, 'Resistance (Shaman)', 'PASSIVE', 0, 'JIJOONG_SHAMAN', 'RESIST_SHAMAN', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 5, 'Resistance (Lycan)', 'PASSIVE', 0, 'JIJOONG_WOLFMAN', 'RESIST_WOLFMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 6, 'Berserker', 'PASSIVE', 0, 'PACHEON', 'MELEE_MAGIC_ATT_BONUS_PER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 7, 'Anti-Magic', 'PASSIVE', 0, 'BANYA', 'RESIST_MAGIC_REDUCTION', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 8, 'Haste', 'PASSIVE', 0, 'CHEONRYEONG', 'CASTING_SPEED', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 9, 'Drill', 'PASSIVE', 0, 'CHOEHOENBIMU', 'PENETRATE_PCT', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 10, 'Restoration', 'AUTO', 480, 'HEAL', '', '713.3 + (k*224.689 + lv*80.2463)', '713.3 + (k*224.689 + lv*80.2463)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '733.3 + (k*230.99 + lv*82.4963)', '733.3 + (k*230.99 + lv*82.4963)', '733.3 + (k*230.99 + lv*82.4963)', '733.3 + (k*230.99 + lv*82.4963)', '58', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 11, 'Vampirism', 'PASSIVE', 0, 'STEALHP', 'STEAL_HP', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 12, 'Spiritualism', 'PASSIVE', 0, 'STEALMP', 'STEAL_SP', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 13, 'Bulwark', 'PASSIVE', 0, 'BLOCK', 'BLOCK', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 14, 'Reflection', 'PASSIVE', 0, 'REFLECT_MELEE', 'REFLECT_MELEE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 15, 'Yang Drop', 'PASSIVE', 0, 'GOLD_DROP', 'GOLD_DOUBLE_BONUS', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 16, 'Range', 'PASSIVE', 0, 'BOW_DISTANCE', 'BOW_DISTANCE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 17, 'Immortal', 'AUTO', 600, 'INVINCIBILITY', '', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '53', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 18, 'Panacea', 'AUTO', 480, 'REMOVAL', '', '0', '0', '0', '0', '0', '0', '0', '0', '41', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 19, 'Master Brewer', 'PASSIVE', 0, 'POTION', 'POTION_BONUS', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 20, 'Monster Hunter', 'PASSIVE', 0, 'MOB_BONUS', 'ATTBONUS_MONSTER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 21, 'Eagle Eyes', 'PASSIVE', 0, 'EXP', 'EXP_DOUBLE_BONUS', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 22, 'Life Drain', 'PASSIVE', 0, 'HP_RECOVER', 'KILL_HP_RECOVERY', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 23, 'Light as a Feather', 'AUTO', 180, 'FEATHER', '', '162.5 + (k*5.6875 + lv*2.03125)', '162.5 + (k*5.6875 + lv*2.03125)', '262.5 + (k*9.1875 + lv*3.28125)', '262.5 + (k*9.1875 + lv*3.28125)', '337.5 + (k*11.8125 + lv*4.21875)', '337.5 + (k*11.8125 + lv*4.21875)', '387.5 + (k*13.5625 + lv*4.84375)', '387.5 + (k*13.5625 + lv*4.84375)', '44+ (k*0.455 + lv*0.1625)', '50 + (k*2.8 + lv*1)');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 1, 'Resistance (Warrior)', 'PASSIVE', 0, 'JIJOONG_WARRIOR', 'RESIST_WARRIOR', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 2, 'Resistance (Sura)', 'PASSIVE', 0, 'JIJOONG_SURA', 'RESIST_SURA', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 3, 'Resistance (Ninja)', 'PASSIVE', 0, 'JIJOONG_ASSASSIN', 'RESIST_ASSASSIN', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 4, 'Resistance (Shaman)', 'PASSIVE', 0, 'JIJOONG_SHAMAN', 'RESIST_SHAMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 5, 'Resistance (Lycan)', 'PASSIVE', 0, 'JIJOONG_WOLFMAN', 'RESIST_WOLFMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 6, 'Berserker', 'PASSIVE', 0, 'PACHEON', 'MELEE_MAGIC_ATT_BONUS_PER', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 7, 'Anti-Magic', 'PASSIVE', 0, 'BANYA', 'RESIST_MAGIC_REDUCTION', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 8, 'Haste', 'PASSIVE', 0, 'CHEONRYEONG', 'CASTING_SPEED', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 9, 'Drill', 'PASSIVE', 0, 'CHOEHOENBIMU', 'PENETRATE_PCT', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 10, 'Restoration', 'AUTO', 480, 'HEAL', '', '713.3 + (k*224.689 + lv*80.2463)', '713.3 + (k*224.689 + lv*80.2463)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '733.3 + (k*230.99 + lv*82.4963)', '733.3 + (k*230.99 + lv*82.4963)', '733.3 + (k*230.99 + lv*82.4963)', '733.3 + (k*230.99 + lv*82.4963)', '58', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 11, 'Vampirism', 'PASSIVE', 0, 'STEALHP', 'STEAL_HP', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 12, 'Spiritualism', 'PASSIVE', 0, 'STEALMP', 'STEAL_SP', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 13, 'Bulwark', 'PASSIVE', 0, 'BLOCK', 'BLOCK', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 14, 'Reflection', 'PASSIVE', 0, 'REFLECT_MELEE', 'REFLECT_MELEE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 15, 'Yang Drop', 'PASSIVE', 0, 'GOLD_DROP', 'GOLD_DOUBLE_BONUS', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 16, 'Range', 'PASSIVE', 0, 'BOW_DISTANCE', 'BOW_DISTANCE', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 17, 'Immortal', 'AUTO', 600, 'INVINCIBILITY', '', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '53', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 18, 'Panacea', 'AUTO', 480, 'REMOVAL', '', '0', '0', '0', '0', '0', '0', '0', '0', '41', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 19, 'Master Brewer', 'PASSIVE', 0, 'POTION', 'POTION_BONUS', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 20, 'Monster Hunter', 'PASSIVE', 0, 'MOB_BONUS', 'ATTBONUS_MONSTER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 21, 'Eagle Eyes', 'PASSIVE', 0, 'EXP', 'EXP_DOUBLE_BONUS', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 22, 'Life Drain', 'PASSIVE', 0, 'HP_RECOVER', 'KILL_HP_RECOVERY', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 23, 'Light as a Feather', 'AUTO', 180, 'FEATHER', '', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '44+ (k*0.455 + lv*0.1625)', '50 + (k*2.8 + lv*1)');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 1, 'Resistance (Warrior)', 'PASSIVE', 0, 'JIJOONG_WARRIOR', 'RESIST_WARRIOR', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 2, 'Resistance (Sura)', 'PASSIVE', 0, 'JIJOONG_SURA', 'RESIST_SURA', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 3, 'Resistance (Ninja)', 'PASSIVE', 0, 'JIJOONG_ASSASSIN', 'RESIST_ASSASSIN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 4, 'Resistance (Shaman)', 'PASSIVE', 0, 'JIJOONG_SHAMAN', 'RESIST_SHAMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 5, 'Resistance (Lycan)', 'PASSIVE', 0, 'JIJOONG_WOLFMAN', 'RESIST_WOLFMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 6, 'Berserker', 'PASSIVE', 0, 'PACHEON', 'MELEE_MAGIC_ATT_BONUS_PER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 7, 'Anti-Magic', 'PASSIVE', 0, 'BANYA', 'RESIST_MAGIC_REDUCTION', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 8, 'Haste', 'PASSIVE', 0, 'CHEONRYEONG', 'CASTING_SPEED', '1 + (k*0.63 + lv*0.225)', '1 + (k*0.63 + lv*0.225)', '1 + (k*0.665 + lv*0.2375)', '1 + (k*0.665 + lv*0.2375)', '1 + (k*0.735 + lv*0.2625)', '1 + (k*0.735 + lv*0.2625)', '1 + (k*0.735 + lv*0.2625)', '1 + (k*0.735 + lv*0.2625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 9, 'Drill', 'PASSIVE', 0, 'CHOEHOENBIMU', 'PENETRATE_PCT', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 10, 'Restoration', 'AUTO', 480, 'HEAL', '', '713.3 + (k*224.689 + lv*80.2463)', '713.3 + (k*224.689 + lv*80.2463)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '733.3 + (k*230.99 + lv*82.4963)', '733.3 + (k*230.99 + lv*82.4963)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '58', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 11, 'Vampirism', 'PASSIVE', 0, 'STEALHP', 'STEAL_HP', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 12, 'Spiritualism', 'PASSIVE', 0, 'STEALMP', 'STEAL_SP', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 13, 'Bulwark', 'PASSIVE', 0, 'BLOCK', 'BLOCK', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.49 + lv*0.175)', '1 + (k*0.49 + lv*0.175)', '1 + (k*0.49 + lv*0.175)', '1 + (k*0.49 + lv*0.175)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 14, 'Reflection', 'PASSIVE', 0, 'REFLECT_MELEE', 'REFLECT_MELEE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 15, 'Yang Drop', 'PASSIVE', 0, 'GOLD_DROP', 'GOLD_DOUBLE_BONUS', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 16, 'Range', 'PASSIVE', 0, 'BOW_DISTANCE', 'BOW_DISTANCE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 17, 'Immortal', 'AUTO', 600, 'INVINCIBILITY', '', '10 + (k*0.63 + lv*0.225)', '10 + (k*0.63 + lv*0.225)', '10 + (k*0.665 + lv*0.2375)', '10 + (k*0.665 + lv*0.2375)', '10 + (k*0.7 + lv*0.25)', '10 + (k*0.7 + lv*0.25)', '10 + (k*0.7 + lv*0.25)', '10 + (k*0.7 + lv*0.25)', '53', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 18, 'Panacea', 'AUTO', 480, 'REMOVAL', '', '0', '0', '0', '0', '0', '0', '0', '0', '41', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 19, 'Master Brewer', 'PASSIVE', 0, 'POTION', 'POTION_BONUS', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 20, 'Monster Hunter', 'PASSIVE', 0, 'MOB_BONUS', 'ATTBONUS_MONSTER', '1 + (k*0.28 + lv*0.1)', '1 + (k*0.28 + lv*0.1)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 21, 'Eagle Eyes', 'PASSIVE', 0, 'EXP', 'EXP_DOUBLE_BONUS', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 22, 'Life Drain', 'PASSIVE', 0, 'HP_RECOVER', 'KILL_HP_RECOVERY', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 23, 'Light as a Feather', 'AUTO', 180, 'FEATHER', '', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '44+ (k*0.455 + lv*0.1625)', '50 + (k*2.8 + lv*1)');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 1, 'Resistance (Warrior)', 'PASSIVE', 0, 'JIJOONG_WARRIOR', 'RESIST_WARRIOR', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 2, 'Resistance (Sura)', 'PASSIVE', 0, 'JIJOONG_SURA', 'RESIST_SURA', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 3, 'Resistance (Ninja)', 'PASSIVE', 0, 'JIJOONG_ASSASSIN', 'RESIST_ASSASSIN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 4, 'Resistance (Shaman)', 'PASSIVE', 0, 'JIJOONG_SHAMAN', 'RESIST_SHAMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 5, 'Resistance (Lycan)', 'PASSIVE', 0, 'JIJOONG_WOLFMAN', 'RESIST_WOLFMAN', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 6, 'Berserker', 'PASSIVE', 0, 'PACHEON', 'MELEE_MAGIC_ATT_BONUS_PER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 7, 'Anti-Magic', 'PASSIVE', 0, 'BANYA', 'RESIST_MAGIC_REDUCTION', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 8, 'Haste', 'PASSIVE', 0, 'CHEONRYEONG', 'CASTING_SPEED', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 9, 'Drill', 'PASSIVE', 0, 'CHOEHOENBIMU', 'PENETRATE_PCT', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 10, 'Restoration', 'AUTO', 480, 'HEAL', '', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '713.3 + (k*224.689 + lv*80.2463)', '713.3 + (k*224.689 + lv*80.2463)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '58', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 11, 'Vampirism', 'PASSIVE', 0, 'STEALHP', 'STEAL_HP', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 12, 'Spiritualism', 'PASSIVE', 0, 'STEALMP', 'STEAL_SP', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 13, 'Bulwark', 'PASSIVE', 0, 'BLOCK', 'BLOCK', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 14, 'Reflection', 'PASSIVE', 0, 'REFLECT_MELEE', 'REFLECT_MELEE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 15, 'Yang Drop', 'PASSIVE', 0, 'GOLD_DROP', 'GOLD_DOUBLE_BONUS', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 16, 'Range', 'PASSIVE', 0, 'BOW_DISTANCE', 'BOW_DISTANCE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 17, 'Immortal', 'AUTO', 600, 'INVINCIBILITY', '', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.63 + lv*0.225)', '10 + (k*0.63 + lv*0.225)', '10 + (k*0.665 + lv*0.2375)', '10 + (k*0.665 + lv*0.2375)', '10 + (k*0.665 + lv*0.2375)', '10 + (k*0.665 + lv*0.2375)', '53', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 18, 'Panacea', 'AUTO', 480, 'REMOVAL', '', '0', '0', '0', '0', '0', '0', '0', '0', '41', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 19, 'Master Brewer', 'PASSIVE', 0, 'POTION', 'POTION_BONUS', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 20, 'Monster Hunter', 'PASSIVE', 0, 'MOB_BONUS', 'ATTBONUS_MONSTER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 21, 'Eagle Eyes', 'PASSIVE', 0, 'EXP', 'EXP_DOUBLE_BONUS', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 22, 'Life Drain', 'PASSIVE', 0, 'HP_RECOVER', 'KILL_HP_RECOVERY', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 23, 'Light as a Feather', 'AUTO', 180, 'FEATHER', '', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '44+ (k*0.455 + lv*0.1625)', '50 + (k*2.8 + lv*1)');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 1, 'Resistance (Warrior)', 'PASSIVE', 0, 'JIJOONG_WARRIOR', 'RESIST_WARRIOR', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 2, 'Resistance (Sura)', 'PASSIVE', 0, 'JIJOONG_SURA', 'RESIST_SURA', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 3, 'Resistance (Ninja)', 'PASSIVE', 0, 'JIJOONG_ASSASSIN', 'RESIST_ASSASSIN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 4, 'Resistance (Shaman)', 'PASSIVE', 0, 'JIJOONG_SHAMAN', 'RESIST_SHAMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 5, 'Resistance (Lycan)', 'PASSIVE', 0, 'JIJOONG_WOLFMAN', 'RESIST_WOLFMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 6, 'Berserker', 'PASSIVE', 0, 'PACHEON', 'MELEE_MAGIC_ATT_BONUS_PER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.525 + lv*0.1875)', '1 + (k*0.525 + lv*0.1875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 7, 'Anti-Magic', 'PASSIVE', 0, 'BANYA', 'RESIST_MAGIC_REDUCTION', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 8, 'Haste', 'PASSIVE', 0, 'CHEONRYEONG', 'CASTING_SPEED', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 9, 'Drill', 'PASSIVE', 0, 'CHOEHOENBIMU', 'PENETRATE_PCT', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 10, 'Restoration', 'AUTO', 480, 'HEAL', '', '713.3 + (k*224.689 + lv*80.2463)', '713.3 + (k*224.689 + lv*80.2463)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '58', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 11, 'Vampirism', 'PASSIVE', 0, 'STEALHP', 'STEAL_HP', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 12, 'Spiritualism', 'PASSIVE', 0, 'STEALMP', 'STEAL_SP', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 13, 'Bulwark', 'PASSIVE', 0, 'BLOCK', 'BLOCK', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 14, 'Reflection', 'PASSIVE', 0, 'REFLECT_MELEE', 'REFLECT_MELEE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 15, 'Yang Drop', 'PASSIVE', 0, 'GOLD_DROP', 'GOLD_DOUBLE_BONUS', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 16, 'Range', 'PASSIVE', 0, 'BOW_DISTANCE', 'BOW_DISTANCE', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 17, 'Immortal', 'AUTO', 600, 'INVINCIBILITY', '', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '53', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 18, 'Panacea', 'AUTO', 480, 'REMOVAL', '', '0', '0', '0', '0', '0', '0', '0', '0', '41', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 19, 'Master Brewer', 'PASSIVE', 0, 'POTION', 'POTION_BONUS', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 20, 'Monster Hunter', 'PASSIVE', 0, 'MOB_BONUS', 'ATTBONUS_MONSTER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 21, 'Eagle Eyes', 'PASSIVE', 0, 'EXP', 'EXP_DOUBLE_BONUS', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 22, 'Life Drain', 'PASSIVE', 0, 'HP_RECOVER', 'KILL_HP_RECOVERY', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 23, 'Light as a Feather', 'AUTO', 180, 'FEATHER', '', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '44+ (k*0.455 + lv*0.1625)', '50 + (k*2.8 + lv*1)');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 1, 'Resistance (Warrior)', 'PASSIVE', 0, 'JIJOONG_WARRIOR', 'RESIST_WARRIOR', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 2, 'Resistance (Sura)', 'PASSIVE', 0, 'JIJOONG_SURA', 'RESIST_SURA', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 3, 'Resistance (Ninja)', 'PASSIVE', 0, 'JIJOONG_ASSASSIN', 'RESIST_ASSASSIN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 4, 'Resistance (Shaman)', 'PASSIVE', 0, 'JIJOONG_SHAMAN', 'RESIST_SHAMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 5, 'Resistance (Lycan)', 'PASSIVE', 0, 'JIJOONG_WOLFMAN', 'RESIST_WOLFMAN', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 6, 'Berserker', 'PASSIVE', 0, 'PACHEON', 'MELEE_MAGIC_ATT_BONUS_PER', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 7, 'Anti-Magic', 'PASSIVE', 0, 'BANYA', 'RESIST_MAGIC_REDUCTION', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 8, 'Haste', 'PASSIVE', 0, 'CHEONRYEONG', 'CASTING_SPEED', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 9, 'Drill', 'PASSIVE', 0, 'CHOEHOENBIMU', 'PENETRATE_PCT', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 10, 'Restoration', 'AUTO', 480, 'HEAL', '', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '58', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 11, 'Vampirism', 'PASSIVE', 0, 'STEALHP', 'STEAL_HP', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 12, 'Spiritualism', 'PASSIVE', 0, 'STEALMP', 'STEAL_SP', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 13, 'Bulwark', 'PASSIVE', 0, 'BLOCK', 'BLOCK', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 14, 'Reflection', 'PASSIVE', 0, 'REFLECT_MELEE', 'REFLECT_MELEE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 15, 'Yang Drop', 'PASSIVE', 0, 'GOLD_DROP', 'GOLD_DOUBLE_BONUS', '10.8 + (k*3.402 + lv*1.215)', '10.8 + (k*3.402 + lv*1.215)', '11.2 + (k*3.528 + lv*1.26)', '11.2 + (k*3.528 + lv*1.26)', '11.6 + (k*3.654 + lv*1.305)', '11.6 + (k*3.654 + lv*1.305)', '11.6 + (k*3.654 + lv*1.305)', '11.6 + (k*3.654 + lv*1.305)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 16, 'Range', 'PASSIVE', 0, 'BOW_DISTANCE', 'BOW_DISTANCE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 17, 'Immortal', 'AUTO', 600, 'INVINCIBILITY', '', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '53', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 18, 'Panacea', 'AUTO', 480, 'REMOVAL', '', '0', '0', '0', '0', '0', '0', '0', '0', '41', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 19, 'Master Brewer', 'PASSIVE', 0, 'POTION', 'POTION_BONUS', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 20, 'Monster Hunter', 'PASSIVE', 0, 'MOB_BONUS', 'ATTBONUS_MONSTER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 21, 'Eagle Eyes', 'PASSIVE', 0, 'EXP', 'EXP_DOUBLE_BONUS', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 22, 'Life Drain', 'PASSIVE', 0, 'HP_RECOVER', 'KILL_HP_RECOVERY', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 23, 'Light as a Feather', 'AUTO', 180, 'FEATHER', '', '187.5 + (k*6.5625 + lv*2.34375)', '187.5 + (k*6.5625 + lv*2.34375)', '287.5 + (k*10.0625 + lv*3.59375)', '287.5 + (k*10.0625 + lv*3.59375)', '287.5 + (k*10.0625 + lv*3.59375)', '387.5 + (k*13.5625 + lv*4.84375)', '387.5 + (k*13.5625 + lv*4.84375)', '387.5 + (k*13.5625 + lv*4.84375)', '44+ (k*0.455 + lv*0.1625)', '50 + (k*2.8 + lv*1)');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 1, 'Resistance (Warrior)', 'PASSIVE', 0, 'JIJOONG_WARRIOR', 'RESIST_WARRIOR', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 2, 'Resistance (Sura)', 'PASSIVE', 0, 'JIJOONG_SURA', 'RESIST_SURA', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 3, 'Resistance (Ninja)', 'PASSIVE', 0, 'JIJOONG_ASSASSIN', 'RESIST_ASSASSIN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 4, 'Resistance (Shaman)', 'PASSIVE', 0, 'JIJOONG_SHAMAN', 'RESIST_SHAMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 5, 'Resistance (Lycan)', 'PASSIVE', 0, 'JIJOONG_WOLFMAN', 'RESIST_WOLFMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 6, 'Berserker', 'PASSIVE', 0, 'PACHEON', 'MELEE_MAGIC_ATT_BONUS_PER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 7, 'Anti-Magic', 'PASSIVE', 0, 'BANYA', 'RESIST_MAGIC_REDUCTION', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 8, 'Haste', 'PASSIVE', 0, 'CHEONRYEONG', 'CASTING_SPEED', '1 + (k*0.63 + lv*0.225)', '1 + (k*0.63 + lv*0.225)', '1 + (k*0.665 + lv*0.2375)', '1 + (k*0.665 + lv*0.2375)', '1 + (k*0.735 + lv*0.2625)', '1 + (k*0.735 + lv*0.2625)', '1 + (k*0.735 + lv*0.2625)', '1 + (k*0.735 + lv*0.2625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 9, 'Drill', 'PASSIVE', 0, 'CHOEHOENBIMU', 'PENETRATE_PCT', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 10, 'Restoration', 'AUTO', 480, 'HEAL', '', '713.3 + (k*224.689 + lv*80.2463)', '713.3 + (k*224.689 + lv*80.2463)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '733.3 + (k*230.99 + lv*82.4963)', '720 + (k*226.8 + lv*81)', '733.3 + (k*230.99 + lv*82.4963)', '720 + (k*226.8 + lv*81)', '58', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 11, 'Vampirism', 'PASSIVE', 0, 'STEALHP', 'STEAL_HP', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 12, 'Spiritualism', 'PASSIVE', 0, 'STEALMP', 'STEAL_SP', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 13, 'Bulwark', 'PASSIVE', 0, 'BLOCK', 'BLOCK', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.49 + lv*0.175)', '1 + (k*0.49 + lv*0.175)', '1 + (k*0.49 + lv*0.175)', '1 + (k*0.49 + lv*0.175)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 14, 'Reflection', 'PASSIVE', 0, 'REFLECT_MELEE', 'REFLECT_MELEE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 15, 'Yang Drop', 'PASSIVE', 0, 'GOLD_DROP', 'GOLD_DOUBLE_BONUS', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 16, 'Range', 'PASSIVE', 0, 'BOW_DISTANCE', 'BOW_DISTANCE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 17, 'Immortal', 'AUTO', 600, 'INVINCIBILITY', '', '10 + (k*0.63 + lv*0.225)', '10 + (k*0.63 + lv*0.225)', '10 + (k*0.665 + lv*0.2375)', '10 + (k*0.665 + lv*0.2375)', '10 + (k*0.7 + lv*0.25)', '10 + (k*0.7 + lv*0.25)', '10 + (k*0.7 + lv*0.25)', '10 + (k*0.7 + lv*0.25)', '53', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 18, 'Panacea', 'AUTO', 480, 'REMOVAL', '', '0', '0', '0', '0', '0', '0', '0', '0', '41', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 19, 'Master Brewer', 'PASSIVE', 0, 'POTION', 'POTION_BONUS', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 20, 'Monster Hunter', 'PASSIVE', 0, 'MOB_BONUS', 'ATTBONUS_MONSTER', '1 + (k*0.28 + lv*0.1)', '1 + (k*0.28 + lv*0.1)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 21, 'Eagle Eyes', 'PASSIVE', 0, 'EXP', 'EXP_DOUBLE_BONUS', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 22, 'Life Drain', 'PASSIVE', 0, 'HP_RECOVER', 'KILL_HP_RECOVERY', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 23, 'Light as a Feather', 'AUTO', 180, 'FEATHER', '', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '44+ (k*0.455 + lv*0.1625)', '50 + (k*2.8 + lv*1)');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 1, 'Resistance (Warrior)', 'PASSIVE', 0, 'JIJOONG_WARRIOR', 'RESIST_WARRIOR', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 2, 'Resistance (Sura)', 'PASSIVE', 0, 'JIJOONG_SURA', 'RESIST_SURA', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 3, 'Resistance (Ninja)', 'PASSIVE', 0, 'JIJOONG_ASSASSIN', 'RESIST_ASSASSIN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 4, 'Resistance (Shaman)', 'PASSIVE', 0, 'JIJOONG_SHAMAN', 'RESIST_SHAMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 5, 'Resistance (Lycan)', 'PASSIVE', 0, 'JIJOONG_WOLFMAN', 'RESIST_WOLFMAN', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 6, 'Berserker', 'PASSIVE', 0, 'PACHEON', 'MELEE_MAGIC_ATT_BONUS_PER', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 7, 'Anti-Magic', 'PASSIVE', 0, 'BANYA', 'RESIST_MAGIC_REDUCTION', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 8, 'Haste', 'PASSIVE', 0, 'CHEONRYEONG', 'CASTING_SPEED', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 9, 'Drill', 'PASSIVE', 0, 'CHOEHOENBIMU', 'PENETRATE_PCT', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 10, 'Restoration', 'AUTO', 480, 'HEAL', '', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '58', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 11, 'Vampirism', 'PASSIVE', 0, 'STEALHP', 'STEAL_HP', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 12, 'Spiritualism', 'PASSIVE', 0, 'STEALMP', 'STEAL_SP', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 13, 'Bulwark', 'PASSIVE', 0, 'BLOCK', 'BLOCK', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 14, 'Reflection', 'PASSIVE', 0, 'REFLECT_MELEE', 'REFLECT_MELEE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 15, 'Yang Drop', 'PASSIVE', 0, 'GOLD_DROP', 'GOLD_DOUBLE_BONUS', '10.8 + (k*3.402 + lv*1.215)', '10.8 + (k*3.402 + lv*1.215)', '11.2 + (k*3.528 + lv*1.26)', '11.2 + (k*3.528 + lv*1.26)', '11.6 + (k*3.654 + lv*1.305)', '11.6 + (k*3.654 + lv*1.305)', '11.6 + (k*3.654 + lv*1.305)', '11.6 + (k*3.654 + lv*1.305)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 16, 'Range', 'PASSIVE', 0, 'BOW_DISTANCE', 'BOW_DISTANCE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 17, 'Immortal', 'AUTO', 600, 'INVINCIBILITY', '', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '53', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 18, 'Panacea', 'AUTO', 480, 'REMOVAL', '', '0', '0', '0', '0', '0', '0', '0', '0', '41', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 19, 'Master Brewer', 'PASSIVE', 0, 'POTION', 'POTION_BONUS', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 20, 'Monster Hunter', 'PASSIVE', 0, 'MOB_BONUS', 'ATTBONUS_MONSTER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 21, 'Eagle Eyes', 'PASSIVE', 0, 'EXP', 'EXP_DOUBLE_BONUS', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 22, 'Life Drain', 'PASSIVE', 0, 'HP_RECOVER', 'KILL_HP_RECOVERY', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 23, 'Light as a Feather', 'AUTO', 180, 'FEATHER', '', '187.5 + (k*6.5625 + lv*2.34375)', '187.5 + (k*6.5625 + lv*2.34375)', '287.5 + (k*10.0625 + lv*3.59375)', '287.5 + (k*10.0625 + lv*3.59375)', '287.5 + (k*10.0625 + lv*3.59375)', '387.5 + (k*13.5625 + lv*4.84375)', '387.5 + (k*13.5625 + lv*4.84375)', '387.5 + (k*13.5625 + lv*4.84375)', '44+ (k*0.455 + lv*0.1625)', '50 + (k*2.8 + lv*1)');
+
+SET FOREIGN_KEY_CHECKS = 1;
diff -ruN baseline/server/server/home/metin2/Source/Server/common/item_length.h final/server/server/home/metin2/Source/Server/common/item_length.h
--- baseline/server/server/home/metin2/Source/Server/common/item_length.h	2025-06-28 20:06:24.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/common/item_length.h	2022-04-27 08:52:35.000000000 +0000
@@ -4,47 +4,41 @@
 enum EItemMisc
 {
 	ITEM_NAME_MAX_LEN = 30,
+	ITEM_VALUES_MAX_NUM = 6,
 	ITEM_SMALL_DESCR_MAX_LEN = 256,
-	METIN_SOCKET_MAX_NUM = 3,
-	ITEM_MAX_COUNT = 200, // MAX 32767
 	ITEM_LIMIT_MAX_NUM = 2,
 #if defined(__ITEM_APPLY4__)
 	ITEM_APPLY_MAX_NUM = 4,
 #else
 	ITEM_APPLY_MAX_NUM = 3,
 #endif
-#if defined(__ITEM_VALUE10__)
-	ITEM_VALUES_MAX_NUM = 10,
-#else
-	ITEM_VALUES_MAX_NUM = 6,
-#endif
-#if defined(__ITEM_SOCKET6__)
-	ITEM_SOCKET_MAX_NUM = 6,
+#if defined(__ITEM_SOCKET5__)
+	ITEM_SOCKET_MAX_NUM = 5,
 #else
 	ITEM_SOCKET_MAX_NUM = 3,
 #endif
-
-	REFINE_MATERIAL_MAX_NUM = 5,
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	REFINE_ELEMENT_MAX = 3,
-#endif
-
+	ITEM_MAX_COUNT = 200, // MAX 32767
 	ITEM_ATTRIBUTE_NORM_NUM = 5,
 	ITEM_ATTRIBUTE_RARE_NUM = 2,
+
 	ITEM_ATTRIBUTE_NORM_START = 0,
 	ITEM_ATTRIBUTE_NORM_END = ITEM_ATTRIBUTE_NORM_START + ITEM_ATTRIBUTE_NORM_NUM,
+
 	ITEM_ATTRIBUTE_RARE_START = ITEM_ATTRIBUTE_NORM_END,
 	ITEM_ATTRIBUTE_RARE_END = ITEM_ATTRIBUTE_RARE_START + ITEM_ATTRIBUTE_RARE_NUM,
-	ITEM_ATTRIBUTE_MAX_NUM = ITEM_ATTRIBUTE_RARE_END,
 
-#if defined(__ATTR_6TH_7TH__)
-	ITEM_ATTRIBUTE_MAX_LEVEL = 10,
-#else
+	ITEM_ATTRIBUTE_MAX_NUM = ITEM_ATTRIBUTE_RARE_END, // 7
 	ITEM_ATTRIBUTE_MAX_LEVEL = 5,
-#endif
-
 	ITEM_AWARD_WHY_MAX_LEN = 50,
+
+	REFINE_MATERIAL_MAX_NUM = 5,
+
 	ITEM_ELK_VNUM = 50026,
+
+#if defined(__EXTENDED_DSS_RECHARGE__) || defined(__EXTENDED_COSTUME_RECHARGE__)
+	MIN_INFINITE_DURATION = 100 * 24 * 60 * 60, // 100d
+	MAX_INFINITE_DURATION = 60 * 365 * 24 * 60 * 60, // 60y
+#endif
 };
 
 const BYTE ITEM_SOCKET_REMAIN_SEC = 0;
@@ -64,78 +58,83 @@
 // ߿  Ȯϸ ¼  -_-;;;
 enum EItemUniqueSockets
 {
-	ITEM_SOCKET_UNIQUE_SAVE_TIME = METIN_SOCKET_MAX_NUM - 2,
-	ITEM_SOCKET_UNIQUE_REMAIN_TIME = METIN_SOCKET_MAX_NUM - 1
+	ITEM_SOCKET_UNIQUE_SAVE_TIME = ITEM_SOCKET_MAX_NUM - 2,
+	ITEM_SOCKET_UNIQUE_REMAIN_TIME = ITEM_SOCKET_MAX_NUM - 1
 };
 
 enum EItemTypes
 {
-	ITEM_NONE,
-	ITEM_WEAPON,
-	ITEM_ARMOR,
-	ITEM_USE,
-	ITEM_AUTOUSE,
-	ITEM_MATERIAL,
-	ITEM_SPECIAL,
-	ITEM_TOOL,
-	ITEM_LOTTERY,
-	ITEM_ELK,
-	ITEM_METIN,
-	ITEM_CONTAINER,
-	ITEM_FISH,
-	ITEM_ROD,
-	ITEM_RESOURCE,
-	ITEM_CAMPFIRE,
-	ITEM_UNIQUE,
-	ITEM_SKILLBOOK,
-	ITEM_QUEST,
-	ITEM_POLYMORPH,
-	ITEM_TREASURE_BOX,
-	ITEM_TREASURE_KEY,
-	ITEM_SKILLFORGET,
-	ITEM_GIFTBOX,
-	ITEM_PICK,
-	ITEM_HAIR,
-	ITEM_TOTEM,
-	ITEM_BLEND,
-	ITEM_COSTUME,
-	ITEM_DS,
-	ITEM_SPECIAL_DS,
-	ITEM_EXTRACT,
-	ITEM_SECONDARY_COIN,
-	ITEM_RING,
-	ITEM_BELT,
-	ITEM_PET,
-#if defined(__MOVE_COSTUME_ATTR__)
-	ITEM_MEDIUM,
+	ITEM_NONE,				// 0
+	ITEM_WEAPON,			// 1 // 
+	ITEM_ARMOR,				// 2 // 
+	ITEM_USE,				// 3 //  
+	ITEM_AUTOUSE,			// 4
+	ITEM_MATERIAL,			// 5
+	ITEM_SPECIAL,			// 6 //  
+	ITEM_TOOL,				// 7
+	ITEM_LOTTERY,			// 8 // 
+	ITEM_ELK,				// 9 // 
+	ITEM_METIN,				// 10
+	ITEM_CONTAINER,			// 11
+	ITEM_FISH,				// 12 // 
+	ITEM_ROD,				// 13
+	ITEM_RESOURCE,			// 14
+	ITEM_CAMPFIRE,			// 15
+	ITEM_UNIQUE,			// 16
+	ITEM_SKILLBOOK,			// 17
+	ITEM_QUEST,				// 18
+	ITEM_POLYMORPH,			// 19
+	ITEM_TREASURE_BOX,		// 20 // 
+	ITEM_TREASURE_KEY,		// 21 //  
+	ITEM_SKILLFORGET,		// 22
+	ITEM_GIFTBOX,			// 23
+	ITEM_PICK,				// 24
+	ITEM_HAIR,				// 25 // Ӹ
+	ITEM_TOTEM,				// 26 // 
+	ITEM_BLEND,				// 27 // ɶ ϰ Ӽ ٴ ๰
+	ITEM_COSTUME,			// 28 // ڽ  (2011 8 ߰ ڽ ýۿ )
+	ITEM_DS,				// 29 // ȥ
+	ITEM_SPECIAL_DS,		// 30 // Ư ȥ (DS_SLOT ϴ UNIQUE ̶ ϸ )
+	ITEM_EXTRACT,			// 31 ⵵.
+	ITEM_SECONDARY_COIN,	// 32 ?? ??
+	ITEM_RING,				// 33 
+	ITEM_BELT,				// 34 Ʈ
+#if defined(__CHEQUE_SYSTEM__)
+	ITEM_CHEQUE,			// 35 won
 #endif
 #if defined(__GACHA_SYSTEM__)
-	ITEM_GACHA,
+	ITEM_GACHA,				// 36 gacha
 #endif
-	ITEM_PASSIVE,
-	ITEM_MERCENARY,
-	ITEM_ALCHEMY,
+	ITEM_PET,				// 37 gacha
 #if defined(__SOUL_SYSTEM__)
-	ITEM_SOUL,
+	ITEM_SOUL,				// 38 soul
 #endif
-	ITEM_MAX_NUM,
+	ITEM_MEDIUM,			// 39 medium
+	ITEM_PASSIVE,			// 40 passive
+	ITEM_MERCENARY			// 41 mercenary
+};
+
+enum EMetinSubTypes
+{
+	METIN_NORMAL,
+	METIN_GOLD,
+	METIN_SUNGMA,
 };
 
 enum EWeaponSubTypes
 {
-	WEAPON_SWORD,
-	WEAPON_DAGGER,
-	WEAPON_BOW,
-	WEAPON_TWO_HANDED,
-	WEAPON_BELL,
-	WEAPON_FAN,
-	WEAPON_ARROW,
-	WEAPON_MOUNT_SPEAR,
-	WEAPON_CLAW,
+	WEAPON_SWORD,		// 0
+	WEAPON_DAGGER,		// 1
+	WEAPON_BOW,			// 2
+	WEAPON_TWO_HANDED,	// 3
+	WEAPON_BELL,		// 4
+	WEAPON_FAN,			// 5
+	WEAPON_ARROW,		// 6
+	WEAPON_MOUNT_SPEAR,	// 7
+	WEAPON_CLAW,		// 8
 #if defined(__QUIVER_SYSTEM__)
-	WEAPON_QUIVER,
+	WEAPON_QUIVER,		// 9
 #endif
-	WEAPON_BOUQUET,
 	WEAPON_NUM_TYPES,
 };
 
@@ -154,12 +153,99 @@
 #if defined(__GLOVE_SYSTEM__)
 	ARMOR_GLOVE,
 #endif
-	ARMOR_NUM_TYPES,
+	ARMOR_NUM_TYPES
+};
+
+enum ECostumeSubTypes
+{
+	COSTUME_BODY = ARMOR_BODY, // [߿!!] ECostumeSubTypes enum value  EArmorSubTypes װͰ ƾ .
+	COSTUME_HAIR = ARMOR_HEAD, // ̴ ڽ ۿ ߰ Ӽ ̰ڴٴ  û    Ȱϱ .
+#if defined(__MOUNT_COSTUME_SYSTEM__)
+	COSTUME_MOUNT,
+#endif
+#if defined(__ACCE_COSTUME_SYSTEM__)
+	COSTUME_ACCE,
+#endif
+#if defined(__WEAPON_COSTUME_SYSTEM__)
+	COSTUME_WEAPON,
+#endif
+	COSTUME_NUM_TYPES,
+};
+
+enum EDragonSoulSubType
+{
+	DS_SLOT1,
+	DS_SLOT2,
+	DS_SLOT3,
+	DS_SLOT4,
+	DS_SLOT5,
+	DS_SLOT6,
+	DS_SLOT_MAX,
+};
+
+enum EDragonSoulGradeTypes
+{
+	DRAGON_SOUL_GRADE_NORMAL,
+	DRAGON_SOUL_GRADE_BRILLIANT,
+	DRAGON_SOUL_GRADE_RARE,
+	DRAGON_SOUL_GRADE_ANCIENT,
+	DRAGON_SOUL_GRADE_LEGENDARY,
+#if defined(__DS_GRADE_MYTH__)
+	DRAGON_SOUL_GRADE_MYTH,
+#endif
+	DRAGON_SOUL_GRADE_MAX,
+};
+
+enum EDragonSoulStepTypes
+{
+	DRAGON_SOUL_STEP_LOWEST,
+	DRAGON_SOUL_STEP_LOW,
+	DRAGON_SOUL_STEP_MID,
+	DRAGON_SOUL_STEP_HIGH,
+	DRAGON_SOUL_STEP_HIGHEST,
+	DRAGON_SOUL_STEP_MAX,
+};
+
+#define DRAGON_SOUL_STRENGTH_MAX 7
+
+enum EDSInventoryMaxNum
+{
+	DRAGON_SOUL_INVENTORY_MAX_NUM = DS_SLOT_MAX * DRAGON_SOUL_GRADE_MAX * DRAGON_SOUL_BOX_SIZE,
+};
+
+enum EFishSubTypes
+{
+	FISH_ALIVE,
+	FISH_DEAD,
+};
+
+enum EResourceSubTypes
+{
+	RESOURCE_FISHBONE,
+	RESOURCE_WATERSTONEPIECE,
+	RESOURCE_WATERSTONE,
+	RESOURCE_BLOOD_PEARL,
+	RESOURCE_BLUE_PEARL,
+	RESOURCE_WHITE_PEARL,
+	RESOURCE_BUCKET,
+	RESOURCE_CRYSTAL,
+	RESOURCE_GEM,
+	RESOURCE_STONE,
+	RESOURCE_METIN,
+	RESOURCE_ORE,
+};
+
+enum EUniqueSubTypes
+{
+	UNIQUE_NONE,
+	UNIQUE_BOOK,
+	UNIQUE_SPECIAL_RIDE,
+	UNIQUE_SPECIAL_MOUNT_RIDE,
 };
 
 enum EUseSubTypes
 {
-	USE_POTION,
+	USE_POTION,						// 0
 	USE_TALISMAN,
 	USE_TUNING,
 	USE_MOVE,
@@ -169,7 +255,7 @@
 	USE_ABILITY_UP,
 	USE_AFFECT,
 	USE_CREATE_STONE,
-	USE_SPECIAL,
+	USE_SPECIAL,					// 10
 	USE_POTION_NODELAY,
 	USE_CLEAR,
 	USE_INVISIBILITY,
@@ -179,7 +265,7 @@
 	USE_CLEAN_SOCKET,
 	USE_CHANGE_ATTRIBUTE,
 	USE_ADD_ATTRIBUTE,
-	USE_ADD_ACCESSORY_SOCKET,
+	USE_ADD_ACCESSORY_SOCKET,		// 20
 	USE_PUT_INTO_ACCESSORY_SOCKET,
 	USE_ADD_ATTRIBUTE2,
 	USE_RECIPE,
@@ -187,38 +273,31 @@
 	USE_BIND,
 	USE_UNBIND,
 	USE_TIME_CHARGE_PER,
-	USE_TIME_CHARGE_FIX,
-	USE_PUT_INTO_BELT_SOCKET,
-	USE_PUT_INTO_RING_SOCKET,
-#if defined(__MOVE_COSTUME_ATTR__)
-	USE_CHANGE_COSTUME_ATTR,
-	USE_RESET_COSTUME_ATTR,
-#endif
-	USE_UNK_33,
-#if defined(__CHANGED_ATTR__)
-	USE_SELECT_ATTRIBUTE,
-#endif
-	USE_FLOWER,
+	USE_TIME_CHARGE_FIX,			// 28
+	USE_PUT_INTO_BELT_SOCKET,		// 29 Ʈ Ͽ   ִ  
+	USE_PUT_INTO_RING_SOCKET,		// 30  Ͽ   ִ  (ũ  ,  ߰  )
+#if defined(__COSTUME_ATTR_SYSTEM__)
+	USE_CHANGE_COSTUME_ATTR,		// 31
+	USE_RESET_COSTUME_ATTR,			// 32
+#endif
+	USE_CALL,						// 33 (Bravery Cape)
+	USE_REMOVE_AFFECT,				// 34 (Remove Affect)
+	USE_SELECT_ATTRIBUTE,			// 35
 #if defined(__EXPRESSING_EMOTIONS__)
-	USE_EMOTION_PACK,
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	USE_ELEMENT_UPGRADE,
-	USE_ELEMENT_DOWNGRADE,
-	USE_ELEMENT_CHANGE,
-#endif
-	USE_CALL,
-	USE_POTION_TOWER,
-	USE_POTION_NODELAY_TOWER,
-	USE_REMOVE_AFFECT,
-	USE_EMOTION_TOWER,
-	USE_SECRET_DUNGEON_SCROLL,
-#if defined(__OFFLINE_SHOP__)
-	USE_OPEN_OFFLINE_SHOP,
+	USE_EMOTION_PACK,				// 36 (Emotion Pack)
 #endif
+	USE_FLOWER,						// 37 (Flower Power Event)
+	USE_UNK39,						// 38
+	USE_UNK40,						// 39
+	USE_ELEMENT_UPGRADE,			// 40
+	USE_ELEMENT_DOWNGRADE,			// 41
+	USE_ELEMENT_CHANGE,				// 42
+	USE_POTION_TOWER,				// 43 (SungMa Tower)
+	USE_POTION_NODELAY_TOWER,		// 44 (SungMa Tower)
+	USE_EMOTION_TOWER,				// 45 (SungMa Tower)
+	USE_SECRET_DUNGEON_SCROLL		// 46
 };
 
-#ifdef __GROWTH_PET_SYSTEM__
 enum EPetSubTypes
 {
 	PET_EGG,
@@ -236,8 +315,38 @@
 	PET_PAY,
 	PET_PRIMIUM_FEEDSTUFF,
 };
+
+#if defined(__SOUL_SYSTEM__)
+enum ESoulSubType
+{
+	RED_SOUL,
+	BLUE_SOUL
+};
+
+enum ESoulGrade
+{
+	BASIC_SOUL = 1,
+	GLEAMING_SOUL = 2,
+	LUSTROUS_SOUL = 3,
+	PRISMATIC_SOUL = 4,
+	ILUMINED_SOUL = 5,
+};
+
+enum ESoulRefine
+{
+	SOUL_REFINE_SET = 999,
+	SOUL_REFINE_EVOLVE_PROB = 100,
+	SOUL_REFINE_AWAKE_PROB = 60,
+	SOUL_REFINE_COST = 0,
+};
 #endif
 
+enum EExtractSubTypes
+{
+	EXTRACT_DRAGON_SOUL,
+	EXTRACT_DRAGON_HEART,
+};
+
 enum EAutoUseSubTypes
 {
 	AUTOUSE_POTION,
@@ -245,7 +354,7 @@
 	AUTOUSE_BOMB,
 	AUTOUSE_GOLD,
 	AUTOUSE_MONEYBAG,
-	AUTOUSE_TREASURE_BOX,
+	AUTOUSE_TREASURE_BOX
 };
 
 enum EMaterialSubTypes
@@ -258,9 +367,6 @@
 	MATERIAL_DS_REFINE_NORMAL,
 	MATERIAL_DS_REFINE_BLESSED,
 	MATERIAL_DS_REFINE_HOLLY,
-#if defined(__DS_CHANGE_ATTR__)
-	MATERIAL_DS_CHANGE_ATTR,
-#endif
 	MATERIAL_PASSIVE_WEAPON,
 	MATERIAL_PASSIVE_ARMOR,
 	MATERIAL_PASSIVE_ACCE,
@@ -277,198 +383,35 @@
 
 enum EToolSubTypes
 {
-	TOOL_FISHING_ROD,
+	TOOL_FISHING_ROD
 };
 
 enum ELotterySubTypes
 {
 	LOTTERY_TICKET,
-	LOTTERY_INSTANT,
-};
-
-enum EMetinSubTypes
-{
-	METIN_NORMAL,
-	METIN_SUNGMA,
-};
-
-enum EFishSubTypes
-{
-	FISH_ALIVE,
-	FISH_DEAD,
-};
-
-enum EResourceSubTypes
-{
-	RESOURCE_FISHBONE,
-	RESOURCE_WATERSTONEPIECE,
-	RESOURCE_WATERSTONE,
-	RESOURCE_BLOOD_PEARL,
-	RESOURCE_BLUE_PEARL,
-	RESOURCE_WHITE_PEARL,
-	RESOURCE_BUCKET,
-	RESOURCE_CRYSTAL,
-	RESOURCE_GEM,
-	RESOURCE_STONE,
-	RESOURCE_METIN,
-	RESOURCE_ORE,
-#if defined(__AURA_COSTUME_SYSTEM__)
-	RESOURCE_AURA,
-#endif
-};
-
-enum EUniqueSubTypes
-{
-	UNIQUE_NONE,
-	UNIQUE_BOOK,
-	UNIQUE_SPECIAL_RIDE,
-	UNIQUE_3,
-	UNIQUE_4,
-	UNIQUE_5,
-	UNIQUE_6,
-	UNIQUE_7,
-	UNIQUE_8,
-	UNIQUE_9,
-	UNIQUE_BUNDLE,
+	LOTTERY_INSTANT
 };
 
-enum EQuestSubTypes
-{
-	QUEST_NONE,
-	QUEST_PET_PAY,
-	QUEST_WARP,
-	QUEST_GEM_BAG,
-};
-
-enum EGiftBoxSubTypes
-{
-	GIFTBOX_NONE,
-	GIFTBOX_NORMAL,
-	GIFTBOX_SPECIAL,
-};
-
-enum ECostumeSubTypes
-{
-	COSTUME_BODY = ARMOR_BODY, // [߿!!] ECostumeSubTypes enum value  EArmorSubTypes װͰ ƾ .
-	COSTUME_HAIR = ARMOR_HEAD, // ̴ ڽ ۿ ߰ Ӽ ̰ڴٴ  û    Ȱϱ .
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-	COSTUME_MOUNT,
-#endif
-#if defined(__ACCE_COSTUME_SYSTEM__)
-	COSTUME_ACCE,
-#endif
-#if defined(__WEAPON_COSTUME_SYSTEM__)
-	COSTUME_WEAPON,
-#endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-	COSTUME_AURA,
-#endif
-	COSTUME_NUM_TYPES,
-};
-
-#if defined(__DRAGON_SOUL_SYSTEM__)
-enum EDragonSoulSubType
-{
-	DS_SLOT1,
-	DS_SLOT2,
-	DS_SLOT3,
-	DS_SLOT4,
-	DS_SLOT5,
-	DS_SLOT6,
-#if defined(__DS_7_SLOT__)
-	DS_SLOT7,
-#endif
-	DS_SLOT_MAX,
-};
-#endif
-
-enum EExtractSubTypes
-{
-	EXTRACT_DRAGON_SOUL,
-	EXTRACT_DRAGON_HEART,
-};
-
-#if defined(__MOVE_COSTUME_ATTR__)
-enum EMediumSubTypes
-{
-	MEDIUM_MOVE_COSTUME_ATTR,
-#if defined(__ACCE_COSTUME_SYSTEM__)
-	MEDIUM_MOVE_ACCE_ATTR,
-#endif
-};
-#endif
-
-#if defined(__GACHA_SYSTEM__)
-enum EGachaSubTypes
-{
-	USE_GACHA,
-#if defined(__LUCKY_BOX__)
-	GEM_LUCKY_BOX_GACHA,
-	SPECIAL_LUCKY_BOX_GACHA,
-#endif
-};
-#endif
-
-enum EPassiveSubTypes
-{
-	PASSIVE_JOB,
-};
-
-enum EMercenarySubTypes
-{
-	MERCENARY_0,
-	MERCENARY_1,
-	MERCENARY_2,
-	MERCENARY_3,
-	MERCENARY_4,
-	MERCENARY_5,
-	MERCENARY_6,
-};
-
-enum EAlchemySubTypes
-{
-	ALCHEMY_ARMOR,
-	ALCHEMY_WEAPON,
-	ALCHEMY_ACCESSORY,
-	ALCHEMY_BELT,
-	ALCHEMY_EVENT,
-	ALCHEMY_ETC,
-	ALCHEMY_JOB,
-	ALCHEMY_SETADD_WEAPON,
-	ALCHEMY_SETADD_ARMOR_BODY,
-	ALCHEMY_SETADD_ARMOR_HELMET,
-	ALCHEMY_PET,
-	ALCHEMY_SKILL_BOOK,
-	ALCHEMY_GLOVE,
-};
-
-#if defined(__SOUL_SYSTEM__)
-enum ESoulSubTypes
-{
-	RED_SOUL,
-	BLUE_SOUL,
-};
-#endif
-
-enum EItemFlags
+enum EItemFlag
 {
 	ITEM_FLAG_REFINEABLE = (1 << 0),
 	ITEM_FLAG_SAVE = (1 << 1),
 	ITEM_FLAG_STACKABLE = (1 << 2), //  ĥ  
 	ITEM_FLAG_COUNT_PER_1GOLD = (1 << 3),
 	ITEM_FLAG_SLOW_QUERY = (1 << 4),
-	ITEM_FLAG_UNIQUE = (1 << 5),
-	ITEM_FLAG_MAKECOUNT = (1 << 6),
-	ITEM_FLAG_IRREMOVABLE = (1 << 7),
-	ITEM_FLAG_CONFIRM_WHEN_USE = (1 << 8),
-	ITEM_FLAG_QUEST_USE = (1 << 9),
-	ITEM_FLAG_QUEST_USE_MULTIPLE = (1 << 10),
-	ITEM_FLAG_QUEST_GIVE = (1 << 11),
-	ITEM_FLAG_LOG = (1 << 12),
-	ITEM_FLAG_APPLICABLE = (1 << 13),
+	ITEM_FLAG_UNUSED01 = (1 << 5), // UNUSED
+	ITEM_FLAG_UNIQUE = (1 << 6),
+	ITEM_FLAG_MAKECOUNT = (1 << 7),
+	ITEM_FLAG_IRREMOVABLE = (1 << 8),
+	ITEM_FLAG_CONFIRM_WHEN_USE = (1 << 9),
+	ITEM_FLAG_QUEST_USE = (1 << 10),
+	ITEM_FLAG_QUEST_USE_MULTIPLE = (1 << 11),
+	ITEM_FLAG_QUEST_GIVE = (1 << 12),
+	ITEM_FLAG_LOG = (1 << 13),
+	ITEM_FLAG_APPLICABLE = (1 << 14),
 };
 
-enum EItemAntiFlags
+enum EItemAntiFlag
 {
 	ITEM_ANTIFLAG_FEMALE = (1 << 0), //   Ұ
 	ITEM_ANTIFLAG_MALE = (1 << 1), //   Ұ
@@ -497,20 +440,16 @@
 	ITEM_ANTIFLAG_REINFORCE = (1 << 22),
 	ITEM_ANTIFLAG_ENCHANT = (1 << 23),
 	ITEM_ANTIFLAG_ENERGY = (1 << 24),
-//#if defined(__GROWTH_PET_SYSTEM__)
 	ITEM_ANTIFLAG_PETFEED = (1 << 25),
-//#endif
 	ITEM_ANTIFLAG_APPLY = (1 << 26),
 #if defined(__ACCE_COSTUME_SYSTEM__)
 	ITEM_ANTIFLAG_ACCE = (1 << 27),
 #endif
-#if defined(__MAILBOX__)
 	ITEM_ANTIFLAG_MAIL = (1 << 28),
-#endif
-	ITEM_ANTIFLAG_DESTROY = (1 << 29), // Custom
+	ITEM_ANTIFLAG_DESTROY = (1 << 29),
 };
 
-enum EItemWearableFlags
+enum EItemWearableFlag
 {
 	WEARABLE_BODY = (1 << 0),
 	WEARABLE_HEAD = (1 << 1),
@@ -523,49 +462,24 @@
 	WEARABLE_SHIELD = (1 << 8),
 	WEARABLE_ARROW = (1 << 9),
 	WEARABLE_HAIR = (1 << 10),
-#if defined(__PENDANT_SYSTEM__)
-	WEARABLE_PENDANT = (1 << 11),
-#endif
-#if defined(__GLOVE_SYSTEM__)
-	WEARABLE_GLOVE = (1 << 12),
-#endif
-};
-
-enum EWearPositions
-{
-	WEAR_BODY,
-	WEAR_HEAD,
-	WEAR_FOOTS,
-	WEAR_WRIST,
-	WEAR_WEAPON,
-	WEAR_NECK,
-	WEAR_EAR,
-	WEAR_UNIQUE1,
-	WEAR_UNIQUE2,
-	WEAR_ARROW,
-	WEAR_SHIELD,
-	WEAR_BELT,
-#if defined(__PENDANT_SYSTEM__)
-	WEAR_PENDANT,
-#endif
-#if defined(__GLOVE_SYSTEM__)
-	WEAR_GLOVE,
-#endif
-	WEAR_COSTUME_BODY,
-	WEAR_COSTUME_HAIR,
+	WEARABLE_ABILITY = (1 << 11),
+	WEARABLE_COSTUME_BODY = (1 << 12),
+	WEARABLE_COSTUME_HAIR = (1 << 13),
 #if defined(__MOUNT_COSTUME_SYSTEM__)
-	WEAR_COSTUME_MOUNT,
+	WEARABLE_COSTUME_MOUNT = (1 << 14),
 #endif
 #if defined(__ACCE_COSTUME_SYSTEM__)
-	WEAR_COSTUME_ACCE,
+	WEARABLE_COSTUME_ACCE = (1 << 15),
 #endif
 #if defined(__WEAPON_COSTUME_SYSTEM__)
-	WEAR_COSTUME_WEAPON,
+	WEARABLE_COSTUME_WEAPON = (1 << 16),
 #endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-	WEAR_COSTUME_AURA,
+#if defined(__PENDANT_SYSTEM__)
+	WEARABLE_PENDANT = (1 << 17),
+#endif
+#if defined(__GLOVE_SYSTEM__)
+	WEARABLE_GLOVE = (1 << 18),
 #endif
-	WEAR_MAX_NUM = 32
 };
 
 enum ELimitTypes
@@ -577,6 +491,7 @@
 	LIMIT_DEX,
 	LIMIT_INT,
 	LIMIT_CON,
+	LIMIT_PCBANG,
 
 	///  ο   ǽð ð  (socket0 Ҹ ð : unix_timestamp Ÿ)
 	LIMIT_REAL_TIME,
@@ -590,8 +505,8 @@
 	/// socket0  ð ʴ . (   ش  0̸  limit value socket0 )
 	LIMIT_TIMER_BASED_ON_WEAR,
 
+	/// SungMa Update (New World)
 	LIMIT_NEWWORLD_LEVEL,
-	LIMIT_DURATION,
 
 	LIMIT_MAX_NUM
 };
@@ -613,242 +528,37 @@
 	REFINE_TYPE_MUSIN,
 	REFINE_TYPE_BDRAGON,
 #if defined(__STONE_OF_BLESS__)
-	REFINE_TYPE_BLESSING_STONE,
+	REFINE_TYPE_STONE_OF_BLESS,
 #endif
 #if defined(__SOUL_SYSTEM__)
-	REFINE_TYPE_SOUL_AWAKE,
 	REFINE_TYPE_SOUL_EVOLVE,
+	REFINE_TYPE_SOUL_AWAKE,
 #endif
 };
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
-enum EDragonSoulGradeTypes
-{
-	DRAGON_SOUL_GRADE_NORMAL,
-	DRAGON_SOUL_GRADE_BRILLIANT,
-	DRAGON_SOUL_GRADE_RARE,
-	DRAGON_SOUL_GRADE_ANCIENT,
-	DRAGON_SOUL_GRADE_LEGENDARY,
-#if defined(__DS_GRADE_MYTH__)
-	DRAGON_SOUL_GRADE_MYTH,
-#endif
-	DRAGON_SOUL_GRADE_MAX,
-};
-
-enum EDragonSoulStepTypes
-{
-	DRAGON_SOUL_STEP_LOWEST,
-	DRAGON_SOUL_STEP_LOW,
-	DRAGON_SOUL_STEP_MID,
-	DRAGON_SOUL_STEP_HIGH,
-	DRAGON_SOUL_STEP_HIGHEST,
-	DRAGON_SOUL_STEP_MAX,
-};
-
-#if defined(__DS_CHANGE_ATTR__)
-enum EDragonSoulChangeAttrMaterialCount
-{
-	DRAGON_SOUL_CHANGE_ATTR_STEP_LOWEST = 1,
-	DRAGON_SOUL_CHANGE_ATTR_STEP_LOW = 3,
-	DRAGON_SOUL_CHANGE_ATTR_STEP_MID = 9,
-	DRAGON_SOUL_CHANGE_ATTR_STEP_HIGH = 27,
-	DRAGON_SOUL_CHANGE_ATTR_STEP_HIGHEST = 81,
-};
-#endif
-
-#define DRAGON_SOUL_STRENGTH_MAX 7
-
-enum EDSInventoryMaxNum
-{
-	DRAGON_SOUL_INVENTORY_MAX_NUM = DS_SLOT_MAX * DRAGON_SOUL_GRADE_MAX * DRAGON_SOUL_BOX_SIZE,
-};
-#endif
-
 #if defined(__ACCE_COSTUME_SYSTEM__)
-enum EItemAcceSocket
-{
-	ITEM_SOCKET_ACCE_DRAIN_ITEM_VNUM,
-	ITEM_SOCKET_ACCE_DRAIN_VALUE,
-};
-#endif
-
-#if defined(__AURA_COSTUME_SYSTEM__)
-enum EItemAuraSocket
-{
-	ITEM_SOCKET_AURA_DRAIN_ITEM_VNUM,
-	ITEM_SOCKET_AURA_LEVEL_VALUE,
-};
-
-enum EItemAuraMaterialValues
-{
-	ITEM_AURA_MATERIAL_EXP_VALUE,
-};
-#endif
-
-#if defined(__MOVE_COSTUME_ATTR__) && defined(__ACCE_COSTUME_SYSTEM__)
-enum EMediumMoveAcceResult
-{
-	MEDIUM_MOVE_ACCE_FAIL,
-	MEDIUM_MOVE_ACCE_PARTIAL,
-	MEDIUM_MOVE_ACCE_SUCCESS,
-	MEDIUM_MOVE_ACCE_MAX,
-};
-#endif
-
-#if defined(__SOUL_SYSTEM__)
-enum ESoulGradeType
+enum EAcceInfo
 {
-	SOUL_GRADE_BASIC,
-	SOUL_GRADE_GLEAMING,
-	SOUL_GRADE_LUSTROUS,
-	SOUL_GRADE_PRISMATIC,
-	SOUL_GRADE_ILUMINED,
-	SOUL_GRADE_MAX,
-};
-#endif
-
-#if defined(__LOOT_FILTER_SYSTEM__)
-enum ELootFilter
-{
-	WEAPON_SELECT_DATA_MAX = 5,
-	ARMOR_SELECT_DATA_MAX = 5,
-	HEAD_SELECT_DATA_MAX = 5,
-	COMMON_SELECT_DATA_MAX = 10,
-	COSTUME_SELECT_DATA_MAX = 6,
-	DS_SELECT_DATA_MAX = 2,
-	UNIQUE_SELECT_DATA_MAX = 2,
-	REFINE_SELECT_DATA_MAX = 3,
-	POTION_SELECT_DATA_MAX = 3,
-	FISH_MINING_SELECT_DATA_MAX = 3,
-	MOUNT_PET_SELECT_DATA_MAX = 4,
-	SKILL_BOOK_SELECT_DATA_MAX = 6,
-	ETC_SELECT_DATA_MAX = 8,
-	EVENT_SELECT_DATA_MAX = 0, // Unused
-
-	WEAPON_ON_OFF = 0,
-	WEAPON_REFINE_MIN,
-	WEAPON_REFINE_MAX,
-	WEAPON_WEARING_LEVEL_MIN,
-	WEAPON_WEARING_LEVEL_MAX,
-	WEAPON_SELECT_DATA_JOB_WARRIOR,
-	WEAPON_SELECT_DATA_JOB_SURA,
-	WEAPON_SELECT_DATA_JOB_ASSASSIN,
-	WEAPON_SELECT_DATA_JOB_SHAMAN,
-	WEAPON_SELECT_DATA_JOB_LYCAN,
-
-	ARMOR_ON_OFF,
-	ARMOR_REFINE_MIN,
-	ARMOR_REFINE_MAX,
-	ARMOR_WEARING_LEVEL_MIN,
-	ARMOR_WEARING_LEVEL_MAX,
-	ARMOR_SELECT_DATA_JOB_WARRIOR,
-	ARMOR_SELECT_DATA_JOB_SURA,
-	ARMOR_SELECT_DATA_JOB_ASSASSIN,
-	ARMOR_SELECT_DATA_JOB_SHAMAN,
-	ARMOR_SELECT_DATA_JOB_LYCAN,
-
-	HEAD_ON_OFF,
-	HEAD_REFINE_MIN,
-	HEAD_REFINE_MAX,
-	HEAD_WEARING_LEVEL_MIN,
-	HEAD_WEARING_LEVEL_MAX,
-	HEAD_SELECT_DATA_JOB_WARRIOR,
-	HEAD_SELECT_DATA_JOB_SURA,
-	HEAD_SELECT_DATA_JOB_ASSASSIN,
-	HEAD_SELECT_DATA_JOB_SHAMAN,
-	HEAD_SELECT_DATA_JOB_LYCAN,
-
-	COMMON_ON_OFF,
-	COMMON_REFINE_MIN,
-	COMMON_REFINE_MAX,
-	COMMON_WEARING_LEVEL_MIN,
-	COMMON_WEARING_LEVEL_MAX,
-	COMMON_SELECT_DATA_SHOE,
-	COMMON_SELECT_DATA_BELT,
-	COMMON_SELECT_DATA_BRACELET,
-	COMMON_SELECT_DATA_NECKLACE,
-	COMMON_SELECT_DATA_EARRING,
-	COMMON_SELECT_DATA_SHIELD,
-	COMMON_SELECT_DATA_GLOVE,
-	COMMON_SELECT_DATA_TALISMAN,
-	COMMON_SELECT_DATA_FISHING_ROD,
-	COMMON_SELECT_DATA_PICKAXE,
-
-	COSTUME_ON_OFF,
-	COSTUME_SELECT_DATA_WEAPON,
-	COSTUME_SELECT_DATA_ARMOR,
-	COSTUME_SELECT_DATA_HAIR,
-	COSTUME_SELECT_DATA_ACCE,
-	COSTUME_SELECT_DATA_AURA,
-	COSTUME_SELECT_DATA_ETC,
-
-	DS_ON_OFF,
-	DS_SELECT_DATA_DS,
-	DS_SELECT_DATA_ETC,
-
-	UNIQUE_ON_OFF,
-	UNIQUE_SELECT_DATA_ABILITY,
-	UNIQUE_SELECT_DATA_ETC,
-
-	REFINE_ON_OFF,
-	REFINE_SELECT_DATA_MATERIAL,
-	REFINE_SELECT_DATA_STONE,
-	REFINE_SELECT_DATA_ETC,
-
-	POTION_ON_OFF,
-	POTION_SELECT_DATA_ABILITY,
-	POTION_SELECT_DATA_HAIRDYE,
-	POTION_SELECT_DATA_ETC,
-
-	FISH_MINING_ON_OFF,
-	FISH_MINING_SELECT_DATA_FOOD,
-	FISH_MINING_SELECT_DATA_STONE,
-	FISH_MINING_SELECT_DATA_ETC,
-
-	MOUNT_PET_ON_OFF,
-	MOUNT_PET_SELECT_DATA_CHARGED_PET,
-	MOUNT_PET_SELECT_DATA_MOUNT,
-	MOUNT_PET_SELECT_DATA_FREE_PET,
-	MOUNT_PET_SELECT_DATA_EGG,
-
-	SKILL_BOOK_ON_OFF,
-	SKILL_BOOK_SELECT_DATA_JOB_WARRIOR,
-	SKILL_BOOK_SELECT_DATA_JOB_SURA,
-	SKILL_BOOK_SELECT_DATA_JOB_ASSASSIN,
-	SKILL_BOOK_SELECT_DATA_JOB_SHAMAN,
-	SKILL_BOOK_SELECT_DATA_JOB_LYCAN,
-	SKILL_BOOK_SELECT_DATA_JOB_PUBLIC,
-
-	ETC_ON_OFF,
-	ETC_SELECT_DATA_GIFTBOX,
-	ETC_SELECT_DATA_MATRIMONY,
-	ETC_SELECT_DATA_SEAL,
-	ETC_SELECT_DATA_PARTY,
-	ETC_SELECT_DATA_POLYMORPH,
-	ETC_SELECT_DATA_RECIPE,
-	ETC_SELECT_DATA_WEAPON_ARROW,
-	ETC_SELECT_DATA_ETC,
-
-	EVENT_ON_OFF,
-
-	LOOT_FILTER_SETTINGS_MAX,
-};
-#endif
-
-#if defined(__ITEM_VALUE10__)
-enum EItemValueMinMax
-{
-	ITEM_VALUE_DEF_MIN_INDEX = 6,
-	ITEM_VALUE_MTK_MIN_INDEX = 6,
-	ITEM_VALUE_MTK_MAX_INDEX = 7,
-	ITEM_VALUE_ATK_MIN_INDEX = 8,
-	ITEM_VALUE_ATK_MAX_INDEX = 9,
-
-	ITEM_SOCKET_DEF_MINMAX_RANDOM = 3,
-	ITEM_SOCKET_BELT_DEF_MINMAX_RANDOM = 3,
-	ITEM_SOCKET_MTK_MINMAX_RANDOM = 3,
-	ITEM_SOCKET_ATK_MINMAX_RANDOM = 4,
-	ITEM_VALUE_MINMAX_RANDOM_DIVISION_VALUE = 100000,
+	ACCE_GRADE_VALUE_FIELD = 0,
+	ACCE_ABSORPTION_SOCKET = 0,
+	ACCE_ABSORBED_SOCKET = 1,
+	ACCE_GRADE_1_ABS = 1,
+	ACCE_GRADE_2_ABS = 5,
+	ACCE_GRADE_3_ABS = 10,
+	ACCE_GRADE_4_ABS_MIN = 11,
+	ACCE_GRADE_4_ABS_MAX = 25,
+	ACCE_GRADE_4_ABS_MAX_COMB = 19,
+	ACCE_GRADE_4_ABS_RANGE = 5,
+	ACCE_EFFECT_FROM_ABS = 19,
+	ACCE_WINDOW_MAX_MATERIALS = 2,
+	ACCE_GRADE_1_PRICE = 100000,
+	ACCE_GRADE_2_PRICE = 200000,
+	ACCE_GRADE_3_PRICE = 300000,
+	ACCE_GRADE_4_PRICE = 500000,
+	ACCE_COMBINE_GRADE_1 = 80,
+	ACCE_COMBINE_GRADE_2 = 70,
+	ACCE_COMBINE_GRADE_3 = 50,
+	ACCE_COMBINE_GRADE_4 = 30,
 };
 #endif
 
diff -ruN baseline/server/server/home/metin2/Source/Server/common/length.h final/server/server/home/metin2/Source/Server/common/length.h
--- baseline/server/server/home/metin2/Source/Server/common/length.h	2025-06-29 13:37:18.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/common/length.h	2022-04-27 09:21:18.000000000 +0000
@@ -5,11 +5,6 @@
 
 #define WORD_MAX 0xffff
 
-#define POINT_TYPE WORD
-#define POINT_VALUE long
-#define POINT_MIN LONG_MIN
-#define POINT_MAX LONG_MAX
-
 enum EMisc
 {
 	MAX_HOST_LENGTH = 15,
@@ -23,36 +18,28 @@
 #endif
 	ACCOUNT_STATUS_MAX_LEN = 8,
 	CHARACTER_NAME_MAX_LEN = 24,
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-	COUNTRY_NAME_MAX_LEN = 2,
-#endif
 	SHOP_SIGN_MAX_LEN = 32,
-
+	INVENTORY_PAGE_SIZE = 45,
+#if defined(__INVENTORY_4PAGES__)
+	INVENTORY_PAGE_COUNT = 4, // 180
+#else
+	INVENTORY_PAGE_COUNT = 2, // 90
+#endif
+	INVENTORY_MAX_NUM = INVENTORY_PAGE_SIZE * INVENTORY_PAGE_COUNT,
 	ABILITY_MAX_NUM = 50,
 	EMPIRE_MAX_NUM = 4,
 	BANWORD_MAX_LEN = 24,
 	SOCIAL_ID_MAX_LEN = 18,
 
-#if defined(__RANKING_SYSTEM__)
-	PARTY_MAX_MEMBER = 8,
-#endif
-
 	GUILD_NAME_MAX_LEN = 12,
 
-#if defined(__MYSHOP_EXPANSION__)
-	SHOP_HOST_ITEM_MAX = 80, /* The maximum number of items of the pc host. */
-#endif
 	SHOP_HOST_ITEM_MAX_NUM = 40, /* ȣƮ ִ   */
-
 	SHOP_GUEST_ITEM_MAX_NUM = 18, /* ԽƮ ִ   */
-#if defined(__MYSHOP_EXPANSION__)
-	SHOP_PRICELIST_MAX_NUM = SHOP_HOST_ITEM_MAX,
-#else
+
 	SHOP_PRICELIST_MAX_NUM = 40, ///< λ  Ʈ   ִ 
-#endif
 
 #if defined(__MYSHOP_DECO__)
-	MYSHOP_MAX_TABS = 2,
+	MYSHOP_MAX_TABS = 1,
 #endif
 
 	CHAT_MAX_LEN = 512,
@@ -61,13 +48,12 @@
 
 	JOURNAL_MAX_NUM = 2,
 
-	QUERY_MAX_LEN = 16384,
+	QUERY_MAX_LEN = 8192,
 
 	FILE_MAX_LEN = 128,
 
 	PLAYER_EXP_TABLE_MAX = 120,
 	PLAYER_MAX_LEVEL_CONST = 120,
-
 #if defined(__CONQUEROR_LEVEL__)
 	PLAYER_CONQUEROR_EXP_TABLE_MAX = 30,
 	PLAYER_MAX_CONQUEROR_LEVEL_CONST = 30,
@@ -85,31 +71,30 @@
 
 	APPLY_NAME_MAX_LEN = 32,
 	EVENT_FLAG_NAME_MAX_LEN = 32,
-	CHARACTER_FOLDER_MAX_LEN = 64,
 
 	MOB_SKILL_MAX_NUM = 5,
 
-	POINT_MAX_NUM = 1000,
-
+	POINT_MAX_NUM = 255,
+	DRAGON_SOUL_BOX_SIZE = 32,
+	DRAGON_SOUL_BOX_COLUMN_NUM = 8,
+	DRAGON_SOUL_BOX_ROW_NUM = DRAGON_SOUL_BOX_SIZE / DRAGON_SOUL_BOX_COLUMN_NUM,
+	DRAGON_SOUL_REFINE_GRID_SIZE = 15,
 	MAX_AMOUNT_OF_MALL_BONUS = 20,
 
-	//WEAR_MAX_NUM = 32,
-
-	GOLD_MAX = 2000000000, // 1999999999
+	WEAR_MAX_NUM = 32,
 
+	GOLD_MAX = 200000000, // 1999999999
 #if defined(__CHEQUE_SYSTEM__)
-	CHEQUE_MAX = 3000, // 999
+	CHEQUE_MAX = 1000, // 999
 #endif
-
 #if defined(__GEM_SYSTEM__)
 	GEM_MAX = 1000000, // 999999
 #endif
 
-#if defined(_DEBUG) && defined(_WIN32)
-	MAX_MAP_ALLOW = 128,
-#else
-	MAX_MAP_ALLOW = 64,
-#endif
+	MAX_MAP_ALLOW = 32,
+
+	PIN_CODE_LENGTH = 4,
+	HWID_MAX_NUM = 128,
 
 	SHOP_TAB_NAME_MAX = 32,
 #if defined(__SHOPEX_TAB4__)
@@ -118,90 +103,81 @@
 	SHOP_TAB_COUNT_MAX = 3,
 #endif
 
-#if defined(__GEM_SHOP__)
-	GEM_SHOP_SLOT_COUNT = 9,
-#	if defined(__CONQUEROR_LEVEL__)
-	GEM_SHOP_SPECIAL_SLOT_COUNT = 3,
-#	endif
-#endif
-
-#if defined(__SUMMER_EVENT_ROULETTE__)
-	ROULETTE_ITEM_MAX = 20,
-#endif
-
-#ifdef __OFFLINE_SHOP__
-	OFFLINE_SHOP_ITEM_WIDTH = 10,
-	OFFLINE_SHOP_ITEM_HEIGHT = 8,
-	OFFLINE_SHOP_PAGES = 4,
-	OFFLINE_SHOP_ITEM_COUNT = OFFLINE_SHOP_ITEM_WIDTH * OFFLINE_SHOP_ITEM_HEIGHT * OFFLINE_SHOP_PAGES,
-	OFFLINE_SHOP_NAME_CHANGE_TIMELIMIT = 60 * 60,
-#endif
-
-	WINDOW_OPENER_MAX_DISTANCE = 1000,
-};
+	BELT_INVENTORY_SLOT_WIDTH = 4,
+	BELT_INVENTORY_SLOT_HEIGHT = 4,
+	BELT_INVENTORY_SLOT_COUNT = BELT_INVENTORY_SLOT_WIDTH * BELT_INVENTORY_SLOT_HEIGHT,
 
-enum EShopSearchMode
-{
-	MODE_NONE,
-	MODE_LOOKING,
-	MODE_TRADING,
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	SPECIAL_INVENTORY_PAGE_SIZE = 45,
+	SPECIAL_INVENTORY_PAGE_COUNT = 5, // 225
+	SPECIAL_INVENTORY_MAX_NUM = SPECIAL_INVENTORY_PAGE_SIZE * SPECIAL_INVENTORY_PAGE_COUNT,
+	SPECIAL_INVENTORY_MAX_PAGE_NUM = SPECIAL_INVENTORY_MAX_NUM * SPECIAL_INVENTORY_PAGE_COUNT,
+
+	SKILL_BOOK_INVENTORY_MAX_NUM = SPECIAL_INVENTORY_MAX_NUM,
+	UPGRADE_ITEMS_INVENTORY_MAX_NUM = SPECIAL_INVENTORY_MAX_NUM,
+	STONE_INVENTORY_MAX_NUM = SPECIAL_INVENTORY_MAX_NUM,
+	GIFT_BOX_INVENTORY_MAX_NUM = SPECIAL_INVENTORY_MAX_NUM,
+#endif
+
+	/**
+		 ****  Ҵ     (DB Item Position) ****
+		+------------------------------------------------------+ 0
+		| ĳ ⺻ κ丮 (45ĭ * 2) 90ĭ           |
+		+------------------------------------------------------+ 90 = INVENTORY_MAX_NUM(90)
+		| ĳ  â ( ) 32ĭ                |
+		+------------------------------------------------------+ 122 = INVENTORY_MAX_NUM(90) + WEAR_MAX_NUM(32)
+		| ȥ  â ( ȥ) 12ĭ                |
+		+------------------------------------------------------+ 134 = 122 + DS_SLOT_MAX(6) * DRAGON_SOUL_DECK_MAX_NUM(2)
+		| ȥ  â  ( ̻) 18ĭ               |
+		+------------------------------------------------------+ 152 = 134 + DS_SLOT_MAX(6) * DRAGON_SOUL_DECK_RESERVED_MAX_NUM(3)
+		| Ʈ κ丮 (Ʈ ÿ Ʈ   Ȱ)|
+		+------------------------------------------------------+ 168 = 152 + BELT_INVENTORY_SLOT_COUNT(16) = INVENTORY_AND_EQUIP_CELL_MAX
+		| ̻                                               |
+		+------------------------------------------------------+ ??
+	*/
 };
 
-enum EPrivateShopState
+enum EGrowthPet
 {
-	STATE_UNAVAILABLE,
-	STATE_CLOSED,
-	STATE_OPEN,
-	STATE_MODIFY
-};
+	PET_MAX_LEVEL = 105,
 
-enum EPrivateShopSearchState
-{
-	STATE_NON_EXISTENT,
-	STATE_REMOVED,
-	STATE_AVAILABLE,
-	STATE_RESTRICTED,
-};
+	PET_ATTR_CHANGE_ITEMVNUM = 55033,
+	PET_NAME_MAX_SIZE = 20,
+	PET_NAME_MIN_SIZE = 4,
+	PET_HATCHING_MONEY = 100000,
+	PET_SKILL_COUNT_MAX = 3,
+	PET_GROWTH_SKILL_LEVEL_MAX = 20,
+	PET_SKILL_UPGRADE_PRICE = 2000000,
+	PET_GROWTH_SKILL_OPEN_EVOL_LEVEL = 4,
+	PET_FEED_SLOT_MAX = 9,
+	PET_REVIVE_MATERIAL_SLOT_MAX = 10,
 
-enum EInventoryPositions
-{
-	INVENTORY_WIDTH = 5,
-	INVENTORY_HEIGHT = 9,
-	INVENTORY_PAGE_SIZE = INVENTORY_WIDTH * INVENTORY_HEIGHT, // 45
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	INVENTORY_PAGE_COUNT = 4, // 180
-#else
-	INVENTORY_PAGE_COUNT = 2, // 90
-#endif
-	INVENTORY_MAX_NUM = INVENTORY_PAGE_SIZE * INVENTORY_PAGE_COUNT,
+	EGG_TO_UPBRINGING_DELTA = 300,
+	MELEY_PET_EGG_VNUM = 55406,
 
-	DRAGON_SOUL_BOX_SIZE = 32,
-	DRAGON_SOUL_BOX_COLUMN_NUM = 8,
-	DRAGON_SOUL_BOX_ROW_NUM = DRAGON_SOUL_BOX_SIZE / DRAGON_SOUL_BOX_COLUMN_NUM,
-	DRAGON_SOUL_REFINE_GRID_SIZE = 15,
+	EXP_TYPE_MOB = 1,
+	EXP_TYPE_ITEM = 2,
 
-	BELT_INVENTORY_SLOT_WIDTH = 4,
-	BELT_INVENTORY_SLOT_HEIGHT = 4,
-	BELT_INVENTORY_SLOT_COUNT = BELT_INVENTORY_SLOT_WIDTH * BELT_INVENTORY_SLOT_HEIGHT,
-};
+	PET_EVOL_MAX_ITEM_COUNT = 7,
+	PET_LAST_EVOL_MIN_DAY_COUNT = 30,
 
-#if defined(__EXTEND_INVEN_SYSTEM__)
-enum EExtendInven
-{
-	EX_INVENTORY_PAGE_COUNT = 2,
-	EX_INVENTORY_PAGE_START = 3,
-	EX_INVENTORY_STAGE_MAX = INVENTORY_HEIGHT * EX_INVENTORY_PAGE_COUNT,
-};
+	PET_MONKEY = 55701,
+	PET_SPIDER = 55702,
+	PET_RAZADOR = 55703,
+	PET_NEMERE = 55704,
+	PET_BLUE_DRAGON = 55705,
+	PET_RED_DRAGON = 55706,
+	PET_BASHIIDO = 55707,
+	PET_MINI_EXECUTOR = 55708,
+	PET_NESSIE = 55709,
+	PET_AZRAEL = 55710,
+	PET_EXEDYAR = 55711,
+	PET_MAX_NUM = 11,
 
-enum EExtendInvenMsg
-{
-	EX_INVEN_FAIL_FALL_SHORT,
-	EX_INVEN_SUCCESS,
-	EX_INVEN_FAIL_FOURTH_PAGE_STAGE_MAX,
+	PET_MAX_BONUS_NUM = 8,
 };
-#endif
 
-#if defined(__REFINE_MSG_ADD__)
+#if defined(__REFINE_FAIL_TYPE__)
 enum ERefineFailType
 {
 	REFINE_FAIL_GRADE_DOWN,
@@ -211,6 +187,17 @@
 };
 #endif
 
+#if defined(__CHANGE_LOOK_SYSTEM__)
+enum EChangeLookInfo
+{
+	CHANGE_LOOK_WINDOW_MAX_MATERIALS = 3,
+	CHANGE_LOOK_TRANSMUTATION_PRICE = 50000000,
+	CHANGE_LOOK_SCROLL_VNUM = 72326,
+	CHANGE_LOOK_SCROLL_VNUM2 = 72341,
+	CHANGE_LOOK_CAN_EQUIP_MULTI_GENDER = FALSE,
+};
+#endif
+
 #if defined(__SKILLBOOK_COMB_SYSTEM__)
 enum ESkillBookCombination
 {
@@ -219,17 +206,55 @@
 };
 #endif
 
-#if defined(__ATTR_6TH_7TH__)
-enum EAttr67Add
+enum EWearPositions
 {
-	NPC_STORAGE_SLOT_MAX = 1,
-	ATTR67_MATERIAL_MAX_COUNT = 10,
-	ATTR67_SUPPORT_MAX_COUNT = 5,
-	ATTR67_SUCCESS_PER_MATERIAL = 2,
-	ATTR67_ADD_WAIT_TIME = 60 * 60 * 24,
-};
+	WEAR_BODY,				// 0
+	WEAR_HEAD,				// 1
+	WEAR_FOOTS,				// 2
+	WEAR_WRIST,				// 3
+	WEAR_WEAPON,			// 4
+	WEAR_NECK,				// 5
+	WEAR_EAR,				// 6
+	WEAR_UNIQUE1,			// 7
+	WEAR_UNIQUE2,			// 8
+	WEAR_ARROW,				// 9
+	WEAR_SHIELD,			// 10
+	WEAR_ABILITY1,			// 11
+	WEAR_ABILITY2,			// 12
+	WEAR_ABILITY3,			// 13
+	WEAR_ABILITY4,			// 14
+	WEAR_ABILITY5,			// 15
+	WEAR_ABILITY6,			// 16
+	WEAR_ABILITY7,			// 17
+	WEAR_ABILITY8,			// 18
+	WEAR_COSTUME_BODY,		// 19
+	WEAR_COSTUME_HAIR,		// 20
+#if defined(__MOUNT_COSTUME_SYSTEM__)
+	WEAR_COSTUME_MOUNT,		// 21
+#endif
+#if defined(__ACCE_COSTUME_SYSTEM__)
+	WEAR_COSTUME_ACCE,		// 22
+#endif
+#if defined(__WEAPON_COSTUME_SYSTEM__)
+	WEAR_COSTUME_WEAPON,	// 23
+#endif
+
+	WEAR_RING1,				// 24 : ű 1 ()
+	WEAR_RING2,				// 25 : ű 2 ()
+
+	WEAR_BELT,				// 26 : ű Ʈ
+
+#if defined(__PENDANT_SYSTEM__)
+	WEAR_PENDANT,			// 27 : pendant
+#endif
+
+#if defined(__GLOVE_SYSTEM__)
+	WEAR_GLOVE,				// 27 : glove
 #endif
 
+	WEAR_MAX = 32			//
+};
+
 enum EDragonSoulDeckType
 {
 	DRAGON_SOUL_DECK_0,
@@ -239,31 +264,6 @@
 	DRAGON_SOUL_DECK_RESERVED_MAX_NUM = 3, // NOTE: ߿!   , 3 з   . DS DECK ø  ݵ  ŭ RESERVED ؾ !
 };
 
-enum EPrivateShop
-{
-	INVENTORY_PAGE_MAX_NUM = INVENTORY_PAGE_COUNT,
-	INVENTORY_PAGE_WIDTH = INVENTORY_WIDTH,
-	INVENTORY_PAGE_HEIGHT = INVENTORY_HEIGHT,
-	INVENTORY_PAGE_ITEM_MAX_NUM = INVENTORY_PAGE_WIDTH * INVENTORY_PAGE_HEIGHT,
-
-	PRIVATE_SHOP_PAGE_MAX_NUM = 2,
-	PRIVATE_SHOP_WIDTH = 8,
-	PRIVATE_SHOP_HEIGHT = 8,
-	PRIVATE_SHOP_PAGE_ITEM_MAX_NUM = PRIVATE_SHOP_WIDTH * PRIVATE_SHOP_HEIGHT,
-	PRIVATE_SHOP_HOST_ITEM_MAX_NUM = (PRIVATE_SHOP_WIDTH * PRIVATE_SHOP_HEIGHT) * PRIVATE_SHOP_PAGE_MAX_NUM,
-	PRIVATE_SHOP_LOCKED_SLOT_MAX_NUM = PRIVATE_SHOP_HOST_ITEM_MAX_NUM / 2,
-	PRIVATE_SHOP_SLOT_UNLOCK_ITEM = 72357,
-	PRIVATE_SHOP_MAX_PREMIUM_TIME = 3600 * 24 * 7,
-	SELECTED_ITEM_MAX_NUM = 10,
-
-	VALID_SALE_DAY_INTERVAL = 30,
-	VALID_MARKET_PRICE_DAY_INTERVAL = 3,
-	MARKET_ITEM_PRICE_UPDATE_SEC_INTERVAL = 3600,
-
-	TITLE_MAX_LEN = 32,
-	TITLE_MIN_LEN = 3,
-};
-
 enum ESex
 {
 	SEX_MALE,
@@ -326,22 +326,19 @@
 	RACE_FLAG_ORC = (1 << 4),
 	RACE_FLAG_MILGYO = (1 << 5),
 	RACE_FLAG_INSECT = (1 << 6),
-	RACE_FLAG_DESERT = (1 << 7),
-	RACE_FLAG_TREE = (1 << 8),
-	RACE_FLAG_DECO = (1 << 9),
-	RACE_FLAG_HIDE = (1 << 10),
-
-	// 20130117
-	//RACE_FLAG_ATT_ELEC = (1 << 11),
-	//RACE_FLAG_ATT_FIRE = (1 << 12),
-	//RACE_FLAG_ATT_ICE = (1 << 13),
-	//RACE_FLAG_ATT_WIND = (1 << 14),
-	//RACE_FLAG_ATT_EARTH = (1 << 15),
-
-	RACE_FLAG_ATT_CZ = (1 << 11),
-	RACE_FLAG_AWEAKEN = (1 << 12),
-	RACE_FLAG_SUNGMAHEE = (1 << 13),
-	RACE_FLAG_OUTPOST = (1 << 14),
+	RACE_FLAG_FIRE = (1 << 7),
+	RACE_FLAG_ICE = (1 << 8),
+	RACE_FLAG_DESERT = (1 << 9),
+	RACE_FLAG_TREE = (1 << 10),
+	RACE_FLAG_ATT_ELEC = (1 << 11),
+	RACE_FLAG_ATT_FIRE = (1 << 12),
+	RACE_FLAG_ATT_ICE = (1 << 13),
+	RACE_FLAG_ATT_WIND = (1 << 14),
+	RACE_FLAG_ATT_EARTH = (1 << 15),
+	RACE_FLAG_ATT_DARK = (1 << 16),
+#if defined(__ELEMENT_SYSTEM__)
+	RACE_FLAG_ZODIAC = (1 << 17),
+#endif
 };
 
 enum ELoads
@@ -353,93 +350,13 @@
 	LOAD_MASSIVE
 };
 
-//enum
-//{
-//	QUICKSLOT_TYPE_NONE,
-//	QUICKSLOT_TYPE_INVENTORY,
-//	QUICKSLOT_TYPE_BELT_INVENTORY,
-//	QUICKSLOT_TYPE_SKILL,
-//	QUICKSLOT_TYPE_COMMAND,
-//	QUICKSLOT_TYPE_MAX_NUM,
-//};
-//
-
-#ifdef __GROWTH_PET_SYSTEM__
-enum EGrowthPet
-{
-	PET_MAX_LEVEL = 120,
-
-	PET_ATTR_CHANGE_ITEMVNUM = 55033,
-	PET_NAME_MAX_SIZE = 20,
-	PET_NAME_MIN_SIZE = 4,
-	PET_HATCHING_MONEY = 100000,
-	PET_SKILL_COUNT_MAX = 3,
-	PET_GROWTH_SKILL_LEVEL_MAX = 20,
-	PET_SKILL_UPGRADE_PRICE = 2000000,
-	PET_GROWTH_SKILL_OPEN_EVOL_LEVEL = 4,
-	PET_FEED_SLOT_MAX = 9,
-	PET_REVIVE_MATERIAL_SLOT_MAX = 10,
-
-	EGG_TO_UPBRINGING_DELTA = 300,
-	MELEY_PET_EGG_VNUM = 55406,
-
-	EXP_TYPE_MOB = 1,
-	EXP_TYPE_ITEM = 2,
-
-	PET_EVOL_MAX_ITEM_COUNT = 7,
-	PET_LAST_EVOL_MIN_DAY_COUNT = 30,
-
-	PET_MONKEY = 55701,
-	PET_SPIDER = 55702,
-	PET_RAZADOR = 55703,
-	PET_NEMERE = 55704,
-	PET_BLUE_DRAGON = 55705,
-	PET_RED_DRAGON = 55706,
-	PET_AZRAEL = 55707,
-	PET_MINI_EXECUTOR = 55708,
-	PET_BASHIIDO = 55709,
-	PET_NESSIE = 55710,
-	PET_EXEDYAR = 55711,
-	PET_MAX_NUM = 11,
-
-	PET_MAX_BONUS_NUM = 8,
-};
-
-enum EPetState
+enum
 {
-	STATE_NONE,
-	STATE_UPBRINGING,
-	STATE_BAG,
-	STATE_SAFEBOX,
-};
-#endif
-
-enum ESlotType
-{
-	SLOT_TYPE_NONE,
-	SLOT_TYPE_INVENTORY,
-	SLOT_TYPE_SKILL,
-	SLOT_TYPE_EMOTION,
-	SLOT_TYPE_SHOP,
-	SLOT_TYPE_EXCHANGE_OWNER,
-	SLOT_TYPE_EXCHANGE_TARGET,
-	SLOT_TYPE_QUICK_SLOT,
-	SLOT_TYPE_SAFEBOX,
-	SLOT_TYPE_GUILDBANK,
-	SLOT_TYPE_ACCE,
-	SLOT_TYPE_PRIVATE_SHOP,
-	SLOT_TYPE_MALL,
-	SLOT_TYPE_DRAGON_SOUL_INVENTORY,
-	SLOT_TYPE_PET_FEED_WINDOW,
-	SLOT_TYPE_EQUIPMENT,
-	SLOT_TYPE_BELT_INVENTORY,
-	SLOT_TYPE_AUTO,
-	SLOT_TYPE_CHANGE_LOOK,
-	SLOT_TYPE_FISH_EVENT,
-	SLOT_TYPE_AURA,
-	SLOT_TYPE_PREMIUM_PRIVATE_SHOP,
-	SLOT_TYPE_GOLDEN_LAND_FRUIT,
-	SLOT_TYPE_MAX,
+	QUICKSLOT_TYPE_NONE,
+	QUICKSLOT_TYPE_ITEM,
+	QUICKSLOT_TYPE_SKILL,
+	QUICKSLOT_TYPE_COMMAND,
+	QUICKSLOT_TYPE_MAX_NUM,
 };
 
 enum EParts
@@ -451,27 +368,11 @@
 #if defined(__ACCE_COSTUME_SYSTEM__)
 	PART_ACCE,
 #endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-	PART_AURA,
-#endif
 
 	PART_MAX_NUM,
 	PART_WEAPON_SUB,
 };
 
-#if defined(__LOCALE_CLIENT__)
-enum ELCType
-{
-	LC_TYPE_STRING,
-	LC_TYPE_QUEST,
-	LC_TYPE_ITEM,
-	LC_TYPE_MOB,
-	LC_TYPE_SKILL,
-	LC_TYPE_PETSKILL,
-	LC_TYPE_OX
-};
-#endif
-
 enum EChatType
 {
 	CHAT_TYPE_TALKING, /* ׳ ä */
@@ -484,14 +385,14 @@
 	CHAT_TYPE_WHISPER,
 	CHAT_TYPE_BIG_NOTICE,
 	CHAT_TYPE_MONARCH_NOTICE,
-#if defined(__OX_RENEWAL__)
 	CHAT_TYPE_BIG_CONTROL_NOTICE,
-#endif
 #if defined(__DICE_SYSTEM__)
 	CHAT_TYPE_DICE_INFO,
 #endif
+#if defined(__12ZI_NOTICE__)
 	CHAT_TYPE_MISSION,
 	CHAT_TYPE_SUB_MISSION,
+#endif
 #if defined(__CHATTING_WINDOW_RENEWAL__)
 	CHAT_TYPE_EXP_INFO,
 	CHAT_TYPE_ITEM_INFO,
@@ -556,9 +457,7 @@
 	CHAR_TYPE_HORSE,
 	CHAR_TYPE_GOTO,
 	CHAR_TYPE_PET,
-	CHAR_TYPE_PET_PAY,
-	CHAR_TYPE_SHOP,
-	CHAR_TYPE_OBJECT,
+	CHAR_TYPE_PET_PAY
 };
 
 enum EBattleType
@@ -635,11 +534,11 @@
 	APPLY_MAGIC_DEF_GRADE,				// 56
 	APPLY_CURSE_PCT,					// 57
 	APPLY_MAX_STAMINA,					// 58
-	APPLY_ATTBONUS_WARRIOR,				// 59
-	APPLY_ATTBONUS_ASSASSIN,			// 60
-	APPLY_ATTBONUS_SURA,				// 61
-	APPLY_ATTBONUS_SHAMAN,				// 62
-	APPLY_ATTBONUS_MONSTER,				// 63
+	APPLY_ATT_BONUS_TO_WARRIOR,			// 59
+	APPLY_ATT_BONUS_TO_ASSASSIN,		// 60
+	APPLY_ATT_BONUS_TO_SURA,			// 61
+	APPLY_ATT_BONUS_TO_SHAMAN,			// 62
+	APPLY_ATT_BONUS_TO_MONSTER,			// 63
 	APPLY_MALL_ATTBONUS,				// 64 ݷ +x%
 	APPLY_MALL_DEFBONUS,				// 65  +x%
 	APPLY_MALL_EXPBONUS,				// 66 ġ +x%
@@ -660,7 +559,6 @@
 	APPLY_RESIST_ASSASSIN,				// 79 ڰ 
 	APPLY_RESIST_SURA,					// 80 󿡰 
 	APPLY_RESIST_SHAMAN,				// 81 翡 
-
 	APPLY_ENERGY,						// 82 
 	APPLY_DEF_GRADE,					// 83 . DEF_GRADE_BONUS Ŭ󿡼 ι  ǵ (...) ִ.
 	APPLY_COSTUME_ATTR_BONUS,			// 84 ڽƬ ۿ  Ӽġ ʽ
@@ -674,243 +572,58 @@
 	APPLY_ANTI_CRITICAL_PCT,			// 90 ũƼ 
 	APPLY_ANTI_PENETRATE_PCT,			// 91 Ÿ 
 
-	APPLY_BLEEDING_REDUCE,			// 92
-	APPLY_BLEEDING_PCT,				// 93
-	APPLY_ATTBONUS_WOLFMAN,			// 94
-	APPLY_RESIST_WOLFMAN,			// 95
-	APPLY_RESIST_CLAW,				// 96
-
-	APPLY_ACCEDRAIN_RATE,
-	APPLY_RESIST_MAGIC_REDUCTION,
-
-	APPLY_ENCHANT_ELECT,
-	APPLY_ENCHANT_FIRE,
-	APPLY_ENCHANT_ICE,
-	APPLY_ENCHANT_WIND,
-	APPLY_ENCHANT_EARTH,
-	APPLY_ENCHANT_DARK,
-
-	APPLY_ATTBONUS_CZ,
-	APPLY_ATTBONUS_INSECT,
-	APPLY_ATTBONUS_DESERT,
-	APPLY_ATTBONUS_SWORD,
-	APPLY_ATTBONUS_TWOHAND,
-	APPLY_ATTBONUS_DAGGER,
-	APPLY_ATTBONUS_BELL,
-	APPLY_ATTBONUS_FAN,
-	APPLY_ATTBONUS_BOW,
-	APPLY_ATTBONUS_CLAW,
-
-	APPLY_RESIST_HUMAN,
-	APPLY_RESIST_MOUNT_FALL,
-	APPLY_RESIST_FIST,
-
-	APPLY_MOUNT,
-
-	APPLY_SKILL_DAMAGE_SAMYEON,
-	APPLY_SKILL_DAMAGE_TANHWAN,
-	APPLY_SKILL_DAMAGE_PALBANG,
-	APPLY_SKILL_DAMAGE_GIGONGCHAM,
-	APPLY_SKILL_DAMAGE_GYOKSAN,
-	APPLY_SKILL_DAMAGE_GEOMPUNG,
-	APPLY_SKILL_DAMAGE_AMSEOP,
-	APPLY_SKILL_DAMAGE_GUNGSIN,
-	APPLY_SKILL_DAMAGE_CHARYUN,
-	APPLY_SKILL_DAMAGE_SANGONG,
-	APPLY_SKILL_DAMAGE_YEONSA,
-	APPLY_SKILL_DAMAGE_KWANKYEOK,
-	APPLY_SKILL_DAMAGE_GIGUNG,
-	APPLY_SKILL_DAMAGE_HWAJO,
-	APPLY_SKILL_DAMAGE_SWAERYUNG,
-	APPLY_SKILL_DAMAGE_YONGKWON,
-	APPLY_SKILL_DAMAGE_PABEOB,
-	APPLY_SKILL_DAMAGE_MARYUNG,
-	APPLY_SKILL_DAMAGE_HWAYEOMPOK,
-	APPLY_SKILL_DAMAGE_MAHWAN,
-	APPLY_SKILL_DAMAGE_BIPABU,
-	APPLY_SKILL_DAMAGE_YONGBI,
-	APPLY_SKILL_DAMAGE_PAERYONG,
-	APPLY_SKILL_DAMAGE_NOEJEON,
-	APPLY_SKILL_DAMAGE_BYEURAK,
-	APPLY_SKILL_DAMAGE_CHAIN,
-	APPLY_SKILL_DAMAGE_CHAYEOL,
-	APPLY_SKILL_DAMAGE_SALPOONG,
-	APPLY_SKILL_DAMAGE_GONGDAB,
-	APPLY_SKILL_DAMAGE_PASWAE,
-
-	APPLY_NORMAL_HIT_DEFEND_BONUS_BOSS_OR_MORE,
-	APPLY_SKILL_DEFEND_BONUS_BOSS_OR_MORE,
-	APPLY_NORMAL_HIT_DAMAGE_BONUS_BOSS_OR_MORE,
-	APPLY_SKILL_DAMAGE_BONUS_BOSS_OR_MORE,
-
-	APPLY_HIT_BUFF_ENCHANT_FIRE,
-	APPLY_HIT_BUFF_ENCHANT_ICE,
-	APPLY_HIT_BUFF_ENCHANT_ELEC,
-	APPLY_HIT_BUFF_ENCHANT_WIND,
-	APPLY_HIT_BUFF_ENCHANT_DARK,
-	APPLY_HIT_BUFF_ENCHANT_EARTH,
-	APPLY_HIT_BUFF_RESIST_FIRE,
-	APPLY_HIT_BUFF_RESIST_ICE,
-	APPLY_HIT_BUFF_RESIST_ELEC,
-	APPLY_HIT_BUFF_RESIST_WIND,
-	APPLY_HIT_BUFF_RESIST_DARK,
-	APPLY_HIT_BUFF_RESIST_EARTH,
-
-	APPLY_USE_SKILL_CHEONGRANG_MOV_SPEED,
-	APPLY_USE_SKILL_CHEONGRANG_CASTING_SPEED,
-	APPLY_USE_SKILL_CHAYEOL_CRITICAL_PCT,
-	APPLY_USE_SKILL_SANGONG_ATT_GRADE_BONUS,
-	APPLY_USE_SKILL_GIGUNG_ATT_GRADE_BONUS,
-	APPLY_USE_SKILL_JEOKRANG_DEF_BONUS,
-	APPLY_USE_SKILL_GWIGEOM_DEF_BONUS,
-	APPLY_USE_SKILL_TERROR_ATT_GRADE_BONUS,
-	APPLY_USE_SKILL_MUYEONG_ATT_GRADE_BONUS,
-	APPLY_USE_SKILL_MANASHILED_CASTING_SPEED,
-	APPLY_USE_SKILL_HOSIN_DEF_BONUS,
-	APPLY_USE_SKILL_GICHEON_ATT_GRADE_BONUS,
-	APPLY_USE_SKILL_JEONGEOP_ATT_GRADE_BONUS,
-	APPLY_USE_SKILL_JEUNGRYEOK_DEF_BONUS,
-	APPLY_USE_SKILL_GIHYEOL_ATT_GRADE_BONUS,
-	APPLY_USE_SKILL_CHUNKEON_CASTING_SPEED,
-	APPLY_USE_SKILL_NOEGEOM_ATT_GRADE_BONUS,
-
-	APPLY_SKILL_DURATION_INCREASE_EUNHYUNG,
-	APPLY_SKILL_DURATION_INCREASE_GYEONGGONG,
-	APPLY_SKILL_DURATION_INCREASE_GEOMKYUNG,
-	APPLY_SKILL_DURATION_INCREASE_JEOKRANG,
-
-	APPLY_USE_SKILL_PALBANG_HP_ABSORB,
-	APPLY_USE_SKILL_AMSEOP_HP_ABSORB,
-	APPLY_USE_SKILL_YEONSA_HP_ABSORB,
-	APPLY_USE_SKILL_YONGBI_HP_ABSORB,
-	APPLY_USE_SKILL_CHAIN_HP_ABSORB,
-	APPLY_USE_SKILL_PASWAE_SP_ABSORB,
-	APPLY_USE_SKILL_GIGONGCHAM_STUN,
-	APPLY_USE_SKILL_CHARYUN_STUN,
-	APPLY_USE_SKILL_PABEOB_STUN,
-	APPLY_USE_SKILL_MAHWAN_STUN,
-	APPLY_USE_SKILL_GONGDAB_STUN,
-	APPLY_USE_SKILL_SAMYEON_STUN,
-	APPLY_USE_SKILL_GYOKSAN_KNOCKBACK,
-	APPLY_USE_SKILL_SEOMJEON_KNOCKBACK,
-	APPLY_USE_SKILL_SWAERYUNG_KNOCKBACK,
-	APPLY_USE_SKILL_HWAYEOMPOK_KNOCKBACK,
-	APPLY_USE_SKILL_GONGDAB_KNOCKBACK,
-	APPLY_USE_SKILL_KWANKYEOK_KNOCKBACK,
-	APPLY_USE_SKILL_SAMYEON_NEXT_COOLTIME_DECREASE_10PER,
-	APPLY_USE_SKILL_GEOMPUNG_NEXT_COOLTIME_DECREASE_10PER,
-	APPLY_USE_SKILL_GUNGSIN_NEXT_COOLTIME_DECREASE_10PER,
-	APPLY_USE_SKILL_KWANKYEOK_NEXT_COOLTIME_DECREASE_10PER,
-	APPLY_USE_SKILL_YONGKWON_NEXT_COOLTIME_DECREASE_10PER,
-	APPLY_USE_SKILL_MARYUNG_NEXT_COOLTIME_DECREASE_10PER,
-	APPLY_USE_SKILL_BIPABU_NEXT_COOLTIME_DECREASE_10PER,
-	APPLY_USE_SKILL_NOEJEON_NEXT_COOLTIME_DECREASE_10PER,
-	APPLY_USE_SKILL_SALPOONG_NEXT_COOLTIME_DECREASE_10PER,
-	APPLY_USE_SKILL_PASWAE_NEXT_COOLTIME_DECREASE_10PER,
-
-	APPLY_ATTBONUS_STONE,
-
-	APPLY_DAMAGE_HP_RECOVERY,
-	APPLY_DAMAGE_SP_RECOVERY,
-
-	APPLY_ALIGNMENT_DAMAGE_BONUS,
-
-	APPLY_NORMAL_DAMAGE_GUARD,
-	APPLY_MORE_THEN_HP90_DAMAGE_REDUCE,
-
-	APPLY_USE_SKILL_TUSOK_HP_ABSORB,
-	APPLY_USE_SKILL_PAERYONG_HP_ABSORB,
-	APPLY_USE_SKILL_BYEURAK_HP_ABSORB,
-
-	APPLY_FIRST_ATTRIBUTE_BONUS,
-	APPLY_SECOND_ATTRIBUTE_BONUS,
-	APPLY_THIRD_ATTRIBUTE_BONUS,
-	APPLY_FOURTH_ATTRIBUTE_BONUS,
-	APPLY_FIFTH_ATTRIBUTE_BONUS,
-
-	APPLY_USE_SKILL_SAMYEON_NEXT_COOLTIME_DECREASE_20PER,
-	APPLY_USE_SKILL_GEOMPUNG_NEXT_COOLTIME_DECREASE_20PER,
-	APPLY_USE_SKILL_GUNGSIN_NEXT_COOLTIME_DECREASE_20PER,
-	APPLY_USE_SKILL_KWANKYEOK_NEXT_COOLTIME_DECREASE_20PER,
-	APPLY_USE_SKILL_YONGKWON_NEXT_COOLTIME_DECREASE_20PER,
-	APPLY_USE_SKILL_MARYUNG_NEXT_COOLTIME_DECREASE_20PER,
-	APPLY_USE_SKILL_BIPABU_NEXT_COOLTIME_DECREASE_20PER,
-	APPLY_USE_SKILL_NOEJEON_NEXT_COOLTIME_DECREASE_20PER,
-	APPLY_USE_SKILL_SALPOONG_NEXT_COOLTIME_DECREASE_20PER,
-	APPLY_USE_SKILL_PASWAE_NEXT_COOLTIME_DECREASE_20PER,
-	APPLY_USE_SKILL_CHAYEOL_HP_ABSORB,
-
-	APPLY_SUNGMA_STR,
-	APPLY_SUNGMA_HP,
-	APPLY_SUNGMA_MOVE,
-	APPLY_SUNGMA_IMMUNE,
-
-	APPLY_HIT_PCT,
-	APPLY_RANDOM,
-
-	APPLY_ATTBONUS_PER_HUMAN,
-	APPLY_ATTBONUS_PER_ANIMAL,
-	APPLY_ATTBONUS_PER_ORC,
-	APPLY_ATTBONUS_PER_MILGYO,
-	APPLY_ATTBONUS_PER_UNDEAD,
-	APPLY_ATTBONUS_PER_DEVIL,
-
-	APPLY_ENCHANT_PER_ELECT,
-	APPLY_ENCHANT_PER_FIRE,
-	APPLY_ENCHANT_PER_ICE,
-	APPLY_ENCHANT_PER_WIND,
-	APPLY_ENCHANT_PER_EARTH,
-	APPLY_ENCHANT_PER_DARK,
-
-	APPLY_ATTBONUS_PER_CZ,
-	APPLY_ATTBONUS_PER_INSECT,
-	APPLY_ATTBONUS_PER_DESERT,
-	APPLY_ATTBONUS_PER_STONE,
-	APPLY_ATTBONUS_PER_MONSTER,
-
-	APPLY_RESIST_PER_HUMAN,
-	APPLY_RESIST_PER_ICE,
-	APPLY_RESIST_PER_DARK,
-	APPLY_RESIST_PER_EARTH,
-	APPLY_RESIST_PER_FIRE,
-	APPLY_RESIST_PER_ELEC,
-	APPLY_RESIST_PER_MAGIC,
-	APPLY_RESIST_PER_WIND,
-
-	APPLY_HIT_BUFF_SUNGMA_STR,
-	APPLY_HIT_BUFF_SUNGMA_MOVE,
-	APPLY_HIT_BUFF_SUNGMA_HP,
-	APPLY_HIT_BUFF_SUNGMA_IMMUNE,
-
-	APPLY_MOUNT_MELEE_MAGIC_ATTBONUS_PER,
-	APPLY_DISMOUNT_MOVE_SPEED_BONUS_PER,
-
-	APPLY_HIT_AUTO_HP_RECOVERY,
-	APPLY_HIT_AUTO_SP_RECOVERY,
-
-	APPLY_USE_SKILL_COOLTIME_DECREASE_ALL,
-
-	APPLY_HIT_STONE_ATTBONUS_STONE,
-	APPLY_HIT_STONE_DEF_GRADE_BONUS,
-
-	APPLY_KILL_BOSS_ITEM_BONUS,
-	APPLY_MOB_HIT_MOB_AGGRESSIVE,
-	APPLY_NO_DEATH_AND_HP_RECOVERY30,
-
-	APPLY_AUTO_PICKUP,
-	APPLY_MOUNT_NO_KNOCKBACK,
-
-	APPLY_SUNGMA_PER_STR,
-	APPLY_SUNGMA_PER_HP,
-	APPLY_SUNGMA_PER_MOVE,
-	APPLY_SUNGMA_PER_IMMUNE,
+	APPLY_BLEEDING_REDUCE = 92,			// 92
+	APPLY_BLEEDING_PCT = 93,			// 93
+	APPLY_ATT_BONUS_TO_WOLFMAN = 94,	// 94
+	APPLY_RESIST_WOLFMAN = 95,			// 95
+	APPLY_RESIST_CLAW = 96,				// 96
+
+#if defined(__MOUNT_COSTUME_SYSTEM__)
+	APPLY_MOUNT,						// 97
+#endif
+
+#if defined(__ACCE_COSTUME_SYSTEM__)
+	APPLY_ACCEDRAIN_RATE,				// 98
+#endif
+
+#if defined(__MAGIC_REDUCTION__)
+	APPLY_RESIST_MAGIC_REDUCTION,		// 99
+#endif
 
-	APPLY_IMMUNE_POISON100,
-	APPLY_IMMUNE_BLEEDING100,
+#if defined(__ELEMENT_SYSTEM__)
+	APPLY_ENCHANT_ELECT,				// 100
+	APPLY_ENCHANT_FIRE,					// 101
+	APPLY_ENCHANT_ICE,					// 102
+	APPLY_ENCHANT_WIND,					// 103
+	APPLY_ENCHANT_EARTH,				// 104
+	APPLY_ENCHANT_DARK,					// 105
+	APPLY_ATTBONUS_CZ,					// 106
+	APPLY_ATTBONUS_INSECT,				// 107
+	APPLY_ATTBONUS_DESERT,				// 108
+
+	APPLY_ATTBONUS_SWORD,				// 109
+	APPLY_ATTBONUS_TWOHAND,				// 110
+	APPLY_ATTBONUS_DAGGER,				// 111
+	APPLY_ATTBONUS_BELL,				// 112
+	APPLY_ATTBONUS_FAN,					// 113
+	APPLY_ATTBONUS_BOW,					// 114
+	APPLY_ATTBONUS_CLAW,				// 115
 
-	APPLY_MONSTER_DEFEND_BONUS,
+	APPLY_RESIST_HUMAN,					// 116
+#endif
+	APPLY_ATTBONUS_STONE,				// 117
 
-	MAX_APPLY_NUM,
+#if defined(__CONQUEROR_LEVEL__)
+	APPLY_SUNGMA_STR,					// 118
+	APPLY_SUNGMA_HP,					// 119
+	APPLY_SUNGMA_MOVE,					// 120
+	APPLY_SUNGMA_IMMUNE,				// 121
+#endif
+#if defined(__ITEM_APPLY_RANDOM__)
+	APPLY_RANDOM,						// 122
+#endif
+
+	MAX_APPLY_NUM,						// 255
 };
 
 enum EOnClickEvents
@@ -937,22 +650,13 @@
 	MALL,
 	DRAGON_SOUL_INVENTORY,
 	BELT_INVENTORY,
-	GUILDBANK, // __GUILDRENEWAL_SYSTEM__
-	MAIL, // __MAILBOX__
-	NPC_STORAGE, // __ATTR_6TH_7TH__
-#if defined(__PREMIUM_PRIVATE_SHOP__)
-	PREMIUM_PRIVATE_SHOP,
-#endif
-	ACCEREFINE, // __ACCE_COSTUME_SYSTEM__
-	GROUND, // NOTE : 2013 25  unused..  ִ°???
-#if defined(__GROWTH_PET_SYSTEM__)
-	PET_FEED,
-#endif
-	CHANGELOOK, // __CHANGE_LOOK_SYSTEM__
-	AURA_REFINE, // __AURA_COSTUME_SYSTEM__
-	CUBE_WINDOW, // __CUBE_RENEWAL__
-
-	WINDOW_TYPE_MAX,
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	SKILL_BOOK_INVENTORY,
+	UPGRADE_ITEMS_INVENTORY,
+	STONE_INVENTORY,
+	GIFT_BOX_INVENTORY,
+#endif
+	GROUND
 };
 
 enum ETradeWnd
@@ -963,33 +667,17 @@
 	WND_SAFEBOX = (1 << 3),
 	WND_REFINE = (1 << 4),
 	WND_CUBE = (1 << 5),
-#if defined(__MOVE_COSTUME_ATTR__)
-	WND_ITEM_COMB = (1 << 6),
-#endif
-#if defined(__CHANGED_ATTR__)
-	WND_SELECT_ATTR = (1 << 7),
+#if defined(__PRIVATESHOP_SEARCH_SYSTEM__)
+	WND_SHOPSEARCH = (1 << 6),
 #endif
-#if defined(__ACCE_COSTUME_SYSTEM__)
-	WND_ACCE = (1 << 8),
-#endif
-#if defined(__CHANGE_LOOK_SYSTEM__)
-	WND_CHANGELOOK = (1 << 9),
-#endif
-
 #if defined(__MAILBOX__)
-	WND_MAILBOX = (1 << 11),
+	WND_MAILBOX = (1 << 7),
 #endif
-#if defined(__ATTR_6TH_7TH__)
-	WND_ATTR67ADD = (1 << 12),
-#endif
-#if defined(__MOVE_COSTUME_ATTR__)
-	WND_LUCKY_BOX = (1 << 13),
-#endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-	WND_AURA = (1 << 14),
+#if defined(__SOUL_ROULETTE__)
+	WND_ROULETTE = (1 << 8),
 #endif
-#if defined(__SUMMER_EVENT_ROULETTE__)
-	WND_MINIGAME_ROULETTE = (1 << 15),
+#if defined(__ATTR_6TH_7TH__)
+	WND_ATTR67ADD = (1 << 9),
 #endif
 	WND_ALL = (1 << 31), // MAX 31
 };
@@ -1063,8 +751,6 @@
 
 enum EMobResists
 {
-	MOB_RESIST_FIST,
-
 	MOB_RESIST_SWORD,
 	MOB_RESIST_TWOHAND,
 	MOB_RESIST_DAGGER,
@@ -1072,19 +758,16 @@
 	MOB_RESIST_FAN,
 	MOB_RESIST_BOW,
 	MOB_RESIST_CLAW,
-
 	MOB_RESIST_FIRE,
 	MOB_RESIST_ELECT,
 	MOB_RESIST_MAGIC,
 	MOB_RESIST_WIND,
-
 	MOB_RESIST_POISON,
 	MOB_RESIST_BLEEDING,
-
 	MOB_RESISTS_MAX_NUM
 };
 
-//#if defined(__ELEMENT_SYSTEM__)
+#if defined(__ELEMENT_SYSTEM__)
 enum EMobElements
 {
 	MOB_ELEMENT_ELECT,
@@ -1095,7 +778,7 @@
 	MOB_ELEMENT_DARK,
 	MOB_ELEMENT_MAX_NUM
 };
-//#endif
+#endif
 
 enum
 {
@@ -1155,12 +838,6 @@
 	ATTRIBUTE_SET_HEAD,
 	ATTRIBUTE_SET_SHIELD,
 	ATTRIBUTE_SET_EAR,
-#if defined(__PENDANT_SYSTEM__)
-	ATTRIBUTE_SET_PENDANT,
-#endif
-#if defined(__GLOVE_SYSTEM__)
-	ATTRIBUTE_SET_GLOVE,
-#endif
 #if defined(__COSTUME_SYSTEM__)
 	ATTRIBUTE_SET_COSTUME_BODY,
 	ATTRIBUTE_SET_COSTUME_HAIR,
@@ -1168,6 +845,12 @@
 	ATTRIBUTE_SET_COSTUME_WEAPON,
 #endif
 #endif
+#if defined(__PENDANT_SYSTEM__)
+	ATTRIBUTE_SET_PENDANT,
+#endif
+#if defined(__GLOVE_SYSTEM__)
+	ATTRIBUTE_SET_GLOVE,
+#endif
 	ATTRIBUTE_SET_MAX_NUM
 };
 
@@ -1204,10 +887,6 @@
 	PREMIUM_FISH_MIND, //    Ȯ 
 	PREMIUM_MARRIAGE_FAST, // ݽ   մϴ.
 	PREMIUM_GOLD, //   1.5
-	PREMIUM_AUTO_USE,
-#if defined(__CONQUEROR_LEVEL__)
-	PREMIUM_SUNGMA,
-#endif
 	PREMIUM_MAX_NUM = 9
 };
 
@@ -1228,8 +907,8 @@
 	SE_SUCCESS,
 	SE_FAIL,
 	SE_FR_SUCCESS,
-	SE_LEVELUP_ON_14_FOR_GERMANY, // 14϶ (  )
-	SE_LEVELUP_UNDER_15_FOR_GERMANY, // 15϶ (  )
+	SE_LEVELUP_ON_14_FOR_GERMANY,
+	SE_LEVELUP_UNDER_15_FOR_GERMANY,
 	SE_PERCENT_DAMAGE1,
 	SE_PERCENT_DAMAGE2,
 	SE_PERCENT_DAMAGE3,
@@ -1237,107 +916,30 @@
 	SE_AUTO_HPUP,
 	SE_AUTO_SPUP,
 
-	SE_EQUIP_RAMADAN_RING, // ʽ´  ϴ  ߵϴ Ʈ
+	SE_EQUIP_RAMADAN_RING, // 󸶴 ʽ´ (71135)   Ʈ (ߵƮ, Ʈ ƴ)
 	SE_EQUIP_HALLOWEEN_CANDY, // ҷ  (-_-;)  ߵϴ Ʈ
-	SE_EQUIP_HAPPINESS_RING, // ũ ູ  ϴ  ߵϴ Ʈ
+	SE_EQUIP_HAPPINESS_RING, // ũ ູ (71143)   Ʈ (ߵƮ, Ʈ ƴ)
 	SE_EQUIP_LOVE_PENDANT, // ߷Ÿ  ҴƮ(71145)   Ʈ (ߵƮ, Ʈ ƴ)
 
+	SE_EQUIP_MAGIC_RING,
 #if defined(__ACCE_COSTUME_SYSTEM__)
 	SE_ACCE_SUCESS_ABSORB,
-	SE_ACCE_EQUIP,
-	SE_ACCE_BACK,
+	SE_EQUIP_ACCE,
 #endif
-
 	SE_EQUIP_EASTER_CANDY,
-
-	SE_THUNDER_AREA,
-	SE_THUNDER,
-	SE_HEAL,
-
 	SE_CAPE_OF_COURAGE,
 	SE_EQUIP_CHOCOLATE_PENDANT,
-#if defined(__PVP_BALANCE_IMPROVING__)
-	SE_FEATHER_WALK,
-#endif
 	SE_PEPSI_EVENT,
-
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-	SE_DRAGONLAIR_STONE_UNBEATABLE_1,
-	SE_DRAGONLAIR_STONE_UNBEATABLE_2,
-	SE_DRAGONLAIR_STONE_UNBEATABLE_3,
-#endif
-
-	SE_BATTLE_POTION, // Battle Field
-	SE_REFLECT, // AI_FLAG_REFLECT
-
-	SE_SKILL_DAMAGE_ZONE,
-	SE_SKILL_SAFE_ZONE,
-	SE_METEOR,
-	SE_BEAD_RAIN,
-	SE_ARROW_RAIN,
-	SE_FALL_ROCK,
-	SE_HORSE_DROP,
-	SE_EGG_DROP,
-	SE_DEAPO_BOOM,
-
-#if defined(__FLOWER_EVENT__)
+	SE_BATTLE_POTION,
+	SE_EQUIP_NAZAR_PENDANT,
+	SE_EQUIP_GUARDIAN_PENDANT,
 	SE_FLOWER_EVENT,
-#endif
-#if defined(__GEM_SYSTEM__)
-	SE_GEM_PENDANT,
-#endif
-#if defined(__DEFENSE_WAVE__)
-	SE_DEFENSE_WAVE_LASER,
-#endif
-	SE_PET_ATTR_CHANGE_NEW_TYPE,
-	SE_PET_PAY_SUMMON1,
-#if defined(__SUMMER_EVENT_ROULETTE__)
-	SE_SPECIAL_ROULETTE,
-#endif
-	SE_MISTS_ISLAND_0,
-	SE_MISTS_ISLAND_1,
-	SE_MISTS_ISLAND_2,
-	SE_MISTS_ISLAND_3,
-	SE_PASSIVE_ATTR_SKILL,
-	SE_SUICIDE_BOMB_SMALL,
-	SE_SUICIDE_BOMB_LARGE,
-	SE_GROUND_THORN,
-	SE_GROUND_SNAKE,
-	SE_WHITE_DRAGON_BERSERK,
-	SE_WHITE_DRAGON_COOLING,
-	SE_USE_METINSTONE_RAIN_SPAWN_TICKET,
-	SE_FAKE_METINSTONE_SPLASH_DAMAGE,
-	SE_MOUNT_UPGRADE_SKILL,
-	SE_SOUTH_REAPER_SKILL_2,
-	SE_YEOMWANG_SKILL_2,
-	SE_BUFF_ITEM_5,
-	SE_BUFF_ITEM_13,
-	SE_BUFF_ITEM_14,
-	SE_BUFF_SYMBOL1,
-	SE_BUFF_ITEM_8_ELEMENT_1,
-	SE_BUFF_ITEM_8_ELEMENT_2,
-	SE_BUFF_FLOWER_OF_GALE,
-	SE_BUFF_FLOWER_OF_DESTRUCTION,
-	SE_SUNGMAHEE_GATE_FLOWER_BLOW_RANGE,
-	SE_SUNGMAHEE_GATE_INVINCIBLE_GATE,
-	SE_SUNGMAHEE_GATE_NORMAL_GATE,
-	SE_MOUNT_UPGRADE_GYEONGGONG,
-#if defined(__SNOWFLAKE_STICK_EVENT__)
-	SE_USE_SNOWFLAKE_STICK,
-#endif
-	SE_SPORTS_MATCH_BUFF_EMBLEM,
-	SE_POINT_AREA_ELECT_ATTACK,
-#ifdef ENABLE_QUEEN_NETHIS
-	SE_EFFECT_SNAKE_REGEN,
-#endif
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	SE_EFFECT_BP_NORMAL_MISSION_COMPLETED,
-	SE_EFFECT_BP_PREMIUM_MISSION_COMPLETED,
-	SE_EFFECT_BP_EVENT_MISSION_COMPLETED,
-	SE_EFFECT_BP_NORMAL_BATTLEPASS_COMPLETED,
-	SE_EFFECT_BP_PREMIUM_BATTLEPASS_COMPLETED,
-	SE_EFFECT_BP_EVENT_BATTLEPASS_COMPLETED,
-#endif
+	SE_EQUIP_GEM_PENDANT,
+
+	SE_THUNDER_AREA,
+	SE_THUNDER,
+	SE_HEAL,
+	
 #ifdef __GROWTH_PET_SYSTEM__
 	SE_GYEONGGONG_BOOM,
 #endif
@@ -1346,7 +948,7 @@
 #include "item_length.h"
 
 // inventory position Ÿ ü
-// int Ͻ ȯ ִ ,SE_THUNDER
+// int Ͻ ȯ ִ ,
 // κ õ  Լ window_type  ʰ, cell ϳ ޾ұ ,( κ ϳ ̾ inventory type̶ ʿ ,)
 // κ   Լ ȣκ ϴ  ϱ ̴.
 
@@ -1357,27 +959,32 @@
 
 enum EMisc2
 {
-	INVENTORY_SLOT_START = 0,
-	INVENTORY_SLOT_END = INVENTORY_MAX_NUM,
-	
-#if defined(__DRAGON_SOUL_SYSTEM__)
-	DRAGON_SOUL_EQUIP_SLOT_START = WEAR_MAX_NUM,
-	DRAGON_SOUL_EQUIP_SLOT_END = DRAGON_SOUL_EQUIP_SLOT_START + (DS_SLOT_MAX * DRAGON_SOUL_DECK_MAX_NUM),
+	DRAGON_SOUL_EQUIP_SLOT_START = INVENTORY_MAX_NUM + WEAR_MAX_NUM, // 180 + 32 ( 212 )
+	DRAGON_SOUL_EQUIP_SLOT_END = DRAGON_SOUL_EQUIP_SLOT_START + (DS_SLOT_MAX * DRAGON_SOUL_DECK_MAX_NUM), // 212 + 12 ( 224 )
+	DRAGON_SOUL_EQUIP_RESERVED_SLOT_END = DRAGON_SOUL_EQUIP_SLOT_END + (DS_SLOT_MAX * DRAGON_SOUL_DECK_RESERVED_MAX_NUM), // 224 + 18 ( 242 )
+
+	BELT_INVENTORY_SLOT_START = DRAGON_SOUL_EQUIP_RESERVED_SLOT_END, // 242
+	BELT_INVENTORY_SLOT_END = BELT_INVENTORY_SLOT_START + BELT_INVENTORY_SLOT_COUNT, // 242 + 16 ( 258 )
+
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	SKILL_BOOK_INVENTORY_SLOT_START = BELT_INVENTORY_SLOT_END,
+	SKILL_BOOK_INVENTORY_SLOT_END = SKILL_BOOK_INVENTORY_SLOT_START + SKILL_BOOK_INVENTORY_MAX_NUM,
+
+	UPGRADE_ITEMS_INVENTORY_SLOT_START = SKILL_BOOK_INVENTORY_SLOT_END,
+	UPGRADE_ITEMS_INVENTORY_SLOT_END = UPGRADE_ITEMS_INVENTORY_SLOT_START + UPGRADE_ITEMS_INVENTORY_MAX_NUM,
+
+	STONE_INVENTORY_SLOT_START = UPGRADE_ITEMS_INVENTORY_SLOT_END,
+	STONE_INVENTORY_SLOT_END = STONE_INVENTORY_SLOT_START + STONE_INVENTORY_MAX_NUM,
+
+	GIFT_BOX_INVENTORY_SLOT_START = STONE_INVENTORY_SLOT_END,
+	GIFT_BOX_INVENTORY_SLOT_END = GIFT_BOX_INVENTORY_SLOT_START + GIFT_BOX_INVENTORY_MAX_NUM,
 #endif
 
-	BELT_INVENTORY_SLOT_START = 0,
-	BELT_INVENTORY_SLOT_END = BELT_INVENTORY_SLOT_COUNT,
-	BELT_INVENTORY_MAX_NUM = BELT_INVENTORY_SLOT_END,
-
-	EQUIPMENT_SLOT_START = 0,
-#if defined(__DRAGON_SOUL_SYSTEM__)
-	EQUIPMENT_SLOT_END = DRAGON_SOUL_EQUIP_SLOT_END,
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	INVENTORY_AND_EQUIP_SLOT_MAX = GIFT_BOX_INVENTORY_SLOT_END,
 #else
-	EQUIPMENT_SLOT_END = WEAR_MAX_NUM,
+	INVENTORY_AND_EQUIP_SLOT_MAX = BELT_INVENTORY_SLOT_END,
 #endif
-	EQUIPMENT_MAX_NUM = EQUIPMENT_SLOT_END,
-
-	INVENTORY_AND_EQUIP_SLOT_MAX = INVENTORY_MAX_NUM + EQUIPMENT_MAX_NUM + BELT_INVENTORY_SLOT_COUNT,
 };
 
 #pragma pack(push, 1)
@@ -1402,77 +1009,76 @@
 	{
 		switch (window_type)
 		{
-			case INVENTORY:
-				return cell < INVENTORY_MAX_NUM;
-
-			case EQUIPMENT:
-				return cell < EQUIPMENT_MAX_NUM;
+		case RESERVED_WINDOW:
+			return false;
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
-			case DRAGON_SOUL_INVENTORY:
-				return cell < DRAGON_SOUL_INVENTORY_MAX_NUM;
+		case INVENTORY:
+		case EQUIPMENT:
+		case BELT_INVENTORY:
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+		case SKILL_BOOK_INVENTORY:
+		case UPGRADE_ITEMS_INVENTORY:
+		case STONE_INVENTORY:
+		case GIFT_BOX_INVENTORY:
 #endif
+			return cell < INVENTORY_AND_EQUIP_SLOT_MAX;
 
-			case BELT_INVENTORY:
-				return cell < BELT_INVENTORY_SLOT_COUNT;
+		case DRAGON_SOUL_INVENTORY:
+			return cell < (DRAGON_SOUL_INVENTORY_MAX_NUM);
 
 			//  ũⰡ  window valid üũ   .
-			case SAFEBOX:
-			case MALL:
-				return false;
+		case SAFEBOX:
+		case MALL:
+			return false;
 
-			default:
-				return false;
+		default:
+			return false;
 		}
 
 		return false;
 	}
 
-	bool IsSameItemPosition(const SItemPos& DestCell) const
+	bool IsEquipPosition() const
 	{
-		return (window_type == DestCell.window_type) && (cell == DestCell.cell);
+		return (((INVENTORY == window_type || EQUIPMENT == window_type) && (cell >= INVENTORY_MAX_NUM && cell < INVENTORY_MAX_NUM + WEAR_MAX_NUM)) || IsDragonSoulEquipPosition());
 	}
 
-	bool IsInventoryPosition() const
+	bool IsDragonSoulEquipPosition() const
 	{
-		return (window_type == INVENTORY && cell < INVENTORY_MAX_NUM);
+		return (INVENTORY == window_type && (DRAGON_SOUL_EQUIP_SLOT_START <= cell && DRAGON_SOUL_EQUIP_SLOT_END > cell));
 	}
 
-	bool IsDefaultInventoryPosition() const
+	bool IsBeltInventoryPosition() const
 	{
-		return IsInventoryPosition();
+		return (BELT_INVENTORY_SLOT_START <= cell && BELT_INVENTORY_SLOT_END > cell);
 	}
 
-	bool IsEquipPosition() const
+	bool IsDefaultInventoryPosition() const
 	{
-		return (IsEquipmentPosition()
-#if defined(__DRAGON_SOUL_SYSTEM__)
-			|| IsDragonSoulEquipPosition()
-#endif
-			);
+		return (INVENTORY == window_type && cell < INVENTORY_MAX_NUM);
 	}
 
-	bool IsEquipmentPosition() const
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	bool IsSkillBookInventoryPosition() const
 	{
-		return (window_type == EQUIPMENT && cell < EQUIPMENT_MAX_NUM);
+		return (INVENTORY == window_type && (cell >= SKILL_BOOK_INVENTORY_SLOT_START && cell < SKILL_BOOK_INVENTORY_SLOT_END));
 	}
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
-	bool IsDragonSoulEquipPosition() const
+	bool IsUpgradeItemsInventoryPosition() const
 	{
-		return (EQUIPMENT == window_type && (cell >= DRAGON_SOUL_EQUIP_SLOT_START && cell < DRAGON_SOUL_EQUIP_SLOT_END));
+		return (INVENTORY == window_type && (cell >= UPGRADE_ITEMS_INVENTORY_SLOT_START && cell < UPGRADE_ITEMS_INVENTORY_SLOT_END));
 	}
 
-	bool IsDragonSoulInventoryPosition() const
+	bool IsStoneInventoryPosition() const
 	{
-		return (window_type == DRAGON_SOUL_INVENTORY && cell < DRAGON_SOUL_INVENTORY_MAX_NUM);
+		return (INVENTORY == window_type && (cell >= STONE_INVENTORY_SLOT_START && cell < STONE_INVENTORY_SLOT_END));
 	}
-#endif
 
-	bool IsBeltInventoryPosition() const
+	bool IsGiftBoxInventoryPosition() const
 	{
-		return (window_type == BELT_INVENTORY && cell < BELT_INVENTORY_SLOT_COUNT);
+		return (INVENTORY == window_type && (cell >= GIFT_BOX_INVENTORY_SLOT_START && cell < GIFT_BOX_INVENTORY_SLOT_END));
 	}
+#endif
 
 	bool operator==(const struct SItemPos& rhs) const
 	{
@@ -1496,552 +1102,58 @@
 {
 	SHOP_COIN_TYPE_GOLD, // DEFAULT VALUE
 	SHOP_COIN_TYPE_SECONDARY_COIN,
-#if defined(__SHOPEX_RENEWAL__)
-	SHOP_COIN_TYPE_ITEM,
-	SHOP_COIN_MAX_TYPE,
-#endif
 } EShopCoinType;
 
-#if defined(__ACCE_COSTUME_SYSTEM__)
-enum EAcceMisc
-{
-	ACCE_MAX_DRAINRATE = 25,
-};
-
-enum EAcceSlot
-{
-	ACCE_SLOT_LEFT,
-	ACCE_SLOT_RIGHT,
-	ACCE_SLOT_RESULT,
-	ACCE_SLOT_MAX
-};
-
-enum EAcceSlotType
-{
-	ACCE_SLOT_TYPE_COMBINE,
-	ACCE_SLOT_TYPE_ABSORB,
-	ACCE_SLOT_TYPE_MAX
-};
-#endif
-
-#if defined(__AURA_COSTUME_SYSTEM__)
-enum EAuraMisc
-{
-	AURA_MAX_LEVEL = 250,
-};
-
-enum EAuraWindowType
-{
-	AURA_WINDOW_TYPE_ABSORB,
-	AURA_WINDOW_TYPE_GROWTH,
-	AURA_WINDOW_TYPE_EVOLVE,
-	AURA_WINDOW_TYPE_MAX,
-};
-
-enum EAuraSlot
-{
-	AURA_SLOT_MAIN,
-	AURA_SLOT_SUB,
-	AURA_SLOT_RESULT,
-	AURA_SLOT_MAX
-};
-
-enum EAuraGradeType
-{
-	AURA_GRADE_NONE,
-	AURA_GRADE_ORDINARY,
-	AURA_GRADE_SIMPLE,
-	AURA_GRADE_NOBLE,
-	AURA_GRADE_SPARKLING,
-	AURA_GRADE_MAGNIFICENT,
-	AURA_GRADE_RADIANT,
-	AURA_GRADE_MAX_NUM,
-};
-
-enum EAuraRefineTokenType
-{
-	AURA_REFINE_INFO_STEP,
-	AURA_REFINE_INFO_LEVEL_MIN,
-	AURA_REFINE_INFO_LEVEL_MAX,
-	AURA_REFINE_INFO_NEED_EXP,
-	AURA_REFINE_INFO_MATERIAL_VNUM,
-	AURA_REFINE_INFO_MATERIAL_COUNT,
-	AURA_REFINE_INFO_NEED_GOLD,
-	AURA_REFINE_INFO_EVOLVE_PCT,
-	AURA_REFINE_INFO_MAX
-};
-
-enum EAuraRefineInfoType
-{
-	AURA_REFINE_INFO_SLOT_CURRENT,
-	AURA_REFINE_INFO_SLOT_NEXT,
-	AURA_REFINE_INFO_SLOT_EVOLVED,
-	AURA_REFINE_INFO_SLOT_MAX
-};
-
-typedef struct SAuraRefineInfo
-{
-	BYTE bLevel;
-	BYTE bExpPercent;
-} TAuraRefineInfo;
-
-#endif
-
-#if defined(__EXPRESSING_EMOTIONS__)
-enum ESpecialActionMisc
-{
-	SPECIAL_ACTION_START_INDEX = 101,
-	SPECIAL_ACTION_DURATION = 43200,
-	SPECIAL_ACTION_SLOT_COUNT = 12,
-};
-#endif
-
-enum EEmotion
-{
-	EMOTION_NONE,
-	EMOTION_CLAP,
-	EMOTION_CONGRATULATION,
-	EMOTION_FORGIVE,
-	EMOTION_ANGRY,
-	EMOTION_ATTRACTIVE,
-	EMOTION_SAD,
-	EMOTION_SHY,
-	EMOTION_CHEERUP,
-	EMOTION_BANTER,
-	EMOTION_JOY,
-	EMOTION_CHEERS_1,
-	EMOTION_CHEERS_2,
-	EMOTION_DANCE_1,
-	EMOTION_DANCE_2,
-	EMOTION_DANCE_3,
-	EMOTION_DANCE_4,
-	EMOTION_DANCE_5,
-	EMOTION_DANCE_6,
-
-	EMOTION_KISS = 51,
-	EMOTION_FRENCH_KISS = 52,
-	EMOTION_SLAP = 53,
-
-#if defined(__EXPRESSING_EMOTIONS__)
-	EMOTION_PUSH_UP = SPECIAL_ACTION_START_INDEX,
-	EMOTION_DANCE_7,
-	EMOTION_EXERCISE,
-	EMOTION_DOZE,
-	EMOTION_SELFIE,
-	EMOTION_CHARGING,
-	EMOTION_NOSAY,
-	EMOTION_WEATHER_1,
-	EMOTION_WEATHER_2,
-	EMOTION_WEATHER_3,
-	EMOTION_HUNGRY,
-	EMOTION_SIREN,
-	EMOTION_LETTER,
-	EMOTION_CALL,
-	EMOTION_CELEBRATION,
-	EMOTION_ALCOHOL,
-	EMOTION_BUSY,
-	EMOTION_WHIRL,
-#endif
-	EMOTION_NUM,
-};
-
-enum EEmotionFlag
-{
-	EMOTION_FLAG_SELF = (1 << 0),
-	EMOTION_FLAG_TARGET = (1 << 1),
-	EMOTION_FLAG_MAN = (1 << 2),
-	EMOTION_FLAG_WOMAN = (1 << 3),
-	EMOTION_FLAG_OTHER_SEX = (1 << 3),
-};
-
-#if defined(__SET_ITEM__)
-enum ESetItemType
+#if defined(__PRIVATESHOP_SEARCH_SYSTEM__)
+enum EPrivateShopSearchState
 {
-	SET_ITEM_COSTUME_BODY,
-	SET_ITEM_COSTUME_HAIR,
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-	SET_ITEM_COSTUME_MOUNT,
-#endif
-#if defined(__ACCE_COSTUME_SYSTEM__)
-	SET_ITEM_COSTUME_ACCE,
-#endif
-#if defined(__WEAPON_COSTUME_SYSTEM__)
-	SET_ITEM_COSTUME_WEAPON,
-#endif
-	SET_ITEM_UNIQUE,
-	SET_ITEM_PET,
-
-	SET_ITEM_MAX
+	SHOP_SEARCH_OFF,
+	SHOP_SEARCH_LOOKING,
+	SHOP_SEARCH_TRADING,
+	SHOP_SEARCH_INDEX = 61000,
 };
-
-enum ESetItemValue
-{
-	SET_ITEM_SET_VALUE_NONE,
-	SET_ITEM_SET_VALUE_1,
-	SET_ITEM_SET_VALUE_2,
-	SET_ITEM_SET_VALUE_3,
-	SET_ITEM_SET_VALUE_4,
-	SET_ITEM_SET_VALUE_5,
-	SET_ITEM_SET_VALUE_MAX
-};
-#endif
-
-#if defined(__DELETE_FAILURE_TYPE__)
-enum EDeleteCharacterFailureType
-{
-	DELETE_FAILURE_NORMAL,
-#if defined(__SOUL_BIND_SYSTEM__)
-	DELETE_FAILURE_HAVE_SEALED_ITEM,
-#endif
-	DELETE_FAILURE_PRIVATE_CODE_ERROR,
-	DELETE_FAILURE_LIMITE_LEVEL_HIGHER,
-	DELETE_FAILURE_LIMITE_LEVEL_LOWER,
-	DELETE_FAILURE_REMAIN_TIME,
-	DELETE_FAILURE_GUILD_MEMBER,
-	DELETE_FAILURE_MARRIAGE,
-	DELETE_FAILURE_LAST_CHAR_SAFEBOX,
-	DELETE_FAILURE_ATTR67,
-	DELETE_FAILURE_PREMIUM_PRIVATE_SHOP,
-};
-#endif
-
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-enum ERefineElementMisc
-{
-	REFINE_ELEMENT_MIN_REFINE_LEVEL = 7,
-
-	REFINE_ELEMENT_UPGRADE_YANG = 3000000,
-	REFINE_ELEMENT_DOWNGRADE_YANG = 10000000,
-	REFINE_ELEMENT_CHANGE_YANG = 10000000,
-
-	REFINE_ELEMENT_RANDOM_VALUE_MIN = 1,
-	REFINE_ELEMENT_RANDOM_VALUE_MAX = 8,
-
-	REFINE_ELEMENT_RANDOM_BONUS_VALUE_MIN = 2,
-	REFINE_ELEMENT_RANDOM_BONUS_VALUE_MAX = 12,
-};
-
-enum ERefineElementType
-{
-	REFINE_ELEMENT_UPGRADE,
-	REFINE_ELEMENT_DOWNGRADE,
-	REFINE_ELEMENT_CHANGE,
-};
-#endif
-
-enum EPartyLeaderShipRoleValue
-{
-	LEADERSHIP_ATTACKER_BASE_VALUE = 10,
-	LEADERSHIP_ATTACKER_ADJUSTMENT_VALUE = 50,
-	LEADERSHIP_TANKER_BASE_VALUE = 50,
-	LEADERSHIP_TANKER_ADJUSTMENT_VALUE = 1120,
-	LEADERSHIP_BUFFER_BASE_VALUE = 5,
-	LEADERSHIP_BUFFER_ADJUSTMENT_VALUE = 8,
-	LEADERSHIP_SKILL_MASTER_BASE_VALUE = 1,
-	LEADERSHIP_SKILL_MASTER_ADJUSTMENT_VALUE = 2,
-	LEADERSHIP_BERSERKER_BASE_VALUE = 1,
-	LEADERSHIP_BERSERKER_ADJUSTMENT_VALUE = 3,
-	LEADERSHIP_DEFENDER_BASE_VALUE = 1,
-	LEADERSHIP_DEFENDER_ADJUSTMENT_VALUE = 3,
-};
-
-#if defined(__PARTY_INSIGHT__)
-enum EPartyInSightValue
-{
-	INSIGHT_ATTACKER_BASE_VALUE = 2,
-	INSIGHT_ATTACKER_ADJUSTMENT_VALUE = 9,
-	INSIGHT_TANKER_BASE_VALUE = 10,
-	INSIGHT_TANKER_ADJUSTMENT_VALUE = 520,
-	INSIGHT_BUFFER_BASE_VALUE = 1,
-	INSIGHT_BUFFER_ADJUSTMENT_VALUE = 4,
-	INSIGHT_SKILL_MASTER_BASE_VALUE = 1,
-	INSIGHT_SKILL_MASTER_ADJUSTMENT_VALUE = 5,
-	INSIGHT_BERSERKER_BASE_VALUE = 1,
-	INSIGHT_BERSERKER_ADJUSTMENT_VALUE = 1,
-	INSIGHT_DEFENDER_BASE_VALUE = 1,
-	INSIGHT_DEFENDER_ADJUSTMENT_VALUE = 2,
-};
-#endif
-
-enum EMapIndex
-{
-	MAP_A1 = 1,
-	MAP_A3 = 3,
-	MAP_GUILD_01 = 4,
-	MAP_MONKEY_DUNGEON_11 = 5,
-	MAP_GUILD_VILLAGE_01 = 6,
-	MAP_B1 = 21,
-	MAP_B3 = 23,
-	MAP_GUILD_02 = 24,
-	MAP_MONKEY_DUNGEON_12 = 25,
-	MAP_GUILD_VILLAGE_02 = 26,
-	MAP_C1 = 41,
-	MAP_C3 = 43,
-	MAP_GUILD_03 = 44,
-	MAP_MONKEY_DUNGEON_13 = 45,
-	MAP_GUILD_VILLAGE_03 = 46,
-	MAP_N_SNOWM_01 = 61,
-	MAP_N_FLAME_01 = 62,
-	MAP_N_DESERT_01 = 63,
-	MAP_N_THREEWAY = 64,
-	MAP_MILGYO = 65,
-	MAP_DEVILTOWER1 = 66,
-	MAP_TRENT = 67,
-	MAP_TRENT02 = 68,
-	MAP_WL_01 = 69,
-	MAP_NUSLUCK01 = 70,
-	MAP_SPIDERDUNGEON_02 = 71,
-	MAP_SKIPIA_DUNGEON_01 = 72,
-	MAP_SKIPIA_DUNGEON_02 = 73,
-	MAP_WEDDING_01 = 81,
-	MAP_E1_01 = 91,
-	MAP_E1_02 = 92,
-	MAP_E1_03 = 93,
-	MAP_T1 = 103,
-	MAP_SPIDERDUNGEON = 104,
-	MAP_T2 = 105,
-	MAP_MONKEY_DUNGEON = 107,
-	MAP_MONKEY_DUNGEON2 = 108,
-	MAP_MONKEY_DUNGEON3 = 109,
-	MAP_T3 = 110,
-	MAP_T4 = 111,
-	MAP_DUEL = 112,
-	MAP_OXEVENT = 113,
-	MAP_SUNGZI = 114,
-	MAP_SUNGZI_FLAME_HILL_01 = 118,
-	MAP_SUNGZI_FLAME_HILL_02 = 119,
-	MAP_SUNGZI_FLAME_HILL_03 = 120,
-	MAP_SUNGZI_SNOW = 121,
-	MAP_SUNGZI_SNOW_PASS01 = 122,
-	MAP_SUNGZI_SNOW_PASS02 = 123,
-	MAP_SUNGZI_SNOW_PASS03 = 124,
-	MAP_SUNGZI_DESERT_01 = 125,
-	MAP_SUNGZI_DESERT_HILL_01 = 126,
-	MAP_SUNGZI_DESERT_HILL_02 = 127,
-	MAP_SUNGZI_DESERT_HILL_03 = 128,
-	MAP_GUILD_WAR1 = 130,
-	MAP_GUILD_WAR2 = 131,
-	MAP_GUILD_WAR3 = 132,
-	MAP_GUILD_WAR4 = 133,
-	MAP_EMPIREWAR01 = 181,
-	MAP_EMPIREWAR02 = 182,
-	MAP_EMPIREWAR03 = 183,
-	MAP_GM_GUILD_BUILD = 200,
-	MAP_PVP_ARENA = 201,
-	MAP_SKIPIA_DUNGEON_BOSS = 208,
-	MAP_DEVILSCATACOMB = 216,
-	MAP_SPIDERDUNGEON_03 = 217,
-	MAP_CAPEDRAGONHEAD = 301,
-	MAP_DAWNMISTWOOD = 302,
-	MAP_BAYBLACKSAND = 303,
-	MAP_MT_THUNDER = 304,
-	MAP_N_FLAME_DUNGEON_01 = 351,
-	MAP_N_SNOW_DUNGEON_01 = 352,
-	MAP_DAWNMIST_DUNGEON_01 = 353,
-	MAP_MT_TH_DUNGEON_01 = 354,
-	MAP_12ZI_STAGE = 355,
-	MAP_N_FLAME_DRAGON = 356,
-	MAP_BATTLEFIED = 357,
-	MAP_DEFENSEWAVE = 358,
-	MAP_DEFENSEWAVE_PORT = 359,
-	MAP_MISTS_OF_ISLAND = 360,
-	MAP_MINIBOSS_01 = 361,
-	MAP_MINIBOSS_02 = 362,
-	MAP_LABYRINTH = 363,
-	MAP_BOSS_CRACK_SKIPIA = 364,
-	MAP_BOSS_CRACK_FLAME = 365,
-	MAP_BOSS_CRACK_SNOW = 366,
-	MAP_BOSS_CRACK_DAWNMIST = 367,
-	MAP_BOSS_AWAKEN_SKIPIA = 368,
-	MAP_BOSS_AWAKEN_FLAME = 369,
-	MAP_BOSS_AWAKEN_SNOW = 370,
-	MAP_BOSS_AWAKEN_DAWNMIST = 371,
-	MAP_GUILD_PVE = 372,
-	MAP_EASTPLAIN_01 = 373,
-	MAP_EMPIRECASTLE = 374,
-	MAP_BATTLEROYALE = 375,
-	MAP_EASTPLAIN_02 = 376,
-	MAP_EASTPLAIN_03 = 377,
-	MAP_ELEMENTAL_01 = 378,
-	MAP_ELEMENTAL_02 = 379,
-	MAP_ELEMENTAL_03 = 380,
-	MAP_ELEMENTAL_04 = 381,
-	MAP_MAZE_DUNGEON1 = 382,
-	MAP_MAZE_DUNGEON2 = 383,
-	MAP_MAZE_DUNGEON3 = 384,
-	MAP_SNAKEVALLEY = 385,
-	MAP_SMHDUNGEON_01 = 386,
-	MAP_SMHDUNGEON_02 = 387,
-	MAP_ICECRYSTALCAVE = 388,
-	MAP_WHITDRAGONVALLEY = 389,
-	MAP_SNAKE_TEMPLE_01 = 390,
-	MAP_SNAKE_TEMPLE_02 = 391,
-	MAP_PRIVATESHOP = 392,
-	MAP_WHITEDRAGONCAVE_01 = 393,
-	MAP_WHITEDRAGONCAVE_02 = 394,
-	MAP_WHITEDRAGONCAVE_BOSS = 395,
-	MAP_ANGLAR_DUNGEON_01 = 396,
-	MAP_SECRETDUNGEON_01 = 399,
-	MAP_OTHERWORLD_01 = 400,
-	MAP_OTHERWORLD_02 = 401,
-	MAP_OTHERWORLD_03 = 402,
-	MAP_OTHERWORLD_04 = 403,
-};
-
-#if defined(__SOUL_BIND_SYSTEM__)
-enum ESealDate
-{
-	E_SEAL_DATE_DEFAULT_TIMESTAMP = 0, // Empty Seal Data
-	U_SEAL_DATE_DEFAULT_TIMESTAMP = -1, // Unlimited Seal Data
-	SEAL_DATE_MAX = 72, // 72 Days
-};
-#endif
-
-#if defined(__LEFT_SEAT__)
-enum ELeftSeat
-{
-	LEFT_SEAT_PULSE = 15,
-};
-
-enum ELeftSeatTime
-{
-	LEFT_SEAT_TIME_10_MIN,
-	LEFT_SEAT_TIME_30_MIN,
-	LEFT_SEAT_TIME_90_MIN,
-	LEFT_SEAT_TIME_MAX,
-};
-
-enum ELeftSeatLogoutTime
-{
-	LEFT_SEAT_LOGOUT_TIME_30_MIN,
-	LEFT_SEAT_LOGOUT_TIME_60_MIN,
-	LEFT_SEAT_LOGOUT_TIME_120_MIN,
-	LEFT_SEAT_LOGOUT_TIME_180_MIN,
-	LEFT_SEAT_LOGOUT_TIME_OFF,
-	LEFT_SEAT_LOGOUT_TIME_MAX,
-};
-#endif
-
-enum ESetCMD
-{
-	SET_CMD_GOLD,
-	SET_CMD_RACE,
-	SET_CMD_SEX,
-	SET_CMD_EXP,
-	SET_CMD_MAX_HP,
-	SET_CMD_MAX_SP,
-	SET_CMD_SKILL,
-	SET_CMD_ALIGN,
-#if defined(__CHEQUE_SYSTEM__)
-	SET_CMD_CHEQUE,
-#endif
-#if defined(__GEM_SYSTEM__)
-	SET_CMD_GEM,
-#endif
-#if defined(__EXPRESSING_EMOTIONS__)
-	SET_CMD_ACTION,
 #endif
-	SET_CMD_MAX_NUN
-};
-
-enum EDeadDialog
-{
-	DEAD_DIALOG_NONE,
-	DEAD_DIALOG_NORMAL,
-	DEAD_DIALOG_GIVE_UP,
-};
-
-#if defined(__FLOWER_EVENT__)
-enum EFlowerEventShootType
-{
-	SHOOT_ENVELOPE,
-	SHOOT_CHRYSANTHEMUM,
-	SHOOT_MAY_BELL,
-	SHOOT_DAFFODIL,
-	SHOOT_LILY,
-	SHOOT_SUNFLOWER,
-	SHOOT_TYPE_MAX,
-};
-
-enum EFlowerEventMisc
-{
-	FLOWER_EVENT_SHOOT_ENVELOPE_NEED_COUNT = 1,
-	FLOWER_EVENT_SHOOT_NEED_COUNT = 10,
-	FLOWER_EVENT_NEED_INVENTORY_SPACE = 1,
-	FLOWER_EVENT_EXCHANGE_COOLTIME_SEC = 1,
-	MAX_FLOWER_EVENT_ITEM_COUNT = 99999,
-};
 
-enum EFlowerEventChatType
+#if defined(__SKILL_COLOR_SYSTEM__)
+namespace ESkillColorLength
 {
-	FLOWER_EVENT_CHAT_TYPE_NOT_ENOUGH_SHOOT_COUNT,
-	FLOWER_EVENT_CHAT_TYPE_NOT_ENOUGH_EVENTORY_SPACE,
-	FLOWER_EVENT_CHAT_TYPE_NOT_ENOUGH_SHOOT_ENVELOPE,
-	FLOWER_EVENT_CHAT_TYPE_GET_SHOOT_ENVELOPE,
-	FLOWER_EVENT_CHAT_TYPE_GET_SHOOT_CHRYSANTHEMUM,
-	FLOWER_EVENT_CHAT_TYPE_GET_SHOOT_MAY_BELL,
-	FLOWER_EVENT_CHAT_TYPE_GET_SHOOT_DAFFODIL,
-	FLOWER_EVENT_CHAT_TYPE_GET_SHOOT_LILY,
-	FLOWER_EVENT_CHAT_TYPE_GET_SHOOT_SUNFLOWER,
-	FLOWER_EVENT_CHAT_TYPE_ITEM_FULL_AND_NOT_USE,
-	FLOWER_EVENT_CHAT_TYPE_GET_SHOOT_CHRYSANTHEMUM_COUNT,
-	FLOWER_EVENT_CHAT_TYPE_GET_SHOOT_MAY_BELL_COUNT,
-	FLOWER_EVENT_CHAT_TYPE_GET_SHOOT_DAFFODIL_COUNT,
-	FLOWER_EVENT_CHAT_TYPE_GET_SHOOT_LILY_COUNT,
-	FLOWER_EVENT_CHAT_TYPE_GET_SHOOT_SUNFLOWER_COUNT,
-	FLOWER_EVENT_CHAT_TYPE_ENVELOPE_MAX,
-	FLOWER_EVENT_CHAT_TYPE_MAX,
-};
+	enum ESkillColorLength
+	{
+#if defined(__9TH_SKILL__)
+		MAX_SKILL_COUNT = 10,
+#else
+		MAX_SKILL_COUNT = 6,
 #endif
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-enum EExtBattlePassType
-{
-	BATTLEPASS_NORMAL,
-	BATTLEPASS_PREMIUM,
-	BATTLEPASS_EVENT,
-
-	BATTLEPASS_TYPE_MAX,
+		MAX_EFFECT_COUNT = 5,
+		MAX_BUFF_COUNT = 6,
+		BUFF_BEGIN = MAX_SKILL_COUNT,
+	};
+}
+#endif
+
+enum EMultiLocale
+{
+	MAX_QUEST_NOTICE_ARGS = 5
+};
+
+enum ELocale
+{
+	LOCALE_YMIR, // Korea
+	LOCALE_EN, // United Kingdom
+	LOCALE_PT, // Portugal
+	LOCALE_ES, // Spain
+	LOCALE_FR, // France
+	LOCALE_DE, // Germany
+	LOCALE_RO, // Romania
+	LOCALE_PL, // Poland
+	LOCALE_IT, // Italy
+	LOCALE_CZ, // Czech
+	LOCALE_HU, // Hungary
+	LOCALE_TR, // Turkey
+	LOCALE_MAX_NUM,
+	LOCALE_DEFAULT = LOCALE_EN,
 };
 
-enum EExtBattleMissionPassType
-{
-	MISSION_TYPE_NONE,
-
-	KILL_MONSTER,
-	KILL_PLAYER,
-
-	DAMAGE_MONSTER,
-	DAMAGE_PLAYER,
-
-	BP_ITEM_USE,
-	BP_ITEM_SELL,
-	BP_ITEM_CRAFT,
-	BP_ITEM_REFINE,
-	BP_ITEM_DESTROY,
-	BP_ITEM_COLLECT,
-
-	FISH_FISHING,
-	FISH_GRILL,
-	FISH_CATCH,
-	
-	EXP_COLLECT,
-	YANG_COLLECT,
-	
-	GUILD_PLAY_GUILDWAR,
-	GUILD_SPENT_EXP,
-
-	GAYA_CRAFT_GAYA,
-	GAYA_BUY_ITEM_GAYA_COST,
-	
-	PET_ENCHANT,
-
-	COMPLETE_DUNGEON,
-	COMPLETE_MINIGAME,
-
-	MISSION_TYPE_MAX,
-};
-#endif
-
 #pragma pack(pop)
+
 #endif // __INC_COMMON_LENGTH_H__
diff -ruN baseline/server/server/home/metin2/Source/Server/common/service.h final/server/server/home/metin2/Source/Server/common/service.h
--- baseline/server/server/home/metin2/Source/Server/common/service.h	2025-06-28 20:08:00.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/common/service.h	2022-04-27 09:21:59.000000000 +0000
@@ -4,267 +4,162 @@
 #define __LOCALE_SERVICE_EUROPE__
 #define __LOCALE_SERVICE_OWSAP__
 
-////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
-///////////////////////////////////////////////////////////////////////// Farques
-#define ENABLE_QUEEN_NETHIS // < Kraliçe Nethis Zindanı
-#define SORF_TAHTASI
-#ifdef SORF_TAHTASI
-	#define SURFBOARD 40003 // -- Sörf tahtası mob proto id'si yazılcak
-#endif
-#define __YMIR_REGEN_FIX__ // < Ymir regen FIX
-#define MOUNT_FIX // < Binek geri atma fix
-
-//#define __OFFLINE_SHOP__
-//#define __SHOP_SEARCH__
-
-#define ENABLE_EXTENDED_BATTLE_PASS 	// Extended Battlepass-System by Aslan
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	#define RESTRICT_COMMAND_GET_INFO					GM_LOW_WIZARD
-	#define RESTRICT_COMMAND_SET_MISSION				GM_IMPLEMENTOR
-	#define RESTRICT_COMMAND_PREMIUM_ACTIVATE	GM_IMPLEMENTOR	
+#define __GROWTH_PET_SYSTEM__
+////////////////////////////////////////////////////////////////////////////////
+// Currency Related
+#define __CHEQUE_SYSTEM__ // Cheque (Won) System
+#define __GEM_SYSTEM__ // Gem (Gaya) System
+#if defined(__GEM_SYSTEM__)
+#	define __GEM_MARKET_SYSTEM__ // Gem (Gaya) Market System
 #endif
 
-#define __GROWTH_PET_SYSTEM__ // < Offical Pet
-
-
-
 ////////////////////////////////////////////////////////////////////////////////
-// Game Related
-#define __MAILBOX__ // Mail Box System
-#define __QUEST_RENEWAL__ // Quest Page Renewal
-#if defined(__QUEST_RENEWAL__)
-#	define __QUEST_EVENT_DAMAGE__ // Damage Quest Event
-#	define __QUEST_EVENT_DEAD__ // Dead Quest Event
-#	define __QUEST_EVENT_FISH__ // Fishing Quest Event
-#	define __QUEST_EVENT_MINE__ // Mining Quest Event
-#	define __QUEST_EVENT_BUY_SELL__ // NPC Buy/Sell Quest Event
-#	define __QUEST_EVENT_CRAFT__ // Craft Quest Event
-#	define __QUEST_EVENT_EMOTION__ // Emotion Quest Event
-#	define __QUEST_EVENT_RESTART_HERE__ // Restart Here Quest Event
-#	define __QUEST_REQUEST_EVENT__ // Request Quest Event
-#endif
-#define __CHATTING_WINDOW_RENEWAL__ // Chatting Window Renewal (Mini Version)
-#define __CUBE_RENEWAL__ // Cube Renewal
-#define __RANKING_SYSTEM__ // Ranking System
-#define __ELEMENT_SYSTEM__ // Element System
-#define __SEND_TARGET_INFO__ // Monster Information & Drops
-#define __PVP_COUNTDOWN__ // PvP Duel Countdown
-#define __REFINE_MSG_ADD__ // Extended refine fail message
-#define __PVP_BALANCE_IMPROVING__ // PvP Balance Improving
+// Minigame Related
+#define /* @author: VegaS */ __MINI_GAME_OKEY__ // Minigame Rumi (Okey)
+#define /* @author: ZeNu */ __MINI_GAME_CATCH_KING__ // Minigame Catch King
 
 ////////////////////////////////////////////////////////////////////////////////
-// Map & Dungeon Related
-#define __SNOW_DUNGEON__ // Snow Dungeon
-#define __DUNGEON_RENEWAL__ // Extended Dungeon Functions
-#define __BLUE_DRAGON_RENEWAL__ // Blue Dragon Rework
-#define __MT_THUNDER_DUNGEON__ // Ochao Temple
-#define __DAWNMIST_DUNGEON__ // Erebus Dungeon
-#define __DEFENSE_WAVE__ // Defense Wave
-#define __CLIENT_TIMER__ // Client Timer (Used for instances)
-#define __LABYRINTH_DUNGEON__ // Labyrinth Dungeon (Utils)
-#define __ELEMENTAL_DUNGEON__ // Elemental Dungeon
-#define __GUILD_DRAGONLAIR_SYSTEM__ // Guild Dragon Lair
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-#	define __GUILD_DRAGONLAIR_PARTY_SYSTEM__ // Guild Dragon Lair Party
-#endif
+// Dragon Soul Related
+#define __DS_GRADE_MYTH__ // Dragon Soul Mythical Grade
+#define __DS_SET__ // Dragon Soul Table Handling
+#define __EXTENDED_DSS_RECHARGE__ // [ITEM] Dragon Soul Extended Recharge
 
 ////////////////////////////////////////////////////////////////////////////////
-// Mini-Game Related
-#define __MINI_GAME_RUMI__ // Mini-Game Rumi
-#if defined(__MINI_GAME_RUMI__)
-#	define __OKEY_EVENT_FLAG_RENEWAL__
-#endif
-#define __MINI_GAME_YUTNORI__ // Mini-Game Yutnori
-#if defined(__MINI_GAME_YUTNORI__)
-#	define __YUTNORI_EVENT_FLAG_RENEWAL__
-#endif
-#define __MINI_GAME_CATCH_KING__ // Mini-Game Catch King
-#if defined(__MINI_GAME_CATCH_KING__)
-#	define __CATCH_KING_EVENT_FLAG_RENEWAL__
-#endif
-#define __FISHING_GAME__ // Fishing Game
-#define __SUMMER_EVENT_ROULETTE__ // Mini-Game Roulette (Late Summer Event)
+// Costume Related
+#define __COSTUME_SYSTEM__ // Costume System
+#define __MOUNT_COSTUME_SYSTEM__ // Mount Costume System
+#define __ACCE_COSTUME_SYSTEM__ // Acce (Sash) Costume System
+#define __WEAPON_COSTUME_SYSTEM__ // Weapon Costume System
+#define __COSTUME_ATTR_SYSTEM__ // [ITEM] Costume Attributes System
+#define /* @author: Owsap */ __EXTENDED_COSTUME_RECHARGE__ // [ITEM] Costume Extended Recharge
+#define /* @author: Owsap */ __HIDE_COSTUME_SYSTEM__ // Hide Costume System
+#define __AURA_COSTUME_SYSTEM__ // Aura Costume System (Proto Support Only)
 
 ////////////////////////////////////////////////////////////////////////////////
-// Event Related
-#define __EASTER_EVENT__ // Easter Event 2011
-#define __XMAS_EVENT_2008__ // Christmas Event 2008
-#define __XMAS_EVENT_2012__ // Christmas Event 2012
-#define __2016_VALENTINE_EVENT__ // Valentine Event 2016~2024
-#define __HALLOWEEN_EVENT_2014__ // Halloween Event 2011~2014 (Halloween Hair)
-#define __OX_RENEWAL__ // OX Renewal
-#define __EVENT_BANNER_FLAG__ // Event Banner Flags
-#define __METINSTONE_SWAP__ // Swap Stone Shape
-#define __RACE_SWAP__ // Swap Race Shape
-#define __SNOWFLAKE_STICK_EVENT__ // Snowflake Stick Event
-#define __INGAME_EVENT_MANAGER__ // InGame Event Manager
-#define __FLOWER_EVENT__ // Flower Event
+// Inventory & Equipment Related
+#define __SWAP_ITEM_SYSTEM__ // Swap Item Slot
+#define __INVENTORY_4PAGES__ // Extended Inventory Pages (4)
+#define __SPECIAL_INVENTORY_SYSTEM__ // Special Inventory System
+//#define __SORT_INVENTORY_ITEMS__ // Sort Inventory Items
+#define __QUIVER_SYSTEM__ // Quiver Equipement
+#define __PENDANT_SYSTEM__ // Talisman Elements
+#define __GLOVE_SYSTEM__ // Glove Equipement
 
 ////////////////////////////////////////////////////////////////////////////////
-// Currency Related
-#define __CHEQUE_SYSTEM__ // Cheque (Won) System
-#define __GEM_SYSTEM__ // Gem (Gaya) System
+// Messenger Related
+#define __MESSENGER_BLOCK_SYSTEM__ // Messenger Block System
+#define __MESSENGER_GM__ // Messenger GM List
 
 ////////////////////////////////////////////////////////////////////////////////
 // Shop Related
-#define __SHOPEX_RENEWAL__ // ShopEX Renewal
+#define /* @author: blackdragonx61 */ __SHOPEX_RENEWAL__ // ShopEX Renewal
 #if defined(__SHOPEX_RENEWAL__)
 #	define __SHOPEX_TAB4__ // ShopEx 4 Tabs
 #endif
-//#define __SHOPEX_EMPIRE_TAX__ // ShopEx Tax (Triple Price)
-#define __MYSHOP_DECO__ // Private Shop Decoration
-#define __MYSHOP_EXPANSION__ // Additional Private Shop Tab
-#if defined(__GEM_SYSTEM__)
-#	define __GEM_SHOP__ // Gem (Gaya) Shop
-#endif
+#define /* @author: Owsap */ __MYSHOP_DECO__ // Private Shop Decoration
+#define /* @author: blackdragonx61 */ __PRIVATESHOP_SEARCH_SYSTEM__ // Private Shop Search System
 
 ////////////////////////////////////////////////////////////////////////////////
-// Dragon Soul Related
-#define __DRAGON_SOUL_SYSTEM__ // Dragon Soul System
-#if defined(__DRAGON_SOUL_SYSTEM__)
-	#define __DS_GRADE_MYTH__ // Dragon Soul Mythical Grade
-	#define __DS_SET__ // Dragon Soul Table Handling
-	#define __DS_CHANGE_ATTR__ // Dragon Soul Change Attribute
-	#define __DS_7_SLOT__ // Dragon Soul 7th Slot
+// Player Related
+#define __VIEW_TARGET_DECIMAL_HP__ // View Target HP
+#if defined(__VIEW_TARGET_DECIMAL_HP__)
+#	define __VIEW_TARGET_PLAYER_HP__ // View Player Target HP
 #endif
-
-////////////////////////////////////////////////////////////////////////////////
-// Pet Related
-#define __PET_SYSTEM__ // Pet System
-#define __PET_LOOT__ // Pet Loot
-//#define __PET_LOOT_AI__ // Pet Loot AI (Goes and picks items)
-
-////////////////////////////////////////////////////////////////////////////////
-// Character Related
 #define __PLAYER_PER_ACCOUNT5__ // Players Per Account (5)
 #define __WOLFMAN_CHARACTER__ // Wolfman Character
 #if defined(__WOLFMAN_CHARACTER__)
 //#	define __DISABLE_WOLFMAN_CREATION__ // Disable Wolfman Creation
 #endif
-#define __VIEW_TARGET_HP__ // View Target HP
-#if defined(__VIEW_TARGET_HP__)
-#	define __VIEW_TARGET_PLAYER_HP__ // View Player Target HP
+#define /* @author: Owsap */ __PLAYER_PIN_SYSTEM__ // Player PIN Code
+#if defined(__PLAYER_PIN_SYSTEM__)
+//#	define __DISABLE_PIN_SYSTEM__ // Disable Player PIN Code Input
 #endif
-#define __IMPROVED_LOGOUT_POINTS__ // Improved Logout Points
-#define __EXPRESSING_EMOTIONS__ // Special Actions
-#define __CONQUEROR_LEVEL__ // Conqueror Level
-#define __MULTI_LANGUAGE_SYSTEM__ // Multi Language System
-#define __DELETE_FAILURE_TYPE__ // Delete Character Failure Type
-#define __LEFT_SEAT__ // Left Seat (AFK)
-#define __AFFECT_RENEWAL__ // Affect Renewal
-
-////////////////////////////////////////////////////////////////////////////////
-// Skill Related
+#define __GUILD_LEADER_GRADE_NAME__ // Guild Leader Grade Name (TextTail)
+#define /* @auhtor: VegaS */ __GENDER_ALIGNMENT__ // Gender Alignment (M, F)
+#define /* @author: blackdragonx61 */ __IMPROVED_LOGOUT_POINTS__ // Improved Logout Points
+#define /* @author: blackdragonx61 */ __SKILL_COOLTIME_UPDATE__ // Refresh Skill Cooldown After Death
+#define /* @author: Owsap */ __EXPRESSING_EMOTIONS__ // Special Actions
+#define __RANDOM_STATUS_PER_LEVEL__ // Random Status Per Level
+#define __PVP_COUNTDOWN__ // PvP Duel Countdown
 #define __7AND8TH_SKILLS__ // 7th, 8th Passive Skills
-#define __SKILL_COOLTIME_UPDATE__ // Refresh Skill Cooldown After Death
+#define __PARTY_PROFICY__ // Party Proficy Passive Skill
 #define __9TH_SKILL__ // 9th Player Skill
-#define __PARTY_PROFICY__ // Party Proficiency Passive Skill
-#define __PARTY_INSIGHT__ // Party InSight Passive Skill
+#define __CONQUEROR_LEVEL__ // Conqueror Level
 
 ////////////////////////////////////////////////////////////////////////////////
-// Party & Guild Related
+// Game Related
+#define __PET_SYSTEM__ // Pet System
 #define __DICE_SYSTEM__ // New Dice System (Party)
-#define __WJ_SHOW_PARTY_ON_MINIMAP__ // Party Member Atlas (Map)
-#define __PARTY_CHANNEL_FIX__ // Party Channel Fix
-#define __GUILD_LEADER_GRADE_NAME__ // Guild Leader Grade Name (TextTail)
-#define __PARTY_KILL_RENEWAL__ // All kill events count towards the party.
-#define __GUILD_WAR_AUTO_JOIN_LEADER__ // Join the Guild War automatically as the Leader.
-#define __GUILD_EVENT_FLAG__ // Guild Event Flag
-
-////////////////////////////////////////////////////////////////////////////////
-// Messenger Related
-#define __MESSENGER_BLOCK_SYSTEM__ // Messenger Block System
-#define __MESSENGER_GM__ // Messenger GM List
-#define __MESSENGER_DETAILS__ // Messenger Details
-
-////////////////////////////////////////////////////////////////////////////////
-// Inventory Related
-#define __EXTEND_INVEN_SYSTEM__ // Extended Inventory System
-#define __EXTEND_MALLBOX__ // Extended Mallbox
-#define __SAFEBOX_IMPROVING__ // Safebox Improving
-
-////////////////////////////////////////////////////////////////////////////////
-// Equipment Related
-#define __QUIVER_SYSTEM__ // Quiver Equipment
-#define __PENDANT_SYSTEM__ // Talisman Elements
-#define __GLOVE_SYSTEM__ // Glove Equipment
-
-////////////////////////////////////////////////////////////////////////////////
-// Costume Related
-#define __COSTUME_SYSTEM__ // Costume System
-#define __MOUNT_COSTUME_SYSTEM__ // Mount Costume System
-#define __ACCE_COSTUME_SYSTEM__ // Acce (Sash) Costume System
-#define __AURA_COSTUME_SYSTEM__ // Aura Costume System
-#define __WEAPON_COSTUME_SYSTEM__ // Weapon Costume System
-#if defined(__WEAPON_COSTUME_SYSTEM__)
-#	define __HIDE_WEAPON_COSTUME_WITH_NO_MAIN_WEAPON__
+#define __MOVE_CHANNEL__ // Move Game Channel
+//#define __SKILL_COLOR_SYSTEM__ // Skill Color System
+#define /* @author: Owsap */ __SKILLBOOK_COMB_SYSTEM__ // Skill Book Combination
+#define __SEND_TARGET_INFO__ // Monster Information & Drops
+#define /* @author: Owsap */ __ELEMENT_SYSTEM__ // Element System
+#define __CHANGE_LOOK_SYSTEM__ // Change Look System (Item Look)
+#if defined(__CHANGE_LOOK_SYSTEM__)
+#	define __MOUNT_CHANGE_LOOK__ // Mount Change Look
 #endif
-#define __MOVE_COSTUME_ATTR__ // Move Costume Attribute (Item Combination)
-#define __HIDE_COSTUME_SYSTEM__ // Hide Costume System
+#define /* @author: VegaS */ __EXTENDED_ITEM_AWARD__ // Extended Item Award
+#define /* @author: VegaS */ __REFINE_FAIL_TYPE__ // Extended Refine Fail Message
+#define /* @author: blackdragonx61 */ __CHANNEL_STATUS_UPDATE__ // Channel Player Count
+#define /* @author: blackdragonx61 */ __WJ_SHOW_PARTY_ON_MINIMAP__ // Party Member Atlas (Map)
+#define /* @author: Owsap */ __EVENT_BANNER_FLAG__ // Event Banner Flags
+#define /* @author: blackdragonx61 */ __MAILBOX__ // Mail Box System
 
 ////////////////////////////////////////////////////////////////////////////////
 // Item Related
+#define __ANTI_EXP_RING__ // Anti Experience Ring
+#define __ITEM_DROP_RENEWAL__ // Item Drop Renewal w/ Color Effect
+#define __WJ_PICKUP_ITEM_EFFECT__ // Picking Item Effect
+#define __NEW_DROP_DIALOG__ // New Drop Dialog w/ Delete Item Option
+#define __SOUL_BIND_SYSTEM__ // Soul Bind System (Protect Items)
+#define __GACHA_SYSTEM__ // Boss (Gacha) Boxes (Open x Times)
 #define __MAGIC_REDUCTION__ // Magic Reduction Item
 #define __STONE_OF_BLESS__ // Stone of Bless (Refinement Item)
-#define __REFINE_PICKAXE_RENEWAL__ // Refine Pickaxe Renewal
-#define __REFINE_FISHINGROD_RENEWAL__ // Refine Fishing Rod Renewal
-#define __SOUL_BIND_SYSTEM__ // Seal Scroll System
-#if defined(__SOUL_BIND_SYSTEM__)
-#	define __DRAGON_SOUL_SEAL__ // Dragon Soul Seal
-#	define __UN_SEAL_SCROLL_PLUS__ // Unseal Scroll Plus
-#endif
-//#define __SOUL_SYSTEM__ // Soul System
-#if defined(__SOUL_SYSTEM__)
-#	define __SOUL_SYSTEM_CALC_FINAL_DAMAGE__
-#endif
+#define /* @author: Owsap */ __SOUL_SYSTEM__ // Soul System
+#define /* @author: Owsap */ __BLEND_AFFECT__ // Blend Affects w/ Icon
+#define /* @author: Owsap */ __EXTENDED_BLEND_AFFECT__ // Extended Blend Item Affect
+#define __ITEM_SOCKET5__ // Extended Item Sockets (5)
 #define __ITEM_APPLY4__ // Extended Apply Bonus (4)
-#define __ITEM_SOCKET6__ // Extended Item Sockets (6)
-#define __ITEM_VALUE10__ // Extended Item Values
-#define __ITEM_APPLY_RANDOM__ // Apply Random Bonus (Base Bonus)
-#define __CHANGED_ATTR__ // Change / Select Attribute
-#define __ATTR_6TH_7TH__ // 6th and 7th Attribute
-#define __SKILLBOOK_COMB_SYSTEM__ // Skill Book Combination
-#define __CHANGE_LOOK_SYSTEM__ // Change Look System (Item Look)
-#define __LOOT_FILTER_SYSTEM__ // Looting System
-#if defined(__LOOT_FILTER_SYSTEM__)
-#	define __PREMIUM_LOOT_FILTER__ // Enable Premium Usage of the Loot Filter System
+#define /* @author: Owsap */ __ITEM_APPLY_RANDOM__ // Apply Random Bonus (Base Bonus)
+
+////////////////////////////////////////////////////////////////////////////////
+// Dungeon Related
+#define __12ZI_NOTICE__ // 12ZI Mission Notice (w/o Dungeon)
+#define __DUNGEON_INFO_SYSTEM__ // Dungeon Information System
+#define __GUILD_DRAGONLAIR_PARTY_SYSTEM__ // Guild Dragon Lair Party
+#if defined(__GUILD_DRAGONLAIR_PARTY_SYSTEM__)
+#	define __GUILD_DRAGONLAIR__ // Guild Dragon Lair Dungeon
+#	if defined(__GUILD_DRAGONLAIR__)
+#		define GUILD_DRAGONLAIR_DESTROY_STATUE_GM
+#		define GUILD_DRAGONLAIR_LAZER_EFFECT_75HP
+#		define GUILD_DRAGONLAIR_LAZER_EFFECT_50HP
+#	endif
 #endif
-#define __GACHA_SYSTEM__ // Boss (Gacha) Boxes (Open x Times)
-#define __LUCKY_BOX__ // Lucky Box
-#define __SET_ITEM__ // Set Item Bonus
-#define __GEM_CONVERTER__ // Gem Converter
-#define __REFINE_ELEMENT_SYSTEM__ // Refine Element System
-#define __USE_NEXT_AUTO_POTION__ // When the automatic potion runs out, use the next one.
-#define __REFINE_STACK_FIX__ // Refine Stack Fix (Used for stones)
+#define __TEMPLE_OCHAO__ // Temple of the Ochao
+#define __EREBUS_DUNGEON__ // Erebus Dungeon
 
 ////////////////////////////////////////////////////////////////////////////////
 // UI Related
 #define __WJ_SHOW_MOB_INFO__ // Monsters Level & Aggressive Flag
-#define __WJ_PICKUP_ITEM_EFFECT__ // Picking Item Effect
-#define __NEW_USER_CARE__ // User Care (Control)
+#define __WJ_NEW_USER_CARE__ // User Care (Control)
 #define __BINARY_ATLAS_MARK_INFO__ // Atlas Mark Info Load
-#define __POPUP_NOTICE__ // Pop-up notification
-#define __NEW_DROP_DIALOG__ // New Drop Dialog w/ Delete Item Option
-#define __ITEM_DROP_RENEWAL__ // Item Drop Renewal w/ Color Effect
-#define __GAME_OPTION_ESCAPE__ // Game Option (Escape)
+#define /* @author: Owsap */ __QUEST_RENEWAL__ // Quest Page Renewal
+#define /* @author: Owsap */ __CHATTING_WINDOW_RENEWAL__ // Chatting Window Renewal (Mini Version)
+
+////////////////////////////////////////////////////////////////////////////////
+// Environment Related
+#define /* @author: blackdragonx61 */ __ENVIRONMENT__ // Environment System
 
 ////////////////////////////////////////////////////////////////////////////////
 // Miscellaneous
 #define __EXTENDED_RELOAD__ // Extended GM Reload Commands (For drops)
-#define __EXTENDED_ITEM_AWARD__ // Extended Item Award
-#define __ENVIRONMENT_SYSTEM__ // Environment System
-#define __LOCALE_CLIENT__ // Locale Client
 
-////////////////////////////////////////////////////////////////////////////////
+//////////////////////////////////////////////////////////////////////////
 // Network Related
-//#define __IMPROVED_PACKET_ENCRYPTION__ // Improved Packet Encryption
+#define __IMPROVED_PACKET_ENCRYPTION__ // Ŷ ȣȭ 
 //#define __SEND_SEQUENCE__ // Sequence Matching
 #define __UDP_BLOCK__ // UDP Block
 //#define __ALLOW_EXTERNAL_PEER__ // Allow External Peer API
-#define __PROXY_IP__ // Proxy IP
-#define __MOVE_CHANNEL__ // Move Game Channel
-#define __CHECK_PORT_STATUS__ // Check Port Status
-#define __AUTO_DETECT_INTERNAL_IP__ // Detect Internal IP
 
-#include "disclaimer.h"
 #endif // __INC_COMMON_SERVICE_H__
diff -ruN baseline/server/server/home/metin2/Source/Server/common/tables.h final/server/server/home/metin2/Source/Server/common/tables.h
--- baseline/server/server/home/metin2/Source/Server/common/tables.h	2025-06-28 20:11:04.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/common/tables.h	2022-04-27 09:33:55.000000000 +0000
@@ -4,9 +4,6 @@
 #include "service.h"
 #include "length.h"
 
-#include <array>
-#include <utility>
-
 typedef DWORD IDENT;
 
 /**
@@ -90,9 +87,8 @@
 	HEADER_GD_PARTY_SET_MEMBER_LEVEL = 56,
 
 	HEADER_GD_GUILD_WAR_BET = 57,
-#if defined(__GUILD_EVENT_FLAG__) //&& defined(__GUILD_RENEWAL__)
-	HEADER_GD_GUILD_EVENT_FLAG = 58,
-#endif
+
+	//HEADER_GD_EMPTY = 58,
 	//HEADER_GD_EMPTY = 59,
 
 	HEADER_GD_CREATE_OBJECT = 60,
@@ -198,20 +194,28 @@
 	HEADER_GD_UPDATE_CHANNELSTATUS = 139,
 	HEADER_GD_REQUEST_CHANNELSTATUS = 140,
 
-	//HEADER_GD_EMPTY = 142,
-	//HEADER_GD_EMPTY = 143,
+#if defined(__GUILD_DRAGONLAIR_PARTY_SYSTEM__)
+	HEADER_GD_GUILD_DUNGEON = 141,
+	HEADER_GD_GUILD_DUNGEON_CD = 142,
+	HEADER_GD_GUILD_DUNGEON_ST = 143,
+#endif
 
 #if defined(__MOVE_CHANNEL__)
 	HEADER_GD_FIND_CHANNEL = 144,
 #endif
 
-	//HEADER_GD_EMPTY = 145,
-	//HEADER_GD_EMPTY = 146,
+#if defined(__SKILL_COLOR_SYSTEM__)
+	HEADER_GD_SKILL_COLOR_SAVE = 145,
+#endif
+
+	HEADER_GD_REQUEST_CHANGE_LANGUAGE = 146,
 
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	HEADER_GD_SAVE_EXT_BATTLE_PASS = 147,
+#ifdef __GROWTH_PET_SYSTEM__
+	HEADER_GD_GROWTH_PET_SAVE		= 147,
+	HEADER_GD_GROWTH_PET_DELETE		= 148,
 #endif
 
+	//HEADER_GD_EMPTY = 147,
 	//HEADER_GD_EMPTY = 148,
 	//HEADER_GD_EMPTY = 149,
 #if defined(__MAILBOX__)
@@ -226,35 +230,28 @@
 	//HEADER_GD_EMPTY = 157,
 	//HEADER_GD_EMPTY = 158,
 	//HEADER_GD_EMPTY = 159,
-#if defined(__GEM_SHOP__)
-	HEADER_GD_GEM_SHOP_LOAD = 160,
-	HEADER_GD_GEM_SHOP_UPDATE = 161,
-#endif
+	//HEADER_GD_EMPTY = 160,
+	//HEADER_GD_EMPTY = 161,
 	//HEADER_GD_EMPTY = 162,
-
-#ifdef __GROWTH_PET_SYSTEM__
-	HEADER_GD_GROWTH_PET_SAVE = 163,
-	HEADER_GD_GROWTH_PET_DELETE = 164,
-#endif
-
-#if defined(__EXPRESSING_EMOTIONS__)
-	HEADER_GD_EMOTE_LOAD = 165,
-	HEADER_GD_EMOTE_CLEAR = 166,
-	HEADER_GD_EMOTE_ADD = 167,
-#endif
-
-#ifdef __SHOP_SEARCH__
-	HEADER_GD_SHOP_SEARCH_REGISTER_ITEM = 172,
-	HEADER_GD_SHOP_SEARCH_UNREGISTER_ITEM = 173,
-	HEADER_GD_SHOP_SEARCH_SOLD_ITEM = 174,
-	HEADER_GD_SHOP_SEARCH_BY_NAME = 175,
-	HEADER_GD_SHOP_SEARCH_BY_OPTIONS = 176,
-	HEADER_GD_SHOP_SEARCH_REQUEST_BUY = 177,
-	HEADER_GD_SHOP_SEARCH_BUY_FROM_SHOP_ERROR = 178,
-	HEADER_GD_SHOP_SEARCH_BOUGHT_FROM_SHOP = 179,
-	HEADER_GD_SHOP_SEARCH_REQUEST_SOLD_INFO = 180,
-	HEADER_GD_SHOP_SEARCH_RELOAD_AVERAGE = 181,
-#endif
+	//HEADER_GD_EMPTY = 163,
+	//HEADER_GD_EMPTY = 164,
+	//HEADER_GD_EMPTY = 165,
+	//HEADER_GD_EMPTY = 166,
+	//HEADER_GD_EMPTY = 167,
+	//HEADER_GD_EMPTY = 168,
+	//HEADER_GD_EMPTY = 169,
+	//HEADER_GD_EMPTY = 170,
+	//HEADER_GD_EMPTY = 171,
+	//HEADER_GD_EMPTY = 172,
+	//HEADER_GD_EMPTY = 173,
+	//HEADER_GD_EMPTY = 174,
+	//HEADER_GD_EMPTY = 175,
+	//HEADER_GD_EMPTY = 176,
+	//HEADER_GD_EMPTY = 177,
+	//HEADER_GD_EMPTY = 178,
+	//HEADER_GD_EMPTY = 179,
+	//HEADER_GD_EMPTY = 180,
+	//HEADER_GD_EMPTY = 181,
 	//HEADER_GD_EMPTY = 182,
 	//HEADER_GD_EMPTY = 183,
 	//HEADER_GD_EMPTY = 184,
@@ -316,14 +313,10 @@
 	//HEADER_GD_EMPTY = 240,
 	//HEADER_GD_EMPTY = 241,
 	//HEADER_GD_EMPTY = 242,
-
-#ifdef __OFFLINE_SHOP__
-	HEADER_GD_REQUEST_OFFLINE_SHOP_ID = 243,
-	HEADER_GD_OFFLINE_SHOP_SAVE = 244,
-	HEADER_GD_OFFLINE_SHOP_SAVE_ITEM = 245,
-	HEADER_GD_OFFLINE_SHOP_DESTROY = 246,
-#endif
-
+	//HEADER_GD_EMPTY = 243,
+	//HEADER_GD_EMPTY = 244,
+	//HEADER_GD_EMPTY = 245,
+	//HEADER_GD_EMPTY = 246,
 	//HEADER_GD_EMPTY = 247,
 	//HEADER_GD_EMPTY = 248,
 	//HEADER_GD_EMPTY = 249,
@@ -460,9 +453,7 @@
 	HEADER_DG_GUILD_WAR_RESERVE_ADD = 106,
 	HEADER_DG_GUILD_WAR_RESERVE_DEL = 107,
 	HEADER_DG_GUILD_WAR_BET = 108,
-#if defined(__GUILD_EVENT_FLAG__) //&& defined(__GUILD_RENEWAL__)
-	HEADER_DG_GUILD_EVENT_FLAG = 109,
-#endif
+	//HEADER_DG_EMPTY = 109,
 	//HEADER_DG_EMPTY = 110,
 	//HEADER_DG_EMPTY = 111,
 	//HEADER_DG_EMPTY = 112,
@@ -543,23 +534,26 @@
 
 	HEADER_DG_NEED_LOGIN_LOG = 177,
 
+	//HEADER_DG_EMPTY = 178,
+
 	HEADER_DG_RESULT_CHARGE_CASH = 179,
 	HEADER_DG_ITEMAWARD_INFORMER = 180, // gift notify
 	HEADER_DG_RESPOND_CHANNELSTATUS = 181,
 
-#if defined(__EXPRESSING_EMOTIONS__)
-	HEADER_DG_EMOTE_LOAD = 182,
-	HEADER_DG_EMOTE_GET = 183,
+#if defined(__GUILD_DRAGONLAIR_PARTY_SYSTEM__)
+	HEADER_DG_GUILD_DUNGEON = 182,
+	HEADER_DG_GUILD_DUNGEON_CD = 183,
+	HEADER_DG_GUILD_DUNGEON_ST = 184,
 #endif
 #if defined(__MOVE_CHANNEL__)
 	HEADER_DG_CHANNEL_RESULT = 185,
 #endif
-	//HEADER_DG_EMPTY = 186,
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	HEADER_DG_EXT_BATTLE_PASS_LOAD = 187,
+#if defined(__SKILL_COLOR_SYSTEM__)
+	HEADER_DG_SKILL_COLOR_LOAD = 186,
+#endif
+#ifdef __GROWTH_PET_SYSTEM__
+	HEADER_DG_GROWTH_PET_LOAD		= 187,
 #endif
-
 	//HEADER_DG_EMPTY = 188,
 	//HEADER_DG_EMPTY = 189,
 #if defined(__MAILBOX__)
@@ -569,23 +563,15 @@
 #endif
 	//HEADER_DG_EMPTY = 193,
 	//HEADER_DG_EMPTY = 194,
-
-#ifdef __GROWTH_PET_SYSTEM__
-	HEADER_DG_GROWTH_PET_LOAD = 195,
-#endif
-
-#if defined(__GEM_SHOP__)
-	HEADER_DG_GEM_SHOP_LOAD = 196,
-	HEADER_DG_GEM_SHOP_UPDATE = 197,
-#endif
+	//HEADER_DG_EMPTY = 195,
+	//HEADER_DG_EMPTY = 196,
+	//HEADER_DG_EMPTY = 197,
 	//HEADER_DG_EMPTY = 198,
-#ifdef __SHOP_SEARCH__
-	HEADER_DG_SHOP_SEARCH_RESULT = 199,
-	HEADER_DG_SHOP_SEARCH_BUY_RESULT = 200,
-	HEADER_DG_SHOP_SEARCH_BUY_FROM_SHOP = 201,
-	HEADER_DG_SHOP_SEARCH_SOLD_INFO = 202,
-#endif
-
+	//HEADER_DG_EMPTY = 199,
+	//HEADER_DG_EMPTY = 200,
+	//HEADER_DG_EMPTY = 201,
+	//HEADER_DG_EMPTY = 202,
+	//HEADER_DG_EMPTY = 203,
 	//HEADER_DG_EMPTY = 204,
 	//HEADER_DG_EMPTY = 205,
 	//HEADER_DG_EMPTY = 206,
@@ -632,14 +618,11 @@
 	//HEADER_DG_EMPTY = 247,
 	//HEADER_DG_EMPTY = 248,
 	//HEADER_DG_EMPTY = 249,
-
-#ifdef __OFFLINE_SHOP__
-	HEADER_DG_RESPOND_OFFLINE_SHOP_ID = 250,
-#endif
-
+	//HEADER_DG_EMPTY = 250,
 	//HEADER_DG_EMPTY = 251,
 	//HEADER_DG_EMPTY = 252,
 	//HEADER_DG_EMPTY = 253,
+
 	HEADER_DG_MAP_LOCATIONS = 0xfe, // 254
 	HEADER_DG_P2P = 0xff, // 255
 };
@@ -660,6 +643,76 @@
 
 } TRequestChargeCash;
 
+typedef struct SPetSkill
+{
+	bool	bLocked;
+	BYTE	bSkill;
+	BYTE	bLevel;
+	DWORD	dwCooltime;
+
+	SPetSkill()
+	{
+		bLocked = true;
+		bSkill = 0;
+		bLevel = 0;
+		dwCooltime = 0;
+	}
+} TPetSkill;
+
+typedef struct SGrowthPet
+{
+	DWORD	dwID;
+	DWORD	dwOwner;
+	DWORD	dwVnum;
+	BYTE	bState;
+	char	szName[PET_NAME_MAX_SIZE + 1];
+	BYTE	bSize;
+
+	DWORD	dwLevel;
+	BYTE	bLevelStep;
+	BYTE	bEvolution;
+	BYTE	bType;
+	DWORD	dwHP;
+	DWORD	dwSP;
+	DWORD	dwDef;
+
+	DWORD	dwHPApply;
+	DWORD	dwSPApply;
+	DWORD	dwDefApply;
+	DWORD	dwAgeApply;
+
+	TPetSkill	aSkill[PET_SKILL_COUNT_MAX];
+
+	DWORD	lExp;
+	DWORD	lItemExp;
+
+	time_t	lBirthday;
+	time_t	lEndTime;
+	time_t	lMaxTime;
+} TGrowthPet;
+
+typedef struct SGrowthPetSkillTable
+{
+	DWORD	dwPetVnum;
+	DWORD	dwSkillVnum;
+	char	szName[32 + 1];
+	BYTE	bType;
+	DWORD	dwCooldown;
+	DWORD	dwAffectFlag;
+
+	char	szPointOn[64];
+	char	szPointPoly1[100 + 1];
+	char	szPointPoly2[100 + 1];
+	char	szPointPoly3[100 + 1];
+	char	szPointPoly4[100 + 1];
+	char	szPointPoly5[100 + 1];
+	char	szPointPoly6[100 + 1];
+	char	szPointPoly7[100 + 1];
+	char	szPointPoly8[100 + 1];
+	char	szActivatePctPoly[100 + 1];
+	char	szDurationPoly[100 + 1];
+} TGrowthPetSkillTable;
+
 typedef struct SSimplePlayer
 {
 	DWORD dwID;
@@ -668,11 +721,11 @@
 	BYTE byLevel;
 	DWORD dwPlayMinutes;
 	BYTE byST, byHT, byDX, byIQ;
-	DWORD dwMainPart;
+	WORD wMainPart;
 	BYTE bChangeName;
-	DWORD dwHairPart;
+	WORD wHairPart;
 #if defined(__ACCE_COSTUME_SYSTEM__)
-	DWORD dwAccePart;
+	WORD wAccePart;
 #endif
 	BYTE bDummy[4];
 	long x, y;
@@ -680,6 +733,7 @@
 	WORD wPort;
 	BYTE skill_group;
 	DWORD last_play;
+	char szPinCode[PIN_CODE_LENGTH + 1];
 #if defined(__CONQUEROR_LEVEL__)
 	BYTE byConquerorLevel;
 	BYTE bySungmaStr, bySungmaHp, bySungmaMove, bySungmaImmune;
@@ -694,9 +748,8 @@
 	char social_id[SOCIAL_ID_MAX_LEN + 1];
 	char status[ACCOUNT_STATUS_MAX_LEN + 1];
 	BYTE bEmpire;
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-	char country[COUNTRY_NAME_MAX_LEN + 1];
-#endif
+	char hwid[HWID_MAX_NUM + 1];
+	BYTE bLanguage;
 	TSimplePlayer players[PLAYER_PER_ACCOUNT];
 } TAccountTable;
 
@@ -706,104 +759,41 @@
 	TSimplePlayer player;
 } TPacketDGCreateSuccess;
 
-typedef struct SPlayerItemAttribute
+typedef struct TPlayerItemAttribute
 {
-	POINT_TYPE wType;
-	POINT_VALUE lValue;
+	BYTE bType;
+	short sValue;
 #if defined(__ITEM_APPLY_RANDOM__)
 	BYTE bPath;
 #endif
 } TPlayerItemAttribute;
 
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-typedef struct SPlayerItemRefineElement
-{
-	WORD wApplyType;
-	BYTE bGrade;
-	BYTE abValue[REFINE_ELEMENT_MAX];
-	BYTE abBonusValue[REFINE_ELEMENT_MAX];
-	SPlayerItemRefineElement()
-	{
-		wApplyType = 0;
-		bGrade = 0;
-		memset(&abValue, 0, sizeof(abValue));
-		memset(&abBonusValue, 0, sizeof(abBonusValue));
-	}
-} TPlayerItemRefineElement;
-#endif
-
 typedef struct SPlayerItem
 {
-	DWORD dwID;
-	DWORD dwOwner;
-
-	BYTE bWindow;
-	WORD wPos;
-
-	DWORD dwVnum;
-	DWORD dwCount;
-
-#if defined(__SOUL_BIND_SYSTEM__)
-	long lSealDate;
-#endif
+	DWORD id;
+	BYTE window;
+	WORD pos;
+	DWORD count;
 
+	DWORD vnum;
 	long alSockets[ITEM_SOCKET_MAX_NUM]; // Ϲȣ
-	TPlayerItemAttribute aAttr[ITEM_ATTRIBUTE_MAX_NUM];
-#if defined(__CHANGE_LOOK_SYSTEM__)
-	DWORD dwTransmutationVnum;
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	TPlayerItemRefineElement RefineElement;
-#endif
+
 #if defined(__ITEM_APPLY_RANDOM__)
 	TPlayerItemAttribute aApplyRandom[ITEM_APPLY_MAX_NUM];
 #endif
-#if defined(__SET_ITEM__)
-	BYTE bSetValue;
-#endif
-} TPlayerItem;
+	TPlayerItemAttribute aAttr[ITEM_ATTRIBUTE_MAX_NUM];
+
+	DWORD owner;
 
-typedef struct packet_item
-{
-	DWORD dwVnum;
-	DWORD dwCount;
-	DWORD dwFlags;
-	DWORD dwAntiFlags;
 #if defined(__SOUL_BIND_SYSTEM__)
-	long lSealDate;
-#endif
-	long alSockets[ITEM_SOCKET_MAX_NUM];
-	TPlayerItemAttribute aAttr[ITEM_ATTRIBUTE_MAX_NUM];
-#if defined(__CHANGE_LOOK_SYSTEM__)
-	DWORD dwTransmutationVnum;
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	TPlayerItemRefineElement RefineElement;
-#endif
-#if defined(__ITEM_APPLY_RANDOM__)
-	TPlayerItemAttribute aApplyRandom[ITEM_APPLY_MAX_NUM];
-#endif
-#if defined(__SET_ITEM__)
-	BYTE bSetValue;
+	long soulbind;
 #endif
-	packet_item()
-	{
-		memset(&alSockets, 0, sizeof(alSockets));
-		memset(&aAttr, 0, sizeof(aAttr));
+
 #if defined(__CHANGE_LOOK_SYSTEM__)
-		dwTransmutationVnum = 0;
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-		memset(&RefineElement, 0, sizeof(RefineElement));
-#endif
-#if defined(__ITEM_APPLY_RANDOM__)
-		memset(&aApplyRandom, 0, sizeof(aApplyRandom));
+	DWORD transmutation;
 #endif
-#if defined(__SET_ITEM__)
-		bSetValue = 0;
-#endif
-	}
-} TItemData;
+
+} TPlayerItem;
 
 typedef struct SQuickslot
 {
@@ -818,14 +808,14 @@
 	time_t tNextRead;
 } TPlayerSkill;
 
-typedef struct SHorseInfo
+struct THorseInfo
 {
 	BYTE bLevel;
 	BYTE bRiding;
 	short sStamina;
 	short sHealth;
 	DWORD dwHorseHealthDropTime;
-} THorseInfo;
+};
 
 typedef struct SPlayerTable
 {
@@ -842,12 +832,12 @@
 	short st, ht, dx, iq;
 
 	DWORD exp;
-	int gold;
+	long long gold;
 #if defined(__CHEQUE_SYSTEM__)
-	int cheque;
+	INT cheque;
 #endif
 #if defined(__GEM_SYSTEM__)
-	int gem;
+	INT gem;
 #endif
 
 	BYTE dir;
@@ -857,8 +847,8 @@
 	long lExitX, lExitY;
 	long lExitMapIndex;
 
-	int hp;
-	int sp;
+	int64_t hp;
+	int64_t sp;
 
 	short sRandomHP;
 	short sRandomSP;
@@ -875,7 +865,7 @@
 	TQuickslot quickslot[QUICKSLOT_MAX_NUM];
 
 	BYTE part_base;
-	DWORD adwParts[PART_MAX_NUM];
+	WORD parts[PART_MAX_NUM];
 
 	short stamina;
 
@@ -891,6 +881,8 @@
 
 	int aiPremiumTimes[PREMIUM_MAX_NUM];
 
+	char pin[PIN_CODE_LENGTH + 1];
+
 #if defined(__CONQUEROR_LEVEL__)
 	BYTE conqueror_level;
 	BYTE conqueror_level_step;
@@ -898,87 +890,8 @@
 	DWORD conqueror_exp;
 	short conqueror_point;
 #endif
-
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	BYTE inven_stage;
-#endif
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	int battle_pass_premium_id;
-#endif
 } TPlayerTable;
 
-#ifdef __GROWTH_PET_SYSTEM__
-typedef struct SPetSkill
-{
-	bool	bLocked;
-	BYTE	bSkill;
-	BYTE	bLevel;
-	DWORD	dwCooltime;
-
-	SPetSkill()
-	{
-		bLocked = true;
-		bSkill = 0;
-		bLevel = 0;
-		dwCooltime = 0;
-	}
-} TPetSkill;
-
-typedef struct SGrowthPet
-{
-	DWORD	dwID;
-	DWORD	dwOwner;
-	DWORD	dwVnum;
-	BYTE	bState;
-	char	szName[PET_NAME_MAX_SIZE + 1];
-	BYTE	bSize;
-
-	DWORD	dwLevel;
-	BYTE	bLevelStep;
-	BYTE	bEvolution;
-	BYTE	bType;
-	DWORD	dwHP;
-	DWORD	dwSP;
-	DWORD	dwDef;
-
-	DWORD	dwHPApply;
-	DWORD	dwSPApply;
-	DWORD	dwDefApply;
-	DWORD	dwAgeApply;
-
-	TPetSkill	aSkill[PET_SKILL_COUNT_MAX];
-
-	DWORD	lExp;
-	DWORD	lItemExp;
-
-	time_t	lBirthday;
-	time_t	lEndTime;
-	time_t	lMaxTime;
-} TGrowthPet;
-
-typedef struct SGrowthPetSkillTable
-{
-	DWORD	dwPetVnum;
-	DWORD	dwSkillVnum;
-	char	szName[32 + 1];
-	BYTE	bType;
-	DWORD	dwCooldown;
-	DWORD	dwAffectFlag;
-
-	char	szPointOn[64];
-	char	szPointPoly1[100 + 1];
-	char	szPointPoly2[100 + 1];
-	char	szPointPoly3[100 + 1];
-	char	szPointPoly4[100 + 1];
-	char	szPointPoly5[100 + 1];
-	char	szPointPoly6[100 + 1];
-	char	szPointPoly7[100 + 1];
-	char	szPointPoly8[100 + 1];
-	char	szActivatePctPoly[100 + 1];
-	char	szDurationPoly[100 + 1];
-} TGrowthPetSkillTable;
-#endif
-
 typedef struct SMobSkillLevel
 {
 	DWORD dwVnum;
@@ -998,15 +911,13 @@
 	BYTE bType; // Monster, NPC
 	BYTE bRank; // PAWN, KNIGHT, KING
 	BYTE bBattleType; // MELEE, etc..
-	BYTE bLevel;
-	BYTE bScale;
+	BYTE bLevel; // Level
 	BYTE bSize;
 
 	DWORD dwGoldMin;
 	DWORD dwGoldMax;
 	DWORD dwExp;
-	DWORD dwSungMaExp;
-	DWORD dwMaxHP;
+	uint64_t dwMaxHP;
 	BYTE bRegenCycle;
 	BYTE bRegenPercent;
 	WORD wDef;
@@ -1016,20 +927,19 @@
 	DWORD dwImmuneFlag;
 
 	BYTE bStr, bDex, bCon, bInt;
-	BYTE bSungMaStr, bSungMaDex, bSungMaCon, bSungMaInt;
 	DWORD dwDamageRange[2];
 
 	short sAttackSpeed;
 	short sMovingSpeed;
-
-	BYTE bAggressiveHPPct;
+	BYTE bAggresiveHPPct;
 	WORD wAggressiveSight;
 	WORD wAttackRange;
 
 	char cEnchants[MOB_ENCHANTS_MAX_NUM];
 	char cResists[MOB_RESISTS_MAX_NUM];
+#if defined(__ELEMENT_SYSTEM__)
 	char cElements[MOB_ELEMENT_MAX_NUM];
-	char cResistDark, cResistIce, cResistEarth;
+#endif
 
 	DWORD dwResurrectionVnum;
 	DWORD dwDropItemVnum;
@@ -1038,7 +948,7 @@
 	BYTE bOnClickType;
 
 	BYTE bEmpire;
-	char szFolder[CHARACTER_FOLDER_MAX_LEN + 1];
+	char szFolder[64 + 1];
 
 	float fDamMultiply;
 
@@ -1054,15 +964,6 @@
 	BYTE bGodSpeedPoint;
 	BYTE bDeathBlowPoint;
 	BYTE bRevivePoint;
-
-	BYTE bHealPoint;
-
-	BYTE bRAttSpeedPoint;
-	BYTE bRCastSpeedPoint;
-
-	BYTE bRHPRegenPoint;
-
-	float fHitRange;
 } TMobTable;
 
 typedef struct SSkillTable
@@ -1112,21 +1013,23 @@
 typedef struct SShopItemTable
 {
 	DWORD vnum;
-	DWORD count;
+	WORD count;
 
 	TItemPos pos; // PC  ̿
 	DWORD price; // PC, shop_table_ex.txt  ̿
 #if defined(__CHEQUE_SYSTEM__)
-	DWORD cheque;
+	DWORD price_cheque;
 #endif
 	BYTE display_pos; // PC, shop_table_ex.txt  ̿,  ġ.
 #if defined(__SHOPEX_RENEWAL__)
-	BYTE bPriceType;
-	DWORD dwPriceVnum;
 	long alSockets[ITEM_SOCKET_MAX_NUM];
-	SShopItemTable() : bPriceType(SHOP_COIN_TYPE_GOLD), dwPriceVnum(0)
+	TPlayerItemAttribute aAttr[ITEM_ATTRIBUTE_MAX_NUM];
+	DWORD price_type;
+	DWORD price_vnum;
+	SShopItemTable() : price_type(1), price_vnum(0)
 	{
 		memset(&alSockets, 0, sizeof(alSockets));
+		memset(&aAttr, 0, sizeof(aAttr));
 	}
 #endif
 } TShopItemTable;
@@ -1135,12 +1038,8 @@
 {
 	DWORD dwVnum;
 	DWORD dwNPCVnum;
-	BYTE bItemCount;
-#if defined(__MYSHOP_EXPANSION__)
-	TShopItemTable items[SHOP_HOST_ITEM_MAX];
-#else
+	WORD wItemCount;
 	TShopItemTable items[SHOP_HOST_ITEM_MAX_NUM];
-#endif
 } TShopTable;
 
 #define QUEST_NAME_MAX_LEN 50 // 32
@@ -1162,8 +1061,8 @@
 
 typedef struct SItemApply
 {
-	POINT_TYPE wType;
-	POINT_VALUE lValue;
+	BYTE bType;
+	long lValue;
 } TItemApply;
 
 typedef struct SItemTable : public SEntityTable
@@ -1182,8 +1081,8 @@
 	DWORD dwWearFlags;
 	DWORD dwImmuneFlag;
 
+	DWORD dwGold;
 	DWORD dwShopBuyPrice;
-	DWORD dwShopSellPrice;
 
 	TItemLimit aLimits[ITEM_LIMIT_MAX_NUM];
 	TItemApply aApplies[ITEM_APPLY_MAX_NUM];
@@ -1191,7 +1090,6 @@
 	long alSockets[ITEM_SOCKET_MAX_NUM];
 	DWORD dwRefinedVnum;
 	WORD wRefineSet;
-	DWORD dw67AttrMaterial;
 	BYTE bAlterToMagicItemPct;
 	BYTE bSpecular;
 	BYTE bGainSocketPct;
@@ -1204,7 +1102,6 @@
 	char cLimitTimerBasedOnWearIndex; //  limit ʵ尪 ߿ LIMIT_TIMER_BASED_ON_WEAR ÷ ġ ( -1)
 
 	char* GetOriginalName() { return szName; }
-	DWORD GetVNum() { return dwVnum; }
 	char* GetName() { return szLocaleName; }
 
 	BYTE GetType() { return bType; }
@@ -1216,8 +1113,8 @@
 	DWORD GetWearFlags() { return dwWearFlags; }
 	DWORD GetImmuneFlags() { return dwImmuneFlag; }
 
-	DWORD GetBuyPrice() { return dwShopBuyPrice; }
-	DWORD GetSellPrice() { return dwShopSellPrice; }
+	unsigned long long GetBuyPrice() { return dwGold; }
+	unsigned long long GetSellPrice() { return dwShopBuyPrice; }
 
 	long GetValue(unsigned int index)
 	{
@@ -1268,45 +1165,33 @@
 #if defined(__WEAPON_COSTUME_SYSTEM__)
 	bool IsCostumeWeapon() { return GetType() == ITEM_COSTUME && GetSubType() == COSTUME_WEAPON; }
 #endif
-#if defined(__MOVE_COSTUME_ATTR__)
 	bool IsCostumeModifyItem() { return GetType() == ITEM_USE && (GetSubType() == USE_CHANGE_COSTUME_ATTR || GetSubType() == USE_RESET_COSTUME_ATTR); }
+
+#if defined(__SOUL_SYSTEM__)
+	// Soul
+	bool IsSoul() { return GetType() == ITEM_SOUL; }
+	bool IsRedSoul() { return GetType() == ITEM_SOUL && GetSubType() == RED_SOUL; }
+	bool IsBlueSoul() { return GetType() == ITEM_SOUL && GetSubType() == BLUE_SOUL; }
 #endif
 
-	bool CanUseByJob(BYTE bJob)
+	long GetApplyValue(unsigned int i)
 	{
-		switch (bJob)
-		{
-		case JOB_WARRIOR:
-			if (GetAntiFlags() & ITEM_ANTIFLAG_WARRIOR)
-				return false;
-			break;
-		case JOB_ASSASSIN:
-			if (GetAntiFlags() & ITEM_ANTIFLAG_ASSASSIN)
-				return false;
-			break;
-		case JOB_SHAMAN:
-			if (GetAntiFlags() & ITEM_ANTIFLAG_SHAMAN)
-				return false;
-			break;
-		case JOB_SURA:
-			if (GetAntiFlags() & ITEM_ANTIFLAG_SURA)
-				return false;
-			break;
-		case JOB_WOLFMAN:
-			if (GetAntiFlags() & ITEM_ANTIFLAG_WOLFMAN)
-				return false;
-			break;
-		}
-		return true;
+		return aApplies[i].lValue;
+	}
+
+	long GetApplyType(unsigned int i)
+	{
+		return aApplies[i].bType;
 	}
 
-	POINT_VALUE FindApplyValue(POINT_TYPE dwType)
+	long FindApplyValue(unsigned int applyType)
 	{
-		for (BYTE bIndex = 0; bIndex < ITEM_APPLY_MAX_NUM; ++bIndex)
+		for (int i = 0; i < ITEM_APPLY_MAX_NUM; ++i)
 		{
-			if (aApplies[bIndex].wType == dwType)
-				return aApplies[bIndex].lValue;
+			if (aApplies[i].bType == applyType)
+				return aApplies[i].lValue;
 		}
+
 		return 0;
 	}
 
@@ -1315,7 +1200,7 @@
 struct TItemAttrTable
 {
 	TItemAttrTable() :
-		wApplyIndex(0),
+		dwApplyIndex(0),
 		dwProb(0)
 	{
 		szApply[0] = 0;
@@ -1324,9 +1209,9 @@
 	}
 
 	char szApply[APPLY_NAME_MAX_LEN + 1];
-	POINT_TYPE wApplyIndex;
+	DWORD dwApplyIndex;
 	DWORD dwProb;
-	POINT_VALUE lValues[ITEM_ATTRIBUTE_MAX_LEVEL];
+	long lValues[5];
 	BYTE bMaxLevelBySet[ATTRIBUTE_SET_MAX_NUM];
 };
 
@@ -1367,14 +1252,6 @@
 	char private_code[8];
 } TPlayerDeletePacket;
 
-#if defined(__DELETE_FAILURE_TYPE__)
-typedef struct SPlayerDeleteFailurePacket
-{
-	BYTE bType;
-	INT iTime;
-} TPlayerDeleteFailurePacket;
-#endif
-
 typedef struct SLogoutPacket
 {
 	char login[LOGIN_MAX_LEN + 1];
@@ -1386,11 +1263,7 @@
 	DWORD dwCount;
 } TPlayerCountPacket;
 
-#if defined(__EXTEND_MALLBOX__)
-#	define SAFEBOX_MAX_NUM 225 // 45 (Slots) * 5 (Pages)
-#else
-#	define SAFEBOX_MAX_NUM 135 // 45 (Slots) * 3 (Pages)
-#endif
+#define SAFEBOX_MAX_NUM 135
 #define SAFEBOX_PASSWORD_MAX_LEN 6
 
 typedef struct SSafeboxTable
@@ -1507,15 +1380,11 @@
 typedef struct TPacketAffectElement
 {
 	DWORD dwType;
-	POINT_TYPE wApplyOn;
-	POINT_VALUE lApplyValue;
+	BYTE bApplyOn;
+	long lApplyValue;
 	DWORD dwFlag;
 	long lDuration;
 	long lSPCost;
-#if defined(__AFFECT_RENEWAL__)
-	bool bRealTime;
-	bool bUpdate;
-#endif
 } TPacketAffectElement;
 
 typedef struct SPacketGDAddAffect
@@ -1528,7 +1397,7 @@
 {
 	DWORD dwPID;
 	DWORD dwType;
-	POINT_TYPE wApplyOn;
+	BYTE bApplyOn;
 } TPacketGDRemoveAffect;
 
 typedef struct SPacketGDHighscore
@@ -1705,9 +1574,8 @@
 	char szSocialID[SOCIAL_ID_MAX_LEN + 1];
 	DWORD adwClientKey[4];
 	int iPremiumTimes[PREMIUM_MAX_NUM];
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-	char szCountry[COUNTRY_NAME_MAX_LEN + 1];
-#endif
+	char szHWID[HWID_MAX_NUM + 1];
+	BYTE bLanguage;
 } TPacketGDAuthLogin;
 
 typedef struct SPacketGDLoginByKey
@@ -1790,9 +1658,6 @@
 	BYTE type;
 	DWORD vnum;
 	int gold;
-#if defined(__CHEQUE_SYSTEM__)
-	int cheque;
-#endif
 } TPacketMoneyLog;
 
 typedef struct SPacketGDGuildMoney
@@ -1834,9 +1699,8 @@
 	char szHost[MAX_HOST_LENGTH + 1];
 	DWORD dwLoginKey;
 	DWORD adwClientKey[4];
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-	char szCountry[COUNTRY_NAME_MAX_LEN + 1];
-#endif
+	char szHWID[HWID_MAX_NUM + 1];
+	BYTE bLanguage;
 } TPacketLoginOnSetup;
 
 typedef struct SPacketGDCreateObject
@@ -1943,7 +1807,7 @@
 	DWORD dwVnum; ///<  vnum
 	DWORD dwPrice; ///< 
 #if defined(__CHEQUE_SYSTEM__)
-	DWORD dwCheque;
+	DWORD dwPriceCheque;
 #endif
 } TItemPriceInfo;
 
@@ -2082,6 +1946,7 @@
 typedef struct tNeedLoginLogInfo
 {
 	DWORD dwPlayerID;
+	BYTE bLanguage;
 } TPacketNeedLoginLogInfo;
 
 //   ˸  ׽Ʈ Ŷ 
@@ -2102,6 +1967,9 @@
 {
 	short nPort;
 	BYTE bStatus;
+#if defined(__CHANNEL_STATUS_UPDATE__)
+	int iCount;
+#endif
 } TChannelStatus;
 
 #if defined(__MESSENGER_BLOCK_SYSTEM__)
@@ -2112,6 +1980,46 @@
 };
 #endif
 
+#if defined(__GUILD_DRAGONLAIR_PARTY_SYSTEM__)
+typedef struct SPacketGDGuildDungeon
+{
+	DWORD dwGuildID;
+	BYTE bChannel;
+	long lMapIndex;
+} TPacketGDGuildDungeon;
+
+typedef struct SPacketDGGuildDungeon
+{
+	DWORD dwGuildID;
+	BYTE bChannel;
+	long lMapIndex;
+} TPacketDGGuildDungeon;
+
+typedef struct SPacketGDGuildDungeonCD
+{
+	DWORD dwGuildID;
+	DWORD dwTime;
+} TPacketGDGuildDungeonCD;
+
+typedef struct SPacketDGGuildDungeonCD
+{
+	DWORD dwGuildID;
+	DWORD dwTime;
+} TPacketDGGuildDungeonCD;
+
+typedef struct SPacketGDGuildDungeonST
+{
+	DWORD dwGuildID;
+	DWORD dwDungeon_start;
+} TPacketGDGuildDungeonST;
+
+typedef struct SPacketDGGuildDungeonST
+{
+	DWORD dwGuildID;
+	DWORD dwDungeon_start;
+} TPacketDGGuildDungeonST;
+#endif
+
 #if defined(__MOVE_CHANNEL__)
 typedef struct
 {
@@ -2126,6 +2034,36 @@
 } TPacketReturnChannel;
 #endif
 
+#if defined(__SKILL_COLOR_SYSTEM__)
+typedef struct
+{
+	DWORD dwPlayerID;
+	DWORD dwSkillColor[ESkillColorLength::MAX_SKILL_COUNT + ESkillColorLength::MAX_BUFF_COUNT][ESkillColorLength::MAX_EFFECT_COUNT];
+} TSkillColor;
+#endif
+
+typedef struct SRequestChangeLanguage
+{
+	DWORD dwAID;
+	BYTE bLanguage;
+} TRequestChangeLanguage;
+
+typedef struct SRequestChangePin
+{
+	char pinCode[PIN_CODE_LENGTH + 1];
+} TRequestChangePin;
+
+#if defined(__SHOPEX_RENEWAL__)
+enum STableExTypes : decltype(TShopItemTable::price_type)
+{
+	EX_GOLD = 1,
+		EX_SECONDARY,
+		EX_ITEM,
+		EX_EXP,
+		EX_MAX
+};
+#endif
+
 #if defined(__MAILBOX__)
 enum EMAILBOX
 {
@@ -2167,22 +2105,14 @@
 	char szMessage[100 + 1];
 	int iYang;
 	int iWon;
-	DWORD dwItemVnum;
-	DWORD dwItemCount;
+	DWORD ItemVnum;
+	DWORD ChangeLookVnum;
+	DWORD ItemCount;
 	long alSockets[ITEM_SOCKET_MAX_NUM];
-	TPlayerItemAttribute aAttr[ITEM_ATTRIBUTE_MAX_NUM];
-#if defined(__CHANGE_LOOK_SYSTEM__)
-	DWORD dwChangeLookVnum;
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	TPlayerItemRefineElement RefineElement;
-#endif
 #if defined(__ITEM_APPLY_RANDOM__)
 	TPlayerItemAttribute aApplyRandom[ITEM_APPLY_MAX_NUM];
 #endif
-#if defined(__SET_ITEM__)
-	BYTE bSetValue;
-#endif
+	TPlayerItemAttribute aAttr[ITEM_ATTRIBUTE_MAX_NUM];
 } TPacketGCMailBoxAddData;
 
 typedef struct packet_mailbox_message
@@ -2204,289 +2134,6 @@
 } TMailBoxTable;
 #endif
 
-#if defined(__RANKING_SYSTEM__)
-typedef struct SPartyMemberName
-{
-	char szName[CHARACTER_NAME_MAX_LEN + 1];
-} TPartyMember;
-
-typedef struct SRankingData
-{
-	char szGuildName[GUILD_NAME_MAX_LEN + 1];
-	SPartyMemberName Member[PARTY_MAX_MEMBER];
-	DWORD dwRecord0, dwRecord1;
-	DWORD dwStartTime;
-	BYTE bEmpire;
-} TRankingData;
-#endif
-
-#if defined(__ATTR_6TH_7TH__)
-typedef struct SAttr67AddData
-{
-	SAttr67AddData() : wRegistItemPos(0), byMaterialCount(0), wSupportItemPos(0), bySupportItemCount(0) {}
-	WORD wRegistItemPos;
-	BYTE byMaterialCount;
-	WORD wSupportItemPos;
-	BYTE bySupportItemCount;
-} TAttr67AddData;
-#endif
-
-#if defined(__GEM_SHOP__)
-typedef struct SGemShopLoad
-{
-	DWORD dwPID;
-#	if defined(__CONQUEROR_LEVEL__)
-	bool bSpecial;
-#	endif
-} TGemShopLoad;
-
-typedef struct SGemShopItem
-{
-	bool bEnable;
-	DWORD dwItemVnum;
-	BYTE bCount;
-	DWORD dwPrice;
-} TGemShopItem;
-
-typedef struct SGemShopTable
-{
-	DWORD dwPID;
-	long lRefreshTime;
-	BYTE bEnabledSlots;
-	TGemShopItem GemShopItem[GEM_SHOP_SLOT_COUNT];
-#	if defined(__CONQUEROR_LEVEL__)
-	bool bSpecial;
-#	endif
-} TGemShopTable;
-#endif
-
-#if defined(__EXPRESSING_EMOTIONS__)
-typedef struct SPacketGDEmote
-{
-	DWORD dwPID;
-	DWORD dwVnum;
-	DWORD dwDuration;
-} TPacketGDEmote;
-#endif
-
-#if defined(__GUILD_EVENT_FLAG__) //&& defined(__GUILD_RENEWAL__)
-typedef struct SPacketSetGuildEventFlag
-{
-	DWORD dwGuildID;
-	char szFlagName[EVENT_FLAG_NAME_MAX_LEN + 1];
-	long lValue;
-} TPacketSetGuildEventFlag;
-#endif
-
-#ifdef __OFFLINE_SHOP__
-typedef struct SOfflineShop
-{
-	uint32_t id;
-
-	uint32_t ownerPid;
-	std::array<char, CHARACTER_NAME_MAX_LEN + 1> ownerName;
-
-	std::array<char, SHOP_TAB_NAME_MAX + 1> shopName;
-	int32_t shopNameChangeTime;
-	uint8_t channel;
-	uint32_t mapIndex, x, y;
-	uint32_t decoRace;
-	uint8_t decoBoard;
-
-	uint32_t openingTime;
-	int64_t gold;
-} TOfflineShop;
-
-typedef std::pair<uint32_t, uint16_t> TOfflineItemID;
-namespace std {
-	template <> struct hash <TOfflineItemID> {
-		inline size_t operator()(const TOfflineItemID& v) const {
-			std::hash<int> int_hasher;
-			return int_hasher(v.first) ^ int_hasher(v.second);
-		}
-	};
-}
-
-typedef struct SOfflineShopItem
-{
-	TOfflineItemID id;
-
-	uint32_t vnum;
-	uint32_t count;
-	std::array<int32_t, ITEM_SOCKET_MAX_NUM> sockets;
-	std::array<TPlayerItemAttribute, ITEM_ATTRIBUTE_MAX_NUM> attributes;
-#if defined(__ITEM_APPLY_RANDOM__)
-	std::array<TPlayerItemAttribute, ITEM_APPLY_MAX_NUM> ApplyRandom;
-#endif
-	int64_t price;
-#if defined(__SOUL_BIND_SYSTEM__)
-	long soulbind;
-#endif
-#if defined(__CHANGE_LOOK_SYSTEM__)
-	DWORD dwTransmutationVnum;
-#endif
-} TOfflineShopItem;
-
-typedef struct SMySellHistory
-{
-	DWORD		pid;
-	DWORD		dwVnum;
-	DWORD		dwCount;
-#if defined(__CHANGE_LOOK_SYSTEM__)
-	DWORD 		dwTransmutationVnum;
-#endif
-	long 		alSockets[ITEM_SOCKET_MAX_NUM];
-	TPlayerItemAttribute aAttr[ITEM_ATTRIBUTE_MAX_NUM];
-#if defined(__ITEM_APPLY_RANDOM__)
-	TPlayerItemAttribute aApplyRandom[ITEM_APPLY_MAX_NUM];
-#endif
-	char		szBuyer[CHARACTER_NAME_MAX_LEN+1];
-	long long 	llPrice;
-	int			iTimeStamp;
-	bool		bIsSaved;
-} TMySellHistory;
-
-typedef std::pair<DWORD, DWORD> TShopSearchItemType;
-
-enum EShopSearchData
-{
-	SHOPSEARCH_SOLD_ITEM_INFO_COUNT = 30,
-};
-
-enum EShopSearchBuyResult {
-	SHOPSEARCH_BUY_SUCCESS,
-	SHOPSEARCH_BUY_NOT_EXIST,
-	SHOPSEARCH_BUY_PRICE_CHANGE,
-	SHOPSEARCH_BUY_TIMEOUT,
-	SHOPSEARCH_BUY_NO_PEER,
-	SHOPSEARCH_BUY_UNKNOWN_ERROR,
-};
-
-enum EShopSearchSortTypes {
-	SHOPSEARCH_SORT_RANDOM,
-	SHOPSEARCH_SORT_ASC,
-	SHOPSEARCH_SORT_DESC,
-	SHOPSEARCH_SORT_MAX_NUM,
-};
-
-enum EShopSearchAveragePriceLevels {
-	SHOPSEARCH_AVG_PRICE_GOOD,
-	SHOPSEARCH_AVG_PRICE_NORMAL,
-	SHOPSEARCH_AVG_PRICE_BAD,
-	SHOPSEARCH_AVG_PRICE_WORST,
-};
-
-typedef struct SShopSearchItem : TPlayerItem
-{
-	TOfflineItemID offlineID;
-
-	int64_t price;
-	DWORD endTime;
-} TShopSearchItem;
-
-typedef struct SShopSearchClientItem : SShopSearchItem
-{
-	BYTE	avgPriceLevel;
-} TShopSearchClientItem;
-
-typedef struct SShopSearchOptions
-{
-	BYTE		typeFlagCount;
-	BYTE		specificVnumCount;
-} TShopSearchOptions;
-
-typedef struct SPacketGDShopSearchByName
-{
-	BYTE	langID;
-	char	itemName[ITEM_NAME_MAX_LEN + 1];
-	WORD	page;
-	BYTE	entryCountIdx;
-	BYTE	sortType;
-} TPacketGDShopSearchByName;
-
-typedef struct SPacketGDShopSearchByOptions
-{
-	TShopSearchOptions	options;
-	WORD				page;
-	BYTE				entryCountIdx;
-	BYTE				sortType;
-} TPacketGDShopSearchByOptions;
-
-typedef struct SPacketGDShopSearchRequestBuy
-{
-	DWORD	ownerID;
-	TOfflineItemID	offlineID;
-	DWORD	itemVnum;
-	int64_t	itemPrice;
-	char	szBuyer[CHARACTER_NAME_MAX_LEN+1];
-} TPacketGDShopSearchRequestBuy;
-
-typedef struct SPacketDGShopSearchBuyFromShop
-{
-	DWORD	buyerDBHandle;
-	DWORD	buyerPCHandle;
-	DWORD	buyerPID;
-	DWORD	ownerPID;
-	TOfflineItemID	offlineID;
-	int64_t	itemPrice;
-	char	szBuyer[CHARACTER_NAME_MAX_LEN+1];
-} TPacketDGShopSearchBuyFromShop;
-
-typedef struct SPacketGDShopSearchBoughtFromShop
-{
-	DWORD	buyerDBHandle;
-	TPlayerItem	item;
-} TPacketGDShopSearchBoughtFromShop;
-
-typedef struct SPacketGDShopSearchSoldItem
-{
-	DWORD	itemVnum;
-	DWORD	itemCount;
-	uint64_t	price;
-} TPacketGDShopSearchSoldItem;
-
-typedef struct SShopSearchSoldItemInfo {
-	SShopSearchSoldItemInfo() : count(0), averagePrice(0) { }
-
-	uint64_t	count;
-	double		averagePrice;
-} TShopSearchSoldItemInfo;
-#endif
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-typedef struct SPlayerExtBattlePassMission
-{
-	DWORD dwPlayerId;
-	DWORD dwBattlePassType;
-	DWORD dwMissionIndex;
-	DWORD dwMissionType;
-	DWORD dwBattlePassId;
-	DWORD dwExtraInfo;
-	BYTE bCompleted;
-	BYTE bIsUpdated;
-} TPlayerExtBattlePassMission;
-
-typedef struct SExtBattlePassRewardItem
-{
-	DWORD dwVnum;
-	BYTE bCount;
-} TExtBattlePassRewardItem;
-
-typedef struct SExtBattlePassMissionInfo
-{
-	BYTE bMissionIndex;
-	BYTE bMissionType;
-	DWORD dwMissionInfo[3];
-	TExtBattlePassRewardItem aRewardList[3];
-} TExtBattlePassMissionInfo;
-
-typedef struct SExtBattlePassTimeTable
-{
-	BYTE	bBattlePassId;
-	DWORD	dwStartTime;
-	DWORD	dwEndTime;
-} TExtBattlePassTimeTable;
-#endif
-
 #pragma pack()
+
 #endif // __INC_COMMON_TABLES_H__
diff -ruN baseline/server/server/home/metin2/Source/Server/db/src/Cache.cpp final/server/server/home/metin2/Source/Server/db/src/Cache.cpp
--- baseline/server/server/home/metin2/Source/Server/db/src/Cache.cpp	2025-06-28 20:12:20.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/db/src/Cache.cpp	2022-04-27 09:34:47.000000000 +0000
@@ -5,8 +5,6 @@
 #include "ClientManager.h"
 #include "Main.h"
 
-#include <sstream>
-
 extern CPacketInfo g_item_info;
 extern int g_iPlayerCacheFlushSeconds;
 extern int g_iItemCacheFlushSeconds;
@@ -17,11 +15,6 @@
 
 extern int g_item_count;
 
-#ifdef __OFFLINE_SHOP__
-extern uint32_t g_offlineShopCacheFlushSeconds;
-extern uint32_t g_offlineShopItemCacheFlushSeconds;
-#endif
-
 CItemCache::CItemCache()
 {
 	m_expireTime = MIN(1800, g_iItemCacheFlushSeconds);
@@ -41,44 +34,42 @@
 // by rtsummit
 void CItemCache::Delete()
 {
-	if (m_data.dwVnum == 0)
+	if (m_data.vnum == 0)
 		return;
 
-	//char szQuery[QUERY_MAX_LEN];
-	//szQuery[QUERY_MAX_LEN] = '\0';
+	// char szQuery[QUERY_MAX_LEN];
+	// szQuery[QUERY_MAX_LEN] = '\0';
 	if (g_test_server)
-		sys_log(0, "ItemCache::Delete : DELETE %u", m_data.dwID);
+		sys_log(0, "ItemCache::Delete : DELETE %u", m_data.id);
 
-	m_data.dwVnum = 0;
+	m_data.vnum = 0;
 	m_bNeedQuery = true;
 	m_lastUpdateTime = time(0);
 	OnFlush();
 
-	//m_bNeedQuery = false;
-	//m_lastUpdateTime = time(0) - m_expireTime;
+	// m_bNeedQuery = false;
+	// m_lastUpdateTime = time(0) - m_expireTime;
 }
 
 void CItemCache::OnFlush()
 {
-	if (m_data.dwVnum == 0) // vnum  0̸ ϶ ǥõ ̴.
+	if (m_data.vnum == 0) // vnum  0̸ ϶ ǥõ ̴.
 	{
 		char szQuery[QUERY_MAX_LEN];
-		snprintf(szQuery, sizeof(szQuery), "DELETE FROM item%s WHERE `id` = %u", GetTablePostfix(), m_data.dwID);
+		snprintf(szQuery, sizeof(szQuery), "DELETE FROM item%s WHERE `id` = %u", GetTablePostfix(), m_data.id);
 		CDBManager::instance().ReturnQuery(szQuery, QID_ITEM_DESTROY, 0, NULL);
 
 		if (g_test_server)
-			sys_log(0, "ItemCache::Flush : DELETE %u %s", m_data.dwID, szQuery);
+			sys_log(0, "ItemCache::Flush : DELETE %u %s", m_data.id, szQuery);
 	}
 	else
 	{
 		long alSockets[ITEM_SOCKET_MAX_NUM];
 		TPlayerItemAttribute aAttr[ITEM_ATTRIBUTE_MAX_NUM];
-
 #if defined(__ITEM_APPLY_RANDOM__)
 		TPlayerItemAttribute aApplyRandom[ITEM_APPLY_MAX_NUM];
 		bool isApplyRandom = false;
 #endif
-
 		bool isSocket = false, isAttr = false;
 
 		memset(&alSockets, 0, sizeof(long) * ITEM_SOCKET_MAX_NUM);
@@ -104,21 +95,49 @@
 		char szValues[QUERY_MAX_LEN];
 		char szUpdate[QUERY_MAX_LEN];
 
-		int iLen = snprintf(szColumns, sizeof(szColumns), "`id`, `owner_id`, `window`, `pos`, `vnum`, `count`");
-		int iValueLen = snprintf(szValues, sizeof(szValues),
-			"%u, %u, %u, %u, %u, %u"
-			, p->dwID, p->dwOwner, p->bWindow, p->wPos, p->dwVnum, p->dwCount
+		int iLen = snprintf(szColumns, sizeof(szColumns),
+			"`id`, `owner_id`, `window`, `pos`, `count`, `vnum`"
+#if defined(__SOUL_BIND_SYSTEM__)
+			", `soulbind`"
+#endif
+#if defined(__CHANGE_LOOK_SYSTEM__)
+			", `transmutation`"
+#endif
 		);
-		int iUpdateLen = snprintf(szUpdate, sizeof(szUpdate),
-			"`owner_id` = %u, `window` = %u, `pos` = %u, `vnum` = %u, `count` = %u"
-			, p->dwOwner, p->bWindow, p->wPos, p->dwCount, p->dwVnum
+
+		int iValueLen = snprintf(szValues, sizeof(szValues),
+			"%u, %u, %d, %d, %u, %u"
+#if defined(__SOUL_BIND_SYSTEM__)
+			", %ld"
+#endif
+#if defined(__CHANGE_LOOK_SYSTEM__)
+			", %u"
+#endif
+			, p->id, p->owner, p->window, p->pos, p->count, p->vnum
+#if defined(__SOUL_BIND_SYSTEM__)
+			, p->soulbind
+#endif
+#if defined(__CHANGE_LOOK_SYSTEM__)
+			, p->transmutation
+#endif
 		);
 
+		int iUpdateLen = snprintf(szUpdate, sizeof(szUpdate),
+			"`owner_id` = %u, `window` = %d, `pos` = %d, `count` = %u, `vnum` = %u"
 #if defined(__SOUL_BIND_SYSTEM__)
-		iLen += snprintf(szColumns + iLen, sizeof(szColumns) - iLen, ", `soulbind`");
-		iValueLen += snprintf(szValues + iValueLen, sizeof(szValues) - iValueLen, ", %ld", p->lSealDate);
-		iUpdateLen += snprintf(szUpdate + iUpdateLen, sizeof(szUpdate) - iUpdateLen, ", `soulbind` = %ld", p->lSealDate);
+			", `soulbind` = %ld"
 #endif
+#if defined(__CHANGE_LOOK_SYSTEM__)
+			", `transmutation` = %u"
+#endif
+			, p->owner, p->window, p->pos, p->count, p->vnum
+#if defined(__SOUL_BIND_SYSTEM__)
+			, p->soulbind
+#endif
+#if defined(__CHANGE_LOOK_SYSTEM__)
+			, p->transmutation
+#endif
+		);
 
 		if (isSocket)
 		{
@@ -126,171 +145,130 @@
 				", `socket0`"
 				", `socket1`"
 				", `socket2`"
-#if defined(__ITEM_SOCKET6__)
+#if defined(__ITEM_SOCKET5__)
 				", `socket3`"
 				", `socket4`"
-				", `socket5`"
+				//", `socket5`"
 #endif
 			);
 			iValueLen += snprintf(szValues + iValueLen, sizeof(szValues) - iValueLen,
 				", %lu"
 				", %lu"
 				", %lu"
-#if defined(__ITEM_SOCKET6__)
-				", %lu"
+#if defined(__ITEM_SOCKET5__)
 				", %lu"
 				", %lu"
+				//", %lu"
 #endif
 				, p->alSockets[0]
 				, p->alSockets[1]
 				, p->alSockets[2]
-#if defined(__ITEM_SOCKET6__)
+#if defined(__ITEM_SOCKET5__)
 				, p->alSockets[3]
 				, p->alSockets[4]
-				, p->alSockets[5]
+				//, p->alSockets[5]
 #endif
 			);
 			iUpdateLen += snprintf(szUpdate + iUpdateLen, sizeof(szUpdate) - iUpdateLen,
 				", `socket0` = %lu"
 				", `socket1` = %lu"
 				", `socket2` = %lu"
-#if defined(__ITEM_SOCKET6__)
+#if defined(__ITEM_SOCKET5__)
 				", `socket3` = %lu"
 				", `socket4` = %lu"
-				", `socket5` = %lu"
+				//", `socket5` = %lu"
 #endif
 				, p->alSockets[0]
 				, p->alSockets[1]
 				, p->alSockets[2]
-#if defined(__ITEM_SOCKET6__)
+#if defined(__ITEM_SOCKET5__)
 				, p->alSockets[3]
 				, p->alSockets[4]
-				, p->alSockets[5]
+				//, p->alSockets[5]
 #endif
 			);
 		}
 
-		if (isAttr)
+#if defined(__ITEM_APPLY_RANDOM__)
+		if (isApplyRandom)
 		{
 			iLen += snprintf(szColumns + iLen, sizeof(szColumns) - iLen,
-				", `attrtype0`, `attrvalue0`"
-				", `attrtype1`, `attrvalue1`"
-				", `attrtype2`, `attrvalue2`"
-				", `attrtype3`, `attrvalue3`"
-				", `attrtype4`, `attrvalue4`"
-				", `attrtype5`, `attrvalue5`"
-				", `attrtype6`, `attrvalue6`"
+				", `apply_type0`, `apply_value0`, `apply_path0`"
+				", `apply_type1`, `apply_value1`, `apply_path1`"
+				", `apply_type2`, `apply_value2`, `apply_path2`"
+				", `apply_type3`, `apply_value3`, `apply_path3`"
 			);
 
 			iValueLen += snprintf(szValues + iValueLen, sizeof(szValues) - iValueLen,
-				", %u, %ld"
-				", %u, %ld"
-				", %u, %ld"
-				", %u, %ld"
-				", %u, %ld"
-				", %u, %ld"
-				", %u, %ld"
-				, p->aAttr[0].wType, p->aAttr[0].lValue
-				, p->aAttr[1].wType, p->aAttr[1].lValue
-				, p->aAttr[2].wType, p->aAttr[2].lValue
-				, p->aAttr[3].wType, p->aAttr[3].lValue
-				, p->aAttr[4].wType, p->aAttr[4].lValue
-				, p->aAttr[5].wType, p->aAttr[5].lValue
-				, p->aAttr[6].wType, p->aAttr[6].lValue
+				", %d, %d, %d"
+				", %d, %d, %d"
+				", %d, %d, %d"
+				", %d, %d, %d"
+				, p->aApplyRandom[0].bType, p->aApplyRandom[0].sValue, p->aApplyRandom[0].bPath
+				, p->aApplyRandom[1].bType, p->aApplyRandom[1].sValue, p->aApplyRandom[1].bPath
+				, p->aApplyRandom[2].bType, p->aApplyRandom[2].sValue, p->aApplyRandom[2].bPath
+				, p->aApplyRandom[3].bType, p->aApplyRandom[3].sValue, p->aApplyRandom[3].bPath
 			);
 
 			iUpdateLen += snprintf(szUpdate + iUpdateLen, sizeof(szUpdate) - iUpdateLen,
-				", `attrtype0` = %u, `attrvalue0` = %ld"
-				", `attrtype1` = %u, `attrvalue1` = %ld"
-				", `attrtype2` = %u, `attrvalue2` = %ld"
-				", `attrtype3` = %u, `attrvalue3` = %ld"
-				", `attrtype4` = %u, `attrvalue4` = %ld"
-				", `attrtype5` = %u, `attrvalue5` = %ld"
-				", `attrtype6` = %u, `attrvalue6` = %ld"
-				, p->aAttr[0].wType, p->aAttr[0].lValue
-				, p->aAttr[1].wType, p->aAttr[1].lValue
-				, p->aAttr[2].wType, p->aAttr[2].lValue
-				, p->aAttr[3].wType, p->aAttr[3].lValue
-				, p->aAttr[4].wType, p->aAttr[4].lValue
-				, p->aAttr[5].wType, p->aAttr[5].lValue
-				, p->aAttr[6].wType, p->aAttr[6].lValue
+				", `apply_type0` = %d, `apply_value0` = %d, `apply_path0` = %d"
+				", `apply_type1` = %d, `apply_value1` = %d, `apply_path1` = %d"
+				", `apply_type2` = %d, `apply_value2` = %d, `apply_path2` = %d"
+				", `apply_type3` = %d, `apply_value3` = %d, `apply_path3` = %d"
+				, p->aApplyRandom[0].bType, p->aApplyRandom[0].sValue, p->aApplyRandom[3].bPath
+				, p->aApplyRandom[1].bType, p->aApplyRandom[1].sValue, p->aApplyRandom[3].bPath
+				, p->aApplyRandom[2].bType, p->aApplyRandom[2].sValue, p->aApplyRandom[3].bPath
+				, p->aApplyRandom[3].bType, p->aApplyRandom[3].sValue, p->aApplyRandom[3].bPath
 			);
 		}
-
-#if defined(__CHANGE_LOOK_SYSTEM__)
-		iLen += snprintf(szColumns + iLen, sizeof(szColumns) - iLen, ", `transmutation`");
-		iValueLen += snprintf(szValues + iValueLen, sizeof(szValues) - iValueLen, ", %u", p->dwTransmutationVnum);
-		iUpdateLen += snprintf(szUpdate + iUpdateLen, sizeof(szUpdate) - iUpdateLen, ", `transmutation` = %u", p->dwTransmutationVnum);
-#endif
-
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-		iLen += snprintf(szColumns + iLen, sizeof(szColumns) - iLen,
-			", `refine_element_apply_type`"
-			", `refine_element_grade`"
-			", `refine_element_value0`, `refine_element_value1`, `refine_element_value2`"
-			", `refine_element_bonus_value0`, `refine_element_bonus_value1`, `refine_element_bonus_value2`"
-		);
-		iValueLen += snprintf(szValues + iValueLen, sizeof(szValues) - iValueLen,
-			", %d"
-			", %d"
-			", %d, %d, %d"
-			", %d, %d, %d"
-			, p->RefineElement.wApplyType
-			, p->RefineElement.bGrade
-			, p->RefineElement.abValue[0], p->RefineElement.abValue[1], p->RefineElement.abValue[2]
-			, p->RefineElement.abBonusValue[0], p->RefineElement.abBonusValue[1], p->RefineElement.abBonusValue[2]
-		);
-		iUpdateLen += snprintf(szUpdate + iUpdateLen, sizeof(szUpdate) - iUpdateLen,
-			", `refine_element_apply_type` = %d"
-			", `refine_element_grade` = %d"
-			", `refine_element_value0` = %d, `refine_element_value1` = %d, `refine_element_value2` = %d"
-			", `refine_element_bonus_value0` = %d, `refine_element_bonus_value1` = %d, `refine_element_bonus_value2` = %d"
-			, p->RefineElement.wApplyType
-			, p->RefineElement.bGrade
-			, p->RefineElement.abValue[0], p->RefineElement.abValue[1], p->RefineElement.abValue[2]
-			, p->RefineElement.abBonusValue[0], p->RefineElement.abBonusValue[1], p->RefineElement.abBonusValue[2]
-		);
 #endif
 
-#if defined(__ITEM_APPLY_RANDOM__)
-		if (isApplyRandom)
+		if (isAttr)
 		{
 			iLen += snprintf(szColumns + iLen, sizeof(szColumns) - iLen,
-				", `apply_type0`, `apply_value0`, `apply_path0`"
-				", `apply_type1`, `apply_value1`, `apply_path1`"
-				", `apply_type2`, `apply_value2`, `apply_path2`"
-				", `apply_type3`, `apply_value3`, `apply_path3`"
+				", `attrtype0`, `attrvalue0`"
+				", `attrtype1`, `attrvalue1`"
+				", `attrtype2`, `attrvalue2`"
+				", `attrtype3`, `attrvalue3`"
+				", `attrtype4`, `attrvalue4`"
+				", `attrtype5`, `attrvalue5`"
+				", `attrtype6`, `attrvalue6`"
 			);
 
 			iValueLen += snprintf(szValues + iValueLen, sizeof(szValues) - iValueLen,
-				", %u, %ld, %d"
-				", %u, %ld, %d"
-				", %u, %ld, %d"
-				", %u, %ld, %d"
-				, p->aApplyRandom[0].wType, p->aApplyRandom[0].lValue, p->aApplyRandom[0].bPath
-				, p->aApplyRandom[1].wType, p->aApplyRandom[1].lValue, p->aApplyRandom[1].bPath
-				, p->aApplyRandom[2].wType, p->aApplyRandom[2].lValue, p->aApplyRandom[2].bPath
-				, p->aApplyRandom[3].wType, p->aApplyRandom[3].lValue, p->aApplyRandom[3].bPath
+				", %d, %d"
+				", %d, %d"
+				", %d, %d"
+				", %d, %d"
+				", %d, %d"
+				", %d, %d"
+				", %d, %d"
+				, p->aAttr[0].bType, p->aAttr[0].sValue
+				, p->aAttr[1].bType, p->aAttr[1].sValue
+				, p->aAttr[2].bType, p->aAttr[2].sValue
+				, p->aAttr[3].bType, p->aAttr[3].sValue
+				, p->aAttr[4].bType, p->aAttr[4].sValue
+				, p->aAttr[5].bType, p->aAttr[5].sValue
+				, p->aAttr[6].bType, p->aAttr[6].sValue
 			);
 
 			iUpdateLen += snprintf(szUpdate + iUpdateLen, sizeof(szUpdate) - iUpdateLen,
-				", `apply_type0` = %u, `apply_value0` = %ld, `apply_path0` = %d"
-				", `apply_type1` = %u, `apply_value1` = %ld, `apply_path1` = %d"
-				", `apply_type2` = %u, `apply_value2` = %ld, `apply_path2` = %d"
-				", `apply_type3` = %u, `apply_value3` = %ld, `apply_path3` = %d"
-				, p->aApplyRandom[0].wType, p->aApplyRandom[0].lValue, p->aApplyRandom[3].bPath
-				, p->aApplyRandom[1].wType, p->aApplyRandom[1].lValue, p->aApplyRandom[3].bPath
-				, p->aApplyRandom[2].wType, p->aApplyRandom[2].lValue, p->aApplyRandom[3].bPath
-				, p->aApplyRandom[3].wType, p->aApplyRandom[3].lValue, p->aApplyRandom[3].bPath
+				", `attrtype0` = %d, `attrvalue0` = %d"
+				", `attrtype1` = %d, `attrvalue1` = %d"
+				", `attrtype2` = %d, `attrvalue2` = %d"
+				", `attrtype3` = %d, `attrvalue3` = %d"
+				", `attrtype4` = %d, `attrvalue4` = %d"
+				", `attrtype5` = %d, `attrvalue5` = %d"
+				", `attrtype6` = %d, `attrvalue6` = %d"
+				, p->aAttr[0].bType, p->aAttr[0].sValue
+				, p->aAttr[1].bType, p->aAttr[1].sValue
+				, p->aAttr[2].bType, p->aAttr[2].sValue
+				, p->aAttr[3].bType, p->aAttr[3].sValue
+				, p->aAttr[4].bType, p->aAttr[4].sValue
+				, p->aAttr[5].bType, p->aAttr[5].sValue
+				, p->aAttr[6].bType, p->aAttr[6].sValue
 			);
 		}
-#endif
-
-#if defined(__SET_ITEM__)
-		iLen += snprintf(szColumns + iLen, sizeof(szColumns) - iLen, ", `set_value`");
-		iValueLen += snprintf(szValues + iValueLen, sizeof(szValues) - iValueLen, ", %u", p->bSetValue);
-		iUpdateLen += snprintf(szUpdate + iUpdateLen, sizeof(szUpdate) - iUpdateLen, ", `set_value` = %u", p->bSetValue);
-#endif
 
 		char szItemQuery[QUERY_MAX_LEN + QUERY_MAX_LEN];
 		snprintf(szItemQuery, sizeof(szItemQuery), "REPLACE INTO item%s (%s) VALUES(%s)", GetTablePostfix(), szColumns, szValues);
@@ -300,13 +278,129 @@
 
 		CDBManager::instance().ReturnQuery(szItemQuery, QID_ITEM_SAVE, 0, NULL);
 
-		//g_item_info.Add(p->vnum);
+		// g_item_info.Add(p->vnum);
 		++g_item_count;
 	}
 
 	m_bNeedQuery = false;
 }
 
+#if defined(__SKILL_COLOR_SYSTEM__)
+//
+// CSKillColorCache
+//
+
+extern int g_iSkillColorCacheFlushSeconds;
+
+CSKillColorCache::CSKillColorCache()
+{
+	m_expireTime = MIN(1800, g_iSkillColorCacheFlushSeconds);
+}
+
+CSKillColorCache::~CSKillColorCache()
+{
+}
+
+void CSKillColorCache::OnFlush()
+{
+	char szQuery[QUERY_MAX_LEN];
+	snprintf(szQuery, sizeof(szQuery),
+		"REPLACE INTO skill_color%s (`player_id`"
+		// Skill Slots
+		", `skillSlot1_Col1`, `skillSlot1_Col2`, `skillSlot1_Col3`, `skillSlot1_Col4`, `skillSlot1_Col5`"
+		", `skillSlot2_Col1`, `skillSlot2_Col2`, `skillSlot2_Col3`, `skillSlot2_Col4`, `skillSlot2_Col5`"
+		", `skillSlot3_Col1`, `skillSlot3_Col2`, `skillSlot3_Col3`, `skillSlot3_Col4`, `skillSlot3_Col5`"
+		", `skillSlot4_Col1`, `skillSlot4_Col2`, `skillSlot4_Col3`, `skillSlot4_Col4`, `skillSlot4_Col5`"
+		", `skillSlot5_Col1`, `skillSlot5_Col2`, `skillSlot5_Col3`, `skillSlot5_Col4`, `skillSlot5_Col5`"
+		", `skillSlot6_Col1`, `skillSlot6_Col2`, `skillSlot6_Col3`, `skillSlot6_Col4`, `skillSlot6_Col5`"
+#if defined(__9TH_SKILL__)
+		", `skillSlot7_Col1`, `skillSlot7_Col2`, `skillSlot7_Col3`, `skillSlot7_Col4`, `skillSlot7_Col5`"
+		", `skillSlot8_Col1`, `skillSlot8_Col2`, `skillSlot8_Col3`, `skillSlot8_Col4`, `skillSlot8_Col5`"
+		", `skillSlot9_Col1`, `skillSlot9_Col2`, `skillSlot9_Col3`, `skillSlot9_Col4`, `skillSlot9_Col5`"
+		", `skillSlot10_Col1`, `skillSlot10_Col2`, `skillSlot10_Col3`, `skillSlot10_Col4`, `skillSlot10_Col5`"
+		// Buff Skills
+		", `buffSkill1_Col1`, `buffSkill1_Col2`, `buffSkill1_Col3`, `buffSkill1_Col4`, `buffSkill1_Col5`"
+		", `buffSkill2_Col1`, `buffSkill2_Col2`, `buffSkill2_Col3`, `buffSkill2_Col4`, `buffSkill2_Col5`"
+		", `buffSkill3_Col1`, `buffSkill3_Col2`, `buffSkill3_Col3`, `buffSkill3_Col4`, `buffSkill3_Col5`"
+		", `buffSkill4_Col1`, `buffSkill4_Col2`, `buffSkill4_Col3`, `buffSkill4_Col4`, `buffSkill4_Col5`"
+		", `buffSkill5_Col1`, `buffSkill5_Col2`, `buffSkill5_Col3`, `buffSkill5_Col4`, `buffSkill5_Col5`"
+		", `buffSkill6_Col1`, `buffSkill6_Col2`, `buffSkill6_Col3`, `buffSkill6_Col4`, `buffSkill6_Col5`"
+#else
+		// Buff Skills
+		", `buffSkill1_Col1`, `buffSkill1_Col2`, `buffSkill1_Col3`, `buffSkill1_Col4`, `buffSkill1_Col5`"
+		", `buffSkill2_Col1`, `buffSkill2_Col2`, `buffSkill2_Col3`, `buffSkill2_Col4`, `buffSkill2_Col5`"
+		", `buffSkill3_Col1`, `buffSkill3_Col2`, `buffSkill3_Col3`, `buffSkill3_Col4`, `buffSkill3_Col5`"
+		", `buffSkill4_Col1`, `buffSkill4_Col2`, `buffSkill4_Col3`, `buffSkill4_Col4`, `buffSkill4_Col5`"
+		", `buffSkill5_Col1`, `buffSkill5_Col2`, `buffSkill5_Col3`, `buffSkill5_Col4`, `buffSkill5_Col5`"
+		", `buffSkill6_Col1`, `buffSkill6_Col2`, `buffSkill6_Col3`, `buffSkill6_Col4`, `buffSkill6_Col5`"
+#endif
+		") "
+		"VALUES (%d"
+		// Skill Slots <Slot, Col1, Col2, Col3, Col4, Col5>
+		", %d, %d, %d, %d, %d" // Skill Slot 1
+		", %d, %d, %d, %d, %d" // Skill Slot 2
+		", %d, %d, %d, %d, %d" // Skill Slot 3
+		", %d, %d, %d, %d, %d" // Skill Slot 4
+		", %d, %d, %d, %d, %d" // Skill Slot 5
+		", %d, %d, %d, %d, %d" // Skill Slot 6 (End of Skills)
+#if defined(__9TH_SKILL__)
+		", %d, %d, %d, %d, %d" // Skill Slot 7 (Unused)
+		", %d, %d, %d, %d, %d" // Skill Slot 8 (Unused)
+		", %d, %d, %d, %d, %d" // Skill Slot 9 (Conqueror)
+		", %d, %d, %d, %d, %d" // Skill Slot 10 (End of Skills)
+		// Buff Skills
+		", %d, %d, %d, %d, %d" // Buff Skill 11 (Shaman Group 1)
+		", %d, %d, %d, %d, %d" // Buff Skill 12 (Shaman Group 1)
+		", %d, %d, %d, %d, %d" // Buff Skill 13 (Shaman Group 1)
+		", %d, %d, %d, %d, %d" // Buff Skill 14 (Shaman Group 2)
+		", %d, %d, %d, %d, %d" // Buff Skill 15 (Shaman Group 2)
+		", %d, %d, %d, %d, %d" // Buff Skill 16 (Wolfman)
+#else
+		// Buff Skills
+		", %d, %d, %d, %d, %d" // Buff Skill 7 (Shaman Group 1)
+		", %d, %d, %d, %d, %d" // Buff Skill 8 (Shaman Group 1)
+		", %d, %d, %d, %d, %d" // Buff Skill 9 (Shaman Group 1)
+		", %d, %d, %d, %d, %d" // Buff Skill 10 (Shaman Group 2)
+		", %d, %d, %d, %d, %d" // Buff Skill 11 (Shaman Group 2)
+		", %d, %d, %d, %d, %d" // Buff Skill 12 (Wolfman)
+#endif
+		")", GetTablePostfix(), m_data.dwPlayerID
+		, m_data.dwSkillColor[0][0], m_data.dwSkillColor[0][1], m_data.dwSkillColor[0][2], m_data.dwSkillColor[0][3], m_data.dwSkillColor[0][4]
+		, m_data.dwSkillColor[1][0], m_data.dwSkillColor[1][1], m_data.dwSkillColor[1][2], m_data.dwSkillColor[1][3], m_data.dwSkillColor[1][4]
+		, m_data.dwSkillColor[2][0], m_data.dwSkillColor[2][1], m_data.dwSkillColor[2][2], m_data.dwSkillColor[2][3], m_data.dwSkillColor[2][4]
+		, m_data.dwSkillColor[3][0], m_data.dwSkillColor[3][1], m_data.dwSkillColor[3][2], m_data.dwSkillColor[3][3], m_data.dwSkillColor[3][4]
+		, m_data.dwSkillColor[4][0], m_data.dwSkillColor[4][1], m_data.dwSkillColor[4][2], m_data.dwSkillColor[4][3], m_data.dwSkillColor[4][4]
+		, m_data.dwSkillColor[5][0], m_data.dwSkillColor[5][1], m_data.dwSkillColor[5][2], m_data.dwSkillColor[5][3], m_data.dwSkillColor[5][4]
+#if defined(__9TH_SKILL__)
+		, m_data.dwSkillColor[6][0], m_data.dwSkillColor[6][1], m_data.dwSkillColor[6][2], m_data.dwSkillColor[6][3], m_data.dwSkillColor[6][4]
+		, m_data.dwSkillColor[7][0], m_data.dwSkillColor[7][1], m_data.dwSkillColor[7][2], m_data.dwSkillColor[7][3], m_data.dwSkillColor[7][4]
+		, m_data.dwSkillColor[8][0], m_data.dwSkillColor[8][1], m_data.dwSkillColor[8][2], m_data.dwSkillColor[8][3], m_data.dwSkillColor[8][4]
+		, m_data.dwSkillColor[9][0], m_data.dwSkillColor[9][1], m_data.dwSkillColor[9][2], m_data.dwSkillColor[9][3], m_data.dwSkillColor[9][4]
+		, m_data.dwSkillColor[10][0], m_data.dwSkillColor[10][1], m_data.dwSkillColor[10][2], m_data.dwSkillColor[10][3], m_data.dwSkillColor[10][4]
+		, m_data.dwSkillColor[11][0], m_data.dwSkillColor[11][1], m_data.dwSkillColor[11][2], m_data.dwSkillColor[11][3], m_data.dwSkillColor[11][4]
+		, m_data.dwSkillColor[12][0], m_data.dwSkillColor[12][1], m_data.dwSkillColor[12][2], m_data.dwSkillColor[12][3], m_data.dwSkillColor[12][4]
+		, m_data.dwSkillColor[13][0], m_data.dwSkillColor[13][1], m_data.dwSkillColor[13][2], m_data.dwSkillColor[13][3], m_data.dwSkillColor[13][4]
+		, m_data.dwSkillColor[14][0], m_data.dwSkillColor[14][1], m_data.dwSkillColor[14][2], m_data.dwSkillColor[14][3], m_data.dwSkillColor[14][4]
+		, m_data.dwSkillColor[15][0], m_data.dwSkillColor[15][1], m_data.dwSkillColor[15][2], m_data.dwSkillColor[15][3], m_data.dwSkillColor[15][4]
+#else
+		, m_data.dwSkillColor[6][0], m_data.dwSkillColor[6][1], m_data.dwSkillColor[6][2], m_data.dwSkillColor[6][3], m_data.dwSkillColor[6][4],
+		, m_data.dwSkillColor[7][0], m_data.dwSkillColor[7][1], m_data.dwSkillColor[7][2], m_data.dwSkillColor[7][3], m_data.dwSkillColor[7][4],
+		, m_data.dwSkillColor[8][0], m_data.dwSkillColor[8][1], m_data.dwSkillColor[8][2], m_data.dwSkillColor[8][3], m_data.dwSkillColor[8][4],
+		, m_data.dwSkillColor[9][0], m_data.dwSkillColor[9][1], m_data.dwSkillColor[9][2], m_data.dwSkillColor[9][3], m_data.dwSkillColor[9][4],
+		, m_data.dwSkillColor[10][0], m_data.dwSkillColor[10][1], m_data.dwSkillColor[10][2], m_data.dwSkillColor[10][3], m_data.dwSkillColor[10][4]
+		, m_data.dwSkillColor[11][0], m_data.dwSkillColor[11][1], m_data.dwSkillColor[11][2], m_data.dwSkillColor[11][3], m_data.dwSkillColor[11][4]
+#endif
+	);
+
+	CDBManager::instance().ReturnQuery(szQuery, QID_SKILL_COLOR_SAVE, 0, NULL);
+
+	if (g_test_server)
+		sys_log(0, "SkillColorCache::Flush :REPLACE %u (%s)", m_data.dwPlayerID, szQuery);
+
+	m_bNeedQuery = false;
+}
+#endif
+
 //
 // CPlayerTableCache
 //
@@ -385,12 +479,10 @@
 		if (tmpvec.size() < sizeAddOldDataSize)
 			sizeAddOldDataSize = tmpvec.size();
 
-		if (!tmpvec.empty())
-			thecore_memcpy(m_data.aPriceInfo + pUpdateList->byCount, &tmpvec[0], sizeof(TItemPriceInfo) * sizeAddOldDataSize);
-
+		thecore_memcpy(m_data.aPriceInfo + pUpdateList->byCount, &tmpvec[0], sizeof(TItemPriceInfo) * sizeAddOldDataSize);
 		m_data.byCount += static_cast<BYTE>(sizeAddOldDataSize);
 
-		nDeletedNum = static_cast<UINT>(tmpvec.size() - sizeAddOldDataSize);
+		nDeletedNum = static_cast<int>(tmpvec.size() - sizeAddOldDataSize);
 	}
 	else
 		nDeletedNum = tmpvec.size();
@@ -429,112 +521,6 @@
 }
 // END_OF_MYSHOP_PRICE_LIST
 
-#ifdef __OFFLINE_SHOP__
-COfflineShopCache::COfflineShopCache()
-{
-	m_expireTime = g_offlineShopCacheFlushSeconds;
-}
-
-void COfflineShopCache::OnFlush()
-{
-	std::array<char, CHARACTER_NAME_MAX_LEN * 2 + 1> escapedOwnerName;
-	CDBManager::Instance().EscapeString(escapedOwnerName.data(), m_data.ownerName.data(), m_data.ownerName.size());
-
-	std::array<char, SHOP_TAB_NAME_MAX * 2 + 1> escapedShopName;
-	CDBManager::Instance().EscapeString(escapedShopName.data(), m_data.shopName.data(), m_data.shopName.size());
-
-	std::stringstream query;
-	query << "REPLACE INTO offline_shop" << GetTablePostfix() << "("
-		<< "id, owner_pid, owner_name, name, name_change_time, channel, "
-		<< "map_index, x, y, deco_race, deco_board, opening_time, gold"
-		<< ") VALUES("
-		<< m_data.id << ", "
-		<< m_data.ownerPid << ", "
-		<< "'" << escapedOwnerName.data() << "', "
-		<< "'" << escapedShopName.data() << "', "
-		<< "'" << m_data.shopNameChangeTime << "', "
-		<< m2::to_string(m_data.channel) << ", "
-		<< m_data.mapIndex << ", "
-		<< m_data.x << ", "
-		<< m_data.y << ", "
-		<< m_data.decoRace << ", "
-		<< m2::to_string(m_data.decoBoard) << ", "
-		<< m_data.openingTime << ", "
-		<< m_data.gold
-		<< ")";
-
-	sys_log(0, "OFFLINE SHOP: %s", query.str().c_str());
-	CDBManager::Instance().AsyncQuery(query.str().c_str());
-	m_bNeedQuery = false;
-}
-
-COfflineShopItemCache::COfflineShopItemCache()
-{
-	m_expireTime = g_offlineShopItemCacheFlushSeconds;
-}
-
-void COfflineShopItemCache::OnFlush()
-{
-	if (m_data.vnum == 0) {
-		std::stringstream query;
-		query << "DELETE FROM offline_shop_item" << GetTablePostfix() << " WHERE owner_pid = " << m_data.id.first << " AND position = " << m2::to_string(m_data.id.second);
-
-		//sys_err("OFFLINE SHOP ITEM: %s", query.str().c_str());
-		CDBManager::Instance().AsyncQuery(query.str().c_str());
-	}
-	else {
-		std::stringstream fields, values;
-		fields << "owner_pid, position, vnum, count, ";
-		values << m_data.id.first << ", " << m2::to_string(m_data.id.second) << ", "
-			<< m_data.vnum << ", " << m2::to_string(m_data.count) << ", ";
-
-		size_t i = 0;
-		for (const auto& socket : m_data.sockets) {
-			fields << "socket" << i << ", ";
-			values << socket << ", ";
-			++i;
-		}
-
-		i = 0;
-		for (const auto& attribute : m_data.attributes) {
-			fields << "attrtype" << i << ", attrvalue" << i << ", ";
-			values << m2::to_string(attribute.wType) << ", " << attribute.lValue << ", ";
-			++i;
-		}
-
-#if defined(__ITEM_APPLY_RANDOM__)
-		i = 0;
-		for (const auto& apply : m_data.ApplyRandom) {
-			fields << "apply_type" << i << ", apply_value" << i << ", apply_path" << i << ", ";
-			values << m2::to_string(apply.wType) << ", " << apply.lValue << ", " << static_cast<int>(apply.bPath) << ", ";
-			++i;
-		}
-#endif
-
-		fields << "price, ";
-		values << m_data.price << ", ";
-		
-#ifdef __CHANGE_LOOK_SYSTEM__
-		fields << "transmutation, ";
-		values << m_data.dwTransmutationVnum << ", ";
-#endif
-
-#ifdef __SOUL_BIND_SYSTEM__
-		fields << "soulbind";
-		values << m_data.soulbind;
-#endif
-		std::stringstream query;
-		query << "REPLACE INTO offline_shop_item" << GetTablePostfix() << "("
-			<< fields.str() << ") VALUES(" << values.str() << ")";
-
-		//sys_err("OFFLINE SHOP ITEM: %s", query.str().c_str());
-		CDBManager::Instance().AsyncQuery(query.str().c_str());
-	}
-
-	m_bNeedQuery = false;
-}
-#endif
-
 #ifdef __GROWTH_PET_SYSTEM__
 CGrowthPetCache::CGrowthPetCache()
 {
@@ -633,4 +619,4 @@
 		m_bNeedQuery = false;
 	}
 }
-#endif
+#endif
\ No newline at end of file
diff -ruN baseline/server/server/home/metin2/Source/Server/db/src/Cache.h final/server/server/home/metin2/Source/Server/db/src/Cache.h
--- baseline/server/server/home/metin2/Source/Server/db/src/Cache.h	2025-06-28 20:11:28.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/db/src/Cache.h	2021-06-22 10:08:45.000000000 +0000
@@ -25,6 +25,17 @@
 	DWORD GetLastUpdateTime() { return static_cast<DWORD>(m_lastUpdateTime); }
 };
 
+#if defined(__SKILL_COLOR_SYSTEM__)
+class CSKillColorCache : public cache<TSkillColor>
+{
+public:
+	CSKillColorCache();
+	virtual ~CSKillColorCache();
+
+	virtual void OnFlush();
+};
+#endif
+
 // MYSHOP_PRICE_LIST
 /**
 * @class CItemPriceListTableCache
@@ -58,28 +69,6 @@
 };
 // END_OF_MYSHOP_PRICE_LIST
 
-#ifdef __OFFLINE_SHOP__
-class COfflineShopCache
-	: public cache<TOfflineShop>
-{
-public:
-	COfflineShopCache();
-	virtual ~COfflineShopCache() = default;
-
-	virtual void OnFlush();
-};
-
-class COfflineShopItemCache
-	: public cache<TOfflineShopItem>
-{
-public:
-	COfflineShopItemCache();
-	virtual ~COfflineShopItemCache() = default;
-
-	virtual void OnFlush();
-};
-#endif
-
 #ifdef __GROWTH_PET_SYSTEM__
 class CGrowthPetCache : public cache<TGrowthPet>
 {
@@ -91,4 +80,4 @@
 };
 #endif
 
-#endif // __INC_DB_CACHE_H__
+#endif
diff -ruN baseline/server/server/home/metin2/Source/Server/db/src/ClientManager.cpp final/server/server/home/metin2/Source/Server/db/src/ClientManager.cpp
--- baseline/server/server/home/metin2/Source/Server/db/src/ClientManager.cpp	2026-02-17 16:41:16.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/db/src/ClientManager.cpp	2022-04-27 10:04:27.000000000 +0000
@@ -1,5 +1,5 @@
 #include "stdafx.h"
-#include <set>
+
 #include "../../common/building.h"
 #include "../../common/VnumHelper.h"
 #include "../../libgame/include/grid.h"
@@ -20,11 +20,6 @@
 #include "ItemIDRangeManager.h"
 #include "Cache.h"
 
-#include <sstream>
-#if defined(__SHOP_SEARCH__)
-	#include "ShopSearchManager.h"
-#endif
-
 extern int g_iPlayerCacheFlushSeconds;
 extern int g_iItemCacheFlushSeconds;
 extern int g_test_server;
@@ -55,15 +50,9 @@
 	m_bShutdowned(false),
 	m_iCacheFlushCount(0),
 	m_iCacheFlushCountLimit(200)
-#if defined(__EXPRESSING_EMOTIONS__)
-	, m_iEmoteDumpDelay(3600)
-#endif
 #if defined(__MAILBOX__)
 	, m_iMailBoxBackupSec(3600)
 #endif
-#if defined(__GEM_SHOP__)
-	, m_iGemShopFlushDelay(3600)
-#endif
 {
 	m_itemRange.dwMin = 0;
 	m_itemRange.dwMax = 0;
@@ -86,7 +75,7 @@
 {
 	m_mChannelStatus.clear();
 	//for (TPeerList::const_iterator i = m_peerList.begin(); i != m_peerList.end(); ++i)
-	for (auto i = m_peerList.begin(); i != m_peerList.end(); ++i)
+	for (itertype(m_peerList) i = m_peerList.begin(); i != m_peerList.end(); ++i)
 		(*i)->Destroy();
 
 	m_peerList.clear();
@@ -157,18 +146,10 @@
 	sys_log(0, "ACCEPT_HANDLE: %u", m_fdAccept);
 	fdwatch_add_fd(m_fdWatcher, m_fdAccept, NULL, FDW_READ, false);
 
-#if defined(__EXPRESSING_EMOTIONS__)
-	CConfig::instance().GetValue("EMOTE_DUMP_DELAY", &m_iEmoteDumpDelay);
-#endif
-
 #if defined(__MAILBOX__)
 	CConfig::instance().GetValue("MAILBOX_BACKUP_SEC", &m_iMailBoxBackupSec);
 #endif
 
-#if defined(__GEM_SHOP__)
-	CConfig::instance().GetValue("GEM_SHOP_FLUSH_DELAY", &m_iGemShopFlushDelay);
-#endif
-
 	if (!CConfig::instance().GetValue("BACKUP_LIMIT_SEC", &tmpValue))
 		tmpValue = 600;
 
@@ -176,7 +157,7 @@
 
 	if (!CConfig::instance().GetValue("PLAYER_DELETE_LEVEL_LIMIT", &m_iPlayerDeleteLevelLimit))
 	{
-		sys_err("config.txt: Cannot find PLAYER_DELETE_LEVEL_LIMIT, use default level %d", PLAYER_MAX_LEVEL_CONST + 1);
+		sys_err("conf.txt: Cannot find PLAYER_DELETE_LEVEL_LIMIT, use default level %d", PLAYER_MAX_LEVEL_CONST + 1);
 		m_iPlayerDeleteLevelLimit = PLAYER_MAX_LEVEL_CONST + 1;
 	}
 
@@ -198,9 +179,6 @@
 	sys_log(0, "CHINA_EVENT_SERVER %s", CClientManager::instance().IsChinaEventServer() ? "true" : "false");
 
 	LoadEventFlag();
-#if defined(__GUILD_EVENT_FLAG__) //&& defined(__GUILD_RENEWAL__)
-	LoadGuildEventFlag();
-#endif
 
 	// database character-set  
 	if (g_stLocale == "big5" || g_stLocale == "sjis")
@@ -235,23 +213,16 @@
 	//
 	sys_log(0, "MainLoop exited, Starting cache flushing");
 
-#if defined(__EXPRESSING_EMOTIONS__)
-	CClientManager::instance().QUERY_EMOTE_DUMP();
-#endif
-
 #if defined(__MAILBOX__)
 	CClientManager::instance().MAILBOX_BACKUP();
 #endif
 
-#if defined(__GEM_SHOP__)
-	// Gem Shop Item Data List Flush
-	CClientManager::instance().FlushGemShop();
-#endif
-
 	signal_timer_disable();
 
+	// TPlayerTableCacheMap::const_iterator it = m_map_playerCache.begin();
+	itertype(m_map_playerCache) it = m_map_playerCache.begin();
+
 	// ÷̾ ̺ ĳ ÷
-	auto it = m_map_playerCache.begin();
 	while (it != m_map_playerCache.end())
 	{
 		CPlayerTableCache* c = (it++)->second;
@@ -261,8 +232,9 @@
 	}
 	m_map_playerCache.clear();
 
+	// TItemCacheMap::const_iterator it2 = m_map_itemCache.begin();
+	itertype(m_map_itemCache) it2 = m_map_itemCache.begin();
 	//  ÷
-	auto it2 = m_map_itemCache.begin();
 	while (it2 != m_map_itemCache.end())
 	{
 		CItemCache* c = (it2++)->second;
@@ -272,11 +244,27 @@
 	}
 	m_map_itemCache.clear();
 
+#if defined(__SKILL_COLOR_SYSTEM__)
+	//TSkillColorCacheMap::const_iterator it3 = m_map_SkillColorCache.begin();
+	itertype(m_map_SkillColorCache) it3 = m_map_SkillColorCache.begin();
+	while (it3 != m_map_SkillColorCache.end())
+	{
+		CSKillColorCache* pCache = it3->second;
+
+		pCache->Flush();
+		delete pCache;
+
+		m_map_SkillColorCache.erase(it3++);
+	}
+	m_map_SkillColorCache.clear();
+#endif
+
 	// MYSHOP_PRICE_LIST
 	//
 	// λ   Ʈ Flush
 	//
-	for (auto itPriceList = m_mapItemPriceListCache.begin(); itPriceList != m_mapItemPriceListCache.end(); ++itPriceList)
+	//for (TItemPriceListCacheMap::const_iterator itPriceList = m_mapItemPriceListCache.begin(); itPriceList != m_mapItemPriceListCache.end(); ++itPriceList)
+	for (itertype(m_mapItemPriceListCache) itPriceList = m_mapItemPriceListCache.begin(); itPriceList != m_mapItemPriceListCache.end(); ++itPriceList)
 	{
 		CItemPriceListTableCache* pCache = itPriceList->second;
 		pCache->Flush();
@@ -284,10 +272,8 @@
 	}
 
 	m_mapItemPriceListCache.clear();
-#ifdef __OFFLINE_SHOP__
-	FlushOfflineShops();
-#endif
-
+	// END_OF_MYSHOP_PRICE_LIST
+	
 #ifdef __GROWTH_PET_SYSTEM__
 	auto growthPetCache = m_map_growthPetCache.begin();
 
@@ -300,8 +286,6 @@
 	}
 	m_map_growthPetCache.clear();
 #endif
-
-	// END_OF_MYSHOP_PRICE_LIST
 }
 
 void CClientManager::Quit()
@@ -338,6 +322,8 @@
 #ifdef __GROWTH_PET_SYSTEM__
 		sizeof(WORD) + sizeof(WORD) + sizeof(TGrowthPetSkillTable) * m_vec_growthPetSkillTable.size() +
 #endif
+
+
 		sizeof(time_t) +
 		sizeof(WORD) + sizeof(WORD) + sizeof(TItemIDRangeTable) * 2 +
 		// ADMIN_MANAGER
@@ -366,13 +352,13 @@
 	sys_log(0, "sizeof(TLand) = %d", sizeof(building::TLand));
 	sys_log(0, "sizeof(TObjectProto) = %d", sizeof(building::TObjectProto));
 	sys_log(0, "sizeof(TObject) = %d", sizeof(building::TObject));
+#ifdef __GROWTH_PET_SYSTEM__
+	sys_log(0, "sizeof(TGrowthPetSkillTable) = %d", sizeof(TGrowthPetSkillTable));
+#endif
 	// ADMIN_MANAGER
 	sys_log(0, "sizeof(tAdminInfo) = %d * %d ", sizeof(tAdminInfo) * vAdmin.size());
 	// END_ADMIN_MANAGER
 	sys_log(0, "sizeof(TMonarchInfo) = %d * %d", sizeof(TMonarchInfo));
-#ifdef __GROWTH_PET_SYSTEM__
-	sys_log(0, "sizeof(TGrowthPetSkillTable) = %d", sizeof(TGrowthPetSkillTable));
-#endif
 
 	peer->EncodeWORD(sizeof(TMobTable));
 	peer->EncodeWORD(static_cast<WORD>(m_vec_mobTable.size()));
@@ -417,10 +403,12 @@
 	peer->EncodeWORD(sizeof(building::TObject));
 	peer->EncodeWORD(static_cast<WORD>(m_map_pkObjectTable.size()));
 
-	auto it = m_map_pkObjectTable.begin();
+	//pkObjectTableMap::const_iterator it = m_map_pkObjectTable.begin();
+	itertype(m_map_pkObjectTable) it = m_map_pkObjectTable.begin();
+
 	while (it != m_map_pkObjectTable.end())
 		peer->Encode((it++)->second, sizeof(building::TObject));
-
+	
 #ifdef __GROWTH_PET_SYSTEM__
 	peer->EncodeWORD(sizeof(TGrowthPetSkillTable));
 	peer->EncodeWORD(m_vec_growthPetSkillTable.size());
@@ -481,33 +469,22 @@
 	if (g_test_server)
 		sys_log(0, "MONARCHCandidacy Size %d", CMonarch::instance().MonarchCandidacySize());
 
-#ifdef __OFFLINE_SHOP__
-	peer->EncodeDWORD(sizeof(TOfflineShop));
-	peer->EncodeDWORD(offlineShopCache_.size());
-	for (const auto& entry : offlineShopCache_) {
-		peer->Encode(entry.second->Get(), sizeof(TOfflineShop));
-	}
-
-	peer->EncodeDWORD(sizeof(TOfflineShopItem));
-	peer->EncodeDWORD(offlineShopItemCache_.size());
-	for (const auto& entry : offlineShopItemCache_) {
-		peer->Encode(entry.second->Get(), sizeof(TOfflineShopItem));
-	}
-#endif
-
 	peer->EncodeWORD(0xffff);
 }
 
 void CClientManager::SendPartyOnSetup(CPeer* pkPeer)
 {
 	TPartyMap& pm = m_map_pkChannelParty[pkPeer->GetChannel()];
-	for (auto it_party = pm.begin(); it_party != pm.end(); ++it_party)
+
+	//for (TPartyMap::const_iterator it_party = pm.begin(); it_party != pm.end(); ++it_party)
+	for (itertype(pm) it_party = pm.begin(); it_party != pm.end(); ++it_party)
 	{
 		sys_log(0, "PARTY SendPartyOnSetup Party [%u]", it_party->first);
 		pkPeer->EncodeHeader(HEADER_DG_PARTY_CREATE, 0, sizeof(TPacketPartyCreate));
 		pkPeer->Encode(&it_party->first, sizeof(DWORD));
 
-		for (auto it_member = it_party->second.begin(); it_member != it_party->second.end(); ++it_member)
+		//for (TPartyMember::const_iterator it_member = it_party->second.begin(); it_member != it_party->second.end(); ++it_member)
+		for (itertype(it_party->second) it_member = it_party->second.begin(); it_member != it_party->second.end(); ++it_member)
 		{
 			sys_log(0, "PARTY SendPartyOnSetup Party [%u] Member [%u]", it_party->first, it_member->first);
 			pkPeer->EncodeHeader(HEADER_DG_PARTY_ADD, 0, sizeof(TPacketPartyAdd));
@@ -591,7 +568,7 @@
 
 	if (pi->account_index == 0)
 	{
-		sys_log(0, "RESULT_SAFEBOX_LOAD account_index == 0");
+		sys_log(0, "RESULT_SAFEBOX_LOAD account_index == 0 sheizer");
 
 		char szSafeboxPassword[SAFEBOX_PASSWORD_MAX_LEN + 1];
 		strlcpy(szSafeboxPassword, pi->safebox_password, sizeof(szSafeboxPassword));
@@ -606,7 +583,6 @@
 			if (strcmp("000000", szSafeboxPassword))
 			{
 				pkPeer->EncodeHeader(HEADER_DG_SAFEBOX_WRONG_PASSWORD, dwHandle, 0);
-				delete pSafebox;
 				delete pi;
 				return;
 			}
@@ -622,7 +598,6 @@
 				((row[2] && *row[2]) && strcmp(row[2], szSafeboxPassword)))
 			{
 				pkPeer->EncodeHeader(HEADER_DG_SAFEBOX_WRONG_PASSWORD, dwHandle, 0);
-				delete pSafebox;
 				delete pi;
 				return;
 			}
@@ -644,11 +619,7 @@
 			*/
 			if (pi->ip[0] == 1)
 			{
-#if defined(__EXTEND_MALLBOX__)
-				pSafebox->bSize = 5;
-#else
 				pSafebox->bSize = 1;
-#endif
 				sys_log(0, "MALL id[%d] size[%d]", pSafebox->dwID, pSafebox->bSize);
 			}
 			else
@@ -662,29 +633,18 @@
 
 		char szQuery[QUERY_MAX_LEN];
 		snprintf(szQuery, sizeof(szQuery),
-			"SELECT `id`, `window`+0, `pos`, `vnum`, `count`"
+			"SELECT `id`, `window`+0, `pos`, `count`, `vnum`"
 #if defined(__SOUL_BIND_SYSTEM__)
 			", `soulbind`"
 #endif
-			", `socket0`, `socket1`, `socket2`"
-#if defined(__ITEM_SOCKET6__)
-			", `socket3`, `socket4`, `socket5`"
-#endif
-			", `attrtype0`, `attrvalue0`"
-			", `attrtype1`, `attrvalue1`"
-			", `attrtype2`, `attrvalue2`"
-			", `attrtype3`, `attrvalue3`"
-			", `attrtype4`, `attrvalue4`"
-			", `attrtype5`, `attrvalue5`"
-			", `attrtype6`, `attrvalue6`"
 #if defined(__CHANGE_LOOK_SYSTEM__)
 			", `transmutation`"
 #endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-			", `refine_element_apply_type`"
-			", `refine_element_grade`"
-			", `refine_element_value0`, `refine_element_value1`, `refine_element_value2`"
-			", `refine_element_bonus_value0`, `refine_element_bonus_value1`, `refine_element_bonus_value2`"
+			", `socket0`, `socket1`, `socket2`"
+#if defined(__ITEM_SOCKET5__)
+			", `socket3`"
+			", `socket4`"
+			//", `socket5`"
 #endif
 #if defined(__ITEM_APPLY_RANDOM__)
 			", `apply_type0`, `apply_value0`, `apply_path0`"
@@ -692,10 +652,14 @@
 			", `apply_type2`, `apply_value2`, `apply_path2`"
 			", `apply_type3`, `apply_value3`, `apply_path3`"
 #endif
-#if defined(__SET_ITEM__)
-			", `set_value`"
-#endif
-			" FROM `item%s` WHERE `owner_id` = %u AND `window` = '%s'",
+			", `attrtype0`, `attrvalue0`"
+			", `attrtype1`, `attrvalue1`"
+			", `attrtype2`, `attrvalue2`"
+			", `attrtype3`, `attrvalue3`"
+			", `attrtype4`, `attrvalue4`"
+			", `attrtype5`, `attrvalue5`"
+			", `attrtype6`, `attrvalue6`"
+			" FROM item%s WHERE `owner_id` = %d AND `window` = '%s'",
 			GetTablePostfix(), pi->account_id, pi->ip[0] == 0 ? "SAFEBOX" : "MALL");
 
 		pi->account_index = 1;
@@ -727,59 +691,27 @@
 
 		ItemAwardSet* pSet = ItemAwardManager::instance().GetByLogin(pi->login);
 
-		// Anti-dupe hardening: prevent duplicate/concurrent processing of item_award for the same login.
-		struct _ItemAwardCheckoutGuard
-		{
-			static std::set<std::string>& Set()
-			{
-				static std::set<std::string> s_inflight;
-				return s_inflight;
-			}
-			std::string login;
-			bool active;
-			_ItemAwardCheckoutGuard(const char* szLogin) : login(szLogin ? szLogin : ""), active(false)
-			{
-				auto& s = Set();
-				if (!login.empty() && s.insert(login).second)
-					active = true;
-			}
-			~_ItemAwardCheckoutGuard()
-			{
-				if (!active) return;
-				auto& s = Set();
-				s.erase(login);
-			}
-			operator bool() const { return active; }
-		};
-		_ItemAwardCheckoutGuard _award_guard(pi->login);
-		if (pSet && !_award_guard)
-		{
-			sys_log(0, "ItemAward checkout skipped (already in progress): %s", pi->login);
-			pSet = NULL;
-		}
-
 		if (pSet && !m_vec_itemTable.empty())
 		{
-#if defined(__EXTEND_MALLBOX__)
-			CGrid grid(5, MAX(1, 5) * 9);
-#else
+
 			CGrid grid(5, MAX(1, pi->pSafebox->bSize) * 9);
-#endif
 			bool bEscape = false;
 
 			for (DWORD i = 0; i < s_items.size(); ++i)
 			{
 				TPlayerItem& r = s_items[i];
 
-				auto it = m_map_itemTableByVnum.find(r.dwVnum);
+				// ItemTableVNumMap::const_iterator it = m_map_itemTableByVnum.find(r.vnum);
+				itertype(m_map_itemTableByVnum) it = m_map_itemTableByVnum.find(r.vnum);
+
 				if (it == m_map_itemTableByVnum.end())
 				{
 					bEscape = true;
-					sys_err("invalid item vnum %u in safebox: login %s", r.dwVnum, pi->login);
+					sys_err("invalid item vnum %u in safebox: login %s", r.vnum, pi->login);
 					break;
 				}
 
-				grid.Put(r.wPos, 1, it->second->bSize);
+				grid.Put(r.pos, 1, it->second->bSize);
 			}
 
 			if (!bEscape)
@@ -802,7 +734,9 @@
 					if (pi->ip[0] == 1 && !pItemAward->bMall)
 						continue;
 
-					auto it = m_map_itemTableByVnum.find(pItemAward->dwVnum);
+					// ItemTableVNumMap::const_iterator it = m_map_itemTableByVnum.find(pItemAward->dwVnum);
+					itertype(m_map_itemTableByVnum) it = m_map_itemTableByVnum.find(pItemAward->dwVnum);
+
 					if (it == m_map_itemTableByVnum.end())
 					{
 						sys_err("invalid item vnum %u in item_award: login %s", pItemAward->dwVnum, pi->login);
@@ -823,7 +757,6 @@
 					DWORD dwSocket0 = pItemAward->dwSocket0;
 					DWORD dwSocket2 = pItemAward->dwSocket2;
 					DWORD dwSocket4 = pItemAward->dwSocket4;
-					DWORD dwSocket5 = pItemAward->dwSocket5;
 #else
 					DWORD dwSocket2 = 0;
 #endif
@@ -843,7 +776,7 @@
 							dwSocket2 = pItemTable->alValues[0];
 #endif
 					}
-					else if ((dwItemVnum == ITEM_SKILLBOOK_VNUM || dwItemVnum == ITEM_SKILLFORGET_VNUM) && pItemAward->dwSocket0 == 0)
+					else if ((dwItemVnum == 50300 || dwItemVnum == 70037) && pItemAward->dwSocket0 == 0)
 					{
 						DWORD dwSkillIdx;
 						DWORD dwSkillVnum;
@@ -868,21 +801,21 @@
 					{
 						switch (dwItemVnum)
 						{
-							case 72723: case 72724: case 72725: case 72726:
-							case 72727: case 72728: case 72729: case 72730:
-								// ù  ϴ  ġ ...
-								// ׷ ׳ ϵ ڵ.  ڿ ڵ ۵.
-							case 76004: case 76005: case 76021: case 76022:
-							case 79012: case 79013:
-								if (pItemAward->dwSocket2 == 0)
-								{
-									dwSocket2 = pItemTable->alValues[0];
-								}
-								else
-								{
-									dwSocket2 = pItemAward->dwSocket2;
-								}
-								break;
+						case 72723: case 72724: case 72725: case 72726:
+						case 72727: case 72728: case 72729: case 72730:
+							// ù  ϴ  ġ ...
+							// ׷ ׳ ϵ ڵ.  ڿ ڵ ۵.
+						case 76004: case 76005: case 76021: case 76022:
+						case 79012: case 79013:
+							if (pItemAward->dwSocket2 == 0)
+							{
+								dwSocket2 = pItemTable->alValues[0];
+							}
+							else
+							{
+								dwSocket2 = pItemAward->dwSocket2;
+							}
+							break;
 						}
 					}
 
@@ -893,7 +826,8 @@
 					}
 
 					{
-						auto it = m_map_itemTableByVnum.find(dwItemVnum);
+						// ItemTableVNumMap::const_iterator it = m_map_itemTableByVnum.find(dwItemVnum);
+						itertype(m_map_itemTableByVnum) it = m_map_itemTableByVnum.find(dwItemVnum);
 						if (it == m_map_itemTableByVnum.end())
 						{
 							sys_err("Invalid item(vnum : %d). It is not in m_map_itemTableByVnum.", dwItemVnum);
@@ -907,7 +841,7 @@
 						}
 
 #if defined(__MOUNT_COSTUME_SYSTEM__)
-						if ((item_table->bType == ITEM_UNIQUE && item_table->bType == COSTUME_MOUNT))
+						if (item_table->bType == ITEM_UNIQUE && item_table->bType == COSTUME_MOUNT)
 						{
 							if (pItemAward->dwSocket4 == 0)
 								dwSocket4 = pItemTable->alValues[0];
@@ -941,7 +875,6 @@
 						}
 						else
 						{
-#if defined(__EXTENDED_ITEM_AWARD__)
 							// Load set values
 							for (int i = 0; i < ITEM_LIMIT_MAX_NUM; i++)
 							{
@@ -956,29 +889,6 @@
 									break;
 								}
 							}
-#else
-							for (int i = 0; i < ITEM_LIMIT_MAX_NUM; i++)
-							{
-								if (LIMIT_REAL_TIME == item_table->aLimits[i].bType)
-								{
-									if (0 == item_table->aLimits[i].lValue)
-										pItemAward->dwSocket0 = time(0) + 60 * 60 * 24 * 7;
-									else
-										pItemAward->dwSocket0 = time(0) + item_table->aLimits[i].lValue;
-
-									break;
-								}
-								else if (LIMIT_REAL_TIME_START_FIRST_USE == item_table->aLimits[i].bType || LIMIT_TIMER_BASED_ON_WEAR == item_table->aLimits[i].bType)
-								{
-									if (0 == item_table->aLimits[i].lValue)
-										pItemAward->dwSocket0 = 60 * 60 * 24 * 7;
-									else
-										pItemAward->dwSocket0 = item_table->aLimits[i].lValue;
-
-									break;
-								}
-							}
-#endif
 						}
 
 #if defined(__EXTENDED_ITEM_AWARD__)
@@ -994,9 +904,9 @@
 						int iLen = snprintf(szColumns, sizeof(szColumns), "`id`, `owner_id`, `window`, `pos`, `vnum`, `count`");
 						int iValueLen = snprintf(szValues, sizeof(szValues), "%u, %u, '%s', %d, %u, %u", GainItemID(), pi->account_id, (pi->ip[0] == 0) ? "SAFEBOX" : "MALL", iPos, pItemAward->dwVnum, pItemAward->dwCount);
 
-#if defined(__ITEM_SOCKET6__)
-						iLen += snprintf(szColumns + iLen, sizeof(szColumns) - iLen, ", `socket0`, `socket1`, `socket2`, `socket3`, `socket4`, `socket5`");
-						iValueLen += snprintf(szValues + iValueLen, sizeof(szValues) - iValueLen, ", %u, %u, %u, %u, %u, %u", dwSocket0, pItemAward->dwSocket1, dwSocket2, pItemAward->dwSocket3, pItemAward->dwSocket4, pItemAward->dwSocket5);
+#if defined(__ITEM_SOCKET5__)
+						iLen += snprintf(szColumns + iLen, sizeof(szColumns) - iLen, ", `socket0`, `socket1`, `socket2`, `socket3`, `socket4`");
+						iValueLen += snprintf(szValues + iValueLen, sizeof(szValues) - iValueLen, ", %u, %u, %u, %u, %u", dwSocket0, pItemAward->dwSocket1, dwSocket2, pItemAward->dwSocket3, pItemAward->dwSocket4);
 #else
 						iLen += snprintf(szColumns + iLen, sizeof(szColumns) - iLen, ", `socket0`, `socket1`, `socket2`");
 						iValueLen += snprintf(szValues + iValueLen, sizeof(szValues) - iValueLen, ", %u, %u, %u", pItemAward->dwSocket0, pItemAward->dwSocket1, dwSocket2);
@@ -1005,7 +915,7 @@
 						for (size_t i = 0; i < ITEM_ATTRIBUTE_MAX_NUM; ++i)
 						{
 							iLen += snprintf(szColumns + iLen, sizeof(szColumns) - iLen, ", `attrtype%d`, `attrvalue%d`", i, i);
-							iValueLen += snprintf(szValues + iValueLen, sizeof(szValues) - iValueLen, ", %u, %ld", pItemAward->aAttr[i].wType, pItemAward->aAttr[i].lValue);
+							iValueLen += snprintf(szValues + iValueLen, sizeof(szValues) - iValueLen, ", %d, %d", pItemAward->aAttr[i].bType, pItemAward->aAttr[i].sValue);
 						}
 						// END_OF_AUTO_QUERY
 
@@ -1016,29 +926,28 @@
 							", `socket0`"
 							", `socket1`"
 							", `socket2`"
-#if defined(__ITEM_SOCKET6__)
+#if defined(__ITEM_SOCKET5__)
 							", `socket3`"
 							", `socket4`"
-							", `socket5`"
+							//", `socket5`"
 #endif
 							") VALUES (%u, %u, '%s', %d, %u, %u"
 							", %u"
 							", %u"
 							", %u"
-#if defined(__ITEM_SOCKET6__)
-							", %u"
+#if defined(__ITEM_SOCKET5__)
 							", %u"
 							", %u"
+							//", %u"
 #endif
 							")",
 							GetTablePostfix(), GainItemID(), pi->account_id, pi->ip[0] == 0 ? "SAFEBOX" : "MALL", iPos, pItemAward->dwVnum, pItemAward->dwCount
 							, pItemAward->dwSocket0
 							, pItemAward->dwSocket1
 							, dwSocket2
-#if defined(__ITEM_SOCKET6__)
+#if defined(__ITEM_SOCKET5__)
 							, pItemAward->dwSocket3
 							, pItemAward->dwSocket4
-							, pItemAward->dwSocket5
 #endif
 						);
 #endif
@@ -1051,31 +960,27 @@
 					if (pRes->uiAffectedRows == 0 || pRes->uiInsertID == 0 || pRes->uiAffectedRows == (uint32_t)-1)
 						break;
 
-					item.dwID = pmsg->Get()->uiInsertID;
+					item.id = pmsg->Get()->uiInsertID;
 					if (pi->ip[0] == 0)
-						item.bWindow = SAFEBOX, item.wPos = iPos;
+						item.window = SAFEBOX, item.pos = iPos;
 					else
-						item.bWindow = MALL, item.wPos = iPos;
-					item.dwVnum = pItemAward->dwVnum;
-					item.dwCount = pItemAward->dwCount;
-#if defined(__EXTENDED_ITEM_AWARD__)
+						item.window = MALL, item.pos = iPos;
+					item.count = pItemAward->dwCount;
+					item.vnum = pItemAward->dwVnum;
 					item.alSockets[0] = dwSocket0;
-#else
-					item.alSockets[0] = pItemAward->dwSocket0;
-#endif
 					item.alSockets[1] = pItemAward->dwSocket1;
 					item.alSockets[2] = dwSocket2;
-#if defined(__ITEM_SOCKET6__)
+#if defined(__ITEM_SOCKET5__)
 					item.alSockets[3] = pItemAward->dwSocket3;
 					item.alSockets[4] = dwSocket4;
-					item.alSockets[5] = dwSocket5;
+					//item.alSockets[5] = pItemAward->dwSocket2;
 #endif
 #if defined(__EXTENDED_ITEM_AWARD__)
 					thecore_memcpy(&item.aAttr, pItemAward->aAttr, sizeof(item.aAttr));
 #endif
 					s_items.push_back(item);
 
-					vec_dwFinishedAwardID.push_back(std::make_pair(pItemAward->dwID, item.dwID));
+					vec_dwFinishedAwardID.push_back(std::make_pair(pItemAward->dwID, item.id));
 					grid.Put(iPos, 1, it->second->bSize);
 				}
 
@@ -1086,48 +991,16 @@
 
 		pi->pSafebox->wItemCount = static_cast<WORD>(s_items.size());
 
-#ifdef __GROWTH_PET_SYSTEM__
-		static std::vector<TGrowthPet> s_petVec;
-
-		// Loads pets only when opening safebox with items
-		if (pi->ip[0] == 0 && !s_items.empty())
-		{
-			char szQuery[QUERY_MAX_LEN];
-			snprintf(szQuery, sizeof(szQuery),
-				"SELECT id,vnum,state+0,name,size,level,level_step,evolution,type,hp,sp,def,hp_apply,sp_apply,def_apply,"
-				"age_apply,skill_level,exp,item_exp,UNIX_TIMESTAMP(birthday),end_time,max_time "
-				"FROM growth_pet%s WHERE owner_id=%d AND state=%d",
-				GetTablePostfix(), pi->account_id, STATE_SAFEBOX);
-
-			std::unique_ptr<SQLMsg> pkMsg(CDBManager::instance().DirectQuery(szQuery));
-			MYSQL_RES* pRes = pkMsg->Get()->pSQLResult;
-			CreateGrowthPetTableFromRes(pRes, &s_petVec, pi->account_id);
-		}
-#endif
-
 		if (pi->ip[0] == 0)
-			pkPeer->EncodeHeader(HEADER_DG_SAFEBOX_LOAD, dwHandle, sizeof(TSafeboxTable) + sizeof(TPlayerItem) * s_items.size()
-#ifdef __GROWTH_PET_SYSTEM__
-			+ sizeof(WORD) + sizeof(TGrowthPet) * s_petVec.size()
-#endif
-		);
+			pkPeer->EncodeHeader(HEADER_DG_SAFEBOX_LOAD, dwHandle, sizeof(TSafeboxTable) + sizeof(TPlayerItem) * s_items.size());
 		else
-			pkPeer->EncodeHeader(HEADER_DG_MALL_LOAD, dwHandle, sizeof(TSafeboxTable) + sizeof(TPlayerItem) * s_items.size()
-
-		);
+			pkPeer->EncodeHeader(HEADER_DG_MALL_LOAD, dwHandle, sizeof(TSafeboxTable) + sizeof(TPlayerItem) * s_items.size());
 
 		pkPeer->Encode(pi->pSafebox, sizeof(TSafeboxTable));
 
 		if (!s_items.empty())
 			pkPeer->Encode(&s_items[0], sizeof(TPlayerItem) * s_items.size());
 
-#ifdef __GROWTH_PET_SYSTEM__
-		pkPeer->EncodeWORD((WORD)s_petVec.size());
-
-		if (!s_petVec.empty())
-			pkPeer->Encode(&s_petVec[0], sizeof(TGrowthPet) * s_petVec.size());
-#endif
-
 		delete pi;
 	}
 }
@@ -1237,7 +1110,7 @@
 		str_to_number(table.aPriceInfo[table.byCount].dwVnum, row[0]);
 		str_to_number(table.aPriceInfo[table.byCount].dwPrice, row[1]);
 #if defined(__CHEQUE_SYSTEM__)
-		str_to_number(table.aPriceInfo[table.byCount].dwCheque, row[2]);
+		str_to_number(table.aPriceInfo[table.byCount].dwPriceCheque, row[2]);
 #endif
 		table.byCount++;
 	}
@@ -1272,7 +1145,7 @@
 	// DB  ε  Cache  
 	//
 
-	TItemPriceListTable table{};
+	TItemPriceListTable table;
 	table.dwOwnerID = pUpdateTable->dwOwnerID;
 	table.byCount = 0;
 
@@ -1283,7 +1156,7 @@
 		str_to_number(table.aPriceInfo[table.byCount].dwVnum, row[0]);
 		str_to_number(table.aPriceInfo[table.byCount].dwPrice, row[1]);
 #if defined(__CHEQUE_SYSTEM__)
-		str_to_number(table.aPriceInfo[table.byCount].dwCheque, row[2]);
+		str_to_number(table.aPriceInfo[table.byCount].dwPriceCheque, row[2]);
 #endif
 		table.byCount++;
 	}
@@ -1417,7 +1290,7 @@
 	if (peer->GetChannel() == 1)
 	{
 		// for (TPeerList::const_iterator i = m_peerList.begin(); i != m_peerList.end(); ++i)
-		for (auto i = m_peerList.begin(); i != m_peerList.end(); ++i)
+		for (itertype(m_peerList) i = m_peerList.begin(); i != m_peerList.end(); ++i)
 		{
 			CPeer* tmp = *i;
 
@@ -1445,7 +1318,7 @@
 	else if (peer->GetChannel() == GUILD_WARP_WAR_CHANNEL)
 	{
 		// for (TPeerList::const_iterator i = m_peerList.begin(); i != m_peerList.end(); ++i)
-		for (auto i = m_peerList.begin(); i != m_peerList.end(); ++i)
+		for (itertype(m_peerList) i = m_peerList.begin(); i != m_peerList.end(); ++i)
 		{
 			CPeer* tmp = *i;
 
@@ -1473,7 +1346,7 @@
 	else
 	{
 		// for (TPeerList::const_iterator i = m_peerList.begin(); i != m_peerList.end(); ++i)
-		for (auto i = m_peerList.begin(); i != m_peerList.end(); ++i)
+		for (itertype(m_peerList) i = m_peerList.begin(); i != m_peerList.end(); ++i)
 		{
 			CPeer* tmp = *i;
 
@@ -1522,7 +1395,7 @@
 	strlcpy(p2pSetupPacket.szHost, peer->GetPublicIP(), sizeof(p2pSetupPacket.szHost));
 
 	//for (TPeerList::const_iterator i = m_peerList.begin(); i != m_peerList.end(); ++i)
-	for (auto i = m_peerList.begin(); i != m_peerList.end(); ++i)
+	for (itertype(m_peerList) i = m_peerList.begin(); i != m_peerList.end(); ++i)
 	{
 		CPeer* tmp = *i;
 
@@ -1540,7 +1413,7 @@
 	//
 	// α   
 	//
-	TPacketLoginOnSetup* pck = (TPacketLoginOnSetup*)c_pData;
+	TPacketLoginOnSetup* pck = (TPacketLoginOnSetup*)c_pData;;
 
 	for (DWORD c = 0; c < p->dwLoginCount; ++c, ++pck)
 	{
@@ -1556,9 +1429,8 @@
 		trim_and_lower(pck->szLogin, r.login, sizeof(r.login));
 		strlcpy(r.social_id, pck->szSocialID, sizeof(r.social_id));
 		strlcpy(r.passwd, "TEMP", sizeof(r.passwd));
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-		strlcpy(r.country, pck->szCountry, sizeof(r.country));
-#endif
+		strlcpy(r.hwid, pck->szHWID, sizeof(r.hwid));
+		r.bLanguage = pck->bLanguage;
 
 		InsertLoginData(pkLD);
 
@@ -1572,15 +1444,9 @@
 	}
 
 	SendPartyOnSetup(peer);
-
 	CGuildManager::instance().OnSetup(peer);
 	CPrivManager::instance().SendPrivOnSetup(peer);
-
 	SendEventFlagsOnSetup(peer);
-#if defined(__GUILD_EVENT_FLAG__) //&& defined(__GUILD_RENEWAL__)
-	SendGuildEventFlagsOnSetup(peer);
-#endif
-
 	marriage::CManager::instance().OnSetup(peer);
 }
 
@@ -1597,59 +1463,54 @@
 		c->Flush();
 }
 
+#if defined(__SKILL_COLOR_SYSTEM__)
+void CClientManager::QUERY_SKILL_COLOR_SAVE(const char* c_pData)
+{
+	PutSkillColorCache((TSkillColor*)c_pData);
+}
+#endif
+
 void CClientManager::QUERY_ITEM_SAVE(CPeer* pkPeer, const char* c_pData)
 {
 	TPlayerItem* p = (TPlayerItem*)c_pData;
 
 	// â ĳ ʰ, ĳ ִ ͵  Ѵ.
 
-	if (p->bWindow == SAFEBOX || p->bWindow == MALL
-	)
+	if (p->window == SAFEBOX || p->window == MALL)
 	{
-		CItemCache* c = GetItemCache(p->dwID);
+		CItemCache* c = GetItemCache(p->id);
 
 		if (c)
 		{
-			TItemCacheSetPtrMap::iterator it = m_map_pkItemCacheSetPtr.find(c->Get()->dwOwner);
+			TItemCacheSetPtrMap::iterator it = m_map_pkItemCacheSetPtr.find(c->Get()->owner);
 
 			if (it != m_map_pkItemCacheSetPtr.end())
 			{
 				if (g_test_server)
-					sys_log(0, "ITEM_CACHE: safebox owner %u id %u", c->Get()->dwOwner, c->Get()->dwID);
+					sys_log(0, "ITEM_CACHE: safebox owner %u id %u", c->Get()->owner, c->Get()->id);
 
 				it->second->erase(c);
 			}
 
-			m_map_itemCache.erase(p->dwID);
+			m_map_itemCache.erase(p->id);
 
 			delete c;
 		}
 
 		char szQuery[QUERY_MAX_LEN];
 		snprintf(szQuery, sizeof(szQuery),
-			"REPLACE INTO `item%s` (`id`, `owner_id`, `window`, `pos`, `vnum`, `count`"
+			"REPLACE INTO item%s (`id`, `owner_id`, `window`, `pos`, `count`, `vnum`"
 #if defined(__SOUL_BIND_SYSTEM__)
 			", `soulbind`"
 #endif
-			", `socket0`, `socket1`, `socket2`"
-#if defined(__ITEM_SOCKET6__)
-			", `socket3`, `socket4`, `socket5`"
-#endif
-			", `attrtype0`, `attrvalue0`"
-			", `attrtype1`, `attrvalue1`"
-			", `attrtype2`, `attrvalue2`"
-			", `attrtype3`, `attrvalue3`"
-			", `attrtype4`, `attrvalue4`"
-			", `attrtype5`, `attrvalue5`"
-			", `attrtype6`, `attrvalue6`"
 #if defined(__CHANGE_LOOK_SYSTEM__)
 			", `transmutation`"
 #endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-			", `refine_element_apply_type`"
-			", `refine_element_grade`"
-			", `refine_element_value0`, `refine_element_value1`, `refine_element_value2`"
-			", `refine_element_bonus_value0`, `refine_element_bonus_value1`, `refine_element_bonus_value2`"
+			", `socket0`, `socket1`, `socket2`"
+#if defined(__ITEM_SOCKET5__)
+			", `socket3`"
+			", `socket4`"
+			//", `socket5`"
 #endif
 #if defined(__ITEM_APPLY_RANDOM__)
 			", `apply_type0`, `apply_value0`, `apply_path0`"
@@ -1657,89 +1518,80 @@
 			", `apply_type2`, `apply_value2`, `apply_path2`"
 			", `apply_type3`, `apply_value3`, `apply_path3`"
 #endif
-#if defined(__SET_ITEM__)
-			", `set_value`"
-#endif
-			") VALUES(%u, %u, %u, %u, %u, %u"
+			", `attrtype0`, `attrvalue0`"
+			", `attrtype1`, `attrvalue1`"
+			", `attrtype2`, `attrvalue2`"
+			", `attrtype3`, `attrvalue3`"
+			", `attrtype4`, `attrvalue4`"
+			", `attrtype5`, `attrvalue5`"
+			", `attrtype6`, `attrvalue6`"
+			") VALUES(%u, %u, %d, %d, %u, %u"
 #if defined(__SOUL_BIND_SYSTEM__)
 			", %ld"
 #endif
-			", %ld, %ld, %ld"
-#if defined(__ITEM_SOCKET6__)
-			", %ld, %ld, %ld"
-#endif
-			", %u, %ld"
-			", %u, %ld"
-			", %u, %ld"
-			", %u, %ld"
-			", %u, %ld"
-			", %u, %ld"
-			", %u, %ld"
 #if defined(__CHANGE_LOOK_SYSTEM__)
 			", %u"
 #endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-			", %u"
-			", %u"
-			", %u, %u, %u"
-			", %u, %u, %u"
+			", %ld, %ld, %ld"
+#if defined(__ITEM_SOCKET5__)
+			", %ld"
+			", %ld"
+			//", %ld"
 #endif
 #if defined(__ITEM_APPLY_RANDOM__)
-			", %u, %ld, %u"
-			", %u, %ld, %u"
-			", %u, %ld, %u"
-			", %u, %ld, %u"
-#endif
-#if defined(__SET_ITEM__)
-			", %u"
-#endif
-			")", GetTablePostfix()
-			, p->dwID
-			, p->dwOwner
-			, p->bWindow
-			, p->wPos
-			, p->dwVnum
-			, p->dwCount
+			", %d, %d, %d"
+			", %d, %d, %d"
+			", %d, %d, %d"
+			", %d, %d, %d"
+#endif
+			", %d, %d"
+			", %d, %d"
+			", %d, %d"
+			", %d, %d"
+			", %d, %d"
+			", %d, %d"
+			", %d, %d)",
+			GetTablePostfix(),
+			p->id,
+			p->owner,
+			p->window,
+			p->pos,
+			p->count,
+			p->vnum,
 #if defined(__SOUL_BIND_SYSTEM__)
-			, p->lSealDate
+			p->soulbind,
 #endif
-			, p->alSockets[0], p->alSockets[1], p->alSockets[2]
-#if defined(__ITEM_SOCKET6__)
-			, p->alSockets[3], p->alSockets[4], p->alSockets[5]
-#endif
-			, p->aAttr[0].wType, p->aAttr[0].lValue
-			, p->aAttr[1].wType, p->aAttr[1].lValue
-			, p->aAttr[2].wType, p->aAttr[2].lValue
-			, p->aAttr[3].wType, p->aAttr[3].lValue
-			, p->aAttr[4].wType, p->aAttr[4].lValue
-			, p->aAttr[5].wType, p->aAttr[5].lValue
-			, p->aAttr[6].wType, p->aAttr[6].lValue
 #if defined(__CHANGE_LOOK_SYSTEM__)
-			, p->dwTransmutationVnum
+			p->transmutation,
 #endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-			, p->RefineElement.wApplyType
-			, p->RefineElement.bGrade
-			, p->RefineElement.abValue[0], p->RefineElement.abValue[1], p->RefineElement.abValue[2]
-			, p->RefineElement.abBonusValue[0], p->RefineElement.abBonusValue[1], p->RefineElement.abBonusValue[2]
+			p->alSockets[0],
+			p->alSockets[1],
+			p->alSockets[2],
+#if defined(__ITEM_SOCKET5__)
+			p->alSockets[3],
+			p->alSockets[4],
+			//p->alSockets[5],
 #endif
 #if defined(__ITEM_APPLY_RANDOM__)
-			, p->aApplyRandom[0].wType, p->aApplyRandom[0].lValue, p->aApplyRandom[0].bPath
-			, p->aApplyRandom[1].wType, p->aApplyRandom[1].lValue, p->aApplyRandom[1].bPath
-			, p->aApplyRandom[2].wType, p->aApplyRandom[2].lValue, p->aApplyRandom[2].bPath
-			, p->aApplyRandom[3].wType, p->aApplyRandom[3].lValue, p->aApplyRandom[3].bPath
-#endif
-#if defined(__SET_ITEM__)
-			, p->bSetValue
-#endif
-		);
+			p->aApplyRandom[0].bType, p->aApplyRandom[0].sValue, p->aApplyRandom[0].bPath,
+			p->aApplyRandom[1].bType, p->aApplyRandom[1].sValue, p->aApplyRandom[1].bPath,
+			p->aApplyRandom[2].bType, p->aApplyRandom[2].sValue, p->aApplyRandom[2].bPath,
+			p->aApplyRandom[3].bType, p->aApplyRandom[3].sValue, p->aApplyRandom[3].bPath,
+#endif
+			p->aAttr[0].bType, p->aAttr[0].sValue,
+			p->aAttr[1].bType, p->aAttr[1].sValue,
+			p->aAttr[2].bType, p->aAttr[2].sValue,
+			p->aAttr[3].bType, p->aAttr[3].sValue,
+			p->aAttr[4].bType, p->aAttr[4].sValue,
+			p->aAttr[5].bType, p->aAttr[5].sValue,
+			p->aAttr[6].bType, p->aAttr[6].sValue);
 
 		CDBManager::instance().ReturnQuery(szQuery, QID_ITEM_SAVE, pkPeer->GetHandle(), NULL);
 	}
 	else
 	{
 		if (g_test_server)
-			sys_log(0, "QUERY_ITEM_SAVE => PutItemCache() owner %d id %d vnum %d ", p->dwOwner, p->dwID, p->dwVnum);
+			sys_log(0, "QUERY_ITEM_SAVE => PutItemCache() owner %d id %d vnum %d ", p->owner, p->id, p->vnum);
 
 		PutItemCache(p);
 	}
@@ -1785,7 +1637,7 @@
 		CItemCache* c = *it_set++;
 		c->Flush();
 
-		m_map_itemCache.erase(c->Get()->dwID);
+		m_map_itemCache.erase(c->Get()->id);
 		delete c;
 	}
 
@@ -1812,16 +1664,16 @@
 {
 	CItemCache* c;
 
-	c = GetItemCache(pNew->dwID);
+	c = GetItemCache(pNew->id);
 
 	//   
 	if (!c)
 	{
 		if (g_log)
-			sys_log(0, "ITEM_CACHE: PutItemCache ==> New CItemCache id%d vnum%d new owner%d", pNew->dwID, pNew->dwVnum, pNew->dwOwner);
+			sys_log(0, "ITEM_CACHE: PutItemCache ==> New CItemCache id%d vnum%d new owner%d", pNew->id, pNew->vnum, pNew->owner);
 
 		c = new CItemCache;
-		m_map_itemCache.insert(TItemCacheMap::value_type(pNew->dwID, c));
+		m_map_itemCache.insert(TItemCacheMap::value_type(pNew->id, c));
 	}
 	// 
 	else
@@ -1830,15 +1682,15 @@
 			sys_log(0, "ITEM_CACHE: PutItemCache ==> Have Cache");
 
 		// ڰ Ʋ
-		if (pNew->dwOwner != c->Get()->dwOwner)
+		if (pNew->owner != c->Get()->owner)
 		{
 			// ̹    ־    Ѵ.
-			TItemCacheSetPtrMap::iterator it = m_map_pkItemCacheSetPtr.find(c->Get()->dwOwner);
+			TItemCacheSetPtrMap::iterator it = m_map_pkItemCacheSetPtr.find(c->Get()->owner);
 
 			if (it != m_map_pkItemCacheSetPtr.end())
 			{
 				if (g_log)
-					sys_log(0, "ITEM_CACHE: delete owner %u id %u new owner %u", c->Get()->dwOwner, c->Get()->dwID, pNew->dwOwner);
+					sys_log(0, "ITEM_CACHE: delete owner %u id %u new owner %u", c->Get()->owner, c->Get()->id, pNew->owner);
 				it->second->erase(c);
 			}
 		}
@@ -1847,14 +1699,14 @@
 	// ο  Ʈ
 	c->Put(pNew, bSkipQuery);
 
-	TItemCacheSetPtrMap::iterator it = m_map_pkItemCacheSetPtr.find(c->Get()->dwOwner);
+	TItemCacheSetPtrMap::iterator it = m_map_pkItemCacheSetPtr.find(c->Get()->owner);
 
 	if (it != m_map_pkItemCacheSetPtr.end())
 	{
 		if (g_log)
-			sys_log(0, "ITEM_CACHE: save %u id %u", c->Get()->dwOwner, c->Get()->dwID);
+			sys_log(0, "ITEM_CACHE: save %u id %u", c->Get()->owner, c->Get()->id);
 		else
-			sys_log(1, "ITEM_CACHE: save %u id %u", c->Get()->dwOwner, c->Get()->dwID);
+			sys_log(1, "ITEM_CACHE: save %u id %u", c->Get()->owner, c->Get()->id);
 		it->second->insert(c);
 	}
 	else
@@ -1862,9 +1714,9 @@
 		//  ڰ Ƿ ٷ ؾ     SQL Ͽ
 		//   Ƿ ٷ Ѵ.
 		if (g_log)
-			sys_log(0, "ITEM_CACHE: direct save %u id %u", c->Get()->dwOwner, c->Get()->dwID);
+			sys_log(0, "ITEM_CACHE: direct save %u id %u", c->Get()->owner, c->Get()->id);
 		else
-			sys_log(1, "ITEM_CACHE: direct save %u id %u", c->Get()->dwOwner, c->Get()->dwID);
+			sys_log(1, "ITEM_CACHE: direct save %u id %u", c->Get()->owner, c->Get()->id);
 
 		c->OnFlush();
 	}
@@ -1881,6 +1733,49 @@
 	return true;
 }
 
+#if defined(__SKILL_COLOR_SYSTEM__)
+CSKillColorCache* CClientManager::GetSkillColorCache(DWORD dwID)
+{
+	TSkillColorCacheMap::iterator it = m_map_SkillColorCache.find(dwID);
+
+	if (it == m_map_SkillColorCache.end())
+		return NULL;
+
+	return it->second;
+}
+
+void CClientManager::PutSkillColorCache(const TSkillColor* c_pNew)
+{
+	CSKillColorCache* pCache = GetSkillColorCache(c_pNew->dwPlayerID);
+
+	if (!pCache)
+	{
+		pCache = new CSKillColorCache;
+		m_map_SkillColorCache.insert(TSkillColorCacheMap::value_type(c_pNew->dwPlayerID, pCache));
+	}
+
+	pCache->Put(const_cast<TSkillColor*>(c_pNew), false);
+}
+
+void CClientManager::UpdateSkillColorCache()
+{
+	TSkillColorCacheMap::iterator it = m_map_SkillColorCache.begin();
+
+	while (it != m_map_SkillColorCache.end())
+	{
+		CSKillColorCache* pCache = it->second;
+
+		if (pCache->CheckFlushTimeout())
+		{
+			pCache->Flush();
+			m_map_SkillColorCache.erase(it++);
+		}
+		else
+			++it;
+	}
+}
+#endif
+
 // MYSHOP_PRICE_LIST
 CItemPriceListTableCache* CClientManager::GetItemPriceListCache(DWORD dwID)
 {
@@ -1919,12 +1814,14 @@
 				sys_log(0, "UPDATE : UpdatePlayerCache() ==> FlushPlayerCache %d %s ", c->Get(false)->id, c->Get(false)->name);
 
 			c->Flush();
-
-			// Item Cache Ʈ
-			UpdateItemCacheSet(c->Get()->id);
+			
 #ifdef __GROWTH_PET_SYSTEM__
 			UpdateGrowthPetCacheSet(c->Get()->id);
 #endif
+
+
+			// Item Cache Ʈ
+			UpdateItemCacheSet(c->Get()->id);
 		}
 		else if (c->CheckFlushTimeout())
 			c->Flush();
@@ -1953,7 +1850,7 @@
 		if (c->CheckFlushTimeout())
 		{
 			if (g_test_server)
-				sys_log(0, "UpdateItemCache ==> Flush() vnum %d id owner %d", c->Get()->dwVnum, c->Get()->dwID, c->Get()->dwOwner);
+				sys_log(0, "UpdateItemCache ==> Flush() vnum %d id owner %d", c->Get()->vnum, c->Get()->id, c->Get()->owner);
 
 			c->Flush();
 
@@ -2019,6 +1916,7 @@
 #ifdef __GROWTH_PET_SYSTEM__
 	FlushGrowthPetCacheSet(dwPID);
 #endif
+
 	m_map_playerCache.erase(dwPID);
 	delete pkCache;
 }
@@ -2047,7 +1945,7 @@
 #ifdef __GROWTH_PET_SYSTEM__
 			+ sizeof(WORD) + sizeof(TGrowthPetSkillTable) * m_vec_growthPetSkillTable.size()
 #endif
-		);
+			);
 		tmp->EncodeWORD(static_cast<WORD>(m_vec_skillTable.size()));
 		tmp->Encode(&m_vec_skillTable[0], sizeof(TSkillTable) * m_vec_skillTable.size());
 
@@ -2062,7 +1960,6 @@
 
 		tmp->EncodeWORD(static_cast<WORD>(m_iRefineTableSize));
 		tmp->Encode(m_pRefineTable, sizeof(TRefineTable) * m_iRefineTableSize);
-
 #ifdef __GROWTH_PET_SYSTEM__
 		tmp->EncodeWORD(m_vec_growthPetSkillTable.size());
 		if (m_vec_growthPetSkillTable.size())
@@ -2093,11 +1990,7 @@
 
 void CClientManager::MoneyLog(TPacketMoneyLog* p)
 {
-	CMoneyLog::instance().AddLog(p->type, p->vnum, p->gold
-#if defined(__CHEQUE_SYSTEM__)
-		, p->cheque
-#endif
-	);
+	CMoneyLog::instance().AddLog(p->type, p->vnum, p->gold);
 }
 
 CLoginData* CClientManager::GetLoginData(DWORD dwKey)
@@ -2191,20 +2084,15 @@
 		trim_and_lower(p->szLogin, r.login, sizeof(r.login));
 		strlcpy(r.social_id, p->szSocialID, sizeof(r.social_id));
 		strlcpy(r.passwd, "TEMP", sizeof(r.passwd));
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-		strlcpy(r.country, p->szCountry, sizeof(r.country));
-#endif
+		strlcpy(r.hwid, p->szHWID, sizeof(r.hwid));
+		r.bLanguage = p->bLanguage;
 
 		sys_log(0, "AUTH_LOGIN id(%u) login(%s)"
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-			" country(%s)"
-#endif
+			" language(%d)"
 			" social_id(%s) login_key(%u), client_key(%u %u %u %u)",
 			p->dwID,
 			p->szLogin,
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-			p->szCountry,
-#endif
+			p->bLanguage,
 			p->szSocialID,
 			p->dwLoginKey,
 			p->adwClientKey[0], p->adwClientKey[1], p->adwClientKey[2], p->adwClientKey[3]
@@ -2292,7 +2180,8 @@
 	}
 
 	//pkObjectTableMap::const_iterator it = m_map_pkObjectTable.find(dwID);
-	auto it = m_map_pkObjectTable.find(dwID);
+	itertype(m_map_pkObjectTable) it = m_map_pkObjectTable.find(dwID);
+
 	if (it != m_map_pkObjectTable.end())
 	{
 		delete it->second;
@@ -2348,7 +2237,7 @@
 		TPacketGDAddAffect pa;
 		pa.dwPID = pid;
 		pa.elem.dwType = 223;
-		pa.elem.wApplyOn = 0;
+		pa.elem.bApplyOn = 0;
 		pa.elem.lApplyValue = 0;
 		pa.elem.dwFlag = 0;
 		pa.elem.lDuration = p->lDuration;
@@ -2438,7 +2327,7 @@
 		snprintf(szQuery, sizeof(szQuery),
 			"SELECT `item_vnum`, `price`"
 #if defined(__CHEQUE_SYSTEM__)
-			", `cheque`"
+			", `price_cheque`"
 #endif
 			" FROM myshop_pricelist%s WHERE `owner_id` = %u", GetTablePostfix(), pPacket->dwOwnerID);
 		CDBManager::instance().ReturnQuery(szQuery, QID_ITEMPRICE_LOAD_FOR_UPDATE, 0, pUpdateTable);
@@ -2476,7 +2365,7 @@
 		snprintf(szQuery, sizeof(szQuery),
 			"SELECT `item_vnum`, `price`"
 #if defined(__CHEQUE_SYSTEM__)
-			", `cheque`"
+			", `price_cheque`"
 #endif
 			" FROM myshop_pricelist%s WHERE `owner_id` = %u", GetTablePostfix(), dwPlayerID);
 		CDBManager::instance().ReturnQuery(szQuery, QID_ITEMPRICE_LOAD, peer->GetHandle(), new TItemPricelistReqInfo(dwHandle, dwPlayerID));
@@ -2486,7 +2375,9 @@
 
 void CPacketInfo::Add(int header)
 {
-	auto it = m_map_info.find(header);
+	// PacketInfoMap::iterator it = m_map_info.find(header);
+	itertype(m_map_info) it = m_map_info.find(header);
+
 	if (it == m_map_info.end())
 		m_map_info.insert(std::map<int, int>::value_type(header, 1));
 	else
@@ -2534,538 +2425,463 @@
 
 		switch (header)
 		{
-			case HEADER_GD_BOOT:
-				QUERY_BOOT(peer, (TPacketGDBoot*)data);
-				break;
-
-			case HEADER_GD_HAMMER_OF_TOR:
-				break;
+		case HEADER_GD_BOOT:
+			QUERY_BOOT(peer, (TPacketGDBoot*)data);
+			break;
 
-			case HEADER_GD_LOGIN_BY_KEY:
-				QUERY_LOGIN_BY_KEY(peer, dwHandle, (TPacketGDLoginByKey*)data);
-				break;
+		case HEADER_GD_HAMMER_OF_TOR:
+			break;
 
-			case HEADER_GD_LOGOUT:
-				//sys_log(0, "HEADER_GD_LOGOUT (handle: %d length: %d)", dwHandle, dwLength);
-				QUERY_LOGOUT(peer, dwHandle, data);
-				break;
+		case HEADER_GD_LOGIN_BY_KEY:
+			QUERY_LOGIN_BY_KEY(peer, dwHandle, (TPacketGDLoginByKey*)data);
+			break;
 
-			case HEADER_GD_PLAYER_LOAD:
-				sys_log(1, "HEADER_GD_PLAYER_LOAD (handle: %d length: %d)", dwHandle, dwLength);
-				QUERY_PLAYER_LOAD(peer, dwHandle, (TPlayerLoadPacket*)data);
-				break;
+		case HEADER_GD_LOGOUT:
+			//sys_log(0, "HEADER_GD_LOGOUT (handle: %d length: %d)", dwHandle, dwLength);
+			QUERY_LOGOUT(peer, dwHandle, data);
+			break;
 
-			case HEADER_GD_PLAYER_SAVE:
-				sys_log(1, "HEADER_GD_PLAYER_SAVE (handle: %d length: %d)", dwHandle, dwLength);
-				QUERY_PLAYER_SAVE(peer, dwHandle, (TPlayerTable*)data);
-				break;
+		case HEADER_GD_PLAYER_LOAD:
+			sys_log(1, "HEADER_GD_PLAYER_LOAD (handle: %d length: %d)", dwHandle, dwLength);
+			QUERY_PLAYER_LOAD(peer, dwHandle, (TPlayerLoadPacket*)data);
+#if defined(__SKILL_COLOR_SYSTEM__)
+			QUERY_SKILL_COLOR_LOAD(peer, dwHandle, (TPlayerLoadPacket*)data);
+#endif
+			break;
 
-			case HEADER_GD_PLAYER_CREATE:
-				sys_log(0, "HEADER_GD_PLAYER_CREATE (handle: %d length: %d)", dwHandle, dwLength);
-				__QUERY_PLAYER_CREATE(peer, dwHandle, (TPlayerCreatePacket*)data);
-				sys_log(0, "END");
-				break;
+		case HEADER_GD_PLAYER_SAVE:
+			sys_log(1, "HEADER_GD_PLAYER_SAVE (handle: %d length: %d)", dwHandle, dwLength);
+			QUERY_PLAYER_SAVE(peer, dwHandle, (TPlayerTable*)data);
+			break;
 
-			case HEADER_GD_PLAYER_DELETE:
-				sys_log(1, "HEADER_GD_PLAYER_DELETE (handle: %d length: %d)", dwHandle, dwLength);
-				__QUERY_PLAYER_DELETE(peer, dwHandle, (TPlayerDeletePacket*)data);
-				break;
+		case HEADER_GD_PLAYER_CREATE:
+			sys_log(0, "HEADER_GD_PLAYER_CREATE (handle: %d length: %d)", dwHandle, dwLength);
+			__QUERY_PLAYER_CREATE(peer, dwHandle, (TPlayerCreatePacket*)data);
+			sys_log(0, "END");
+			break;
 
-			case HEADER_GD_PLAYER_COUNT:
-				QUERY_PLAYER_COUNT(peer, (TPlayerCountPacket*)data);
-				break;
+		case HEADER_GD_PLAYER_DELETE:
+			sys_log(1, "HEADER_GD_PLAYER_DELETE (handle: %d length: %d)", dwHandle, dwLength);
+			__QUERY_PLAYER_DELETE(peer, dwHandle, (TPlayerDeletePacket*)data);
+			break;
 
-			case HEADER_GD_QUEST_SAVE:
-				sys_log(1, "HEADER_GD_QUEST_SAVE (handle: %d length: %d)", dwHandle, dwLength);
-				QUERY_QUEST_SAVE(peer, (TQuestTable*)data, dwLength);
-				break;
+		case HEADER_GD_PLAYER_COUNT:
+			QUERY_PLAYER_COUNT(peer, (TPlayerCountPacket*)data);
+			break;
 
-			case HEADER_GD_SAFEBOX_LOAD:
-				QUERY_SAFEBOX_LOAD(peer, dwHandle, (TSafeboxLoadPacket*)data, 0);
-				break;
+		case HEADER_GD_QUEST_SAVE:
+			sys_log(1, "HEADER_GD_QUEST_SAVE (handle: %d length: %d)", dwHandle, dwLength);
+			QUERY_QUEST_SAVE(peer, (TQuestTable*)data, dwLength);
+			break;
 
-			case HEADER_GD_SAFEBOX_SAVE:
-				sys_log(1, "HEADER_GD_SAFEBOX_SAVE (handle: %d length: %d)", dwHandle, dwLength);
-				QUERY_SAFEBOX_SAVE(peer, (TSafeboxTable*)data);
-				break;
+		case HEADER_GD_SAFEBOX_LOAD:
+			QUERY_SAFEBOX_LOAD(peer, dwHandle, (TSafeboxLoadPacket*)data, 0);
+			break;
 
-			case HEADER_GD_SAFEBOX_CHANGE_SIZE:
-				QUERY_SAFEBOX_CHANGE_SIZE(peer, dwHandle, (TSafeboxChangeSizePacket*)data);
-				break;
+		case HEADER_GD_SAFEBOX_SAVE:
+			sys_log(1, "HEADER_GD_SAFEBOX_SAVE (handle: %d length: %d)", dwHandle, dwLength);
+			QUERY_SAFEBOX_SAVE(peer, (TSafeboxTable*)data);
+			break;
 
-			case HEADER_GD_SAFEBOX_CHANGE_PASSWORD:
-				QUERY_SAFEBOX_CHANGE_PASSWORD(peer, dwHandle, (TSafeboxChangePasswordPacket*)data);
-				break;
+		case HEADER_GD_SAFEBOX_CHANGE_SIZE:
+			QUERY_SAFEBOX_CHANGE_SIZE(peer, dwHandle, (TSafeboxChangeSizePacket*)data);
+			break;
 
-			case HEADER_GD_MALL_LOAD:
-				QUERY_SAFEBOX_LOAD(peer, dwHandle, (TSafeboxLoadPacket*)data, 1);
-				break;
+		case HEADER_GD_SAFEBOX_CHANGE_PASSWORD:
+			QUERY_SAFEBOX_CHANGE_PASSWORD(peer, dwHandle, (TSafeboxChangePasswordPacket*)data);
+			break;
 
-			case HEADER_GD_EMPIRE_SELECT:
-				QUERY_EMPIRE_SELECT(peer, dwHandle, (TEmpireSelectPacket*)data);
-				break;
+		case HEADER_GD_MALL_LOAD:
+			QUERY_SAFEBOX_LOAD(peer, dwHandle, (TSafeboxLoadPacket*)data, 1);
+			break;
 
-			case HEADER_GD_SETUP:
-				QUERY_SETUP(peer, dwHandle, data);
-				break;
+		case HEADER_GD_EMPIRE_SELECT:
+			QUERY_EMPIRE_SELECT(peer, dwHandle, (TEmpireSelectPacket*)data);
+			break;
 
-			case HEADER_GD_GUILD_CREATE:
-				GuildCreate(peer, *(DWORD*)data);
-				break;
+		case HEADER_GD_SETUP:
+			QUERY_SETUP(peer, dwHandle, data);
+			break;
 
-			case HEADER_GD_GUILD_SKILL_UPDATE:
-				GuildSkillUpdate(peer, (TPacketGuildSkillUpdate*)data);
-				break;
+		case HEADER_GD_GUILD_CREATE:
+			GuildCreate(peer, *(DWORD*)data);
+			break;
 
-			case HEADER_GD_GUILD_EXP_UPDATE:
-				GuildExpUpdate(peer, (TPacketGuildExpUpdate*)data);
-				break;
+		case HEADER_GD_GUILD_SKILL_UPDATE:
+			GuildSkillUpdate(peer, (TPacketGuildSkillUpdate*)data);
+			break;
 
-			case HEADER_GD_GUILD_ADD_MEMBER:
-				GuildAddMember(peer, (TPacketGDGuildAddMember*)data);
-				break;
+		case HEADER_GD_GUILD_EXP_UPDATE:
+			GuildExpUpdate(peer, (TPacketGuildExpUpdate*)data);
+			break;
 
-			case HEADER_GD_GUILD_REMOVE_MEMBER:
-				GuildRemoveMember(peer, (TPacketGuild*)data);
-				break;
+		case HEADER_GD_GUILD_ADD_MEMBER:
+			GuildAddMember(peer, (TPacketGDGuildAddMember*)data);
+			break;
 
-			case HEADER_GD_GUILD_CHANGE_GRADE:
-				GuildChangeGrade(peer, (TPacketGuild*)data);
-				break;
+		case HEADER_GD_GUILD_REMOVE_MEMBER:
+			GuildRemoveMember(peer, (TPacketGuild*)data);
+			break;
 
-			case HEADER_GD_GUILD_CHANGE_MEMBER_DATA:
-				GuildChangeMemberData(peer, (TPacketGuildChangeMemberData*)data);
-				break;
+		case HEADER_GD_GUILD_CHANGE_GRADE:
+			GuildChangeGrade(peer, (TPacketGuild*)data);
+			break;
 
-			case HEADER_GD_GUILD_DISBAND:
-				GuildDisband(peer, (TPacketGuild*)data);
-				break;
+		case HEADER_GD_GUILD_CHANGE_MEMBER_DATA:
+			GuildChangeMemberData(peer, (TPacketGuildChangeMemberData*)data);
+			break;
 
-			case HEADER_GD_GUILD_WAR:
-				GuildWar(peer, (TPacketGuildWar*)data);
-				break;
+		case HEADER_GD_GUILD_DISBAND:
+			GuildDisband(peer, (TPacketGuild*)data);
+			break;
 
-			case HEADER_GD_GUILD_WAR_SCORE:
-				GuildWarScore(peer, (TPacketGuildWarScore*)data);
-				break;
+		case HEADER_GD_GUILD_WAR:
+			GuildWar(peer, (TPacketGuildWar*)data);
+			break;
 
-			case HEADER_GD_GUILD_CHANGE_LADDER_POINT:
-				GuildChangeLadderPoint((TPacketGuildLadderPoint*)data);
-				break;
+		case HEADER_GD_GUILD_WAR_SCORE:
+			GuildWarScore(peer, (TPacketGuildWarScore*)data);
+			break;
 
-			case HEADER_GD_GUILD_USE_SKILL:
-				GuildUseSkill((TPacketGuildUseSkill*)data);
-				break;
+		case HEADER_GD_GUILD_CHANGE_LADDER_POINT:
+			GuildChangeLadderPoint((TPacketGuildLadderPoint*)data);
+			break;
 
-			case HEADER_GD_FLUSH_CACHE:
-				QUERY_FLUSH_CACHE(peer, data);
-				break;
+		case HEADER_GD_GUILD_USE_SKILL:
+			GuildUseSkill((TPacketGuildUseSkill*)data);
+			break;
 
-			case HEADER_GD_ITEM_SAVE:
-				QUERY_ITEM_SAVE(peer, data);
-				break;
+		case HEADER_GD_FLUSH_CACHE:
+			QUERY_FLUSH_CACHE(peer, data);
+			break;
 
-			case HEADER_GD_ITEM_DESTROY:
-				QUERY_ITEM_DESTROY(peer, data);
-				break;
+		case HEADER_GD_ITEM_SAVE:
+			QUERY_ITEM_SAVE(peer, data);
+			break;
 
-			case HEADER_GD_ITEM_FLUSH:
-				QUERY_ITEM_FLUSH(peer, data);
-				break;
+		case HEADER_GD_ITEM_DESTROY:
+			QUERY_ITEM_DESTROY(peer, data);
+			break;
 
-			case HEADER_GD_ADD_AFFECT:
-				sys_log(1, "HEADER_GD_ADD_AFFECT");
-				QUERY_ADD_AFFECT(peer, (TPacketGDAddAffect*)data);
-				break;
+		case HEADER_GD_ITEM_FLUSH:
+			QUERY_ITEM_FLUSH(peer, data);
+			break;
 
-			case HEADER_GD_REMOVE_AFFECT:
-				sys_log(1, "HEADER_GD_REMOVE_AFFECT");
-				QUERY_REMOVE_AFFECT(peer, (TPacketGDRemoveAffect*)data);
-				break;
+		case HEADER_GD_ADD_AFFECT:
+			sys_log(1, "HEADER_GD_ADD_AFFECT");
+			QUERY_ADD_AFFECT(peer, (TPacketGDAddAffect*)data);
+			break;
 
-			case HEADER_GD_HIGHSCORE_REGISTER:
-				QUERY_HIGHSCORE_REGISTER(peer, (TPacketGDHighscore*)data);
-				break;
+		case HEADER_GD_REMOVE_AFFECT:
+			sys_log(1, "HEADER_GD_REMOVE_AFFECT");
+			QUERY_REMOVE_AFFECT(peer, (TPacketGDRemoveAffect*)data);
+			break;
 
-			case HEADER_GD_PARTY_CREATE:
-				QUERY_PARTY_CREATE(peer, (TPacketPartyCreate*)data);
-				break;
+		case HEADER_GD_HIGHSCORE_REGISTER:
+			QUERY_HIGHSCORE_REGISTER(peer, (TPacketGDHighscore*)data);
+			break;
 
-			case HEADER_GD_PARTY_DELETE:
-				QUERY_PARTY_DELETE(peer, (TPacketPartyDelete*)data);
-				break;
+		case HEADER_GD_PARTY_CREATE:
+			QUERY_PARTY_CREATE(peer, (TPacketPartyCreate*)data);
+			break;
 
-			case HEADER_GD_PARTY_ADD:
-				QUERY_PARTY_ADD(peer, (TPacketPartyAdd*)data);
-				break;
+		case HEADER_GD_PARTY_DELETE:
+			QUERY_PARTY_DELETE(peer, (TPacketPartyDelete*)data);
+			break;
 
-			case HEADER_GD_PARTY_REMOVE:
-				QUERY_PARTY_REMOVE(peer, (TPacketPartyRemove*)data);
-				break;
+		case HEADER_GD_PARTY_ADD:
+			QUERY_PARTY_ADD(peer, (TPacketPartyAdd*)data);
+			break;
 
-			case HEADER_GD_PARTY_STATE_CHANGE:
-				QUERY_PARTY_STATE_CHANGE(peer, (TPacketPartyStateChange*)data);
-				break;
+		case HEADER_GD_PARTY_REMOVE:
+			QUERY_PARTY_REMOVE(peer, (TPacketPartyRemove*)data);
+			break;
 
-			case HEADER_GD_PARTY_SET_MEMBER_LEVEL:
-				QUERY_PARTY_SET_MEMBER_LEVEL(peer, (TPacketPartySetMemberLevel*)data);
-				break;
+		case HEADER_GD_PARTY_STATE_CHANGE:
+			QUERY_PARTY_STATE_CHANGE(peer, (TPacketPartyStateChange*)data);
+			break;
 
-			case HEADER_GD_RELOAD_PROTO:
-				QUERY_RELOAD_PROTO();
-				break;
+		case HEADER_GD_PARTY_SET_MEMBER_LEVEL:
+			QUERY_PARTY_SET_MEMBER_LEVEL(peer, (TPacketPartySetMemberLevel*)data);
+			break;
 
-			case HEADER_GD_CHANGE_NAME:
-				QUERY_CHANGE_NAME(peer, dwHandle, (TPacketGDChangeName*)data);
-				break;
+		case HEADER_GD_RELOAD_PROTO:
+			QUERY_RELOAD_PROTO();
+			break;
 
-			case HEADER_GD_AUTH_LOGIN:
-				QUERY_AUTH_LOGIN(peer, dwHandle, (TPacketGDAuthLogin*)data);
-				break;
+		case HEADER_GD_CHANGE_NAME:
+			QUERY_CHANGE_NAME(peer, dwHandle, (TPacketGDChangeName*)data);
+			break;
 
-			case HEADER_GD_REQUEST_GUILD_PRIV:
-				AddGuildPriv((TPacketGiveGuildPriv*)data);
-				break;
+		case HEADER_GD_AUTH_LOGIN:
+			QUERY_AUTH_LOGIN(peer, dwHandle, (TPacketGDAuthLogin*)data);
+			break;
 
-			case HEADER_GD_REQUEST_EMPIRE_PRIV:
-				AddEmpirePriv((TPacketGiveEmpirePriv*)data);
-				break;
+		case HEADER_GD_REQUEST_GUILD_PRIV:
+			AddGuildPriv((TPacketGiveGuildPriv*)data);
+			break;
 
-			case HEADER_GD_REQUEST_CHARACTER_PRIV:
-				AddCharacterPriv((TPacketGiveCharacterPriv*)data);
-				break;
+		case HEADER_GD_REQUEST_EMPIRE_PRIV:
+			AddEmpirePriv((TPacketGiveEmpirePriv*)data);
+			break;
 
-			case HEADER_GD_MONEY_LOG:
-				MoneyLog((TPacketMoneyLog*)data);
-				break;
+		case HEADER_GD_REQUEST_CHARACTER_PRIV:
+			AddCharacterPriv((TPacketGiveCharacterPriv*)data);
+			break;
 
-			case HEADER_GD_GUILD_DEPOSIT_MONEY:
-				GuildDepositMoney((TPacketGDGuildMoney*)data);
-				break;
+		case HEADER_GD_MONEY_LOG:
+			MoneyLog((TPacketMoneyLog*)data);
+			break;
 
-			case HEADER_GD_GUILD_WITHDRAW_MONEY:
-				GuildWithdrawMoney(peer, (TPacketGDGuildMoney*)data);
-				break;
+		case HEADER_GD_GUILD_DEPOSIT_MONEY:
+			GuildDepositMoney((TPacketGDGuildMoney*)data);
+			break;
 
-			case HEADER_GD_GUILD_WITHDRAW_MONEY_GIVE_REPLY:
-				GuildWithdrawMoneyGiveReply((TPacketGDGuildMoneyWithdrawGiveReply*)data);
-				break;
+		case HEADER_GD_GUILD_WITHDRAW_MONEY:
+			GuildWithdrawMoney(peer, (TPacketGDGuildMoney*)data);
+			break;
 
-			case HEADER_GD_GUILD_WAR_BET:
-				GuildWarBet((TPacketGDGuildWarBet*)data);
-				break;
+		case HEADER_GD_GUILD_WITHDRAW_MONEY_GIVE_REPLY:
+			GuildWithdrawMoneyGiveReply((TPacketGDGuildMoneyWithdrawGiveReply*)data);
+			break;
 
-#if defined(__GUILD_EVENT_FLAG__) //&& defined(__GUILD_RENEWAL__)
-			case HEADER_GD_GUILD_EVENT_FLAG:
-				GuildSetEventFlag((TPacketSetGuildEventFlag*)data);
-				break;
-#endif
+		case HEADER_GD_GUILD_WAR_BET:
+			GuildWarBet((TPacketGDGuildWarBet*)data);
+			break;
 
-			case HEADER_GD_SET_EVENT_FLAG:
-				SetEventFlag((TPacketSetEventFlag*)data);
-				break;
+		case HEADER_GD_SET_EVENT_FLAG:
+			SetEventFlag((TPacketSetEventFlag*)data);
+			break;
 
-			case HEADER_GD_CREATE_OBJECT:
-				CreateObject((TPacketGDCreateObject*)data);
-				break;
+		case HEADER_GD_CREATE_OBJECT:
+			CreateObject((TPacketGDCreateObject*)data);
+			break;
 
-			case HEADER_GD_DELETE_OBJECT:
-				DeleteObject(*(DWORD*)data);
-				break;
+		case HEADER_GD_DELETE_OBJECT:
+			DeleteObject(*(DWORD*)data);
+			break;
 
-			case HEADER_GD_UPDATE_LAND:
-				UpdateLand((DWORD*)data);
-				break;
+		case HEADER_GD_UPDATE_LAND:
+			UpdateLand((DWORD*)data);
+			break;
 
-			case HEADER_GD_MARRIAGE_ADD:
-				MarriageAdd((TPacketMarriageAdd*)data);
-				break;
+		case HEADER_GD_MARRIAGE_ADD:
+			MarriageAdd((TPacketMarriageAdd*)data);
+			break;
 
-			case HEADER_GD_MARRIAGE_UPDATE:
-				MarriageUpdate((TPacketMarriageUpdate*)data);
-				break;
+		case HEADER_GD_MARRIAGE_UPDATE:
+			MarriageUpdate((TPacketMarriageUpdate*)data);
+			break;
 
-			case HEADER_GD_MARRIAGE_REMOVE:
-				MarriageRemove((TPacketMarriageRemove*)data);
-				break;
+		case HEADER_GD_MARRIAGE_REMOVE:
+			MarriageRemove((TPacketMarriageRemove*)data);
+			break;
 
-			case HEADER_GD_WEDDING_REQUEST:
-				WeddingRequest((TPacketWeddingRequest*)data);
-				break;
+		case HEADER_GD_WEDDING_REQUEST:
+			WeddingRequest((TPacketWeddingRequest*)data);
+			break;
 
-			case HEADER_GD_WEDDING_READY:
-				WeddingReady((TPacketWeddingReady*)data);
-				break;
+		case HEADER_GD_WEDDING_READY:
+			WeddingReady((TPacketWeddingReady*)data);
+			break;
 
-			case HEADER_GD_WEDDING_END:
-				WeddingEnd((TPacketWeddingEnd*)data);
-				break;
+		case HEADER_GD_WEDDING_END:
+			WeddingEnd((TPacketWeddingEnd*)data);
+			break;
 
-				// BLOCK_CHAT
-			case HEADER_GD_BLOCK_CHAT:
-				BlockChat((TPacketBlockChat*)data);
-				break;
-				// END_OF_BLOCK_CHAT
+			// BLOCK_CHAT
+		case HEADER_GD_BLOCK_CHAT:
+			BlockChat((TPacketBlockChat*)data);
+			break;
+			// END_OF_BLOCK_CHAT
 
-				// MYSHOP_PRICE_LIST
-			case HEADER_GD_MYSHOP_PRICELIST_UPDATE:
-				MyshopPricelistUpdate((TItemPriceListTable*)data);
-				break;
+			// MYSHOP_PRICE_LIST
+		case HEADER_GD_MYSHOP_PRICELIST_UPDATE:
+			MyshopPricelistUpdate((TItemPriceListTable*)data);
+			break;
 
-			case HEADER_GD_MYSHOP_PRICELIST_REQ:
-				MyshopPricelistRequest(peer, dwHandle, *(DWORD*)data);
-				break;
-				// END_OF_MYSHOP_PRICE_LIST
+		case HEADER_GD_MYSHOP_PRICELIST_REQ:
+			MyshopPricelistRequest(peer, dwHandle, *(DWORD*)data);
+			break;
+			// END_OF_MYSHOP_PRICE_LIST
 
-				// RELOAD_ADMIN
-			case HEADER_GD_RELOAD_ADMIN:
-				ReloadAdmin(peer, (TPacketReloadAdmin*)data);
-				break;
-				// END_RELOAD_ADMIN
+			// RELOAD_ADMIN
+		case HEADER_GD_RELOAD_ADMIN:
+			ReloadAdmin(peer, (TPacketReloadAdmin*)data);
+			break;
+			// END_RELOAD_ADMIN
 
-			case HEADER_GD_BREAK_MARRIAGE:
-				BreakMarriage(peer, data);
-				break;
+		case HEADER_GD_BREAK_MARRIAGE:
+			BreakMarriage(peer, data);
+			break;
 
-				// MOANRCH
-			case HEADER_GD_ELECT_MONARCH:
-				Election(peer, dwHandle, data);
-				break;
+			// MOANRCH
+		case HEADER_GD_ELECT_MONARCH:
+			Election(peer, dwHandle, data);
+			break;
 
-			case HEADER_GD_CANDIDACY:
-				Candidacy(peer, dwHandle, data);
-				break;
+		case HEADER_GD_CANDIDACY:
+			Candidacy(peer, dwHandle, data);
+			break;
 
-			case HEADER_GD_ADD_MONARCH_MONEY:
-				AddMonarchMoney(peer, dwHandle, data);
-				break;
+		case HEADER_GD_ADD_MONARCH_MONEY:
+			AddMonarchMoney(peer, dwHandle, data);
+			break;
 
-			case HEADER_GD_DEC_MONARCH_MONEY:
-				DecMonarchMoney(peer, dwHandle, data);
-				break;
+		case HEADER_GD_DEC_MONARCH_MONEY:
+			DecMonarchMoney(peer, dwHandle, data);
+			break;
 
-			case HEADER_GD_TAKE_MONARCH_MONEY:
-				TakeMonarchMoney(peer, dwHandle, data);
-				break;
+		case HEADER_GD_TAKE_MONARCH_MONEY:
+			TakeMonarchMoney(peer, dwHandle, data);
+			break;
 
-			case HEADER_GD_COME_TO_VOTE:
-				ComeToVote(peer, dwHandle, data);
-				break;
+		case HEADER_GD_COME_TO_VOTE:
+			ComeToVote(peer, dwHandle, data);
+			break;
 
-			case HEADER_GD_RMCANDIDACY: ///< ĺ  ()
-				RMCandidacy(peer, dwHandle, data);
-				break;
+		case HEADER_GD_RMCANDIDACY: ///< ĺ  ()
+			RMCandidacy(peer, dwHandle, data);
+			break;
 
-			case HEADER_GD_SETMONARCH: ///< ּ ()
-				SetMonarch(peer, dwHandle, data);
-				break;
+		case HEADER_GD_SETMONARCH: ///< ּ ()
+			SetMonarch(peer, dwHandle, data);
+			break;
 
-			case HEADER_GD_RMMONARCH: ///< ֻ
-				RMMonarch(peer, dwHandle, data);
-				break;
-				// END_MONARCH
+		case HEADER_GD_RMMONARCH: ///< ֻ
+			RMMonarch(peer, dwHandle, data);
+			break;
+			// END_MONARCH
 
-			case HEADER_GD_CHANGE_MONARCH_LORD:
-				ChangeMonarchLord(peer, dwHandle, (TPacketChangeMonarchLord*)data);
-				break;
+		case HEADER_GD_CHANGE_MONARCH_LORD:
+			ChangeMonarchLord(peer, dwHandle, (TPacketChangeMonarchLord*)data);
+			break;
 
-			case HEADER_GD_BLOCK_COUNTRY_IP:
-				sys_log(0, "HEADER_GD_BLOCK_COUNTRY_IP received");
-				CBlockCountry::instance().SendBlockedCountryIp(peer);
-				CBlockCountry::instance().SendBlockException(peer);
-				break;
+		case HEADER_GD_BLOCK_COUNTRY_IP:
+			sys_log(0, "HEADER_GD_BLOCK_COUNTRY_IP received");
+			CBlockCountry::instance().SendBlockedCountryIp(peer);
+			CBlockCountry::instance().SendBlockException(peer);
+			break;
 
-			case HEADER_GD_BLOCK_EXCEPTION:
-				sys_log(0, "HEADER_GD_BLOCK_EXCEPTION received");
-				BlockException((TPacketBlockException*)data);
-				break;
+		case HEADER_GD_BLOCK_EXCEPTION:
+			sys_log(0, "HEADER_GD_BLOCK_EXCEPTION received");
+			BlockException((TPacketBlockException*)data);
+			break;
 
-			case HEADER_GD_REQ_SPARE_ITEM_ID_RANGE:
-				SendSpareItemIDRange(peer);
-				break;
+		case HEADER_GD_REQ_SPARE_ITEM_ID_RANGE:
+			SendSpareItemIDRange(peer);
+			break;
 
-			case HEADER_GD_REQ_CHANGE_GUILD_MASTER:
-				GuildChangeMaster((TPacketChangeGuildMaster*)data);
-				break;
+		case HEADER_GD_REQ_CHANGE_GUILD_MASTER:
+			GuildChangeMaster((TPacketChangeGuildMaster*)data);
+			break;
 
-			case HEADER_GD_UPDATE_HORSE_NAME:
-				UpdateHorseName((TPacketUpdateHorseName*)data, peer);
-				break;
+		case HEADER_GD_UPDATE_HORSE_NAME:
+			UpdateHorseName((TPacketUpdateHorseName*)data, peer);
+			break;
 
-			case HEADER_GD_REQ_HORSE_NAME:
-				AckHorseName(*(DWORD*)data, peer);
-				break;
+		case HEADER_GD_REQ_HORSE_NAME:
+			AckHorseName(*(DWORD*)data, peer);
+			break;
 
-			case HEADER_GD_DC:
-				DeleteLoginKey((TPacketDC*)data);
-				break;
+		case HEADER_GD_DC:
+			DeleteLoginKey((TPacketDC*)data);
+			break;
 
-			case HEADER_GD_VALID_LOGOUT:
-				ResetLastPlayerID((TPacketNeedLoginLogInfo*)data);
-				break;
+		case HEADER_GD_VALID_LOGOUT:
+			ResetLastPlayerID((TPacketNeedLoginLogInfo*)data);
+			break;
 
-			case HEADER_GD_REQUEST_CHARGE_CASH:
-				ChargeCash((TRequestChargeCash*)data);
-				break;
+		case HEADER_GD_REQUEST_CHARGE_CASH:
+			ChargeCash((TRequestChargeCash*)data);
+			break;
 
-				// delete gift notify icon
-			case HEADER_GD_DELETE_AWARDID:
-				DeleteAwardId((TPacketDeleteAwardID*)data);
-				break;
+			// delete gift notify icon
+		case HEADER_GD_DELETE_AWARDID:
+			DeleteAwardId((TPacketDeleteAwardID*)data);
+			break;
 
-			case HEADER_GD_UPDATE_CHANNELSTATUS:
-				UpdateChannelStatus((SChannelStatus*)data);
-				break;
+		case HEADER_GD_UPDATE_CHANNELSTATUS:
+			UpdateChannelStatus((SChannelStatus*)data);
+			break;
 
-			case HEADER_GD_REQUEST_CHANNELSTATUS:
-				RequestChannelStatus(peer, dwHandle);
-				break;
+		case HEADER_GD_REQUEST_CHANNELSTATUS:
+			RequestChannelStatus(peer, dwHandle);
+			break;
 
-#if defined(__MOVE_CHANNEL__)
-			case HEADER_GD_FIND_CHANNEL:
-				FindChannel(peer, dwHandle, (TPacketChangeChannel*)data);
-				break;
-#endif
+#if defined(__GUILD_DRAGONLAIR_PARTY_SYSTEM__)
+		case HEADER_GD_GUILD_DUNGEON:
+			GuildDungeon((TPacketGDGuildDungeon*)data);
+			break;
 
-#if defined(__GEM_SHOP__)
-			case HEADER_GD_GEM_SHOP_LOAD:
-				LoadGemShop(peer, dwHandle, (TGemShopLoad*)data);
-				break;
+		case HEADER_GD_GUILD_DUNGEON_CD:
+			GuildDungeonGD((TPacketGDGuildDungeonCD*)data);
+			break;
 
-			case HEADER_GD_GEM_SHOP_UPDATE:
-				UpdateGemShop(peer, dwHandle, (TGemShopTable*)data);
-				break;
+		case HEADER_GD_GUILD_DUNGEON_ST:
+			GuildDungeonST((TPacketGDGuildDungeonST*)data);
+			break;
 #endif
 
-#if defined(__EXPRESSING_EMOTIONS__)
-			case HEADER_GD_EMOTE_LOAD:
-				QUERY_EMOTE_LOAD(peer, dwHandle, (TPacketGDEmote*)data);
-				break;
-
-			case HEADER_GD_EMOTE_CLEAR:
-				QUERY_EMOTE_CLEAR(peer, dwHandle, (TPacketGDEmote*)data);
-				break;
-
-			case HEADER_GD_EMOTE_ADD:
-				QUERY_EMOTE_ADD(peer, dwHandle, (TPacketGDEmote*)data);
-				break;
+#if defined(__MOVE_CHANNEL__)
+		case HEADER_GD_FIND_CHANNEL:
+			FindChannel(peer, dwHandle, (TPacketChangeChannel*)data);
+			break;
 #endif
 
-#if defined(__MAILBOX__)
-			case HEADER_GD_MAILBOX_LOAD:
-				QUERY_MAILBOX_LOAD(peer, dwHandle, (TMailBox*)data);
-				break;
-
-			case HEADER_GD_MAILBOX_CHECK_NAME:
-				QUERY_MAILBOX_CHECK_NAME(peer, dwHandle, (TMailBox*)data);
-				break;
-
-			case HEADER_GD_MAILBOX_WRITE:
-				QUERY_MAILBOX_WRITE(peer, dwHandle, (TMailBoxTable*)data);
-				break;
-
-			case HEADER_GD_MAILBOX_DELETE:
-				QUERY_MAILBOX_DELETE(peer, dwHandle, (TMailBox*)data);
-				break;
-
-			case HEADER_GD_MAILBOX_CONFIRM:
-				QUERY_MAILBOX_CONFIRM(peer, dwHandle, (TMailBox*)data);
-				break;
-
-			case HEADER_GD_MAILBOX_GET:
-				QUERY_MAILBOX_GET(peer, dwHandle, (TMailBox*)data);
-				break;
-
-			case HEADER_GD_MAILBOX_UNREAD:
-				QUERY_MAILBOX_UNREAD(peer, dwHandle, (TMailBox*)data);
-				break;
+#if defined(__SKILL_COLOR_SYSTEM__)
+		case HEADER_GD_SKILL_COLOR_SAVE:
+			QUERY_SKILL_COLOR_SAVE(data);
+			break;
 #endif
 
-#ifdef __SHOP_SEARCH__
-			case HEADER_GD_SHOP_SEARCH_REGISTER_ITEM:
-				CShopSearchManager::Instance().RecvRegisterItem(peer, *reinterpret_cast<const TShopSearchItem*>(data));
-				break;
-
-			case HEADER_GD_SHOP_SEARCH_UNREGISTER_ITEM:
-				CShopSearchManager::Instance().RecvUnregisterItem(*reinterpret_cast<const TShopSearchItem*>(data));
-				break;
-
-			case HEADER_GD_SHOP_SEARCH_SOLD_ITEM:
-				CShopSearchManager::Instance().RecvSoldItem(*reinterpret_cast<const TPacketGDShopSearchSoldItem*>(data));
-				break;
-
-			case HEADER_GD_SHOP_SEARCH_BY_NAME:
-				CShopSearchManager::Instance().RecvSearchByName(peer, dwHandle, *reinterpret_cast<const TPacketGDShopSearchByName*>(data));
-				break;
-
-			case HEADER_GD_SHOP_SEARCH_BY_OPTIONS:
-			{
-				const TPacketGDShopSearchByOptions& packet = *reinterpret_cast<const TPacketGDShopSearchByOptions*>(data);
-				data += sizeof(TPacketGDShopSearchByOptions);
-				const TShopSearchItemType* itemTypeFlags = (const TShopSearchItemType*)data;
-				data += sizeof(TShopSearchItemType) * packet.options.typeFlagCount;
-				CShopSearchManager::Instance().RecvSearchByOptions(peer, dwHandle, packet, itemTypeFlags, (const DWORD*)data);
-			}
+		case HEADER_GD_REQUEST_CHANGE_LANGUAGE:
+			ChangeLanguage((TRequestChangeLanguage*)data);
+			break;
+			
+#ifdef __GROWTH_PET_SYSTEM__
+		case HEADER_GD_GROWTH_PET_SAVE:
+			QUERY_GROWTH_PET_SAVE(peer, data);
 			break;
 
-			case HEADER_GD_SHOP_SEARCH_REQUEST_BUY:
-				CShopSearchManager::Instance().RecvBuyItem(peer, dwHandle, *reinterpret_cast<const TPacketGDShopSearchRequestBuy*>(data));
-				break;
-
-			case HEADER_GD_SHOP_SEARCH_BUY_FROM_SHOP_ERROR:
-				CShopSearchManager::Instance().RecvBuyFromShopError(*reinterpret_cast<const TPacketDGShopSearchBuyFromShop*>(data));
-				break;
-
-			case HEADER_GD_SHOP_SEARCH_BOUGHT_FROM_SHOP:
-				CShopSearchManager::Instance().RecvBoughtFromShop(dwHandle, *reinterpret_cast<const TPacketGDShopSearchBoughtFromShop*>(data));
-				break;
-
-			case HEADER_GD_SHOP_SEARCH_REQUEST_SOLD_INFO:
-				CShopSearchManager::Instance().RecvRequestSoldInfo(peer, dwHandle, *reinterpret_cast<const DWORD*>(data));
-				break;
-
-			case HEADER_GD_SHOP_SEARCH_RELOAD_AVERAGE:
-				CShopSearchManager::Instance().Initialize();
-				break;
+		case HEADER_GD_GROWTH_PET_DELETE:
+			QUERY_GROWTH_PET_DELETE(peer, data);
+			break;
 #endif
 
-#ifdef __GROWTH_PET_SYSTEM__
-			case HEADER_GD_GROWTH_PET_SAVE:
-				QUERY_GROWTH_PET_SAVE(peer, data);
-				break;
+#if defined(__MAILBOX__)
+		case HEADER_GD_MAILBOX_LOAD:
+			QUERY_MAILBOX_LOAD(peer, dwHandle, (TMailBox*)data);
+			break;
 
-			case HEADER_GD_GROWTH_PET_DELETE:
-				QUERY_GROWTH_PET_DELETE(peer, data);
-				break;
-#endif
+		case HEADER_GD_MAILBOX_CHECK_NAME:
+			QUERY_MAILBOX_CHECK_NAME(peer, dwHandle, (TMailBox*)data);
+			break;
 
-#ifdef __OFFLINE_SHOP__
-			case HEADER_GD_REQUEST_OFFLINE_SHOP_ID:
-				RequestOfflineShopId(peer, *reinterpret_cast<const uint32_t*>(data));
-				break;
+		case HEADER_GD_MAILBOX_WRITE:
+			QUERY_MAILBOX_WRITE(peer, dwHandle, (TMailBoxTable*)data);
+			break;
 
-			case HEADER_GD_OFFLINE_SHOP_SAVE:
-				SaveOfflineShop(*reinterpret_cast<const TOfflineShop*>(data));
-				break;
+		case HEADER_GD_MAILBOX_DELETE:
+			QUERY_MAILBOX_DELETE(peer, dwHandle, (TMailBox*)data);
+			break;
 
-			case HEADER_GD_OFFLINE_SHOP_SAVE_ITEM:
-				SaveOfflineShopItem(*reinterpret_cast<const TOfflineShopItem*>(data));
-				break;
+		case HEADER_GD_MAILBOX_CONFIRM:
+			QUERY_MAILBOX_CONFIRM(peer, dwHandle, (TMailBox*)data);
+			break;
 
-			case HEADER_GD_OFFLINE_SHOP_DESTROY:
-				DestroyOfflineShop(*reinterpret_cast<const uint32_t*>(data));
-				break;
-#endif
+		case HEADER_GD_MAILBOX_GET:
+			QUERY_MAILBOX_GET(peer, dwHandle, (TMailBox*)data);
+			break;
 
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-			case HEADER_GD_SAVE_EXT_BATTLE_PASS:
-				QUERY_SAVE_EXT_BATTLE_PASS(peer, dwHandle, (TPlayerExtBattlePassMission*)data);
-				break;
+		case HEADER_GD_MAILBOX_UNREAD:
+			QUERY_MAILBOX_UNREAD(peer, dwHandle, (TMailBox*)data);
+			break;
 #endif
 
-			default:
-				sys_err("Unknown header (header: %d handle: %d length: %d)", header, dwHandle, dwLength);
-				break;
+		default:
+			sys_err("Unknown header (header: %d handle: %d length: %d)", header, dwHandle, dwLength);
+			break;
 		}
 	}
 
@@ -3121,7 +2937,7 @@
 CPeer* CClientManager::GetPeer(IDENT ident)
 {
 	// for (TPeerList::const_iterator i = m_peerList.begin(); i != m_peerList.end(); ++i)
-	for (auto i = m_peerList.begin(); i != m_peerList.end(); ++i)
+	for (itertype(m_peerList) i = m_peerList.begin(); i != m_peerList.end(); ++i)
 	{
 		CPeer* tmp = *i;
 
@@ -3155,20 +2971,20 @@
 
 	switch (qi->iType)
 	{
-		case QID_ITEM_AWARD_LOAD:
-			ItemAwardManager::instance().Load(msg);
-			delete qi;
-			return true;
-
-		case QID_GUILD_RANKING:
-			CGuildManager::instance().ResultRanking(msg->Get()->pSQLResult);
-			break;
+	case QID_ITEM_AWARD_LOAD:
+		ItemAwardManager::instance().Load(msg);
+		delete qi;
+		return true;
 
-			// MYSHOP_PRICE_LIST
-		case QID_ITEMPRICE_LOAD_FOR_UPDATE:
-			RESULT_PRICELIST_LOAD_FOR_UPDATE(msg);
-			break;
-			// END_OF_MYSHOP_PRICE_LIST
+	case QID_GUILD_RANKING:
+		CGuildManager::instance().ResultRanking(msg->Get()->pSQLResult);
+		break;
+
+		// MYSHOP_PRICE_LIST
+	case QID_ITEMPRICE_LOAD_FOR_UPDATE:
+		RESULT_PRICELIST_LOAD_FOR_UPDATE(msg);
+		break;
+		// END_OF_MYSHOP_PRICE_LIST
 	}
 
 	if (!peer)
@@ -3180,83 +2996,86 @@
 
 	switch (qi->iType)
 	{
-		case QID_PLAYER:
-		case QID_ITEM:
-		case QID_QUEST:
-		case QID_AFFECT:
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-		case QID_EXT_BATTLE_PASS:
+	case QID_PLAYER:
+	case QID_ITEM:
+	case QID_QUEST:
+	case QID_AFFECT:
+#if defined(__SKILL_COLOR_SYSTEM__)
+	case QID_SKILL_COLOR:
 #endif
 #ifdef __GROWTH_PET_SYSTEM__
-		case QID_GROWTH_PET:
+	case QID_GROWTH_PET:
 #endif
-			RESULT_COMPOSITE_PLAYER(peer, msg, qi->iType);
-			break;
-
-		case QID_LOGIN:
-			RESULT_LOGIN(peer, msg);
-			break;
-
-		case QID_SAFEBOX_LOAD:
-			sys_log(0, "QUERY_RESULT: HEADER_GD_SAFEBOX_LOAD");
-			RESULT_SAFEBOX_LOAD(peer, msg);
-			break;
-
-		case QID_SAFEBOX_CHANGE_SIZE:
-			sys_log(0, "QUERY_RESULT: HEADER_GD_SAFEBOX_CHANGE_SIZE");
-			RESULT_SAFEBOX_CHANGE_SIZE(peer, msg);
-			break;
+		RESULT_COMPOSITE_PLAYER(peer, msg, qi->iType);
+		break;
 
-		case QID_SAFEBOX_CHANGE_PASSWORD:
-			sys_log(0, "QUERY_RESULT: HEADER_GD_SAFEBOX_CHANGE_PASSWORD %p", msg);
-			RESULT_SAFEBOX_CHANGE_PASSWORD(peer, msg);
-			break;
-
-		case QID_SAFEBOX_CHANGE_PASSWORD_SECOND:
-			sys_log(0, "QUERY_RESULT: HEADER_GD_SAFEBOX_CHANGE_PASSWORD %p", msg);
-			RESULT_SAFEBOX_CHANGE_PASSWORD_SECOND(peer, msg);
-			break;
-
-		case QID_HIGHSCORE_REGISTER:
-			sys_log(0, "QUERY_RESULT: HEADER_GD_HIGHSCORE_REGISTER %p", msg);
-			RESULT_HIGHSCORE_REGISTER(peer, msg);
-			break;
-
-		case QID_SAFEBOX_SAVE:
-		case QID_ITEM_SAVE:
-		case QID_ITEM_DESTROY:
-		case QID_QUEST_SAVE:
-		case QID_PLAYER_SAVE:
-		case QID_ITEM_AWARD_TAKEN:
+	case QID_LOGIN:
+		RESULT_LOGIN(peer, msg);
+		break;
+
+	case QID_SAFEBOX_LOAD:
+		sys_log(0, "QUERY_RESULT: HEADER_GD_SAFEBOX_LOAD");
+		RESULT_SAFEBOX_LOAD(peer, msg);
+		break;
+
+	case QID_SAFEBOX_CHANGE_SIZE:
+		sys_log(0, "QUERY_RESULT: HEADER_GD_SAFEBOX_CHANGE_SIZE");
+		RESULT_SAFEBOX_CHANGE_SIZE(peer, msg);
+		break;
+
+	case QID_SAFEBOX_CHANGE_PASSWORD:
+		sys_log(0, "QUERY_RESULT: HEADER_GD_SAFEBOX_CHANGE_PASSWORD %p", msg);
+		RESULT_SAFEBOX_CHANGE_PASSWORD(peer, msg);
+		break;
+
+	case QID_SAFEBOX_CHANGE_PASSWORD_SECOND:
+		sys_log(0, "QUERY_RESULT: HEADER_GD_SAFEBOX_CHANGE_PASSWORD %p", msg);
+		RESULT_SAFEBOX_CHANGE_PASSWORD_SECOND(peer, msg);
+		break;
+
+	case QID_HIGHSCORE_REGISTER:
+		sys_log(0, "QUERY_RESULT: HEADER_GD_HIGHSCORE_REGISTER %p", msg);
+		RESULT_HIGHSCORE_REGISTER(peer, msg);
+		break;
+
+	case QID_SAFEBOX_SAVE:
+	case QID_ITEM_SAVE:
+	case QID_ITEM_DESTROY:
+	case QID_QUEST_SAVE:
+	case QID_PLAYER_SAVE:
+	case QID_ITEM_AWARD_TAKEN:
+#if defined(__SKILL_COLOR_SYSTEM__)
+	case QID_SKILL_COLOR_SAVE:
+#endif
 #ifdef __GROWTH_PET_SYSTEM__
-		case QID_GROWTH_PET_SAVE:
-		case QID_GROWTH_PET_DELETE:
+	case QID_GROWTH_PET_SAVE:
+	case QID_GROWTH_PET_DELETE:
 #endif
-			break;
-
-			// PLAYER_INDEX_CREATE_BUG_FIX
-		case QID_PLAYER_INDEX_CREATE:
-			RESULT_PLAYER_INDEX_CREATE(peer, msg);
-			break;
-			// END_PLAYER_INDEX_CREATE_BUG_FIX
+		break;
 
-		case QID_PLAYER_DELETE:
-			__RESULT_PLAYER_DELETE(peer, msg);
-			break;
-
-		case QID_LOGIN_BY_KEY:
-			RESULT_LOGIN_BY_KEY(peer, msg);
-			break;
-
-			// MYSHOP_PRICE_LIST
-		case QID_ITEMPRICE_LOAD:
-			RESULT_PRICELIST_LOAD(peer, msg);
-			break;
-			// END_OF_MYSHOP_PRICE_LIST
-
-		default:
-			sys_log(0, "CClientManager::AnalyzeQueryResult unknown query result type: %d, str: %s", qi->iType, msg->stQuery.c_str());
-			break;
+		// PLAYER_INDEX_CREATE_BUG_FIX
+	case QID_PLAYER_INDEX_CREATE:
+		RESULT_PLAYER_INDEX_CREATE(peer, msg);
+		break;
+		// END_PLAYER_INDEX_CREATE_BUG_FIX
+
+	case QID_PLAYER_DELETE:
+		__RESULT_PLAYER_DELETE(peer, msg);
+		break;
+
+	case QID_LOGIN_BY_KEY:
+		RESULT_LOGIN_BY_KEY(peer, msg);
+		break;
+
+		// MYSHOP_PRICE_LIST
+	case QID_ITEMPRICE_LOAD:
+		RESULT_PRICELIST_LOAD(peer, msg);
+		break;
+		// END_OF_MYSHOP_PRICE_LIST
+
+	default:
+		sys_log(0, "CClientManager::AnalyzeQueryResult unknown query result type: %d, str: %s", qi->iType, msg->stQuery.c_str());
+		break;
 	}
 
 	delete qi;
@@ -3317,6 +3136,7 @@
 		{
 			if (g_test_server)
 			{
+
 				if (!(thecore_heart->pulse % thecore_heart->passes_per_sec * 10))
 
 				{
@@ -3375,49 +3195,38 @@
 
 			memset(&thecore_profiler[0], 0, sizeof(thecore_profiler));
 
-#if defined(__EXPRESSING_EMOTIONS__)
-			if (!(thecore_heart->pulse % (thecore_heart->passes_per_sec * m_iEmoteDumpDelay)))
-				CClientManager::instance().QUERY_EMOTE_DUMP();
-#endif
-
 #if defined(__MAILBOX__)
 			if (!(thecore_heart->pulse % (thecore_heart->passes_per_sec * m_iMailBoxBackupSec)))
 				CClientManager::instance().MAILBOX_BACKUP();
 #endif
 
-#if defined(__GEM_SHOP__)
-			if (!(thecore_heart->pulse % (thecore_heart->passes_per_sec * m_iGemShopFlushDelay)))
-				CClientManager::instance().FlushGemShop();
-#endif
-
 			if (!(thecore_heart->pulse % (thecore_heart->passes_per_sec * 3600)))
 				UsageLog();
 
 			m_iCacheFlushCount = 0;
 
+#if defined(__SKILL_COLOR_SYSTEM__)
+			// Skill Color fush
+			UpdateSkillColorCache();
+#endif
+
 			// ÷̾ ÷
 			UpdatePlayerCache();
 			//  ÷
 			UpdateItemCache();
+#ifdef __GROWTH_PET_SYSTEM__
+			UpdateGrowthPetCache();
+#endif
 			//α׾ƿ ó- ĳ ÷
 			UpdateLogoutPlayer();
 
 			// MYSHOP_PRICE_LIST
 			UpdateItemPriceListCache();
 			// END_OF_MYSHOP_PRICE_LIST
-#ifdef __OFFLINE_SHOP__
-			UpdateOfflineShopCache();
-			UpdateOfflineShopItemCache();
-#endif
-#ifdef __GROWTH_PET_SYSTEM__
-			UpdateGrowthPetCache();
-#endif
+
 			CGuildManager::instance().Update();
 			CPrivManager::instance().Update();
 			marriage::CManager::instance().Update();
-#ifdef __SHOP_SEARCH__
-			CShopSearchManager::Instance().Update();
-#endif
 		}
 
 		if (!(thecore_heart->pulse % (thecore_heart->passes_per_sec * 5)))
@@ -3430,12 +3239,13 @@
 			/*
 			char buf[4096 + 1];
 			int len
+			itertype(g_query_info.m_map_info) it;
 
 			/////////////////////////////////////////////////////////////////
 			buf[0] = '\0';
 			len = 0;
 
-			auto it = g_query_info.m_map_info.begin();
+			it = g_query_info.m_map_info.begin();
 
 			int count = 0;
 
@@ -3488,7 +3298,7 @@
 			CMoneyLog::instance().Save();
 		}
 
-#if defined(__ENVIRONMENT_SYSTEM__)
+#if defined(__ENVIRONMENT__)
 		static bool OnSetup = true;
 		if (!(thecore_heart->pulse % (thecore_heart->passes_per_sec * 60 * 20)) || OnSetup)
 		{
@@ -3523,43 +3333,43 @@
 
 		switch (fdwatch_check_event(m_fdWatcher, peer->GetFd(), idx))
 		{
-			case FDW_READ:
-				if (peer->Recv() < 0)
-				{
-					sys_err("Recv failed");
-					RemovePeer(peer);
-				}
-				else
-				{
-					if (peer == m_pkAuthPeer)
-						if (g_log)
-							sys_log(0, "AUTH_PEER_READ: size %d", peer->GetRecvLength());
-
-					ProcessPackets(peer);
-				}
-				break;
-
-			case FDW_WRITE:
+		case FDW_READ:
+			if (peer->Recv() < 0)
+			{
+				sys_err("Recv failed");
+				RemovePeer(peer);
+			}
+			else
+			{
 				if (peer == m_pkAuthPeer)
 					if (g_log)
-						sys_log(0, "AUTH_PEER_WRITE: size %d", peer->GetSendLength());
+						sys_log(0, "AUTH_PEER_READ: size %d", peer->GetRecvLength());
 
-				if (peer->Send() < 0)
-				{
-					sys_err("Send failed");
-					RemovePeer(peer);
-				}
+				ProcessPackets(peer);
+			}
+			break;
 
-				break;
+		case FDW_WRITE:
+			if (peer == m_pkAuthPeer)
+				if (g_log)
+					sys_log(0, "AUTH_PEER_WRITE: size %d", peer->GetSendLength());
 
-			case FDW_EOF:
+			if (peer->Send() < 0)
+			{
+				sys_err("Send failed");
 				RemovePeer(peer);
-				break;
+			}
 
-			default:
-				sys_err("fdwatch_check_fd returned unknown result");
-				RemovePeer(peer);
-				break;
+			break;
+
+		case FDW_EOF:
+			RemovePeer(peer);
+			break;
+
+		default:
+			sys_err("fdwatch_check_fd returned unknown result");
+			RemovePeer(peer);
+			break;
 		}
 	}
 
@@ -3569,11 +3379,11 @@
 		int c = _getch();
 		switch (c)
 		{
-			case 0x1b: // Esc
-				return 0; // shutdown
-				break;
-			default:
-				break;
+		case 0x1b: // Esc
+			return 0; // shutdown
+			break;
+		default:
+			break;
 		}
 	}
 #endif
@@ -3601,7 +3411,7 @@
 void CClientManager::ForwardPacket(BYTE header, const void* data, int size, BYTE bChannel, CPeer* except)
 {
 	//for (TPeerList::const_iterator it = m_peerList.begin(); it != m_peerList.end(); ++it)
-	for (auto it = m_peerList.begin(); it != m_peerList.end(); ++it)
+	for (itertype(m_peerList) it = m_peerList.begin(); it != m_peerList.end(); ++it)
 	{
 		CPeer* peer = *it;
 
@@ -3647,7 +3457,7 @@
 	//  ID ʱȭ Ѵ.
 	if (!CConfig::instance().GetTwoValue("ITEM_ID_RANGE", &dwMin, &dwMax))
 	{
-		sys_err("config.txt: Cannot find ITEM_ID_RANGE [start_item_id] [end_item_id]");
+		sys_err("conf.txt: Cannot find ITEM_ID_RANGE [start_item_id] [end_item_id]");
 		return false;
 	}
 
@@ -3695,7 +3505,7 @@
 
 	MYSQL_ROW row = NULL;
 
-	for (; (row = mysql_fetch_row(pMsg->Get()->pSQLResult)) != NULL;)
+	for (int n = 0; (row = mysql_fetch_row(pMsg->Get()->pSQLResult)) != NULL; ++n)
 	{
 		int col = 0;
 		tLocale locale;
@@ -4181,7 +3991,7 @@
 		sizeof(WORD) + sizeof(WORD) + 16 * vHost.size();
 
 	//for (TPeerList::const_iterator it = m_peerList.begin(); it != m_peerList.end(); ++it)
-	for (auto it = m_peerList.begin(); it != m_peerList.end(); ++it)
+	for (itertype(m_peerList) it = m_peerList.begin(); it != m_peerList.end(); ++it)
 	{
 		CPeer* peer = *it;
 
@@ -4224,7 +4034,9 @@
 
 void CClientManager::UpdateItemCacheSet(DWORD pid)
 {
-	auto it = m_map_pkItemCacheSetPtr.find(pid);
+	// TItemCacheSetPtrMap::const_iterator it = m_map_pkItemCacheSetPtr.find(pid);
+	itertype(m_map_pkItemCacheSetPtr) it = m_map_pkItemCacheSetPtr.find(pid);
+
 	if (it == m_map_pkItemCacheSetPtr.end())
 	{
 		if (g_test_server)
@@ -4300,7 +4112,7 @@
 			sys_log(0, "[MONARCH_CANDIDACY] Success %d %s", pid, data);
 
 		// for (TPeerList::const_iterator it = m_peerList.begin(); it != m_peerList.end(); ++it)
-		for (auto it = m_peerList.begin(); it != m_peerList.end(); ++it)
+		for (itertype(m_peerList) it = m_peerList.begin(); it != m_peerList.end(); ++it)
 		{
 			CPeer* p = *it;
 
@@ -4340,7 +4152,7 @@
 	CMonarch::instance().AddMoney(Empire, Money);
 
 	// for (TPeerList::const_iterator it = m_peerList.begin(); it != m_peerList.end(); ++it)
-	for (auto it = m_peerList.begin(); it != m_peerList.end(); ++it)
+	for (itertype(m_peerList) it = m_peerList.begin(); it != m_peerList.end(); ++it)
 	{
 		CPeer* p = *it;
 
@@ -4377,7 +4189,7 @@
 	CMonarch::instance().DecMoney(Empire, Money);
 
 	// for (TPeerList::const_iterator it = m_peerList.begin(); it != m_peerList.end(); ++it)
-	for (auto it = m_peerList.begin(); it != m_peerList.end(); ++it)
+	for (itertype(m_peerList) it = m_peerList.begin(); it != m_peerList.end(); ++it)
 	{
 		CPeer* p = *it;
 
@@ -4445,7 +4257,7 @@
 	if (1 == iRet)
 	{
 		// for (TPeerList::const_iterator it = m_peerList.begin(); it != m_peerList.end(); ++it)
-		for (auto it = m_peerList.begin(); it != m_peerList.end(); ++it)
+		for (itertype(m_peerList) it = m_peerList.begin(); it != m_peerList.end(); ++it)
 		{
 			CPeer* p = *it;
 
@@ -4489,7 +4301,7 @@
 	if (1 == iRet)
 	{
 		// for (TPeerList::const_iterator it = m_peerList.begin(); it != m_peerList.end(); ++it)
-		for (auto it = m_peerList.begin(); it != m_peerList.end(); ++it)
+		for (itertype(m_peerList) it = m_peerList.begin(); it != m_peerList.end(); ++it)
 		{
 			CPeer* p = *it;
 
@@ -4535,7 +4347,7 @@
 	if (1 == iRet)
 	{
 		// for (TPeerList::const_iterator it = m_peerList.begin(); it != m_peerList.end(); ++it)
-		for (auto it = m_peerList.begin(); it != m_peerList.end(); ++it)
+		for (itertype(m_peerList) it = m_peerList.begin(); it != m_peerList.end(); ++it)
 		{
 			CPeer* p = *it;
 
@@ -4612,7 +4424,8 @@
 
 			TMonarchInfo* newInfo = CMonarch::instance().GetMonarch();
 
-			for (auto it = m_peerList.begin(); it != m_peerList.end(); ++it)
+			// for (TPeerList::const_iterator it = m_peerList.begin(); it != m_peerList.end(); it++)
+			for (itertype(m_peerList) it = m_peerList.begin(); it != m_peerList.end(); it++)
 			{
 				CPeer* client = *it;
 
@@ -4640,23 +4453,24 @@
 
 		switch (data->cmd)
 		{
-			case BLOCK_EXCEPTION_CMD_ADD:
-				snprintf(buf, sizeof(buf), "INSERT INTO `block_exception` VALUES('%s')", data->login);
-				CDBManager::instance().AsyncQuery(buf, SQL_ACCOUNT);
-				CBlockCountry::instance().AddBlockException(data->login);
-				break;
-			case BLOCK_EXCEPTION_CMD_DEL:
-				snprintf(buf, sizeof(buf), "DELETE FROM `block_exception` WHERE `login` = %s", data->login);
-				CDBManager::instance().AsyncQuery(buf, SQL_ACCOUNT);
-				CBlockCountry::instance().DelBlockException(data->login);
-				break;
-			default:
-				return;
+		case BLOCK_EXCEPTION_CMD_ADD:
+			snprintf(buf, sizeof(buf), "INSERT INTO `block_exception` VALUES('%s')", data->login);
+			CDBManager::instance().AsyncQuery(buf, SQL_ACCOUNT);
+			CBlockCountry::instance().AddBlockException(data->login);
+			break;
+		case BLOCK_EXCEPTION_CMD_DEL:
+			snprintf(buf, sizeof(buf), "DELETE FROM `block_exception` VALUES('%s')", data->login);
+			CDBManager::instance().AsyncQuery(buf, SQL_ACCOUNT);
+			CBlockCountry::instance().DelBlockException(data->login);
+			break;
+		default:
+			return;
 		}
 
 	}
 
-	for (auto it = m_peerList.begin(); it != m_peerList.end(); ++it)
+	// for (TPeerList::const_iterator it = m_peerList.begin(); it != m_peerList.end(); ++it)
+	for (itertype(m_peerList) it = m_peerList.begin(); it != m_peerList.end(); ++it)
 	{
 		CPeer* peer = *it;
 
@@ -4715,11 +4529,20 @@
 	TChannelStatusMap::iterator it = m_mChannelStatus.find(pData->nPort);
 	if (it != m_mChannelStatus.end())
 	{
+#if defined(__CHANNEL_STATUS_UPDATE__)
+		it->second.first = pData->bStatus;
+		it->second.second = pData->iCount;
+#else
 		it->second = pData->bStatus;
+#endif
 	}
 	else
 	{
+#if defined(__CHANNEL_STATUS_UPDATE__)
+		m_mChannelStatus.emplace(pData->nPort, std::make_pair(pData->bStatus, pData->iCount));
+#else
 		m_mChannelStatus.insert(TChannelStatusMap::value_type(pData->nPort, pData->bStatus));
+#endif
 	}
 }
 
@@ -4728,11 +4551,20 @@
 	const int nSize = m_mChannelStatus.size();
 	peer->EncodeHeader(HEADER_DG_RESPOND_CHANNELSTATUS, dwHandle, sizeof(TChannelStatus) * nSize + sizeof(int));
 	peer->Encode(&nSize, sizeof(int));
-	for (TChannelStatusMap::iterator it = m_mChannelStatus.begin(); it != m_mChannelStatus.end(); ++it)
+#if defined(__CHANNEL_STATUS_UPDATE__)
+	for (const auto& v : m_mChannelStatus)
+	{
+		peer->Encode(&v.first, sizeof(decltype(v.first)));
+		peer->Encode(&v.second.first, sizeof(decltype(v.second.first)));
+		peer->Encode(&v.second.second, sizeof(decltype(v.second.second)));
+	}
+#else
+	for (TChannelStatusMap::iterator it = m_mChannelStatus.begin(); it != m_mChannelStatus.end(); it++)
 	{
 		peer->Encode(&it->first, sizeof(short));
 		peer->Encode(&it->second, sizeof(BYTE));
 	}
+#endif
 }
 
 void CClientManager::ResetLastPlayerID(const TPacketNeedLoginLogInfo* data)
@@ -4742,6 +4574,7 @@
 	if (NULL != pkLD)
 	{
 		pkLD->SetLastPlayerID(0);
+		pkLD->GetAccountRef().bLanguage = data->bLanguage;
 	}
 }
 
@@ -4764,6 +4597,23 @@
 	CDBManager::Instance().AsyncQuery(szQuery, SQL_ACCOUNT);
 }
 
+#if defined(__GUILD_DRAGONLAIR_PARTY_SYSTEM__)
+void CClientManager::GuildDungeon(TPacketGDGuildDungeon* sPacket)
+{
+	CGuildManager::instance().Dungeon(sPacket->dwGuildID, sPacket->bChannel, sPacket->lMapIndex);
+}
+
+void CClientManager::GuildDungeonGD(TPacketGDGuildDungeonCD* sPacket)
+{
+	CGuildManager::instance().DungeonCooldown(sPacket->dwGuildID, sPacket->dwTime);
+}
+
+void CClientManager::GuildDungeonST(TPacketGDGuildDungeonST* sPacket)
+{
+	CGuildManager::instance().DungeonStart(sPacket->dwGuildID, sPacket->dwDungeon_start);
+}
+#endif
+
 #if defined(__MOVE_CHANNEL__)
 void CClientManager::FindChannel(CPeer* requestPeer, DWORD dwHandle, TPacketChangeChannel* p)
 {
@@ -4774,7 +4624,7 @@
 	WORD wPort = 0;
 
 	// for (TPeerList::const_iterator i = m_peerList.begin(); i != m_peerList.end(); ++i)
-	for (auto i = m_peerList.begin(); i != m_peerList.end(); ++i)
+	for (itertype(m_peerList) i = m_peerList.begin(); i != m_peerList.end(); ++i)
 	{
 		CPeer* peer = *i;
 		if (peer->GetChannel() != p->iChannel) // not the channel we are looking for!
@@ -4813,866 +4663,59 @@
 }
 #endif
 
-#if defined(__ENVIRONMENT_SYSTEM__)
-enum DayMode : BYTE { DAY, NIGHT };
-
-static BYTE GetDayMode(int Hour)
-{
-	if (Hour >= 6 && Hour <= 20)
-		return DayMode::DAY;
-	return DayMode::NIGHT;
-}
-
-static bool IsWinter(int Month)
-{
-	return (Month >= 11 || Month <= 0);
-}
-
-void CClientManager::UpdateEnvironment()
-{
-	time_t CurrentTime = time(nullptr);
-	tm* tm = localtime(&CurrentTime);
-
-	auto SendFlag = [&](const char* flag, BYTE val)
-		{
-			TEventFlagMap::const_iterator it = m_map_lEventFlag.find(flag);
-			if ((it != m_map_lEventFlag.end() && it->second == val) == false)
-			{
-				TPacketSetEventFlag p;
-				std::strcpy(p.szFlagName, flag);
-				p.lValue = val;
-				SetEventFlag(&p);
-			}
-		};
-
-	SendFlag("eclipse", GetDayMode(tm->tm_hour));
-	BOOL Winter = IsWinter(tm->tm_mon);
-	for (const auto& Flag : { "xmas_snow" })
-		SendFlag(Flag, Winter);
-}
-#endif
-
-#if defined(__EXPRESSING_EMOTIONS__)
-void CClientManager::QUERY_EMOTE_LOAD(CPeer* pkPeer, DWORD dwHandle, TPacketGDEmote* pTable)
+void CClientManager::ChangeLanguage(const TRequestChangeLanguage* packet)
 {
-	if (pTable == nullptr)
-		return;
-
-	TEmoteTableVector* pVec = nullptr;
-	TPlayerEmoteMap::iterator it = m_map_kPlayerEmote.find(pTable->dwPID);
-	if (it != m_map_kPlayerEmote.end())
-		pVec = &it->second;
+	char szQuery[512];
 
-	if (pVec && !pVec->empty())
+	if (packet->bLanguage > LOCALE_YMIR && packet->bLanguage < LOCALE_MAX_NUM)
 	{
-		const DWORD dwCurrentTime = static_cast<DWORD>(std::time(nullptr));
-		pVec->erase(std::remove_if(pVec->begin(), pVec->end(),
-			[dwCurrentTime](const TPacketGDEmote& rkTable)
-			{
-				return dwCurrentTime > rkTable.dwDuration;
-			}
-		), pVec->end());
-	}
-
-	const WORD wSize = pVec ? static_cast<WORD>(pVec->size()) : 0;
-	const DWORD dwPacketSize = sizeof(WORD) + sizeof(WORD) + sizeof(TPacketGDEmote) * wSize;
-
-	pkPeer->EncodeHeader(HEADER_DG_EMOTE_LOAD, dwHandle, dwPacketSize);
-	pkPeer->EncodeWORD(sizeof(TPacketGDEmote));
-	pkPeer->EncodeWORD(wSize);
-	if (pVec && !pVec->empty())
-		pkPeer->Encode(&(*pVec)[0], sizeof(TPacketGDEmote) * wSize);
-}
-
-void CClientManager::QUERY_EMOTE_CLEAR(CPeer* pkPeer, DWORD dwHandle, TPacketGDEmote* pTable)
-{
-	if (pTable == nullptr)
-		return;
-
-	TPlayerEmoteMap::iterator it = m_map_kPlayerEmote.find(pTable->dwPID);
-	if (it != m_map_kPlayerEmote.end())
-		it->second.clear();
-
-	QUERY_EMOTE_LOAD(pkPeer, dwHandle, pTable);
-}
-
-void CClientManager::QUERY_EMOTE_ADD(CPeer* pkPeer, DWORD dwHandle, TPacketGDEmote* pTable)
-{
-	if (!pkPeer || !pTable)
-		return;
-
-	const DWORD dwCurrentTime = static_cast<DWORD>(std::time(nullptr));
-
-	TPacketGDEmote GDPacket;
-	GDPacket.dwPID = pTable->dwPID;
-	GDPacket.dwVnum = pTable->dwVnum;
-	GDPacket.dwDuration = dwCurrentTime + pTable->dwDuration;
-
-	TPlayerEmoteMap::iterator it = m_map_kPlayerEmote.find(pTable->dwPID);
-	if (it != m_map_kPlayerEmote.end())
-	{
-		TEmoteTableVector& rkVec = it->second;
-		if (rkVec.size() >= SPECIAL_ACTION_SLOT_COUNT)
-		{
-			TPacketGDEmote& rkTable = rkVec[number(0, rkVec.size() - 1)];
-			if (dwCurrentTime >= rkTable.dwDuration)
-				rkTable.dwDuration = dwCurrentTime + pTable->dwDuration;
-			else
-				rkTable.dwDuration += pTable->dwDuration;
-
-			GDPacket.dwVnum = rkTable.dwVnum;
-			GDPacket.dwDuration = rkTable.dwDuration;
-		}
-		else
-		{
-			TEmoteTableVector::iterator itVec = std::find_if(rkVec.begin(), rkVec.end(),
-				[pTable](const TPacketGDEmote& rkTable)
-				{
-					return rkTable.dwVnum == pTable->dwVnum;
-				});
-
-			if (itVec != rkVec.end())
-			{
-				if (dwCurrentTime >= itVec->dwDuration)
-					itVec->dwDuration = dwCurrentTime + pTable->dwDuration;
-				else
-					itVec->dwDuration += pTable->dwDuration;
-
-				GDPacket.dwDuration = itVec->dwDuration;
-			}
-			else
-			{
-				pTable->dwDuration = GDPacket.dwDuration;
-				rkVec.emplace_back(*pTable);
-			}
-		}
+		sprintf(szQuery, "update account set `language` = %d where id = %d", packet->bLanguage, packet->dwAID);
 	}
 	else
 	{
-		pTable->dwDuration = GDPacket.dwDuration;
-		m_map_kPlayerEmote[pTable->dwPID].emplace_back(*pTable);
-	}
-
-	pkPeer->EncodeHeader(HEADER_DG_EMOTE_GET, dwHandle, sizeof(GDPacket));
-	pkPeer->Encode(&GDPacket, sizeof(GDPacket));
-}
-
-void CClientManager::QUERY_EMOTE_DUMP()
-{
-	CDBManager::instance().DirectQuery("TRUNCATE TABLE `player`.`emotions`");
-
-	if (m_map_kPlayerEmote.empty())
-		return;
-
-	char szQuery[1024];
-	const DWORD dwCurrentTime = static_cast<DWORD>(std::time(nullptr));
-
-	for (TPlayerEmoteMap::value_type& it : m_map_kPlayerEmote)
-	{
-		TEmoteTableVector& rkVec = it.second;
-		if (rkVec.empty())
-			continue;
-
-		rkVec.erase(std::remove_if(rkVec.begin(), rkVec.end(),
-			[dwCurrentTime](const TPacketGDEmote& rkTable)
-			{
-				return dwCurrentTime > rkTable.dwDuration;
-			}
-		), rkVec.end());
-
-		for (const TPacketGDEmote& rkTable : rkVec)
-		{
-			snprintf(szQuery, sizeof(szQuery),
-				"REPLACE INTO emotions%s (`pid`, `vnum`, `duration`) VALUES(%d, %d, FROM_UNIXTIME(%d))",
-				GetTablePostfix(), rkTable.dwPID, rkTable.dwVnum, rkTable.dwDuration
-			);
-
-			std::unique_ptr<SQLMsg> pkInsert(CDBManager::instance().DirectQuery(szQuery));
-		}
-	}
-}
-#endif
-
-#if defined(__MAILBOX__)
-void CClientManager::QUERY_MAILBOX_LOAD(CPeer* pkPeer, DWORD dwHandle, TMailBox* p)
-{
-	if (g_log)
-		sys_log(0, "QUERY_MAILBOX (handle: %d ch: %s)", dwHandle, p->szName);
-
-	std::vector<SMailBoxTable>* vec = nullptr;
-	auto it = m_map_mailbox.find(p->szName);
-	if (it != m_map_mailbox.end())
-		vec = &it->second;
-
-	if (vec)
-	{
-		const time_t now = std::time(nullptr);
-
-		vec->erase(std::remove_if(vec->begin(), vec->end(),
-			[now](const TMailBoxTable& mail)
-			{ return mail.bIsDeleted || std::difftime(mail.Message.DeleteTime, now) <= 0; }
-		), vec->end());
-
-		std::sort(vec->begin(), vec->end(),
-			[](const TMailBoxTable& l, const TMailBoxTable& r)
-			{
-				return l.Message.SendTime > r.Message.SendTime;
-			});
-	}
-
-	const WORD size = vec ? static_cast<WORD>(vec->size()) : 0;
-	const DWORD dwPacketSize = sizeof(WORD) + sizeof(WORD) + sizeof(SMailBoxTable) * size;
-
-	pkPeer->EncodeHeader(HEADER_DG_RESPOND_MAILBOX_LOAD, dwHandle, dwPacketSize);
-	pkPeer->EncodeWORD(sizeof(SMailBoxTable));
-	pkPeer->EncodeWORD(size);
-
-	if (vec && vec->empty() == false)
-		pkPeer->Encode(&(*vec)[0], sizeof(SMailBoxTable) * size);
-}
-
-void CClientManager::QUERY_MAILBOX_CHECK_NAME(CPeer* pkPeer, DWORD dwHandle, TMailBox* p)
-{
-	TMailBox t;
-	std::memcpy(t.szName, "", sizeof(t.szName));
-	t.Index = 0; // Index: Mail Count
-
-	static std::unordered_set<std::string> NameSet;
-	bool bFound = NameSet.find(p->szName) != NameSet.end();
-
-	if (bFound == false)
-	{
-		char s_szQuery[128];
-		//snprintf(s_szQuery, sizeof(s_szQuery), "SELECT * FROM player%s WHERE `name` = '%s' LIMIT 1", GetTablePostfix(), p->szName);
-		snprintf(s_szQuery, sizeof(s_szQuery), "SELECT * FROM player%s WHERE `name` = convert('%s' using utf8mb4) collate utf8mb4_bin LIMIT 1", GetTablePostfix(), p->szName);
-		std::unique_ptr<SQLMsg> pMsg(CDBManager::instance().DirectQuery(s_szQuery));
-		bFound = pMsg->Get()->uiNumRows > 0;
-	}
-
-	if (bFound)
-	{
-		NameSet.emplace(p->szName); // player exists, next time we will use this to avoid using mysql.
-		std::memcpy(t.szName, p->szName, sizeof(t.szName));
-		auto it = m_map_mailbox.find(p->szName);
-		if (it != m_map_mailbox.end())
-		{
-			const time_t now = time(nullptr);
-			for (const SMailBoxTable& mail : it->second)
-			{
-				if (mail.bIsDeleted)
-					continue;
-
-				if (std::difftime(mail.Message.DeleteTime, now) <= 0)
-					continue;
-
-				t.Index++;
-			}
-		}
-	}
-
-	pkPeer->EncodeHeader(HEADER_DG_RESPOND_MAILBOX_CHECK_NAME, dwHandle, sizeof(TMailBox));
-	pkPeer->Encode(&t, sizeof(TMailBox));
-}
-
-void CClientManager::QUERY_MAILBOX_WRITE(CPeer* pkPeer, DWORD dwHandle, TMailBoxTable* p)
-{
-	m_map_mailbox[p->szName].emplace_back(*p);
-}
-
-bool CClientManager::GET_MAIL(const char* name, const BYTE index, SMailBoxTable** mail)
-{
-	auto it = m_map_mailbox.find(name);
-	if (it == m_map_mailbox.end())
-		return false;
-
-	MailVec& mailvec = it->second;
-	if (index >= mailvec.size())
-		return false;
-
-	*mail = &mailvec.at(index);
-	return true;
-}
-
-void CClientManager::QUERY_MAILBOX_DELETE(CPeer* pkPeer, DWORD dwHandle, TMailBox* p)
-{
-	SMailBoxTable* mail = nullptr;
-	if (GET_MAIL(p->szName, p->Index, &mail) == false)
-		return;
-
-	mail->bIsDeleted = true;
-}
-
-void CClientManager::QUERY_MAILBOX_CONFIRM(CPeer* pkPeer, DWORD dwHandle, TMailBox* p)
-{
-	SMailBoxTable* mail = nullptr;
-	if (GET_MAIL(p->szName, p->Index, &mail) == false)
-		return;
-
-	mail->Message.bIsConfirm = true;
-}
-
-void CClientManager::QUERY_MAILBOX_GET(CPeer* pkPeer, DWORD dwHandle, TMailBox* p)
-{
-	SMailBoxTable* mail = nullptr;
-	if (GET_MAIL(p->szName, p->Index, &mail) == false)
-		return;
-
-	mail->AddData.iYang = 0;
-	mail->AddData.iWon = 0;
-	mail->Message.bIsItemExist = false;
-	mail->Message.bIsConfirm = true;
-	mail->AddData.dwItemVnum = 0;
-	mail->AddData.dwItemCount = 0;
-	memset(mail->AddData.alSockets, 0, sizeof(mail->AddData.alSockets));
-	memset(mail->AddData.aAttr, 0, sizeof(mail->AddData.aAttr));
-#if defined(__CHANGE_LOOK_SYSTEM__)
-	mail->AddData.dwChangeLookVnum = 0;
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	memset(&mail->AddData.RefineElement, 0, sizeof(mail->AddData.RefineElement));
-#endif
-#if defined(__ITEM_APPLY_RANDOM__)
-	memset(mail->AddData.aApplyRandom, 0, sizeof(mail->AddData.aApplyRandom));
-#endif
-#if defined(__SET_ITEM__)
-	mail->AddData.bSetValue = 0;
-#endif
-}
-
-void CClientManager::QUERY_MAILBOX_UNREAD(CPeer* pkPeer, DWORD dwHandle, TMailBox* p)
-{
-	auto it = m_map_mailbox.find(p->szName);
-	if (it == m_map_mailbox.end())
-		return;
-
-	const MailVec& mailvec = it->second;
-	if (mailvec.empty())
-		return;
-
-	const time_t now = time(nullptr);
-	TMailBoxRespondUnreadData t;
-
-	for (const SMailBoxTable& mail : it->second)
-	{
-		if (mail.bIsDeleted)
-			continue;
-
-		if (mail.Message.bIsConfirm)
-			continue;
-
-		if (std::difftime(mail.Message.DeleteTime, now) <= 0)
-			continue;
-
-		if (mail.Message.bIsGMPost)
-			t.bGMVisible = true;
-
-		if (mail.Message.bIsItemExist)
-			t.bItemMessageCount++;
-		else
-			t.bCommonMessageCount++;
-	}
-
-	if ((t.bItemMessageCount + t.bCommonMessageCount) < 1)
-		return;
-
-	pkPeer->EncodeHeader(HEADER_DG_RESPOND_MAILBOX_UNREAD, dwHandle, sizeof(TMailBoxRespondUnreadData));
-	pkPeer->Encode(&t, sizeof(TMailBoxRespondUnreadData));
-}
-
-void CClientManager::MAILBOX_BACKUP()
-{
-	CDBManager::instance().DirectQuery("TRUNCATE TABLE player.mailbox");
-
-	if (m_map_mailbox.empty())
+		sys_err("Invalid request change language (language : %d, aid : %d)", packet->bLanguage, packet->dwAID);
 		return;
-
-	char szQuery[QUERY_MAX_LEN];
-	const time_t now = std::time(nullptr);
-
-	for (auto& p : m_map_mailbox)
-	{
-		auto& mailvec = p.second;
-		if (mailvec.empty())
-			continue;
-
-		mailvec.erase(std::remove_if(mailvec.begin(), mailvec.end(),
-			[now](const TMailBoxTable& mail)
-			{ return mail.bIsDeleted || std::difftime(mail.Message.DeleteTime, now) <= 0; }
-		), mailvec.end());
-
-		std::sort(mailvec.begin(), mailvec.end(),
-			[](const TMailBoxTable& l, const TMailBoxTable& r)
-			{
-				return l.Message.SendTime > r.Message.SendTime;
-			});
-
-		for (const auto& mail : mailvec)
-		{
-			snprintf(szQuery, sizeof(szQuery),
-				"INSERT INTO `mailbox%s` (`name`, `who`, `title`, `message`, `gm`, `confirm`, `send_time`, `delete_time`"
-				", `gold`, `won`, `vnum`, `count`"
-				", `socket0`, `socket1`, `socket2`"
-#if defined(__ITEM_SOCKET6__)
-				", `socket3`, `socket4`, `socket5`"
-#endif
-				", `attrtype0`, `attrvalue0`"
-				", `attrtype1`, `attrvalue1`"
-				", `attrtype2`, `attrvalue2`"
-				", `attrtype3`, `attrvalue3`"
-				", `attrtype4`, `attrvalue4`"
-				", `attrtype5`, `attrvalue5`"
-				", `attrtype6`, `attrvalue6`"
-#if defined(__CHANGE_LOOK_SYSTEM__)
-				", `changelookvnum`"
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-				", `refine_element_apply_type`"
-				", `refine_element_grade`"
-				", `refine_element_value0`, `refine_element_value1`, `refine_element_value2`"
-				", `refine_element_bonus_value0`, `refine_element_bonus_value1`, `refine_element_bonus_value2`"
-#endif
-#if defined(__ITEM_APPLY_RANDOM__)
-				", `apply_type0`, `apply_value0`, `apply_path0`"
-				", `apply_type1`, `apply_value1`, `apply_path1`"
-				", `apply_type2`, `apply_value2`, `apply_path2`"
-				", `apply_type3`, `apply_value3`, `apply_path3`"
-#endif
-#if defined(__SET_ITEM__)
-				", `set_value`"
-#endif
-				") VALUES ('%s', '%s', '%s', '%s', %d, %d, %d, %d" // `name`, `who`, `title`, `message`, `gm`, `confirm`, `send_time`, `delete_time`
-				", %u, %u, %u, %u" // `gold`, `won`, `vnum`, `count`
-				", %ld, %ld, %ld" // `socket0`, `socket1`, `socket2`
-#if defined(__ITEM_SOCKET6__)
-				", %ld, %ld, %ld" // `socket3`, `socket4`, `socket5`
-#endif
-				", %u, %ld" // `attrtype0`, `attrvalue0`
-				", %u, %ld" // `attrtype1`, `attrvalue1`
-				", %u, %ld" // `attrtype2`, `attrvalue2`
-				", %u, %ld" // `attrtype3`, `attrvalue3`
-				", %u, %ld" // `attrtype4`, `attrvalue4`
-				", %u, %ld" // `attrtype5`, `attrvalue5`
-				", %u, %ld" // `attrtype6`, `attrvalue6`
-#if defined(__CHANGE_LOOK_SYSTEM__)
-				", %u" // `changelookvnum`
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-				", %u" // `refine_element_apply_type`
-				", %u" // `refine_element_grade`
-				", %u, %u, %u" // `refine_element_value0`, `refine_element_value1`, `refine_element_value2`
-				", %u, %u, %u" // `refine_element_bonus_value0`, `refine_element_bonus_value1`, `refine_element_bonus_value2`
-#endif
-#if defined(__ITEM_APPLY_RANDOM__)
-				", %u, %ld, %d" // `apply_type0`, `apply_value0`, `apply_path0`
-				", %u, %ld, %d" // `apply_type1`, `apply_value1`, `apply_path1`
-				", %u, %ld, %d" // `apply_type2`, `apply_value2`, `apply_path2`
-				", %u, %ld, %d" // `apply_type3`, `apply_value3`, `apply_path3`
-#endif
-#if defined(__SET_ITEM__)
-				", %d" // `set_value`
-#endif
-				")", GetTablePostfix()
-				, mail.szName
-				, mail.AddData.szFrom
-				, mail.Message.szTitle
-				, mail.AddData.szMessage
-				, mail.Message.bIsGMPost
-				, mail.Message.bIsConfirm
-				, mail.Message.SendTime
-				, mail.Message.DeleteTime
-				, mail.AddData.iYang
-				, mail.AddData.iWon
-				, mail.AddData.dwItemVnum
-				, mail.AddData.dwItemCount
-				, mail.AddData.alSockets[0], mail.AddData.alSockets[1], mail.AddData.alSockets[2]
-#if defined(__ITEM_SOCKET6__)
-				, mail.AddData.alSockets[3], mail.AddData.alSockets[4], mail.AddData.alSockets[5]
-#endif
-				, mail.AddData.aAttr[0].wType, mail.AddData.aAttr[0].lValue
-				, mail.AddData.aAttr[1].wType, mail.AddData.aAttr[1].lValue
-				, mail.AddData.aAttr[2].wType, mail.AddData.aAttr[2].lValue
-				, mail.AddData.aAttr[3].wType, mail.AddData.aAttr[3].lValue
-				, mail.AddData.aAttr[4].wType, mail.AddData.aAttr[4].lValue
-				, mail.AddData.aAttr[5].wType, mail.AddData.aAttr[5].lValue
-				, mail.AddData.aAttr[6].wType, mail.AddData.aAttr[6].lValue
-#if defined(__CHANGE_LOOK_SYSTEM__)
-				, mail.AddData.dwChangeLookVnum
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-				, mail.AddData.RefineElement.wApplyType
-				, mail.AddData.RefineElement.bGrade
-				, mail.AddData.RefineElement.abValue[0], mail.AddData.RefineElement.abValue[1], mail.AddData.RefineElement.abValue[2]
-				, mail.AddData.RefineElement.abBonusValue[0], mail.AddData.RefineElement.abBonusValue[1], mail.AddData.RefineElement.abBonusValue[2]
-#endif
-#if defined(__ITEM_APPLY_RANDOM__)
-				, mail.AddData.aApplyRandom[0].wType, mail.AddData.aApplyRandom[0].lValue, mail.AddData.aApplyRandom[0].bPath
-				, mail.AddData.aApplyRandom[1].wType, mail.AddData.aApplyRandom[1].lValue, mail.AddData.aApplyRandom[1].bPath
-				, mail.AddData.aApplyRandom[2].wType, mail.AddData.aApplyRandom[2].lValue, mail.AddData.aApplyRandom[2].bPath
-				, mail.AddData.aApplyRandom[3].wType, mail.AddData.aApplyRandom[3].lValue, mail.AddData.aApplyRandom[3].bPath
-#endif
-#if defined(__SET_ITEM__)
-				, mail.AddData.bSetValue
-#endif
-			);
-
-			std::unique_ptr<SQLMsg> pInsert(CDBManager::instance().DirectQuery(szQuery));
-		}
-	}
-}
-#endif
-
-#if defined(__GEM_SHOP__)
-void CClientManager::LoadGemShop(CPeer* pPeer, DWORD dwHandle, TGemShopLoad* pTable, bool bUpdate)
-{
-	if (g_log)
-		sys_log(0, "LoadGemShop (handle: %d pid: %d)", dwHandle, pTable->dwPID);
-
-	TGemShopTable GemShopTable = {};
-#	if defined(__CONQUEROR_LEVEL__)
-	GemShopTable.bSpecial = pTable->bSpecial;
-	if (GemShopTable.bSpecial)
-	{
-		GemShopTableMap::iterator it = m_mapGemShopSpecialTable.find(pTable->dwPID);
-		if (it != m_mapGemShopSpecialTable.end())
-			GemShopTable = it->second;
-	}
-	else
-#	endif
-	{
-		GemShopTableMap::iterator it = m_mapGemShopTable.find(pTable->dwPID);
-		if (it != m_mapGemShopTable.end())
-			GemShopTable = it->second;
-	}
-
-	pPeer->EncodeHeader(bUpdate ? HEADER_DG_GEM_SHOP_UPDATE : HEADER_DG_GEM_SHOP_LOAD, dwHandle, sizeof(GemShopTable));
-	pPeer->Encode(&GemShopTable, sizeof(GemShopTable));
-}
-
-void CClientManager::UpdateGemShop(CPeer* pPeer, DWORD dwHandle, TGemShopTable* pTable)
-{
-	if (g_log)
-		sys_log(0, "UpdateGemShop (handle: %d pid: %d)", dwHandle, pTable->dwPID);
-
-#	if defined(__CONQUEROR_LEVEL__)
-	if (pTable->bSpecial)
-	{
-		GemShopTableMap::iterator it = m_mapGemShopSpecialTable.find(pTable->dwPID);
-		if (it != m_mapGemShopSpecialTable.end())
-			it->second = *pTable;
-		else
-			m_mapGemShopSpecialTable.emplace(std::make_pair(pTable->dwPID, *pTable));
-	}
-	else
-#	endif
-	{
-		GemShopTableMap::iterator it = m_mapGemShopTable.find(pTable->dwPID);
-		if (it != m_mapGemShopTable.end())
-			it->second = *pTable;
-		else
-			m_mapGemShopTable.emplace(std::make_pair(pTable->dwPID, *pTable));
-	}
-
-	// NOTE : Request Gem Shop Load
-	TGemShopLoad Packet;
-	Packet.dwPID = pTable->dwPID;
-#	if defined(__CONQUEROR_LEVEL__)
-	Packet.bSpecial = pTable->bSpecial;
-#	endif
-	LoadGemShop(pPeer, dwHandle, &Packet, true);
-}
-
-void CClientManager::FlushGemShop()
-{
-	// Flush Default Gem Shop Table
-	{
-		if (m_mapGemShopTable.empty())
-			return;
-
-		char szQuery[1024] = {};
-		snprintf(szQuery, sizeof(szQuery), "TRUNCATE TABLE `player`.`gem_shop%s`", GetTablePostfix());
-		CDBManager::instance().DirectQuery(szQuery);
-
-		GemShopTableMap::iterator it = m_mapGemShopTable.begin();
-		for (; it != m_mapGemShopTable.end(); ++it)
-		{
-			TGemShopTable GemShopTable = it->second;
-			if (it->first != GemShopTable.dwPID)
-				continue;
-
-			char szColumns[1024] = {};
-			char szValues[1024] = {};
-
-			int iLen = snprintf(szColumns, sizeof(szColumns), "`pid`, `refresh_time`, `enabled_slots`");
-			int iValueLen = snprintf(szValues, sizeof(szValues), "%u, FROM_UNIXTIME(%ld), %d", GemShopTable.dwPID, GemShopTable.lRefreshTime, GemShopTable.bEnabledSlots);
-
-			for (BYTE bSlotIndex = 0; bSlotIndex < GEM_SHOP_SLOT_COUNT; ++bSlotIndex)
-			{
-				iLen += snprintf(szColumns + iLen, sizeof(szColumns) - iLen, ", `slot%d_enable`, `slot%d_vnum`, `slot%d_count`, `slot%d_price`",
-					bSlotIndex, bSlotIndex, bSlotIndex, bSlotIndex);
-				iValueLen += snprintf(szValues + iValueLen, sizeof(szValues) - iValueLen, ", %d, %u, %d, %u",
-					GemShopTable.GemShopItem[bSlotIndex].bEnable,
-					GemShopTable.GemShopItem[bSlotIndex].dwItemVnum,
-					GemShopTable.GemShopItem[bSlotIndex].bCount,
-					GemShopTable.GemShopItem[bSlotIndex].dwPrice
-				);
-			}
-
-			snprintf(szQuery, sizeof(szQuery), "INSERT INTO `gem_shop%s` (%s) VALUES(%s)",
-				GetTablePostfix(), szColumns, szValues);
-
-			std::unique_ptr<SQLMsg> pInsert(CDBManager::instance().DirectQuery(szQuery));
-		}
-	}
-
-#	if defined(__CONQUEROR_LEVEL__)
-	// Flush Port (Special) Gem Shop Table
-	{
-		if (m_mapGemShopSpecialTable.empty())
-			return;
-
-		char szQuery[1024] = {};
-		snprintf(szQuery, sizeof(szQuery), "TRUNCATE TABLE `player`.`gem_shop_port%s`", GetTablePostfix());
-		CDBManager::instance().DirectQuery(szQuery);
-
-		GemShopTableMap::iterator it = m_mapGemShopSpecialTable.begin();
-		for (; it != m_mapGemShopSpecialTable.end(); ++it)
-		{
-			TGemShopTable GemShopTable = it->second;
-			if (it->first != GemShopTable.dwPID)
-				continue;
-
-			char szColumns[1024] = {};
-			char szValues[1024] = {};
-
-			int iLen = snprintf(szColumns, sizeof(szColumns), "`pid`, `refresh_time`, `enabled_slots`");
-			int iValueLen = snprintf(szValues, sizeof(szValues), "%u, FROM_UNIXTIME(%ld), %d", GemShopTable.dwPID, GemShopTable.lRefreshTime, GemShopTable.bEnabledSlots);
-
-			for (BYTE bSlotIndex = 0; bSlotIndex < GEM_SHOP_SLOT_COUNT; ++bSlotIndex)
-			{
-				iLen += snprintf(szColumns + iLen, sizeof(szColumns) - iLen, ", `slot%d_enable`, `slot%d_vnum`, `slot%d_count`, `slot%d_price`",
-					bSlotIndex, bSlotIndex, bSlotIndex, bSlotIndex);
-				iValueLen += snprintf(szValues + iValueLen, sizeof(szValues) - iValueLen, ", %d, %u, %d, %u",
-					GemShopTable.GemShopItem[bSlotIndex].bEnable,
-					GemShopTable.GemShopItem[bSlotIndex].dwItemVnum,
-					GemShopTable.GemShopItem[bSlotIndex].bCount,
-					GemShopTable.GemShopItem[bSlotIndex].dwPrice
-				);
-			}
-
-			snprintf(szQuery, sizeof(szQuery), "INSERT INTO `gem_shop_port%s` (%s) VALUES(%s)",
-				GetTablePostfix(), szColumns, szValues);
-
-			std::unique_ptr<SQLMsg> pInsert(CDBManager::instance().DirectQuery(szQuery));
-		}
-	}
-#	endif
-}
-#endif
-
-#ifdef __OFFLINE_SHOP__
-void CClientManager::InitializeNextOfflineShopId()
-{
-	std::stringstream query;
-	query << "SELECT MAX(id) + 1 FROM offline_shop" << GetTablePostfix();
-
-	std::unique_ptr<SQLMsg> msg(CDBManager::Instance().DirectQuery(query.str().c_str()));
-	if (msg && msg->Get()->uiNumRows > 0) {
-		auto row = mysql_fetch_row(msg->Get()->pSQLResult);
-		str_to_number(nextOfflineShopId_, row[0]);
-	}
-	else {
-		nextOfflineShopId_ = 1;
-	}
-
-	sys_log(0, "Next offline shop id: %u", nextOfflineShopId_);
-}
-
-void CClientManager::RequestOfflineShopId(CPeer* peer, uint32_t queueId)
-{
-	peer->EncodeHeader(HEADER_DG_RESPOND_OFFLINE_SHOP_ID, 0, sizeof(uint32_t) + sizeof(uint32_t));
-	peer->Encode(&queueId, sizeof(uint32_t));
-	peer->Encode(&nextOfflineShopId_, sizeof(uint32_t));
-
-	nextOfflineShopId_++;
-}
-
-void CClientManager::SaveOfflineShop(const TOfflineShop& data, bool skipQuery)
-{
-	auto it = offlineShopCache_.find(data.id);
-	if (it != offlineShopCache_.end()) {
-		it->second->Put(&data);
-	}
-	else {
-		auto cache = std::unique_ptr<COfflineShopCache>(new COfflineShopCache());
-		cache->Put(&data, skipQuery);
-
-		offlineShopCache_.insert(std::make_pair(data.id, std::move(cache)));
-	}
-}
-
-void CClientManager::SaveOfflineShopItem(const TOfflineShopItem& data, bool skipQuery)
-{
-	auto it = offlineShopItemCache_.find(data.id);
-	if (it != offlineShopItemCache_.end()) {
-		it->second->Put(&data);
-	}
-	else {
-		auto cache = std::unique_ptr<COfflineShopItemCache>(new COfflineShopItemCache());
-		cache->Put(&data, skipQuery);
-
-		offlineShopItemCache_.insert(std::make_pair(data.id, std::move(cache)));
-	}
-}
-
-void CClientManager::DestroyOfflineShop(uint32_t id)
-{
-	auto it = offlineShopCache_.find(id);
-	if (it != offlineShopCache_.end()) {
-		offlineShopCache_.erase(it);
-	}
-
-	std::pair<uint32_t, uint16_t> key = { id, 0 };
-	for (uint16_t i = 0; i < OFFLINE_SHOP_ITEM_COUNT; ++i) {
-		key.second = i;
-
-		auto it = offlineShopItemCache_.find(key);
-		if (it != offlineShopItemCache_.end()) {
-			offlineShopItemCache_.erase(it);
-		}
 	}
 
-	std::stringstream queryDeleteOfflineShop;
-	queryDeleteOfflineShop << "DELETE FROM offline_shop" << GetTablePostfix() << " WHERE id = " << id;
-	CDBManager::Instance().AsyncQuery(queryDeleteOfflineShop.str().c_str());
-
-	std::stringstream queryDeleteOfflineShopItems;
-	queryDeleteOfflineShopItems << "DELETE FROM offline_shop_item" << GetTablePostfix() << " WHERE owner_pid = " << id;
-	CDBManager::Instance().AsyncQuery(queryDeleteOfflineShopItems.str().c_str());
-}
-
-void CClientManager::UpdateOfflineShopCache()
-{
-	auto it = offlineShopCache_.begin();
-	while (m_iCacheFlushCount < m_iCacheFlushCountLimit && it != offlineShopCache_.end()) {
-		if (it->second->CheckFlushTimeout()) {
-			it->second->Flush();
-
-			m_iCacheFlushCount++;
-		}
-
-		it++;
-	}
+	CDBManager::Instance().AsyncQuery(szQuery, SQL_ACCOUNT);
 }
 
-void CClientManager::UpdateOfflineShopItemCache()
-{
-	auto it = offlineShopItemCache_.begin();
-	while (m_iCacheFlushCount < m_iCacheFlushCountLimit && it != offlineShopItemCache_.end()) {
-		if (it->second->CheckFlushTimeout()) {
-			it->second->Flush();
-
-			m_iCacheFlushCount++;
-		}
-
-		it++;
-	}
-}
+#if defined(__ENVIRONMENT__)
+enum DayMode : BYTE { DAY, NIGHT };
 
-void CClientManager::FlushOfflineShops()
+static BYTE GetDayMode(int Hour)
 {
-	for (auto it = offlineShopCache_.begin(); it != offlineShopCache_.end(); ++it) {
-		it->second->Flush();
-	}
-
-	for (auto it = offlineShopItemCache_.begin(); it != offlineShopItemCache_.end(); ++it) {
-		it->second->Flush();
-	}
+	if (Hour >= 6 && Hour <= 20)
+		return DayMode::DAY;
+	return DayMode::NIGHT;
 }
 
-const TItemTable* CClientManager::GetItemTable(DWORD vnum) const
+static bool IsWinter(int Month)
 {
-	auto it = m_map_itemTableByVnum.find(vnum);
-	if (it == m_map_itemTableByVnum.end())
-	{
-		return NULL;
-	}
-
-	return it->second;
+	return (Month >= 12 && Month <= 2);
 }
 
-BYTE CClientManager::GetRealItemType(DWORD vnum)
+void CClientManager::UpdateEnvironment()
 {
-	if (vnum >= 110000 && vnum <= 165499)
-		return ITEM_DS;
-	
-	
-	/* SHIT :
-	for (auto it = m_map_itemTableByVnum.begin(); it != m_map_itemTableByVnum.end(); ++it)
-	{
-		if (it->second->dwVnum == vnum)
-		{
-			return it->second->bType;
-		}
-	}
-	*/
-	
-	for (auto it = m_vec_itemTable.begin(); it != m_vec_itemTable.end(); ++it)
-	{
-		if (it->dwVnum == vnum)
-		{
-			return it->bType;
-		}
-	}
-	
-	return ITEM_NONE;
-}
+	time_t CurrentTime = time(nullptr);
+	tm* tm = localtime(&CurrentTime);
 
-BYTE CClientManager::GetRealItemSubType(DWORD vnum)
-{
-	/* SHIT:
-	for (auto it = m_map_itemTableByVnum.begin(); it != m_map_itemTableByVnum.end(); ++it)
-	{
-		if (it->second->dwVnum == vnum)
-		{
-			return it->second->bSubType;
-		}
-	}
-	*/
-	
-	for (auto it = m_vec_itemTable.begin(); it != m_vec_itemTable.end(); ++it)
+	auto SendFlag = [&](const char* flag, BYTE val)
 	{
-		if (it->dwVnum == vnum)
+		TEventFlagMap::const_iterator it = m_map_lEventFlag.find(flag);
+		if ((it != m_map_lEventFlag.end() && it->second == val) == false)
 		{
-			return it->bSubType;
+			TPacketSetEventFlag p;
+			std::strcpy(p.szFlagName, flag);
+			p.lValue = val;
+			SetEventFlag(&p);
 		}
-	}
-	
-	return 0;
-}
+	};
 
-void CClientManager::GetRealItemLimit(DWORD vnum, int & limitType, DWORD & limitValue)
-{
-	/* BUGGED SHIT :
-	for (auto it = m_map_itemTableByVnum.begin(); it != m_map_itemTableByVnum.end(); ++it)
-	{
-		if (it->second->dwVnum == vnum)
-		{
-			limitType = it->second->aLimits[0].bType;
-			limitValue = it->second->aLimits[0].lValue;
-			return;
-		}
-	}
-	*/
-	
-	for (auto it = m_vec_itemTable.begin(); it != m_vec_itemTable.end(); ++it)
-	{
-		if (it->dwVnum == vnum)
-		{
-			limitType = it->aLimits[0].bType;
-			limitValue = it->aLimits[0].lValue;
-			return;
-		}
-	}
+	SendFlag("eclipse", GetDayMode(tm->tm_hour));
+	BOOL Winter = IsWinter(tm->tm_mon);
+	for (const auto& Flag : { "xmas_snow", "xmas_tree" /*, "xmas_boom"*/ })
+		SendFlag(Flag, Winter);
 }
 #endif
 
@@ -5691,7 +4734,7 @@
 {
 	if (m_map_pkGrowthPetCacheSetPtr.find(pid) != m_map_pkGrowthPetCacheSetPtr.end())
 		return;
-				 
+
 	TGrowthPetCacheSet* pSet = new TGrowthPetCacheSet;
 	m_map_pkGrowthPetCacheSetPtr.insert(TGrowthPetCacheSetPtrMap::value_type(pid, pSet));
 
@@ -5905,6 +4948,7 @@
 		int cur = 0;
 
 		str_to_number(pet.dwID, row[cur++]);
+		str_to_number(pet.dwOwner, row[cur++]);
 		str_to_number(pet.dwVnum, row[cur++]);
 		str_to_number(pet.bState, row[cur++]);
 		strlcpy(pet.szName, row[cur++], sizeof(pet.szName));
@@ -5926,8 +4970,6 @@
 		str_to_number(pet.lBirthday, row[cur++]);
 		str_to_number(pet.lEndTime, row[cur++]);
 		str_to_number(pet.lMaxTime, row[cur++]);
-
-		pet.dwOwner = dwPID;
 	}
 
 	return true;
@@ -5955,3 +4997,269 @@
 	}
 }
 #endif
+
+
+#if defined(__MAILBOX__)
+void CClientManager::QUERY_MAILBOX_LOAD(CPeer* pkPeer, DWORD dwHandle, TMailBox* p)
+{
+	if (g_log)
+		sys_log(0, "QUERY_MAILBOX (handle: %d ch: %s)", dwHandle, p->szName);
+
+	std::vector<SMailBoxTable>* vec = nullptr;
+	auto it = m_map_mailbox.find(p->szName);
+	if (it != m_map_mailbox.end())
+		vec = &it->second;
+
+	if (vec)
+	{
+		const time_t now = std::time(nullptr);
+
+		vec->erase(std::remove_if(vec->begin(), vec->end(),
+			[now](const TMailBoxTable& mail)
+			{ return mail.bIsDeleted || std::difftime(mail.Message.DeleteTime, now) <= 0; }
+		), vec->end());
+
+		std::sort(vec->begin(), vec->end(),
+			[](const TMailBoxTable& l, const TMailBoxTable& r)
+			{
+				return l.Message.SendTime > r.Message.SendTime;
+			});
+	}
+
+	const WORD size = vec ? static_cast<WORD>(vec->size()) : 0;
+	const DWORD dwPacketSize = sizeof(WORD) + sizeof(WORD) + sizeof(SMailBoxTable) * size;
+
+	pkPeer->EncodeHeader(HEADER_DG_RESPOND_MAILBOX_LOAD, dwHandle, dwPacketSize);
+	pkPeer->EncodeWORD(sizeof(SMailBoxTable));
+	pkPeer->EncodeWORD(size);
+
+	if (vec && vec->empty() == false)
+		pkPeer->Encode(&(*vec)[0], sizeof(SMailBoxTable) * size);
+}
+
+void CClientManager::QUERY_MAILBOX_CHECK_NAME(CPeer* pkPeer, DWORD dwHandle, TMailBox* p)
+{
+	TMailBox t;
+	std::memcpy(t.szName, "", sizeof(t.szName));
+	t.Index = 0; // Index: Mail Count
+
+	static std::unordered_set<std::string> NameSet;
+	bool bFound = NameSet.find(p->szName) != NameSet.end();
+
+	if (bFound == false)
+	{
+		char s_szQuery[128];
+		snprintf(s_szQuery, sizeof(s_szQuery), "SELECT * FROM player%s WHERE `name` = '%s' LIMIT 1", GetTablePostfix(), p->szName);
+		std::unique_ptr<SQLMsg> pMsg(CDBManager::instance().DirectQuery(s_szQuery));
+		bFound = pMsg->Get()->uiNumRows > 0;
+	}
+
+	if (bFound)
+	{
+		NameSet.emplace(p->szName); // player exists, next time we will use this to avoid using mysql.
+		std::memcpy(t.szName, p->szName, sizeof(t.szName));
+		auto it = m_map_mailbox.find(p->szName);
+		if (it != m_map_mailbox.end())
+		{
+			const time_t now = time(nullptr);
+			for (const SMailBoxTable& mail : it->second)
+			{
+				if (mail.bIsDeleted)
+					continue;
+
+				if (std::difftime(mail.Message.DeleteTime, now) <= 0)
+					continue;
+
+				t.Index++;
+			}
+		}
+	}
+
+	pkPeer->EncodeHeader(HEADER_DG_RESPOND_MAILBOX_CHECK_NAME, dwHandle, sizeof(TMailBox));
+	pkPeer->Encode(&t, sizeof(TMailBox));
+}
+
+void CClientManager::QUERY_MAILBOX_WRITE(CPeer* pkPeer, DWORD dwHandle, TMailBoxTable* p)
+{
+	m_map_mailbox[p->szName].emplace_back(*p);
+}
+
+bool CClientManager::GET_MAIL(const char* name, const BYTE index, SMailBoxTable** mail)
+{
+	auto it = m_map_mailbox.find(name);
+	if (it == m_map_mailbox.end())
+		return false;
+
+	MailVec& mailvec = it->second;
+	if (index >= mailvec.size())
+		return false;
+
+	*mail = &mailvec.at(index);
+	return true;
+}
+
+void CClientManager::QUERY_MAILBOX_DELETE(CPeer* pkPeer, DWORD dwHandle, TMailBox* p)
+{
+	SMailBoxTable* mail = nullptr;
+	if (GET_MAIL(p->szName, p->Index, &mail) == false)
+		return;
+
+	mail->bIsDeleted = true;
+}
+
+void CClientManager::QUERY_MAILBOX_CONFIRM(CPeer* pkPeer, DWORD dwHandle, TMailBox* p)
+{
+	SMailBoxTable* mail = nullptr;
+	if (GET_MAIL(p->szName, p->Index, &mail) == false)
+		return;
+
+	mail->Message.bIsConfirm = true;
+}
+
+void CClientManager::QUERY_MAILBOX_GET(CPeer* pkPeer, DWORD dwHandle, TMailBox* p)
+{
+	SMailBoxTable* mail = nullptr;
+	if (GET_MAIL(p->szName, p->Index, &mail) == false)
+		return;
+
+	mail->AddData.iYang = 0;
+	mail->AddData.iWon = 0;
+	mail->Message.bIsItemExist = false;
+	mail->Message.bIsConfirm = true;
+	mail->AddData.ItemVnum = 0;
+	mail->AddData.ChangeLookVnum = 0;
+	mail->AddData.ItemCount = 0;
+	memset(mail->AddData.alSockets, 0, sizeof(mail->AddData.alSockets));
+#if defined(__ITEM_APPLY_RANDOM__)
+	memset(mail->AddData.aApplyRandom, 0, sizeof(mail->AddData.aApplyRandom));
+#endif
+	memset(mail->AddData.aAttr, 0, sizeof(mail->AddData.aAttr));
+}
+
+void CClientManager::QUERY_MAILBOX_UNREAD(CPeer* pkPeer, DWORD dwHandle, TMailBox* p)
+{
+	auto it = m_map_mailbox.find(p->szName);
+	if (it == m_map_mailbox.end())
+		return;
+
+	const MailVec& mailvec = it->second;
+	if (mailvec.empty())
+		return;
+
+	const time_t now = time(nullptr);
+	TMailBoxRespondUnreadData t;
+
+	for (const SMailBoxTable& mail : it->second)
+	{
+		if (mail.bIsDeleted)
+			continue;
+
+		if (mail.Message.bIsConfirm)
+			continue;
+
+		if (std::difftime(mail.Message.DeleteTime, now) <= 0)
+			continue;
+
+		if (mail.Message.bIsGMPost)
+			t.bGMVisible = true;
+
+		if (mail.Message.bIsItemExist)
+			t.bItemMessageCount++;
+		else
+			t.bCommonMessageCount++;
+	}
+
+	if ((t.bItemMessageCount + t.bCommonMessageCount) < 1)
+		return;
+
+	pkPeer->EncodeHeader(HEADER_DG_RESPOND_MAILBOX_UNREAD, dwHandle, sizeof(TMailBoxRespondUnreadData));
+	pkPeer->Encode(&t, sizeof(TMailBoxRespondUnreadData));
+}
+
+void CClientManager::MAILBOX_BACKUP()
+{
+	CDBManager::instance().DirectQuery("TRUNCATE TABLE player.mailbox");
+
+	if (m_map_mailbox.empty())
+		return;
+
+	char s_szQuery[1024];
+	const time_t now = std::time(nullptr);
+
+	for (auto& p : m_map_mailbox)
+	{
+		auto& mailvec = p.second;
+		if (mailvec.empty())
+			continue;
+
+		mailvec.erase(std::remove_if(mailvec.begin(), mailvec.end(),
+			[now](const TMailBoxTable& mail)
+			{ return mail.bIsDeleted || std::difftime(mail.Message.DeleteTime, now) <= 0; }
+		), mailvec.end());
+
+		std::sort(mailvec.begin(), mailvec.end(),
+			[](const TMailBoxTable& l, const TMailBoxTable& r)
+			{
+				return l.Message.SendTime > r.Message.SendTime;
+			});
+
+		for (const auto& mail : mailvec)
+		{
+			snprintf(s_szQuery, sizeof(s_szQuery),
+				"INSERT INTO mailbox%s (`name`, `who`, `title`, `message`, `gm`, `confirm`, `send_time`, `delete_time`, "
+				"`gold`, `won`, `ivnum`, `ichangelookvnum`, `icount`, "
+				"`socket0`, `socket1`, `socket2`, `socket3`, `socket4`, "
+#if defined(__ITEM_APPLY_RANDOM__)
+				"`apply_type0`, `apply_value0`, `apply_path0`, "
+				"`apply_type1`, `apply_value1`, `apply_path1`, "
+				"`apply_type2`, `apply_value2`, `apply_path2`, "
+				"`apply_type3`, `apply_value3`, `apply_path3`, "
+#endif
+				"`attrtype0`, `attrvalue0`, "
+				"`attrtype1`, `attrvalue1`, "
+				"`attrtype2`, `attrvalue2`, "
+				"`attrtype3`, `attrvalue3`, "
+				"`attrtype4`, `attrvalue4`, "
+				"`attrtype5`, `attrvalue5`, "
+				"`attrtype6`, `attrvalue6`) "
+				"VALUES('%s', '%s', '%s', '%s', %d, %d, %d, %d, " // `name`, `who`, `title`, `message`, `gm`, `confirm`, `send_time`, `delete_time`
+				"%d, %d, %u, %u, %u, " // `gold`, `won`, `ivnum`, `ichangelookvnum`, `icount`
+				"%lu, %lu, %lu, %lu, %lu " // `socket0`, `socket1`, `socket2`, `socket3`, `socket4`
+#if defined(__ITEM_APPLY_RANDOM__)
+				"%d, %d, %d, " // `apply_type0`, `apply_value0`, `apply_path0`
+				"%d, %d, %d, " // `apply_type1`, `apply_value1`, `apply_path1`
+				"%d, %d, %d, " // `apply_type2`, `apply_value2`, `apply_path2`
+				"%d, %d, %d, " // `apply_type3`, `apply_value3`, `apply_path3`
+#endif
+				"%d, %d, " // `attrtype0`, `attrvalue0`
+				"%d, %d, " // `attrtype1`, `attrvalue1`
+				"%d, %d, " // `attrtype2`, `attrvalue2`
+				"%d, %d, " // `attrtype3`, `attrvalue3`
+				"%d, %d, " // `attrtype4`, `attrvalue4`
+				"%d, %d, " // `attrtype5`, `attrvalue5`
+				"%d, %d)", // `attrtype6`, `attrvalue6`
+				GetTablePostfix(),
+				mail.szName, mail.AddData.szFrom, mail.Message.szTitle, mail.AddData.szMessage,
+				mail.Message.bIsGMPost, mail.Message.bIsConfirm, mail.Message.SendTime, mail.Message.DeleteTime,
+				mail.AddData.iYang, mail.AddData.iWon, mail.AddData.ItemVnum, mail.AddData.ChangeLookVnum, mail.AddData.ItemCount,
+				mail.AddData.alSockets[0], mail.AddData.alSockets[1], mail.AddData.alSockets[2], mail.AddData.alSockets[3], mail.AddData.alSockets[4],
+#if defined(__ITEM_APPLY_RANDOM__)
+				mail.AddData.aApplyRandom[0].bType, mail.AddData.aApplyRandom[0].sValue, mail.AddData.aApplyRandom[0].bPath,
+				mail.AddData.aApplyRandom[1].bType, mail.AddData.aApplyRandom[1].sValue, mail.AddData.aApplyRandom[1].bPath,
+				mail.AddData.aApplyRandom[2].bType, mail.AddData.aApplyRandom[2].sValue, mail.AddData.aApplyRandom[2].bPath,
+				mail.AddData.aApplyRandom[3].bType, mail.AddData.aApplyRandom[3].sValue, mail.AddData.aApplyRandom[3].bPath,
+#endif
+				mail.AddData.aAttr[0].bType, mail.AddData.aAttr[0].sValue,
+				mail.AddData.aAttr[1].bType, mail.AddData.aAttr[1].sValue,
+				mail.AddData.aAttr[2].bType, mail.AddData.aAttr[2].sValue,
+				mail.AddData.aAttr[3].bType, mail.AddData.aAttr[3].sValue,
+				mail.AddData.aAttr[4].bType, mail.AddData.aAttr[4].sValue,
+				mail.AddData.aAttr[5].bType, mail.AddData.aAttr[5].sValue,
+				mail.AddData.aAttr[6].bType, mail.AddData.aAttr[6].sValue
+			);
+
+			std::unique_ptr<SQLMsg> pInsert(CDBManager::instance().DirectQuery(s_szQuery));
+		}
+	}
+}
+#endif
\ No newline at end of file
diff -ruN baseline/server/server/home/metin2/Source/Server/db/src/ClientManager.h final/server/server/home/metin2/Source/Server/db/src/ClientManager.h
--- baseline/server/server/home/metin2/Source/Server/db/src/ClientManager.h	2025-06-28 21:46:08.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/db/src/ClientManager.h	2022-04-27 10:05:05.000000000 +0000
@@ -1,13 +1,8 @@
 #ifndef __INC_CLIENTMANAGER_H__
 #define __INC_CLIENTMANAGER_H__
 
-#include <boost/unordered_map.hpp>
-#include <boost/unordered_set.hpp>
-#include <memory>
-
 #include <unordered_map>
 #include <unordered_set>
-#include "Cache.h"
 
 #include "../../common/stl.h"
 #include "../../common/building.h"
@@ -19,9 +14,15 @@
 class CPlayerTableCache;
 class CItemCache;
 class CItemPriceListTableCache;
+
 #ifdef __GROWTH_PET_SYSTEM__
 class CGrowthPetCache;
 #endif
+
+#if defined(__SKILL_COLOR_SYSTEM__)
+class CSKillColorCache;
+#endif
+
 // typedef std::map<int, int> PacketInfoMap;
 
 class CPacketInfo
@@ -50,12 +51,19 @@
 	typedef std::unordered_set<CItemCache*, std::hash<CItemCache*> > TItemCacheSet;
 	typedef std::unordered_map<DWORD, TItemCacheSet*> TItemCacheSetPtrMap;
 	typedef std::unordered_map<DWORD, CItemPriceListTableCache*> TItemPriceListCacheMap;
+#if defined(__CHANNEL_STATUS_UPDATE__)
+	typedef std::unordered_map<short, std::pair<BYTE, int>> TChannelStatusMap;
+#else
 	typedef std::unordered_map<short, BYTE> TChannelStatusMap;
+#endif
+#if defined(__SKILL_COLOR_SYSTEM__)
+	typedef std::unordered_map<DWORD, CSKillColorCache*> TSkillColorCacheMap;
+#endif
 
 #ifdef __GROWTH_PET_SYSTEM__
-	typedef boost::unordered_map<DWORD, CGrowthPetCache*> TGrowthPetCacheMap;
-	typedef boost::unordered_set<CGrowthPetCache*, boost::hash<CGrowthPetCache*> > TGrowthPetCacheSet;
-	typedef boost::unordered_map<DWORD, TGrowthPetCacheSet*> TGrowthPetCacheSetPtrMap;
+	typedef std::unordered_map<DWORD, CGrowthPetCache*> TGrowthPetCacheMap;
+	typedef std::unordered_set<CGrowthPetCache*, std::hash<CGrowthPetCache*> > TGrowthPetCacheSet;
+	typedef std::unordered_map<DWORD, TGrowthPetCacheSet*> TGrowthPetCacheSetPtrMap;
 #endif
 
 	// MYSHOP_PRICE_LIST
@@ -133,6 +141,12 @@
 	void SendAllGuildSkillRechargePacket();
 	void SendTime();
 
+#if defined(__SKILL_COLOR_SYSTEM__)
+	CSKillColorCache* GetSkillColorCache(DWORD dwID);
+	void PutSkillColorCache(const TSkillColor* c_pNew);
+	void UpdateSkillColorCache();
+#endif
+
 	CPlayerTableCache* GetPlayerCache(DWORD id);
 	void PutPlayerCache(TPlayerTable* pNew);
 
@@ -144,11 +158,9 @@
 	void PutItemCache(TPlayerItem* pNew, bool bSkipQuery = false);
 	bool DeleteItemCache(DWORD id);
 
-	CPeer* GetPeer(IDENT ident);
-
 	void UpdatePlayerCache();
 	void UpdateItemCache();
-
+	
 #ifdef __GROWTH_PET_SYSTEM__
 	void			CreateGrowthPetCacheSet(DWORD dwID);
 	TGrowthPetCacheSet* GetGrowthPetCacheSet(DWORD dwID);
@@ -209,14 +221,11 @@
 private:
 	bool InitializeTables();
 	bool InitializeShopTable();
-
 	bool InitializeMobTable();
-	bool InitializeItemTable();
-
 	// BEGIN NPC TABLE
 	bool InitializeNpcTable();
 	// END NPC TABLE
-
+	bool InitializeItemTable();
 	bool InitializeQuestItemTable();
 	bool InitializeSkillTable();
 	bool InitializeRefineTable();
@@ -227,9 +236,20 @@
 	bool InitializeObjectProto();
 	bool InitializeObjectTable();
 	bool InitializeMonarch();
+#ifdef __GROWTH_PET_SYSTEM__
+	bool		InitializeGrowthPetSkillTable();
+#endif
+
+
+	// mob_proto.txt, item_proto.txt  mob_proto, item_proto real db ݿ.
+	// item_proto, mob_proto db ݿ ʾƵ,  ưµ  ,
+	//   db item_proto, mob_proto о    ߻Ѵ.
+	bool MirrorMobTableIntoDB();
+	bool MirrorItemTableIntoDB();
 
 	void AddPeer(socket_t fd);
 	void RemovePeer(CPeer* pPeer);
+	CPeer* GetPeer(IDENT ident);
 
 	int AnalyzeQueryResult(SQLMsg* msg);
 	int AnalyzeErrorMsg(CPeer* peer, SQLMsg* msg);
@@ -283,9 +303,9 @@
 	void RESULT_QUEST_LOAD(CPeer* pkPeer, MYSQL_RES* pRes, DWORD dwHandle, DWORD dwPID);
 	void RESULT_AFFECT_LOAD(CPeer* pkPeer, MYSQL_RES* pRes, DWORD dwHandle, DWORD dwRealPID);
 
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	void RESULT_EXT_BATTLE_PASS_LOAD(CPeer* peer, MYSQL_RES* pRes, DWORD dwHandle, DWORD dwRealPID);
-	void QUERY_SAVE_EXT_BATTLE_PASS(CPeer* peer, DWORD dwHandle, TPlayerExtBattlePassMission* battlePass);
+#if defined(__SKILL_COLOR_SYSTEM__)
+	void QUERY_SKILL_COLOR_LOAD(CPeer* peer, DWORD dwHandle, TPlayerLoadPacket* packet);
+	void RESULT_SKILL_COLOR_LOAD(CPeer* peer, MYSQL_RES* pRes, DWORD dwHandle);
 #endif
 
 	// PLAYER_INDEX_CREATE_BUG_FIX
@@ -319,6 +339,10 @@
 
 	void QUERY_PLAYER_COUNT(CPeer* pkPeer, TPlayerCountPacket*);
 
+#if defined(__SKILL_COLOR_SYSTEM__)
+	void QUERY_SKILL_COLOR_SAVE(const char* c_pData);
+#endif
+
 	void QUERY_ITEM_SAVE(CPeer* pkPeer, const char* c_pData);
 	void QUERY_ITEM_DESTROY(CPeer* pkPeer, const char* c_pData);
 	void QUERY_ITEM_FLUSH(CPeer* pkPeer, const char* c_pData);
@@ -378,12 +402,6 @@
 	void SetEventFlag(TPacketSetEventFlag* p);
 	void SendEventFlagsOnSetup(CPeer* peer);
 
-#if defined(__GUILD_EVENT_FLAG__) //&& defined(__GUILD_RENEWAL__)
-	void LoadGuildEventFlag();
-	void GuildSetEventFlag(TPacketSetGuildEventFlag* pTable);
-	void SendGuildEventFlagsOnSetup(CPeer* pPeer);
-#endif
-
 	// ȥ
 	void MarriageAdd(TPacketMarriageAdd* p);
 	void MarriageUpdate(TPacketMarriageUpdate* p);
@@ -424,21 +442,10 @@
 	void BlockChat(TPacketBlockChat* p);
 	// END_OF_BLOCK_CHAT
 
-#if defined(__ENVIRONMENT_SYSTEM__)
-	void UpdateEnvironment();
-#endif
-
-#ifdef __OFFLINE_SHOP__
-public:
-	const TItemTable* GetItemTable(DWORD vnum) const;
-	BYTE GetRealItemType(DWORD vnum);
-	BYTE GetRealItemSubType(DWORD vnum);
-	void GetRealItemLimit(DWORD vnum, int & limitType, DWORD & limitValue);
-#endif
+	void ChangeLanguage(const TRequestChangeLanguage* p);
 
-#ifdef __GROWTH_PET_SYSTEM__
-protected:
-	bool InitializeGrowthPetSkillTable();
+#if defined(__ENVIRONMENT__)
+	void UpdateEnvironment();
 #endif
 
 private:
@@ -493,17 +500,26 @@
 	std::vector<building::TObjectProto> m_vec_kObjectProto;
 	//pkObjectTableMap m_map_pkObjectTable;
 	std::map<DWORD, building::TObject *> m_map_pkObjectTable;
+	
 #ifdef __GROWTH_PET_SYSTEM__
 	std::vector<TGrowthPetSkillTable>		m_vec_growthPetSkillTable;
-	TGrowthPetCacheMap				m_map_growthPetCache;
-	TGrowthPetCacheSetPtrMap		m_map_pkGrowthPetCacheSetPtr;
 #endif
+
 	bool m_bShutdowned;
 
 	TPlayerTableCacheMap m_map_playerCache; // ÷̾ id key
 
 	TItemCacheMap m_map_itemCache; //  id key
 	TItemCacheSetPtrMap m_map_pkItemCacheSetPtr; // ÷̾ id key,  ÷̾   ĳ  ֳ?
+#if defined(__SKILL_COLOR_SYSTEM__)
+	TSkillColorCacheMap m_map_SkillColorCache;
+#endif
+
+#ifdef __GROWTH_PET_SYSTEM__
+	TGrowthPetCacheMap				m_map_growthPetCache;
+	TGrowthPetCacheSetPtrMap		m_map_pkGrowthPetCacheSetPtr;
+#endif
+
 
 	// MYSHOP_PRICE_LIST
 	/// ÷̾   Ʈ map. key: ÷̾ ID, value:  Ʈ ĳ
@@ -530,11 +546,6 @@
 	typedef std::map<std::string, long> TEventFlagMap;
 	TEventFlagMap m_map_lEventFlag;
 
-#if defined(__GUILD_EVENT_FLAG__) //&& defined(__GUILD_RENEWAL__)
-	typedef std::map<DWORD, std::map<std::string, long>> TGuildEventFlagMap;
-	TGuildEventFlagMap m_map_lGuildEventFlag;
-#endif
-
 	BYTE m_bLastHeader;
 	int m_iCacheFlushCount;
 	int m_iCacheFlushCountLimit;
@@ -616,21 +627,10 @@
 	void UpdateChannelStatus(TChannelStatus* pData);
 	void RequestChannelStatus(CPeer* peer, DWORD dwHandle);
 
-#if defined(__EXPRESSING_EMOTIONS__)
-public:
-	typedef std::vector<TPacketGDEmote> TEmoteTableVector;
-	typedef std::unordered_map<DWORD, TEmoteTableVector> TPlayerEmoteMap;
-
-private:
-	bool InitializeEmoteTable();
-
-	void QUERY_EMOTE_LOAD(CPeer* pkPeer, DWORD dwHandle, TPacketGDEmote* pTable);
-	void QUERY_EMOTE_CLEAR(CPeer* pkPeer, DWORD dwHandle, TPacketGDEmote* pTable);
-	void QUERY_EMOTE_ADD(CPeer* pkPeer, DWORD dwHandle, TPacketGDEmote* pTable);
-	void QUERY_EMOTE_DUMP();
-
-	TPlayerEmoteMap m_map_kPlayerEmote;
-	int m_iEmoteDumpDelay;
+#if defined(__GUILD_DRAGONLAIR_PARTY_SYSTEM__)
+	void GuildDungeon(TPacketGDGuildDungeon* sPacket);
+	void GuildDungeonGD(TPacketGDGuildDungeonCD* sPacket);
+	void GuildDungeonST(TPacketGDGuildDungeonST* sPacket);
 #endif
 
 #if defined(__MAILBOX__)
@@ -654,44 +654,6 @@
 	int m_iMailBoxBackupSec;
 	std::map<std::string, MailVec> m_map_mailbox;
 #endif
-
-#if defined(__GEM_SHOP__)
-public:
-	using GemShopTableMap = std::map<DWORD, TGemShopTable>;
-
-	bool InitializeGemShopTable();
-
-	void LoadGemShop(CPeer* pPeer, DWORD dwHandle, TGemShopLoad* pTable, bool bUpdate = false);
-	void UpdateGemShop(CPeer* pPeer, DWORD dwHandle, TGemShopTable* pTable);
-	void FlushGemShop();
-
-	GemShopTableMap m_mapGemShopTable;
-#if defined(__CONQUEROR_LEVEL__)
-	GemShopTableMap m_mapGemShopSpecialTable;
-#endif
-	int m_iGemShopFlushDelay;
-#endif
-
-#ifdef __OFFLINE_SHOP__
-private:
-	uint32_t nextOfflineShopId_;
-	std::map<uint32_t, std::unique_ptr<COfflineShopCache>> offlineShopCache_;
-	std::map<TOfflineItemID, std::unique_ptr<COfflineShopItemCache>> offlineShopItemCache_;
-
-private:
-	void InitializeOfflineShops();
-	void RequestOfflineShopId(CPeer* peer, uint32_t queueId);
-	void SaveOfflineShop(const TOfflineShop& data, bool skipQuery = false);
-	void SaveOfflineShopItem(const TOfflineShopItem& data, bool skipQuery = false);
-	void DestroyOfflineShop(uint32_t id);
-	void UpdateOfflineShopCache();
-	void UpdateOfflineShopItemCache();
-
-	void FlushOfflineShops();
-
-public:
-	void InitializeNextOfflineShopId();
-#endif
 };
 
 template<class Func>
diff -ruN baseline/server/server/home/metin2/Source/Server/db/src/ClientManagerBoot.cpp final/server/server/home/metin2/Source/Server/db/src/ClientManagerBoot.cpp
--- baseline/server/server/home/metin2/Source/Server/db/src/ClientManagerBoot.cpp	2025-06-28 20:16:34.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/db/src/ClientManagerBoot.cpp	2022-04-27 10:05:49.000000000 +0000
@@ -8,6 +8,7 @@
 
 using namespace std;
 
+extern bool g_bUseSQLProto;
 extern int g_test_server;
 extern std::string g_stLocaleNameColumn;
 
@@ -19,25 +20,35 @@
 		return false;
 	}
 
+	if (!g_bUseSQLProto)
+	{
+		if (!MirrorMobTableIntoDB())
+		{
+			sys_err("MirrorMobTableIntoDB FAILED");
+			return false;
+		}
+	}
+
 	if (!InitializeItemTable())
 	{
 		sys_err("InitializeItemTable FAILED");
 		return false;
 	}
 
-	if (!InitializeShopTable())
+	if (!g_bUseSQLProto)
 	{
-		sys_err("InitializeShopTable FAILED");
-		return false;
+		if (!MirrorItemTableIntoDB())
+		{
+			sys_err("MirrorItemTableIntoDB FAILED");
+			return false;
+		}
 	}
 
-#if defined(__GEM_SHOP__)
-	if (!InitializeGemShopTable())
+	if (!InitializeShopTable())
 	{
-		sys_err("InitializeGemShopTable FAILED");
+		sys_err("InitializeShopTable FAILED");
 		return false;
 	}
-#endif
 
 	if (!InitializeSkillTable())
 	{
@@ -92,23 +103,6 @@
 		sys_err("InitializeMonarch FAILED");
 		return false;
 	}
-
-#if defined(__MAILBOX__)
-	if (!InitializeMailBoxTable())
-	{
-		sys_err("InitializeMailBoxTable FAILED");
-		return false;
-	}
-#endif
-
-#if defined(__EXPRESSING_EMOTIONS__)
-	if (!InitializeEmoteTable())
-	{
-		sys_err("InitializeEmoteTable FAILED");
-		return false;
-	}
-#endif
-
 #ifdef __GROWTH_PET_SYSTEM__
 	if (!InitializeGrowthPetSkillTable())
 	{
@@ -117,10 +111,13 @@
 	}
 #endif
 
-#ifdef __OFFLINE_SHOP__
-		InitializeOfflineShops();
+#if defined(__MAILBOX__)
+	if (!InitializeMailBoxTable())
+	{
+		sys_err("InitializeMailBoxTable FAILED");
+		return false;
+	}
 #endif
-
 	return true;
 }
 
@@ -258,6 +255,128 @@
 
 bool CClientManager::InitializeMobTable()
 {
+	if (g_bUseSQLProto)
+	{
+		char szQuery[QUERY_MAX_LEN];
+		snprintf(szQuery, sizeof(szQuery),
+			"SELECT `vnum`, `name`, `%s`, `type`, `rank`, `battle_type`, `level`, `size`+0, `ai_flag`+0, `setRaceFlag`+0, `setImmuneFlag`+0, "
+			"`on_click`, `empire`, `drop_item`, `resurrection_vnum`, `folder`, "
+			"`st`, `dx`, `ht`, `iq`, `damage_min`, `damage_max`, `max_hp`, `regen_cycle`, `regen_percent`, `exp`, "
+			"`gold_min`, `gold_max`, `def`, `attack_speed`, `move_speed`, `aggressive_hp_pct`, `aggressive_sight`, `attack_range`, `polymorph_item`, "
+
+			"`enchant_curse`, `enchant_slow`, `enchant_poison`, `enchant_stun`, `enchant_critical`, `enchant_penetrate`, "
+			"`resist_sword`, `resist_twohand`, `resist_dagger`, `resist_bell`, `resist_fan`, `resist_bow`, `resist_claw`, "
+
+			"`resist_fire`, `resist_elect`, `resist_magic`, `resist_wind`, `resist_poison`, `resist_bleeding`, "
+			"`att_elec`, `att_fire`, `att_ice`, `att_wind`, `att_earth`, `att_dark`, "
+			"`dam_multiply`, `summon`, `drain_sp`, "
+
+			"`skill_vnum0`, `skill_level0`, `skill_vnum1`, `skill_level1`, `skill_vnum2`, `skill_level2`, "
+			"`skill_vnum3`, `skill_level3`, `skill_vnum4`, `skill_level4`, "
+			"`sp_berserk`, `sp_stoneskin`, `sp_godspeed`, `sp_deathblow`, `sp_revive` "
+			"FROM mob_proto%s ORDER BY vnum",
+			g_stLocaleNameColumn.c_str(), GetTablePostfix()
+		);
+
+		std::unique_ptr<SQLMsg> pkMsg(CDBManager::instance().DirectQuery(szQuery));
+		SQLResult* pRes = pkMsg->Get();
+
+		if (!pRes->uiNumRows)
+		{
+			sys_err("Could not load mob_proto. No results!");
+			return false;
+		}
+
+		sys_log(0, "MOB_PROTO loading...");
+
+		if (!m_vec_mobTable.empty())
+		{
+			sys_log(0, "RELOAD: mob_proto");
+			m_vec_mobTable.clear();
+		}
+
+		m_vec_mobTable.resize(pRes->uiNumRows);
+		memset(&m_vec_mobTable[0], 0, sizeof(TMobTable) * m_vec_mobTable.size());
+		TMobTable* mob_table = &m_vec_mobTable[0];
+
+		MYSQL_ROW data;
+		int col;
+		while ((data = mysql_fetch_row(pRes->pSQLResult)))
+		{
+			col = 0;
+			str_to_number(mob_table->dwVnum, data[col++]);
+			strlcpy(mob_table->szName, data[col++], sizeof(mob_table->szName));
+			strlcpy(mob_table->szLocaleName, data[col++], sizeof(mob_table->szLocaleName));
+			str_to_number(mob_table->bType, data[col++]);
+			str_to_number(mob_table->bRank, data[col++]);
+			str_to_number(mob_table->bBattleType, data[col++]);
+			str_to_number(mob_table->bLevel, data[col++]);
+			str_to_number(mob_table->bSize, data[col++]);
+			str_to_number(mob_table->dwAIFlag, data[col++]);
+			str_to_number(mob_table->dwRaceFlag, data[col++]);
+			str_to_number(mob_table->dwImmuneFlag, data[col++]);
+			str_to_number(mob_table->bOnClickType, data[col++]);
+			str_to_number(mob_table->bEmpire, data[col++]);
+			str_to_number(mob_table->dwDropItemVnum, data[col++]);
+			str_to_number(mob_table->dwResurrectionVnum, data[col++]);
+			strlcpy(mob_table->szFolder, data[col++], sizeof(mob_table->szFolder));
+			str_to_number(mob_table->bStr, data[col++]);
+			str_to_number(mob_table->bDex, data[col++]);
+			str_to_number(mob_table->bCon, data[col++]);
+			str_to_number(mob_table->bInt, data[col++]);
+			str_to_number(mob_table->dwDamageRange[0], data[col++]);
+			str_to_number(mob_table->dwDamageRange[1], data[col++]);
+			str_to_number(mob_table->dwMaxHP, data[col++]);
+			str_to_number(mob_table->bRegenCycle, data[col++]);
+			str_to_number(mob_table->bRegenPercent, data[col++]);
+			str_to_number(mob_table->dwExp, data[col++]);
+			str_to_number(mob_table->dwGoldMin, data[col++]);
+			str_to_number(mob_table->dwGoldMax, data[col++]);
+			str_to_number(mob_table->wDef, data[col++]);
+			str_to_number(mob_table->sAttackSpeed, data[col++]);
+			str_to_number(mob_table->sMovingSpeed, data[col++]);
+			str_to_number(mob_table->bAggresiveHPPct, data[col++]);
+			str_to_number(mob_table->wAggressiveSight, data[col++]);
+			str_to_number(mob_table->wAttackRange, data[col++]);
+			str_to_number(mob_table->dwPolymorphItemVnum, data[col++]);
+
+			int i;
+			for (i = 0; i < MOB_ENCHANTS_MAX_NUM; ++i)
+				str_to_number(mob_table->cEnchants[i], data[col++]);
+
+			for (i = 0; i < MOB_RESISTS_MAX_NUM; ++i)
+				str_to_number(mob_table->cResists[i], data[col++]);
+
+#if defined(__ELEMENT_SYSTEM__)
+			for (i = 0; i < MOB_ELEMENT_MAX_NUM; ++i)
+				str_to_number(mob_table->cElements[i], data[col++]);
+#endif
+
+			str_to_number(mob_table->fDamMultiply, data[col++]);
+			str_to_number(mob_table->dwSummonVnum, data[col++]);
+			str_to_number(mob_table->dwDrainSP, data[col++]);
+
+			for (i = 0; i < MOB_SKILL_MAX_NUM; ++i)
+			{
+				str_to_number(mob_table->Skills[i].dwVnum, data[col++]);
+				str_to_number(mob_table->Skills[i].bLevel, data[col++]);
+			}
+
+			str_to_number(mob_table->bBerserkPoint, data[col++]);
+			str_to_number(mob_table->bStoneSkinPoint, data[col++]);
+			str_to_number(mob_table->bGodSpeedPoint, data[col++]);
+			str_to_number(mob_table->bDeathBlowPoint, data[col++]);
+			str_to_number(mob_table->bRevivePoint, data[col++]);
+
+			sys_log(1, "MOB #%-5d %-24s %-24s level: %-3u rank: %u empire: %d", mob_table->dwVnum, mob_table->szName, mob_table->szLocaleName, mob_table->bLevel, mob_table->bRank, mob_table->bEmpire);
+			++mob_table;
+		}
+
+		sort(m_vec_mobTable.begin(), m_vec_mobTable.end(), FCompareVnum());
+		sys_log(0, "CClientManager::InitializeMobTable:: %d mobs loaded.n", m_vec_mobTable.size());
+		return true;
+	}
+
 	map<int, const char*> localMap;
 
 	cCsvTable nameData;
@@ -370,23 +489,26 @@
 		if (!data[col]) // ¾ÆÀÌÅÛÀÌ ÇÏ³ªµµ ¾øÀ¸¸é NULLÀÌ ¸®ÅÏ µÇ¹Ç·Î..
 			continue;
 
-		TShopItemTable* pItem = &shop_table->items[shop_table->bItemCount];
+		TShopItemTable* pItem = &shop_table->items[shop_table->wItemCount];
 
 		str_to_number(pItem->vnum, data[col++]);
 		str_to_number(pItem->count, data[col++]);
 
-		++shop_table->bItemCount;
+		++shop_table->wItemCount;
 	}
 
 	m_pShopTable = new TShopTable[map_shop.size()];
 	m_iShopTableSize = map_shop.size();
 
+	// std::map<int, TShopTable*>::const_iterator it = map_shop.begin();
+	__typeof__(map_shop.begin()) it = map_shop.begin();
+
 	int i = 0;
-	auto it = map_shop.begin();
+
 	while (it != map_shop.end())
 	{
 		thecore_memcpy((m_pShopTable + i), (it++)->second, sizeof(TShopTable));
-		sys_log(0, "SHOP: #%d items: %d", (m_pShopTable + i)->dwVnum, (m_pShopTable + i)->bItemCount);
+		sys_log(0, "SHOP: #%d items: %d", (m_pShopTable + i)->dwVnum, (m_pShopTable + i)->wItemCount);
 		++i;
 	}
 
@@ -449,6 +571,113 @@
 
 bool CClientManager::InitializeItemTable()
 {
+	if (g_bUseSQLProto)
+	{
+		char szQuery[QUERY_MAX_LEN];
+		snprintf(szQuery, sizeof(szQuery),
+			"SELECT `vnum`, `name`, `%s`, `type`, `subtype`, `gold`, `shop_buy_price`, `weight`, `size`, "
+			"`flag`, `wearflag`, `antiflag`, immuneflag+0, "
+			"`refined_vnum`, `refine_set`, `magic_pct`, `socket_pct`, `addon_type`, "
+			"`limittype0`, `limitvalue0`, `limittype1`, `limitvalue1`, "
+			"`applytype0`, `applyvalue0`, `applytype1`, `applyvalue1`, `applytype2`, `applyvalue2`, "
+#if defined(__ITEM_APPLY4__)
+			"`applyvalue3`, `applytype3`, "
+#endif
+			"`value0`, `value1`, `value2`, `value3`, `value4`, `value5` "
+			"FROM item_proto%s ORDER BY vnum",
+			g_stLocaleNameColumn.c_str(), GetTablePostfix()
+		);
+
+		std::unique_ptr<SQLMsg> pkMsg(CDBManager::instance().DirectQuery(szQuery));
+		SQLResult* pRes = pkMsg->Get();
+
+		if (!pRes->uiNumRows)
+		{
+			sys_err("Could not load item_proto. No results!");
+			return false;
+		}
+
+		sys_log(0, "ITEM_PROTO loading...");
+
+		if (!m_vec_itemTable.empty())
+		{
+			sys_log(0, "RELOAD: item_proto");
+			m_vec_itemTable.clear();
+			m_map_itemTableByVnum.clear();
+		}
+
+		m_vec_itemTable.resize(pRes->uiNumRows);
+		memset(&m_vec_itemTable[0], 0, sizeof(TItemTable) * m_vec_itemTable.size());
+		TItemTable* item_table = &m_vec_itemTable[0];
+
+		MYSQL_ROW data;
+		int col;
+
+		while ((data = mysql_fetch_row(pRes->pSQLResult)))
+		{
+			col = 0;
+
+			str_to_number(item_table->dwVnum, data[col++]);
+			//str_to_number(item_table->dwVnumRange, data[col++]);
+			strlcpy(item_table->szName, data[col++], sizeof(item_table->szName));
+			strlcpy(item_table->szLocaleName, data[col++], sizeof(item_table->szLocaleName));
+			str_to_number(item_table->bType, data[col++]);
+			str_to_number(item_table->bSubType, data[col++]);
+			str_to_number(item_table->dwGold, data[col++]);
+			str_to_number(item_table->dwShopBuyPrice, data[col++]);
+			str_to_number(item_table->bWeight, data[col++]);
+			str_to_number(item_table->bSize, data[col++]);
+			str_to_number(item_table->dwFlags, data[col++]);
+			str_to_number(item_table->dwWearFlags, data[col++]);
+			str_to_number(item_table->ullAntiFlags, data[col++]);
+			str_to_number(item_table->dwImmuneFlag, data[col++]);
+			str_to_number(item_table->dwRefinedVnum, data[col++]);
+			str_to_number(item_table->wRefineSet, data[col++]);
+			str_to_number(item_table->bAlterToMagicItemPct, data[col++]);
+			str_to_number(item_table->bGainSocketPct, data[col++]);
+			str_to_number(item_table->sAddonType, data[col++]);
+
+			item_table->cLimitRealTimeFirstUseIndex = -1;
+			item_table->cLimitTimerBasedOnWearIndex = -1;
+
+			int i;
+			for (i = 0; i < ITEM_LIMIT_MAX_NUM; ++i)
+			{
+				str_to_number(item_table->aLimits[i].bType, data[col++]);
+				str_to_number(item_table->aLimits[i].lValue, data[col++]);
+
+				if (LIMIT_REAL_TIME_START_FIRST_USE == item_table->aLimits[i].bType)
+					item_table->cLimitRealTimeFirstUseIndex = (char)i;
+
+				if (LIMIT_TIMER_BASED_ON_WEAR == item_table->aLimits[i].bType)
+					item_table->cLimitTimerBasedOnWearIndex = (char)i;
+			}
+
+			for (i = 0; i < ITEM_APPLY_MAX_NUM; ++i)
+			{
+				str_to_number(item_table->aApplies[i].bType, data[col++]);
+				str_to_number(item_table->aApplies[i].lValue, data[col++]);
+			}
+
+			for (i = 0; i < ITEM_VALUES_MAX_NUM; ++i)
+				str_to_number(item_table->alValues[i], data[col++]);
+
+			sys_log(1, "ITEM: #%-5lu %-24s %-24s VAL: %ld %ld %ld %ld %ld %ld WEAR %lu ANTI %lu IMMUNE %lu REFINE %lu REFINE_SET %u MAGIC_PCT %u",
+				item_table->dwVnum, item_table->szName, item_table->szLocaleName,
+				item_table->alValues[0], item_table->alValues[1], item_table->alValues[2],
+				item_table->alValues[3], item_table->alValues[4], item_table->alValues[5],
+				item_table->dwWearFlags, item_table->ullAntiFlags, item_table->dwImmuneFlag,
+				item_table->dwRefinedVnum, item_table->wRefineSet, item_table->bAlterToMagicItemPct);
+
+			m_map_itemTableByVnum.insert(std::map<DWORD, TItemTable*>::value_type(item_table->dwVnum, item_table));
+			++item_table;
+		}
+
+		sort(m_vec_itemTable.begin(), m_vec_itemTable.end(), FCompareVnum());
+		sys_log(0, "CClientManager::InitializeMobTable:: %d items loaded.n", m_vec_itemTable.size());
+		return true;
+	}
+
 	map<int, const char*> localMap;
 	cCsvTable nameData;
 	if (!nameData.Load("item_names.txt", '\t'))
@@ -510,12 +739,14 @@
 
 	m_map_itemTableByVnum.clear();
 
-	auto it = m_vec_itemTable.begin();
+	// ItemTableVector::iterator it = m_vec_itemTable.begin();
+	itertype(m_vec_itemTable) it = m_vec_itemTable.begin();
+
 	while (it != m_vec_itemTable.end())
 	{
 		TItemTable* item_table = &(*(it++));
 
-		sys_log(1, "ITEM: #%-5lu %-24s %-24s VAL: %ld %ld %ld %ld %ld %ld WEAR %lu ANTI %llu IMMUNE %lu REFINE %lu REFINE_SET %u ATTR67_MATERIAL %u MAGIC_PCT %u",
+		sys_log(1, "ITEM: #%-5lu %-24s %-24s VAL: %ld %ld %ld %ld %ld %ld WEAR %lu ANTI %llu IMMUNE %lu REFINE %lu REFINE_SET %u MAGIC_PCT %u",
 			item_table->dwVnum,
 			item_table->szName,
 			item_table->szLocaleName,
@@ -530,13 +761,11 @@
 			item_table->dwImmuneFlag,
 			item_table->dwRefinedVnum,
 			item_table->wRefineSet,
-			item_table->dw67AttrMaterial,
 			item_table->bAlterToMagicItemPct);
 
 		m_map_itemTableByVnum.insert(std::map<DWORD, TItemTable*>::value_type(item_table->dwVnum, item_table));
 	}
 	sort(m_vec_itemTable.begin(), m_vec_itemTable.end(), FCompareVnum());
-
 	return true;
 }
 
@@ -662,18 +891,7 @@
 {
 	char query[4096];
 	snprintf(query, sizeof(query),
-		"SELECT `apply`, `apply`+0, `prob`, "
-		"`lv1`, `lv2`, `lv3`, `lv4`, `lv5`, "
-#if defined(__ATTR_6TH_7TH__)
-		"`lv6`, `lv7`, `lv8`, `lv9`, `lv10`, "
-#endif
-		"`weapon`, `body`, `wrist`, `foots`, `neck`, `head`, `shield`, `ear`"
-#if defined(__PENDANT_SYSTEM__)
-		", `pendant`"
-#endif
-#if defined(__GLOVE_SYSTEM__)
-		", `glove`"
-#endif
+		"SELECT `apply`, `apply`+0, `prob`, `lv1`, `lv2`, `lv3`, `lv4`, `lv5`, `weapon`, `body`, `wrist`, `foots`, `neck`, `head`, `shield`, `ear`"
 #if defined(__COSTUME_SYSTEM__)
 		", `costume_body`"
 		", `costume_hair`"
@@ -681,6 +899,12 @@
 		", `costume_weapon`"
 #endif
 #endif
+#if defined(__PENDANT_SYSTEM__)
+		", `pendant`"
+#endif
+#if defined(__GLOVE_SYSTEM__)
+		", `glove`"
+#endif
 		" FROM item_attr%s ORDER BY `apply`",
 		GetTablePostfix()
 	);
@@ -713,20 +937,13 @@
 		int col = 0;
 
 		strlcpy(t.szApply, data[col++], sizeof(t.szApply));
-		str_to_number(t.wApplyIndex, data[col++]);
+		str_to_number(t.dwApplyIndex, data[col++]);
 		str_to_number(t.dwProb, data[col++]);
 		str_to_number(t.lValues[0], data[col++]);
 		str_to_number(t.lValues[1], data[col++]);
 		str_to_number(t.lValues[2], data[col++]);
 		str_to_number(t.lValues[3], data[col++]);
 		str_to_number(t.lValues[4], data[col++]);
-#if defined(__ATTR_6TH_7TH__)
-		str_to_number(t.lValues[5], data[col++]);
-		str_to_number(t.lValues[6], data[col++]);
-		str_to_number(t.lValues[7], data[col++]);
-		str_to_number(t.lValues[8], data[col++]);
-		str_to_number(t.lValues[9], data[col++]);
-#endif
 		str_to_number(t.bMaxLevelBySet[ATTRIBUTE_SET_WEAPON], data[col++]);
 		str_to_number(t.bMaxLevelBySet[ATTRIBUTE_SET_BODY], data[col++]);
 		str_to_number(t.bMaxLevelBySet[ATTRIBUTE_SET_WRIST], data[col++]);
@@ -735,12 +952,6 @@
 		str_to_number(t.bMaxLevelBySet[ATTRIBUTE_SET_HEAD], data[col++]);
 		str_to_number(t.bMaxLevelBySet[ATTRIBUTE_SET_SHIELD], data[col++]);
 		str_to_number(t.bMaxLevelBySet[ATTRIBUTE_SET_EAR], data[col++]);
-#if defined(__PENDANT_SYSTEM__)
-		str_to_number(t.bMaxLevelBySet[ATTRIBUTE_SET_PENDANT], data[col++]);
-#endif
-#if defined(__GLOVE_SYSTEM__)
-		str_to_number(t.bMaxLevelBySet[ATTRIBUTE_SET_GLOVE], data[col++]);
-#endif
 #if defined(__COSTUME_SYSTEM__)
 		str_to_number(t.bMaxLevelBySet[ATTRIBUTE_SET_COSTUME_BODY], data[col++]);
 		str_to_number(t.bMaxLevelBySet[ATTRIBUTE_SET_COSTUME_HAIR], data[col++]);
@@ -748,6 +959,12 @@
 		str_to_number(t.bMaxLevelBySet[ATTRIBUTE_SET_COSTUME_WEAPON], data[col++]);
 #endif
 #endif
+#if defined(__PENDANT_SYSTEM__)
+		str_to_number(t.bMaxLevelBySet[ATTRIBUTE_SET_PENDANT], data[col++]);
+#endif
+#if defined(__GLOVE_SYSTEM__)
+		str_to_number(t.bMaxLevelBySet[ATTRIBUTE_SET_GLOVE], data[col++]);
+#endif
 
 		if (!m_bWolfmanCharacter)
 		{
@@ -766,17 +983,7 @@
 					continue;
 		}
 
-		sys_log(0, "ITEM_RARE: %-20s %4lu { %3d %3d %3d %3d %3d "
-#if defined(__ATTR_6TH_7TH__)
-			"%3d %3d %3d %3d %3d"
-#endif
-			"} { %d %d %d %d %d %d %d "
-#if defined(__PENDANT_SYSTEM__)
-			"%d "
-#endif
-#if defined(__GLOVE_SYSTEM__)
-			"%d "
-#endif
+		sys_log(0, "ITEM_ATTR: %-20s %4lu { %3d %3d %3d %3d %3d } { %d %d %d %d %d %d %d "
 #if defined(__COSTUME_SYSTEM__)
 			"%d "
 			"%d "
@@ -784,13 +991,20 @@
 			"%d "
 #endif
 #endif
+#if defined(__PENDANT_SYSTEM__)
+			"%d "
+#endif
+#if defined(__GLOVE_SYSTEM__)
+			"%d "
+#endif
 			"}"
 			, t.szApply
 			, t.dwProb
-			, t.lValues[0], t.lValues[1], t.lValues[2], t.lValues[3], t.lValues[4]
-#if defined(__ATTR_6TH_7TH__)
-			, t.lValues[5], t.lValues[6], t.lValues[7], t.lValues[8], t.lValues[9]
-#endif
+			, t.lValues[0]
+			, t.lValues[1]
+			, t.lValues[2]
+			, t.lValues[3]
+			, t.lValues[4]
 			, t.bMaxLevelBySet[ATTRIBUTE_SET_WEAPON]
 			, t.bMaxLevelBySet[ATTRIBUTE_SET_BODY]
 			, t.bMaxLevelBySet[ATTRIBUTE_SET_WRIST]
@@ -799,12 +1013,6 @@
 			, t.bMaxLevelBySet[ATTRIBUTE_SET_HEAD]
 			, t.bMaxLevelBySet[ATTRIBUTE_SET_SHIELD]
 			, t.bMaxLevelBySet[ATTRIBUTE_SET_EAR]
-#if defined(__PENDANT_SYSTEM__)
-			, t.bMaxLevelBySet[ATTRIBUTE_SET_PENDANT]
-#endif
-#if defined(__GLOVE_SYSTEM__)
-			, t.bMaxLevelBySet[ATTRIBUTE_SET_GLOVE]
-#endif
 #if defined(__COSTUME_SYSTEM__)
 			, t.bMaxLevelBySet[ATTRIBUTE_SET_COSTUME_BODY]
 			, t.bMaxLevelBySet[ATTRIBUTE_SET_COSTUME_HAIR]
@@ -812,6 +1020,12 @@
 			, t.bMaxLevelBySet[ATTRIBUTE_SET_COSTUME_WEAPON]
 #endif
 #endif
+#if defined(__PENDANT_SYSTEM__)
+			, t.bMaxLevelBySet[ATTRIBUTE_SET_PENDANT]
+#endif
+#if defined(__GLOVE_SYSTEM__)
+			, t.bMaxLevelBySet[ATTRIBUTE_SET_GLOVE]
+#endif
 		);
 
 		m_vec_itemAttrTable.push_back(t);
@@ -824,12 +1038,14 @@
 {
 	char query[4096];
 	snprintf(query, sizeof(query),
-		"SELECT `apply`, `apply`+0, `prob`, "
-		"`lv1`, `lv2`, `lv3`, `lv4`, `lv5`, "
-#if defined(__ATTR_6TH_7TH__)
-		"`lv6`, `lv7`, `lv8`, `lv9`, `lv10`, "
+		"SELECT `apply`, `apply`+0, `prob`, `lv1`, `lv2`, `lv3`, `lv4`, `lv5`, `weapon`, `body`, `wrist`, `foots`, `neck`, `head`, `shield`, `ear`"
+#if defined(__COSTUME_SYSTEM__)
+		", `costume_body`"
+		", `costume_hair`"
+#if defined(__WEAPON_COSTUME_SYSTEM__)
+		", `costume_weapon`"
+#endif
 #endif
-		"`weapon`, `body`, `wrist`, `foots`, `neck`, `head`, `shield`, `ear`"
 #if defined(__PENDANT_SYSTEM__)
 		", `pendant`"
 #endif
@@ -868,20 +1084,13 @@
 		int col = 0;
 
 		strlcpy(t.szApply, data[col++], sizeof(t.szApply));
-		str_to_number(t.wApplyIndex, data[col++]);
+		str_to_number(t.dwApplyIndex, data[col++]);
 		str_to_number(t.dwProb, data[col++]);
 		str_to_number(t.lValues[0], data[col++]);
 		str_to_number(t.lValues[1], data[col++]);
 		str_to_number(t.lValues[2], data[col++]);
 		str_to_number(t.lValues[3], data[col++]);
 		str_to_number(t.lValues[4], data[col++]);
-#if defined(__ATTR_6TH_7TH__)
-		str_to_number(t.lValues[5], data[col++]);
-		str_to_number(t.lValues[6], data[col++]);
-		str_to_number(t.lValues[7], data[col++]);
-		str_to_number(t.lValues[8], data[col++]);
-		str_to_number(t.lValues[9], data[col++]);
-#endif
 		str_to_number(t.bMaxLevelBySet[ATTRIBUTE_SET_WEAPON], data[col++]);
 		str_to_number(t.bMaxLevelBySet[ATTRIBUTE_SET_BODY], data[col++]);
 		str_to_number(t.bMaxLevelBySet[ATTRIBUTE_SET_WRIST], data[col++]);
@@ -890,6 +1099,13 @@
 		str_to_number(t.bMaxLevelBySet[ATTRIBUTE_SET_HEAD], data[col++]);
 		str_to_number(t.bMaxLevelBySet[ATTRIBUTE_SET_SHIELD], data[col++]);
 		str_to_number(t.bMaxLevelBySet[ATTRIBUTE_SET_EAR], data[col++]);
+#if defined(__COSTUME_SYSTEM__)
+		str_to_number(t.bMaxLevelBySet[ATTRIBUTE_SET_COSTUME_BODY], data[col++]);
+		str_to_number(t.bMaxLevelBySet[ATTRIBUTE_SET_COSTUME_HAIR], data[col++]);
+#if defined(__WEAPON_COSTUME_SYSTEM__)
+		str_to_number(t.bMaxLevelBySet[ATTRIBUTE_SET_COSTUME_WEAPON], data[col++]);
+#endif
+#endif
 #if defined(__PENDANT_SYSTEM__)
 		str_to_number(t.bMaxLevelBySet[ATTRIBUTE_SET_PENDANT], data[col++]);
 #endif
@@ -897,11 +1113,14 @@
 		str_to_number(t.bMaxLevelBySet[ATTRIBUTE_SET_GLOVE], data[col++]);
 #endif
 
-		sys_log(0, "ITEM_RARE: %-20s %4lu { %3d %3d %3d %3d %3d "
-#if defined(__ATTR_6TH_7TH__)
-			"%3d %3d %3d %3d %3d"
+		sys_log(0, "ITEM_RARE: %-20s %4lu { %3d %3d %3d %3d %3d } { %d %d %d %d %d %d %d "
+#if defined(__COSTUME_SYSTEM__)
+			"%d "
+			"%d "
+#if defined(__WEAPON_COSTUME_SYSTEM__)
+			"%d "
+#endif
 #endif
-			"} { %d %d %d %d %d %d %d "
 #if defined(__PENDANT_SYSTEM__)
 			"%d "
 #endif
@@ -909,11 +1128,13 @@
 			"%d "
 #endif
 			"}"
-			, t.szApply, t.dwProb
-			, t.lValues[0], t.lValues[1], t.lValues[2], t.lValues[3], t.lValues[4]
-#if defined(__ATTR_6TH_7TH__)
-			, t.lValues[5], t.lValues[6], t.lValues[7], t.lValues[8], t.lValues[9]
-#endif
+			, t.szApply
+			, t.dwProb
+			, t.lValues[0]
+			, t.lValues[1]
+			, t.lValues[2]
+			, t.lValues[3]
+			, t.lValues[4]
 			, t.bMaxLevelBySet[ATTRIBUTE_SET_WEAPON]
 			, t.bMaxLevelBySet[ATTRIBUTE_SET_BODY]
 			, t.bMaxLevelBySet[ATTRIBUTE_SET_WRIST]
@@ -922,6 +1143,13 @@
 			, t.bMaxLevelBySet[ATTRIBUTE_SET_HEAD]
 			, t.bMaxLevelBySet[ATTRIBUTE_SET_SHIELD]
 			, t.bMaxLevelBySet[ATTRIBUTE_SET_EAR]
+#if defined(__COSTUME_SYSTEM__)
+			, t.bMaxLevelBySet[ATTRIBUTE_SET_COSTUME_BODY]
+			, t.bMaxLevelBySet[ATTRIBUTE_SET_COSTUME_HAIR]
+#if defined(__WEAPON_COSTUME_SYSTEM__)
+			, t.bMaxLevelBySet[ATTRIBUTE_SET_COSTUME_WEAPON]
+#endif
+#endif
 #if defined(__PENDANT_SYSTEM__)
 			, t.bMaxLevelBySet[ATTRIBUTE_SET_PENDANT]
 #endif
@@ -1061,10 +1289,9 @@
 
 	m_vec_kObjectProto.reserve(MAX(0, pRes->uiNumRows));
 
-	MYSQL_ROW data;
+	MYSQL_ROW	data;
 
 	if (pRes->uiNumRows > 0)
-	{
 		while ((data = mysql_fetch_row(pRes->pSQLResult)))
 		{
 			TObjectProto t;
@@ -1109,7 +1336,6 @@
 
 			m_vec_kObjectProto.push_back(t);
 		}
-	}
 
 	return true;
 }
@@ -1168,84 +1394,31 @@
 	return true;
 }
 
-#if defined(__EXPRESSING_EMOTIONS__)
-bool CClientManager::InitializeEmoteTable()
-{
-	if (m_map_kPlayerEmote.empty() == false)
-		return true;
-
-	char szQuery[1024];
-	sprintf(szQuery, "SELECT `pid`, `vnum`, UNIX_TIMESTAMP(`duration`) FROM emotions%s", GetTablePostfix());
-
-	std::unique_ptr<SQLMsg> pkMsg(CDBManager::instance().DirectQuery(szQuery));
-	const SQLResult* pkRes = pkMsg->Get();
-	if (!pkRes->uiNumRows)
-		return true;
-
-	const DWORD dwCurrentTime = static_cast<DWORD>(std::time(nullptr));
-
-	MYSQL_ROW kData;
-	while ((kData = mysql_fetch_row(pkRes->pSQLResult)))
-	{
-		BYTE bColumn = 0; TPacketGDEmote kTable;
-
-		str_to_number(kTable.dwPID, kData[bColumn++]);
-		str_to_number(kTable.dwVnum, kData[bColumn++]);
-		str_to_number(kTable.dwDuration, kData[bColumn++]);
-
-		if (dwCurrentTime > kTable.dwDuration)
-			continue;
-	
-		m_map_kPlayerEmote[kTable.dwPID].emplace_back(kTable);
-	}
-
-	return true;
-}
-#endif
-
 #if defined(__MAILBOX__)
 bool CClientManager::InitializeMailBoxTable()
 {
 	if (m_map_mailbox.empty() == false)
 		return true;
 
-	char szQuery[QUERY_MAX_LEN];
-	int len = sprintf(szQuery, "SELECT `name`, `who`, `title`, `message`, `gm`, `confirm`, `send_time`, `delete_time`"
-		", `gold`, `won`, `vnum`, `count`"
-	);
+	char s_szQuery[512];
+	int len = sprintf(s_szQuery, "SELECT name, who, title, message, gm, confirm, send_time, delete_time, gold, won, ivnum, ichangelookvnum, icount, ");
 
 	for (BYTE i = 0; i < ITEM_SOCKET_MAX_NUM; i++)
-		len += sprintf(szQuery + len, ", `socket%u`", i);
+		len += sprintf(s_szQuery + len, "socket%d, ", i);
 
 	for (BYTE i = 0; i < ITEM_ATTRIBUTE_MAX_NUM; i++)
-		len += sprintf(szQuery + len, ", `attrtype%u`, `attrvalue%u`", i, i);
-
-#if defined(__CHANGE_LOOK_SYSTEM__)
-	len += sprintf(szQuery + len, ", `changelookvnum`");
-#endif
-
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	len += sprintf(szQuery + len,
-		", `refine_element_apply_type`"
-		", `refine_element_grade`"
-		", `refine_element_value0`, `refine_element_value1`, `refine_element_value2`"
-		", `refine_element_bonus_value0`, `refine_element_bonus_value1`, `refine_element_bonus_value2`"
-	);
-#endif
-
-#if defined(__ITEM_APPLY_RANDOM__)
-	for (BYTE i = 0; i < ITEM_APPLY_MAX_NUM; i++)
-		len += sprintf(szQuery + len, ", `apply_type%u`, `apply_value%u`, `apply_path%u`", i, i, i);
-#endif
+	{
+		len += sprintf(s_szQuery + len, "attrtype%d, attrvalue%d ", i, i);
+		if (i != ITEM_ATTRIBUTE_MAX_NUM - 1)
+			len += sprintf(s_szQuery + len, ", ");
+	}
 
-#if defined(__SET_ITEM__)
-	len += sprintf(szQuery + len, ", `set_value`");
-#endif
+	len += sprintf(s_szQuery + len, "FROM mailbox%s", GetTablePostfix());
 
-	len += sprintf(szQuery + len, " FROM `mailbox%s`", GetTablePostfix());
+	std::unique_ptr<SQLMsg> pkMsg(CDBManager::instance().DirectQuery(s_szQuery));
 
-	std::unique_ptr<SQLMsg> pkMsg(CDBManager::instance().DirectQuery(szQuery));
 	const SQLResult* pRes = pkMsg->Get();
+
 	if (!pRes->uiNumRows)
 		return true;
 
@@ -1259,7 +1432,6 @@
 		mail.bIsDeleted = false;
 		mail.AddData.bHeader = 0;
 		mail.AddData.Index = 0;
-
 		std::memcpy(mail.szName, name, sizeof(mail.szName));
 		std::memcpy(mail.AddData.szFrom, data[col++], sizeof(mail.AddData.szFrom));
 		std::memcpy(mail.Message.szTitle, data[col++], sizeof(mail.Message.szTitle));
@@ -1270,45 +1442,28 @@
 		str_to_number(mail.Message.DeleteTime, data[col++]);
 		str_to_number(mail.AddData.iYang, data[col++]);
 		str_to_number(mail.AddData.iWon, data[col++]);
-		str_to_number(mail.AddData.dwItemVnum, data[col++]);
-		str_to_number(mail.AddData.dwItemCount, data[col++]);
-
-		mail.Message.bIsItemExist = mail.AddData.dwItemVnum > 0 || mail.AddData.iYang > 0 || mail.AddData.iWon > 0;
+		str_to_number(mail.AddData.ItemVnum, data[col++]);
+		str_to_number(mail.AddData.ChangeLookVnum, data[col++]);
+		str_to_number(mail.AddData.ItemCount, data[col++]);
+		mail.Message.bIsItemExist = mail.AddData.ItemVnum > 0 || mail.AddData.iYang > 0 || mail.AddData.iWon > 0;
 
 		for (BYTE i = 0; i < ITEM_SOCKET_MAX_NUM; i++)
 			str_to_number(mail.AddData.alSockets[i], data[col++]);
 
-		for (BYTE i = 0; i < ITEM_ATTRIBUTE_MAX_NUM; i++)
-		{
-			str_to_number(mail.AddData.aAttr[i].wType, data[col++]);
-			str_to_number(mail.AddData.aAttr[i].lValue, data[col++]);
-		}
-
-#if defined(__CHANGE_LOOK_SYSTEM__)
-		str_to_number(mail.AddData.dwChangeLookVnum, data[col++]);
-#endif
-
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-		str_to_number(mail.AddData.RefineElement.wApplyType, data[col++]);
-		str_to_number(mail.AddData.RefineElement.bGrade, data[col++]);
-		for (BYTE i = 0; i < REFINE_ELEMENT_MAX; i++)
-			str_to_number(mail.AddData.RefineElement.abValue[i], data[col++]);
-		for (BYTE i = 0; i < REFINE_ELEMENT_MAX; i++)
-			str_to_number(mail.AddData.RefineElement.abBonusValue[i], data[col++]);
-#endif
-
 #if defined(__ITEM_APPLY_RANDOM__)
 		for (BYTE i = 0; i < ITEM_APPLY_MAX_NUM; i++)
 		{
-			str_to_number(mail.AddData.aApplyRandom[i].wType, data[col++]);
-			str_to_number(mail.AddData.aApplyRandom[i].lValue, data[col++]);
+			str_to_number(mail.AddData.aApplyRandom[i].bType, data[col++]);
+			str_to_number(mail.AddData.aApplyRandom[i].sValue, data[col++]);
 			str_to_number(mail.AddData.aApplyRandom[i].bPath, data[col++]);
 		}
 #endif
 
-#if defined(__SET_ITEM__)
-		str_to_number(mail.AddData.bSetValue, data[col++]);
-#endif
+		for (BYTE i = 0; i < ITEM_ATTRIBUTE_MAX_NUM; i++)
+		{
+			str_to_number(mail.AddData.aAttr[i].bType, data[col++]);
+			str_to_number(mail.AddData.aAttr[i].sValue, data[col++]);
+		}
 
 		m_map_mailbox[name].emplace_back(mail);
 	}
@@ -1317,207 +1472,211 @@
 }
 #endif
 
-#if defined(__GEM_SHOP__)
-bool CClientManager::InitializeGemShopTable()
+bool CClientManager::MirrorMobTableIntoDB()
 {
-	// Load Default Gem Shop Table
+	// for (MobTableVector::const_iterator it = m_vec_mobTable.begin(); it != m_vec_mobTable.end(); it++)
+	for (itertype(m_vec_mobTable) it = m_vec_mobTable.begin(); it != m_vec_mobTable.end(); it++)
 	{
-		if (m_mapGemShopTable.empty() == false)
-			return true;
-
-		char szQuery[1024];
-		int iLen = sprintf(szQuery, "SELECT `pid`, UNIX_TIMESTAMP(`refresh_time`), `enabled_slots`");
-
-		for (BYTE i = 0; i < GEM_SHOP_SLOT_COUNT; i++)
-			iLen += sprintf(szQuery + iLen, ", `slot%d_enable`, `slot%d_vnum`, `slot%d_count`, `slot%d_price`", i, i, i, i);
-
-		iLen += sprintf(szQuery + iLen, " FROM `gem_shop%s`", GetTablePostfix());
-
-		std::unique_ptr<SQLMsg> pMsg(CDBManager::instance().DirectQuery(szQuery));
-		const SQLResult* c_pRes = pMsg->Get();
-		if (!c_pRes->uiNumRows)
-			return true;
-
-		MYSQL_ROW RowData;
-		while ((RowData = mysql_fetch_row(c_pRes->pSQLResult)))
+		const TMobTable& t = *it;
+		char query[4096];
+		if (g_stLocaleNameColumn == "name")
 		{
-			uint8_t iColumn = 0;
-			SGemShopTable GemShopTable;
-#if defined(__CONQUEROR_LEVEL__)
-			GemShopTable.bSpecial = false;
-#endif
-
-			str_to_number(GemShopTable.dwPID, RowData[iColumn++]);
-			str_to_number(GemShopTable.lRefreshTime, RowData[iColumn++]);
-			str_to_number(GemShopTable.bEnabledSlots, RowData[iColumn++]);
-			for (BYTE i = 0; i < GEM_SHOP_SLOT_COUNT; i++)
-			{
-				str_to_number(GemShopTable.GemShopItem[i].bEnable, RowData[iColumn++]);
-				str_to_number(GemShopTable.GemShopItem[i].dwItemVnum, RowData[iColumn++]);
-				str_to_number(GemShopTable.GemShopItem[i].bCount, RowData[iColumn++]);
-				str_to_number(GemShopTable.GemShopItem[i].dwPrice, RowData[iColumn++]);
-			}
-			m_mapGemShopTable.emplace(std::make_pair(GemShopTable.dwPID, GemShopTable));
+			snprintf(query, sizeof(query),
+				"REPLACE INTO mob_proto%s "
+				"("
+				"`vnum`, `name`, `type`, `rank`, `battle_type`, `level`, `size`, `ai_flag`, `setRaceFlag`, `setImmuneFlag`, "
+				"`on_click`, `empire`, `drop_item`, `resurrection_vnum`, `folder`, "
+				"`st`, `dx`, `ht`, `iq`, `damage_min`, `damage_max`, `max_hp`, `regen_cycle`, `regen_percent`, `exp`, "
+				"`gold_min`, `gold_max`, `def`, `attack_speed`, `move_speed`, `aggressive_hp_pct`, `aggressive_sight`, `attack_range`, `polymorph_item`, "
+
+				"`enchant_curse`, `enchant_slow`, `enchant_poison`, `enchant_stun`, `enchant_critical`, `enchant_penetrate`, "
+				"`resist_sword`, `resist_twohand`, `resist_dagger`, `resist_bell`, `resist_fan`, `resist_bow`, `resist_claw`, "
+				"`resist_fire`, `resist_elect`, `resist_magic`, `resist_wind`, `resist_poison`, `resist_bleeding`, "
+				"`att_elec`, `att_fire`, `att_ice`, `att_wind`, `att_earth`, `att_dark`, "
+
+				"`dam_multiply`, `summon`, `drain_sp`, "
+
+				"`skill_vnum0`, `skill_level0`, `skill_vnum1`, `skill_level1`, `skill_vnum2`, `skill_level2`, "
+				"`skill_vnum3`, `skill_level3`, `skill_vnum4`, `skill_level4`, "
+				"`sp_berserk`, `sp_stoneskin`, `sp_godspeed`, `sp_deathblow`, `sp_revive`"
+				") "
+				"VALUES ("
+
+				"%u, \"%s\", %u, %u, %u, %u, %u, %u, %u, %u, "
+				"%u, %u, %u, %u, '%s', "
+				"%u, %u, %u, %u, %u, %u, %lld, %u, %u, %u, "
+				"%u, %u, %d, %d, %d, %u, %d, %d, %u, "
+
+				"%d, %d, %d, %d, %d, %d, "
+				"%d, %d, %d, %d, %d, %d, %d, "
+				"%d, %d, %d, %d, %d, %d, "
+				"%d, %d, %d, %d, %d, %d, "
+				"%f, %u, %u, "
+
+				"%u, %u, %u, %u, %u, %u, "
+				"%u, %u, %u, %u, "
+				"%u, %u, %u, %u, %u"
+				")",
+				GetTablePostfix(), /*g_stLocaleNameColumn.c_str(),*/
+
+				t.dwVnum, t.szName, /*t.szLocaleName, */t.bType, t.bRank, t.bBattleType, t.bLevel, t.bSize, t.dwAIFlag, t.dwRaceFlag, t.dwImmuneFlag,
+				t.bOnClickType, t.bEmpire, t.dwDropItemVnum, t.dwResurrectionVnum, t.szFolder,
+				t.bStr, t.bDex, t.bCon, t.bInt, t.dwDamageRange[0], t.dwDamageRange[1], t.dwMaxHP, t.bRegenCycle, t.bRegenPercent, t.dwExp,
+
+				t.dwGoldMin, t.dwGoldMax, t.wDef, t.sAttackSpeed, t.sMovingSpeed, t.bAggresiveHPPct, t.wAggressiveSight, t.wAttackRange, t.dwPolymorphItemVnum,
+				t.cEnchants[MOB_ENCHANT_CURSE], t.cEnchants[MOB_ENCHANT_SLOW], t.cEnchants[MOB_ENCHANT_POISON], t.cEnchants[MOB_ENCHANT_STUN], t.cEnchants[MOB_ENCHANT_CRITICAL], t.cEnchants[MOB_ENCHANT_PENETRATE],
+				t.cResists[MOB_RESIST_SWORD], t.cResists[MOB_RESIST_TWOHAND], t.cResists[MOB_RESIST_DAGGER], t.cResists[MOB_RESIST_BELL], t.cResists[MOB_RESIST_FAN], t.cResists[MOB_RESIST_BOW], t.cResists[MOB_RESIST_CLAW],
+				t.cResists[MOB_RESIST_FIRE], t.cResists[MOB_RESIST_ELECT], t.cResists[MOB_RESIST_MAGIC], t.cResists[MOB_RESIST_WIND], t.cResists[MOB_RESIST_POISON], t.cResists[MOB_RESIST_BLEEDING],
+				t.cElements[MOB_ELEMENT_ELECT], t.cElements[MOB_ELEMENT_FIRE], t.cElements[MOB_ELEMENT_ICE], t.cElements[MOB_ELEMENT_WIND], t.cElements[MOB_ELEMENT_EARTH], t.cElements[MOB_ELEMENT_DARK],
+				t.fDamMultiply, t.dwSummonVnum, t.dwDrainSP,
+
+				t.Skills[0].dwVnum, t.Skills[0].bLevel, t.Skills[1].dwVnum, t.Skills[1].bLevel, t.Skills[2].dwVnum, t.Skills[2].bLevel,
+				t.Skills[3].dwVnum, t.Skills[3].bLevel, t.Skills[4].dwVnum, t.Skills[4].bLevel,
+				t.bBerserkPoint, t.bStoneSkinPoint, t.bGodSpeedPoint, t.bDeathBlowPoint, t.bRevivePoint
+			);
 		}
-	}
-
-#	if defined(__CONQUEROR_LEVEL__)
-	// Load Port (Special) Gem Shop Table
-	{
-		if (m_mapGemShopSpecialTable.empty() == false)
-			return true;
-
-		char szQuery[1024];
-		int iLen = sprintf(szQuery, "SELECT `pid`, UNIX_TIMESTAMP(`refresh_time`), `enabled_slots`");
-
-		for (BYTE i = 0; i < GEM_SHOP_SLOT_COUNT; i++)
-			iLen += sprintf(szQuery + iLen, ", `slot%d_enable`, `slot%d_vnum`, `slot%d_count`, `slot%d_price`", i, i, i, i);
-
-		iLen += sprintf(szQuery + iLen, " FROM `gem_shop_port%s`", GetTablePostfix());
-
-		std::unique_ptr<SQLMsg> pMsg(CDBManager::instance().DirectQuery(szQuery));
-		const SQLResult* c_pRes = pMsg->Get();
-		if (!c_pRes->uiNumRows)
-			return true;
-
-		MYSQL_ROW RowData;
-		while ((RowData = mysql_fetch_row(c_pRes->pSQLResult)))
+		else
 		{
-			uint8_t iColumn = 0;
-			SGemShopTable GemShopTable;
-			GemShopTable.bSpecial = true;
-
-			str_to_number(GemShopTable.dwPID, RowData[iColumn++]);
-			str_to_number(GemShopTable.lRefreshTime, RowData[iColumn++]);
-			str_to_number(GemShopTable.bEnabledSlots, RowData[iColumn++]);
-			for (BYTE i = 0; i < GEM_SHOP_SLOT_COUNT; i++)
-			{
-				str_to_number(GemShopTable.GemShopItem[i].bEnable, RowData[iColumn++]);
-				str_to_number(GemShopTable.GemShopItem[i].dwItemVnum, RowData[iColumn++]);
-				str_to_number(GemShopTable.GemShopItem[i].bCount, RowData[iColumn++]);
-				str_to_number(GemShopTable.GemShopItem[i].dwPrice, RowData[iColumn++]);
-			}
-			m_mapGemShopSpecialTable.emplace(std::make_pair(GemShopTable.dwPID, GemShopTable));
+			snprintf(query, sizeof(query),
+				"REPLACE INTO mob_proto%s "
+				"("
+				"`vnum`, `name`, `%s`, `type`, `rank`, `battle_type`, `level`, `size`, `ai_flag`, `setRaceFlag`, `setImmuneFlag`, "
+				"`on_click`, `empire`, `drop_item`, `resurrection_vnum`, `folder`, "
+				"`st`, `dx`, `ht`, `iq`, `damage_min`, `damage_max`, `max_hp`, `regen_cycle`, `regen_percent`, `exp`, "
+				"`gold_min`, `gold_max`, `def`, `attack_speed`, `move_speed`, `aggressive_hp_pct`, `aggressive_sight`, `attack_range`, `polymorph_item`, "
+
+				"`enchant_curse`, `enchant_slow`, `enchant_poison`, `enchant_stun`, `enchant_critical`, `enchant_penetrate`, "
+				"`resist_sword`, `resist_twohand`, `resist_dagger`, `resist_bell`, `resist_fan`, `resist_bow`, `resist_claw`, "
+				"`resist_fire`, `resist_elect`, `resist_magic`, `resist_wind`, `resist_poison`, `resist_bleeding`, "
+				"`att_elec`, `att_fire`, `att_ice`, `att_wind`, `att_earth`, `att_dark`, "
+				"`dam_multiply`, `summon`, `drain_sp`, "
+
+				"`skill_vnum0`, `skill_level0`, `skill_vnum1`, `skill_level1`, `skill_vnum2`, `skill_level2`, "
+				"`skill_vnum3`, `skill_level3`, `skill_vnum4`, `skill_level4`, "
+				"`sp_berserk`, `sp_stoneskin`, `sp_godspeed`, `sp_deathblow`, `sp_revive`"
+				") "
+				"VALUES ("
+
+				"%u, \"%s\", \"%s\", %u, %u, %u, %u, %u, %u, %u, %u, "
+				"%u, %u, %u, %u, '%s', "
+				"%u, %u, %u, %u, %u, %u, %lld, %u, %u, %u, "
+				"%u, %u, %d, %d, %d, %u, %d, %d, %u, "
+
+				"%d, %d, %d, %d, %d, %d, "
+				"%d, %d, %d, %d, %d, %d, %d, "
+				"%d, %d, %d, %d, %d, %d, "
+				"%d, %d, %d, %d, %d, %d, "
+				"%f, %u, %u, "
+
+				"%u, %u, %u, %u, %u, %u, "
+				"%u, %u, %u, %u, "
+				"%u, %u, %u, %u, %u"
+				")",
+				GetTablePostfix(), g_stLocaleNameColumn.c_str(),
+
+				t.dwVnum, t.szName, t.szLocaleName, t.bType, t.bRank, t.bBattleType, t.bLevel, t.bSize, t.dwAIFlag, t.dwRaceFlag, t.dwImmuneFlag,
+				t.bOnClickType, t.bEmpire, t.dwDropItemVnum, t.dwResurrectionVnum, t.szFolder,
+				t.bStr, t.bDex, t.bCon, t.bInt, t.dwDamageRange[0], t.dwDamageRange[1], t.dwMaxHP, t.bRegenCycle, t.bRegenPercent, t.dwExp,
+
+				t.dwGoldMin, t.dwGoldMax, t.wDef, t.sAttackSpeed, t.sMovingSpeed, t.bAggresiveHPPct, t.wAggressiveSight, t.wAttackRange, t.dwPolymorphItemVnum,
+				t.cEnchants[MOB_ENCHANT_CURSE], t.cEnchants[MOB_ENCHANT_SLOW], t.cEnchants[MOB_ENCHANT_POISON], t.cEnchants[MOB_ENCHANT_STUN], t.cEnchants[MOB_ENCHANT_CRITICAL], t.cEnchants[MOB_ENCHANT_PENETRATE],
+				t.cResists[MOB_RESIST_SWORD], t.cResists[MOB_RESIST_TWOHAND], t.cResists[MOB_RESIST_DAGGER], t.cResists[MOB_RESIST_BELL], t.cResists[MOB_RESIST_FAN], t.cResists[MOB_RESIST_BOW], t.cResists[MOB_RESIST_CLAW],
+				t.cResists[MOB_RESIST_FIRE], t.cResists[MOB_RESIST_ELECT], t.cResists[MOB_RESIST_MAGIC], t.cResists[MOB_RESIST_WIND], t.cResists[MOB_RESIST_POISON], t.cResists[MOB_RESIST_BLEEDING],
+				t.cElements[MOB_ELEMENT_ELECT], t.cElements[MOB_ELEMENT_FIRE], t.cElements[MOB_ELEMENT_ICE], t.cElements[MOB_ELEMENT_WIND], t.cElements[MOB_ELEMENT_EARTH], t.cElements[MOB_ELEMENT_DARK],
+				t.fDamMultiply, t.dwSummonVnum, t.dwDrainSP,
+
+				t.Skills[0].dwVnum, t.Skills[0].bLevel, t.Skills[1].dwVnum, t.Skills[1].bLevel, t.Skills[2].dwVnum, t.Skills[2].bLevel,
+				t.Skills[3].dwVnum, t.Skills[3].bLevel, t.Skills[4].dwVnum, t.Skills[4].bLevel,
+				t.bBerserkPoint, t.bStoneSkinPoint, t.bGodSpeedPoint, t.bDeathBlowPoint, t.bRevivePoint
+			);
 		}
-	}
-#	endif
 
+		CDBManager::instance().AsyncQuery(query);
+	}
 	return true;
 }
-#endif
 
-#ifdef __OFFLINE_SHOP__
-void CClientManager::InitializeOfflineShops()
+bool CClientManager::MirrorItemTableIntoDB()
 {
-	std::stringstream shopQuery;
-	shopQuery << "SELECT id, owner_pid, owner_name, name, name_change_time, channel, map_index, x, y, deco_race, deco_board, opening_time, gold FROM offline_shop" << GetTablePostfix();
-
-	std::unique_ptr<SQLMsg> msg(CDBManager::Instance().DirectQuery(shopQuery.str().c_str()));
-	if (!msg) {
-		return;
-	}
-
-	auto result = msg->Get();
-	if (!result || result->uiNumRows < 1) {
-		return;
-	}
-
-	while (auto shopData = mysql_fetch_row(result->pSQLResult)) {
-		size_t col = 0;
-
-		TOfflineShop shop;
-#define NUMBER_FROM_RESULT(field) str_to_number(shop.field, shopData[col++]);
-		NUMBER_FROM_RESULT(id);
-		NUMBER_FROM_RESULT(ownerPid);
-
-		std::string ownerName(shopData[col++]);
-		std::fill(shop.ownerName.begin(), shop.ownerName.end(), '\0');
-		std::copy(ownerName.begin(), ownerName.end(), shop.ownerName.begin());
-
-		std::string shopName(shopData[col++]);
-		std::fill(shop.shopName.begin(), shop.shopName.end(), '\0');
-		std::copy(shopName.begin(), shopName.end(), shop.shopName.begin());
-
-		NUMBER_FROM_RESULT(shopNameChangeTime);
-		NUMBER_FROM_RESULT(channel);
-		NUMBER_FROM_RESULT(mapIndex);
-		NUMBER_FROM_RESULT(x);
-		NUMBER_FROM_RESULT(y);
-		NUMBER_FROM_RESULT(decoRace);
-		NUMBER_FROM_RESULT(decoBoard);
-		NUMBER_FROM_RESULT(openingTime);
-		NUMBER_FROM_RESULT(gold);
-#undef NUMBER_FROM_RESULT
-
-		SaveOfflineShop(shop, true);
-
-
-		std::stringstream itemQuery;
-		itemQuery << "SELECT owner_pid, position, vnum, count, ";
-
-		for (size_t i = 0; i < ITEM_SOCKET_MAX_NUM; ++i) {
-			itemQuery << "socket" << i << ", ";
-		}
-
-		for (size_t i = 0; i < ITEM_ATTRIBUTE_MAX_NUM; ++i) {
-			itemQuery << "attrtype" << i << ", " << "attrvalue" << i << ", ";
-		}
-
-#if defined(__ITEM_APPLY_RANDOM__)
-		for (size_t i = 0; i < ITEM_APPLY_MAX_NUM; ++i) {
-			itemQuery << "apply_type" << i << ", apply_value" << i << ", apply_path" << i << ", ";
-		}
+	// for (ItemTableVector::const_iterator it = m_vec_itemTable.begin(); it != m_vec_itemTable.end(); it++)
+	for (itertype(m_vec_itemTable) it = m_vec_itemTable.begin(); it != m_vec_itemTable.end(); it++)
+	{
+		if (g_stLocaleNameColumn != "name")
+		{
+			const TItemTable& t = *it;
+			char query[4096];
+			snprintf(query, sizeof(query),
+				"REPLACE INTO item_proto%s ("
+				"`vnum`, `type`, `subtype`, `name`, `%s`, `gold`, `shop_buy_price`, `weight`, `size`, "
+				"`flag`, `wearflag`, `antiflag`, `immuneflag`, "
+				"`refined_vnum`, `refine_set`, `magic_pct`, `socket_pct`, `addon_type`, "
+				"`limittype0`, `limitvalue0`, `limittype1`, `limitvalue1`, "
+				"`applytype0`, `applyvalue0`, `applytype1`, `applyvalue1`, `applytype2`, `applyvalue2`, "
+#if defined(__ITEM_APPLY4__)
+				"`applytype3`, `applyvalue3`, "
+#endif
+				"`value0`, `value1`, `value2`, `value3`, `value4`, `value5`"
+				") "
+				"VALUES ("
+				"%d, %d, %d, \"%s\", \"%s\", %d, %d, %d, %d, "
+				"%d, %d, %llu, %d, "
+				"%d, %d, %d, %d, %d, "
+				"%d, %ld, %d, %ld, "
+				"%d, %ld, %d, %ld, %d, %ld, "
+#if defined(__ITEM_APPLY4__)
+				"%d, %ld, "
+#endif
+				"%ld, %ld, %ld, %ld, %ld, %ld)",
+				GetTablePostfix(), g_stLocaleNameColumn.c_str(),
+				t.dwVnum, t.bType, t.bSubType, t.szName, t.szLocaleName, t.dwGold, t.dwShopBuyPrice, t.bWeight, t.bSize,
+				t.dwFlags, t.dwWearFlags, t.ullAntiFlags, t.dwImmuneFlag,
+				t.dwRefinedVnum, t.wRefineSet, t.bAlterToMagicItemPct, t.bGainSocketPct, t.sAddonType,
+				t.aLimits[0].bType, t.aLimits[0].lValue, t.aLimits[1].bType, t.aLimits[1].lValue,
+				t.aApplies[0].bType, t.aApplies[0].lValue, t.aApplies[1].bType, t.aApplies[1].lValue, t.aApplies[2].bType, t.aApplies[2].lValue,
+#if defined(__ITEM_APPLY4__)
+				t.aApplies[3].bType, t.aApplies[3].lValue,
 #endif
-
-		itemQuery << "transmutation, soulbind, ";
-
-		itemQuery << "price FROM offline_shop_item" << GetTablePostfix() << " WHERE owner_pid = " << shop.id;
-
-		std::unique_ptr<SQLMsg> itemMsg(CDBManager::Instance().DirectQuery(itemQuery.str().c_str()));
-		if (!itemMsg) {
-			continue;
+				t.alValues[0], t.alValues[1], t.alValues[2], t.alValues[3], t.alValues[4], t.alValues[5]);
+			CDBManager::instance().AsyncQuery(query);
 		}
-
-		auto itemResult = itemMsg->Get();
-		if (!itemResult || itemResult->uiNumRows < 1) {
-			continue;
-		}
-
-		while (auto itemData = mysql_fetch_row(itemResult->pSQLResult)) {
-			col = 0;
-
-			TOfflineShopItem item;
-#define NUMBER_FROM_RESULT(field) str_to_number(item.field, itemData[col++]);
-			NUMBER_FROM_RESULT(id.first);
-			NUMBER_FROM_RESULT(id.second);
-			NUMBER_FROM_RESULT(vnum);
-			NUMBER_FROM_RESULT(count);
-
-			for (size_t i = 0; i < ITEM_SOCKET_MAX_NUM; ++i) {
-				NUMBER_FROM_RESULT(sockets[i]);
-			}
-
-			for (size_t i = 0; i < ITEM_ATTRIBUTE_MAX_NUM; ++i) {
-				NUMBER_FROM_RESULT(attributes[i].wType);
-				NUMBER_FROM_RESULT(attributes[i].lValue);
-			}
-#if defined(__ITEM_APPLY_RANDOM__)
-			for (size_t i = 0; i < ITEM_APPLY_MAX_NUM; ++i) {
-				NUMBER_FROM_RESULT(ApplyRandom[i].wType);
-				NUMBER_FROM_RESULT(ApplyRandom[i].lValue);
-				NUMBER_FROM_RESULT(ApplyRandom[i].bPath);
-			}
+		else
+		{
+			const TItemTable& t = *it;
+			char query[4096];
+			snprintf(query, sizeof(query),
+				"REPLACE INTO item_proto%s ("
+				"`vnum`, `type`, `subtype`, `name`, `gold`, `shop_buy_price`, `weight`, `size`, "
+				"`flag`, `wearflag`, `antiflag`, `immuneflag`, "
+				"`refined_vnum`, `refine_set`, `magic_pct`, `socket_pct`, `addon_type`, "
+				"`limittype0`, `limitvalue0`, `limittype1`, `limitvalue1`, "
+				"`applytype0`, `applyvalue0`, `applytype1`, `applyvalue1`, `applytype2`, `applyvalue2`, "
+#if defined(__ITEM_APPLY4__)
+				"`applytype3`, `applyvalue3`, "
+#endif
+				"`value0`, `value1`, `value2`, `value3`, `value4`, `value5`"
+				") "
+				"VALUES ("
+				"%d, %d, %d, \"%s\", %d, %d, %d, %d, "
+				"%d, %d, %lld, %d, "
+				"%d, %d, %d, %d, %d, "
+				"%d, %ld, %d, %ld, "
+				"%d, %ld, %d, %ld, %d, %ld, "
+#if defined(__ITEM_APPLY4__)
+				"%d, %ld, "
+#endif
+				"%ld, %ld, %ld, %ld, %ld, %ld)",
+				GetTablePostfix(),
+				t.dwVnum, t.bType, t.bSubType, t.szName, t.dwGold, t.dwShopBuyPrice, t.bWeight, t.bSize,
+				t.dwFlags, t.dwWearFlags, t.ullAntiFlags, t.dwImmuneFlag,
+				t.dwRefinedVnum, t.wRefineSet, t.bAlterToMagicItemPct, t.bGainSocketPct, t.sAddonType,
+				t.aLimits[0].bType, t.aLimits[0].lValue, t.aLimits[1].bType, t.aLimits[1].lValue,
+				t.aApplies[0].bType, t.aApplies[0].lValue, t.aApplies[1].bType, t.aApplies[1].lValue, t.aApplies[2].bType, t.aApplies[2].lValue,
+#if defined(__ITEM_APPLY4__)
+				t.aApplies[3].bType, t.aApplies[3].lValue,
 #endif
-			NUMBER_FROM_RESULT(dwTransmutationVnum);
-			NUMBER_FROM_RESULT(soulbind);
-
-			NUMBER_FROM_RESULT(price);
-#undef NUMBER_FROM_RESULT
-
-			SaveOfflineShopItem(item, true);
+				t.alValues[0], t.alValues[1], t.alValues[2], t.alValues[3], t.alValues[4], t.alValues[5]);
+			CDBManager::instance().AsyncQuery(query);
 		}
 	}
-
-	sys_log(0, "Initialized %u offline shops with %u items.", offlineShopCache_.size(), offlineShopItemCache_.size());
+	return true;
 }
-#endif
diff -ruN baseline/server/server/home/metin2/Source/Server/db/src/ClientManagerPlayer.cpp final/server/server/home/metin2/Source/Server/db/src/ClientManagerPlayer.cpp
--- baseline/server/server/home/metin2/Source/Server/db/src/ClientManagerPlayer.cpp	2026-02-17 15:17:08.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/db/src/ClientManagerPlayer.cpp	2022-04-27 10:06:26.000000000 +0000
@@ -7,6 +7,9 @@
 #include "ItemAwardManager.h"
 #include "HB.h"
 #include "Cache.h"
+#if defined(__SKILL_COLOR_SYSTEM__)
+#include "../../common/length.h"
+#endif
 
 extern bool g_bHotBackup;
 
@@ -49,56 +52,66 @@
 		// Check all SELECT syntax on item table before change this function!!!
 		// Check all SELECT syntax on item table before change this function!!!
 		// Check all SELECT syntax on item table before change this function!!!
-		str_to_number(item.dwID, row[cur++]);
-		str_to_number(item.bWindow, row[cur++]);
-		str_to_number(item.wPos, row[cur++]);
-		str_to_number(item.dwVnum, row[cur++]);
-		str_to_number(item.dwCount, row[cur++]);
-
+		str_to_number(item.id, row[cur++]);
+		str_to_number(item.window, row[cur++]);
+		str_to_number(item.pos, row[cur++]);
+		str_to_number(item.count, row[cur++]);
+		str_to_number(item.vnum, row[cur++]);
 #if defined(__SOUL_BIND_SYSTEM__)
-		str_to_number(item.lSealDate, row[cur++]);
+		str_to_number(item.soulbind, row[cur++]);
 #endif
-
-		for (BYTE i = 0; i < ITEM_SOCKET_MAX_NUM; i++)
-			str_to_number(item.alSockets[i], row[cur++]);
-
-		for (int j = 0; j < ITEM_ATTRIBUTE_MAX_NUM; j++)
-		{
-			str_to_number(item.aAttr[j].wType, row[cur++]);
-			str_to_number(item.aAttr[j].lValue, row[cur++]);
-		}
-
 #if defined(__CHANGE_LOOK_SYSTEM__)
-		str_to_number(item.dwTransmutationVnum, row[cur++]);
+		str_to_number(item.transmutation, row[cur++]);
 #endif
-
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-		str_to_number(item.RefineElement.wApplyType, row[cur++]);
-		str_to_number(item.RefineElement.bGrade, row[cur++]);
-		for (BYTE i = 0; i < REFINE_ELEMENT_MAX; i++)
-			str_to_number(item.RefineElement.abValue[i], row[cur++]);
-		for (BYTE i = 0; i < REFINE_ELEMENT_MAX; i++)
-			str_to_number(item.RefineElement.abBonusValue[i], row[cur++]);
+		str_to_number(item.alSockets[0], row[cur++]);
+		str_to_number(item.alSockets[1], row[cur++]);
+		str_to_number(item.alSockets[2], row[cur++]);
+#if defined(__ITEM_SOCKET5__)
+		str_to_number(item.alSockets[3], row[cur++]);
+		str_to_number(item.alSockets[4], row[cur++]);
+		// str_to_number(item.alSockets[5], row[cur++]);
 #endif
 
 #if defined(__ITEM_APPLY_RANDOM__)
 		for (int j = 0; j < ITEM_APPLY_MAX_NUM; j++)
 		{
-			str_to_number(item.aApplyRandom[j].wType, row[cur++]);
-			str_to_number(item.aApplyRandom[j].lValue, row[cur++]);
+			str_to_number(item.aApplyRandom[j].bType, row[cur++]);
+			str_to_number(item.aApplyRandom[j].sValue, row[cur++]);
 			str_to_number(item.aApplyRandom[j].bPath, row[cur++]);
 		}
 #endif
 
-#if defined(__SET_ITEM__)
-		str_to_number(item.bSetValue, row[cur++]);
-#endif
+		for (int j = 0; j < ITEM_ATTRIBUTE_MAX_NUM; j++)
+		{
+			str_to_number(item.aAttr[j].bType, row[cur++]);
+			str_to_number(item.aAttr[j].sValue, row[cur++]);
+		}
+
+		item.owner = dwPID;
+	}
+
+	return true;
+}
+
+#if defined(__SKILL_COLOR_SYSTEM__)
+bool CreateSkillColorTableFromRes(MYSQL_RES* res, DWORD* dwSkillColor)
+{
+	if (mysql_num_rows(res) == 0)
+		return false;
+
+	MYSQL_ROW row = mysql_fetch_row(res);
 
-		item.dwOwner = dwPID;
+	for (BYTE bySlot = 0; bySlot < ESkillColorLength::MAX_SKILL_COUNT + ESkillColorLength::MAX_BUFF_COUNT; ++bySlot)
+	{
+		for (BYTE byLayer = 0; byLayer < ESkillColorLength::MAX_EFFECT_COUNT; ++byLayer)
+		{
+			*(dwSkillColor++) = atoi(row[byLayer + (bySlot * ESkillColorLength::MAX_EFFECT_COUNT)]);
+		}
 	}
 
 	return true;
 }
+#endif
 
 size_t CreatePlayerSaveQuery(char* pszQuery, size_t querySize, TPlayerTable* pkTab)
 {
@@ -116,8 +129,8 @@
 		"`exit_x` = %ld, "
 		"`exit_y` = %ld, "
 		"`exit_map_index` = %ld, "
-		"`hp` = %d, "
-		"`mp` = %d, "
+		"`hp` = %lld, "
+		"`mp` = %lld, "
 		"`stamina` = %d, "
 		"`random_hp` = %d, "
 		"`random_sp` = %d, "
@@ -128,10 +141,7 @@
 		"`ht` = %d, "
 		"`dx` = %d, "
 		"`iq` = %d, "
-#if defined(__EXTEND_INVEN_SYSTEM__)
-		"`inven_stage` = %d, "
-#endif
-		"`gold` = %d, "
+		"`gold` = %lld, "
 #if defined(__CHEQUE_SYSTEM__)
 		"`cheque` = %d, "
 #endif
@@ -168,9 +178,6 @@
 		"`horse_hp_droptime` = %u, "
 		"`horse_stamina` = %d, "
 		"`horse_skill_point` = %d, "
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-		"`battle_pass_premium_id` = %d, "
-#endif
 		,
 		GetTablePostfix(),
 		pkTab->job,
@@ -195,9 +202,6 @@
 		pkTab->ht,
 		pkTab->dx,
 		pkTab->iq,
-#if defined(__EXTEND_INVEN_SYSTEM__)
-		pkTab->inven_stage,
-#endif
 		pkTab->gold,
 #if defined(__CHEQUE_SYSTEM__)
 		pkTab->cheque,
@@ -211,10 +215,10 @@
 		pkTab->sub_skill_point,
 		pkTab->stat_reset_count,
 		pkTab->ip,
-		pkTab->adwParts[PART_MAIN],
-		pkTab->adwParts[PART_HAIR],
+		pkTab->parts[PART_MAIN],
+		pkTab->parts[PART_HAIR],
 #if defined(__ACCE_COSTUME_SYSTEM__)
-		pkTab->adwParts[PART_ACCE],
+		pkTab->parts[PART_ACCE],
 #endif
 		pkTab->skill_group,
 		pkTab->lAlignment,
@@ -233,11 +237,7 @@
 		pkTab->horse.sHealth,
 		pkTab->horse.dwHorseHealthDropTime,
 		pkTab->horse.sStamina,
-		pkTab->horse_skill_point,
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-		pkTab->battle_pass_premium_id
-#endif
-	);
+		pkTab->horse_skill_point);
 
 	// Binary  ٲٱ  ӽ 
 	static char text[QUERY_MAX_LEN];
@@ -282,6 +282,56 @@
 	c->Put(pNew);
 }
 
+#if defined(__SKILL_COLOR_SYSTEM__)
+void CClientManager::QUERY_SKILL_COLOR_LOAD(CPeer* peer, DWORD dwHandle, TPlayerLoadPacket* packet)
+{
+	CSKillColorCache* c;
+	TSkillColor* p;
+
+	if ((c = GetSkillColorCache(packet->player_id)))
+	{
+		p = c->Get();
+		peer->EncodeHeader(HEADER_DG_SKILL_COLOR_LOAD, dwHandle, sizeof(p->dwSkillColor));
+		peer->Encode(p->dwSkillColor, sizeof(p->dwSkillColor));
+	}
+	else
+	{
+		char szQuery[QUERY_MAX_LEN];
+		snprintf(szQuery, sizeof(szQuery), "SELECT "
+			"`skillSlot1_Col1`, `skillSlot1_Col2`, `skillSlot1_Col3`, `skillSlot1_Col4`, `skillSlot1_Col5`"
+			", `skillSlot2_Col1`, `skillSlot2_Col2`, `skillSlot2_Col3`, `skillSlot2_Col4`, `skillSlot2_Col5`"
+			", `skillSlot3_Col1`, `skillSlot3_Col2`, `skillSlot3_Col3`, `skillSlot3_Col4`, `skillSlot3_Col5`"
+			", `skillSlot4_Col1`, `skillSlot4_Col2`, `skillSlot4_Col3`, `skillSlot4_Col4`, `skillSlot4_Col5`"
+			", `skillSlot5_Col1`, `skillSlot5_Col2`, `skillSlot5_Col3`, `skillSlot5_Col4`, `skillSlot5_Col5`"
+			", `skillSlot6_Col1`, `skillSlot6_Col2`, `skillSlot6_Col3`, `skillSlot6_Col4`, `skillSlot6_Col5`"
+#if defined(__9TH_SKILL__)
+			", `skillSlot7_Col1`, `skillSlot7_Col2`, `skillSlot7_Col3`, `skillSlot7_Col4`, `skillSlot7_Col5`"
+			", `skillSlot8_Col1`, `skillSlot8_Col2`, `skillSlot8_Col3`, `skillSlot8_Col4`, `skillSlot8_Col5`"
+			", `skillSlot9_Col1`, `skillSlot9_Col2`, `skillSlot9_Col3`, `skillSlot9_Col4`, `skillSlot9_Col5`"
+			", `skillSlot10_Col1`, `skillSlot10_Col2`, `skillSlot10_Col3`, `skillSlot10_Col4`, `skillSlot10_Col5`"
+			// Buff Skills
+			", `buffSkill1_Col1`, `buffSkill1_Col2`, `buffSkill1_Col3`, `buffSkill1_Col4`, `buffSkill1_Col5`"
+			", `buffSkill2_Col1`, `buffSkill2_Col2`, `buffSkill2_Col3`, `buffSkill2_Col4`, `buffSkill2_Col5`"
+			", `buffSkill3_Col1`, `buffSkill3_Col2`, `buffSkill3_Col3`, `buffSkill3_Col4`, `buffSkill3_Col5`"
+			", `buffSkill4_Col1`, `buffSkill4_Col2`, `buffSkill4_Col3`, `buffSkill4_Col4`, `buffSkill4_Col5`"
+			", `buffSkill5_Col1`, `buffSkill5_Col2`, `buffSkill5_Col3`, `buffSkill5_Col4`, `buffSkill5_Col5`"
+			", `buffSkill6_Col1`, `buffSkill6_Col2`, `buffSkill6_Col3`, `buffSkill6_Col4`, `buffSkill6_Col5`"
+#else
+			// Buff Skills
+			", `buffSkill1_Col1`, `buffSkill1_Col2`, `buffSkill1_Col3`, `buffSkill1_Col4`, `buffSkill1_Col5`"
+			", `buffSkill2_Col1`, `buffSkill2_Col2`, `buffSkill2_Col3`, `buffSkill2_Col4`, `buffSkill2_Col5`"
+			", `buffSkill3_Col1`, `buffSkill3_Col2`, `buffSkill3_Col3`, `buffSkill3_Col4`, `buffSkill3_Col5`"
+			", `buffSkill4_Col1`, `buffSkill4_Col2`, `buffSkill4_Col3`, `buffSkill4_Col4`, `buffSkill4_Col5`"
+			", `buffSkill5_Col1`, `buffSkill5_Col2`, `buffSkill5_Col3`, `buffSkill5_Col4`, `buffSkill5_Col5`"
+			", `buffSkill6_Col1`, `buffSkill6_Col2`, `buffSkill6_Col3`, `buffSkill6_Col4`, `buffSkill6_Col5`"
+#endif
+			" FROM skill_color%s WHERE `player_id` = %d",
+			GetTablePostfix(), packet->player_id);
+		CDBManager::instance().ReturnQuery(szQuery, QID_SKILL_COLOR, peer->GetHandle(), new ClientHandleInfo(dwHandle, packet->player_id));
+	}
+}
+#endif
+
 /*
 * PLAYER LOAD
 */
@@ -384,7 +434,7 @@
 				CItemCache* c = *it++;
 				TPlayerItem* p = c->Get();
 
-				if (p->dwVnum) // vnum   ̴.
+				if (p->vnum) // vnum   ̴.
 					thecore_memcpy(&s_items[dwCount++], p, sizeof(TPlayerItem));
 			}
 
@@ -406,11 +456,7 @@
 
 			// Affect
 			snprintf(szQuery, sizeof(szQuery),
-				"SELECT `dwPID`, `dwType`, `wApplyOn`, `lApplyValue`, `dwFlag`, `lDuration`, `lSPCost`"
-#if defined(__AFFECT_RENEWAL__)
-				", `bRealTime`"
-#endif
-				" FROM `affect%s` WHERE `dwPID` = %d",
+				"SELECT `dwPID`, `bType`, `bApplyOn`, `lApplyValue`, `dwFlag`, `lDuration`, `lSPCost` FROM affect%s WHERE `dwPID` = %d",
 				GetTablePostfix(), pTab->id);
 			CDBManager::instance().ReturnQuery(szQuery, QID_AFFECT, peer->GetHandle(), new ClientHandleInfo(dwHandle, pTab->id));
 		}
@@ -420,46 +466,34 @@
 		else
 		{
 			snprintf(szQuery, sizeof(szQuery),
-				"SELECT `id`, `window`+0, `pos`, `vnum`, `count`"
+				"SELECT `id`, `window`+0, `pos`, `count`, `vnum`, "
 #if defined(__SOUL_BIND_SYSTEM__)
-				", `soulbind`"
+				"`soulbind`, "
 #endif
-				", `socket0`, `socket1`, `socket2`"
-#if defined(__ITEM_SOCKET6__)
-				", `socket3`, `socket4`, `socket5`"
-#endif
-				", `attrtype0`, `attrvalue0`"
-				", `attrtype1`, `attrvalue1`"
-				", `attrtype2`, `attrvalue2`"
-				", `attrtype3`, `attrvalue3`"
-				", `attrtype4`, `attrvalue4`"
-				", `attrtype5`, `attrvalue5`"
-				", `attrtype6`, `attrvalue6`"
 #if defined(__CHANGE_LOOK_SYSTEM__)
-				", `transmutation`"
+				"`transmutation`, "
 #endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-				", `refine_element_apply_type`"
-				", `refine_element_grade`"
-				", `refine_element_value0`, `refine_element_value1`, `refine_element_value2`"
-				", `refine_element_bonus_value0`, `refine_element_bonus_value1`, `refine_element_bonus_value2`"
+				"`socket0`, `socket1`, `socket2`, "
+#if defined(__ITEM_SOCKET5__)
+				"`socket3`, "
+				"`socket4`, "
+				// "`socket5`, "
 #endif
 #if defined(__ITEM_APPLY_RANDOM__)
-				", `apply_type0`, `apply_value0`, `apply_path0`"
-				", `apply_type1`, `apply_value1`, `apply_path1`"
-				", `apply_type2`, `apply_value2`, `apply_path2`"
-				", `apply_type3`, `apply_value3`, `apply_path3`"
-#endif
-#if defined(__SET_ITEM__)
-				", `set_value`"
-#endif
-				" FROM `item%s` WHERE `owner_id` = %u AND (`window` in ("
-				"'INVENTORY', 'EQUIPMENT', 'DRAGON_SOUL_INVENTORY', 'BELT_INVENTORY'"
-#if defined(__ATTR_6TH_7TH__)
-				", 'NPC_STORAGE'"
-#endif
-				"))",
-				GetTablePostfix(), pTab->id);
+				"`apply_type0`, `apply_value0`, `apply_path0`, "
+				"`apply_type1`, `apply_value1`, `apply_path1`, "
+				"`apply_type2`, `apply_value2`, `apply_path2`, "
+				"`apply_type3`, `apply_value3`, `apply_path3`, "
+#endif
+				"`attrtype0`, `attrvalue0`, "
+				"`attrtype1`, `attrvalue1`, "
+				"`attrtype2`, `attrvalue2`, "
+				"`attrtype3`, `attrvalue3`, "
+				"`attrtype4`, `attrvalue4`, "
+				"`attrtype5`, `attrvalue5`, "
+				"`attrtype6`, `attrvalue6` "
+				"FROM item%s WHERE `owner_id` = %d AND (`window` < %d OR `window` = %d OR `window` = %d)",
+				GetTablePostfix(), pTab->id, SAFEBOX, DRAGON_SOUL_INVENTORY, BELT_INVENTORY);
 
 			CDBManager::instance().ReturnQuery(szQuery,
 				QID_ITEM,
@@ -474,11 +508,7 @@
 				peer->GetHandle(),
 				new ClientHandleInfo(dwHandle, pTab->id));
 			snprintf(szQuery, sizeof(szQuery),
-				"SELECT `dwPID`, `dwType`, `wApplyOn`, `lApplyValue`, `dwFlag`, `lDuration`, `lSPCost`"
-#if defined(__AFFECT_RENEWAL__)
-				", `bRealTime`"
-#endif
-				" FROM `affect%s` WHERE `dwPID` = %d",
+				"SELECT `dwPID`, `bType`, `bApplyOn`, `lApplyValue`, `dwFlag`, `lDuration`, `lSPCost` FROM affect%s WHERE `dwPID` = %d",
 				GetTablePostfix(), pTab->id);
 
 			CDBManager::instance().ReturnQuery(szQuery,
@@ -505,9 +535,6 @@
 			"SELECT "
 			"`id`, `name`, `job`, `voice`, `dir`, `x`, `y`, `z`, `map_index`, "
 			"`exit_x`, `exit_y`, `exit_map_index`, `hp`, `mp`, `stamina`, `random_hp`, `random_sp`, `playtime`, "
-#if defined(__EXTEND_INVEN_SYSTEM__)
-			"`inven_stage`, "
-#endif
 			"`gold`, "
 #if defined(__CHEQUE_SYSTEM__)
 			"`cheque`, "
@@ -546,10 +573,7 @@
 			"`horse_hp_droptime`, "
 			"`horse_stamina`, "
 			"UNIX_TIMESTAMP(NOW()) - UNIX_TIMESTAMP(`last_play`), "
-			"`horse_skill_point`, "
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-			"`battle_pass_premium_id` "
-#endif
+			"`horse_skill_point`"
 			" FROM player%s WHERE `id` = %d",
 			GetTablePostfix(), packet->player_id);
 
@@ -561,46 +585,34 @@
 		//  
 		// ---------------------------------------------------------------
 		snprintf(queryStr, sizeof(queryStr),
-			"SELECT `id`, `window`+0, `pos`, `vnum`, `count`"
+			"SELECT `id`, `window`+0, `pos`, `count`, `vnum`, "
 #if defined(__SOUL_BIND_SYSTEM__)
-			", `soulbind`"
+			"`soulbind`, "
 #endif
-			", `socket0`, `socket1`, `socket2`"
-#if defined(__ITEM_SOCKET6__)
-			", `socket3`, `socket4`, `socket5`"
-#endif
-			", `attrtype0`, `attrvalue0`"
-			", `attrtype1`, `attrvalue1`"
-			", `attrtype2`, `attrvalue2`"
-			", `attrtype3`, `attrvalue3`"
-			", `attrtype4`, `attrvalue4`"
-			", `attrtype5`, `attrvalue5`"
-			", `attrtype6`, `attrvalue6`"
 #if defined(__CHANGE_LOOK_SYSTEM__)
-			", `transmutation`"
+			"`transmutation`, "
 #endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-			", `refine_element_apply_type`"
-			", `refine_element_grade`"
-			", `refine_element_value0`, `refine_element_value1`, `refine_element_value2`"
-			", `refine_element_bonus_value0`, `refine_element_bonus_value1`, `refine_element_bonus_value2`"
+			"`socket0`, `socket1`, `socket2`, "
+#if defined(__ITEM_SOCKET5__)
+			"`socket3`, "
+			"`socket4`, "
+			// "`socket5`, "
 #endif
 #if defined(__ITEM_APPLY_RANDOM__)
-			", `apply_type0`, `apply_value0`, `apply_path0`"
-			", `apply_type1`, `apply_value1`, `apply_path1`"
-			", `apply_type2`, `apply_value2`, `apply_path2`"
-			", `apply_type3`, `apply_value3`, `apply_path3`"
-#endif
-#if defined(__SET_ITEM__)
-			", `set_value`"
-#endif
-			" FROM `item%s` WHERE `owner_id` = %u AND (`window` in ("
-			"'INVENTORY', 'EQUIPMENT', 'DRAGON_SOUL_INVENTORY', 'BELT_INVENTORY'"
-#if defined(__ATTR_6TH_7TH__)
-			", 'NPC_STORAGE'"
-#endif
-			"))",
-			GetTablePostfix(), packet->player_id);
+			"`apply_type0`, `apply_value0`, `apply_path0`, "
+			"`apply_type1`, `apply_value1`, `apply_path1`, "
+			"`apply_type2`, `apply_value2`, `apply_path2`, "
+			"`apply_type3`, `apply_value3`, `apply_path3`, "
+#endif
+			"`attrtype0`, `attrvalue0`, "
+			"`attrtype1`, `attrvalue1`, "
+			"`attrtype2`, `attrvalue2`, "
+			"`attrtype3`, `attrvalue3`, "
+			"`attrtype4`, `attrvalue4`, "
+			"`attrtype5`, `attrvalue5`, "
+			"`attrtype6`, `attrvalue6` "
+			"FROM item%s WHERE `owner_id` = %d AND (`window` < %d OR `window` = %d OR `window` = %d)",
+			GetTablePostfix(), packet->player_id, SAFEBOX, DRAGON_SOUL_INVENTORY, BELT_INVENTORY);
 
 		CDBManager::instance().ReturnQuery(queryStr, QID_ITEM, peer->GetHandle(), new ClientHandleInfo(dwHandle, packet->player_id));
 
@@ -616,23 +628,11 @@
 		// AFFECT  
 		// ---------------------------------------------------------------
 		snprintf(queryStr, sizeof(queryStr),
-			"SELECT `dwPID`, `dwType`, `wApplyOn`, `lApplyValue`, `dwFlag`, `lDuration`, `lSPCost`"
-#if defined(__AFFECT_RENEWAL__)
-			", `bRealTime`"
-#endif
-			" FROM `affect%s` WHERE `dwPID` = %d",
+			"SELECT `dwPID`, `bType`, `bApplyOn`, `lApplyValue`, `dwFlag`, `lDuration`, `lSPCost` FROM affect%s WHERE `dwPID` = %d",
 			GetTablePostfix(), packet->player_id);
 		CDBManager::instance().ReturnQuery(queryStr, QID_AFFECT, peer->GetHandle(), new ClientHandleInfo(dwHandle, packet->player_id));
 	}
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	// Load all missions from table
-	char queryStrBP[QUERY_MAX_LEN];
-	snprintf(queryStrBP, sizeof(queryStrBP),
-		"SELECT player_id, battlepass_type+0, mission_index, mission_type+0, battle_pass_id, extra_info, completed FROM battlepass_missions WHERE player_id = %d", packet->player_id);
-	CDBManager::instance().ReturnQuery(queryStrBP, QID_EXT_BATTLE_PASS, peer->GetHandle(), new ClientHandleInfo(dwHandle, packet->player_id));
-#endif
-
+	
 #ifdef __GROWTH_PET_SYSTEM__
 	TGrowthPetCacheSet* pSet = GetGrowthPetCacheSet(packet->player_id);
 	if (pSet)
@@ -663,10 +663,10 @@
 	{
 		char szQuery[QUERY_MAX_LEN];
 		snprintf(szQuery, sizeof(szQuery),
-			"SELECT id,vnum,state+0,name,size,level,level_step,evolution,type,hp,sp,def,hp_apply,sp_apply,def_apply,"
+			"SELECT id,owner_id,vnum,state+0,name,size,level,level_step,evolution,type,hp,sp,def,hp_apply,sp_apply,def_apply,"
 			"age_apply,skill_level,exp,item_exp,UNIX_TIMESTAMP(birthday),end_time,max_time "
-			"FROM growth_pet%s WHERE owner_id=%d AND state < %d",
-			GetTablePostfix(), packet->player_id, STATE_SAFEBOX);
+			"FROM growth_pet%s WHERE owner_id=%d",
+			GetTablePostfix(), packet->player_id);
 
 		CDBManager::instance().ReturnQuery(szQuery,
 			QID_GROWTH_PET,
@@ -674,6 +674,7 @@
 			new ClientHandleInfo(dwHandle, packet->player_id));
 	}
 #endif
+
 }
 
 void CClientManager::ItemAward(CPeer* peer, char* login)
@@ -684,7 +685,8 @@
 	if (pSet == NULL)
 		return;
 
-	ItemAwardSet::iterator it = pSet->begin(); // taken_time  NULL ΰ͵ о
+	// std::set<TItemAward*>::const_iterator it = pSet->begin(); // taken_time  NULL ΰ͵ о
+	__typeof__(pSet->begin()) it = pSet->begin(); // taken_time  NULL ΰ͵ о
 	while (it != pSet->end())
 	{
 		TItemAward* pItemAward = *(it++);
@@ -693,7 +695,7 @@
 		strcpy(cmdStr, whyStr); // ɾ   ū  ūȭ Ǳ 
 		char command[20] = "";
 		GetCommand(cmdStr, command); // command 
-		if (!(strcmp(cmdStr, "GIFT"))) // command  GIFT ̸
+		if (!(strcmp(cmdStr, "GIFT")))	// command  GIFT ̸
 		{
 			TPacketItemAwardInfromer giftData;
 			strcpy(giftData.login, pItemAward->szLogin); //α ̵ 
@@ -748,9 +750,6 @@
 	str_to_number(pkTab->sRandomHP, row[col++]);
 	str_to_number(pkTab->sRandomSP, row[col++]);
 	str_to_number(pkTab->playtime, row[col++]);
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	str_to_number(pkTab->inven_stage, row[col++]);
-#endif
 	str_to_number(pkTab->gold, row[col++]);
 #if defined(__CHEQUE_SYSTEM__)
 	str_to_number(pkTab->cheque, row[col++]);
@@ -770,9 +769,9 @@
 	str_to_number(pkTab->sub_skill_point, row[col++]);
 	str_to_number(pkTab->stat_reset_count, row[col++]);
 	str_to_number(pkTab->part_base, row[col++]);
-	str_to_number(pkTab->adwParts[PART_HAIR], row[col++]);
+	str_to_number(pkTab->parts[PART_HAIR], row[col++]);
 #if defined(__ACCE_COSTUME_SYSTEM__)
-	str_to_number(pkTab->adwParts[PART_ACCE], row[col++]);
+	str_to_number(pkTab->parts[PART_ACCE], row[col++]);
 #endif
 
 	if (row[col])
@@ -808,14 +807,10 @@
 	str_to_number(pkTab->horse.sStamina, row[col++]);
 	str_to_number(pkTab->logoff_interval, row[col++]);
 	str_to_number(pkTab->horse_skill_point, row[col++]);
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	str_to_number(pkTab->battle_pass_premium_id, row[col++]);
-#endif
+
 	// reset sub_skill_point
 	{
 		pkTab->skills[123].bLevel = 0; // SKILL_CREATE
-		if (pkTab->skills[130].bMasterType != 0) // SKILL_HORSE
-			pkTab->skills[130].bMasterType = SKILL_NORMAL;
 
 		if (pkTab->level > 9)
 		{
@@ -827,12 +822,9 @@
 				MIN(10, pkTab->skills[131].bLevel) + // SKILL_HORSE_SUMMON ȯ
 				MIN(20, pkTab->skills[141].bLevel) + // SKILL_ADD_HP HP
 				MIN(20, pkTab->skills[142].bLevel) + // SKILL_RESIST_PENETRATE 
-#if defined(__PARTY_PROFICY__)
+
 				MIN(20, pkTab->skills[133].bLevel) + // SKILL_ROLE_PROFICIENCY
-#endif
-#if defined(__PARTY_INSIGHT__)
 				MIN(20, pkTab->skills[134].bLevel) + // SKILL_INSIGHT
-#endif
 				MIN(20, pkTab->skills[246].bLevel); // SKILL_HIT
 
 			pkTab->sub_skill_point = max_point - skill_point;
@@ -861,6 +853,7 @@
 	case QID_PLAYER:
 		sys_log(0, "QID_PLAYER %u %u", info->dwHandle, info->player_id);
 		RESULT_PLAYER_LOAD(peer, pSQLResult, info.get());
+
 		break;
 
 	case QID_ITEM:
@@ -868,6 +861,13 @@
 		RESULT_ITEM_LOAD(peer, pSQLResult, info->dwHandle, info->player_id);
 		break;
 
+#if defined(__SKILL_COLOR_SYSTEM__)
+	case QID_SKILL_COLOR:
+		sys_log(0, "QID_SKILL_COLOR %u %u", info->dwHandle, info->player_id);
+		RESULT_SKILL_COLOR_LOAD(peer, pSQLResult, info->dwHandle);
+		break;
+#endif
+
 	case QID_QUEST:
 	{
 		sys_log(0, "QID_QUEST %u", info->dwHandle);
@@ -880,8 +880,8 @@
 
 		CLoginData* pLoginData1 = GetLoginDataByAID(temp1->account_id);
 		//   
-		//if (pLoginData1->GetAccountRef().login == NULL)
-		//	break;
+		if (pLoginData1->GetAccountRef().login == NULL)
+			break;
 
 		if (pLoginData1 == NULL)
 			break;
@@ -895,13 +895,7 @@
 		sys_log(0, "QID_AFFECT %u", info->dwHandle);
 		RESULT_AFFECT_LOAD(peer, pSQLResult, info->dwHandle, info->player_id);
 		break;
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	case QID_EXT_BATTLE_PASS:
-		sys_log(0, "QID_EXT_BATTLE_PASS %u", info->dwHandle);
-		RESULT_EXT_BATTLE_PASS_LOAD(peer, pSQLResult, info->dwHandle, info->player_id);
-		break;
-#endif
+		
 #ifdef __GROWTH_PET_SYSTEM__
 	case QID_GROWTH_PET:
 		sys_log(0, "QID_GROWTH_PET %u", info->dwHandle);
@@ -974,6 +968,34 @@
 	}
 }
 
+#if defined(__SKILL_COLOR_SYSTEM__)
+void CClientManager::RESULT_SKILL_COLOR_LOAD(CPeer* peer, MYSQL_RES* pRes, DWORD dwHandle)
+{
+	DWORD dwSkillColor[ESkillColorLength::MAX_SKILL_COUNT + ESkillColorLength::MAX_BUFF_COUNT][ESkillColorLength::MAX_EFFECT_COUNT];
+	memset(dwSkillColor, 0, sizeof(dwSkillColor));
+
+	CreateSkillColorTableFromRes(pRes, *dwSkillColor);
+	sys_log(0, "SKILL_COLOR_LOAD (SkillSlot1) %i, %i, %i, %i, %i", dwSkillColor[0][0], dwSkillColor[0][1], dwSkillColor[0][2], dwSkillColor[0][3], dwSkillColor[0][4]);
+	sys_log(0, "SKILL_COLOR_LOAD (SkillSlot2) %i, %i, %i, %i, %i", dwSkillColor[1][0], dwSkillColor[1][1], dwSkillColor[1][2], dwSkillColor[1][3], dwSkillColor[1][4]);
+	sys_log(0, "SKILL_COLOR_LOAD (SkillSlot3) %i, %i, %i, %i, %i", dwSkillColor[2][0], dwSkillColor[2][1], dwSkillColor[2][2], dwSkillColor[2][3], dwSkillColor[2][4]);
+	sys_log(0, "SKILL_COLOR_LOAD (SkillSlot4) %i, %i, %i, %i, %i", dwSkillColor[3][0], dwSkillColor[3][1], dwSkillColor[3][2], dwSkillColor[3][3], dwSkillColor[3][4]);
+	sys_log(0, "SKILL_COLOR_LOAD (SkillSlot5) %i, %i, %i, %i, %i", dwSkillColor[4][0], dwSkillColor[4][1], dwSkillColor[4][2], dwSkillColor[4][3], dwSkillColor[4][4]);
+	sys_log(0, "SKILL_COLOR_LOAD (SkillSlot6) %i, %i, %i, %i, %i", dwSkillColor[5][0], dwSkillColor[5][1], dwSkillColor[5][2], dwSkillColor[5][3], dwSkillColor[5][4]);
+	sys_log(0, "SKILL_COLOR_LOAD (SkillSlot7) %i, %i, %i, %i, %i", dwSkillColor[6][0], dwSkillColor[6][1], dwSkillColor[6][2], dwSkillColor[6][3], dwSkillColor[6][4]);
+	sys_log(0, "SKILL_COLOR_LOAD (SkillSlot8) %i, %i, %i, %i, %i", dwSkillColor[7][0], dwSkillColor[7][1], dwSkillColor[7][2], dwSkillColor[7][3], dwSkillColor[7][4]);
+	sys_log(0, "SKILL_COLOR_LOAD (SkillSlot9) %i, %i, %i, %i, %i", dwSkillColor[8][0], dwSkillColor[8][1], dwSkillColor[8][2], dwSkillColor[8][3], dwSkillColor[8][4]);
+	sys_log(0, "SKILL_COLOR_LOAD (SkillSlot10) %i, %i, %i, %i, %i", dwSkillColor[9][0], dwSkillColor[9][1], dwSkillColor[9][2], dwSkillColor[9][3], dwSkillColor[9][4]);
+	sys_log(0, "SKILL_COLOR_LOAD (BuffSkill1) %i, %i, %i, %i, %i", dwSkillColor[10][0], dwSkillColor[10][1], dwSkillColor[10][2], dwSkillColor[10][3], dwSkillColor[10][4]);
+	sys_log(0, "SKILL_COLOR_LOAD (BuffSkill2) %i, %i, %i, %i, %i", dwSkillColor[11][0], dwSkillColor[11][1], dwSkillColor[11][2], dwSkillColor[11][3], dwSkillColor[11][4]);
+	sys_log(0, "SKILL_COLOR_LOAD (BuffSkill3) %i, %i, %i, %i, %i", dwSkillColor[12][0], dwSkillColor[12][1], dwSkillColor[12][2], dwSkillColor[12][3], dwSkillColor[12][4]);
+	sys_log(0, "SKILL_COLOR_LOAD (BuffSkill4) %i, %i, %i, %i, %i", dwSkillColor[13][0], dwSkillColor[13][1], dwSkillColor[13][2], dwSkillColor[13][3], dwSkillColor[13][4]);
+	sys_log(0, "SKILL_COLOR_LOAD (BuffSkill5) %i, %i, %i, %i, %i", dwSkillColor[14][0], dwSkillColor[14][1], dwSkillColor[14][2], dwSkillColor[14][3], dwSkillColor[14][4]);
+	sys_log(0, "SKILL_COLOR_LOAD (BuffSkill6) %i, %i, %i, %i, %i", dwSkillColor[15][0], dwSkillColor[15][1], dwSkillColor[15][2], dwSkillColor[15][3], dwSkillColor[15][4]);
+	peer->EncodeHeader(HEADER_DG_SKILL_COLOR_LOAD, dwHandle, sizeof(dwSkillColor));
+	peer->Encode(&dwSkillColor, sizeof(dwSkillColor));
+}
+#endif
+
 void CClientManager::RESULT_AFFECT_LOAD(CPeer* peer, MYSQL_RES* pRes, DWORD dwHandle, DWORD dwRealPID)
 {
 	int iNumRows;
@@ -1010,15 +1032,11 @@
 			str_to_number(dwPID, row[0]);
 
 		str_to_number(r.dwType, row[1]);
-		str_to_number(r.wApplyOn, row[2]);
+		str_to_number(r.bApplyOn, row[2]);
 		str_to_number(r.lApplyValue, row[3]);
 		str_to_number(r.dwFlag, row[4]);
 		str_to_number(r.lDuration, row[5]);
 		str_to_number(r.lSPCost, row[6]);
-#if defined(__AFFECT_RENEWAL__)
-		str_to_number(r.bRealTime, row[7]);
-		r.bUpdate = false;
-#endif
 	}
 
 	sys_log(0, "AFFECT_LOAD: count %d PID %u", s_elements.size(), dwPID);
@@ -1069,76 +1087,6 @@
 	peer->Encode(&s_table[0], sizeof(TQuestTable) * dwCount);
 }
 
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-void CClientManager::RESULT_EXT_BATTLE_PASS_LOAD(CPeer* peer, MYSQL_RES* pRes, DWORD dwHandle, DWORD dwRealPID)
-{
-	int iNumRows;
-
-	if ((iNumRows = mysql_num_rows(pRes)) == 0)
-	{
-		DWORD dwCount = 0;
-		TPlayerExtBattlePassMission pbpTable = { 0 };
-
-		sys_log(0, "EXT_BATTLE_PASS_LOAD: count %u PID %u", dwCount, dwRealPID);
-
-		peer->EncodeHeader(HEADER_DG_EXT_BATTLE_PASS_LOAD, dwHandle, sizeof(DWORD) + sizeof(DWORD) + sizeof(TPlayerExtBattlePassMission) * dwCount);
-		peer->Encode(&dwRealPID, sizeof(DWORD));
-		peer->Encode(&dwCount, sizeof(DWORD));
-		peer->Encode(&pbpTable, sizeof(TPlayerExtBattlePassMission) * dwCount);
-		return;
-	}
-
-	static std::vector<TPlayerExtBattlePassMission> s_mission;
-	s_mission.resize(iNumRows);
-
-	MYSQL_ROW row;
-
-	for (int i = 0; i < iNumRows; ++i)
-	{
-		int col = 0;
-		TPlayerExtBattlePassMission& r = s_mission[i];
-		row = mysql_fetch_row(pRes);
-
-		str_to_number(r.dwPlayerId, row[col++]);
-		str_to_number(r.dwBattlePassType, row[col++]);
-		str_to_number(r.dwMissionIndex, row[col++]);
-		str_to_number(r.dwMissionType, row[col++]);
-		str_to_number(r.dwBattlePassId, row[col++]);
-		str_to_number(r.dwExtraInfo, row[col++]);
-		str_to_number(r.bCompleted, row[col++]);
-
-		r.bIsUpdated = 0;
-	}
-
-	sys_log(0, "EXT_BATTLE_PASS_LOAD: count %d PID %u", s_mission.size(), dwRealPID);
-
-	DWORD dwCount = s_mission.size();
-
-	peer->EncodeHeader(HEADER_DG_EXT_BATTLE_PASS_LOAD, dwHandle, sizeof(DWORD) + sizeof(DWORD) + sizeof(TPlayerExtBattlePassMission) * dwCount);
-	peer->Encode(&dwRealPID, sizeof(DWORD));
-	peer->Encode(&dwCount, sizeof(DWORD));
-	peer->Encode(&s_mission[0], sizeof(TPlayerExtBattlePassMission) * dwCount);
-}
-
-void CClientManager::QUERY_SAVE_EXT_BATTLE_PASS(CPeer* peer, DWORD dwHandle, TPlayerExtBattlePassMission* battlePass)
-{
-	if (g_test_server)
-		sys_log(0, "QUERY_SAVE_EXT_BATTLE_PASS: %lu", battlePass->dwPlayerId);
-
-	char szQuery[QUERY_MAX_LEN];
-	snprintf(szQuery, sizeof(szQuery),
-		"REPLACE INTO battlepass_missions (player_id, battlepass_type, mission_index, mission_type, battle_pass_id, extra_info, completed) VALUES (%lu, %d, %d, %d, %d, %d, %d)",
-		battlePass->dwPlayerId,
-		battlePass->dwBattlePassType,
-		battlePass->dwMissionIndex,
-		battlePass->dwMissionType,
-		battlePass->dwBattlePassId,
-		battlePass->dwExtraInfo,
-		battlePass->bCompleted ? 1 : 0);
-	CDBManager::instance().AsyncQuery(szQuery);
-}
-#endif
-
 /*
 * PLAYER SAVE
 */
@@ -1250,9 +1198,6 @@
 #if defined(__ACCE_COSTUME_SYSTEM__)
 		"`part_acce`, "
 #endif
-#if defined(__EXTEND_INVEN_SYSTEM__)
-		"`inven_stage`, "
-#endif
 		"`gold`, "
 #if defined(__CHEQUE_SYSTEM__)
 		"`cheque`, "
@@ -1260,6 +1205,7 @@
 #if defined(__GEM_SYSTEM__)
 		"`gem`, "
 #endif
+		"`pin`, "
 		"`playtime`, `skill_level`, `quickslot`) "
 		"VALUES (0, "
 		"%u, "
@@ -1275,8 +1221,8 @@
 		"%d, " // x
 		"%d, " // y
 		"%d, " // z
-		"%d, " // hp
-		"%d, " // sp
+		"%lld, " // hp
+		"%lld, " // sp
 		"%d, " // sRandomHP
 		"%d, " // sRandomSP
 		"%d, " // stat_point
@@ -1287,16 +1233,14 @@
 #if defined(__ACCE_COSTUME_SYSTEM__)
 		"%d, " // part_base(acce)
 #endif
-#if defined(__EXTEND_INVEN_SYSTEM__)
-		"%d, " // inven_stage
-#endif
-		"%d, " // gold
+		"%lld, " // gold
 #if defined(__CHEQUE_SYSTEM__)
 		"%d, " // cheque
 #endif
 #if defined(__GEM_SYSTEM__)
 		"%d, " // gem
 #endif
+		"'%s', " // pin
 		"0, "
 		, GetTablePostfix()
 		, packet->account_id
@@ -1320,12 +1264,9 @@
 		, packet->player_table.stamina
 		, packet->player_table.part_base
 		, packet->player_table.part_base
-		, packet->player_table.adwParts[PART_HAIR]
+		, packet->player_table.parts[PART_HAIR]
 #if defined(__ACCE_COSTUME_SYSTEM__)
-		, packet->player_table.adwParts[PART_ACCE]
-#endif
-#if defined(__EXTEND_INVEN_SYSTEM__)
-		, packet->player_table.inven_stage
+		, packet->player_table.parts[PART_ACCE]
 #endif
 		, packet->player_table.gold
 #if defined(__CHEQUE_SYSTEM__)
@@ -1334,6 +1275,7 @@
 #if defined(__GEM_SYSTEM__)
 		, packet->player_table.gem
 #endif
+		, packet->player_table.pin
 	);
 
 	sys_log(0, "PlayerCreate accountid %d name %s level %d gold %d"
@@ -1418,9 +1360,10 @@
 	pack.player.bySungmaMove = packet->player_table.sungma_move;
 	pack.player.bySungmaImmune = packet->player_table.sungma_immune;
 #endif
-	pack.player.dwMainPart = packet->player_table.part_base;
+	pack.player.wMainPart = packet->player_table.part_base;
 	pack.player.x = packet->player_table.x;
 	pack.player.y = packet->player_table.y;
+	strlcpy(pack.player.szPinCode, packet->player_table.pin, sizeof(pack.player.szPinCode));
 	pack.player.last_play = packet->player_table.last_play;
 
 	peer->EncodeHeader(HEADER_DG_PLAYER_CREATE_SUCCESS, dwHandle, sizeof(TPacketDGCreateSuccess));
@@ -1434,82 +1377,6 @@
 /*
 * PLAYER DELETE
 */
-#if defined(__DELETE_FAILURE_TYPE__)
-static char QUERY_CHECK_PLAYER_DELETE(DWORD dwPID, DWORD dwAID, INT* piWaitTime)
-{
-	*piWaitTime = 0;
-
-	SQLMsg* pMsg = NULL;
-	char szQuery[QUERY_MAX_LEN] = {};
-
-#if defined(__SOUL_BIND_SYSTEM__)
-	// Check if the player has any sealed items.
-	snprintf(szQuery, sizeof(szQuery), "SELECT * FROM item%s WHERE `owner_id` = %d AND `soulbind` != 0", GetTablePostfix(), dwPID);
-	pMsg = CDBManager::Instance().DirectQuery(szQuery);
-	if (pMsg->Get()->uiNumRows)
-		return DELETE_FAILURE_HAVE_SEALED_ITEM;
-#endif
-
-	// Check if the player is a member of a guild.
-	snprintf(szQuery, sizeof(szQuery), "SELECT * FROM guild_member%s WHERE `pid` = %d", GetTablePostfix(), dwPID);
-	pMsg = CDBManager::Instance().DirectQuery(szQuery);
-	if (pMsg->Get()->uiNumRows)
-		return DELETE_FAILURE_GUILD_MEMBER;
-
-	// Check if the player is married.
-	snprintf(szQuery, sizeof(szQuery), "SELECT * FROM marriage%s WHERE `pid1` = %d OR `pid2` = %d", GetTablePostfix(), dwPID, dwPID);
-	pMsg = CDBManager::Instance().DirectQuery(szQuery);
-	if (pMsg->Get()->uiNumRows)
-		return DELETE_FAILURE_MARRIAGE;
-
-	// Check if the player is the last character on the account and if there are any items in the safebox.
-	snprintf(szQuery, sizeof(szQuery), "SELECT COUNT(*) FROM `player%s` WHERE `account_id` = %u;", GetTablePostfix(), dwAID);
-	pMsg = CDBManager::Instance().DirectQuery(szQuery);
-	if (pMsg->Get() && pMsg->Get()->uiNumRows)
-	{
-		MYSQL_ROW row = mysql_fetch_row(pMsg->Get()->pSQLResult);
-
-		BYTE bPlayerCount = 0;
-		str_to_number(bPlayerCount, row[0]);
-
-		if (bPlayerCount == 1)
-		{
-			snprintf(szQuery, sizeof(szQuery), "SELECT * FROM `item%s` WHERE `owner_id` = %u AND `window` = 'SAFEBOX' > 0;", GetTablePostfix(), dwAID);
-			pMsg = CDBManager::Instance().DirectQuery(szQuery);
-			if (pMsg->Get()->uiNumRows)
-				return DELETE_FAILURE_LAST_CHAR_SAFEBOX;
-		}
-	}
-
-#if defined(__ATTR_6TH_7TH__)
-	// Check if the player has any items in the NPC storage.
-	snprintf(szQuery, sizeof(szQuery), "SELECT * FROM item%s WHERE `owner_id` = %d AND `window` = 'NPC_STORAGE'", GetTablePostfix(), dwPID);
-	pMsg = CDBManager::Instance().DirectQuery(szQuery);
-	if (pMsg->Get()->uiNumRows)
-		return DELETE_FAILURE_ATTR67;
-#endif
-
-	// Check if the player has any items in the premium private shop.
-	snprintf(szQuery, sizeof(szQuery), "SELECT * FROM item%s WHERE `owner_id` = %d AND `window` = 'PREMIUM_PRIVATE_SHOP'", GetTablePostfix(), dwPID);
-	pMsg = CDBManager::Instance().DirectQuery(szQuery);
-	if (pMsg->Get()->uiNumRows)
-		return DELETE_FAILURE_PREMIUM_PRIVATE_SHOP;
-
-	// Check if the player has at least 10 minutes of playtime.
-	/*
-	CPlayerTableCache* pPlayerTableCache = CClientManager::Instance().GetPlayerCache(dwPID);
-	INT iPlayTime = pPlayerTableCache ? pPlayerTableCache->Get(false)->playtime : 0;
-	if (iPlayTime < 10)
-	{
-		*piWaitTime = 10 - iPlayTime;
-		return DELETE_FAILURE_REMAIN_TIME;
-	}
-	*/
-
-	return -1;
-}
-#endif
-
 void CClientManager::__QUERY_PLAYER_DELETE(CPeer* peer, DWORD dwHandle, TPlayerDeletePacket* packet)
 {
 	if (!packet->login[0] || !packet->player_id || packet->account_index >= PLAYER_PER_ACCOUNT)
@@ -1519,16 +1386,8 @@
 
 	if (!ld)
 	{
-#if defined(__DELETE_FAILURE_TYPE__)
-		TPlayerDeleteFailurePacket DelFailurePacket = {};
-		DelFailurePacket.bType = DELETE_FAILURE_NORMAL;
-		DelFailurePacket.iTime = 0;
-		peer->EncodeHeader(HEADER_DG_PLAYER_DELETE_FAILED, dwHandle, sizeof(TPlayerDeleteFailurePacket));
-		peer->Encode(&DelFailurePacket, sizeof(TPlayerDeleteFailurePacket));
-#else
-		peer->EncodeHeader(HEADER_DG_PLAYER_DELETE_FAILED, dwHandle, sizeof(BYTE));
+		peer->EncodeHeader(HEADER_DG_PLAYER_DELETE_FAILED, dwHandle, 1);
 		peer->EncodeBYTE(packet->account_index);
-#endif
 		return;
 	}
 
@@ -1542,16 +1401,8 @@
 			if (strlen(r.social_id) < 7 || strncmp(packet->private_code, r.social_id + strlen(r.social_id) - 7, 7))
 			{
 				sys_log(0, "PLAYER_DELETE FAILED len(%d)", strlen(r.social_id));
-#if defined(__DELETE_FAILURE_TYPE__)
-				TPlayerDeleteFailurePacket DelFailurePacket;
-				DelFailurePacket.bType = DELETE_FAILURE_PRIVATE_CODE_ERROR;
-				DelFailurePacket.iTime = 0;
-				peer->EncodeHeader(HEADER_DG_PLAYER_DELETE_FAILED, dwHandle, sizeof(TPlayerDeleteFailurePacket));
-				peer->Encode(&DelFailurePacket, sizeof(TPlayerDeleteFailurePacket));
-#else
-				peer->EncodeHeader(HEADER_DG_PLAYER_DELETE_FAILED, dwHandle, sizeof(BYTE));
+				peer->EncodeHeader(HEADER_DG_PLAYER_DELETE_FAILED, dwHandle, 1);
 				peer->EncodeBYTE(packet->account_index);
-#endif
 				return;
 			}
 
@@ -1563,52 +1414,22 @@
 				if (pTab->level >= m_iPlayerDeleteLevelLimit)
 				{
 					sys_log(0, "PLAYER_DELETE FAILED LEVEL %u >= DELETE LIMIT %d", pTab->level, m_iPlayerDeleteLevelLimit);
-#if defined(__DELETE_FAILURE_TYPE__)
-					TPlayerDeleteFailurePacket DelFailurePacket;
-					DelFailurePacket.bType = DELETE_FAILURE_LIMITE_LEVEL_HIGHER;
-					DelFailurePacket.iTime = 0;
-					peer->EncodeHeader(HEADER_DG_PLAYER_DELETE_FAILED, dwHandle, sizeof(TPlayerDeleteFailurePacket));
-					peer->Encode(&DelFailurePacket, sizeof(TPlayerDeleteFailurePacket));
-#else
-					peer->EncodeHeader(HEADER_DG_PLAYER_DELETE_FAILED, dwHandle, sizeof(BYTE));
+					peer->EncodeHeader(HEADER_DG_PLAYER_DELETE_FAILED, dwHandle, 1);
 					peer->EncodeBYTE(packet->account_index);
-#endif
 					return;
 				}
 
 				if (pTab->level < m_iPlayerDeleteLevelLimitLower)
 				{
 					sys_log(0, "PLAYER_DELETE FAILED LEVEL %u < DELETE LIMIT %d", pTab->level, m_iPlayerDeleteLevelLimitLower);
-#if defined(__DELETE_FAILURE_TYPE__)
-					TPlayerDeleteFailurePacket DelFailurePacket;
-					DelFailurePacket.bType = DELETE_FAILURE_LIMITE_LEVEL_LOWER;
-					DelFailurePacket.iTime = 0;
-					peer->EncodeHeader(HEADER_DG_PLAYER_DELETE_FAILED, dwHandle, sizeof(TPlayerDeleteFailurePacket));
-					peer->Encode(&DelFailurePacket, sizeof(TPlayerDeleteFailurePacket));
-#else
-					peer->EncodeHeader(HEADER_DG_PLAYER_DELETE_FAILED, dwHandle, sizeof(BYTE));
+					peer->EncodeHeader(HEADER_DG_PLAYER_DELETE_FAILED, dwHandle, 1);
 					peer->EncodeBYTE(packet->account_index);
-#endif
 					return;
 				}
 			}
 		}
 	}
 
-#if defined(__DELETE_FAILURE_TYPE__)
-	INT iWaitTime;
-	const char bFailureType = QUERY_CHECK_PLAYER_DELETE(packet->player_id, r.id, &iWaitTime);
-	if (bFailureType != -1)
-	{
-		TPlayerDeleteFailurePacket DelFailurePacket;
-		DelFailurePacket.bType = bFailureType;
-		DelFailurePacket.iTime = iWaitTime;
-		peer->EncodeHeader(HEADER_DG_PLAYER_DELETE_FAILED, dwHandle, sizeof(TPlayerDeleteFailurePacket));
-		peer->Encode(&DelFailurePacket, sizeof(TPlayerDeleteFailurePacket));
-		return;
-}
-#endif
-
 	char szQuery[128];
 	snprintf(szQuery, sizeof(szQuery), "SELECT p.`id`, p.`level`, p.`name` FROM player_index%s AS i, player%s AS p WHERE `pid%d` = %u AND `pid%d` = p.`id`",
 		GetTablePostfix(), GetTablePostfix(), packet->account_index + 1, packet->player_id, packet->account_index + 1);
@@ -1698,7 +1519,7 @@
 			while (it != pSet->end())
 			{
 				CItemCache* pkItemCache = *it++;
-				DeleteItemCache(pkItemCache->Get()->dwID);
+				DeleteItemCache(pkItemCache->Get()->id);
 			}
 
 			pSet->clear();
@@ -1723,32 +1544,27 @@
 			return;
 		}
 
-		snprintf(queryStr, sizeof(queryStr), "DELETE FROM `player%s` WHERE `id` = %u", GetTablePostfix(), pi->player_id);
+		snprintf(queryStr, sizeof(queryStr), "DELETE FROM player%s WHERE `id` = %u", GetTablePostfix(), pi->player_id);
 		delete CDBManager::instance().DirectQuery(queryStr);
 
-		snprintf(queryStr, sizeof(queryStr), "DELETE FROM `item%s` WHERE `owner_id` = %u AND (`window` in ("
-			"'INVENTORY', 'EQUIPMENT', 'DRAGON_SOUL_INVENTORY', 'BELT_INVENTORY'"
-#if defined(__ATTR_6TH_7TH__)
-			", 'NPC_STORAGE'"
-#endif
-			"))", GetTablePostfix(), pi->player_id);
+		snprintf(queryStr, sizeof(queryStr), "DELETE FROM item%s WHERE `owner_id` = %u AND (`window` < %d OR `window` = %d OR `window` = %d)", GetTablePostfix(), pi->player_id, SAFEBOX, DRAGON_SOUL_INVENTORY, BELT_INVENTORY);
 		delete CDBManager::instance().DirectQuery(queryStr);
 
-		snprintf(queryStr, sizeof(queryStr), "DELETE FROM `quest%s` WHERE `dwPID` = %d", GetTablePostfix(), pi->player_id);
+		snprintf(queryStr, sizeof(queryStr), "DELETE FROM quest%s WHERE `dwPID` = %d", GetTablePostfix(), pi->player_id);
 		CDBManager::instance().AsyncQuery(queryStr);
 
-		snprintf(queryStr, sizeof(queryStr), "DELETE FROM `affect%s` WHERE `dwPID` = %d", GetTablePostfix(), pi->player_id);
+		snprintf(queryStr, sizeof(queryStr), "DELETE FROM affect%s WHERE `dwPID` = %d", GetTablePostfix(), pi->player_id);
 		CDBManager::instance().AsyncQuery(queryStr);
 
-		snprintf(queryStr, sizeof(queryStr), "DELETE FROM `guild_member%s` WHERE `pid` = %u", GetTablePostfix(), pi->player_id);
+		snprintf(queryStr, sizeof(queryStr), "DELETE FROM guild_member%s WHERE `pid` = %u", GetTablePostfix(), pi->player_id);
 		CDBManager::instance().AsyncQuery(queryStr);
 
 		// MYSHOP_PRICE_LIST
-		snprintf(queryStr, sizeof(queryStr), "DELETE FROM `myshop_pricelist%s` WHERE `owner_id` = %u", GetTablePostfix(), pi->player_id);
+		snprintf(queryStr, sizeof(queryStr), "DELETE FROM myshop_pricelist%s WHERE `owner_id` = %u", GetTablePostfix(), pi->player_id);
 		CDBManager::instance().AsyncQuery(queryStr);
 		// END_OF_MYSHOP_PRICE_LIST
 
-		snprintf(queryStr, sizeof(queryStr), "DELETE FROM `messenger_list%s` WHERE `account` = '%s' OR `companion` = '%s'", GetTablePostfix(), szName, szName);
+		snprintf(queryStr, sizeof(queryStr), "DELETE FROM messenger_list%s WHERE `account` = '%s' OR `companion` = '%s'", GetTablePostfix(), szName, szName);
 		CDBManager::instance().AsyncQuery(queryStr);
 
 		peer->EncodeHeader(HEADER_DG_PLAYER_DELETE_SUCCESS, pi->dwHandle, 1);
@@ -1765,72 +1581,37 @@
 
 void CClientManager::QUERY_ADD_AFFECT(CPeer* peer, TPacketGDAddAffect* p)
 {
-	char query[QUERY_MAX_LEN];
-#if defined(__AFFECT_RENEWAL__)
-	if (p->elem.bUpdate)
-	{
-		snprintf(query, sizeof(query),
-			"UPDATE `affect%s` SET `lApplyValue` = %ld, `dwFlag` = %u, `lDuration` = %ld, `lSPCost` = %ld, `bRealTime` = %d "
-			"WHERE `dwPID` = %u AND `dwType` = %u AND `wApplyOn` = %u",
-			GetTablePostfix(),
-			p->elem.lApplyValue,
-			p->elem.dwFlag,
-			p->elem.lDuration,
-			p->elem.lSPCost,
-			p->elem.bRealTime ? 1 : 0,
-			p->dwPID,
-			p->elem.dwType,
-			p->elem.wApplyOn);
-	}
-	else
-	{
-		snprintf(query, sizeof(query),
-			"REPLACE INTO `affect%s` (`dwPID`, `dwType`, `wApplyOn`, `lApplyValue`, `dwFlag`, `lDuration`, `lSPCost`, `bRealTime`) "
-			"VALUES(%u, %u, %u, %ld, %u, %ld, %ld, %d)",
-			GetTablePostfix(),
-			p->dwPID,
-			p->elem.dwType,
-			p->elem.wApplyOn,
-			p->elem.lApplyValue,
-			p->elem.dwFlag,
-			p->elem.lDuration,
-			p->elem.lSPCost,
-			p->elem.bRealTime ? 1 : 0);
-	}
-#else
-	snprintf(query, sizeof(query),
-		"REPLACE INTO `affect%s` (`dwPID`, `dwType`, `wApplyOn`, `lApplyValue`, `dwFlag`, `lDuration`, `lSPCost`) "
+	char queryStr[QUERY_MAX_LEN];
+	snprintf(queryStr, sizeof(queryStr),
+		"REPLACE INTO affect%s (`dwPID`, `bType`, `bApplyOn`, `lApplyValue`, `dwFlag`, `lDuration`, `lSPCost`) "
 		"VALUES(%u, %u, %u, %ld, %u, %ld, %ld)",
 		GetTablePostfix(),
 		p->dwPID,
 		p->elem.dwType,
-		p->elem.wApplyOn,
+		p->elem.bApplyOn,
 		p->elem.lApplyValue,
 		p->elem.dwFlag,
 		p->elem.lDuration,
-		p->elem.lSPCost
-	);
-#endif
-	CDBManager::instance().AsyncQuery(query);
+		p->elem.lSPCost);
+
+	CDBManager::instance().AsyncQuery(queryStr);
 }
 
 void CClientManager::QUERY_REMOVE_AFFECT(CPeer* peer, TPacketGDRemoveAffect* p)
 {
-	char query[QUERY_MAX_LEN];
-	snprintf(query, sizeof(query),
-		"DELETE FROM `affect%s` WHERE `dwPID` = %u AND `dwType` = %u AND `wApplyOn` = %u",
-		GetTablePostfix(), p->dwPID, p->dwType, p->wApplyOn);
-	CDBManager::instance().AsyncQuery(query);
+	char queryStr[QUERY_MAX_LEN];
+
+	snprintf(queryStr, sizeof(queryStr),
+		"DELETE FROM affect%s WHERE `dwPID` = %u AND `bType` = %u AND `bApplyOn` = %u",
+		GetTablePostfix(), p->dwPID, p->dwType, p->bApplyOn);
+
+	CDBManager::instance().AsyncQuery(queryStr);
 }
 
 void CClientManager::QUERY_HIGHSCORE_REGISTER(CPeer* peer, TPacketGDHighscore* data)
 {
-	char escBoard[sizeof(data->szBoard) * 2 + 1];
-	const size_t boardLen = strnlen(data->szBoard, sizeof(data->szBoard));
-	CDBManager::instance().EscapeString(escBoard, data->szBoard, boardLen);
-
-	char szQuery[256];
-	snprintf(szQuery, sizeof(szQuery), "SELECT `value` FROM highscore%s WHERE `board` = '%s' AND `pid` = %u", GetTablePostfix(), escBoard, data->dwPID);
+	char szQuery[128];
+	snprintf(szQuery, sizeof(szQuery), "SELECT `value` FROM highscore%s WHERE `board` = '%s' AND `pid` = %u", GetTablePostfix(), data->szBoard, data->dwPID);
 
 	sys_log(0, "HEADER_GD_HIGHSCORE_REGISTER: PID %u", data->dwPID);
 
@@ -1945,11 +1726,12 @@
 
 		if (now - g_iLogoutSeconds > pLogout->time)
 		{
-			FlushItemCacheSet(pLogout->pid);
-			FlushPlayerCacheSet(pLogout->pid);
 #ifdef __GROWTH_PET_SYSTEM__
 			FlushGrowthPetCacheSet(pLogout->pid);
 #endif
+			FlushItemCacheSet(pLogout->pid);
+			FlushPlayerCacheSet(pLogout->pid);
+
 			delete pLogout;
 			m_map_logout.erase(it++);
 		}
diff -ruN baseline/server/server/home/metin2/Source/Server/db/src/ProtoReader.cpp final/server/server/home/metin2/Source/Server/db/src/ProtoReader.cpp
--- baseline/server/server/home/metin2/Source/Server/db/src/ProtoReader.cpp	2025-06-28 19:31:06.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/db/src/ProtoReader.cpp	2022-04-27 10:07:54.000000000 +0000
@@ -55,54 +55,54 @@
 int get_Item_Type_Value(string inputString)
 {
 	string arType[] = {
-		"ITEM_NONE",
-		"ITEM_WEAPON",
-		"ITEM_ARMOR",
-		"ITEM_USE",
-		"ITEM_AUTOUSE",
-		"ITEM_MATERIAL",
-		"ITEM_SPECIAL",
-		"ITEM_TOOL",
-		"ITEM_LOTTERY",
-		"ITEM_ELK",
-		"ITEM_METIN",
-		"ITEM_CONTAINER",
-		"ITEM_FISH",
-		"ITEM_ROD",
-		"ITEM_RESOURCE",
-		"ITEM_CAMPFIRE",
-		"ITEM_UNIQUE",
-		"ITEM_SKILLBOOK",
-		"ITEM_QUEST",
-		"ITEM_POLYMORPH",
-		"ITEM_TREASURE_BOX",
-		"ITEM_TREASURE_KEY",
-		"ITEM_SKILLFORGET",
-		"ITEM_GIFTBOX",
-		"ITEM_PICK",
-		"ITEM_HAIR",
-		"ITEM_TOTEM",
-		"ITEM_BLEND",
-		"ITEM_COSTUME",
-		"ITEM_DS",
-		"ITEM_SPECIAL_DS",
-		"ITEM_EXTRACT",
-		"ITEM_SECONDARY_COIN",
-		"ITEM_RING",
-		"ITEM_BELT",
-		"ITEM_PET",
-#if defined(__MOVE_COSTUME_ATTR__)		
-		"ITEM_MEDIUM",
-#endif									
-#if defined(__GACHA_SYSTEM__)			
-		"ITEM_GACHA",
-#endif									
-		"ITEM_PASSIVE",
-		"ITEM_MERCENARY",
-		"ITEM_ALCHEMY",
-//#if defined(__SOUL_SYSTEM__)			
-		"ITEM_SOUL",
-//#endif
+		"ITEM_NONE",				// 0 ~ 1
+		"ITEM_WEAPON",				// 1 ~ 2
+		"ITEM_ARMOR",				// 2 ~ 3
+		"ITEM_USE",					// 3 ~ 4
+		"ITEM_AUTOUSE",				// 4 ~ 5
+		"ITEM_MATERIAL",			// 5 ~ 6
+		"ITEM_SPECIAL",				// 6 ~ 7
+		"ITEM_TOOL",				// 7 ~ 8
+		"ITEM_LOTTERY",				// 8 ~ 9
+		"ITEM_ELK",					// 9 ~ 10
+		"ITEM_METIN",				// 10 ~ 11
+		"ITEM_CONTAINER",			// 11 ~ 12
+		"ITEM_FISH",				// 12 ~ 13
+		"ITEM_ROD",					// 13 ~ 14
+		"ITEM_RESOURCE",			// 14 ~ 15
+		"ITEM_CAMPFIRE",			// 15 ~ 16
+		"ITEM_UNIQUE",				// 16 ~ 17
+		"ITEM_SKILLBOOK",			// 17 ~ 18
+		"ITEM_QUEST",				// 18 ~ 19
+		"ITEM_POLYMORPH",			// 19 ~ 20
+		"ITEM_TREASURE_BOX",		// 20 ~ 21
+		"ITEM_TREASURE_KEY",		// 21 ~ 22
+		"ITEM_SKILLFORGET",			// 22 ~ 23
+		"ITEM_GIFTBOX",				// 23 ~ 24
+		"ITEM_PICK",				// 24 ~ 25
+		"ITEM_HAIR",				// 25 ~ 26
+		"ITEM_TOTEM",				// 26 ~ 27
+		"ITEM_BLEND",				// 27 ~ 28
+		"ITEM_COSTUME",				// 28 ~ 29
+		"ITEM_DS",					// 29 ~ 30
+		"ITEM_SPECIAL_DS",			// 30 ~ 31
+		"ITEM_EXTRACT",				// 31 ~ 32
+		"ITEM_SECONDARY_COIN",		// 32 ~ 33
+		"ITEM_RING",				// 33 ~ 34
+		"ITEM_BELT",				// 34 ~ 35 (EItemTypes  ġ 34)
+#if defined(__CHEQUE_SYSTEM__)
+		"ITEM_CHEQUE",				// 35 ~ 36 (EItemTypes Value 35)
+#endif
+#if defined(__GACHA_SYSTEM__)
+		"ITEM_GACHA",				// 36 ~ 37 (EItemTypes Value 36)
+#endif
+		"ITEM_PET",					// 37 ~ 38 (EItemTypes Value 37)
+#if defined(__SOUL_SYSTEM__)
+		"ITEM_SOUL",				// 38 ~ 39 (EItemTypes Value 38)
+#endif
+		"ITEM_MEDIUM",				// 39 ~ 40 (EItemTypes Value 39)
+		"ITEM_PASSIVE",				// 40 ~ 41 (EItemTypes Value 40)
+		"ITEM_MERCENARY"			// 41 ~ 42 (EItemTypes Value 41) 
 	};
 
 	int retInt = -1;
@@ -137,7 +137,7 @@
 #if defined(__QUIVER_SYSTEM__)
 		"WEAPON_QUIVER",
 #endif
-		"WEAPON_BOUQUE",
+		"WEAPON_BOUQUET"
 	};
 
 	static string arSub2[] = {
@@ -154,64 +154,59 @@
 #if defined(__GLOVE_SYSTEM__)
 		"ARMOR_GLOVE",
 #endif
+		"ARMOR_NUM_TYPES"
 	};
 
 	static string arSub3[] = {
-		"USE_POTION",
-		"USE_TALISMAN",
-		"USE_TUNING",
-		"USE_MOVE",
-		"USE_TREASURE_BOX",
-		"USE_MONEYBAG",
-		"USE_BAIT",
-		"USE_ABILITY_UP",
-		"USE_AFFECT",
-		"USE_CREATE_STONE",
-		"USE_SPECIAL",
-		"USE_POTION_NODELAY",
-		"USE_CLEAR",
-		"USE_INVISIBILITY",
-		"USE_DETACHMENT",
-		"USE_BUCKET",
-		"USE_POTION_CONTINUE",
-		"USE_CLEAN_SOCKET",
-		"USE_CHANGE_ATTRIBUTE",
-		"USE_ADD_ATTRIBUTE",
-		"USE_ADD_ACCESSORY_SOCKET",
-		"USE_PUT_INTO_ACCESSORY_SOCKET",
-		"USE_ADD_ATTRIBUTE2",
-		"USE_RECIPE",
-		"USE_CHANGE_ATTRIBUTE2",
-		"USE_BIND",
-		"USE_UNBIND",
-		"USE_TIME_CHARGE_PER",
-		"USE_TIME_CHARGE_FIX",
-		"USE_PUT_INTO_BELT_SOCKET",
-		"USE_PUT_INTO_RING_SOCKET",
-#if defined(__MOVE_COSTUME_ATTR__)
-		"USE_CHANGE_COSTUME_ATTR",
-		"USE_RESET_COSTUME_ATTR",
-#endif
-		"USE_UNK_33",
-#if defined(__CHANGED_ATTR__)
-		"USE_SELECT_ATTRIBUTE",
-#endif
-		"USE_FLOWER",
-#if defined(__EXPRESSING_EMOTIONS__)
-		"USE_EMOTION_PACK",
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-		"USE_ELEMENT_UPGRADE",
-		"USE_ELEMENT_DOWNGRADE",
-		"USE_ELEMENT_CHANGE",
-#endif
-		"USE_CALL",
-		"USE_POTION_TOWER",
-		"USE_POTION_NODELAY_TOWER",
-		"USE_REMOVE_AFFECT",
-		"USE_EMOTION_TOWER",
-		"USE_SECRET_DUNGEON_SCROLL",
-		"USE_OPEN_OFFLINE_SHOP",
+		"USE_POTION",						// 0
+		"USE_TALISMAN",						// 1
+		"USE_TUNING",						// 2
+		"USE_MOVE",							// 3
+		"USE_TREASURE_BOX",					// 4
+		"USE_MONEYBAG",						// 5
+		"USE_BAIT",							// 6
+		"USE_ABILITY_UP",					// 7
+		"USE_AFFECT",						// 8
+		"USE_CREATE_STONE",					// 9
+		"USE_SPECIAL",						// 10
+		"USE_POTION_NODELAY",				// 11
+		"USE_CLEAR",						// 12
+		"USE_INVISIBILITY",					// 13
+		"USE_DETACHMENT",					// 14
+		"USE_BUCKET",						// 15
+		"USE_POTION_CONTINUE",				// 16
+		"USE_CLEAN_SOCKET",					// 17
+		"USE_CHANGE_ATTRIBUTE",				// 18
+		"USE_ADD_ATTRIBUTE",				// 19
+		"USE_ADD_ACCESSORY_SOCKET",			// 20
+		"USE_PUT_INTO_ACCESSORY_SOCKET",	// 21
+		"USE_ADD_ATTRIBUTE2",				// 22
+		"USE_RECIPE",						// 23
+		"USE_CHANGE_ATTRIBUTE2",			// 24
+		"USE_BIND",							// 25
+		"USE_UNBIND",						// 26
+		"USE_TIME_CHARGE_PER",				// 27
+		"USE_TIME_CHARGE_FIX",				// 28
+		"USE_PUT_INTO_BELT_SOCKET",			// 29
+		"USE_PUT_INTO_RING_SOCKET",			// 30
+#if defined(__COSTUME_ATTR_SYSTEM__)
+		"USE_CHANGE_COSTUME_ATTR",			// 31
+		"USE_RESET_COSTUME_ATTR",			// 32
+#endif
+		"USE_CALL",							// 33 (Bravery Cape)
+		"USE_REMOVE_AFFECT",				// 34 (Remove Affect)
+		"USE_SELECT_ATTRIBUTE",				// 35
+		"USE_EMOTION_PACK",					// 36 (Emotion Pack)
+		"USE_FLOWER",						// 37 (Flower Power Event)
+		"USE_UNK39",						// 38
+		"USE_UNK40",						// 39
+		"USE_ELEMENT_UPGRADE",				// 40
+		"USE_ELEMENT_DOWNGRADE",			// 41
+		"USE_ELEMENT_CHANGE",				// 42
+		"USE_POTION_TOWER",					// 43 (SungMa Tower)
+		"USE_POTION_NODELAY_TOWER",			// 44 (SungMa Tower)
+		"USE_EMOTION_TOWER",				// 45 (SungMa Tower)
+		"USE_SECRET_DUNGEON_SCROLL"			// 46
 	};
 
 	static string arSub4[] = {
@@ -220,7 +215,7 @@
 		"AUTOUSE_BOMB",
 		"AUTOUSE_GOLD",
 		"AUTOUSE_MONEYBAG",
-		"AUTOUSE_TREASURE_BOX",
+		"AUTOUSE_TREASURE_BOX"
 	};
 
 	static string arSub5[] = {
@@ -232,39 +227,38 @@
 		"MATERIAL_DS_REFINE_NORMAL",
 		"MATERIAL_DS_REFINE_BLESSED",
 		"MATERIAL_DS_REFINE_HOLLY",
-#if defined(__DS_CHANGE_ATTR__)
-		"MATERIAL_DS_CHANGE_ATTR",
-#endif
+		"MATERIAL_DS_CHANGE_ATTR", // Dragon Soul Myth
 		"MATERIAL_PASSIVE_WEAPON",
 		"MATERIAL_PASSIVE_ARMOR",
 		"MATERIAL_PASSIVE_ACCE",
-		"MATERIAL_PASSIVE_ELEMENT",
+		"MATERIAL_PASSIVE_ELEMENT"
 	};
 
 	static string arSub6[] = {
 		"SPECIAL_MAP",
 		"SPECIAL_KEY",
 		"SPECIAL_DOC",
-		"SPECIAL_SPIRIT",
+		"SPECIAL_SPIRIT"
 	};
 
 	static string arSub7[] = {
-		"TOOL_FISHING_ROD",
+		"TOOL_FISHING_ROD"
 	};
 
 	static string arSub8[] = {
 		"LOTTERY_TICKET",
-		"LOTTERY_INSTANT",
+		"LOTTERY_INSTANT"
 	};
 
 	static string arSub10[] = {
 		"METIN_NORMAL",
-		"METIN_SUNGMA",
+		"METIN_GOLD",
+		"METIN_SUNGMA"
 	};
 
 	static string arSub12[] = {
 		"FISH_ALIVE",
-		"FISH_DEAD",
+		"FISH_DEAD"
 	};
 
 	static string arSub14[] = {
@@ -281,7 +275,7 @@
 		"RESOURCE_METIN",
 		"RESOURCE_ORE",
 #if defined(__AURA_COSTUME_SYSTEM__)
-		"RESOURCE_AURA",
+		"RESOURCE_AURA"
 #endif
 	};
 
@@ -296,21 +290,12 @@
 		"UNIQUE_7",
 		"UNIQUE_8",
 		"UNIQUE_9",
-		"UNIQUE_BUNDLE",
+		"USE_SPECIAL"
 	};
 
 	static string arSub18[] = {
 		"QUEST_NONE",
-		"QUEST_PET_PAY",
-		"QUEST_WARP",
-		"QUEST_GEM_BAG",
-	};
-
-	static std::string arSub23[]
-	{
-		"GIFTBOX_NONE",
-		"GIFTBOX_NORMAL",
-		"GIFTBOX_SPECIAL",
+		"QUEST_WARP"
 	};
 
 	static string arSub28[] = {
@@ -326,7 +311,7 @@
 		"COSTUME_WEAPON",
 #endif
 #if defined(__AURA_COSTUME_SYSTEM__)
-		"COSTUME_AURA",
+		"COSTUME_AURA"
 #endif
 	};
 
@@ -336,196 +321,153 @@
 		"DS_SLOT3",
 		"DS_SLOT4",
 		"DS_SLOT5",
-		"DS_SLOT6",
-#if defined(__DS_7_SLOT__)
-		"DS_SLOT7",
-#endif
+		"DS_SLOT6"
 	};
 
 	static string arSub31[] = {
 		"EXTRACT_DRAGON_SOUL",
-		"EXTRACT_DRAGON_HEART",
-	};
-
-//#ifdef __GROWTH_PET_SYSTEM__
-	static string arSub35[] = {
-	"PET_EGG",
-	"PET_UPBRINGING",
-	"PET_BAG",
-	"PET_FEEDSTUFF",
-	"PET_SKILL",
-	"PET_SKILL_DEL_BOOK",
-	"PET_NAME_CHANGE",
-	"PET_EXPFOOD",
-	"PET_SKILL_ALL_DEL_BOOK",
-	"PET_EXPFOOD_PER",
-	"PET_ATTR_DETERMINE",
-	"PET_ATTR_CHANGE",
-	"PET_PAY",
-	"PET_PRIMIUM_FEEDSTUFF",
+		"EXTRACT_DRAGON_HEART"
 	};
-//#endif
 
-#if defined(__MOVE_COSTUME_ATTR__)
-	static string arSub36[] = {
-		"MEDIUM_MOVE_COSTUME_ATTR",
-#if defined(__ACCE_COSTUME_SYSTEM__)
-		"MEDIUM_MOVE_ACCE_ATTR",
-#endif
+	static string arSub37[] = { 
+		"PET_EGG", 
+		"PET_UPBRINGING", 
+		"PET_BAG", 
+		"PET_FEEDSTUFF", 
+		"PET_SKILL", 
+		"PET_SKILL_DEL_BOOK", 
+		"PET_NAME_CHANGE",
+		"PET_EXPFOOD", 
+		"PET_SKILL_ALL_DEL_BOOK", 
+		"PET_EXPFOOD_PER", 
+		"PET_ATTR_DETERMINE", 
+		"PET_ATTR_CHANGE", 
+		"PET_PAY", 
+		"PET_PRIMIUM_FEEDSTUFF" 
 	};
-#endif
 
-#if defined(__GACHA_SYSTEM__)
-	static string arSub37[] = {
-		"USE_GACHA",
-#if defined(__LUCKY_BOX__)
-		"GEM_LUCKY_BOX_GACHA",
-		"SPECIAL_LUCKY_BOX_GACHA",
-#endif
+#if defined(__SOUL_SYSTEM__)
+	static string arSub38[] = {
+		"SOUL_RED",
+		"SOUL_BLUE"
 	};
 #endif
 
-	static std::string arSub38[]
-	{
-		"PASSIVE_JOB",
+	static string arSub39[] = {
+		"MEDIUM_MOVE_COSTUME_ATTR",
+		"MEDIUM_MOVE_ACCE_ATTR"
 	};
 
-	static string arSub39[] = {
+	static string arSub41[] = {
 		"MERCENARY_0",
 		"MERCENARY_1",
 		"MERCENARY_2",
 		"MERCENARY_3",
 		"MERCENARY_4",
 		"MERCENARY_5",
-		"MERCENARY_6",
-	};
-
-	static std::string arSub40[]
-	{
-		"ARMOR",
-		"WEAPON",
-		"ACCESSORY",
-		"BELT",
-		"EVENT",
-		"ETC",
-		"JOB",
-		"SETADD_WEAPON",
-		"SETADD_ARMOR_BODY",
-		"SETADD_ARMOR_HELMET",
-		"PET",
-		"SKILL_BOOK",
-		"GLOVE",
-	};
-
-//#if defined(__SOUL_SYSTEM__)
-	static string arSub41[] = {
-		"SOUL_RED",
-		"SOUL_BLUE"
+		"MERCENARY_6"
 	};
-//#endif
 
 	static string* arSubType[] = {
-		0,			// ITEM_NONE
-		arSub1,		// ITEM_WEAPON
-		arSub2,		// ITEM_ARMOR
-		arSub3,		// ITEM_USE
-		arSub4,		// ITEM_AUTOUSE
-		arSub5,		// ITEM_MATERIAL
-		arSub6,		// ITEM_SPECIAL
-		arSub7,		// ITEM_TOOL
-		arSub8,		// ITEM_LOTTERY
-		0,			// ITEM_ELK
-		arSub10,	// ITEM_METIN
-		0,			// ITEM_CONTAINER
-		arSub12,	// ITEM_FISH
-		0,			// ITEM_ROD
-		arSub14,	// ITEM_RESOURCE
-		0,			// ITEM_CAMPFIRE
-		arSub16,	// ITEM_UNIQUE
-		0,			// ITEM_SKILLBOOK
-		arSub18,	// ITEM_QUEST
-		0,			// ITEM_POLYMORPH
-		0,			// ITEM_TREASURE_BOX
-		0,			// ITEM_TREASURE_KEY
-		0,			// ITEM_SKILLFORGET
-		arSub23,	// ITEM_GIFTBOX
-		0,			// ITEM_PICK
-		0,			// ITEM_HAIR
-		0,			// ITEM_TOTEM
-		0,			// ITEM_BLEND
-		arSub28,	// ITEM_COSTUME
-		arSub29,	// ITEM_DS
-		arSub29,	// ITEM_SPECIAL_DS
-		arSub31,	// ITEM_EXTRACT
-		0,			// ITEM_SECONDARY_COIN
-		0,			// ITEM_RING
-		0,			// ITEM_BELT
-//#ifdef __GROWTH_PET_SYSTEM__
-		arSub35,	// ITEM_PET
-//#endif
-#if defined(__MOVE_COSTUME_ATTR__)
-		arSub36,	// ITEM_MEDIUM
+		0,			// 0
+		arSub1,		// 1
+		arSub2,		// 2
+		arSub3,		// 3
+		arSub4,		// 4
+		arSub5,		// 5
+		arSub6,		// 6
+		arSub7,		// 7
+		arSub8,		// 8
+		0,			// 9
+		arSub10,	// 10
+		0,			// 11
+		arSub12,	// 12
+		0,			// 13
+		arSub14,	// 14
+		0,			// 15
+		arSub16,	// 16
+		0,			// 17
+		arSub18,	// 18
+		0,			// 19
+		0,			// 20
+		0,			// 21
+		0,			// 22
+		0,			// 23
+		0,			// 24
+		0,			// 25
+		0,			// 26
+		0,			// 27
+		arSub28,	// 28
+		arSub29,	// 29
+		arSub29,	// 30
+		arSub31,	// 31
+		0,			// 32
+		0,			// 33 
+		0,			// 34 Ʈ
+#if defined(__CHEQUE_SYSTEM__)
+		0,			// 35 won
 #endif
 #if defined(__GACHA_SYSTEM__)
-		arSub37,	// ITEM_GACHA
+		0,			// 36 gacha
 #endif
-		arSub38,	// ITEM_PASSIVE
-		arSub39,	// ITEM_MERCENARY
-		arSub40,	// ITEM_ALCHEMY
-//#if defined(__SOUL_SYSTEM__)
-		arSub41,	// ITEM_SOUL
-//#endif
+		arSub37,	// 37 pet
+#if defined(__SOUL_SYSTEM__)
+		arSub38,	// 38 soul
+#endif
+		arSub39,	// 39 medium
+		0,			// 40 passive
+		arSub41,	// 41 mercenary
 	};
 
 	static int arNumberOfSubtype[_countof(arSubType)] = {
-		0,										// ITEM_NONE
-		sizeof(arSub1) / sizeof(arSub1[0]),		// ITEM_WEAPON
-		sizeof(arSub2) / sizeof(arSub2[0]),		// ITEM_ARMOR
-		sizeof(arSub3) / sizeof(arSub3[0]),		// ITEM_USE
-		sizeof(arSub4) / sizeof(arSub4[0]),		// ITEM_AUTOUSE
-		sizeof(arSub5) / sizeof(arSub5[0]),		// ITEM_MATERIAL
-		sizeof(arSub6) / sizeof(arSub6[0]),		// ITEM_SPECIAL
-		sizeof(arSub7) / sizeof(arSub7[0]),		// ITEM_TOOL
-		sizeof(arSub8) / sizeof(arSub8[0]),		// ITEM_LOTTERY
-		0,										// ITEM_ELK
-		sizeof(arSub10) / sizeof(arSub10[0]),	// ITEM_METIN
-		0,										// ITEM_CONTAINER
-		sizeof(arSub12) / sizeof(arSub12[0]),	// ITEM_FISH
-		0,										// ITEM_ROD
-		sizeof(arSub14) / sizeof(arSub14[0]),	// ITEM_RESOURCE
-		0,										// ITEM_CAMPFIRE
-		sizeof(arSub16) / sizeof(arSub16[0]),	// ITEM_UNIQUE
-		0,										// ITEM_SKILLBOOK
-		sizeof(arSub18) / sizeof(arSub18[0]),	// ITEM_QUEST
-		0,										// ITEM_POLYMORPH
-		0,										// ITEM_TREASURE_BOX
-		0,										// ITEM_TREASURE_KEY
-		0,										// ITEM_SKILLFORGET
-		sizeof(arSub23) / sizeof(arSub23[0]),	// ITEM_GIFTBOX
-		0,										// ITEM_PICK
-		0,										// ITEM_HAIR
-		0,										// ITEM_TOTEM
-		0,										// ITEM_BLEND
-		sizeof(arSub28) / sizeof(arSub28[0]),	// ITEM_COSTUME
-		sizeof(arSub29) / sizeof(arSub29[0]),	// ITEM_DS
-		sizeof(arSub29) / sizeof(arSub29[0]),	// ITEM_SPECIAL_DS
-		sizeof(arSub31) / sizeof(arSub31[0]),	// ITEM_EXTRACT
-		0,										// ITEM_SECONDARY_COIN
-		0,										// ITEM_RING
-		0,										// ITEM_BELT
-		sizeof(arSub35) / sizeof(arSub35[0]),	// ITEM_PET
-#if defined(__MOVE_COSTUME_ATTR__)
-		sizeof(arSub36) / sizeof(arSub36[0]),	// ITEM_MEDIUM
+		0,										// 0
+		sizeof(arSub1) / sizeof(arSub1[0]),		// 1
+		sizeof(arSub2) / sizeof(arSub2[0]),		// 2
+		sizeof(arSub3) / sizeof(arSub3[0]),		// 3
+		sizeof(arSub4) / sizeof(arSub4[0]),		// 4
+		sizeof(arSub5) / sizeof(arSub5[0]),		// 5
+		sizeof(arSub6) / sizeof(arSub6[0]),		// 6
+		sizeof(arSub7) / sizeof(arSub7[0]),		// 7
+		sizeof(arSub8) / sizeof(arSub8[0]),		// 8
+		0,										// 9
+		sizeof(arSub10) / sizeof(arSub10[0]),	// 10
+		0,										// 11
+		sizeof(arSub12) / sizeof(arSub12[0]),	// 12
+		0,										// 13
+		sizeof(arSub14) / sizeof(arSub14[0]),	// 14
+		0,										// 15
+		sizeof(arSub16) / sizeof(arSub16[0]),	// 16
+		0,										// 17
+		sizeof(arSub18) / sizeof(arSub18[0]),	// 18
+		0,										// 19
+		0,										// 20
+		0,										// 21
+		0,										// 22
+		0,										// 23
+		0,										// 24
+		0,										// 25
+		0,										// 26
+		0,										// 27
+		sizeof(arSub28) / sizeof(arSub28[0]),	// 28
+		sizeof(arSub29) / sizeof(arSub29[0]),	// 29
+		sizeof(arSub29) / sizeof(arSub29[0]),	// 30
+		sizeof(arSub31) / sizeof(arSub31[0]),	// 31
+		0,										// 32
+		0,										// 33 
+		0,										// 34 Ʈ
+#if defined(__CHEQUE_SYSTEM__)
+		0,										// 35 won
 #endif
 #if defined(__GACHA_SYSTEM__)
-		sizeof(arSub37) / sizeof(arSub37[0]),	// ITEM_GACHA
+		0,										// 36 gacha
 #endif
-		sizeof(arSub38) / sizeof(arSub38[0]),	// ITEM_PASSIVE
-		sizeof(arSub39) / sizeof(arSub39[0]),	// ITEM_MERCENARY
-		sizeof(arSub40) / sizeof(arSub40[0]),	// ITEM_ALCHEMY
-//#if defined(__SOUL_SYSTEM__)
-		sizeof(arSub41) / sizeof(arSub41[0]),	// ITEM_SOUL
-//#endif
+		sizeof(arSub37) / sizeof(arSub37[0]),	// 37 gacha
+#if defined(__SOUL_SYSTEM__)
+		sizeof(arSub38) / sizeof(arSub38[0]),	// 38 soul
+#endif
+		sizeof(arSub39) / sizeof(arSub39[0]),	// 39 medium
+		0,										// 40 passive
+		sizeof(arSub41) / sizeof(arSub41[0])	// 41 mercenary
 	};
 
 	assert(_countof(arSubType) > type_value && "Subtype rule: Out of range!!");
@@ -590,17 +532,13 @@
 		"ANTI_REINFORCE",
 		"ANTI_ENCHANT",
 		"ANTI_ENERGY",
-//#if defined(__GROWTH_PET_SYSTEM__)
 		"ANTI_PETFEED",
-//#endif
 		"ANTI_APPLY",
 #if defined(__ACCE_COSTUME_SYSTEM__)
 		"ANTI_ACCE",
 #endif
-#if defined(__MAILBOX__)
 		"ANTI_MAIL",
-#endif
-		"ANTI_DESTROY" // Custom
+		"ANTI_DESTROY"
 	};
 
 	int retValue = 0;
@@ -641,8 +579,13 @@
 		"QUEST_USE",
 		"QUEST_USE_MULTIPLE",
 		"QUEST_GIVE",
+		"ITEM_QUEST",
 		"LOG",
-		"ITEM_APPLICABLE",
+		"STACKABLE",
+		"SLOW_QUERY",
+		"REFINEABLE",
+		"IRREMOVABLE",
+		"ITEM_APPLICABLE"
 	};
 
 	int retValue = 0;
@@ -670,24 +613,38 @@
 
 int get_Item_WearFlag_Value(string inputString)
 {
-	// @ EItemWearableFlag
 	string arWearrFlag[] = {
-		"WEAR_BODY",
-		"WEAR_HEAD",
-		"WEAR_FOOTS",
-		"WEAR_WRIST",
-		"WEAR_WEAPON",
-		"WEAR_NECK",
-		"WEAR_EAR",
-		"WEAR_UNIQUE",
-		"WEAR_SHIELD",
-		"WEAR_ARROW",
-		"WEAR_HAIR",
+		"WEAR_BODY",				// 0 @ EItemWearableFlag
+		"WEAR_HEAD",				// 1
+		"WEAR_FOOTS",				// 2
+		"WEAR_WRIST",				// 3
+		"WEAR_WEAPON",				// 4
+		"WEAR_NECK",				// 5
+		"WEAR_EAR",					// 6
+		"WEAR_UNIQUE",				// 7
+		"WEAR_SHIELD",				// 8
+		"WEAR_ARROW",				// 9
+		"WEAR_HAIR",				// 10
+		"WEAR_ABILITY",				// 11
+		"WEAR_COSTUME_BODY",		// 12
+		"WEAR_COSTUME_HAIR",		// 13
+#if defined(__MOUNT_COSTUME_SYSTEM__)
+		"WEAR_COSTUME_MOUNT",		// 14
+#endif
+#if defined(__ACCE_COSTUME_SYSTEM__)
+		"WEAR_COSTUME_ACCE",		// 15
+#endif
+#if defined(__WEAPON_COSTUME_SYSTEM__)
+		"WEAR_COSTUME_WEAPON",		// 16
+#endif
+#if defined(__AURA_COSTUME_SYSTEM__)
+		"WEAR_COSTUME_AURA",		// 17
+#endif
 #if defined(__PENDANT_SYSTEM__)
-		"WEAR_PENDANT",
+		"WEAR_PENDANT",				// 18
 #endif
 #if defined(__GLOVE_SYSTEM__)
-		"WEAR_GLOVE",
+		"WEAR_GLOVE",				// 19
 #endif
 	};
 
@@ -723,7 +680,7 @@
 		"SLEEP",
 		"SLOW",
 		"POISON",
-		"TERROR",
+		"TERROR"
 	};
 
 	int retValue = 0;
@@ -758,6 +715,7 @@
 		"DEX",
 		"INT",
 		"CON",
+		"PC_BANG",
 		"REAL_TIME",
 		"REAL_TIME_FIRST_USE",
 		"TIMER_BASED_ON_WEAR",
@@ -883,8 +841,16 @@
 		"APPLY_ATTBONUS_WOLFMAN",
 		"APPLY_RESIST_WOLFMAN",
 		"APPLY_RESIST_CLAW",
+#if defined(__MOUNT_COSTUME_SYSTEM__)
+		"APPLY_MOUNT",
+#endif
+#if defined(__ACCE_COSTUME_SYSTEM__)
 		"APPLY_ACCEDRAIN_RATE",
+#endif
+#if defined(__MAGIC_REDUCTION__)
 		"APPLY_RESIST_MAGIC_REDUCTION",
+#endif
+#if defined(__ELEMENT_SYSTEM__)
 		"APPLY_ENCHANT_ELECT",
 		"APPLY_ENCHANT_FIRE",
 		"APPLY_ENCHANT_ICE",
@@ -894,191 +860,25 @@
 		"APPLY_ATTBONUS_CZ",
 		"APPLY_ATTBONUS_INSECT",
 		"APPLY_ATTBONUS_DESERT",
-		"APPLY_ATTBONUS_SWORD",
-		"APPLY_ATTBONUS_TWOHAND",
-		"APPLY_ATTBONUS_DAGGER",
-		"APPLY_ATTBONUS_BELL",
-		"APPLY_ATTBONUS_FAN",
-		"APPLY_ATTBONUS_BOW",
-		"APPLY_ATTBONUS_CLAW",
+		"APPLY_RESIST_SWORD_REDUCTION",
+		"APPLY_RESIST_TWOHAND_REDUCTION",
+		"APPLY_RESIST_DAGGER_REDUCTION",
+		"APPLY_RESIST_BELL_REDUCTION",
+		"APPLY_RESIST_FAN_REDUCTION",
+		"APPLY_RESIST_BOW_REDUCTION",
+		"APPLY_RESIST_CLAW_REDUCTION",
 		"APPLY_RESIST_HUMAN",
-		"APPLY_RESIST_MOUNT_FALL",
-		"APPLY_RESIST_FIST",
-		"APPLY_MOUNT",
-		"APPLY_SKILL_DAMAGE_SAMYEON",
-		"APPLY_SKILL_DAMAGE_TANHWAN",
-		"APPLY_SKILL_DAMAGE_PALBANG",
-		"APPLY_SKILL_DAMAGE_GIGONGCHAM",
-		"APPLY_SKILL_DAMAGE_GYOKSAN",
-		"APPLY_SKILL_DAMAGE_GEOMPUNG",
-		"APPLY_SKILL_DAMAGE_AMSEOP",
-		"APPLY_SKILL_DAMAGE_GUNGSIN",
-		"APPLY_SKILL_DAMAGE_CHARYUN",
-		"APPLY_SKILL_DAMAGE_SANGONG",
-		"APPLY_SKILL_DAMAGE_YEONSA",
-		"APPLY_SKILL_DAMAGE_KWANKYEOK",
-		"APPLY_SKILL_DAMAGE_GIGUNG",
-		"APPLY_SKILL_DAMAGE_HWAJO",
-		"APPLY_SKILL_DAMAGE_SWAERYUNG",
-		"APPLY_SKILL_DAMAGE_YONGKWON",
-		"APPLY_SKILL_DAMAGE_PABEOB",
-		"APPLY_SKILL_DAMAGE_MARYUNG",
-		"APPLY_SKILL_DAMAGE_HWAYEOMPOK",
-		"APPLY_SKILL_DAMAGE_MAHWAN",
-		"APPLY_SKILL_DAMAGE_BIPABU",
-		"APPLY_SKILL_DAMAGE_YONGBI",
-		"APPLY_SKILL_DAMAGE_PAERYONG",
-		"APPLY_SKILL_DAMAGE_NOEJEON",
-		"APPLY_SKILL_DAMAGE_BYEURAK",
-		"APPLY_SKILL_DAMAGE_CHAIN",
-		"APPLY_SKILL_DAMAGE_CHAYEOL",
-		"APPLY_SKILL_DAMAGE_SALPOONG",
-		"APPLY_SKILL_DAMAGE_GONGDAB",
-		"APPLY_SKILL_DAMAGE_PASWAE",
-		"APPLY_NORMAL_HIT_DEFEND_BONUS_BOSS_OR_MORE",
-		"APPLY_SKILL_DEFEND_BONUS_BOSS_OR_MORE",
-		"APPLY_NORMAL_HIT_DAMAGE_BONUS_BOSS_OR_MORE",
-		"APPLY_SKILL_DAMAGE_BONUS_BOSS_OR_MORE",
-		"APPLY_HIT_BUFF_ENCHANT_FIRE",
-		"APPLY_HIT_BUFF_ENCHANT_ICE",
-		"APPLY_HIT_BUFF_ENCHANT_ELEC",
-		"APPLY_HIT_BUFF_ENCHANT_WIND",
-		"APPLY_HIT_BUFF_ENCHANT_DARK",
-		"APPLY_HIT_BUFF_ENCHANT_EARTH",
-		"APPLY_HIT_BUFF_RESIST_FIRE",
-		"APPLY_HIT_BUFF_RESIST_ICE",
-		"APPLY_HIT_BUFF_RESIST_ELEC",
-		"APPLY_HIT_BUFF_RESIST_WIND",
-		"APPLY_HIT_BUFF_RESIST_DARK",
-		"APPLY_HIT_BUFF_RESIST_EARTH",
-		"APPLY_USE_SKILL_CHEONGRANG_MOV_SPEED",
-		"APPLY_USE_SKILL_CHEONGRANG_CASTING_SPEED",
-		"APPLY_USE_SKILL_CHAYEOL_CRITICAL_PCT",
-		"APPLY_USE_SKILL_SANGONG_ATT_GRADE_BONUS",
-		"APPLY_USE_SKILL_GIGUNG_ATT_GRADE_BONUS",
-		"APPLY_USE_SKILL_JEOKRANG_DEF_BONUS",
-		"APPLY_USE_SKILL_GWIGEOM_DEF_BONUS",
-		"APPLY_USE_SKILL_TERROR_ATT_GRADE_BONUS",
-		"APPLY_USE_SKILL_MUYEONG_ATT_GRADE_BONUS",
-		"APPLY_USE_SKILL_MANASHILED_CASTING_SPEED",
-		"APPLY_USE_SKILL_HOSIN_DEF_BONUS",
-		"APPLY_USE_SKILL_GICHEON_ATT_GRADE_BONUS",
-		"APPLY_USE_SKILL_JEONGEOP_ATT_GRADE_BONUS",
-		"APPLY_USE_SKILL_JEUNGRYEOK_DEF_BONUS",
-		"APPLY_USE_SKILL_GIHYEOL_ATT_GRADE_BONUS",
-		"APPLY_USE_SKILL_CHUNKEON_CASTING_SPEED",
-		"APPLY_USE_SKILL_NOEGEOM_ATT_GRADE_BONUS",
-		"APPLY_SKILL_DURATION_INCREASE_EUNHYUNG",
-		"APPLY_SKILL_DURATION_INCREASE_GYEONGGONG",
-		"APPLY_SKILL_DURATION_INCREASE_GEOMKYUNG",
-		"APPLY_SKILL_DURATION_INCREASE_JEOKRANG",
-		"APPLY_USE_SKILL_PALBANG_HP_ABSORB",
-		"APPLY_USE_SKILL_AMSEOP_HP_ABSORB",
-		"APPLY_USE_SKILL_YEONSA_HP_ABSORB",
-		"APPLY_USE_SKILL_YONGBI_HP_ABSORB",
-		"APPLY_USE_SKILL_CHAIN_HP_ABSORB",
-		"APPLY_USE_SKILL_PASWAE_SP_ABSORB",
-		"APPLY_USE_SKILL_GIGONGCHAM_STUN",
-		"APPLY_USE_SKILL_CHARYUN_STUN",
-		"APPLY_USE_SKILL_PABEOB_STUN",
-		"APPLY_USE_SKILL_MAHWAN_STUN",
-		"APPLY_USE_SKILL_GONGDAB_STUN",
-		"APPLY_USE_SKILL_SAMYEON_STUN",
-		"APPLY_USE_SKILL_GYOKSAN_KNOCKBACK",
-		"APPLY_USE_SKILL_SEOMJEON_KNOCKBACK",
-		"APPLY_USE_SKILL_SWAERYUNG_KNOCKBACK",
-		"APPLY_USE_SKILL_HWAYEOMPOK_KNOCKBACK",
-		"APPLY_USE_SKILL_GONGDAB_KNOCKBACK",
-		"APPLY_USE_SKILL_KWANKYEOK_KNOCKBACK",
-		"APPLY_USE_SKILL_SAMYEON_NEXT_COOLTIME_DECREASE_10PER",
-		"APPLY_USE_SKILL_GEOMPUNG_NEXT_COOLTIME_DECREASE_10PER",
-		"APPLY_USE_SKILL_GUNGSIN_NEXT_COOLTIME_DECREASE_10PER",
-		"APPLY_USE_SKILL_KWANKYEOK_NEXT_COOLTIME_DECREASE_10PER",
-		"APPLY_USE_SKILL_YONGKWON_NEXT_COOLTIME_DECREASE_10PER",
-		"APPLY_USE_SKILL_MARYUNG_NEXT_COOLTIME_DECREASE_10PER",
-		"APPLY_USE_SKILL_BIPABU_NEXT_COOLTIME_DECREASE_10PER",
-		"APPLY_USE_SKILL_NOEJEON_NEXT_COOLTIME_DECREASE_10PER",
-		"APPLY_USE_SKILL_SALPOONG_NEXT_COOLTIME_DECREASE_10PER",
-		"APPLY_USE_SKILL_PASWAE_NEXT_COOLTIME_DECREASE_10PER",
+#endif
 		"APPLY_ATTBONUS_STONE",
-		"APPLY_DAMAGE_HP_RECOVERY",
-		"APPLY_DAMAGE_SP_RECOVERY",
-		"APPLY_ALIGNMENT_DAMAGE_BONUS",
-		"APPLY_NORMAL_DAMAGE_GUARD",
-		"APPLY_MORE_THEN_HP90_DAMAGE_REDUCE",
-		"APPLY_USE_SKILL_TUSOK_HP_ABSORB",
-		"APPLY_USE_SKILL_PAERYONG_HP_ABSORB",
-		"APPLY_USE_SKILL_BYEURAK_HP_ABSORB",
-		"APPLY_FIRST_ATTRIBUTE_BONUS",
-		"APPLY_SECOND_ATTRIBUTE_BONUS",
-		"APPLY_THIRD_ATTRIBUTE_BONUS",
-		"APPLY_FOURTH_ATTRIBUTE_BONUS",
-		"APPLY_FIFTH_ATTRIBUTE_BONUS",
-		"APPLY_USE_SKILL_SAMYEON_NEXT_COOLTIME_DECREASE_20PER",
-		"APPLY_USE_SKILL_GEOMPUNG_NEXT_COOLTIME_DECREASE_20PER",
-		"APPLY_USE_SKILL_GUNGSIN_NEXT_COOLTIME_DECREASE_20PER",
-		"APPLY_USE_SKILL_KWANKYEOK_NEXT_COOLTIME_DECREASE_20PER",
-		"APPLY_USE_SKILL_YONGKWON_NEXT_COOLTIME_DECREASE_20PER",
-		"APPLY_USE_SKILL_MARYUNG_NEXT_COOLTIME_DECREASE_20PER",
-		"APPLY_USE_SKILL_BIPABU_NEXT_COOLTIME_DECREASE_20PER",
-		"APPLY_USE_SKILL_NOEJEON_NEXT_COOLTIME_DECREASE_20PER",
-		"APPLY_USE_SKILL_SALPOONG_NEXT_COOLTIME_DECREASE_20PER",
-		"APPLY_USE_SKILL_PASWAE_NEXT_COOLTIME_DECREASE_20PER",
-		"APPLY_USE_SKILL_CHAYEOL_HP_ABSORB",
+#if defined(__CONQUEROR_LEVEL__)
 		"APPLY_SUNGMA_STR",
 		"APPLY_SUNGMA_HP",
 		"APPLY_SUNGMA_MOVE",
 		"APPLY_SUNGMA_IMMUNE",
-		"APPLY_HIT_PCT",
+#endif
+#if defined(__ITEM_APPLY_RANDOM__)
 		"APPLY_RANDOM",
-		"APPLY_ATTBONUS_PER_HUMAN",
-		"APPLY_ATTBONUS_PER_ANIMAL",
-		"APPLY_ATTBONUS_PER_ORC",
-		"APPLY_ATTBONUS_PER_MILGYO",
-		"APPLY_ATTBONUS_PER_UNDEAD",
-		"APPLY_ATTBONUS_PER_DEVIL",
-		"APPLY_ENCHANT_PER_ELECT",
-		"APPLY_ENCHANT_PER_FIRE",
-		"APPLY_ENCHANT_PER_ICE",
-		"APPLY_ENCHANT_PER_WIND",
-		"APPLY_ENCHANT_PER_EARTH",
-		"APPLY_ENCHANT_PER_DARK",
-		"APPLY_ATTBONUS_PER_CZ",
-		"APPLY_ATTBONUS_PER_INSECT",
-		"APPLY_ATTBONUS_PER_DESERT",
-		"APPLY_ATTBONUS_PER_STONE",
-		"APPLY_ATTBONUS_PER_MONSTER",
-		"APPLY_RESIST_PER_HUMAN",
-		"APPLY_RESIST_PER_ICE",
-		"APPLY_RESIST_PER_DARK",
-		"APPLY_RESIST_PER_EARTH",
-		"APPLY_RESIST_PER_FIRE",
-		"APPLY_RESIST_PER_ELEC",
-		"APPLY_RESIST_PER_MAGIC",
-		"APPLY_RESIST_PER_WIND",
-		"APPLY_HIT_BUFF_SUNGMA_STR",
-		"APPLY_HIT_BUFF_SUNGMA_MOVE",
-		"APPLY_HIT_BUFF_SUNGMA_HP",
-		"APPLY_HIT_BUFF_SUNGMA_IMMUNE",
-		"APPLY_MOUNT_MELEE_MAGIC_ATTBONUS_PER",
-		"APPLY_DISMOUNT_MOVE_SPEED_BONUS_PER",
-		"APPLY_HIT_AUTO_HP_RECOVERY",
-		"APPLY_HIT_AUTO_SP_RECOVERY",
-		"APPLY_USE_SKILL_COOLTIME_DECREASE_ALL",
-		"APPLY_HIT_STONE_ATTBONUS_STONE",
-		"APPLY_HIT_STONE_DEF_GRADE_BONUS",
-		"APPLY_KILL_BOSS_ITEM_BONUS",
-		"APPLY_MOB_HIT_MOB_AGGRESSIVE",
-		"APPLY_NO_DEATH_AND_HP_RECOVERY30",
-		"APPLY_AUTO_PICKUP",
-		"APPLY_MOUNT_NO_KNOCKBACK",
-		"APPLY_SUNGMA_PER_STR",
-		"APPLY_SUNGMA_PER_HP",
-		"APPLY_SUNGMA_PER_MOVE",
-		"APPLY_SUNGMA_PER_IMMUNE",
-		"APPLY_IMMUNE_POISON100",
-		"APPLY_IMMUNE_BLEEDING100",
-		"APPLY_MONSTER_DEFEND_BONUS",
+#endif
 	};
 
 	int retInt = -1;
@@ -1108,7 +908,7 @@
 		"KNIGHT",
 		"S_KNIGHT",
 		"BOSS",
-		"KING",
+		"KING"
 	};
 
 	int retInt = -1;
@@ -1142,10 +942,8 @@
 		"POLYMORPH_PC",
 		"HORSE",
 		"GOTO",
-		"PET",
 		"PET_PAY",
-		"SHOP",
-		"OBJECT",
+		"PET"
 	};
 
 	int retInt = -1;
@@ -1176,7 +974,7 @@
 		"POWER",
 		"TANKER",
 		"SUPER_POWER",
-		"SUPER_TANKER",
+		"SUPER_TANKER"
 	};
 
 	int retInt = -1;
@@ -1202,7 +1000,7 @@
 	string arSize[] = {
 		"SMALL",
 		"MEDIUM",
-		"BIG",
+		"BIG"
 	};
 
 	int retInt = 0;
@@ -1276,21 +1074,26 @@
 int get_Mob_RaceFlag_Value(string inputString)
 {
 	string arRaceFlag[] = {
-		"ANIMAL",
-		"UNDEAD",
-		"DEVIL",
-		"HUMAN",
-		"ORC",
-		"MILGYO",
-		"INSECT",
-		"DESERT",
-		"TREE",
-		"DECO",
-		"HIDE",
-		"ATT_CZ",
-		"AWEAKEN",
-		"SUNGMAHEE",
-		"OUTPOST",
+		"ANIMAL",		// 0
+		"UNDEAD",		// 1
+		"DEVIL",		// 2
+		"HUMAN",		// 3
+		"ORC",			// 4
+		"MILGYO",		// 5
+		"INSECT",		// 6
+		"FIRE",			// 7
+		"ICE",			// 8
+		"DESERT",		// 9
+		"TREE",			// 10
+		"ATT_ELEC",		// 11
+		"ATT_FIRE",		// 12
+		"ATT_ICE",		// 13
+		"ATT_WIND",		// 14
+		"ATT_EARTH",	// 15
+		"ATT_DARK",		// 16
+#if defined(__ELEMENT_SYSTEM__)
+		"ZODIAC",		// 17
+#endif
 	};
 
 	int retValue = 0;
@@ -1325,7 +1128,7 @@
 		"CURSE",
 		"POISON",
 		"TERROR",
-		"REFLECT",
+		"REFLECT"
 	};
 
 	int retValue = 0;
@@ -1356,7 +1159,6 @@
 bool Set_Proto_Mob_Table(TMobTable* mobTable, cCsvTable& csvTable, std::map<int, const char*>& nameMap)
 {
 	int col = 0;
-
 	str_to_number(mobTable->dwVnum, csvTable.AsStringByIndex(col++));
 	strlcpy(mobTable->szName, csvTable.AsStringByIndex(col++), sizeof(mobTable->szName));
 
@@ -1376,33 +1178,27 @@
 	// RANK
 	int rankValue = get_Mob_Rank_Value(csvTable.AsStringByIndex(col++));
 	mobTable->bRank = rankValue;
-
 	// TYPE
 	int typeValue = get_Mob_Type_Value(csvTable.AsStringByIndex(col++));
 	mobTable->bType = typeValue;
-
 	// BATTLE_TYPE
 	int battleTypeValue = get_Mob_BattleType_Value(csvTable.AsStringByIndex(col++));
 	mobTable->bBattleType = battleTypeValue;
 
 	str_to_number(mobTable->bLevel, csvTable.AsStringByIndex(col++));
-	str_to_number(mobTable->bScale, csvTable.AsStringByIndex(col++));
-
+	// SCALEPCT
+	col++;
 	// SIZE
 	int sizeValue = get_Mob_Size_Value(csvTable.AsStringByIndex(col++));
 	mobTable->bSize = sizeValue;
-
 	// AI_FLAG
 	int aiFlagValue = get_Mob_AIFlag_Value(csvTable.AsStringByIndex(col++));
 	mobTable->dwAIFlag = aiFlagValue;
-
 	// MOUNT_CAPACITY;
 	col++;
-
 	// RACE_FLAG
 	int raceFlagValue = get_Mob_RaceFlag_Value(csvTable.AsStringByIndex(col++));
 	mobTable->dwRaceFlag = raceFlagValue;
-
 	// IMMUNE_FLAG
 	int immuneFlagValue = get_Mob_ImmuneFlag_Value(csvTable.AsStringByIndex(col++));
 	mobTable->dwImmuneFlag = immuneFlagValue;
@@ -1417,10 +1213,6 @@
 	str_to_number(mobTable->bDex, csvTable.AsStringByIndex(col++));
 	str_to_number(mobTable->bCon, csvTable.AsStringByIndex(col++));
 	str_to_number(mobTable->bInt, csvTable.AsStringByIndex(col++));
-	str_to_number(mobTable->bSungMaStr, csvTable.AsStringByIndex(col++));
-	str_to_number(mobTable->bSungMaDex, csvTable.AsStringByIndex(col++));
-	str_to_number(mobTable->bSungMaCon, csvTable.AsStringByIndex(col++));
-	str_to_number(mobTable->bSungMaInt, csvTable.AsStringByIndex(col++));
 	str_to_number(mobTable->dwDamageRange[0], csvTable.AsStringByIndex(col++));
 	str_to_number(mobTable->dwDamageRange[1], csvTable.AsStringByIndex(col++));
 	str_to_number(mobTable->dwMaxHP, csvTable.AsStringByIndex(col++));
@@ -1429,15 +1221,14 @@
 	str_to_number(mobTable->dwGoldMin, csvTable.AsStringByIndex(col++));
 	str_to_number(mobTable->dwGoldMax, csvTable.AsStringByIndex(col++));
 	str_to_number(mobTable->dwExp, csvTable.AsStringByIndex(col++));
-	str_to_number(mobTable->dwSungMaExp, csvTable.AsStringByIndex(col++));
 	str_to_number(mobTable->wDef, csvTable.AsStringByIndex(col++));
 	str_to_number(mobTable->sAttackSpeed, csvTable.AsStringByIndex(col++));
 	str_to_number(mobTable->sMovingSpeed, csvTable.AsStringByIndex(col++));
-	str_to_number(mobTable->bAggressiveHPPct, csvTable.AsStringByIndex(col++));
+	str_to_number(mobTable->bAggresiveHPPct, csvTable.AsStringByIndex(col++));
 	str_to_number(mobTable->wAggressiveSight, csvTable.AsStringByIndex(col++));
 	str_to_number(mobTable->wAttackRange, csvTable.AsStringByIndex(col++));
 
-	str_to_number(mobTable->dwDropItemVnum, csvTable.AsStringByIndex(col++));
+	str_to_number(mobTable->dwDropItemVnum, csvTable.AsStringByIndex(col++)); // 32
 	str_to_number(mobTable->dwResurrectionVnum, csvTable.AsStringByIndex(col++));
 	for (int i = 0; i < MOB_ENCHANTS_MAX_NUM; ++i)
 		str_to_number(mobTable->cEnchants[i], csvTable.AsStringByIndex(col++));
@@ -1448,10 +1239,6 @@
 #if defined(__ELEMENT_SYSTEM__)
 	for (int i = 0; i < MOB_ELEMENT_MAX_NUM; ++i)
 		str_to_number(mobTable->cElements[i], csvTable.AsStringByIndex(col++));
-
-	str_to_number(mobTable->cResistDark, csvTable.AsStringByIndex(col++));
-	str_to_number(mobTable->cResistIce, csvTable.AsStringByIndex(col++));
-	str_to_number(mobTable->cResistEarth, csvTable.AsStringByIndex(col++));
 #endif
 
 	str_to_number(mobTable->fDamMultiply, csvTable.AsStringByIndex(col++));
@@ -1480,12 +1267,6 @@
 	str_to_number(mobTable->bDeathBlowPoint, csvTable.AsStringByIndex(col++));
 	str_to_number(mobTable->bRevivePoint, csvTable.AsStringByIndex(col++));
 
-	str_to_number(mobTable->bHealPoint, csvTable.AsStringByIndex(col++));
-	str_to_number(mobTable->bRAttSpeedPoint, csvTable.AsStringByIndex(col++));
-	str_to_number(mobTable->bRCastSpeedPoint, csvTable.AsStringByIndex(col++));
-	str_to_number(mobTable->bRHPRegenPoint, csvTable.AsStringByIndex(col++));
-	str_to_number(mobTable->fHitRange, csvTable.AsStringByIndex(col++));
-
 	sys_log(0, "MOB #%-5d %-24s level: %-3u rank: %u empire: %d", mobTable->dwVnum, mobTable->szLocaleName, mobTable->bLevel, mobTable->bRank, mobTable->bEmpire);
 
 	return true;
@@ -1493,6 +1274,100 @@
 
 bool Set_Proto_Item_Table(TItemTable* itemTable, cCsvTable& csvTable, std::map<int, const char*>& nameMap)
 {
+	int col = 0;
+
+#if defined(__ITEM_APPLY4__)
+	int dataArray[35];
+#else
+	int dataArray[33];
+#endif
+	for (int i = 0; i < sizeof(dataArray) / sizeof(dataArray[0]); i++)
+	{
+		int validCheck = 0;
+		if (i == 2)
+		{
+			dataArray[i] = get_Item_Type_Value(csvTable.AsStringByIndex(col));
+			validCheck = dataArray[i];
+		}
+		else if (i == 3)
+		{
+			dataArray[i] = get_Item_SubType_Value(dataArray[i - 1], csvTable.AsStringByIndex(col));
+			validCheck = dataArray[i];
+		}
+		else if (i == 5)
+		{
+			dataArray[i] = get_Item_AntiFlag_Value(csvTable.AsStringByIndex(col));
+			validCheck = dataArray[i];
+		}
+		else if (i == 6)
+		{
+			dataArray[i] = get_Item_Flag_Value(csvTable.AsStringByIndex(col));
+			validCheck = dataArray[i];
+		}
+		else if (i == 7)
+		{
+			dataArray[i] = get_Item_WearFlag_Value(csvTable.AsStringByIndex(col));
+			validCheck = dataArray[i];
+		}
+		else if (i == 8)
+		{
+			dataArray[i] = get_Item_Immune_Value(csvTable.AsStringByIndex(col));
+			validCheck = dataArray[i];
+		}
+		else if (i == 14)
+		{
+			dataArray[i] = get_Item_LimitType_Value(csvTable.AsStringByIndex(col));
+			validCheck = dataArray[i];
+		}
+		else if (i == 16)
+		{
+			dataArray[i] = get_Item_LimitType_Value(csvTable.AsStringByIndex(col));
+			validCheck = dataArray[i];
+		}
+		else if (i == 18)
+		{
+			dataArray[i] = get_Item_ApplyType_Value(csvTable.AsStringByIndex(col));
+			validCheck = dataArray[i];
+		}
+		else if (i == 20)
+		{
+			dataArray[i] = get_Item_ApplyType_Value(csvTable.AsStringByIndex(col));
+			validCheck = dataArray[i];
+		}
+		else if (i == 22)
+		{
+			dataArray[i] = get_Item_ApplyType_Value(csvTable.AsStringByIndex(col));
+			validCheck = dataArray[i];
+		}
+#if defined(__ITEM_APPLY4__)
+		else if (i == 24)
+		{
+			dataArray[i] = get_Item_ApplyType_Value(csvTable.AsStringByIndex(col));
+			validCheck = dataArray[i];
+		}
+#endif
+		else
+		{
+			str_to_number(dataArray[i], csvTable.AsStringByIndex(col));
+		}
+
+		if (validCheck == -1)
+		{
+			std::ostringstream dataStream;
+
+			for (int j = 0; j < i; ++j)
+				dataStream << dataArray[j] << ",";
+
+			// fprintf(stderr, "ItemProto Reading Failed : Invalid value.\n");
+			sys_err("ItemProto Reading Failed : Invalid value. (index: %d, col: %d, value: %s)", i, col, csvTable.AsStringByIndex(col));
+			sys_err("\t%d ~ %d Values: %s", 0, i, dataStream.str().c_str());
+
+			exit(0);
+		}
+
+		col = col + 1;
+	}
+
 	// vnum  vnum range б.
 	{
 		std::string s(csvTable.AsStringByIndex(0));
@@ -1500,12 +1375,7 @@
 		// vnum ʵ忡 '~' ٸ н
 		if (std::string::npos == pos)
 		{
-			itemTable->dwVnum = atoi(s.c_str());
-			if (0 == itemTable->dwVnum)
-			{
-				printf("INVALID VNUM %s\n", s.c_str());
-				return false;
-			}
+			itemTable->dwVnum = dataArray[0];
 			itemTable->dwVnumRange = 0;
 		}
 		else
@@ -1525,11 +1395,9 @@
 		}
 	}
 
-	int col = 1;
-
-	strlcpy(itemTable->szName, csvTable.AsStringByIndex(col++), sizeof(itemTable->szName));
+	strlcpy(itemTable->szName, csvTable.AsStringByIndex(1), sizeof(itemTable->szName));
 	//  ̸ ־ֱ.
-	std::map<int, const char*>::iterator it;
+	map<int, const char*>::iterator it;
 	it = nameMap.find(itemTable->dwVnum);
 	if (it != nameMap.end())
 	{
@@ -1540,27 +1408,27 @@
 	{
 		strlcpy(itemTable->szLocaleName, itemTable->szName, sizeof(itemTable->szLocaleName));
 	}
-
-	itemTable->bType = get_Item_Type_Value(csvTable.AsStringByIndex(col++));
-	itemTable->bSubType = get_Item_SubType_Value(itemTable->bType, csvTable.AsStringByIndex(col++));
-	itemTable->bSize = atoi(csvTable.AsStringByIndex(col++));
-	itemTable->ullAntiFlags = get_Item_AntiFlag_Value(csvTable.AsStringByIndex(col++));
-	itemTable->dwFlags = get_Item_Flag_Value(csvTable.AsStringByIndex(col++));
-	itemTable->dwWearFlags = get_Item_WearFlag_Value(csvTable.AsStringByIndex(col++));
-	itemTable->dwImmuneFlag = get_Item_Immune_Value(csvTable.AsStringByIndex(col++));
-	itemTable->dwShopBuyPrice = atoi(csvTable.AsStringByIndex(col++));
-	itemTable->dwShopSellPrice = atoi(csvTable.AsStringByIndex(col++));
-	itemTable->dwRefinedVnum = atoi(csvTable.AsStringByIndex(col++));
-	itemTable->wRefineSet = atoi(csvTable.AsStringByIndex(col++));
-	itemTable->dw67AttrMaterial = atoi(csvTable.AsStringByIndex(col++));
-	itemTable->bAlterToMagicItemPct = atoi(csvTable.AsStringByIndex(col++));
+	itemTable->bType = dataArray[2];
+	itemTable->bSubType = dataArray[3];
+	itemTable->bSize = dataArray[4];
+	itemTable->ullAntiFlags = dataArray[5];
+	itemTable->dwFlags = dataArray[6];
+	itemTable->dwWearFlags = dataArray[7];
+	itemTable->dwImmuneFlag = dataArray[8];
+	itemTable->dwGold = dataArray[9];
+	itemTable->dwShopBuyPrice = dataArray[10];
+	itemTable->dwRefinedVnum = dataArray[11];
+	itemTable->wRefineSet = dataArray[12];
+	itemTable->bAlterToMagicItemPct = dataArray[13];
 	itemTable->cLimitRealTimeFirstUseIndex = -1;
 	itemTable->cLimitTimerBasedOnWearIndex = -1;
 
-	for (int i = 0; i < ITEM_LIMIT_MAX_NUM; ++i)
+	int i;
+
+	for (i = 0; i < ITEM_LIMIT_MAX_NUM; ++i)
 	{
-		itemTable->aLimits[i].bType = get_Item_LimitType_Value(csvTable.AsStringByIndex(col++));
-		itemTable->aLimits[i].lValue = atoi(csvTable.AsStringByIndex(col++));
+		itemTable->aLimits[i].bType = dataArray[14 + i * 2];
+		itemTable->aLimits[i].lValue = dataArray[15 + i * 2];
 
 		if (LIMIT_REAL_TIME_START_FIRST_USE == itemTable->aLimits[i].bType)
 			itemTable->cLimitRealTimeFirstUseIndex = (char)i;
@@ -1569,22 +1437,30 @@
 			itemTable->cLimitTimerBasedOnWearIndex = (char)i;
 	}
 
-	for (int i = 0; i < ITEM_APPLY_MAX_NUM; ++i)
+	for (i = 0; i < ITEM_APPLY_MAX_NUM; ++i)
 	{
-		itemTable->aApplies[i].wType = get_Item_ApplyType_Value(csvTable.AsStringByIndex(col++));
-		itemTable->aApplies[i].lValue = atoi(csvTable.AsStringByIndex(col++));
+		itemTable->aApplies[i].bType = dataArray[18 + i * 2];
+		itemTable->aApplies[i].lValue = dataArray[19 + i * 2];
 	}
 
-	for (int i = 0; i < ITEM_VALUES_MAX_NUM; ++i)
-		itemTable->alValues[i] = atoi(csvTable.AsStringByIndex(col++));
-
-	itemTable->bSpecular = atoi(csvTable.AsStringByIndex(col++));
-	itemTable->bGainSocketPct = atoi(csvTable.AsStringByIndex(col++));
-	itemTable->sAddonType = atoi(csvTable.AsStringByIndex(col++));
+	for (i = 0; i < ITEM_VALUES_MAX_NUM; ++i)
+#if defined(__ITEM_APPLY4__)
+		itemTable->alValues[i] = dataArray[26 + i];
+#else
+		itemTable->alValues[i] = dataArray[24 + i];
+#endif
 
-	itemTable->bWeight = 0;
+	// column for 'Specular'
+#if defined(__ITEM_APPLY4__)
+	itemTable->bGainSocketPct = dataArray[33];
+	itemTable->sAddonType = dataArray[34];
+#else
+	itemTable->bGainSocketPct = dataArray[31];
+	itemTable->sAddonType = dataArray[32];
+#endif
 
-	sys_log(0, "ITEM #%-5d %-24s", itemTable->dwVnum, itemTable->szLocaleName);
+	// test
+	str_to_number(itemTable->bWeight, "0");
 
 	return true;
 }
diff -ruN baseline/server/server/home/metin2/Source/Server/db/src/QID.h final/server/server/home/metin2/Source/Server/db/src/QID.h
--- baseline/server/server/home/metin2/Source/Server/db/src/QID.h	2025-06-28 20:24:10.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/db/src/QID.h	2021-06-22 10:14:39.000000000 +0000
@@ -34,14 +34,18 @@
 	QID_ITEMPRICE_LOAD_FOR_UPDATE, ///< 23,  Ʈ    ε 
 	QID_ITEMPRICE_LOAD, ///< 24,   ε 
 	// END_OF_MYSHOP_PRICE_LIST
-#ifdef __GROWTH_PET_SYSTEM__
-	QID_GROWTH_PET,
-	QID_GROWTH_PET_SAVE,
-	QID_GROWTH_PET_DELETE,
+
+#if defined(__SKILL_COLOR_SYSTEM__)
+	QID_SKILL_COLOR,
+	QID_SKILL_COLOR_SAVE,
 #endif
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	QID_EXT_BATTLE_PASS,
+
+#ifdef __GROWTH_PET_SYSTEM__
+    QID_GROWTH_PET,
+    QID_GROWTH_PET_SAVE,
+    QID_GROWTH_PET_DELETE,
 #endif
+
 };
 
 #endif
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/Makefile final/server/server/home/metin2/Source/Server/game/src/Makefile
--- baseline/server/server/home/metin2/Source/Server/game/src/Makefile	2025-06-28 22:27:22.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/Makefile	2022-04-27 12:42:54.000000000 +0000
@@ -1,120 +1,148 @@
-CC = clang++15
-CFLAGS = -m32 -w -g -Wall -O2 -pipe -fexceptions -D_THREAD_SAFE -DNDEBUG
-CXXFLAGS = -std=c++20 -Wno-invalid-source-encoding -Wno-unused-private-field -Wno-unknown-pragmas -Wno-format-security
-
-BSD_VERSION = $(shell uname -v 2>&1 | cut -d' ' -f2 | cut -d'.' -f1)
-PLATFORM = $(shell file /bin/ls | cut -d' ' -f3 | cut -d'-' -f1)
-
-BINDIR = ..
-BIN = $(BINDIR)/game
-
-INCDIR =
-LIBDIR =
-LIBS = -pthread -lm -lmd
-
-OBJDIR = .obj
-
-$(shell if [ ! -d $(OBJDIR) ]; then mkdir $(OBJDIR); fi)
-
-# External
-INCDIR += -I../../../External/include
-LIBDIR += -L../../../External/library
-
-# DevIL
-INCDIR += -I../../../External/include/devil/
-LIBS += -lIL -lpng -ltiff -lmng -llcms -ljpeg
-
-# MySQL
-ifeq ($(BSD_VERSION), 14)
-INCDIR += -I../../libmysql/8.0.33/14.0
-LIBDIR += -L../../libmysql/8.0.33/14.0
-else ifeq ($(BSD_VERSION), 13)
-INCDIR += -I../../libmysql/8.0.33/13.0
-LIBDIR += -L../../libmysql/8.0.33/13.0
-else
-INCDIR += -I../../libmysql/8.0.33
-LIBDIR += -L../../libmysql/8.0.33
-endif
-LIBS += -lmysqlclient -lz -lzstd
-
-# OpenSSL, CryptoPP
-LIBS += ../../../External/library/libcryptopp.a
-LIBS += -lssl -lcrypto
-
-# Project Library
-LIBDIR += -L../../libthecore/lib
-LIBS += -lthecore
-LIBDIR += -L../../libpoly
-LIBS += -lpoly
-LIBDIR += -L../../libsql
-LIBS += -lsql
-LIBDIR += -L../../libgame/lib
-LIBS += -lgame
-INCDIR += -I../../liblua/include
-LIBDIR += -L../../liblua/lib
-LIBS += -llua -llualib
-INCDIR += -I../../libserverkey
-LIBDIR += -L../../libserverkey
-LIBS += -lserverkey
-
-TARGET = $(BIN)
-
-CFILE = minilzo.c
-
-CPPFILE = growth_pet.cpp battlepass_manager.cpp affect.cpp ani.cpp arena.cpp auth_brazil.cpp banword.cpp battle.cpp BattleArena.cpp blend_item.cpp block_country.cpp \
-	BlueDragon.cpp BlueDragon_Binder.cpp buff_on_attributes.cpp buffer_manager.cpp building.cpp castle.cpp changelook.cpp char.cpp \
-	char_acce.cpp char_affect.cpp char_aura.cpp char_battle.cpp char_change_empire.cpp char_dragonsoul.cpp char_horse.cpp char_item.cpp \
-	char_manager.cpp char_quickslot.cpp char_resist.cpp char_skill.cpp char_state.cpp cipher.cpp ClientPackageCryptInfo.cpp cmd.cpp cmd_emotion.cpp \
-	cmd_general.cpp cmd_gm.cpp cmd_oxevent.cpp config.cpp constants.cpp crc32.cpp CsvReader.cpp cube.cpp dawnmist_dungeon.cpp db.cpp desc.cpp \
-	desc_client.cpp desc_manager.cpp desc_p2p.cpp dev_log.cpp dragon_soul_table.cpp DragonLair.cpp DragonSoul.cpp dungeon.cpp empire_text_convert.cpp \
-	entity.cpp entity_view.cpp event.cpp event_queue.cpp exchange.cpp file_loader.cpp FileMonitor_FreeBSD.cpp fishing.cpp FSM.cpp GemShop.cpp gm.cpp \
-	group_text_parse_tree.cpp guild.cpp guild_manager.cpp guild_war.cpp horse_rider.cpp horsename_manager.cpp input.cpp input_auth.cpp input_db.cpp \
-	input_login.cpp input_main.cpp input_p2p.cpp input_udp.cpp ip_ban.cpp item.cpp item_addon.cpp item_apply_random_table.cpp item_attribute.cpp \
-	item_manager.cpp item_manager_idrange.cpp item_manager_read_tables.cpp locale.cpp locale_service.cpp log.cpp login_data.cpp LootFilter.cpp \
-	lzo_manager.cpp MailBox.cpp map_location.cpp MarkConvert.cpp MarkImage.cpp MarkManager.cpp marriage.cpp messenger_manager.cpp ingame_event_manager.cpp \
-	minigame_catchking.cpp minigame_rumi.cpp minigame_yutnori.cpp mining.cpp mob_manager.cpp monarch.cpp motion.cpp mt_thunder_dungeon.cpp over9refine.cpp OXEvent.cpp \
-	p2p.cpp packet_info.cpp panama.cpp party.cpp pcbang.cpp PetSystem.cpp polymorph.cpp priv_manager.cpp pvp.cpp questevent.cpp questlua.cpp \
-	questlua_affect.cpp questlua_arena.cpp questlua_attr67add.cpp questlua_ba.cpp questlua_building.cpp questlua_danceevent.cpp questlua_dragonlair.cpp \
-	questlua_dragonsoul.cpp questlua_dungeon.cpp questlua_forked.cpp questlua_game.cpp questlua_global.cpp questlua_guild.cpp questlua_horse.cpp \
-	questlua_item.cpp questlua_marriage.cpp questlua_mgmt.cpp questlua_monarch.cpp questlua_npc.cpp questlua_oxevent.cpp questlua_party.cpp questlua_pc.cpp \
-	questlua_pet.cpp questlua_quest.cpp questlua_defense_wave.cpp questlua_target.cpp questmanager.cpp questnpc.cpp questpc.cpp Ranking.cpp refine.cpp \
-	regen.cpp safebox.cpp sectree.cpp sectree_manager.cpp sequence.cpp defense_wave.cpp shop.cpp shop_manager.cpp shopEx.cpp skill.cpp skill_power.cpp \
-	start_position.cpp target.cpp text_file_loader.cpp threeway_war.cpp TrafficProfiler.cpp trigger.cpp utils.cpp vector.cpp war_map.cpp wedding.cpp xmas_event.cpp \
-	guild_dragonlair.cpp questlua_guild_dragonlair.cpp minigame_roulette.cpp flower_event.cpp questlua_snakelair.cpp SnakeLair.cpp \
-	ShopSearchManager.cpp OfflineShop.cpp
-
-COBJS = $(CFILE:%.c=$(OBJDIR)/%.o)
-CPPOBJS = $(CPPFILE:%.cpp=$(OBJDIR)/%.o)
-
-MAINOBJ = $(OBJDIR)/main.o
-MAINCPP = main.cpp
-
-default: $(TARGET)
-
-$(TARGET): $(CPPOBJS) $(COBJS) $(MAINOBJ)
-	@echo "Linking $(TARGET)"
-	@$(CC) $(CFLAGS) $(CXXFLAGS) $(LIBDIR) $(COBJS) $(CPPOBJS) $(MAINOBJ) $(LIBS) -o $(TARGET)
-
-$(OBJDIR)/minilzo.o: minilzo.c
-	@echo "Compiling $<"
-	@$(CC) $(CFLAGS) $(CXXFLAGS) $(INCDIR) -c $< -o $@
-
-$(OBJDIR)/%.o: %.cpp
-	@echo "Compiling $<"
-	@$(CC) $(CFLAGS) $(CXXFLAGS) $(INCDIR) -c $< -o $@
-
-limit_time:
-	@echo update limit time
-	@python update_limit_time.py
-
-clean:
-	@rm -f $(COBJS) $(CPPOBJS)
-	@rm -f $(BINDIR)/game_r* $(BINDIR)/conv
-
-tag:
-	ctags *.cpp *.h *.c
-
-dep:
-	makedepend -f Depend $(INCDIR) -I/usr/include/c++/3.3 -I/usr/include/c++/4.2 -p$(OBJDIR)/ $(CPPFILE) $(CFILE) $(MAINCPP) 2> /dev/null > Depend
-
-sinclude Depend
+MAKE = gmake
+CC = clang++90
+
+INCDIR =
+LIBDIR =
+BINDIR = ..
+OBJDIR = .obj
+
+PLATFORM = $(shell file /bin/ls | cut -d' ' -f3 | cut -d'-' -f1)
+GCC_VERSION = $(shell $(CC) --version 2>&1 | grep "(GCC)" | cut -d' ' -f3 | cut -d'.' -f1)
+BSD_VERSION = $(shell uname -v 2>&1 | cut -d' ' -f2 | cut -d'.' -f1)
+VERSION = $(shell cat ../REVISION)
+REVISION = $(shell echo $$(($(VERSION)+1)))
+
+$(shell if [ ! -d $(OBJDIR) ]; then mkdir $(OBJDIR); fi)
+
+# Standard Setting
+LIBS = -lm -lmd
+CFLAGS = -m32 -w -g -Wall -O2 -pipe -fexceptions -fno-strict-aliasing -pthread -D_THREAD_SAFE -DNDEBUG
+CFLAGS += -Wno-invalid-source-encoding
+
+# Stack protector
+CFLAGS += -fstack-protector-all
+
+CXXFLAGS += -std=c++2a
+
+INCDIR += -I/usr/local/include
+LIBDIR += -I/usr/local/lib
+
+# External
+INCDIR += -I../../../External/include
+LIBDIR += -L../../../External/library
+ifeq ($(BSD_VERSION), 12)
+LIBDIR += -L../../../External/library/12.0/
+else
+LIBDIR += -L../../../External/library/11.0/
+endif
+
+# Boost
+INCDIR += -I../../../External/include/boost
+
+# DevIL
+INCDIR += -I../../../External/include/devil/IL
+LIBS += -lIL -lpng -ltiff -lmng -llcms -ljpeg
+# LIBS += -ljasper -ljbig
+#LIBS += -llzma
+LIBS += /usr/lib/liblzma.a
+
+# CryptoPP
+LIBS += ../../../External/library/libcryptopp.a
+
+# MySQL
+ifeq ($(PLATFORM), 64)
+LIBS += -lmysqlclient -lz -lzstd
+else
+INCDIR += -I/usr/local/include/mysql
+LIBS += /usr/local/lib/mysql/libmysqlclient.a /usr/lib/libz.a /usr/local/lib/libzstd.a
+endif
+
+# OpenSSL
+INCDIR += -I/usr/include
+LIBS += -lssl -lcrypto
+# LIBS += /usr/lib/libssl.a
+
+# Project Library
+LIBDIR += -L../../libosp/
+LIBS += -losp
+
+INCDIR += -I../../liblua/include
+INCDIR += -I../../libserverkey
+LIBDIR += -L../../libthecore/lib -L../../libpoly -L../../libsql -L../../libgame/lib -L../../liblua/lib -L../../libserverkey
+
+LIBS += -lthecore -lpoly -llua -llualib -lsql -lgame -lserverkey
+
+TARGET = $(BINDIR)/game_r$(REVISION)_$(PLATFORM)
+
+CFILE = minilzo.c
+
+CPPFILE = BattleArena.cpp FSM.cpp MarkConvert.cpp MarkImage.cpp MarkManager.cpp OXEvent.cpp TrafficProfiler.cpp ani.cpp\
+	arena.cpp banword.cpp battle.cpp blend_item.cpp block_country.cpp buffer_manager.cpp building.cpp castle.cpp\
+	char.cpp char_affect.cpp char_battle.cpp char_change_empire.cpp char_horse.cpp char_item.cpp char_cards.cpp char_manager.cpp\
+	char_quickslot.cpp char_resist.cpp char_skill.cpp char_state.cpp char_gem.cpp PetSystem.cpp cmd.cpp cmd_emotion.cpp cmd_general.cpp\
+	cmd_gm.cpp cmd_oxevent.cpp config.cpp constants.cpp crc32.cpp cube.cpp db.cpp desc.cpp\
+	desc_client.cpp desc_manager.cpp desc_p2p.cpp dev_log.cpp dungeon.cpp empire_text_convert.cpp entity.cpp\
+	entity_view.cpp event.cpp event_queue.cpp exchange.cpp file_loader.cpp fishing.cpp gm.cpp guild.cpp\
+	guild_manager.cpp guild_war.cpp horse_rider.cpp horsename_manager.cpp input.cpp input_auth.cpp input_db.cpp\
+	input_login.cpp input_main.cpp input_p2p.cpp ip_ban.cpp\
+	item.cpp item_addon.cpp item_attribute.cpp item_manager.cpp item_manager_idrange.cpp locale.cpp\
+	locale_service.cpp log.cpp login_data.cpp lzo_manager.cpp marriage.cpp\
+	messenger_manager.cpp mining.cpp mob_manager.cpp monarch.cpp motion.cpp over9refine.cpp p2p.cpp packet_info.cpp\
+	party.cpp pcbang.cpp polymorph.cpp priv_manager.cpp pvp.cpp\
+	questevent.cpp questlua.cpp questlua_affect.cpp questlua_arena.cpp questlua_ba.cpp questlua_building.cpp\
+	questlua_danceevent.cpp questlua_dungeon.cpp questlua_forked.cpp questlua_game.cpp questlua_global.cpp\
+	questlua_guild.cpp questlua_horse.cpp questlua_pet.cpp questlua_item.cpp questlua_marriage.cpp questlua_mgmt.cpp\
+	questlua_monarch.cpp questlua_npc.cpp questlua_oxevent.cpp questlua_party.cpp questlua_pc.cpp\
+	questlua_quest.cpp questlua_target.cpp questmanager.cpp questnpc.cpp questpc.cpp\
+	refine.cpp regen.cpp safebox.cpp sectree.cpp sectree_manager.cpp sequence.cpp shop.cpp\
+	skill.cpp start_position.cpp target.cpp text_file_loader.cpp trigger.cpp utils.cpp vector.cpp war_map.cpp\
+	wedding.cpp xmas_event.cpp version.cpp panama.cpp threeway_war.cpp map_location.cpp auth_brazil.cpp\
+	BlueDragon.cpp BlueDragon_Binder.cpp DragonLair.cpp questlua_dragonlair.cpp\
+	skill_power.cpp affect.cpp SpeedServer.cpp questlua_speedserver.cpp\
+	FileMonitor_FreeBSD.cpp ClientPackageCryptInfo.cpp cipher.cpp\
+	buff_on_attributes.cpp dragon_soul_table.cpp DragonSoul.cpp\
+	group_text_parse_tree.cpp char_dragonsoul.cpp questlua_dragonsoul.cpp\
+	shop_manager.cpp shopEx.cpp item_manager_read_tables.cpp MeleyLair.cpp questlua_meleylair.cpp\
+	TempleOchao.cpp questlua_templeochao.cpp minigame.cpp minigame_catch_king.cpp CsvReader.cpp\
+	MailBox.cpp item_apply_random_table.cpp char_aura.cpp growth_pet.cpp
+
+COBJS = $(CFILE:%.c=$(OBJDIR)/%.o)
+CPPOBJS = $(CPPFILE:%.cpp=$(OBJDIR)/%.o)
+
+MAINOBJ = $(OBJDIR)/main.o
+MAINCPP = main.cpp
+
+default: $(TARGET)
+
+$(OBJDIR)/minilzo.o: minilzo.c
+	@$(CC) $(CFLAGS) $(CXXFLAGS) $(INCDIR) -c $< -o $@
+	@echo compiling $<
+
+$(OBJDIR)/version.o: version.cpp
+	@$(CC) $(CFLAGS) $(CXXFLAGS) -D__REVISION__="$(REVISION)" -c $< -o $@
+	@echo compiling $<
+
+$(OBJDIR)/%.o: %.cpp
+	@echo compiling $<
+	@$(CC) $(CFLAGS) $(CXXFLAGS) $(INCDIR) -c $< -o $@
+
+limit_time:
+	@echo update limit time
+	@python update_limit_time.py
+
+$(TARGET): $(CPPOBJS) $(COBJS) $(MAINOBJ)
+	@echo linking $(TARGET)....
+	@$(CC) $(CFLAGS) $(CXXFLAGS) $(LIBDIR) $(COBJS) $(CPPOBJS) $(MAINOBJ) $(LIBS) -o $(TARGET)
+	@expr $(REVISION) > ../REVISION
+
+clean:
+	@rm -f $(COBJS) $(CPPOBJS)
+	@rm -f $(BINDIR)/game_r* $(BINDIR)/conv
+
+tag:
+	ctags *.cpp *.h *.c
+
+dep:
+	makedepend -f Depend $(INCDIR) -I/usr/include/c++/3.3 -I/usr/include/c++/4.2 -p$(OBJDIR)/ $(CPPFILE) $(CFILE) $(MAINCPP) 2> /dev/null > Depend
+
+sinclude Depend
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/affect.h final/server/server/home/metin2/Source/Server/game/src/affect.h
--- baseline/server/server/home/metin2/Source/Server/game/src/affect.h	2025-06-28 20:24:50.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/affect.h	2022-04-27 10:08:42.000000000 +0000
@@ -5,18 +5,11 @@
 {
 public:
 	DWORD dwType;
-	POINT_TYPE wApplyOn;
-	POINT_VALUE lApplyValue;
+	BYTE bApplyOn;
+	long lApplyValue;
 	DWORD dwFlag;
 	long lDuration;
 	long lSPCost;
-#if defined(__AFFECT_RENEWAL__)
-	bool bRealTime;
-	bool bUpdate;
-#endif
-#if defined(__9TH_SKILL__)
-	long lValue;
-#endif
 
 	static CAffect* Acquire();
 	static void Release(CAffect* p);
@@ -26,70 +19,41 @@
 {
 	AFFECT_NONE,
 
-	//AFFECT_GUILD_SKILL_BLOOD = 152,
-	//AFFECT_GUILD_SKILL_BLESS = 153,
-	//AFFECT_GUILD_SKILL_SEONGHWI = 154,
-	//AFFECT_GUILD_SKILL_ACCEL = 155,
-	//AFFECT_GUILD_SKILL_BUNNO = 156,
-	//AFFECT_GUILD_SKILL_JUMUN = 157,
-
-	//AFFECT_SKILL_9_FINISH = 176,
-	//AFFECT_SKILL_9_ILGWANGPYO = 177,
-	//AFFECT_SKILL_9_PUNGLOEPO = 178,
-	//AFFECT_SKILL_9_GEOMAGGWI = 179,
-	//AFFECT_SKILL_9_MABEOBAGGWI = 180,
-	//AFFECT_SKILL_9_METEO = 181,
-#if defined(__9TH_SKILL__)
-	AFFECT_SKILL_9_CHEONUN = 182,
-#endif
-	//AFFECT_SKILL_9_ILIPUNGU = 183,
-
 	AFFECT_MOV_SPEED = 200,
-	AFFECT_ATT_SPEED,
-	AFFECT_ATT_GRADE,
-	AFFECT_INVISIBILITY,
-	AFFECT_STR,
-	AFFECT_DEX,
-	AFFECT_CON,
-	AFFECT_INT,
-	AFFECT_FISH_MIND_PILL,
-
-	AFFECT_POISON,
-	AFFECT_STUN,
-	AFFECT_SLOW,
-	AFFECT_DUNGEON_READY,
-	AFFECT_DUNGEON_UNIQUE,
-
-	AFFECT_BUILDING,
-	AFFECT_REVIVE_INVISIBLE,
-	AFFECT_FIRE,
-	AFFECT_CAST_SPEED,
-	AFFECT_HP_RECOVER_CONTINUE,
-	AFFECT_SP_RECOVER_CONTINUE,
-
-	AFFECT_POLYMORPH,
-	AFFECT_MOUNT,
-
-	AFFECT_WAR_FLAG,
-
-	AFFECT_BLOCK_CHAT,
-	AFFECT_CHINA_FIREWORK,
-
-	AFFECT_BOW_DISTANCE,
-	AFFECT_DEF_GRADE,
-
-	AFFECT_BLEEDING,
-
-	//AFFECT_SKILL_MONSTER_WIDE_AREA_DAMAGE_SUNGMA_STR = 274,
-	//AFFECT_SKILL_MONSTER_ATT_GRADE_DOWN = 279,
-	//AFFECT_SKILL_POSION_DAMAGE_SUNGMA_MOVE = 280,
-	//AFFECT_SKILL_CRUSH_DAMAGE_SUNGMA_STR = 281,
+	AFFECT_ATT_SPEED, // 201
+	AFFECT_ATT_GRADE, // 202
+	AFFECT_INVISIBILITY, // 203
+	AFFECT_STR, // 204
+	AFFECT_DEX, // 205
+	AFFECT_CON, // 206
+	AFFECT_INT, // 207
+	AFFECT_FISH_MIND_PILL, // 208
+
+	AFFECT_POISON, // 209
+	AFFECT_STUN, // 210
+	AFFECT_SLOW, // 211
+	AFFECT_DUNGEON_READY, // 212
+	AFFECT_DUNGEON_UNIQUE, // 213
+
+	AFFECT_BUILDING, // 214
+	AFFECT_REVIVE_INVISIBLE, // 215
+	AFFECT_FIRE, // 216
+	AFFECT_CAST_SPEED, // 217
+	AFFECT_HP_RECOVER_CONTINUE, // 218
+	AFFECT_SP_RECOVER_CONTINUE, // 219
+
+	AFFECT_POLYMORPH, // 220
+	AFFECT_MOUNT, // 221
+
+	AFFECT_WAR_FLAG, // 222
 
-	AFFECT_RAMADAN_ABILITY = 300,
-	AFFECT_RAMADAN_RING = 301, // 󸶴 ̺Ʈ Ư ʽ´   
+	AFFECT_BLOCK_CHAT, // 223
+	AFFECT_CHINA_FIREWORK, // 224
 
-	AFFECT_NOG_ABILITY = 302,
-	AFFECT_HOLLY_STONE_POWER = 303,
+	AFFECT_BOW_DISTANCE, // 225
+	AFFECT_DEF_GRADE, // 226
+
+	AFFECT_BLEEDING, // 227
 
 	AFFECT_PREMIUM_START = 500,
 	AFFECT_EXP_BONUS = 500, //  
@@ -99,7 +63,7 @@
 	AFFECT_FISH_MIND = 504, // PREMIUM_FISH_MIND,
 	AFFECT_MARRIAGE_FAST = 505, //  
 	AFFECT_GOLD_BONUS = 506, //  Ȯ 50%
-	AFFECT_AUTO_USE = 507, // ڵ 
+	//AFFECT_NONE = 507,
 #if defined(__CONQUEROR_LEVEL__)
 	AFFECT_SUNGMA_BONUS = 508,
 #endif
@@ -111,161 +75,86 @@
 	AFFECT_SKILL_NO_BOOK_DELAY = 513, // ־ȼ
 
 	AFFECT_HAIR = 514, //  ȿ
-	AFFECT_COLLECT = 515, // Ʈ 
-
+	AFFECT_COLLECT = 515, //Ʈ 
 	AFFECT_EXP_BONUS_EURO_FREE = 516, //   (  14   ⺻ ȿ)
 	AFFECT_EXP_BONUS_EURO_FREE_UNDER_15 = 517,
 	AFFECT_UNIQUE_ABILITY = 518,
 
-	AFFECT_BLEND,
+	AFFECT_CUBE_1, // 519
+	AFFECT_CUBE_2, // 520
+	AFFECT_CUBE_3, // 521
+	AFFECT_CUBE_4, // 522
+	AFFECT_CUBE_5, // 523
+	AFFECT_CUBE_6, // 524
+	AFFECT_CUBE_7, // 525
+	AFFECT_CUBE_8, // 526
+	AFFECT_CUBE_9, // 527
+	AFFECT_CUBE_10, // 528
+	AFFECT_CUBE_11, // 529
+	AFFECT_CUBE_12, // 530
+
+	AFFECT_BLEND, // 531
 
-	AFFECT_HORSE_NAME,
-	AFFECT_MOUNT_BONUS,
+	AFFECT_HORSE_NAME, // 532
+	AFFECT_MOUNT_BONUS, // 533
 
 	AFFECT_AUTO_HP_RECOVERY = 534,
 	AFFECT_AUTO_SP_RECOVERY = 535,
-
-#if defined(__LOOT_FILTER_SYSTEM__) && defined(__PREMIUM_LOOT_FILTER__)
-	AFFECT_LOOTING_SYSTEM = 537,
+	
+#ifdef __GROWTH_PET_SYSTEM__
+	AFFECT_GROWTH_PET,
 #endif
 
-	//AFFECT_UNKNOWN_538,
-	//AFFECT_UNKNOWN_539,
+	//NEW_AFFECT_PREMIUM_PRIVATE_SHOP = 536,
+	//AFFECT_NONE = 537,
+	//AFFECT_NONE = 538,
+	//AFFECT_NONE = 539,
 
 	AFFECT_DRAGON_SOUL_QUALIFIED = 540,
 	AFFECT_DRAGON_SOUL_DECK_0 = 541,
 	AFFECT_DRAGON_SOUL_DECK_1 = 542,
-
-	//AFFECT_PVP_EXPBONUS = 543,
-	//AFFECT_IMPOSSIBLE_ATTACK = 544,
-	//AFFECT_PVP_ENTER = 545,
-
-#ifdef __GROWTH_PET_SYSTEM__
-	AFFECT_GROWTH_PET = 545,
-#endif
-
-#if defined(__SOUL_SYSTEM__)
-	AFFECT_SOUL = 546,
-#endif
-#ifdef __OFFLINE_SHOP__
-	AFFECT_OFFLINE_SHOP_DECORATION = 547,
+#if defined(__DS_SET__)
+	NEW_AFFECT_DS_SET = 543,
 #endif
 
-	//AFFECT_UNKNOWN_549,
+	//NEW_AFFECT_IMPOSSIBLE_ATTACK = 544,
+	//NEW_AFFECT_PVP_ENTER = 545,
 
-#if defined(__SET_ITEM__)
-	AFFECT_SET_ITEM = 550,
-#endif
-	//AFFECT_EXP_BONUS_EVENT = 551,
-	//AFFECT_ATT_SPEED_SLOW = 552,
-	//AFFECT_PEPSI_EVENT = 553,
-	//AFFECT_SUMMER_EVENT = 554,
-
-	//AFFECT_BATTLE_FIELD = 555,
-	//AFFECT_BATTLE_POTION = 556,
-	//AFFECT_BATTLE_RANK = 557,
-
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-	AFFECT_RED_DRAGONLAIR_STONE = 558,
-#endif
-	//AFFECT_UNKNOWN_559,
+	//NEW_AFFECT_SET_ITEM = 550,
+	//NEW_AFFECT_EXP_BONUS_EVENT = 552,
+	//NEW_AFFECT_PEPSI_EVENT = 553,
 
-	//AFFECT_LUCKEY_EVENT_BUFF = 560,
-	AFFECT_MOUNT_FALL = 561,
-	//AFFECT_NO_RECOVERY = 562,
-	//AFFECT_REDUCE_CAST_SPEED = 563,
-	//AFFECT_UNKNOWN_564,
-
-	//AFFECT_ATT_GRADE_DOWN = 565,
-	//AFFECT_DEF_GRADE_DOWN = 566,
-
-	//AFFECT_CRITICAL_PCT_DOWN = 567,
-	//AFFECT_CZ_UNLIMIT_ENTER = 568,
-	//AFFECT_UNKNOWN_569,
-#if defined(__FLOWER_EVENT__)
-	AFFECT_FLOWER_EVENT = 570,
-#endif
-#if defined(__DS_SET__)
-	AFFECT_DS_SET = 571,
-#endif
-	AFFECT_RESEARCHER_ELIXIR = 572,
-#if defined(__DEFENSE_WAVE__)
-	AFFECT_DEFENSEWAVE_LASER = 573,
-#endif
+	//NEW_AFFECT_BATTLE_FIELD = 555,
+	//NEW_AFFECT_BATTLE_POTION = 556,
+	//NEW_AFFECT_BATTLE_RANK = 557,
 
-	//AFFECT_NO_DEATH_PENALTY_PLUS = 574,
-#if defined(__YUTNORI_EVENT_FLAG_RENEWAL__)
-	AFFECT_HALLOWEEN_EVENT = 575,
-#endif
-	//AFFECT_UNKNOWN_576,
-#if defined(__FISHING_GAME__)
-	AFFECT_FISHING_GOLD_TUNA = 577,
-	AFFECT_FISHING_MOVE_SPEED_DOWN = 578,
-#endif
-	//AFFECT_UNKNOWN_579,
-	AFFECT_SAFE_BOX_BUFF = 580,
-	//AFFECT_UNKNOWN_581,
-	//AFFECT_MALL_EXP_BONUS = 582,
-
-#if defined(__SUMMER_EVENT_ROULETTE__)
-	AFFECT_LATE_SUMMER_EVENT_BUFF = 583,
-	AFFECT_LATE_SUMMER_EVENT_PRIMIUM_BUFF = 584,
-#endif
+	//NEW_AFFECT_LUCKEY_EVENT_BUFF = 560
 
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-	AFFECT_RED_DRAGONLAIR_BUFF = 585,
-#endif
-	//AFFECT_MISTS_ISLAND_BUFF = 586,
+	AFFECT_RAMADAN_ABILITY = 300,
+	AFFECT_RAMADAN_RING = 301,
 
-	//AFFECT_SEASON_RANKING_BUFF = 587,
-	//AFFECT_SEASON_PVE_BUFF = 588,
-	//AFFECT_UNKNOWN_589,
-
-	//AFFECT_BATTLE_ROYALE_SLOW = 590,
-	//AFFECT_BATTLE_ROYALE_MOVE_SPEED = 591,
-	//AFFECT_UNKNOWN_592,
-
-	//AFFECT_PASSIVE_JOB_DECK = 593,
-#if defined(__ELEMENTAL_DUNGEON__)
-	AFFECT_CURSE_OF_ELEMENTAL = 594,
-	AFFECT_PROTECTION_OF_ELEMENTAL = 595,
-	AFFECT_POTION_OF_ELEMENTAL = 596,
-#endif
-	//AFFECT_UNKNOWN_597,
-	//AFFECT_UNKNOWN_598,
-	//AFFECT_UNKNOWN_599,
-	//AFFECT_BATTLE_ROYALE_INFINITE_STAMINA = 600,
-
-#if defined(__SET_ITEM__)
-	AFFECT_SET_ITEM_SET_VALUE_1 = 601,
-	AFFECT_SET_ITEM_SET_VALUE_2 = 602,
-	AFFECT_SET_ITEM_SET_VALUE_3 = 603,
-	AFFECT_SET_ITEM_SET_VALUE_4 = 604,
-	AFFECT_SET_ITEM_SET_VALUE_5 = 605,
-#endif
-	//AFFECT_UNKNOWN_606,
-	//AFFECT_UNKNOWN_607,
+	AFFECT_NOG_ABILITY = 302,
+	AFFECT_HOLLY_STONE_POWER = 303,
 
-#if defined(__9TH_SKILL__)
-	AFFECT_CHEONUN_INVINCIBILITY = 608,
+#if defined(__EXTENDED_BLEND_AFFECT__) || defined(__BLEND_AFFECT__)
+	AFFECT_BLEND_POTION_1 = 304, // Critical
+	AFFECT_BLEND_POTION_2 = 305, // Penetration
+	AFFECT_BLEND_POTION_3 = 306, // Attack Speed
+	AFFECT_BLEND_POTION_4 = 307, // Magic Resist
+	AFFECT_BLEND_POTION_5 = 308, // Attack Value
+	AFFECT_BLEND_POTION_6 = 309, // Defense
+	AFFECT_ENERGY = 310,
+	AFFECT_DRAGON_GOD_1 = 311, // Max HP.
+	AFFECT_DRAGON_GOD_2 = 312, // Max SP.
+	AFFECT_DRAGON_GOD_3 = 313, // Attack Value
+	AFFECT_DRAGON_GOD_4 = 314, // Defense
+	AFFECT_CRITICAL = 315,
+	AFFECT_PENETRATE = 316,
+	AFFECT_ATTACK_SPEED = 317,
+	AFFECT_MOVE_SPEED = 318,
 #endif
 
-	//AFFECT_WORLD_BOSS_REWARD = 609,
-	//AFFECT_WORLD_BOSS_DAILY_REWARD = 610,
-
-	//AFFECT_SUNGMAHEE_TOWER_BUFF = 611,
-	//AFFECT_SUNGMAHEE_TOWER_DEBUFF = 612,
-	//AFFECT_SUNGMAHEE_TOWER_CURSE = 613,
-	//AFFECT_UNKNOWN_614,
-	//AFFECT_GARRISON_DEBUFF = 615,
-	//AFFECT_GARRISON_BUFF = 616,
-
-	//AFFECT_UNKNOWN_617,
-	//AFFECT_UNKNOWN_618,
-	//AFFECT_UNKNOWN_619,
-	//AFFECT_UNKNOWN_620,
-	//AFFECT_UNKNOWN_621,
-	//AFFECT_UNKNOWN_622,
+	AFFECT_RESEARCHER_ELIXIR = 400,
 
 #if defined(__CONQUEROR_LEVEL__)
 	AFFECT_SUNGMA_STR = 623,
@@ -274,54 +163,17 @@
 	AFFECT_SUNGMA_IMMUNE = 626,
 #endif
 
-	//AFFECT_UNKNOWN_627,
-	//AFFECT_UNKNOWN_628,
-	//AFFECT_SUBQUEST_NEWWORLD_5 = 629,
-	//AFFECT_WHITE_DRAGON_CAVE_CURSE = 630,
-
-	//AFFECT_SECRET_DUNGEON_BUFF_POINT_C = 631,
-	//AFFECT_SECRET_DUNGEON_BUFF_C = 632,
-	//AFFECT_SECRET_DUNGEON_BUFF_B = 633,
-	//AFFECT_SECRET_DUNGEON_BUFF_A = 634,
-
-	//AFFECT_OTHER_WORLD_DEAD_SOUL = 635,
-	//AFFECT_OTHER_WORLD_GOBLIN_PROTECTION = 636,
-	//AFFECT_OTHER_WORLD_YEOMWANG_CURSE = 637,
-	//AFFECT_OTHER_WORLD_NORTH_REAPER_ROOM_DEBUFF = 638,
-
-	//AFFECT_SKILL_MOUNT_UPGRADE_NIMBLE = 639,
-	//AFFECT_SKILL_MOUNT_UPGRADE_EXP = 640,
-	//AFFECT_SKILL_MOUNT_UPGRADE_SPEED = 641,
-	//AFFECT_SKILL_MOUNT_UPGRADE_GYENONGGONG = 642,
-	//AFFECT_SKILL_MOUNT_UPGRADE_INVINCIBLITIY = 643,
-	//AFFECT_SKILL_MOUNT_UPGRADE_KNOCKBACK = 644,
-	//AFFECT_SKILL_MOUNT_UPGRADE_TO_STRONG = 645,
-	//AFFECT_SKILL_MOUNT_UPGRADE_EFFECT_UP = 646,
-	//AFFECT_SKILL_MOUNT_UPGRADE_SUNGMA_STR = 647,
-	//AFFECT_SKILL_MOUNT_UPGRADE_SUNGMA_HP = 648,
-	//AFFECT_SKILL_MOUNT_UPGRADE_SUNGMA_MOVE = 649,
-	//AFFECT_SKILL_MOUNT_UPGRADE_SUNGMA_IMMUNE = 650,
-	//AFFECT_SKILL_MOUNT_UPGRADE_HIT_PCT = 651,
-
-	//AFFECT_MERCENARY_MISSION_MAX_ACTIVE_INCREASE = 652,
-	//AFFECT_SECRET_DUNGEON_BUFF_POINT_B = 653,
-	//AFFECT_SECRET_DUNGEON_BUFF_POINT_A = 654,
-	AFFECT_ELEMENT_BUFF_CRACK = 655,
-	//AFFECT_FLOWER_OF_GALE = 656,
-	//AFFECT_FLOWER_OF_DESTRUCTION = 657,
-	//AFFECT_UNKNOWN_658,
-	//AFFECT_UNKNOWN_659,
-	//AFFECT_UNKNOWN_660,
-	//AFFECT_UNKNOWN_661,
-	//AFFECT_IMMUNE_MINE_TOWER_SKILL = 662,
-#if defined(__SNOWFLAKE_STICK_EVENT__)
-	AFFECT_SNOWFLAKE_STICK_EVENT_RANK_BUFF = 663,
-	AFFECT_SNOWFLAKE_STICK_EVENT_SNOWFLAKE_BUFF = 664,
+#if defined(__GUILD_DRAGONLAIR__)
+	AFFECT_STATUE = 700,
 #endif
 
-	AFFECT_QUEST_START_IDX = 1000,
+#if defined(__SOUL_SYSTEM__)
+	AFFECT_SOUL_RED = 720,
+	AFFECT_SOUL_BLUE = 721,
+	AFFECT_SOUL_MIX = 723,
+#endif
 
-	AFFECT_MAX
+	AFFECT_QUEST_START_IDX = 1000
 };
 
 enum EAffectBits
@@ -339,7 +191,7 @@
 	AFF_DUNGEON_READY, //  غ 
 	AFF_DUNGEON_UNIQUE, //  ũ (Ŭ̾Ʈ ø)
 
-	AFF_BUILDING_CONSTRUCTION_SMALL, // AFF_SHACKLE
+	AFF_BUILDING_CONSTRUCTION_SMALL,
 	AFF_BUILDING_CONSTRUCTION_LARGE,
 	AFF_BUILDING_UPGRADE,
 
@@ -368,82 +220,40 @@
 	AFF_TANHWAN_DASH, // źȯݿ ޸Ʈ
 	AFF_PABEOP, // Ĺ
 	AFF_CHEONGEUN_WITH_FALL, // õ
-
-	AFF_POLYMORPH, // 
-
+	AFF_POLYMORPH,
 	AFF_WAR_FLAG1,
 	AFF_WAR_FLAG2,
 	AFF_WAR_FLAG3,
 
 	AFF_CHINA_FIREWORK,
-	AFF_CANNOT_ATTACK,
-	AFF_CANNOT_USE_SKILL,
+	AFF_HAIR, // 
+	AFF_GERMANY, // 
+
 	AFF_DS,
 
-	AFF_BLEEDING,
-	AFF_RED_POSSESSION,
-	AFF_BLUE_POSSESSION,
-
-	AFF_UNK46,
-	AFF_UNK47,
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-	AFF_UNBEATABLE,
+	AFF_BLEEDING, // 42
+	AFF_RED_POSSESSION, // 43
+	AFF_BLUE_POSSESSION, // 44
+
+#if defined(__GUILD_DRAGONLAIR__)
+	AFF_STATUE1, // 45
+	AFF_STATUE2, // 46
+	AFF_STATUE3, // 47
+	AFF_STATUE4, // 48
 #endif
 
-	AFF_BATTLE_FIELD_RANK1,
-	AFF_BATTLE_FIELD_RANK2,
-	AFF_BATTLE_FIELD_RANK3,
-	AFF_TARGET_VICTIM,
-
-	AFF_UNK53,
-
-	AFF_ELECTRIC_SHOCK,
-	AFF_CONFUSION,
-
 #if defined(__SOUL_SYSTEM__)
-	AFF_SOUL_RED,
-	AFF_SOUL_BLUE,
-	AFF_SOUL_MIX,
+	AFF_SOUL_RED, // 49
+	AFF_SOUL_BLUE, // 50
+	AFF_SOUL_MIX, // 51
 #endif
 
-	AFF_UNK59,
-	AFF_BATTLE_ROYALE_SLOW_1,
-	AFF_BATTLE_ROYALE_SLOW_2,
-	AFF_BATTLE_ROYALE_SLOW_3,
-
-	AFF_UNK63,
-	AFF_PASWAE,
-	AFF_UNK65,
-
-	AFF_ELEMENT_BUFF_CRACK_NONE,
-	AFF_ELEMENT_BUFF_CRACK_FIRE,
-	AFF_ELEMENT_BUFF_CRACK_ICE,
-	AFF_ELEMENT_BUFF_CRACK_ELECT,
-	AFF_ELEMENT_BUFF_CRACK_WIND,
-	AFF_ELEMENT_BUFF_CRACK_EARTH,
-	AFF_ELEMENT_BUFF_CRACK_DARK,
-
-	AFF_FLAG_UNK73, // guild_battle (blue)
-	AFF_FLAG_UNK74, // guild_battle (yellow)
-	AFF_FLAG_UNK75, // guild_battle (green)
-	AFF_FLAG_UNK76, // guild_battle (red)
-
-	AFF_FLAG_UNK77,
-	AFF_FLAG_UNK78,
-	AFF_FLAG_UNK79,
-	AFF_FLAG_UNK80,
-
 #if defined(__9TH_SKILL__)
-	AFF_CHEONUN_INVINCIBILITY,
-	AFF_CHEONUN_NORMAL,
-	AFF_CHEONUN_MASTER,
-	AFF_CHEONUN_GRAND_MASTER,
-	AFF_CHEONUN_PERFECT_MASTER,
+	AFF_CHEONUN, // 52
+	AFF_CHUNWOON_MOOJUK, // 53
 #endif
 
-	AFF_BITS_MAX,
-
-	AFF_HWAYEOM = AFF_GEOMGYEONG,
+	AFF_BITS_MAX
 };
 
 extern void SendAffectAddPacket(LPDESC d, CAffect* pkAff);
@@ -451,11 +261,11 @@
 // AFFECT_DURATION_BUG_FIX
 enum AffectVariable
 {
-	// Used when Affect should be set to infinity.
-	// Since time continues to decrease, infinity is emulated by using a very large value.
-	//// 24 bits are not enough, so 25 bits are used.
-	// ...Despite saying to use 25 bits, this is an enormous comment using 29 bits...
-	// In the collect quest, an infinite time of 60 years is used, so let's use 60 years here too.
+	// Affect Ѵ  ־   .
+	// ð  ̱  ſ ū Ѵ븦 ķ̼.
+	//// 24Ʈ Ƿ 25Ʈ .
+	// ... 25Ʈ Ѵٰ س 29bit ϰ ִ û ̶ּ...
+	// collect quest  ð 60 ϰ Ƿ, ⵵ 60 .
 
 	INFINITE_AFFECT_DURATION = 60 * 365 * 24 * 60 * 60
 };
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/char.cpp final/server/server/home/metin2/Source/Server/game/src/char.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/char.cpp	2026-02-18 18:50:34.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/char.cpp	2022-04-27 12:51:21.000000000 +0000
@@ -1,11997 +1,10203 @@
-#include "stdafx.h"
-
-#include "../../common/VnumHelper.h"
-
-#include "char.h"
-#include "config.h"
-#include "utils.h"
-#include "crc32.h"
-#include "char_manager.h"
-#include "desc_client.h"
-#include "desc_manager.h"
-#include "buffer_manager.h"
-#include "item_manager.h"
-#include "motion.h"
-#include "vector.h"
-#include "packet.h"
-#include "cmd.h"
-#include "fishing.h"
-#include "exchange.h"
-#include "battle.h"
-#include "affect.h"
-#include "shop.h"
-#include "shop_manager.h"
-#include "safebox.h"
-#include "regen.h"
-#include "pvp.h"
-#include "party.h"
-#include "start_position.h"
-#include "questmanager.h"
-#include "log.h"
-#include "p2p.h"
-#include "guild.h"
-#include "guild_manager.h"
-#include "dungeon.h"
-#include "messenger_manager.h"
-#include "unique_item.h"
-#include "unique_mob.h"
-#include "priv_manager.h"
-#include "war_map.h"
-#include "xmas_event.h"
-#include "banword.h"
-#include "target.h"
-#include "wedding.h"
-#include "mob_manager.h"
-#include "mining.h"
-#include "monarch.h"
-#include "castle.h"
-#include "arena.h"
-#include "dev_log.h"
-#include "horsename_manager.h"
-#include "pcbang.h"
-#include "gm.h"
-#include "map_location.h"
-#include "BlueDragon_Binder.h"
-#include "skill_power.h"
-#include "buff_on_attributes.h"
-#include "threeway_war.h"
-
-#if defined(__PET_SYSTEM__)
-#	include "PetSystem.h"
-#endif
-#include "DragonSoul.h"
-#ifdef ENABLE_QUEEN_NETHIS
-#include "SnakeLair.h"
-#endif
-#if defined(__LOOT_FILTER_SYSTEM__)
-#	include "LootFilter.h"
-#endif
-
-#include "BlueDragon.h"
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-#	include "guild_dragonlair.h"
-#endif
-#if defined(__DEFENSE_WAVE__)
-#	include "defense_wave.h"
-#endif
-
-#ifdef __OFFLINE_SHOP__
-#include "OfflineShop.h"
-#endif
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-#include "battlepass_manager.h"
-#endif
-
-#include <sstream>
-
-extern const POINT_TYPE g_aBuffOnAttrPoints;
-extern bool RaceToJob(BYTE race, BYTE* ret_job);
-
-extern int g_nPortalLimitTime;
-extern int test_server;
-
-bool CAN_ENTER_ZONE(const LPCHARACTER& ch, int map_index)
-{
-	switch (map_index)
-	{
-		case MAP_CAPEDRAGONHEAD:
-		case MAP_DAWNMISTWOOD:
-		case MAP_BAYBLACKSAND:
-		case MAP_MT_THUNDER:
-			if (ch->GetLevel() < 90)
-				return false;
-	}
-	return true;
-}
-
-bool IS_BLOCKED_PET(int map_index)
-{
-	if (map_index >= 10000)
-		map_index = map_index / 10000;
-	
-	switch (map_index)
-	{
-		case 113: // ox
-		case 81: // wedding map
-			return true;
-	}
-	
-	return false;
-}
-
-bool IS_BLOCKED_PET_DUNGEON_MAP(int map_index)
-{
-	if (map_index < 10000)
-		return false;
-
-	map_index /= 10000;
-
-	switch (map_index)
-	{
-	default:
-		return false;
-	}
-
-	return false;
-}
-
-// <Factor> DynamicCharacterPtr member function definitions
-LPCHARACTER DynamicCharacterPtr::Get() const
-{
-	LPCHARACTER p = NULL;
-	if (is_pc)
-		p = CHARACTER_MANAGER::instance().FindByPID(id);
-	else
-		p = CHARACTER_MANAGER::instance().Find(id);
-
-	return p;
-}
-
-DynamicCharacterPtr& DynamicCharacterPtr::operator=(LPCHARACTER character)
-{
-	if (character == NULL)
-	{
-		Reset();
-		return *this;
-	}
-
-	if (character->IsPC())
-	{
-		is_pc = true;
-		id = character->GetPlayerID();
-	}
-	else
-	{
-		is_pc = false;
-		id = character->GetVID();
-	}
-
-	return *this;
-}
-
-CHARACTER::CHARACTER()
-{
-	m_stateIdle.Set(this, &CHARACTER::BeginStateEmpty, &CHARACTER::StateIdle, &CHARACTER::EndStateEmpty);
-	m_stateMove.Set(this, &CHARACTER::BeginStateEmpty, &CHARACTER::StateMove, &CHARACTER::EndStateEmpty);
-	m_stateBattle.Set(this, &CHARACTER::BeginStateEmpty, &CHARACTER::StateBattle, &CHARACTER::EndStateEmpty);
-
-	Initialize();
-}
-
-CHARACTER::~CHARACTER()
-{
-	Destroy();
-}
-
-void CHARACTER::Initialize()
-{
-	m_stName = "";
-
-	CEntity::Initialize(ENTITY_CHARACTER);
-
-#if defined(__LEFT_SEAT__)
-	m_bLeftSeat = false;
-
-	m_dwLeftSeatWaitTime = false;
-	m_pLeftSeatWaitTimerEvent = NULL;
-
-	m_dwLeftSeatLogoutTime = false;
-	m_pLeftSeatLogoutTimerEvent = NULL;
-
-	m_dwLastRequestTime = 0;
-#endif
-
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	SetUnderRefineElement(false);
-#endif
-
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	m_bExtendInvenStage = 0;
-#endif
-
-#if defined(__ACCE_COSTUME_SYSTEM__)
-	m_bAcceRefineWindowType = ACCE_SLOT_TYPE_MAX;
-	m_bAcceRefineWindowOpen = false;
-	for (BYTE bSlotIndex = ACCE_SLOT_LEFT; bSlotIndex < ACCE_SLOT_MAX; bSlotIndex++)
-		m_pAcceRefineWindowItemSlot[bSlotIndex] = NPOS;
-#endif
-
-#if defined(__AURA_COSTUME_SYSTEM__)
-	m_bAuraRefineWindowType = AURA_WINDOW_TYPE_MAX;
-	m_bAuraRefineWindowOpen = false;
-	for (BYTE i = AURA_SLOT_MAIN; i < AURA_SLOT_MAX; i++)
-		m_pAuraRefineWindowItemSlot[i] = NPOS;
-
-	std::memset(&m_bAuraRefineInfo, 0, AURA_REFINE_INFO_SLOT_MAX * sizeof(TAuraRefineInfo));
-#endif
-
-#if defined(__FISHING_GAME__)
-	SetFishingGameGoals(0);
-#endif
-
-#if defined(__ATTR_6TH_7TH__)
-	m_bIsOpenAttr67Add = false;
-#endif
-
-#if defined(__GEM_SHOP__)
-	m_pGemShop = nullptr;
-	m_bGemShopLoading = false;
-#endif
-
-#if defined(__MAILBOX__)
-	m_pkMailBox = nullptr;
-	bMailBoxLoading = false;
-	m_iMyMailBoxTime = 0;
-#endif
-
-#if defined(__MINI_GAME_RUMI__)
-	m_pkMiniGameRumi = nullptr;
-#endif
-
-#if defined(__MINI_GAME_YUTNORI__)
-	m_pkMiniGameYutnori = nullptr;
-#endif
-
-#if defined(__SUMMER_EVENT_ROULETTE__)
-	m_pMiniGameRoulette = nullptr;
-	m_bMiniGameRoulette_RewardMapperNum = 0;
-#endif
-
-	m_bNoOpenedShop = true;
-
-	m_bOpeningSafebox = false;
-
-	m_fSyncTime = get_float_time() - 3;
-	m_dwPlayerID = 0;
-	m_dwKillerPID = 0;
-
-	m_iMoveCount = 0;
-
-	m_pkRegen = NULL;
-	regen_id_ = 0;
-	m_posRegen.x = m_posRegen.y = m_posRegen.z = 0;
-	m_posStart.x = m_posStart.y = 0;
-	m_posDest.x = m_posDest.y = 0;
-	m_fRegenAngle = 0.0f;
-
-	m_pkMobData = NULL;
-	m_pkMobInst = NULL;
-
-	m_pkShop = NULL;
-	m_pkChrShopOwner = NULL;
-	m_pkMyShop = NULL;
-	m_pkExchange = NULL;
-	m_pkParty = NULL;
-	m_pkPartyRequestEvent = NULL;
-
-	m_pGuild = NULL;
-
-	m_pkChrTarget = NULL;
-
-#if defined(__CHANGE_LOOK_SYSTEM__)
-	m_pkChangeLook = nullptr;
-#endif
-
-	m_pkMuyeongEvent = NULL;
-#ifdef ENABLE_QUEEN_NETHIS
-	m_pkSnakeSkillEvent = NULL;
-#endif
-#if defined(__PVP_BALANCE_IMPROVING__)
-	m_pkGyeongGongEvent = NULL;
-#endif
-#if defined(__9TH_SKILL__)
-	m_pkCheonunEvent = NULL;
-#endif
-#if defined(__ATTR_6TH_7TH__)
-	m_pHitBuffEvent = NULL;
-#endif
-#if defined(__ELEMENTAL_DUNGEON__)
-	m_pElementalCurseEvent = NULL;
-	m_dwAccumulatedDamage = 0;
-#endif
-
-	m_pkWarpNPCEvent = NULL;
-	m_pkDeadEvent = NULL;
-	m_pkStunEvent = NULL;
-	m_pkSaveEvent = NULL;
-	m_pkRecoveryEvent = NULL;
-	m_pkTimedEvent = NULL;
-	m_pkFishingEvent = NULL;
-	m_pkWarpEvent = NULL;
-
-	// MINING
-	m_pkMiningEvent = NULL;
-	// END_OF_MINING
-
-	m_pkPoisonEvent = NULL;
-	m_pkBleedingEvent = NULL;
-	m_pkFireEvent = NULL;
-#if defined(__DAWNMIST_DUNGEON__)
-	m_pkHealEvent = NULL;
-#endif
-
-	m_pkCheckSpeedHackEvent = NULL;
-	m_speed_hack_count = 0;
-
-	m_pkAffectEvent = NULL;
-	m_afAffectFlag = TAffectFlag(0, 0);
-
-	m_pkDestroyWhenIdleEvent = NULL;
-
-	m_pkChrSyncOwner = NULL;
-
-	memset(&m_points, 0, sizeof(m_points));
-	memset(&m_pointsInstant, 0, sizeof(m_pointsInstant));
-	memset(&m_quickslot, 0, sizeof(m_quickslot));
-
-	m_bCharType = CHAR_TYPE_MONSTER;
-
-	SetPosition(POS_STANDING);
-
-	m_dwPlayStartTime = m_dwLastMoveTime = get_dword_time();
-#if defined(__LEFT_SEAT__)
-	m_dwLastRequestTime = get_dword_time();
-#endif
-
-	GotoState(m_stateIdle);
-	m_dwStateDuration = 1;
-
-	m_dwLastAttackTime = get_dword_time() - 20000;
-
-	m_bAddChrState = 0;
-
-	m_pkChrStone = NULL;
-
-	m_pkSafebox = NULL;
-	m_iSafeboxSize = -1;
-	m_iSafeboxLoadTime = 0;
-
-	m_pkMall = NULL;
-	m_iMallLoadTime = 0;
-
-	m_posWarp.x = m_posWarp.y = m_posWarp.z = 0;
-	m_lWarpMapIndex = 0;
-
-	m_posExit.x = m_posExit.y = m_posExit.z = 0;
-	m_lExitMapIndex = 0;
-
-	m_pSkillLevels = NULL;
-
-	m_dwMoveStartTime = 0;
-	m_dwMoveDuration = 0;
-
-	m_dwFlyTargetID = 0;
-
-	m_dwNextStatePulse = 0;
-
-	m_dwLastDeadTime = get_dword_time() - 180000;
-
-	m_bSkipSave = false;
-
-	m_bItemLoaded = false;
-
-	m_bHasPoisoned = false;
-	m_bHasBled = false;
-
-	m_pkDungeon = NULL;
-	m_iEventAttr = 0;
-
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-	m_pGuildDragonLair = NULL;
-#endif
-
-#if defined(__DEFENSE_WAVE__)
-	m_pDefenseWave = NULL;
-#endif
-
-	m_kAttackLog.dwVID = 0;
-	m_kAttackLog.dwTime = 0;
-
-	m_bNowWalking = m_bWalking = false;
-	ResetChangeAttackPositionTime();
-
-	m_bDetailLog = false;
-	m_bMonsterLog = false;
-
-	m_bDisableCooltime = false;
-
-	m_iAlignment = 0;
-	m_iRealAlignment = 0;
-
-	m_iKillerModePulse = 0;
-	m_bPKMode = PK_MODE_PEACE;
-
-	m_dwQuestNPCVID = 0;
-	m_dwQuestByVnum = 0;
-	m_pQuestItem = NULL;
-
-	m_dwUnderGuildWarInfoMessageTime = get_dword_time() - 60000;
-
-	m_bUnderRefine = false;
-
-	// REFINE_NPC
-	m_dwRefineNPCVID = 0;
-	// END_OF_REFINE_NPC
-
-	m_dwPolymorphRace = 0;
-#if defined(__RACE_SWAP__)
-	m_dwEventRaceNum = 0;
-#endif
-
-	m_bStaminaConsume = false;
-
-	ResetChainLightningIndex();
-
-	m_dwMountVnum = 0;
-	m_chHorse = NULL;
-	m_chRider = NULL;
-	m_pWarMap = NULL;
-	m_pWeddingMap = NULL;
-	m_bChatCounter = 0;
-	m_bWhisperCounter = 0;
-
-	ResetStopTime();
-
-	m_dwLastVictimSetTime = get_dword_time() - 3000;
-	m_iMaxAggro = -100;
-
-	m_bSendHorseLevel = 0;
-	m_bSendHorseHealthGrade = 0;
-	m_bSendHorseStaminaGrade = 0;
-
-	m_dwLoginPlayTime = 0;
-
-	m_pkChrMarried = NULL;
-
-	m_posSafeboxOpen.x = -1000;
-	m_posSafeboxOpen.y = -1000;
-
-	// EQUIP_LAST_SKILL_DELAY
-	m_dwLastSkillTime = get_dword_time();
-	// END_OF_EQUIP_LAST_SKILL_DELAY
-
-	// MOB_SKILL_COOLTIME
-	memset(m_adwMobSkillCooltime, 0, sizeof(m_adwMobSkillCooltime));
-	// END_OF_MOB_SKILL_COOLTIME
-
-	m_isinPCBang = false;
-
-	// ARENA
-	m_pArena = NULL;
-	m_nPotionLimit = quest::CQuestManager::instance().GetEventFlag("arena_potion_limit_count");
-	// END_ARENA
-
-	// PREVENT_TRADE_WINDOW
-	m_isOpenSafebox = 0;
-	// END_PREVENT_TRADE_WINDOW
-
-	// PREVENT_REFINE_HACK
-	m_iRefineTime = 0;
-	// END_PREVENT_REFINE_HACK
-
-	// RESTRICT_USE_SEED_OR_MOONBOTTLE
-	m_iSeedTime = 0;
-	// END_RESTRICT_USE_SEED_OR_MOONBOTTLE
-	// PREVENT_PORTAL_AFTER_EXCHANGE
-	m_iExchangeTime = 0;
-	// END_PREVENT_PORTAL_AFTER_EXCHANGE
-
-	m_iSafeboxLoadTime = 0;
-
-	m_iMyShopTime = 0;
-
-#ifdef __SHOP_SEARCH__
-	m_dwLastShopSearchRequestTime = 0;
-	m_bShopSearchFloodCount = 0;
-#endif
-
-#if defined(__MYSHOP_DECO__)
-	m_bMyShopDecoType = 0;
-	m_bMyShopDecoState = 0;
-	m_bMyShopDecoPolyVnum = 30000;
-
-	m_bMyPrivShopTabCount = 1;
-	m_bMyPrivShopIsCashItem = false;
-#endif
-
-#if defined(__FLOWER_EVENT__)
-	m_dwLastFlowerEventExchangePulse = 0;
-#endif
-
-	InitMC();
-
-	m_deposit_pulse = 0;
-
-	SET_OVER_TIME(this, OT_NONE);
-
-	m_strNewName = "";
-
-	m_known_guild.clear();
-
-	m_dwLogOffInterval = 0;
-	m_dwLastPlay = 0;
-
-	m_bComboSequence = 0;
-	m_dwLastComboTime = 0;
-	m_bComboIndex = 0;
-	m_iComboHackCount = 0;
-	m_dwSkipComboAttackByTime = 0;
-
-	m_dwMountTime = 0;
-
-	m_dwLastGoldDropTime = 0;
-#if defined(__CHEQUE_SYSTEM__)
-	m_dwLastChequeDropTime = 0;
-#endif
-
-	m_bIsLoadedAffect = false;
-	cannot_dead = false;
-
-	m_newSummonInterval = 0;
-	m_lastSummonTime = 0;
-
-#if defined(__PET_SYSTEM__)
-	m_petSystem = 0;
-	m_bIsPet = false;
-#endif
-
-#if defined(__LOOT_FILTER_SYSTEM__)
-	m_pLootFilter = nullptr;
-#endif
-
-	m_fAttMul = 1.0f;
-	m_fDamMul = 1.0f;
-
-	m_pointsInstant.iDragonSoulActiveDeck = -1;
-	m_pointsInstant.iDragonSoulRefineDeckSnapshot = -1;
-
-	memset(&m_tvLastSyncTime, 0, sizeof(m_tvLastSyncTime));
-	m_iSyncHackCount = 0;
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	m_listExtBattlePass.clear();
-	m_bIsLoadedExtBattlePass = false;
-	m_dwLastReciveExtBattlePassInfoTime = 0;
-#endif
-
-#if defined(__CHANGED_ATTR__)
-	memset(&m_ItemSelectAttr, 0, sizeof(m_ItemSelectAttr));
-#endif
-
-#if defined(__MINI_GAME_CATCH_KING__)
-	m_vecCatchKingFieldCards.clear();
-	bCatchKingHandCard = 0;
-	bCatchKingHandCardLeft = 0;
-	bCatchKingBetSetNumber = 0;
-	dwCatchKingTotalScore = 0;
-	dwCatchKingGameStatus = false;
-#endif
-
-#if defined(__LUCKY_BOX__)
-	ResetLuckyBoxData();
-#endif
-
-#if defined(__GAME_OPTION_ESCAPE__)
-	m_dwEscapeCooltime = 0;
-#endif
-
-#if defined(__HIDE_COSTUME_SYSTEM__)
-	m_dwHideCostumePulse = 0;
-	memset(&m_bHiddenCostumePart, 0, sizeof(m_bHiddenCostumePart));
-#endif
-
-#ifdef __OFFLINE_SHOP__
-	keepingOfflineShop_ = 0;
-	isOpeningOfflineShop_ = false;
-	offlineShopOpeningItem_ = nullptr;
-	m_bSellHistoryLoaded = 0;
-	m_vecSellHistory.clear();
-#endif
-
-#ifdef __GROWTH_PET_SYSTEM__
-	m_bInvincible = false;
-
-	m_bIsPetHatchOpen = false;
-	m_bIsPetChangeNameOpen = false;
-	m_bIsGrowthPetLoaded = false;
-
-	m_bPetWindowType = 0;
-
-	m_activeGrowthPet = nullptr;
-	m_growthPetMap.clear();
-
-	m_bCharacterSize = 0;
-#endif
-}
-
-void CHARACTER::Create(const char* c_pszName, DWORD vid, bool isPC)
-{
-	static int s_crc = 172814;
-
-	char crc_string[128 + 1];
-	snprintf(crc_string, sizeof(crc_string), "%s%p%d", c_pszName, this, ++s_crc);
-	m_vid = VID(vid, GetCRC32(crc_string, strlen(crc_string)));
-
-	if (isPC)
-		m_stName = c_pszName;
-}
-
-void CHARACTER::Destroy()
-{
-	CloseMyShop();
-#ifdef __OFFLINE_SHOP__
-	RemoveFromViewingOfflineShops();
-#endif
-	if (m_pkRegen)
-	{
-		if (m_pkDungeon)
-		{
-			// Dungeon regen may not be valid at this point
-			if (m_pkDungeon->IsValidRegen(m_pkRegen, regen_id_))
-			{
-				--m_pkRegen->count;
-			}
-		}
-		else
-		{
-			// Is this really safe?
-			--m_pkRegen->count;
-#ifdef __YMIR_REGEN_FIX__
-			if (m_pkRegen->event)
-			{
-				m_pkRegen->event->skip_event = false;
-				event_reset_time(m_pkRegen->event, PASSES_PER_SEC(m_pkRegen->time));
-			}
-#endif
-		}
-		m_pkRegen = NULL;
-	}
-
-	if (m_pkDungeon)
-		SetDungeon(NULL);
-
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-	if (m_pGuildDragonLair)
-		SetGuildDragonLair(NULL);
-#endif
-
-#if defined(__DEFENSE_WAVE__)
-	if (m_pDefenseWave)
-		SetDefenseWave(NULL);
-#endif
-
-#if defined(__PET_SYSTEM__)
-	if (m_petSystem)
-	{
-		m_petSystem->Destroy();
-		delete m_petSystem;
-
-		m_petSystem = 0;
-	}
-#endif
-
-#ifdef __GROWTH_PET_SYSTEM__
-	if (IsPC())
-	{
-		ClearGrowthPet();
-	}
-#endif
-
-#if defined(__LOOT_FILTER_SYSTEM__)
-	ClearLootFilter();
-#endif
-
-#if defined(__CHANGE_LOOK_SYSTEM__)
-	SetChangeLook(nullptr);
-#endif
-
-#if defined(__MINI_GAME_RUMI__)
-	SetMiniGameRumi(nullptr);
-#endif
-
-#if defined(__MINI_GAME_YUTNORI__)
-	SetMiniGameYutnori(nullptr);
-#endif
-
-#if defined(__MAILBOX__)
-	SetMailBox(nullptr);
-#endif
-
-#if defined(__GEM_SHOP__)
-	SetGemShop(nullptr);
-#endif
-
-#if defined(__SUMMER_EVENT_ROULETTE__)
-	SetMiniGameRoulette(nullptr);
-#endif
-
-	HorseSummon(false);
-
-	if (GetRider())
-		GetRider()->ClearHorseInfo();
-
-	if (GetDesc())
-	{
-		GetDesc()->BindCharacter(NULL);
-		//BindDesc(NULL);
-	}
-
-	if (m_pkExchange)
-		m_pkExchange->Cancel();
-
-	SetVictim(NULL);
-
-	if (GetShop())
-	{
-		GetShop()->RemoveGuest(this);
-		SetShop(NULL);
-	}
-
-	ClearStone();
-	ClearSync();
-	ClearTarget();
-
-	if (NULL == m_pkMobData)
-	{
-#if defined(__DRAGON_SOUL_SYSTEM__)
-		DragonSoul_CleanUp();
-#endif
-		ClearItem();
-	}
-
-	// <Factor> m_pkParty becomes NULL after CParty destructor call!
-	LPPARTY party = m_pkParty;
-	if (party)
-	{
-		if (party->GetLeaderPID() == GetVID() && !IsPC())
-		{
-			M2_DELETE(party);
-		}
-		else
-		{
-			party->Unlink(this);
-
-			if (!IsPC())
-				party->Quit(GetVID());
-		}
-
-		SetParty(NULL); // ص  ϰ.
-	}
-
-	if (m_pkMobInst)
-	{
-		M2_DELETE(m_pkMobInst);
-		m_pkMobInst = NULL;
-	}
-
-	m_pkMobData = NULL;
-
-	if (m_pkSafebox)
-	{
-		M2_DELETE(m_pkSafebox);
-		m_pkSafebox = NULL;
-	}
-
-	if (m_pkMall)
-	{
-		M2_DELETE(m_pkMall);
-		m_pkMall = NULL;
-	}
-
-	m_set_pkChrSpawnedBy.clear();
-
-	StopMuyeongEvent();
-#if defined(__9TH_SKILL__)
-	StopCheonunEvent();
-#endif
-#if defined(__ATTR_6TH_7TH__)
-	StopHitBuffEvent();
-#endif
-#if defined(__ELEMENTAL_DUNGEON__)
-	StopElementalCurseEvent();
-#endif
-
-	event_cancel(&m_pkWarpNPCEvent);
-	event_cancel(&m_pkRecoveryEvent);
-	event_cancel(&m_pkDeadEvent);
-	event_cancel(&m_pkSaveEvent);
-	event_cancel(&m_pkTimedEvent);
-	event_cancel(&m_pkStunEvent);
-	event_cancel(&m_pkFishingEvent);
-	event_cancel(&m_pkPoisonEvent);
-	event_cancel(&m_pkBleedingEvent);
-	event_cancel(&m_pkFireEvent);
-#if defined(__DAWNMIST_DUNGEON__)
-	event_cancel(&m_pkHealEvent);
-#endif
-	event_cancel(&m_pkPartyRequestEvent);
-	// DELAYED_WARP
-	event_cancel(&m_pkWarpEvent);
-	event_cancel(&m_pkCheckSpeedHackEvent);
-	// END_DELAYED_WARP
-
-	// RECALL_DELAY
-	//event_cancel(&m_pkRecallEvent);
-	// END_OF_RECALL_DELAY
-
-	// MINING
-	event_cancel(&m_pkMiningEvent);
-	// END_OF_MINING
-
-#if defined(__LEFT_SEAT__)
-	event_cancel(&m_pLeftSeatWaitTimerEvent);
-	event_cancel(&m_pLeftSeatLogoutTimerEvent);
-#endif
-
-	for (MobSkillEventMap::iterator it = m_mapMobSkillEvent.begin();
-		it != m_mapMobSkillEvent.end(); ++it)
-	{
-		LPEVENT pkEvent = it->second;
-		event_cancel(&pkEvent);
-	}
-	m_mapMobSkillEvent.clear();
-
-	//event_cancel(&m_pkAffectEvent);
-	ClearAffect();
-
-	for (TMapBuffOnAttrs::iterator it = m_map_buff_on_attrs.begin();
-		it != m_map_buff_on_attrs.end(); ++it)
-	{
-		if (NULL != it->second)
-		{
-			M2_DELETE(it->second);
-		}
-	}
-	m_map_buff_on_attrs.clear();
-
-	event_cancel(&m_pkDestroyWhenIdleEvent);
-
-	if (m_pSkillLevels)
-	{
-		M2_DELETE_ARRAY(m_pSkillLevels);
-		m_pSkillLevels = NULL;
-	}
-
-	CEntity::Destroy();
-
-	if (GetSectree())
-		GetSectree()->RemoveEntity(this);
-
-	if (m_bMonsterLog)
-		CHARACTER_MANAGER::instance().UnregisterForMonsterLog(this);
-}
-
-const char* CHARACTER::GetName() const
-{
-	return m_stName.empty() ? (m_pkMobData ? m_pkMobData->m_table.szLocaleName : "") : m_stName.c_str();
-}
-
-void CHARACTER::OpenMyShop(const char* c_pszSign, TShopItemTable* pTable, BYTE bItemCount)
-{
-	if (!CanHandleItem())
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("ٸ ŷ(â,ȯ,) λ   ϴ."));
-		return;
-	}
-
-#ifdef __GROWTH_PET_SYSTEM__
-	if (GetActiveGrowthPet())
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("PET_YANINDAYKEN_PAZAR_ACAMAZSIN"));
-		return;
-	}
-
-	if (GetPetWindowType() == PET_WINDOW_ATTR_CHANGE || GetPetWindowType() == PET_WINDOW_PRIMIUM_FEEDSTUFF)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("PET_STATLARINI_DEGISTIRME_UYARI"));
-		return;
-	}
-#endif
-
-	if (GetPart(PART_MAIN) > 2)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("      ֽϴ."));
-		return;
-	}
-
-	if (GetMyShop()) // ̹    ݴ´.
-	{
-		CloseMyShop();
-		return;
-	}
-
-	//  Ʈ     .
-	quest::PC* pPC = quest::CQuestManager::instance().GetPCForce(GetPlayerID());
-
-	// GetPCForce NULL  Ƿ  Ȯ 
-	if (pPC->IsRunning())
-		return;
-
-	if (bItemCount == 0)
-		return;
-
-	int64_t nTotalMoney = 0;
-#if defined(__CHEQUE_SYSTEM__)
-	int64_t nTotalCheque = 0;
-#endif
-
-	for (int n = 0; n < bItemCount; ++n)
-	{
-		nTotalMoney += static_cast<int64_t>((pTable + n)->price);
-#if defined(__CHEQUE_SYSTEM__)
-		nTotalCheque += static_cast<int64_t>((pTable + n)->cheque);
-#endif
-	}
-
-	nTotalMoney += static_cast<int64_t>(GetGold());
-#if defined(__CHEQUE_SYSTEM__)
-	nTotalCheque += static_cast<int64_t>(GetCheque());
-#endif
-
-	if (GOLD_MAX <= nTotalMoney)
-	{
-		sys_err("[OVERFLOW_GOLD] Overflow (GOLD_MAX) id %u name %s", GetPlayerID(), GetName());
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("20  ʰϿ   ϴ"));
-		return;
-	}
-
-#if defined(__CHEQUE_SYSTEM__)
-	if (CHEQUE_MAX < nTotalCheque)
-	{
-		sys_err("[OVERFLOW_CHEQUE] Overflow (CHEQUE_MAX) id %u name %s", GetPlayerID(), GetName());
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot trade, because the maximum number of %d Won was exceeded.", CHEQUE_MAX));
-		return;
-	}
-#endif
-
-	char szSign[SHOP_SIGN_MAX_LEN + 1];
-	strlcpy(szSign, c_pszSign, sizeof(szSign));
-
-	m_stShopSign = szSign;
-
-	if (m_stShopSign.length() == 0)
-		return;
-
-	if (CBanwordManager::instance().CheckString(m_stShopSign.c_str(), m_stShopSign.length()))
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ӿ  Ե  ̸    ϴ."));
-		return;
-	}
-
-	// MYSHOP_PRICE_LIST
-#if defined(__CHEQUE_SYSTEM__)
-	std::map<DWORD, TItemPriceInfo> itemkind;
-#else
-	std::map<DWORD, DWORD> itemkind; //   , first: vnum, second:   
-#endif
-	// END_OF_MYSHOP_PRICE_LIST
-
-	std::set<TItemPos> cont;
-	for (BYTE i = 0; i < bItemCount; ++i)
-	{
-		if (cont.find((pTable + i)->pos) != cont.end())
-		{
-			sys_err("MYSHOP: duplicate shop item detected! (name: %s)", GetName());
-			return;
-		}
-
-		// ANTI_GIVE, ANTI_MYSHOP check
-		LPITEM pkItem = GetItem((pTable + i)->pos);
-
-		if (pkItem)
-		{
-			const TItemTable* item_table = pkItem->GetProto();
-
-			if (item_table && (IS_SET(item_table->ullAntiFlags, ITEM_ANTIFLAG_GIVE | ITEM_ANTIFLAG_MYSHOP)))
-			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("ȭ  λ Ǹ  ϴ."));
-				return;
-			}
-
-			if (pkItem->IsEquipped() == true)
-			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("  λ Ǹ  ϴ."));
-				return;
-			}
-
-			if (true == pkItem->isLocked())
-			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("  λ Ǹ  ϴ."));
-				return;
-			}
-
-#if defined(__SOUL_BIND_SYSTEM__)
-			if (pkItem->IsSealed())
-			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot sell soulbound items in a private shop."));
-				return;
-			}
-#endif
-
-			// MYSHOP_PRICE_LIST
-#if defined(__CHEQUE_SYSTEM__)
-			TItemPriceInfo priceinfo;
-			priceinfo.dwVnum = pkItem->GetVnum();
-			priceinfo.dwPrice = (pTable + i)->price / pkItem->GetCount();
-			priceinfo.dwCheque = (pTable + i)->cheque / pkItem->GetCount();
-			itemkind[pkItem->GetVnum()] = priceinfo;
-#else
-			itemkind[pkItem->GetVnum()] = (pTable + i)->price / pkItem->GetCount();
-#endif
-			// END_OF_MYSHOP_PRICE_LIST
-		}
-
-		cont.insert((pTable + i)->pos);
-	}
-
-	// MYSHOP_PRICE_LIST
-	//   ҽŲ.
-	if (CountSpecifyItem(71049)) //    ʰ  Ѵ.
-	{
-		//
-		//   ϱ    Ŷ  DB ĳÿ .
-		//
-		TItemPriceListTable header;
-		memset(&header, 0, sizeof(TItemPriceListTable));
-
-		header.dwOwnerID = GetPlayerID();
-		header.byCount = static_cast<BYTE>(itemkind.size());
-
-		size_t idx = 0;
-
-		for (auto it = itemkind.begin(); it != itemkind.end(); ++it)
-		{
-			header.aPriceInfo[idx].dwVnum = it->first;
-#if defined(__CHEQUE_SYSTEM__)
-			header.aPriceInfo[idx].dwPrice = it->second.dwPrice;
-			header.aPriceInfo[idx].dwCheque = it->second.dwCheque;
-#else
-			header.aPriceInfo[idx].dwPrice = it->second;
-#endif
-
-			idx++;
-		}
-
-		db_clientdesc->DBPacket(HEADER_GD_MYSHOP_PRICELIST_UPDATE, GetDesc()->GetHandle(), &header, sizeof(TItemPriceListTable));
-	}
-	// END_OF_MYSHOP_PRICE_LIST
-	else if (CountSpecifyItem(50200))
-		RemoveSpecifyItem(50200, 1);
-	else
-		return; //   ߴ.
-
-	if (m_pkExchange)
-		m_pkExchange->Cancel();
-
-	TPacketGCShopSign p;
-
-	p.bHeader = HEADER_GC_SHOP_SIGN;
-	p.dwVID = GetVID();
-	strlcpy(p.szSign, c_pszSign, sizeof(p.szSign));
-#if defined(__MYSHOP_DECO__)
-	p.bType = GetMyShopDecoType();
-#endif
-
-	PacketAround(&p, sizeof(TPacketGCShopSign));
-
-	m_pkMyShop = CShopManager::instance().CreatePCShop(this, pTable, bItemCount);
-
-	if (IsPolymorphed() == true)
-	{
-		RemoveAffect(AFFECT_POLYMORPH);
-	}
-
-	if (GetHorse())
-	{
-		HorseSummon(false, true);
-	}
-	// new mount ̿ ߿,    ڵ unmount
-	// StopRiding Ʈ óϸ   ׷ س   .
-	else if (GetMountVnum())
-	{
-		RemoveAffect(AFFECT_MOUNT);
-		RemoveAffect(AFFECT_MOUNT_BONUS);
-	}
-
-	SetPolymorph(30000, true);
-}
-
-void CHARACTER::CloseMyShop()
-{
-	if (GetMyShop())
-	{
-		m_stShopSign.clear();
-		CShopManager::instance().DestroyPCShop(this);
-		m_pkMyShop = NULL;
-
-#if defined(__MYSHOP_DECO__)
-		SetMyShopDecoType(0);
-		SetMyShopDecoPolyVnum(30000);
-		SetMyPrivShopTabCount(1);
-#endif
-
-		TPacketGCShopSign p;
-
-		p.bHeader = HEADER_GC_SHOP_SIGN;
-		p.dwVID = GetVID();
-		p.szSign[0] = '\0';
-#if defined(__MYSHOP_DECO__)
-		p.bType = 0;
-#endif
-
-		PacketAround(&p, sizeof(p));
-
-		SetPolymorph(m_points.bJob, true);
-	}
-}
-
-void EncodeMovePacket(TPacketGCMove& pack, DWORD dwVID, BYTE bFunc, BYTE bArg, DWORD x, DWORD y, DWORD dwDuration, DWORD dwTime, BYTE bRot)
-{
-	pack.bHeader = HEADER_GC_MOVE;
-	pack.bFunc = bFunc;
-	pack.bArg = bArg;
-	pack.dwVID = dwVID;
-	pack.dwTime = dwTime ? dwTime : get_dword_time();
-	pack.bRot = bRot;
-	pack.lX = x;
-	pack.lY = y;
-	pack.dwDuration = dwDuration;
-}
-
-void CHARACTER::Restart(BYTE bSubCMD)
-{
-	if (false == IsDead())
-	{
-		ChatPacket(CHAT_TYPE_COMMAND, "CloseRestartWindow");
-		StartRecoveryEvent();
-		return;
-	}
-
-	if (NULL == m_pkDeadEvent)
-		return;
-
-	int iTimeToDead = (event_time(m_pkDeadEvent) / passes_per_sec);
-
-	if (bSubCMD != SCMD_RESTART_TOWN && (!GetWarMap() || GetWarMap()->GetType() == GUILD_WAR_TYPE_FLAG))
-	{
-		if (!test_server)
-		{
-			if (IsHack())
-			{
-				//  ϰ쿡 üũ  ʴ´.
-				if (false == CThreeWayWar::instance().IsSungZiMapIndex(GetMapIndex()))
-				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("    ϴ. (%d )", iTimeToDead - (180 - g_nPortalLimitTime)));
-					return;
-				}
-			}
-
-			if (iTimeToDead > 170)
-			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("    ϴ. (%d )", iTimeToDead - 170));
-				return;
-			}
-		}
-	}
-
-	// PREVENT_HACK
-	// DESC : â, ȯ â  Ż ϴ ׿ ̿ɼ ־
-	// Ÿ ߰
-	if (bSubCMD == SCMD_RESTART_TOWN)
-	{
-		if (IsHack())
-		{
-			// , ʿ üũ  ʴ´.
-			if ((!GetWarMap() || GetWarMap()->GetType() == GUILD_WAR_TYPE_FLAG) ||
-				false == CThreeWayWar::instance().IsSungZiMapIndex(GetMapIndex()))
-			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("    ϴ. (%d )", iTimeToDead - (180 - g_nPortalLimitTime)));
-				return;
-			}
-		}
-
-		if (iTimeToDead > 173)
-		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("     ϴ. (%d  )", iTimeToDead - 173));
-			return;
-		}
-	}
-	//END_PREVENT_HACK
-
-	ChatPacket(CHAT_TYPE_COMMAND, "CloseRestartWindow");
-
-	GetDesc()->SetPhase(PHASE_GAME);
-	SetPosition(POS_STANDING);
-	StartRecoveryEvent();
-
-	// FORKED_LOAD
-	// DESC: Ÿ  Ȱ Ұ  Ա ƴ Ÿ   ̵ϰ ȴ.
-	if (1 == quest::CQuestManager::instance().GetEventFlag("threeway_war"))
-	{
-		if (bSubCMD == SCMD_RESTART_TOWN || bSubCMD == SCMD_RESTART_HERE)
-		{
-			if (true == CThreeWayWar::instance().IsThreeWayWarMapIndex(GetMapIndex()) &&
-				false == CThreeWayWar::instance().IsSungZiMapIndex(GetMapIndex()))
-			{
-				WarpSet(EMPIRE_START_X(GetEmpire()), EMPIRE_START_Y(GetEmpire()));
-
-				PointChange(POINT_HP, GetMaxHP() - GetHP());
-				PointChange(POINT_SP, GetMaxSP() - GetSP());
-
-				ComputePoints();
-				ReviveInvisible(5);
-
-				return;
-			}
-
-			// 
-			if (true == CThreeWayWar::instance().IsSungZiMapIndex(GetMapIndex()))
-			{
-				if (CThreeWayWar::instance().GetReviveTokenForPlayer(GetPlayerID()) <= 0)
-				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING(" Ȱ ȸ  Ҿϴ!  ̵մϴ!"));
-					WarpSet(EMPIRE_START_X(GetEmpire()), EMPIRE_START_Y(GetEmpire()));
-				}
-				else
-				{
-					Show(GetMapIndex(), GetSungziStartX(GetEmpire()), GetSungziStartY(GetEmpire()));
-				}
-
-				PointChange(POINT_HP, GetMaxHP() - GetHP());
-				PointChange(POINT_SP, GetMaxSP() - GetSP());
-
-				ComputePoints();
-				ReviveInvisible(5);
-
-				return;
-			}
-		}
-	}
-	// END_FORKED_LOAD
-
-	if (GetDungeon())
-		GetDungeon()->UseRevive(this);
-
-	if (GetWarMap() && !IsObserverMode())
-	{
-		CWarMap* pMap = GetWarMap();
-		DWORD dwGuildOpponent = pMap ? pMap->GetGuildOpponent(this) : 0;
-
-		if (dwGuildOpponent)
-		{
-			switch (bSubCMD)
-			{
-				case SCMD_RESTART_TOWN:
-				{
-					sys_log(0, "do_restart: restart town");
-
-					PIXEL_POSITION pos;
-					if (CWarMapManager::instance().GetStartPosition(GetMapIndex(), GetGuild()->GetID() < dwGuildOpponent ? 0 : 1, pos))
-						Show(GetMapIndex(), pos.x, pos.y);
-					else
-						ExitToSavedLocation();
-
-					PointChange(POINT_HP, GetMaxHP() - GetHP());
-					PointChange(POINT_SP, GetMaxSP() - GetSP());
-
-					ComputePoints();
-					ReviveInvisible(5);
-				}
-				break;
-
-				case SCMD_RESTART_HERE:
-				{
-					sys_log(0, "do_restart: restart here");
-
-					RestartAtSamePos();
-					//Show(GetMapIndex(), GetX(), GetY());
-
-					PointChange(POINT_HP, GetMaxHP() - GetHP());
-					PointChange(POINT_SP, GetMaxSP() - GetSP());
-
-					ComputePoints();
-					ReviveInvisible(5);
-				}
-				break;
-			}
-
-			return;
-		}
-	}
-
-	if (IS_MAZE_DUNGEON(GetMapIndex()))
-	{
-		if (WarpSet(1147800, 532600))
-			return;
-	}
-
-#if defined(__ELEMENTAL_DUNGEON__)
-	if (IS_ELEMENTAL_DUNGEON(GetMapIndex()) && !IsGM())
-		bSubCMD = SCMD_RESTART_GIVEUP;
-#endif
-
-	switch (bSubCMD)
-	{
-		case SCMD_RESTART_TOWN:
-		{
-			sys_log(0, "do_restart: restart town");
-
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-			if (GetGuildDragonLair())
+#include "stdafx.h"
+
+#include "../../common/VnumHelper.h"
+
+#include "char.h"
+
+#include "config.h"
+#include "utils.h"
+#include "crc32.h"
+#include "char_manager.h"
+#include "desc_client.h"
+#include "desc_manager.h"
+#include "buffer_manager.h"
+#include "item_manager.h"
+#include "motion.h"
+#include "vector.h"
+#include "packet.h"
+#include "cmd.h"
+#include "fishing.h"
+#include "exchange.h"
+#include "battle.h"
+#include "affect.h"
+#include "shop.h"
+#include "shop_manager.h"
+#include "safebox.h"
+#include "regen.h"
+#include "pvp.h"
+#include "party.h"
+#include "start_position.h"
+#include "questmanager.h"
+#include "log.h"
+#include "p2p.h"
+#include "guild.h"
+#include "guild_manager.h"
+#include "dungeon.h"
+#include "messenger_manager.h"
+#include "unique_item.h"
+#include "unique_mob.h"
+#include "priv_manager.h"
+#include "war_map.h"
+#include "xmas_event.h"
+#include "banword.h"
+#include "target.h"
+#include "wedding.h"
+#include "mob_manager.h"
+#include "mining.h"
+#include "monarch.h"
+#include "castle.h"
+#include "arena.h"
+#include "dev_log.h"
+#include "horsename_manager.h"
+#include "pcbang.h"
+#include "gm.h"
+#include "map_location.h"
+#include "BlueDragon_Binder.h"
+#include "skill_power.h"
+#include "buff_on_attributes.h"
+
+#if defined(__PET_SYSTEM__)
+#include "PetSystem.h"
+#endif
+
+#include "DragonSoul.h"
+
+#if defined(__GUILD_DRAGONLAIR__)
+#include "MeleyLair.h"
+#endif
+
+#if defined(__TEMPLE_OCHAO__)
+#include "TempleOchao.h"
+#endif
+
+extern const BYTE g_aBuffOnAttrPoints;
+extern bool RaceToJob(unsigned race, unsigned* ret_job);
+
+extern int g_nPortalLimitTime;
+extern int test_server;
+
+bool CAN_ENTER_ZONE(const LPCHARACTER& ch, int map_index)
+{
+	switch (map_index)
+	{
+	case 301:
+	case 302:
+	case 303:
+	case 304:
+		if (ch->GetLevel() < 90)
+			return false;
+	}
+	return true;
+}
+
+bool IS_BLOCKED_PET_SUMMON_MAP(int map_index, bool isHorse)
+{
+	if (map_index == 113)
+		return true;
+
+	return false;
+}
+
+bool IS_BLOCKED_MOUNT_SUMMON_MAP(int map_index)
+{
+	switch (map_index)
+	{
+	case 113:
+		return true;
+	}
+	return false;
+}
+
+bool IS_BLOCKED_MOUNT_DUNGEON_MAP(int map_index)
+{
+	if (map_index < 10000)
+		return false;
+
+	map_index /= 10000;
+
+	switch (map_index)
+	{
+	case 353: // metin2_map_dawnmist_dungeon_01
+		return true;
+	}
+
+	return false;
+}
+// <Factor> DynamicCharacterPtr member function definitions
+
+LPCHARACTER DynamicCharacterPtr::Get() const
+{
+	LPCHARACTER p = NULL;
+	if (is_pc)
+		p = CHARACTER_MANAGER::instance().FindByPID(id);
+	else
+		p = CHARACTER_MANAGER::instance().Find(id);
+
+	return p;
+}
+
+DynamicCharacterPtr& DynamicCharacterPtr::operator=(LPCHARACTER character)
+{
+	if (character == NULL)
+	{
+		Reset();
+		return *this;
+	}
+
+	if (character->IsPC())
+	{
+		is_pc = true;
+		id = character->GetPlayerID();
+	}
+	else
+	{
+		is_pc = false;
+		id = character->GetVID();
+	}
+
+	return *this;
+}
+
+CHARACTER::CHARACTER()
+{
+	m_stateIdle.Set(this, &CHARACTER::BeginStateEmpty, &CHARACTER::StateIdle, &CHARACTER::EndStateEmpty);
+	m_stateMove.Set(this, &CHARACTER::BeginStateEmpty, &CHARACTER::StateMove, &CHARACTER::EndStateEmpty);
+	m_stateBattle.Set(this, &CHARACTER::BeginStateEmpty, &CHARACTER::StateBattle, &CHARACTER::EndStateEmpty);
+
+	Initialize();
+}
+
+CHARACTER::~CHARACTER()
+{
+	Destroy();
+}
+
+void CHARACTER::Initialize()
+{
+	CEntity::Initialize(ENTITY_CHARACTER);
+
+#if defined(__MAILBOX__)
+	m_pkMailBox = nullptr;
+	bMailBoxLoading = false;
+	m_iMyMailBoxTime = 0;
+#endif
+
+	m_bNoOpenedShop = true;
+
+	m_bOpeningSafebox = false;
+
+	m_fSyncTime = get_float_time() - 3;
+	m_dwPlayerID = 0;
+	m_dwKillerPID = 0;
+
+#if defined(__SEND_TARGET_INFO__)
+	dwLastTargetInfoPulse = 0;
+#endif
+
+	m_iMoveCount = 0;
+
+	m_pkRegen = NULL;
+	regen_id_ = 0;
+	m_posRegen.x = m_posRegen.y = m_posRegen.z = 0;
+	m_posStart.x = m_posStart.y = 0;
+	m_posDest.x = m_posDest.y = 0;
+	m_fRegenAngle = 0.0f;
+
+	m_pkMobData = NULL;
+	m_pkMobInst = NULL;
+
+	m_pkShop = NULL;
+	m_pkChrShopOwner = NULL;
+	m_pkMyShop = NULL;
+	m_pkExchange = NULL;
+	m_pkParty = NULL;
+	m_pkPartyRequestEvent = NULL;
+
+	m_pGuild = NULL;
+
+	m_pkChrTarget = NULL;
+
+	m_pkMuyeongEvent = NULL;
+#if defined(__9TH_SKILL__)
+	m_pkCheonunEvent = NULL;
+#endif
+
+	m_pkWarpNPCEvent = NULL;
+	m_pkDeadEvent = NULL;
+	m_pkStunEvent = NULL;
+	m_pkSaveEvent = NULL;
+	m_pkRecoveryEvent = NULL;
+	m_pkTimedEvent = NULL;
+	m_pkFishingEvent = NULL;
+	m_pkWarpEvent = NULL;
+
+	// MINING
+	m_pkMiningEvent = NULL;
+	// END_OF_MINING
+
+	m_pkPoisonEvent = NULL;
+	m_pkBleedingEvent = NULL;
+	m_pkFireEvent = NULL;
+	m_pkCheckSpeedHackEvent = NULL;
+	m_speed_hack_count = 0;
+
+	m_pkAffectEvent = NULL;
+	m_afAffectFlag = TAffectFlag(0, 0);
+
+	m_pkDestroyWhenIdleEvent = NULL;
+
+	m_pkChrSyncOwner = NULL;
+
+	memset(&m_points, 0, sizeof(m_points));
+	memset(&m_pointsInstant, 0, sizeof(m_pointsInstant));
+	memset(&m_quickslot, 0, sizeof(m_quickslot));
+
+#if defined(__MINI_GAME_OKEY__)
+	memset(&character_cards, 0, sizeof(character_cards));
+	memset(&randomized_cards, 0, sizeof(randomized_cards));
+#endif
+
+	m_bCharType = CHAR_TYPE_MONSTER;
+
+	SetPosition(POS_STANDING);
+
+	m_dwPlayStartTime = m_dwLastMoveTime = get_dword_time();
+
+	GotoState(m_stateIdle);
+	m_dwStateDuration = 1;
+
+	m_dwLastAttackTime = get_dword_time() - 20000;
+
+	m_bAddChrState = 0;
+
+	m_pkChrStone = NULL;
+
+	m_pkSafebox = NULL;
+	m_iSafeboxSize = -1;
+	m_iSafeboxLoadTime = 0;
+
+	m_pkMall = NULL;
+	m_iMallLoadTime = 0;
+
+	m_posWarp.x = m_posWarp.y = m_posWarp.z = 0;
+	m_lWarpMapIndex = 0;
+
+	m_posExit.x = m_posExit.y = m_posExit.z = 0;
+	m_lExitMapIndex = 0;
+
+	m_pSkillLevels = NULL;
+
+	m_dwMoveStartTime = 0;
+	m_dwMoveDuration = 0;
+
+	m_dwFlyTargetID = 0;
+
+	m_dwNextStatePulse = 0;
+
+	m_dwLastDeadTime = get_dword_time() - 180000;
+
+	m_bSkipSave = false;
+
+	m_bItemLoaded = false;
+
+	m_bHasPoisoned = false;
+	m_bHasBled = false;
+
+	m_pkDungeon = NULL;
+	m_iEventAttr = 0;
+
+	m_kAttackLog.dwVID = 0;
+	m_kAttackLog.dwTime = 0;
+
+	m_bNowWalking = m_bWalking = false;
+	ResetChangeAttackPositionTime();
+
+	m_bDetailLog = false;
+	m_bMonsterLog = false;
+
+	m_bDisableCooltime = false;
+
+	m_iAlignment = 0;
+	m_iRealAlignment = 0;
+
+	m_iKillerModePulse = 0;
+	m_bPKMode = PK_MODE_PEACE;
+
+	m_dwQuestNPCVID = 0;
+	m_dwQuestByVnum = 0;
+	m_pQuestItem = NULL;
+
+	m_dwUnderGuildWarInfoMessageTime = get_dword_time() - 60000;
+
+	m_bUnderRefine = false;
+
+	// REFINE_NPC
+	m_dwRefineNPCVID = 0;
+	// END_OF_REFINE_NPC
+
+	m_dwPolymorphRace = 0;
+
+	m_bStaminaConsume = false;
+
+	ResetChainLightningIndex();
+
+#if defined(__PRIVATESHOP_SEARCH_SYSTEM__)
+	bPrivateShopSearchState = SHOP_SEARCH_OFF;
+#endif
+
+	m_dwMountVnum = 0;
+	m_chHorse = NULL;
+	m_chRider = NULL;
+
+	m_pWarMap = NULL;
+	m_pWeddingMap = NULL;
+	m_bChatCounter = 0;
+
+	ResetStopTime();
+
+#if defined(__GEM_MARKET_SYSTEM__)
+	LoadGemSystem();
+#endif
+
+	m_dwLastVictimSetTime = get_dword_time() - 3000;
+	m_iMaxAggro = -100;
+
+	m_bSendHorseLevel = 0;
+	m_bSendHorseHealthGrade = 0;
+	m_bSendHorseStaminaGrade = 0;
+
+	m_dwLoginPlayTime = 0;
+
+	m_pkChrMarried = NULL;
+
+	m_posSafeboxOpen.x = -1000;
+	m_posSafeboxOpen.y = -1000;
+
+	// EQUIP_LAST_SKILL_DELAY
+	m_dwLastSkillTime = get_dword_time();
+	// END_OF_EQUIP_LAST_SKILL_DELAY
+
+	// MOB_SKILL_COOLTIME
+	memset(m_adwMobSkillCooltime, 0, sizeof(m_adwMobSkillCooltime));
+	// END_OF_MOB_SKILL_COOLTIME
+
+	m_isinPCBang = false;
+
+	// ARENA
+	m_pArena = NULL;
+	m_nPotionLimit = quest::CQuestManager::instance().GetEventFlag("arena_potion_limit_count");
+	// END_ARENA
+
+	// PREVENT_TRADE_WINDOW
+	m_isOpenSafebox = 0;
+	// END_PREVENT_TRADE_WINDOW
+
+	// PREVENT_REFINE_HACK
+	m_iRefineTime = 0;
+	// END_PREVENT_REFINE_HACK
+
+	// RESTRICT_USE_SEED_OR_MOONBOTTLE
+	m_iSeedTime = 0;
+	// END_RESTRICT_USE_SEED_OR_MOONBOTTLE
+	// PREVENT_PORTAL_AFTER_EXCHANGE
+	m_iExchangeTime = 0;
+	// END_PREVENT_PORTAL_AFTER_EXCHANGE
+
+	m_iSafeboxLoadTime = 0;
+
+	m_iMyShopTime = 0;
+#if defined(__MYSHOP_DECO__)
+	m_bMyShopDecoType = 0;
+	m_dwMyShopDecoPolyVnum = 0;
+	m_bMyShopTabs = 0;
+#endif
+
+	InitMC();
+
+	m_deposit_pulse = 0;
+
+	SET_OVER_TIME(this, OT_NONE);
+
+	m_strNewName = "";
+
+	m_known_guild.clear();
+
+	m_dwLogOffInterval = 0;
+	m_dwLastPlay = 0;
+
+	m_bComboSequence = 0;
+	m_dwLastComboTime = 0;
+	m_bComboIndex = 0;
+	m_iComboHackCount = 0;
+	m_dwSkipComboAttackByTime = 0;
+
+	m_dwMountTime = 0;
+
+	m_dwLastGoldDropTime = 0;
+#if defined(__CHEQUE_SYSTEM__)
+	m_dwLastChequeDropTime = 0;
+#endif
+
+	m_bIsLoadedAffect = false;
+	cannot_dead = false;
+
+	m_newSummonInterval = 0;
+	m_lastSummonTime = 0;
+#if defined(__EREBUS_DUNGEON__)
+	m_iLastHealerSummonDelay = 0;
+#endif
+
+#if defined(__PET_SYSTEM__)
+	m_petSystem = 0;
+	m_bIsPet = false;
+#endif
+
+	m_fAttMul = 1.0f;
+	m_fDamMul = 1.0f;
+
+	m_pointsInstant.iDragonSoulActiveDeck = -1;
+
+	memset(&m_tvLastSyncTime, 0, sizeof(m_tvLastSyncTime));
+	m_iSyncHackCount = 0;
+
+#if defined(__ACCE_COSTUME_SYSTEM__)
+	m_bAcceCombination = false;
+	m_bAcceAbsorption = false;
+#endif
+
+#if defined(__CHANGE_LOOK_SYSTEM__)
+	m_bChangeLook = false;
+#endif
+
+#if defined(__SORT_INVENTORY_ITEMS__)
+	m_sortInventoryPulse = 0;
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	m_sortSpecialInventoryPulse = 0;
+#endif
+#endif
+
+#if defined(__HIDE_COSTUME_SYSTEM__)
+	m_HideCostumePulse = 0;
+	m_bHideBodyCostume = false;
+	m_bHideHairCostume = false;
+	m_bHideAcceCostume = false;
+	m_bHideWeaponCostume = false;
+#endif
+
+	affectInfo = NULL;
+
+#if defined(__SKILL_COLOR_SYSTEM__)
+	memset(&m_dwSkillColor, 0, sizeof(m_dwSkillColor));
+#endif
+
+#if defined(__MINI_GAME_CATCH_KING__)
+	m_vecCatchKingFieldCards.clear();
+	bCatchKingHandCard = 0;
+	bCatchKingHandCardLeft = 0;
+	bCatchKingBetSetNumber = 0;
+	dwCatchKingTotalScore = 0;
+	dwCatchKingGameStatus = false;
+#endif
+
+#ifdef __GROWTH_PET_SYSTEM__
+	m_bInvincible = false;
+
+	m_bIsPetHatchOpen = false;
+	m_bIsPetChangeNameOpen = false;
+	m_bIsGrowthPetLoaded = false;
+
+	m_bPetWindowType = 0;
+
+	m_activeGrowthPet = nullptr;
+	m_growthPetMap.clear();
+
+	m_bCharacterSize = 0;
+#endif
+}
+
+void CHARACTER::Create(const char* c_pszName, DWORD vid, bool isPC)
+{
+	static int s_crc = 172814;
+
+	char crc_string[128 + 1];
+	snprintf(crc_string, sizeof(crc_string), "%s%p%d", c_pszName, this, ++s_crc);
+	m_vid = VID(vid, GetCRC32(crc_string, strlen(crc_string)));
+
+	if (isPC)
+		m_stName = c_pszName;
+}
+
+void CHARACTER::Destroy()
+{
+	CloseMyShop();
+
+	if (m_pkRegen)
+	{
+		if (m_pkDungeon)
+		{
+			// Dungeon regen may not be valid at this point
+			if (m_pkDungeon->IsValidRegen(m_pkRegen, regen_id_))
+			{
+				--m_pkRegen->count;
+			}
+		}
+		else
+		{
+			// Is this really safe?
+			--m_pkRegen->count;
+		}
+		m_pkRegen = NULL;
+	}
+
+	if (m_pkDungeon)
+	{
+		SetDungeon(NULL);
+	}
+	
+#ifdef __GROWTH_PET_SYSTEM__
+	if (IsPC())
+	{
+		ClearGrowthPet();
+	}
+#endif
+
+#if defined(__PET_SYSTEM__)
+	if (m_petSystem)
+	{
+		m_petSystem->Destroy();
+		delete m_petSystem;
+
+		m_petSystem = 0;
+	}
+#endif
+
+#if defined(__MAILBOX__)
+	SetMailBox(nullptr);
+#endif
+
+	HorseSummon(false);
+
+	if (GetRider())
+		GetRider()->ClearHorseInfo();
+
+	if (GetDesc())
+	{
+		GetDesc()->BindCharacter(NULL);
+		//BindDesc(NULL);
+	}
+
+	if (m_pkExchange)
+		m_pkExchange->Cancel();
+
+	SetVictim(NULL);
+
+	if (GetShop())
+	{
+		GetShop()->RemoveGuest(this);
+		SetShop(NULL);
+	}
+
+	ClearStone();
+	ClearSync();
+	ClearTarget();
+
+	if (NULL == m_pkMobData)
+	{
+		DragonSoul_CleanUp();
+		ClearItem();
+	}
+
+	// <Factor> m_pkParty becomes NULL after CParty destructor call!
+	LPPARTY party = m_pkParty;
+	if (party)
+	{
+		if (party->GetLeaderPID() == GetVID() && !IsPC())
+		{
+			M2_DELETE(party);
+		}
+		else
+		{
+			party->Unlink(this);
+
+			if (!IsPC())
+				party->Quit(GetVID());
+		}
+
+		SetParty(NULL); // ص  ϰ.
+	}
+
+	if (m_pkMobInst)
+	{
+		M2_DELETE(m_pkMobInst);
+		m_pkMobInst = NULL;
+	}
+
+	m_pkMobData = NULL;
+
+	if (m_pkSafebox)
+	{
+		M2_DELETE(m_pkSafebox);
+		m_pkSafebox = NULL;
+	}
+
+	if (m_pkMall)
+	{
+		M2_DELETE(m_pkMall);
+		m_pkMall = NULL;
+	}
+
+	m_set_pkChrSpawnedBy.clear();
+
+	StopMuyeongEvent();
+#if defined(__9TH_SKILL__)
+	StopCheonunEvent();
+#endif
+
+	event_cancel(&m_pkWarpNPCEvent);
+	event_cancel(&m_pkRecoveryEvent);
+	event_cancel(&m_pkDeadEvent);
+	event_cancel(&m_pkSaveEvent);
+	event_cancel(&m_pkTimedEvent);
+	event_cancel(&m_pkStunEvent);
+	event_cancel(&m_pkFishingEvent);
+	event_cancel(&m_pkPoisonEvent);
+	event_cancel(&m_pkBleedingEvent);
+	event_cancel(&m_pkFireEvent);
+	event_cancel(&m_pkPartyRequestEvent);
+	// DELAYED_WARP
+	event_cancel(&m_pkWarpEvent);
+	event_cancel(&m_pkCheckSpeedHackEvent);
+	// END_DELAYED_WARP
+
+	// RECALL_DELAY
+	//event_cancel(&m_pkRecallEvent);
+	// END_OF_RECALL_DELAY
+
+	// MINING
+	event_cancel(&m_pkMiningEvent);
+	// END_OF_MINING
+
+	for (itertype(m_mapMobSkillEvent) it = m_mapMobSkillEvent.begin(); it != m_mapMobSkillEvent.end(); ++it)
+	{
+		LPEVENT pkEvent = it->second;
+		event_cancel(&pkEvent);
+	}
+	m_mapMobSkillEvent.clear();
+
+	//event_cancel(&m_pkAffectEvent);
+	ClearAffect();
+
+	for (itertype(m_map_buff_on_attrs) it = m_map_buff_on_attrs.begin(); it != m_map_buff_on_attrs.end(); ++it)
+	{
+		if (NULL != it->second)
+		{
+			M2_DELETE(it->second);
+		}
+	}
+	m_map_buff_on_attrs.clear();
+
+	event_cancel(&m_pkDestroyWhenIdleEvent);
+
+	if (m_pSkillLevels)
+	{
+		M2_DELETE_ARRAY(m_pSkillLevels);
+		m_pSkillLevels = NULL;
+	}
+
+	CEntity::Destroy();
+
+	if (GetSectree())
+		GetSectree()->RemoveEntity(this);
+
+	if (m_bMonsterLog)
+		CHARACTER_MANAGER::instance().UnregisterForMonsterLog(this);
+
+	if (affectInfo)
+	{
+		M2_DELETE_ARRAY(affectInfo->data);
+		M2_DELETE(affectInfo);
+	}
+}
+
+const char* CHARACTER::GetName() const
+{
+	return m_stName.empty() ? (m_pkMobData ? LC_LOCALE_MOB_TEXT(GetRaceNum(), GetLanguage()) : "") : m_stName.c_str();
+}
+
+void CHARACTER::OpenMyShop(const char* c_pszSign, TShopItemTable* pTable, WORD wItemCount)
+{
+	if (!CanHandleItem())
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ٸ ŷ(â,ȯ,) λ   ϴ."));
+		return;
+	}
+
+	if (GetPart(PART_MAIN) > 2)
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("      ֽϴ."));
+		return;
+	}
+
+	if (GetMyShop()) // ̹    ݴ´.
+	{
+		CloseMyShop();
+		return;
+	}
+	
+#ifdef __GROWTH_PET_SYSTEM__
+	if (GetActiveGrowthPet())
+	{
+		ChatPacket(CHAT_TYPE_INFO, "You cannot open a private shop whilst summoning your pet.");
+		return;
+	}
+
+	if (GetPetWindowType() == PET_WINDOW_ATTR_CHANGE || GetPetWindowType() == PET_WINDOW_PRIMIUM_FEEDSTUFF)
+	{
+		ChatPacket(CHAT_TYPE_INFO, "While modifying your pet's stats, you cannot trade, sell items, use the storeroom etc.");
+		return;
+	}
+#endif
+
+	//  Ʈ     .
+	quest::PC* pPC = quest::CQuestManager::instance().GetPCForce(GetPlayerID());
+
+	// GetPCForce NULL  Ƿ  Ȯ 
+	if (pPC->IsRunning())
+		return;
+
+	if (wItemCount == 0)
+		return;
+
+	int64_t nTotalMoney = 0;
+#if defined(__CHEQUE_SYSTEM__)
+	int64_t nTotalCheque = 0;
+#endif
+
+	for (int n = 0; n < wItemCount; ++n)
+	{
+		nTotalMoney += static_cast<int64_t>((pTable + n)->price);
+#if defined(__CHEQUE_SYSTEM__)
+		nTotalCheque += static_cast<int64_t>((pTable + n)->price_cheque);
+#endif
+	}
+
+	nTotalMoney += static_cast<int64_t>(GetGold());
+#if defined(__CHEQUE_SYSTEM__)
+	nTotalCheque += static_cast<int64_t>(GetCheque());
+#endif
+
+	if (g_MaxGold <= nTotalMoney)
+	{
+		sys_err("[OVERFLOW_GOLD] Overflow (GOLD_MAX) id %u name %s", GetPlayerID(), GetName());
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("20  ʰϿ   ϴ"));
+		return;
+	}
+
+#if defined(__CHEQUE_SYSTEM__)
+	if (CHEQUE_MAX <= nTotalCheque)
+	{
+		sys_err("[OVERFLOW_CHEQUE] Overflow (CHEQUE_MAX) id %u name %s", GetPlayerID(), GetName());
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("20  ʰϿ   ϴ"));
+		return;
+	}
+#endif
+
+	char szSign[SHOP_SIGN_MAX_LEN + 1];
+	strlcpy(szSign, c_pszSign, sizeof(szSign));
+
+	m_stShopSign = szSign;
+
+	if (m_stShopSign.length() == 0)
+		return;
+
+	if (CBanwordManager::instance().CheckString(m_stShopSign.c_str(), m_stShopSign.length()))
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ӿ  Ե  ̸    ϴ."));
+		return;
+	}
+
+	// MYSHOP_PRICE_LIST
+	std::map<DWORD, DWORD> itemkind; //   , first: vnum, second:   
+	// END_OF_MYSHOP_PRICE_LIST
+
+	std::set<TItemPos> cont;
+	for (WORD i = 0; i < wItemCount; ++i)
+	{
+		if (cont.find((pTable + i)->pos) != cont.end())
+		{
+			sys_err("MYSHOP: duplicate shop item detected! (name: %s)", GetName());
+			return;
+		}
+
+		// ANTI_GIVE, ANTI_MYSHOP check
+		LPITEM pkItem = GetItem((pTable + i)->pos);
+
+		if (pkItem)
+		{
+			const TItemTable* item_table = pkItem->GetProto();
+
+			if (item_table && (IS_SET(item_table->ullAntiFlags, ITEM_ANTIFLAG_GIVE | ITEM_ANTIFLAG_MYSHOP)))
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ȭ  λ Ǹ  ϴ."));
+				return;
+			}
+
+			if (pkItem->IsEquipped() == true)
 			{
-				const LPSECTREE_MAP pSectree = SECTREE_MANAGER::instance().GetMap(MAP_N_FLAME_DRAGON);
-				if (pSectree != NULL)
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  λ Ǹ  ϴ."));
+				return;
+			}
+
+			if (true == pkItem->isLocked())
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  λ Ǹ  ϴ."));
+				return;
+			}
+
+#if defined(__SOUL_BIND_SYSTEM__)
+			if (pkItem->IsSealed())
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot sell soulbound items in a private shop."));
+				return;
+			}
+#endif
+
+			// MYSHOP_PRICE_LIST
+			itemkind[pkItem->GetVnum()] = (pTable + i)->price / pkItem->GetCount();
+#if defined(__CHEQUE_SYSTEM__)
+			itemkind[pkItem->GetVnum()] = (pTable + i)->price_cheque / pkItem->GetCount();
+#endif
+			// END_OF_MYSHOP_PRICE_LIST
+		}
+
+		cont.insert((pTable + i)->pos);
+	}
+
+	// MYSHOP_PRICE_LIST
+	//   ҽŲ.
+#if defined(__MYSHOP_DECO__)
+	if (CountSpecifyItem(71049) || CountSpecifyItem(KASHMIR_BUNDLE)) //    ʰ  Ѵ.
+#else
+	if (CountSpecifyItem(71049)) //    ʰ  Ѵ.
+#endif
+	{
+		//
+		//   ϱ    Ŷ  DB ĳÿ .
+		//
+		TItemPriceListTable header;
+		memset(&header, 0, sizeof(TItemPriceListTable));
+
+		header.dwOwnerID = GetPlayerID();
+		header.byCount = itemkind.size();
+
+		size_t idx = 0;
+
+		for (itertype(itemkind) it = itemkind.begin(); it != itemkind.end(); ++it)
+		{
+			header.aPriceInfo[idx].dwVnum = it->first;
+			header.aPriceInfo[idx].dwPrice = it->second;
+#if defined(__CHEQUE_SYSTEM__)
+			header.aPriceInfo[idx].dwPriceCheque = it->second;
+#endif
+
+			idx++;
+		}
+
+		db_clientdesc->DBPacket(HEADER_GD_MYSHOP_PRICELIST_UPDATE, GetDesc()->GetHandle(), &header, sizeof(TItemPriceListTable));
+	}
+	// END_OF_MYSHOP_PRICE_LIST
+	else if (CountSpecifyItem(50200))
+		RemoveSpecifyItem(50200, 1);
+	else
+		return; //   ߴ.
+
+	if (m_pkExchange)
+		m_pkExchange->Cancel();
+
+	TPacketGCShopSign p;
+
+	p.bHeader = HEADER_GC_SHOP_SIGN;
+	p.dwVID = GetVID();
+	strlcpy(p.szSign, c_pszSign, sizeof(p.szSign));
+#if defined(__MYSHOP_DECO__)
+	p.bType = GetMyShopDecoType();
+#endif
+
+	PacketAround(&p, sizeof(TPacketGCShopSign));
+
+	m_pkMyShop = CShopManager::instance().CreatePCShop(this, pTable, wItemCount);
+
+	if (IsPolymorphed() == true)
+	{
+		RemoveAffect(AFFECT_POLYMORPH);
+	}
+
+	if (GetHorse())
+	{
+		HorseSummon(false, true);
+	}
+	// new mount ̿ ߿,    ڵ unmount
+	// StopRiding Ʈ óϸ   ׷ س   .
+	else if (GetMountVnum())
+	{
+		RemoveAffect(AFFECT_MOUNT);
+		RemoveAffect(AFFECT_MOUNT_BONUS);
+	}
+
+#if defined(__MYSHOP_DECO__)
+	if (GetMyShopDecoPolyVnum() != 0)
+		SetPolymorph(GetMyShopDecoPolyVnum(), true);
+	else
+		SetPolymorph(30000, true);
+#else
+	SetPolymorph(30000, true);
+#endif
+}
+
+void CHARACTER::CloseMyShop()
+{
+	if (GetMyShop())
+	{
+		m_stShopSign.clear();
+		CShopManager::instance().DestroyPCShop(this);
+		m_pkMyShop = NULL;
+
+#if defined(__MYSHOP_DECO__)
+		SetMyShopDecoPolyVnum(0);
+		SetMyShopDecoType(0);
+		SetMyShopTabs(0);
+#endif
+
+		TPacketGCShopSign p;
+
+		p.bHeader = HEADER_GC_SHOP_SIGN;
+		p.dwVID = GetVID();
+		p.szSign[0] = '\0';
+#if defined(__MYSHOP_DECO__)
+		p.bType = 0;
+#endif
+
+		PacketAround(&p, sizeof(p));
+
+		SetPolymorph(m_points.job, true);
+#if defined(__PRIVATESHOP_SEARCH_SYSTEM__)
+		CTargetManager::instance().DeleteShopSearchTarget(static_cast<DWORD>(GetVID()));
+#endif
+	}
+}
+
+void EncodeMovePacket(TPacketGCMove& pack, DWORD dwVID, BYTE bFunc, BYTE bArg, DWORD x, DWORD y, DWORD dwDuration, DWORD dwTime, BYTE bRot)
+{
+	pack.bHeader = HEADER_GC_MOVE;
+	pack.bFunc = bFunc;
+	pack.bArg = bArg;
+	pack.dwVID = dwVID;
+	pack.dwTime = dwTime ? dwTime : get_dword_time();
+	pack.bRot = bRot;
+	pack.lX = x;
+	pack.lY = y;
+	pack.dwDuration = dwDuration;
+}
+
+void CHARACTER::RestartAtSamePos()
+{
+	if (m_bIsObserver)
+		return;
+
+	EncodeRemovePacket(this);
+	EncodeInsertPacket(this);
+
+	ENTITY_MAP::iterator it = m_map_view.begin();
+
+	while (it != m_map_view.end())
+	{
+		LPENTITY entity = (it++)->first;
+
+		EncodeRemovePacket(entity);
+		if (!m_bIsObserver)
+			EncodeInsertPacket(entity);
+
+		if (entity->IsType(ENTITY_CHARACTER))
+		{
+			LPCHARACTER lpChar = (LPCHARACTER)entity;
+			if (lpChar->IsPC() || lpChar->IsNPC() || lpChar->IsMonster())
+			{
+				if (!entity->IsObserverMode())
+					entity->EncodeInsertPacket(this);
+			}
+		}
+		else
+		{
+			if (!entity->IsObserverMode())
+			{
+				entity->EncodeInsertPacket(this);
+			}
+		}
+	}
+}
+
+// Entity  Ÿٰ Ŷ .
+void CHARACTER::EncodeInsertPacket(LPENTITY entity)
+{
+	LPDESC d;
+
+	if (!(d = entity->GetDesc()))
+		return;
+
+	// ̸   ڵ
+	LPCHARACTER ch = (LPCHARACTER)entity;
+	ch->SendGuildName(GetGuild());
+	// ̸   ڵ
+
+	TPacketGCCharacterAdd pack;
+
+	pack.header = HEADER_GC_CHARACTER_ADD;
+	pack.dwVID = m_vid;
+#if defined(__WJ_SHOW_MOB_INFO__)
+	if (IsMonster() || IsStone())
+	{
+		pack.dwLevel = GetLevel();
+		pack.dwAIFlag = IsMonster() ? GetAIFlag() : 0;
+	}
+	else
+	{
+		pack.dwLevel = 0;
+		pack.dwAIFlag = 0;
+	}
+#endif
+	pack.bType = GetCharType();
+	pack.angle = GetRotation();
+	pack.x = GetX();
+	pack.y = GetY();
+	pack.z = GetZ();
+	pack.wRaceNum = GetRaceNum();
+	pack.bMovingSpeed = (IsPet() || IsGrowthPet()) ? 150 : GetLimitPoint(POINT_MOV_SPEED);
+	pack.bAttackSpeed = GetLimitPoint(POINT_ATT_SPEED);
+	pack.dwAffectFlag[0] = m_afAffectFlag.bits[0];
+	pack.dwAffectFlag[1] = m_afAffectFlag.bits[1];
+
+	pack.bStateFlag = m_bAddChrState;
+
+	int iDur = 0;
+
+	if (m_posDest.x != pack.x || m_posDest.y != pack.y)
+	{
+		iDur = (m_dwMoveStartTime + m_dwMoveDuration) - get_dword_time();
+
+		if (iDur <= 0)
+		{
+			pack.x = m_posDest.x;
+			pack.y = m_posDest.y;
+		}
+	}
+
+	d->Packet(&pack, sizeof(pack));
+
+	if (IsPC() || CMobVnumHelper::IsNPCType(m_bCharType) || m_bCharType == CHAR_TYPE_PET)
+	{
+		TPacketGCCharacterAdditionalInfo addPacket;
+		memset(&addPacket, 0, sizeof(TPacketGCCharacterAdditionalInfo));
+
+		addPacket.header = HEADER_GC_CHAR_ADDITIONAL_INFO;
+		addPacket.dwVID = m_vid;
+
+		addPacket.awPart[CHR_EQUIPPART_ARMOR] = GetPart(PART_MAIN);
+		addPacket.awPart[CHR_EQUIPPART_WEAPON] = GetPart(PART_WEAPON);
+		addPacket.awPart[CHR_EQUIPPART_HEAD] = GetPart(PART_HEAD);
+		addPacket.awPart[CHR_EQUIPPART_HAIR] = GetPart(PART_HAIR);
+#if defined(__ACCE_COSTUME_SYSTEM__)
+		addPacket.awPart[CHR_EQUIPPART_ACCE] = GetPart(PART_ACCE);
+#endif
+#if defined(__QUIVER_SYSTEM__)
+		addPacket.dwArrow = (IsPC() && GetWear(WEAR_ARROW) != NULL) ? GetWear(WEAR_ARROW)->GetOriginalVnum() : 0;
+#endif
+
+		addPacket.bPKMode = m_bPKMode;
+		addPacket.dwMountVnum = GetMountVnum();
+		addPacket.bEmpire = m_bEmpire;
+		addPacket.dwLevel = 0;
+#if defined(__CONQUEROR_LEVEL__)
+		addPacket.dwConquerorLevel = IsPC() ? GetConquerorLevel() : 0;
+#endif
+		addPacket.dwGuildID = 0;
+#if defined(__GUILD_LEADER_GRADE_NAME__)
+		addPacket.bGuildLeaderGrade = 0;
+#endif
+#if defined(__GENDER_ALIGNMENT__)
+		addPacket.bJob = IsPC() ? m_points.job : 0;
+#endif
+#if defined(__SKILL_COLOR_SYSTEM__)
+		memcpy(addPacket.dwSkillColor, GetSkillColor(), sizeof(addPacket.dwSkillColor));
+#endif
+		addPacket.bLanguage = GetLanguage();
+
+		strlcpy(addPacket.name, GetName(), sizeof(addPacket.name));
+
+		if (IsPC() == true)
+		{
+			addPacket.dwLevel = GetLevel();
+		}
+	
+#ifdef __GROWTH_PET_SYSTEM__
+		if (IsGrowthPet())
+		{
+			addPacket.dwLevel = GetLevel();
+			addPacket.bCharacterSize = GetCharacterSize();
+		}
+#endif
+
+		if (GetGuild() != NULL)
+		{
+			addPacket.dwGuildID = GetGuild()->GetID();
+#if defined(__GUILD_LEADER_GRADE_NAME__)
+			CGuild* pGuild = this->GetGuild();
+			if (pGuild->GetMasterPID() == GetPlayerID())
+				addPacket.bGuildLeaderGrade = 3;
+			else if (pGuild->GetGeneralPID(GetPlayerID()) == true)
+				addPacket.bGuildLeaderGrade = 2;
+			else
+				addPacket.bGuildLeaderGrade = 1;
+#endif
+		}
+
+		addPacket.sAlignment = m_iAlignment / 10;
+
+		d->Packet(&addPacket, sizeof(TPacketGCCharacterAdditionalInfo));
+	}
+
+	if (iDur)
+	{
+		TPacketGCMove pack;
+		EncodeMovePacket(pack, GetVID(), FUNC_MOVE, 0, m_posDest.x, m_posDest.y, iDur, 0, (BYTE)(GetRotation() / 5));
+		d->Packet(&pack, sizeof(pack));
+
+		TPacketGCWalkMode p;
+		p.vid = GetVID();
+		p.header = HEADER_GC_WALK_MODE;
+		p.mode = m_bNowWalking ? WALKMODE_WALK : WALKMODE_RUN;
+
+		d->Packet(&p, sizeof(p));
+	}
+
+	if (entity->IsType(ENTITY_CHARACTER) && GetDesc())
+	{
+		LPCHARACTER ch = (LPCHARACTER)entity;
+		if (ch->IsWalking())
+		{
+			TPacketGCWalkMode p;
+			p.vid = ch->GetVID();
+			p.header = HEADER_GC_WALK_MODE;
+			p.mode = ch->m_bNowWalking ? WALKMODE_WALK : WALKMODE_RUN;
+			GetDesc()->Packet(&p, sizeof(p));
+		}
+	}
+
+	if (GetMyShop())
+	{
+		TPacketGCShopSign p;
+
+		p.bHeader = HEADER_GC_SHOP_SIGN;
+		p.dwVID = GetVID();
+		strlcpy(p.szSign, m_stShopSign.c_str(), sizeof(p.szSign));
+#if defined(__MYSHOP_DECO__)
+		p.bType = GetMyShopDecoType();
+#endif
+
+		d->Packet(&p, sizeof(TPacketGCShopSign));
+	}
+
+	if (entity->IsType(ENTITY_CHARACTER))
+	{
+		sys_log(3, "EntityInsert %s (RaceNum %d) (%d %d) TO %s",
+			GetName(), GetRaceNum(), GetX() / SECTREE_SIZE, GetY() / SECTREE_SIZE, ((LPCHARACTER)entity)->GetName());
+	}
+}
+
+void CHARACTER::EncodeRemovePacket(LPENTITY entity)
+{
+	if (entity->GetType() != ENTITY_CHARACTER)
+		return;
+
+	LPDESC d;
+
+	if (!(d = entity->GetDesc()))
+		return;
+
+	TPacketGCCharacterDelete pack;
+
+	pack.header = HEADER_GC_CHARACTER_DEL;
+	pack.id = m_vid;
+
+	d->Packet(&pack, sizeof(TPacketGCCharacterDelete));
+
+	if (entity->IsType(ENTITY_CHARACTER))
+		sys_log(3, "EntityRemove %s(%d) FROM %s", GetName(), (DWORD)m_vid, ((LPCHARACTER)entity)->GetName());
+}
+
+void CHARACTER::UpdatePacket()
+{
+	if (IsPC() && (!GetDesc() || !GetDesc()->GetCharacter()))
+		return;
+
+	if (GetSectree() == NULL)
+		return;
+
+	TPacketGCCharacterUpdate pack;
+	TPacketGCCharacterUpdate pack2;
+
+	pack.header = HEADER_GC_CHARACTER_UPDATE;
+	pack.dwVID = m_vid;
+
+	pack.awPart[CHR_EQUIPPART_ARMOR] = GetPart(PART_MAIN);
+	pack.awPart[CHR_EQUIPPART_WEAPON] = GetPart(PART_WEAPON);
+	pack.awPart[CHR_EQUIPPART_HEAD] = GetPart(PART_HEAD);
+	pack.awPart[CHR_EQUIPPART_HAIR] = GetPart(PART_HAIR);
+#if defined(__ACCE_COSTUME_SYSTEM__)
+	pack.awPart[CHR_EQUIPPART_ACCE] = GetPart(PART_ACCE);
+#endif
+#if defined(__QUIVER_SYSTEM__)
+	pack.dwArrow = GetWear(WEAR_ARROW) != NULL ? GetWear(WEAR_ARROW)->GetOriginalVnum() : 0;
+#endif
+
+#if defined(__SKILL_COLOR_SYSTEM__)
+	memcpy(pack.dwSkillColor, GetSkillColor(), sizeof(pack.dwSkillColor));
+#endif
+
+	pack.bMovingSpeed = GetLimitPoint(POINT_MOV_SPEED);
+	pack.bAttackSpeed = GetLimitPoint(POINT_ATT_SPEED);
+	pack.bStateFlag = m_bAddChrState;
+	pack.dwAffectFlag[0] = m_afAffectFlag.bits[0];
+	pack.dwAffectFlag[1] = m_afAffectFlag.bits[1];
+	pack.dwGuildID = GetGuild() ? GetGuild()->GetID() : 0;
+	pack.sAlignment = m_iAlignment / 10;
+	//pack.dwLevel = IsPC() ? GetLevel() : 0;
+	pack.dwLevel = GetLevel();
+#if defined(__CONQUEROR_LEVEL__)
+	pack.dwConquerorLevel = IsPC() ? GetConquerorLevel() : 0;
+#endif
+	pack.bPKMode = m_bPKMode;
+	pack.dwMountVnum = GetMountVnum();
+	pack.bLanguage = GetLanguage();
+
+#if defined(__GUILD_LEADER_GRADE_NAME__)
+	CGuild* pGuild = this->GetGuild();
+	if (pGuild)
+	{
+		if (pGuild->GetMasterPID() == GetPlayerID())
+			pack.bGuildLeaderGrade = 3;
+		else if (pGuild->GetGeneralPID(GetPlayerID()) == true)
+			pack.bGuildLeaderGrade = 2;
+		else
+			pack.bGuildLeaderGrade = 1;
+	}
+	else
+	{
+		pack.bGuildLeaderGrade = 0;
+	}
+#endif
+
+	pack2 = pack;
+	pack2.dwGuildID = 0;
+	pack2.sAlignment = 0;
+
+	if (false)
+	{
+		if (m_bIsObserver != true)
+		{
+			for (ENTITY_MAP::iterator iter = m_map_view.begin(); iter != m_map_view.end(); iter++)
+			{
+				LPENTITY pEntity = iter->first;
+
+				if (pEntity != NULL)
 				{
-					Show(GetMapIndex(),
-						pSectree->m_setting.iBaseX + GuildDragonLair_GetFactor(3, "PixelPosition", "InsideWatcher", "x") * 100,
-						pSectree->m_setting.iBaseY + GuildDragonLair_GetFactor(3, "PixelPosition", "InsideWatcher", "y") * 100, 0);
-					Stop();
+					if (pEntity->IsType(ENTITY_CHARACTER) == true)
+					{
+						if (pEntity->GetDesc() != NULL)
+						{
+							LPCHARACTER pChar = (LPCHARACTER)pEntity;
+
+							if (GetEmpire() == pChar->GetEmpire() || pChar->GetGMLevel() > GM_PLAYER)
+							{
+								pEntity->GetDesc()->Packet(&pack, sizeof(pack));
+							}
+							else
+							{
+								pEntity->GetDesc()->Packet(&pack2, sizeof(pack2));
+							}
+						}
+					}
+					else
+					{
+						if (pEntity->GetDesc() != NULL)
+						{
+							pEntity->GetDesc()->Packet(&pack, sizeof(pack));
+						}
+					}
 				}
+			}
+		}
+
+		if (GetDesc() != NULL)
+		{
+			GetDesc()->Packet(&pack, sizeof(pack));
+		}
+	}
+	else
+	{
+		PacketAround(&pack, sizeof(pack));
+	}
+}
+
+LPCHARACTER CHARACTER::FindCharacterInView(const char* c_pszName, bool bFindPCOnly)
+{
+	ENTITY_MAP::iterator it = m_map_view.begin();
+
+	for (; it != m_map_view.end(); ++it)
+	{
+		if (!it->first->IsType(ENTITY_CHARACTER))
+			continue;
+
+		LPCHARACTER tch = (LPCHARACTER)it->first;
+
+		if (bFindPCOnly && tch->IsNPC())
+			continue;
+
+		if (!strcasecmp(tch->GetName(), c_pszName))
+			return (tch);
+	}
+
+	return NULL;
+}
+
+void CHARACTER::SetPosition(int pos)
+{
+	if (pos == POS_STANDING)
+	{
+		REMOVE_BIT(m_bAddChrState, ADD_CHARACTER_STATE_DEAD);
+		REMOVE_BIT(m_pointsInstant.instant_flag, INSTANT_FLAG_STUN);
+
+		event_cancel(&m_pkDeadEvent);
+		event_cancel(&m_pkStunEvent);
+	}
+	else if (pos == POS_DEAD)
+		SET_BIT(m_bAddChrState, ADD_CHARACTER_STATE_DEAD);
+
+	if (!IsStone())
+	{
+		switch (pos)
+		{
+		case POS_FIGHTING:
+			if (!IsState(m_stateBattle))
+				MonsterLog("[BATTLE] ο ");
+
+			GotoState(m_stateBattle);
+			break;
+
+		default:
+			if (!IsState(m_stateIdle))
+				MonsterLog("[IDLE]  ");
+
+			GotoState(m_stateIdle);
+			break;
+		}
+	}
+
+	m_pointsInstant.position = pos;
+}
+
+void CHARACTER::Save()
+{
+	if (!m_bSkipSave)
+		CHARACTER_MANAGER::instance().DelayedSave(this);
+}
+
+void CHARACTER::CreatePlayerProto(TPlayerTable& tab)
+{
+	memset(&tab, 0, sizeof(TPlayerTable));
+
+	if (GetNewName().empty())
+	{
+		strlcpy(tab.name, GetName(), sizeof(tab.name));
+	}
+	else
+	{
+		strlcpy(tab.name, GetNewName().c_str(), sizeof(tab.name));
+	}
+
+	strlcpy(tab.ip, GetDesc()->GetHostName(), sizeof(tab.ip));
+
+	tab.id = m_dwPlayerID;
+	tab.voice = GetPoint(POINT_VOICE);
+	tab.level = GetLevel();
+	tab.level_step = GetPoint(POINT_LEVEL_STEP);
+	tab.exp = GetExp();
+	tab.gold = GetGold();
+#if defined(__CHEQUE_SYSTEM__)
+	tab.cheque = GetCheque();
+#endif
+#if defined(__GEM_SYSTEM__)
+	tab.gem = GetGem();
+#endif
+	tab.job = m_points.job;
+	tab.part_base = m_pointsInstant.bBasePart;
+	tab.skill_group = m_points.skill_group;
+
+	DWORD dwPlayedTime = (get_dword_time() - m_dwPlayStartTime);
+
+	if (dwPlayedTime > 60000)
+	{
+		if (GetSectree() && !GetSectree()->IsAttr(GetX(), GetY(), ATTR_BANPK))
+		{
+			if (GetRealAlignment() < 0)
+			{
+				if (IsEquipUniqueItem(UNIQUE_ITEM_FASTER_ALIGNMENT_UP_BY_TIME))
+					UpdateAlignment(120 * (dwPlayedTime / 60000));
 				else
-					CGuildDragonLairManager::Instance().Exit(this);
+					UpdateAlignment(60 * (dwPlayedTime / 60000));
+			}
+			else
+				UpdateAlignment(5 * (dwPlayedTime / 60000));
+		}
+
+		SetRealPoint(POINT_PLAYTIME, GetRealPoint(POINT_PLAYTIME) + dwPlayedTime / 60000);
+		ResetPlayTime(dwPlayedTime % 60000);
+	}
+
+	tab.playtime = GetRealPoint(POINT_PLAYTIME);
+	tab.lAlignment = m_iRealAlignment;
+
+	if (m_posWarp.x != 0 || m_posWarp.y != 0)
+	{
+		tab.x = m_posWarp.x;
+		tab.y = m_posWarp.y;
+		tab.z = 0;
+		tab.lMapIndex = m_lWarpMapIndex;
+	}
+	else
+	{
+		tab.x = GetX();
+		tab.y = GetY();
+		tab.z = GetZ();
+		tab.lMapIndex = GetMapIndex();
+	}
+
+	if (m_lExitMapIndex == 0)
+	{
+		tab.lExitMapIndex = tab.lMapIndex;
+		tab.lExitX = tab.x;
+		tab.lExitY = tab.y;
+	}
+	else
+	{
+		tab.lExitMapIndex = m_lExitMapIndex;
+		tab.lExitX = m_posExit.x;
+		tab.lExitY = m_posExit.y;
+	}
+
+	sys_log(0, "SAVE: %s %dx%d", GetName(), tab.x, tab.y);
+
+	tab.st = GetRealPoint(POINT_ST);
+	tab.ht = GetRealPoint(POINT_HT);
+	tab.dx = GetRealPoint(POINT_DX);
+	tab.iq = GetRealPoint(POINT_IQ);
+
+	tab.stat_point = GetPoint(POINT_STAT);
+	tab.skill_point = GetPoint(POINT_SKILL);
+	tab.sub_skill_point = GetPoint(POINT_SUB_SKILL);
+	tab.horse_skill_point = GetPoint(POINT_HORSE_SKILL);
+
+	tab.stat_reset_count = GetPoint(POINT_STAT_RESET_COUNT);
+
+	tab.hp = GetHP();
+	tab.sp = GetSP();
+
+	tab.stamina = GetStamina();
+
+	tab.sRandomHP = m_points.iRandomHP;
+	tab.sRandomSP = m_points.iRandomSP;
+
+	for (int i = 0; i < QUICKSLOT_MAX_NUM; ++i)
+		tab.quickslot[i] = m_quickslot[i];
+
+	thecore_memcpy(tab.parts, m_pointsInstant.parts, sizeof(tab.parts));
+
+	// REMOVE_REAL_SKILL_LEVLES
+	thecore_memcpy(tab.skills, m_pSkillLevels, sizeof(TPlayerSkill) * SKILL_MAX_NUM);
+	// END_OF_REMOVE_REAL_SKILL_LEVLES
+
+	tab.horse = GetHorseData();
+
+#if defined(__CONQUEROR_LEVEL__)
+	tab.conqueror_level = GetConquerorLevel();
+	tab.conqueror_level_step = GetPoint(POINT_CONQUEROR_LEVEL_STEP);
+	tab.conqueror_exp = GetConquerorExp();
+
+	tab.sungma_str = GetRealPoint(POINT_SUNGMA_STR);
+	tab.sungma_hp = GetRealPoint(POINT_SUNGMA_HP);
+	tab.sungma_move = GetRealPoint(POINT_SUNGMA_MOVE);
+	tab.sungma_immune = GetRealPoint(POINT_SUNGMA_IMMUNE);
+
+	tab.conqueror_point = GetPoint(POINT_CONQUEROR_POINT);
+#endif
+}
+
+void CHARACTER::SaveReal()
+{
+	if (m_bSkipSave)
+		return;
+
+	if (!GetDesc())
+	{
+		sys_err("Character::Save : no descriptor when saving (name: %s)", GetName());
+		return;
+	}
+
+	TPlayerTable table;
+	CreatePlayerProto(table);
+
+	db_clientdesc->DBPacket(HEADER_GD_PLAYER_SAVE, GetDesc()->GetHandle(), &table, sizeof(TPlayerTable));
+
+	quest::PC* pkQuestPC = quest::CQuestManager::instance().GetPCForce(GetPlayerID());
+
+	if (!pkQuestPC)
+		sys_err("CHARACTER::Save : null quest::PC pointer! (name %s)", GetName());
+	else
+	{
+		pkQuestPC->Save();
+	}
+
+	marriage::TMarriage* pMarriage = marriage::CManager::instance().Get(GetPlayerID());
+	if (pMarriage)
+		pMarriage->Save();
+}
+
+void CHARACTER::FlushDelayedSaveItem()
+{
+	//  ȵ ǰ  Ų.
+	LPITEM item;
+
+	for (int i = 0; i < INVENTORY_AND_EQUIP_SLOT_MAX; ++i)
+		if ((item = GetInventoryItem(i)))
+			ITEM_MANAGER::instance().FlushDelayedSave(item);
+}
+
+void CHARACTER::Disconnect(const char* c_pszReason)
+{
+	assert(GetDesc() != NULL);
+
+	sys_log(0, "DISCONNECT: %s (%s)", GetName(), c_pszReason ? c_pszReason : "unset");
+
+	if (GetShop())
+	{
+		GetShop()->RemoveGuest(this);
+		SetShop(NULL);
+	}
+
+	if (GetArena() != NULL)
+	{
+		GetArena()->OnDisconnect(GetPlayerID());
+	}
+
+	if (GetParty() != NULL)
+	{
+		GetParty()->UpdateOfflineState(GetPlayerID());
+	}
+
+	marriage::CManager::instance().Logout(this);
+
+	// P2P Logout
+	TPacketGGLogout p;
+	p.bHeader = HEADER_GG_LOGOUT;
+	strlcpy(p.szName, GetName(), sizeof(p.szName));
+	P2P_MANAGER::instance().Send(&p, sizeof(TPacketGGLogout));
+	char buf[51];
+#if defined(__CHEQUE_SYSTEM__) && defined(__GEM_SYSTEM__)
+	snprintf(buf, sizeof(buf), "%s %lld %d %d %d %ld %d",
+		inet_ntoa(GetDesc()->GetAddr().sin_addr), GetGold(), GetCheque(), GetGem(), g_bChannel, GetMapIndex(), GetAlignment());
+#elif defined(__CHEQUE_SYSTEM__)
+	snprintf(buf, sizeof(buf), "%s %lld %d %d %ld %d",
+		inet_ntoa(GetDesc()->GetAddr().sin_addr), GetGold(), GetCheque(), g_bChannel, GetMapIndex(), GetAlignment());
+#else
+	snprintf(buf, sizeof(buf), "%s %lld %d %ld %d",
+		inet_ntoa(GetDesc()->GetAddr().sin_addr), GetGold(), g_bChannel, GetMapIndex(), GetAlignment());
+#endif
+	LogManager::instance().CharLog(this, 0, "LOGOUT", buf);
+
+#if defined(__GUILD_DRAGONLAIR__)
+	if (MeleyLair::CMgr::instance().IsMeleyMap(GetMapIndex()))
+		MeleyLair::CMgr::instance().Leave(GetGuild(), this, false);
+#endif
+
+	if (LC_IsYMIR() || LC_IsKorea() || LC_IsBrazil())
+	{
+		long playTime = GetRealPoint(POINT_PLAYTIME) - m_dwLoginPlayTime;
+		LogManager::instance().LoginLog(false, GetDesc()->GetAccountTable().id, GetPlayerID(), GetLevel(), GetJob(), playTime);
+
+		if (LC_IsBrazil() != true)
+			CPCBangManager::instance().Log(GetDesc()->GetHostName(), GetPlayerID(), playTime);
+	}
+
+	if (m_pWarMap)
+		SetWarMap(NULL);
+
+	if (m_pWeddingMap)
+	{
+		SetWeddingMap(NULL);
+	}
+
+	if (GetGuild())
+		GetGuild()->LogoutMember(this);
+
+	quest::CQuestManager::instance().LogoutPC(this);
+
+	if (GetParty())
+		GetParty()->Unlink(this);
+
+	// ׾  Ӳ ġ ٰ ϱ
+	if (IsStun() || IsDead())
+	{
+		DeathPenalty(0);
+		PointChange(POINT_HP, 50 - GetHP());
+	}
+
+	if (!CHARACTER_MANAGER::instance().FlushDelayedSave(this))
+	{
+		SaveReal();
+	}
+
+	FlushDelayedSaveItem();
+
+	SaveAffect();
+	m_bIsLoadedAffect = false;
+
+	m_bSkipSave = true; //  Ŀ ̻ ϸ ȵȴ.
+
+	quest::CQuestManager::instance().DisconnectPC(this);
+
+	CloseSafebox();
+
+	CloseMall();
+
+	CPVPManager::instance().Disconnect(this);
+
+	CTargetManager::instance().Logout(GetPlayerID());
+
+	MessengerManager::instance().Logout(GetName());
+
+	if (GetDesc())
+	{
+#if defined(__IMPROVED_LOGOUT_POINTS__)
+		packet_point_change pack;
+		pack.header = HEADER_GC_CHARACTER_POINT_CHANGE;
+		pack.dwVID = m_vid;
+		pack.type = POINT_PLAYTIME;
+		pack.value = GetRealPoint(POINT_PLAYTIME) + (get_dword_time() - m_dwPlayStartTime) / 60000;
+		pack.amount = 0;
+		GetDesc()->Packet(&pack, sizeof(struct packet_point_change));
+#endif
+		GetDesc()->BindCharacter(NULL);
+		// BindDesc(NULL);
+	}
+
+	M2_DESTROY_CHARACTER(this);
+}
+
+#if defined(__WJ_SHOW_MOB_INFO__)
+bool CHARACTER::Show(long lMapIndex, long x, long y, long z, bool bShowSpawnMotion, bool bAggressive)
+#else
+bool CHARACTER::Show(long lMapIndex, long x, long y, long z, bool bShowSpawnMotion/* = false */)
+#endif
+{
+	LPSECTREE sectree = SECTREE_MANAGER::instance().Get(lMapIndex, x, y);
+
+	if (!sectree)
+	{
+		sys_log(0, "cannot find sectree by %dx%d mapindex %d", x, y, lMapIndex);
+		return false;
+	}
+
+	SetMapIndex(lMapIndex);
+
+	bool bChangeTree = false;
+
+	if (!GetSectree() || GetSectree() != sectree)
+		bChangeTree = true;
+
+	if (bChangeTree)
+	{
+		if (GetSectree())
+			GetSectree()->RemoveEntity(this);
+
+		ViewCleanup();
+	}
+
+	if (!IsNPC())
+	{
+		sys_log(0, "SHOW: %s %dx%dx%d", GetName(), x, y, z);
+		if (GetStamina() < GetMaxStamina())
+			StartAffectEvent();
+	}
+	else if (m_pkMobData)
+	{
+		m_pkMobInst->m_posLastAttacked.x = x;
+		m_pkMobInst->m_posLastAttacked.y = y;
+		m_pkMobInst->m_posLastAttacked.z = z;
+	}
+
+	if (bShowSpawnMotion)
+	{
+		SET_BIT(m_bAddChrState, ADD_CHARACTER_STATE_SPAWN);
+		m_afAffectFlag.Set(AFF_SPAWN);
+	}
+
+#if defined(__WJ_SHOW_MOB_INFO__)
+	if (bAggressive)
+		SetAggressive();
+#endif
+
+	SetXYZ(x, y, z);
+
+	m_posDest.x = x;
+	m_posDest.y = y;
+	m_posDest.z = z;
+
+	m_posStart.x = x;
+	m_posStart.y = y;
+	m_posStart.z = z;
+
+	if (bChangeTree)
+	{
+		EncodeInsertPacket(this);
+		sectree->InsertEntity(this);
+
+		UpdateSectree();
+	}
+	else
+	{
+		ViewReencode();
+		sys_log(0, "      in same sectree");
+	}
+
+	REMOVE_BIT(m_bAddChrState, ADD_CHARACTER_STATE_SPAWN);
+
+	SetValidComboInterval(0);
+	return true;
+}
+
+// BGM_INFO
+struct BGMInfo
+{
+	std::string name;
+	float vol;
+};
+
+typedef std::map<unsigned, BGMInfo> BGMInfoMap;
+
+static BGMInfoMap gs_bgmInfoMap;
+static bool gs_bgmVolEnable = false;
+
+void CHARACTER_SetBGMVolumeEnable()
+{
+	gs_bgmVolEnable = true;
+	sys_log(0, "bgm_info.set_bgm_volume_enable");
+}
+
+void CHARACTER_AddBGMInfo(unsigned mapIndex, const char* name, float vol)
+{
+	BGMInfo newInfo;
+	newInfo.name = name;
+	newInfo.vol = vol;
+
+	gs_bgmInfoMap[mapIndex] = newInfo;
+
+	sys_log(0, "bgm_info.add_info(%d, '%s', %f)", mapIndex, name, vol);
+}
+
+const BGMInfo& CHARACTER_GetBGMInfo(unsigned mapIndex)
+{
+	BGMInfoMap::iterator f = gs_bgmInfoMap.find(mapIndex);
+	if (gs_bgmInfoMap.end() == f)
+	{
+		static BGMInfo s_empty = { "", 0.0f };
+		return s_empty;
+	}
+	return f->second;
+}
+
+bool CHARACTER_IsBGMVolumeEnable()
+{
+	return gs_bgmVolEnable;
+}
+// END_OF_BGM_INFO
+
+void CHARACTER::MainCharacterPacket()
+{
+	const unsigned mapIndex = GetMapIndex();
+	const BGMInfo& bgmInfo = CHARACTER_GetBGMInfo(mapIndex);
+
+	// SUPPORT_BGM
+	if (!bgmInfo.name.empty())
+	{
+		if (CHARACTER_IsBGMVolumeEnable())
+		{
+			sys_log(1, "bgm_info.play_bgm_vol(%d, name='%s', vol=%f)", mapIndex, bgmInfo.name.c_str(), bgmInfo.vol);
+			TPacketGCMainCharacter4_BGM_VOL mainChrPacket;
+			mainChrPacket.header = HEADER_GC_MAIN_CHARACTER4_BGM_VOL;
+			mainChrPacket.dwVID = m_vid;
+			mainChrPacket.wRaceNum = GetRaceNum();
+			mainChrPacket.lx = GetX();
+			mainChrPacket.ly = GetY();
+			mainChrPacket.lz = GetZ();
+			mainChrPacket.empire = GetDesc()->GetEmpire();
+			mainChrPacket.skill_group = GetSkillGroup();
+			strlcpy(mainChrPacket.szChrName, GetName(), sizeof(mainChrPacket.szChrName));
+
+			mainChrPacket.fBGMVol = bgmInfo.vol;
+			strlcpy(mainChrPacket.szBGMName, bgmInfo.name.c_str(), sizeof(mainChrPacket.szBGMName));
+			GetDesc()->Packet(&mainChrPacket, sizeof(TPacketGCMainCharacter4_BGM_VOL));
+		}
+		else
+		{
+			sys_log(1, "bgm_info.play(%d, '%s')", mapIndex, bgmInfo.name.c_str());
+			TPacketGCMainCharacter3_BGM mainChrPacket;
+			mainChrPacket.header = HEADER_GC_MAIN_CHARACTER3_BGM;
+			mainChrPacket.dwVID = m_vid;
+			mainChrPacket.wRaceNum = GetRaceNum();
+			mainChrPacket.lx = GetX();
+			mainChrPacket.ly = GetY();
+			mainChrPacket.lz = GetZ();
+			mainChrPacket.empire = GetDesc()->GetEmpire();
+			mainChrPacket.skill_group = GetSkillGroup();
+			strlcpy(mainChrPacket.szChrName, GetName(), sizeof(mainChrPacket.szChrName));
+			strlcpy(mainChrPacket.szBGMName, bgmInfo.name.c_str(), sizeof(mainChrPacket.szBGMName));
+			GetDesc()->Packet(&mainChrPacket, sizeof(TPacketGCMainCharacter3_BGM));
+		}
+	}
+	// END_OF_SUPPORT_BGM
+	else
+	{
+		sys_log(0, "bgm_info.play(%d, DEFAULT_BGM_NAME)", mapIndex);
+
+		TPacketGCMainCharacter pack;
+		pack.header = HEADER_GC_MAIN_CHARACTER;
+		pack.dwVID = m_vid;
+		pack.wRaceNum = GetRaceNum();
+		pack.lx = GetX();
+		pack.ly = GetY();
+		pack.lz = GetZ();
+		pack.empire = GetDesc()->GetEmpire();
+		pack.skill_group = GetSkillGroup();
+		strlcpy(pack.szName, GetName(), sizeof(pack.szName));
+		GetDesc()->Packet(&pack, sizeof(TPacketGCMainCharacter));
+	}
+}
+
+void CHARACTER::PointsPacket()
+{
+	if (!GetDesc())
+		return;
+
+	TPacketGCPoints pack;
+
+	pack.header = HEADER_GC_CHARACTER_POINTS;
+
+	pack.points[POINT_LEVEL] = GetLevel();
+	pack.points[POINT_EXP] = GetExp();
+	pack.points[POINT_NEXT_EXP] = GetNextExp();
+	pack.points[POINT_HP] = GetHP();
+	pack.points[POINT_MAX_HP] = GetMaxHP();
+	pack.points[POINT_SP] = GetSP();
+	pack.points[POINT_MAX_SP] = GetMaxSP();
+	pack.points[POINT_GOLD] = GetGold();
+	pack.points[POINT_STAMINA] = GetStamina();
+	pack.points[POINT_MAX_STAMINA] = GetMaxStamina();
+
+	for (int i = POINT_ST; i < POINT_MAX_NUM; ++i)
+		pack.points[i] = GetPoint(i);
+
+#if defined(__CONQUEROR_LEVEL__)
+	pack.points[POINT_CONQUEROR_LEVEL] = GetConquerorLevel();
+	pack.points[POINT_CONQUEROR_EXP] = GetConquerorExp();
+	pack.points[POINT_CONQUEROR_NEXT_EXP] = GetConquerorNextExp();
+
+	pack.points[POINT_MOV_SPEED] = GetLimitPoint(POINT_MOV_SPEED);
+#endif
+
+#if defined(__CHEQUE_SYSTEM__)
+	pack.points[POINT_CHEQUE] = GetCheque();
+#endif
+#if defined(__GEM_SYSTEM__)
+	pack.points[POINT_GEM] = GetGem();
+#endif
+
+	GetDesc()->Packet(&pack, sizeof(TPacketGCPoints));
+}
+
+void CHARACTER::UpdatePointsPacket(BYTE type, long long val, long long amount, bool bAmount, bool bBroadcast)
+{
+	if (GetDesc())
+	{
+		struct packet_point_change pack;
+
+#if defined(__CONQUEROR_LEVEL__)
+		switch (type)
+		{
+		case POINT_MOV_SPEED:
+			if (GetSungMaWill(POINT_SUNGMA_MOVE) > GetPoint(POINT_SUNGMA_MOVE))
+				val /= 2;
+			break;
+		}
+#endif
+
+		pack.header = HEADER_GC_CHARACTER_POINT_CHANGE;
+		pack.dwVID = m_vid;
+		pack.type = type;
+		pack.value = val;
+
+		if (bAmount)
+			pack.amount = amount;
+		else
+			pack.amount = 0;
+
+		if (!bBroadcast)
+			GetDesc()->Packet(&pack, sizeof(struct packet_point_change));
+		else
+			PacketAround(&pack, sizeof(pack));
+	}
+}
+
+bool CHARACTER::ChangeSex()
+{
+	int src_race = GetRaceNum();
+
+	switch (src_race)
+	{
+	case MAIN_RACE_WARRIOR_M:
+		m_points.job = MAIN_RACE_WARRIOR_W;
+		break;
+
+	case MAIN_RACE_WARRIOR_W:
+		m_points.job = MAIN_RACE_WARRIOR_M;
+		break;
+
+	case MAIN_RACE_ASSASSIN_M:
+		m_points.job = MAIN_RACE_ASSASSIN_W;
+		break;
+
+	case MAIN_RACE_ASSASSIN_W:
+		m_points.job = MAIN_RACE_ASSASSIN_M;
+		break;
+
+	case MAIN_RACE_SURA_M:
+		m_points.job = MAIN_RACE_SURA_W;
+		break;
+
+	case MAIN_RACE_SURA_W:
+		m_points.job = MAIN_RACE_SURA_M;
+		break;
+
+	case MAIN_RACE_SHAMAN_M:
+		m_points.job = MAIN_RACE_SHAMAN_W;
+		break;
+
+	case MAIN_RACE_SHAMAN_W:
+		m_points.job = MAIN_RACE_SHAMAN_M;
+		break;
+
+	case MAIN_RACE_WOLFMAN_M:
+		m_points.job = MAIN_RACE_WOLFMAN_M;
+		break;
+
+	default:
+		sys_err("CHANGE_SEX: %s unknown race %d", GetName(), src_race);
+		return false;
+	}
+
+	sys_log(0, "CHANGE_SEX: %s (%d -> %d)", GetName(), src_race, m_points.job);
+	return true;
+}
+
+bool CHARACTER::IsMale() const
+{
+	switch (GetRaceNum())
+	{
+	case MAIN_RACE_WARRIOR_M:
+	case MAIN_RACE_SURA_M:
+	case MAIN_RACE_ASSASSIN_M:
+	case MAIN_RACE_SHAMAN_M:
+	case MAIN_RACE_WOLFMAN_M:
+		return true;
+	}
+	return false;
+}
+
+bool CHARACTER::IsFemale() const
+{
+	switch (GetRaceNum())
+	{
+	case MAIN_RACE_ASSASSIN_W:
+	case MAIN_RACE_SHAMAN_W:
+	case MAIN_RACE_WARRIOR_W:
+	case MAIN_RACE_SURA_W:
+		return true;
+	}
+	return false;
+}
+
+WORD CHARACTER::GetRaceNum() const
+{
+	if (m_dwPolymorphRace)
+		return m_dwPolymorphRace;
+
+	if (m_pkMobData)
+		return m_pkMobData->m_table.dwVnum;
+
+	return m_points.job;
+}
+
+void CHARACTER::SetRace(BYTE race)
+{
+	if (race >= MAIN_RACE_MAX_NUM)
+	{
+		sys_err("CHARACTER::SetRace(name=%s, race=%d).OUT_OF_RACE_RANGE", GetName(), race);
+		return;
+	}
+
+	m_points.job = race;
+}
+
+BYTE CHARACTER::GetJob() const
+{
+	unsigned race = m_points.job;
+	unsigned job;
+
+	if (RaceToJob(race, &job))
+		return job;
+
+	sys_err("CHARACTER::GetJob(name=%s, race=%d).OUT_OF_RACE_RANGE", GetName(), race);
+	return JOB_WARRIOR;
+}
+
+void CHARACTER::SetLevel(BYTE level)
+{
+	m_points.level = level;
+
+	if (IsPC())
+	{
+		if (level < PK_PROTECT_LEVEL)
+			SetPKMode(PK_MODE_PROTECT);
+		else if (GetGMLevel() != GM_PLAYER)
+			SetPKMode(PK_MODE_PROTECT);
+		else if (m_bPKMode == PK_MODE_PROTECT)
+			SetPKMode(PK_MODE_PEACE);
+	}
+}
+
+void CHARACTER::SetEmpire(BYTE bEmpire)
+{
+	m_bEmpire = bEmpire;
+}
+
+void CHARACTER::SetPlayerProto(const TPlayerTable* t)
+{
+	if (!GetDesc() || !*GetDesc()->GetHostName())
+		sys_err("cannot get desc or hostname");
+	else
+		SetGMLevel();
+
+	m_bCharType = CHAR_TYPE_PC;
+
+	m_dwPlayerID = t->id;
+
+	m_iAlignment = t->lAlignment;
+	m_iRealAlignment = t->lAlignment;
+
+	m_points.voice = t->voice;
+
+	m_points.skill_group = t->skill_group;
+
+	m_pointsInstant.bBasePart = t->part_base;
+	SetPart(PART_HAIR, t->parts[PART_HAIR]);
+#if defined(__ACCE_COSTUME_SYSTEM__)
+	SetPart(PART_ACCE, t->parts[PART_ACCE]);
+#endif
+
+	m_points.iRandomHP = t->sRandomHP;
+	m_points.iRandomSP = t->sRandomSP;
+
+	// REMOVE_REAL_SKILL_LEVLES
+	if (m_pSkillLevels)
+		M2_DELETE_ARRAY(m_pSkillLevels);
+
+	m_pSkillLevels = M2_NEW TPlayerSkill[SKILL_MAX_NUM];
+	thecore_memcpy(m_pSkillLevels, t->skills, sizeof(TPlayerSkill) * SKILL_MAX_NUM);
+	// END_OF_REMOVE_REAL_SKILL_LEVLES
+
+	if (t->lMapIndex >= 10000)
+	{
+		m_posWarp.x = t->lExitX;
+		m_posWarp.y = t->lExitY;
+		m_lWarpMapIndex = t->lExitMapIndex;
+	}
+
+	SetRealPoint(POINT_PLAYTIME, t->playtime);
+	m_dwLoginPlayTime = t->playtime;
+	SetRealPoint(POINT_ST, t->st);
+	SetRealPoint(POINT_HT, t->ht);
+	SetRealPoint(POINT_DX, t->dx);
+	SetRealPoint(POINT_IQ, t->iq);
+
+	SetPoint(POINT_ST, t->st);
+	SetPoint(POINT_HT, t->ht);
+	SetPoint(POINT_DX, t->dx);
+	SetPoint(POINT_IQ, t->iq);
+
+	SetPoint(POINT_STAT, t->stat_point);
+	SetPoint(POINT_SKILL, t->skill_point);
+	SetPoint(POINT_SUB_SKILL, t->sub_skill_point);
+	SetPoint(POINT_HORSE_SKILL, t->horse_skill_point);
+
+	SetPoint(POINT_STAT_RESET_COUNT, t->stat_reset_count);
+
+	SetPoint(POINT_LEVEL_STEP, t->level_step);
+	SetRealPoint(POINT_LEVEL_STEP, t->level_step);
+
+	SetRace(t->job);
+
+	SetLevel(t->level);
+	SetExp(t->exp);
+	SetGold(t->gold);
+#if defined(__CHEQUE_SYSTEM__)
+	SetCheque(t->cheque);
+#endif
+#if defined(__GEM_SYSTEM__)
+	SetGem(t->gem);
+#endif
+
+#if defined(__CONQUEROR_LEVEL__)
+	SetRealPoint(POINT_SUNGMA_STR, t->sungma_str);
+	SetRealPoint(POINT_SUNGMA_HP, t->sungma_hp);
+	SetRealPoint(POINT_SUNGMA_MOVE, t->sungma_move);
+	SetRealPoint(POINT_SUNGMA_IMMUNE, t->sungma_immune);
+
+	SetPoint(POINT_SUNGMA_STR, t->sungma_str);
+	SetPoint(POINT_SUNGMA_HP, t->sungma_hp);
+	SetPoint(POINT_SUNGMA_MOVE, t->sungma_move);
+	SetPoint(POINT_SUNGMA_IMMUNE, t->sungma_immune);
+
+	SetPoint(POINT_CONQUEROR_POINT, t->conqueror_point);
+
+	SetPoint(POINT_CONQUEROR_LEVEL_STEP, t->conqueror_level_step);
+	SetRealPoint(POINT_CONQUEROR_LEVEL_STEP, t->conqueror_level_step);
+
+	SetConquerorLevel(t->conqueror_level);
+	SetConquerorExp(t->conqueror_exp);
+#endif
+
+	SetMapIndex(t->lMapIndex);
+	SetXYZ(t->x, t->y, t->z);
+
+	ComputePoints();
+
+	SetHP(t->hp);
+	SetSP(t->sp);
+	SetStamina(t->stamina);
+
+	// GM϶ ȣ
+	if (GetGMLevel() > GM_LOW_WIZARD)
+		m_afAffectFlag.Set(AFF_YMIR);
+
+	if (GetLevel() < PK_PROTECT_LEVEL)
+		m_bPKMode = PK_MODE_PROTECT;
+
+	SetHorseData(t->horse);
+
+	if (GetHorseLevel() > 0)
+		UpdateHorseDataByLogoff(t->logoff_interval);
+
+	thecore_memcpy(m_aiPremiumTimes, t->aiPremiumTimes, sizeof(t->aiPremiumTimes));
+
+	m_dwLogOffInterval = t->logoff_interval;
+	m_dwLastAttackTime = t->last_play;
+
+	sys_log(0, "PLAYER_LOAD: %s PREMIUM %d %d, LOGGOFF_INTERVAL %u PTR: %p", t->name, m_aiPremiumTimes[0], m_aiPremiumTimes[1], t->logoff_interval, this);
+
+	if (GetGMLevel() != GM_PLAYER)
+	{
+		LogManager::instance().CharLog(this, GetGMLevel(), "GM_LOGIN", "");
+		sys_log(0, "GM_LOGIN(gmlevel=%d, name=%s(%d), pos=(%d, %d)", GetGMLevel(), GetName(), GetPlayerID(), GetX(), GetY());
+	}
+
+#if defined(__PET_SYSTEM__)
+	// NOTE: ϴ ĳͰ PC 쿡 PetSystem  .  ӽŴ ޸  NPC ϱ ..
+	if (m_petSystem)
+	{
+		m_petSystem->Destroy();
+		delete m_petSystem;
+	}
+
+	m_petSystem = M2_NEW CPetSystem(this);
+#endif
+}
+
+EVENTFUNC(kill_ore_load_event)
+{
+	char_event_info* info = dynamic_cast<char_event_info*>(event->info);
+	if (info == NULL)
+	{
+		sys_err("kill_ore_load_even> <Factor> Null pointer");
+		return 0;
+	}
+
+	LPCHARACTER ch = info->ch;
+
+	if (ch == NULL) // <Factor>
+		return 0;
+
+	ch->m_pkMiningEvent = NULL;
+	M2_DESTROY_CHARACTER(ch);
+	return 0;
+}
+
+void CHARACTER::SetProto(const CMob* pkMob)
+{
+	if (m_pkMobInst)
+		M2_DELETE(m_pkMobInst);
+
+	m_pkMobData = pkMob;
+	m_pkMobInst = M2_NEW CMobInstance;
+
+	m_bPKMode = PK_MODE_FREE;
+
+	const TMobTable* t = &m_pkMobData->m_table;
+
+	m_bCharType = t->bType;
+
+	SetLevel(t->bLevel);
+	SetEmpire(t->bEmpire);
+
+	SetExp(t->dwExp);
+	SetRealPoint(POINT_ST, t->bStr);
+	SetRealPoint(POINT_DX, t->bDex);
+	SetRealPoint(POINT_HT, t->bCon);
+	SetRealPoint(POINT_IQ, t->bInt);
+
+	ComputePoints();
+
+	SetHP(GetMaxHP());
+	SetSP(GetMaxSP());
+
+	////////////////////
+	m_pointsInstant.dwAIFlag = t->dwAIFlag;
+	SetImmuneFlag(t->dwImmuneFlag);
+
+	AssignTriggers(t);
+
+	ApplyMobAttribute(t);
+
+	if (IsStone())
+	{
+		DetermineDropMetinStone();
+	}
+
+	if (IsWarp() || IsGoto())
+	{
+		StartWarpNPCEvent();
+	}
+
+	CHARACTER_MANAGER::instance().RegisterRaceNumMap(this);
+
+#if defined(__TEMPLE_OCHAO__)
+	/*
+	if (GetRaceNum() == TempleOchao::PORTAL)
+		m_dwPlayStartTime = get_dword_time() + 60 * 1000;
+	*/
+#endif
+
+	// XXX X-mas santa hardcoding
+	if (GetRaceNum() == xmas::MOB_SANTA_VNUM)
+	{
+		SetPoint(POINT_ATT_GRADE_BONUS, 10);
+		if (g_iUseLocale)
+			SetPoint(POINT_DEF_GRADE_BONUS, 6);
+		else
+			SetPoint(POINT_DEF_GRADE_BONUS, 15);
+
+		//Ÿ
+		//m_dwPlayStartTime = get_dword_time() + 10 * 60 * 1000;
+		//ż  
+		m_dwPlayStartTime = get_dword_time() + 30 * 1000;
+		if (test_server)
+			m_dwPlayStartTime = get_dword_time() + 30 * 1000;
+	}
+
+	// XXX CTF GuildWar hardcoding
+	if (warmap::IsWarFlag(GetRaceNum()))
+	{
+		m_stateIdle.Set(this, &CHARACTER::BeginStateEmpty, &CHARACTER::StateFlag, &CHARACTER::EndStateEmpty);
+		m_stateMove.Set(this, &CHARACTER::BeginStateEmpty, &CHARACTER::StateFlag, &CHARACTER::EndStateEmpty);
+		m_stateBattle.Set(this, &CHARACTER::BeginStateEmpty, &CHARACTER::StateFlag, &CHARACTER::EndStateEmpty);
+	}
+
+	if (warmap::IsWarFlagBase(GetRaceNum()))
+	{
+		m_stateIdle.Set(this, &CHARACTER::BeginStateEmpty, &CHARACTER::StateFlagBase, &CHARACTER::EndStateEmpty);
+		m_stateMove.Set(this, &CHARACTER::BeginStateEmpty, &CHARACTER::StateFlagBase, &CHARACTER::EndStateEmpty);
+		m_stateBattle.Set(this, &CHARACTER::BeginStateEmpty, &CHARACTER::StateFlagBase, &CHARACTER::EndStateEmpty);
+	}
+
+	if (IsHorse() ||
+		GetRaceNum() == 20101 ||
+		GetRaceNum() == 20102 ||
+		GetRaceNum() == 20103 ||
+		GetRaceNum() == 20104 ||
+		GetRaceNum() == 20105 ||
+		GetRaceNum() == 20106 ||
+		GetRaceNum() == 20107 ||
+		GetRaceNum() == 20108 ||
+		GetRaceNum() == 20109
+		)
+	{
+		m_stateIdle.Set(this, &CHARACTER::BeginStateEmpty, &CHARACTER::StateHorse, &CHARACTER::EndStateEmpty);
+		m_stateMove.Set(this, &CHARACTER::BeginStateEmpty, &CHARACTER::StateMove, &CHARACTER::EndStateEmpty);
+		m_stateBattle.Set(this, &CHARACTER::BeginStateEmpty, &CHARACTER::StateHorse, &CHARACTER::EndStateEmpty);
+	}
+
+	// MINING
+	if (mining::IsVeinOfOre(GetRaceNum()))
+	{
+		char_event_info* info = AllocEventInfo<char_event_info>();
+
+		info->ch = this;
+
+		m_pkMiningEvent = event_create(kill_ore_load_event, info, PASSES_PER_SEC(number(7 * 60, 15 * 60)));
+	}
+	// END_OF_MINING
+}
+
+const TMobTable& CHARACTER::GetMobTable() const
+{
+	return m_pkMobData->m_table;
+}
+
+bool CHARACTER::IsRaceFlag(DWORD dwBit) const
+{
+	return m_pkMobData ? IS_SET(m_pkMobData->m_table.dwRaceFlag, dwBit) : 0;
+}
+
+DWORD CHARACTER::GetMobDamageMin() const
+{
+	return m_pkMobData->m_table.dwDamageRange[0];
+}
+
+DWORD CHARACTER::GetMobDamageMax() const
+{
+	return m_pkMobData->m_table.dwDamageRange[1];
+}
+
+float CHARACTER::GetMobDamageMultiply() const
+{
+	float fDamMultiply = GetMobTable().fDamMultiply;
+
+	if (IsBerserk())
+		fDamMultiply = fDamMultiply * 2.0f; // BALANCE: ȭ  ι
+
+	return fDamMultiply;
+}
+
+#if defined(__ELEMENT_SYSTEM__)
+int CHARACTER::GetMobElement(BYTE bElement) const
+{
+	if (bElement >= 0 && bElement < MOB_ELEMENT_MAX_NUM)
+		return m_pkMobData->m_table.cElements[bElement];
+	return 0;
+}
+#endif
+
+DWORD CHARACTER::GetMobDropItemVnum() const
+{
+	return m_pkMobData->m_table.dwDropItemVnum;
+}
+
+bool CHARACTER::IsSummonMonster() const
+{
+	return GetSummonVnum() != 0;
+}
+
+bool CHARACTER::CanSummonMonster() const
+{
+#if defined(__EREBUS_DUNGEON__)
+	if (GetRaceNum() == THUNDER_BOSS)
+	{
+		if (thecore_pulse() > m_iLastHealerSummonDelay)
+			return true;
+
+		return false;
+	}
+#endif
+
+	if (!IsSummonMonster())
+		return false;
+
+	return (thecore_pulse() > m_lastSummonTime + PASSES_PER_SEC(m_newSummonInterval));
+}
+
+void CHARACTER::MarkSummonedMonster()
+{
+	m_lastSummonTime = thecore_pulse();
+	m_newSummonInterval = number(g_npcGroupRespawnRange[0], g_npcGroupRespawnRange[1]);
+}
+
+DWORD CHARACTER::GetSummonVnum() const
+{
+	return m_pkMobData ? m_pkMobData->m_table.dwSummonVnum : 0;
+}
+
+DWORD CHARACTER::GetPolymorphItemVnum() const
+{
+	return m_pkMobData ? m_pkMobData->m_table.dwPolymorphItemVnum : 0;
+}
+
+DWORD CHARACTER::GetMonsterDrainSPPoint() const
+{
+	return m_pkMobData ? m_pkMobData->m_table.dwDrainSP : 0;
+}
+
+BYTE CHARACTER::GetMobRank() const
+{
+	if (!m_pkMobData)
+		return MOB_RANK_KNIGHT; // PC  KNIGHT
+
+	return m_pkMobData->m_table.bRank;
+}
+
+BYTE CHARACTER::GetMobSize() const
+{
+	if (!m_pkMobData)
+		return MOBSIZE_MEDIUM;
+
+	return m_pkMobData->m_table.bSize;
+}
+
+WORD CHARACTER::GetMobAttackRange() const
+{
+	switch (GetMobBattleType())
+	{
+	case BATTLE_TYPE_RANGE:
+	case BATTLE_TYPE_MAGIC:
+		return m_pkMobData->m_table.wAttackRange + GetPoint(POINT_BOW_DISTANCE);
+	default:
+		return m_pkMobData->m_table.wAttackRange;
+	}
+}
+
+BYTE CHARACTER::GetMobBattleType() const
+{
+	if (!m_pkMobData)
+		return BATTLE_TYPE_MELEE;
+
+	return (m_pkMobData->m_table.bBattleType);
+}
+
+void CHARACTER::ComputeBattlePoints()
+{
+	if (IsPolymorphed())
+	{
+		DWORD dwMobVnum = GetPolymorphVnum();
+		const CMob* pMob = CMobManager::instance().Get(dwMobVnum);
+		int iAtt = 0;
+		int iDef = 0;
+
+		if (pMob)
+		{
+			iAtt = GetLevel() * 2 + GetPolymorphPoint(POINT_ST) * 2;
+			// lev + con
+			iDef = GetLevel() + GetPolymorphPoint(POINT_HT) + pMob->m_table.wDef;
+		}
+
+		SetPoint(POINT_ATT_GRADE, iAtt);
+		SetPoint(POINT_DEF_GRADE, iDef);
+		SetPoint(POINT_MAGIC_ATT_GRADE, GetPoint(POINT_ATT_GRADE));
+		SetPoint(POINT_MAGIC_DEF_GRADE, GetPoint(POINT_DEF_GRADE));
+	}
+	else if (IsPC())
+	{
+		SetPoint(POINT_ATT_GRADE, 0);
+		SetPoint(POINT_DEF_GRADE, 0);
+		SetPoint(POINT_CLIENT_DEF_GRADE, 0);
+		SetPoint(POINT_MAGIC_ATT_GRADE, GetPoint(POINT_ATT_GRADE));
+		SetPoint(POINT_MAGIC_DEF_GRADE, GetPoint(POINT_DEF_GRADE));
+
+		//
+		// ⺻ ATK = 2lev + 2str,   2str ٲ  
+		//
+		int iAtk = GetLevel() * 2;
+		int iStatAtk = 0;
+
+		switch (GetJob())
+		{
+		case JOB_WARRIOR:
+		case JOB_SURA:
+			iStatAtk = (2 * GetPoint(POINT_ST));
+			break;
+
+		case JOB_ASSASSIN:
+			iStatAtk = (4 * GetPoint(POINT_ST) + 2 * GetPoint(POINT_DX)) / 3;
+			break;
+
+		case JOB_SHAMAN:
+			iStatAtk = (4 * GetPoint(POINT_ST) + 2 * GetPoint(POINT_IQ)) / 3;
+			break;
+
+		case JOB_WOLFMAN:
+			iStatAtk = (2 * GetPoint(POINT_ST));
+			break;
+
+		default:
+			sys_err("invalid job %d", GetJob());
+			iStatAtk = (2 * GetPoint(POINT_ST));
+			break;
+		}
+
+		//  Ÿ ְ,   ݷ ST*2   ST*2 Ѵ.
+		//  ߸   ݷ   ʰ ϱ ؼ.
+		if (GetMountVnum() && iStatAtk < 2 * GetPoint(POINT_ST))
+			iStatAtk = (2 * GetPoint(POINT_ST));
+
+		iAtk += iStatAtk;
+
+		// ¸() : ˼  
+		if (GetMountVnum())
+		{
+			if (GetJob() == JOB_SURA && GetSkillGroup() == 1)
+			{
+				iAtk += (iAtk * GetHorseLevel()) / 60;
+			}
+			else
+			{
+				iAtk += (iAtk * GetHorseLevel()) / 30;
+			}
+		}
+
+		//
+		// ATK Setting
+		//
+		iAtk += GetPoint(POINT_ATT_GRADE_BONUS);
+
+		PointChange(POINT_ATT_GRADE, iAtk);
+
+		// DEF = LEV + CON + ARMOR
+		int iShowDef = GetLevel() + GetPoint(POINT_HT); // For Ymir(õ)
+		int iDef = GetLevel() + (int)(GetPoint(POINT_HT) / 1.25); // For Other
+		int iArmor = 0;
+
+		LPITEM pkItem;
+
+		for (int i = 0; i < WEAR_MAX_NUM; ++i)
+		{
+			if (((pkItem = GetWear(i))) && pkItem->GetType() == ITEM_ARMOR)
+			{
+
+				if (pkItem->GetSubType() == ARMOR_BODY
+					|| pkItem->GetSubType() == ARMOR_HEAD
+					|| pkItem->GetSubType() == ARMOR_FOOTS
+					|| pkItem->GetSubType() == ARMOR_SHIELD
+#if defined(__PENDANT_SYSTEM__)
+					|| pkItem->GetSubType() == ARMOR_PENDANT
+#endif
+#if defined(__GLOVE_SYSTEM__)
+					|| pkItem->GetSubType() == ARMOR_GLOVE
+#endif
+					)
+				{
+					iArmor += pkItem->GetValue(1);
+					iArmor += (2 * pkItem->GetValue(5));
+				}
+			}
+		}
+
+		//  Ÿ      º    
+		if (true == IsHorseRiding())
+		{
+			if (iArmor < GetHorseArmor())
+				iArmor = GetHorseArmor();
+
+			const char* pHorseName = CHorseNameManager::instance().GetHorseName(GetPlayerID());
+
+			if (pHorseName != NULL && strlen(pHorseName))
+			{
+				iArmor += 20;
+			}
+		}
+
+		iArmor += GetPoint(POINT_DEF_GRADE_BONUS);
+		iArmor += GetPoint(POINT_PARTY_DEFENDER_BONUS);
+
+		PointChange(POINT_DEF_GRADE, iDef + iArmor);
+		PointChange(POINT_CLIENT_DEF_GRADE, (iShowDef + iArmor) - GetPoint(POINT_DEF_GRADE));
+		PointChange(POINT_MAGIC_ATT_GRADE, GetLevel() * 2 + GetPoint(POINT_IQ) * 2 + GetPoint(POINT_MAGIC_ATT_GRADE_BONUS));
+		PointChange(POINT_MAGIC_DEF_GRADE, GetLevel() + (GetPoint(POINT_IQ) * 3 + GetPoint(POINT_HT)) / 3 + iArmor / 2 + GetPoint(POINT_MAGIC_DEF_GRADE_BONUS));
+	}
+	else
+	{
+		// 2lev + str * 2
+		int iAtt = GetLevel() * 2 + GetPoint(POINT_ST) * 2;
+		// lev + con
+		int iDef = GetLevel() + GetPoint(POINT_HT) + GetMobTable().wDef;
+
+		SetPoint(POINT_ATT_GRADE, iAtt);
+		SetPoint(POINT_DEF_GRADE, iDef);
+		SetPoint(POINT_MAGIC_ATT_GRADE, GetPoint(POINT_ATT_GRADE));
+		SetPoint(POINT_MAGIC_DEF_GRADE, GetPoint(POINT_DEF_GRADE));
+	}
+}
+
+void CHARACTER::ComputePoints()
+{
+	long lStat = GetPoint(POINT_STAT);
+	long lStatResetCount = GetPoint(POINT_STAT_RESET_COUNT);
+	long lSkillActive = GetPoint(POINT_SKILL);
+	long lSkillSub = GetPoint(POINT_SUB_SKILL);
+	long lSkillHorse = GetPoint(POINT_HORSE_SKILL);
+	long lLevelStep = GetPoint(POINT_LEVEL_STEP);
+
+	long lAttackerBonus = GetPoint(POINT_PARTY_ATTACKER_BONUS);
+	long lTankerBonus = GetPoint(POINT_PARTY_TANKER_BONUS);
+	long lBufferBonus = GetPoint(POINT_PARTY_BUFFER_BONUS);
+	long lSkillMasterBonus = GetPoint(POINT_PARTY_SKILL_MASTER_BONUS);
+	long lHasteBonus = GetPoint(POINT_PARTY_HASTE_BONUS);
+	long lDefenderBonus = GetPoint(POINT_PARTY_DEFENDER_BONUS);
+
+	long lHPRecovery = GetPoint(POINT_HP_RECOVERY);
+	long lSPRecovery = GetPoint(POINT_SP_RECOVERY);
+
+#if defined(__CONQUEROR_LEVEL__)
+	long lConquerorPoint = GetPoint(POINT_CONQUEROR_POINT);
+	long lConquerorLevelStep = GetPoint(POINT_CONQUEROR_LEVEL_STEP);
+#endif
+
+	memset(m_pointsInstant.points, 0, sizeof(m_pointsInstant.points));
+	BuffOnAttr_ClearAll();
+	m_SkillDamageBonus.clear();
+
+	SetPoint(POINT_STAT, lStat);
+	SetPoint(POINT_SKILL, lSkillActive);
+	SetPoint(POINT_SUB_SKILL, lSkillSub);
+	SetPoint(POINT_HORSE_SKILL, lSkillHorse);
+	SetPoint(POINT_LEVEL_STEP, lLevelStep);
+	SetPoint(POINT_STAT_RESET_COUNT, lStatResetCount);
+
+	SetPoint(POINT_ST, GetRealPoint(POINT_ST));
+	SetPoint(POINT_HT, GetRealPoint(POINT_HT));
+	SetPoint(POINT_DX, GetRealPoint(POINT_DX));
+	SetPoint(POINT_IQ, GetRealPoint(POINT_IQ));
+
+#if defined(__CONQUEROR_LEVEL__)
+	SetPoint(POINT_CONQUEROR_POINT, lConquerorPoint);
+	SetPoint(POINT_CONQUEROR_LEVEL_STEP, lConquerorLevelStep);
+
+	SetPoint(POINT_SUNGMA_STR, GetRealPoint(POINT_SUNGMA_STR));
+	SetPoint(POINT_SUNGMA_HP, GetRealPoint(POINT_SUNGMA_HP));
+	SetPoint(POINT_SUNGMA_MOVE, GetRealPoint(POINT_SUNGMA_MOVE));
+	SetPoint(POINT_SUNGMA_IMMUNE, GetRealPoint(POINT_SUNGMA_IMMUNE));
+#endif
+
+	SetPart(PART_MAIN, GetOriginalPart(PART_MAIN));
+	SetPart(PART_WEAPON, GetOriginalPart(PART_WEAPON));
+	SetPart(PART_HEAD, GetOriginalPart(PART_HEAD));
+	SetPart(PART_HAIR, GetOriginalPart(PART_HAIR));
+#if defined(__ACCE_COSTUME_SYSTEM__)
+	SetPart(PART_ACCE, GetOriginalPart(PART_ACCE));
+#endif
+
+	SetPoint(POINT_PARTY_ATTACKER_BONUS, lAttackerBonus);
+	SetPoint(POINT_PARTY_TANKER_BONUS, lTankerBonus);
+	SetPoint(POINT_PARTY_BUFFER_BONUS, lBufferBonus);
+	SetPoint(POINT_PARTY_SKILL_MASTER_BONUS, lSkillMasterBonus);
+	SetPoint(POINT_PARTY_HASTE_BONUS, lHasteBonus);
+	SetPoint(POINT_PARTY_DEFENDER_BONUS, lDefenderBonus);
+
+	SetPoint(POINT_HP_RECOVERY, lHPRecovery);
+	SetPoint(POINT_SP_RECOVERY, lSPRecovery);
+
+	// PC_BANG_ITEM_ADD
+	SetPoint(POINT_PC_BANG_EXP_BONUS, 0);
+	SetPoint(POINT_PC_BANG_DROP_BONUS, 0);
+	// END_PC_BANG_ITEM_ADD
+
+	int64_t iMaxHP, iMaxSP;
+	int iMaxStamina;
+
+	if (IsPC())
+	{
+		// ִ /ŷ
+		iMaxHP = JobInitialPoints[GetJob()].max_hp + m_points.iRandomHP + GetPoint(POINT_HT) * JobInitialPoints[GetJob()].hp_per_ht;
+		iMaxSP = JobInitialPoints[GetJob()].max_sp + m_points.iRandomSP + GetPoint(POINT_IQ) * JobInitialPoints[GetJob()].sp_per_iq;
+		iMaxStamina = JobInitialPoints[GetJob()].max_stamina + GetPoint(POINT_HT) * JobInitialPoints[GetJob()].stamina_per_con;
+
+		{
+			CSkillProto* pkSk = CSkillManager::instance().Get(SKILL_ADD_HP);
+
+			if (NULL != pkSk)
+			{
+				pkSk->SetPointVar("k", 1.0f * GetSkillPower(SKILL_ADD_HP) / 100.0f);
+
+				iMaxHP += static_cast<int64_t>(pkSk->kPointPoly.Eval());
+			}
+		}
+
+		// ⺻ 
+		SetPoint(POINT_MOV_SPEED, 100);
+		SetPoint(POINT_ATT_SPEED, 100);
+		PointChange(POINT_ATT_SPEED, GetPoint(POINT_PARTY_HASTE_BONUS));
+		SetPoint(POINT_CASTING_SPEED, 100);
+	}
+	else
+	{
+		iMaxHP = m_pkMobData->m_table.dwMaxHP;
+		iMaxSP = 0;
+		iMaxStamina = 0;
+
+		SetPoint(POINT_ATT_SPEED, m_pkMobData->m_table.sAttackSpeed);
+		SetPoint(POINT_MOV_SPEED, m_pkMobData->m_table.sMovingSpeed);
+		SetPoint(POINT_CASTING_SPEED, m_pkMobData->m_table.sAttackSpeed);
+	}
+
+	if (IsPC())
+	{
+		//  Ÿ   ⺻    Ⱥ   .
+		//      ̹Ƿ, / ü  
+		// ä  ö󰡰  ̴.
+		if (GetMountVnum())
+		{
+			if (GetHorseST() > GetPoint(POINT_ST))
+				PointChange(POINT_ST, GetHorseST() - GetPoint(POINT_ST));
+
+			if (GetHorseDX() > GetPoint(POINT_DX))
+				PointChange(POINT_DX, GetHorseDX() - GetPoint(POINT_DX));
+
+			if (GetHorseHT() > GetPoint(POINT_HT))
+				PointChange(POINT_HT, GetHorseHT() - GetPoint(POINT_HT));
+
+			if (GetHorseIQ() > GetPoint(POINT_IQ))
+				PointChange(POINT_IQ, GetHorseIQ() - GetPoint(POINT_IQ));
+		}
+	}
+
+	ComputeBattlePoints();
+
+	// ⺻ HP/SP 
+	if (iMaxHP != GetMaxHP())
+	{
+		SetRealPoint(POINT_MAX_HP, iMaxHP); // ⺻HP RealPoint  ´.
+	}
+	PointChange(POINT_MAX_HP, 0);
+
+	if (iMaxSP != GetMaxSP())
+	{
+		SetRealPoint(POINT_MAX_SP, iMaxSP); // ⺻SP RealPoint  ´.
+	}
+	PointChange(POINT_MAX_SP, 0);
+
+	SetMaxStamina(iMaxStamina);
+
+	//int64_t iCurHP = this->GetHP();
+	//int64_t iCurSP = this->GetSP();
+
+	m_pointsInstant.dwImmuneFlag = 0;
+
+	for (int i = 0; i < WEAR_MAX_NUM; i++)
+	{
+		LPITEM pItem = GetWear(i);
+		if (pItem)
+		{
+			pItem->ModifyPoints(true);
+			SET_BIT(m_pointsInstant.dwImmuneFlag, GetWear(i)->GetImmuneFlag());
+		}
+	}
+
+	// ȥ ý
+	// ComputePoints ɸ  Ӽ ʱȭϰ,
+	// ,   õ  Ӽ ϱ ,
+	// ȥ ý۵ ActiveDeck ִ  ȥ Ӽ ٽ Ѿ Ѵ.
+	if (DragonSoul_IsDeckActivated())
+	{
+		for (int i = WEAR_MAX_NUM + DS_SLOT_MAX * DragonSoul_GetActiveDeck();
+			i < WEAR_MAX_NUM + DS_SLOT_MAX * (DragonSoul_GetActiveDeck() + 1); i++)
+		{
+			LPITEM pItem = GetWear(i);
+			if (pItem)
+			{
+				if (DSManager::instance().IsTimeLeftDragonSoul(pItem))
+					pItem->ModifyPoints(true);
+			}
+		}
+
+#if defined(__DS_SET__)
+		DragonSoul_HandleSetBonus();
+#endif
+	}
+
+	ComputeSkillPoints();
+
+	RefreshAffect();
+
+	if (GetHP() > GetMaxHP())
+		PointChange(POINT_HP, GetMaxHP() - GetHP());
+
+	if (GetSP() > GetMaxSP())
+		PointChange(POINT_SP, GetMaxSP() - GetSP());
+
+	CPetSystem* pPetSystem = GetPetSystem();
+	if (NULL != pPetSystem)
+		pPetSystem->RefreshBuff();
+
+	/*
+	if (IsPC())
+	{
+		if (this->GetHP() != iCurHP)
+			this->PointChange(POINT_HP, iCurHP - this->GetHP());
+		if (this->GetSP() != iCurSP)
+			this->PointChange(POINT_SP, iCurSP - this->GetSP());
+	}
+	*/
+
+	PointChange(POINT_MAX_HP, 0);
+	PointChange(POINT_MAX_SP, 0);
+
+	UpdatePacket();
+}
+
+// m_dwPlayStartTime  milisecond. ͺ̽ д ϱ
+//  ÷̽ð   / 60000   ϴµ,    
+//   ⿡ dwTimeRemain ־  ǵ ־ Ѵ.
+void CHARACTER::ResetPlayTime(DWORD dwTimeRemain)
+{
+	m_dwPlayStartTime = get_dword_time() - dwTimeRemain;
+}
+
+const int aiRecoveryPercents[10] = { 1, 5, 5, 5, 5, 5, 5, 5, 5, 5 };
+
+EVENTFUNC(recovery_event)
+{
+	char_event_info* info = dynamic_cast<char_event_info*>(event->info);
+	if (info == NULL)
+	{
+		sys_err("recovery_event> <Factor> Null pointer");
+		return 0;
+	}
+
+	LPCHARACTER ch = info->ch;
+
+	if (ch == NULL) // <Factor>
+		return 0;
+
+	if (!ch->IsPC())
+	{
+		//
+		//  ȸ
+		//
+		if (ch->IsAffectFlag(AFF_POISON))
+			return PASSES_PER_SEC(MAX(1, ch->GetMobTable().bRegenCycle));
+
+		if (ch->IsAffectFlag(AFF_BLEEDING))
+			return PASSES_PER_SEC(MAX(1, ch->GetMobTable().bRegenCycle));
+
+		DWORD vnum = ch->GetMobTable().dwVnum;
+		if (vnum == 2493) // Aqua Dragon
+		{
+			int regenPct = BlueDragon_GetRangeFactor("hp_regen", ch->GetHPPct());
+			regenPct += ch->GetMobTable().bRegenPercent;
+
+			for (int i = 1; i <= 4; ++i)
+			{
+				if (REGEN_PECT_BONUS == BlueDragon_GetIndexFactor("DragonStone", i, "effect_type"))
+				{
+					DWORD dwDragonStoneID = BlueDragon_GetIndexFactor("DragonStone", i, "vnum");
+					size_t val = BlueDragon_GetIndexFactor("DragonStone", i, "val");
+					size_t cnt = SECTREE_MANAGER::instance().GetMonsterCountInMap(ch->GetMapIndex(), dwDragonStoneID);
+
+					regenPct += (val * cnt);
+
+					break;
+				}
+			}
+
+			ch->MonsterLog("AQUA_HP_REGEN +%d", MAX(1, (ch->GetMaxHP() * regenPct) / 100));
+			ch->PointChange(POINT_HP, MAX(1, (ch->GetMaxHP() * regenPct) / 100));
+		}
+		else if (!ch->IsDoor())
+		{
+			ch->MonsterLog("HP_REGEN +%d", MAX(1, (ch->GetMaxHP() * ch->GetMobTable().bRegenPercent) / 100));
+			ch->PointChange(POINT_HP, MAX(1, (ch->GetMaxHP() * ch->GetMobTable().bRegenPercent) / 100));
+		}
+
+		if (ch->GetHP() >= ch->GetMaxHP())
+		{
+			ch->m_pkRecoveryEvent = NULL;
+			return 0;
+		}
+
+		if (2493 == ch->GetMobTable().dwVnum)
+		{
+			for (int i = 1; i <= 4; ++i)
+			{
+				if (REGEN_TIME_BONUS == BlueDragon_GetIndexFactor("DragonStone", i, "effect_type"))
+				{
+					DWORD dwDragonStoneID = BlueDragon_GetIndexFactor("DragonStone", i, "vnum");
+					size_t val = BlueDragon_GetIndexFactor("DragonStone", i, "val");
+					size_t cnt = SECTREE_MANAGER::instance().GetMonsterCountInMap(ch->GetMapIndex(), dwDragonStoneID);
+
+					return PASSES_PER_SEC(MAX(1, (ch->GetMobTable().bRegenCycle - (val * cnt))));
+				}
+			}
+		}
+
+		return PASSES_PER_SEC(MAX(1, ch->GetMobTable().bRegenCycle));
+	}
+	else
+	{
+		//
+		// PC ȸ
+		//
+		ch->CheckTarget();
+		// ch->UpdateSectree(); // ⼭ ̰ ?
+		ch->UpdateKillerMode();
+
+		if (ch->IsAffectFlag(AFF_POISON) == true)
+		{
+			// ߵ  ڵȸ 
+			// Ĺ  ڵȸ 
+			return 3;
+		}
+
+		if (ch->IsAffectFlag(AFF_BLEEDING))
+			return 3;
+
+		int iSec = (get_dword_time() - ch->GetLastMoveTime()) / 3000;
+
+		// SP ȸ ƾ.
+		//  ̰ɷ ؼ Լ ° ?!
+		ch->DistributeSP(ch);
+
+		if (ch->GetMaxHP() <= ch->GetHP())
+			return PASSES_PER_SEC(3);
+
+		int iPercent = 0;
+		int64_t iAmount = 0;
+
+		{
+			iPercent = aiRecoveryPercents[MIN(9, iSec)];
+			iAmount = 15 + (ch->GetMaxHP() * iPercent) / 100;
+		}
+
+		iAmount += (iAmount * ch->GetPoint(POINT_HP_REGEN)) / 100;
+
+		sys_log(1, "RECOVERY_EVENT: %s %d HP_REGEN %d HP +%lld", ch->GetName(), iPercent, ch->GetPoint(POINT_HP_REGEN), iAmount);
+
+		ch->PointChange(POINT_HP, iAmount, false);
+		return PASSES_PER_SEC(3);
+	}
+}
+
+void CHARACTER::StartRecoveryEvent()
+{
+	if (m_pkRecoveryEvent)
+		return;
+
+	if (IsDead() || IsStun())
+		return;
+
+	if (IsNPC() && GetHP() >= GetMaxHP()) // ʹ ü    Ѵ.
+		return;
+
+#if defined(__GUILD_DRAGONLAIR__)
+	if ((MeleyLair::CMgr::instance().IsMeleyMap(GetMapIndex())) && ((GetRaceNum() == (WORD)(MeleyLair::STATUE_VNUM)) || ((GetRaceNum() == (WORD)(MeleyLair::BOSS_VNUM)))))
+		return;
+#endif
+
+	char_event_info* info = AllocEventInfo<char_event_info>();
+
+	info->ch = this;
+
+	int iSec = IsPC() ? 3 : (MAX(1, GetMobTable().bRegenCycle));
+	m_pkRecoveryEvent = event_create(recovery_event, info, PASSES_PER_SEC(iSec));
+}
+
+void CHARACTER::Standup()
+{
+	struct packet_position pack_position;
+
+	if (!IsPosition(POS_SITTING))
+		return;
+
+	SetPosition(POS_STANDING);
+
+	sys_log(1, "STANDUP: %s", GetName());
+
+	pack_position.header = HEADER_GC_CHARACTER_POSITION;
+	pack_position.vid = GetVID();
+	pack_position.position = POSITION_GENERAL;
+
+	PacketAround(&pack_position, sizeof(pack_position));
+}
+
+void CHARACTER::Sitdown(int is_ground)
+{
+	struct packet_position pack_position;
+
+	if (IsPosition(POS_SITTING))
+		return;
+
+	SetPosition(POS_SITTING);
+	sys_log(1, "SITDOWN: %s", GetName());
+
+	pack_position.header = HEADER_GC_CHARACTER_POSITION;
+	pack_position.vid = GetVID();
+	pack_position.position = POSITION_SITTING_GROUND;
+	PacketAround(&pack_position, sizeof(pack_position));
+}
+
+void CHARACTER::SetRotation(float fRot)
+{
+	m_pointsInstant.fRot = fRot;
+}
+
+// x, y   .
+void CHARACTER::SetRotationToXY(long x, long y)
+{
+	SetRotation(GetDegreeFromPositionXY(GetX(), GetY(), x, y));
+}
+
+bool CHARACTER::CannotMoveByAffect() const
+{
+	return (IsAffectFlag(AFF_STUN));
+}
+
+bool CHARACTER::CanMove() const
+{
+	if (CannotMoveByAffect())
+		return false;
+
+	if (GetMyShop()) //   ¿   
+		return false;
+
+	// 0.2 ̶   .
+	/*
+	if (get_float_time() - m_fSyncTime < 0.2f)
+		return false;
+	*/
+	return true;
+}
+
+//  x, y ġ ̵ Ų.
+bool CHARACTER::Sync(long x, long y)
+{
+	if (!GetSectree())
+		return false;
+
+	LPSECTREE new_tree = SECTREE_MANAGER::instance().Get(GetMapIndex(), x, y);
+
+	if (!new_tree)
+	{
+		if (GetDesc())
+		{
+			sys_err("cannot find tree at %d %d (name: %s)", x, y, GetName());
+			GetDesc()->SetPhase(PHASE_CLOSE);
+		}
+		else
+		{
+			sys_err("no tree: %s %d %d %d", GetName(), x, y, GetMapIndex());
+			Dead();
+		}
+
+		return false;
+	}
+
+	SetRotationToXY(x, y);
+	SetXYZ(x, y, 0);
+
+	if (GetDungeon())
+	{
+		//  ̺Ʈ Ӽ ȭ
+		int iLastEventAttr = m_iEventAttr;
+		m_iEventAttr = new_tree->GetEventAttribute(x, y);
+
+		if (m_iEventAttr != iLastEventAttr)
+		{
+			if (GetParty())
+			{
+				quest::CQuestManager::instance().AttrOut(GetParty()->GetLeaderPID(), this, iLastEventAttr);
+				quest::CQuestManager::instance().AttrIn(GetParty()->GetLeaderPID(), this, m_iEventAttr);
+			}
+			else
+			{
+				quest::CQuestManager::instance().AttrOut(GetPlayerID(), this, iLastEventAttr);
+				quest::CQuestManager::instance().AttrIn(GetPlayerID(), this, m_iEventAttr);
+			}
+		}
+	}
+
+	if (GetSectree() != new_tree)
+	{
+		if (test_server)
+			if (!IsNPC())
+			{
+				SECTREEID id = new_tree->GetID();
+				SECTREEID old_id = GetSectree()->GetID();
+
+				const float fDist = DISTANCE_SQRT(id.coord.x - old_id.coord.x, id.coord.y - old_id.coord.y);
+				sys_log(0, "SECTREE DIFFER: %s %dx%d was %dx%d dist %.1fm",
+					GetName(),
+					id.coord.x,
+					id.coord.y,
+					old_id.coord.x,
+					old_id.coord.y,
+					fDist);
+			}
+
+		new_tree->InsertEntity(this);
+	}
+
+	return true;
+}
+
+void CHARACTER::Stop()
+{
+	if (!IsState(m_stateIdle))
+		MonsterLog("[IDLE] ");
+
+	GotoState(m_stateIdle);
+
+	m_posDest.x = m_posStart.x = GetX();
+	m_posDest.y = m_posStart.y = GetY();
+}
+
+bool CHARACTER::Goto(long x, long y)
+{
+#if defined(__GUILD_DRAGONLAIR__)
+	// NOTE: Prevent Dragon Queen Meley from changing position
+	// when warping out of the dungeon.
+	if (GetRaceNum() == static_cast<WORD>(MeleyLair::BOSS_VNUM))
+		return false;
+#endif
+
+	// TODO Ÿüũ ʿ
+	//  ġ ̵ ʿ  (ڵ )
+	if (GetX() == x && GetY() == y)
+		return false;
+
+	if (m_posDest.x == x && m_posDest.y == y)
+	{
+		if (!IsState(m_stateMove))
+		{
+			m_dwStateDuration = 4;
+			GotoState(m_stateMove);
+		}
+		return false;
+	}
+
+	m_posDest.x = x;
+	m_posDest.y = y;
+
+	CalculateMoveDuration();
+
+	m_dwStateDuration = 4;
+
+	if (!IsState(m_stateMove))
+	{
+		MonsterLog("[MOVE] %s", GetVictim() ? "To victim" : "Free");
+
+		if (GetVictim())
+		{
+			//MonsterChat(MONSTER_CHAT_CHASE);
+			//MonsterChat(MONSTER_CHAT_ATTACK);
+		}
+	}
+
+	GotoState(m_stateMove);
+
+	return true;
+}
+
+DWORD CHARACTER::GetMotionMode() const
+{
+	DWORD dwMode = MOTION_MODE_GENERAL;
+
+	if (IsPolymorphed())
+		return dwMode;
+
+	LPITEM pkItem;
+
+	if ((pkItem = GetWear(WEAR_WEAPON)))
+	{
+		switch (pkItem->GetProto()->bSubType)
+		{
+		case WEAPON_SWORD:
+			dwMode = MOTION_MODE_ONEHAND_SWORD;
+			break;
+
+		case WEAPON_TWO_HANDED:
+			dwMode = MOTION_MODE_TWOHAND_SWORD;
+			break;
+
+		case WEAPON_DAGGER:
+			dwMode = MOTION_MODE_DUALHAND_SWORD;
+			break;
+
+		case WEAPON_BOW:
+			dwMode = MOTION_MODE_BOW;
+			break;
+
+		case WEAPON_BELL:
+			dwMode = MOTION_MODE_BELL;
+			break;
+
+		case WEAPON_FAN:
+			dwMode = MOTION_MODE_FAN;
+			break;
+
+		case WEAPON_CLAW:
+			dwMode = MOTION_MODE_CLAW;
+			break;
+
+		}
+	}
+	return dwMode;
+}
+
+float CHARACTER::GetMoveMotionSpeed() const
+{
+	DWORD dwMode = GetMotionMode();
+
+	const CMotion* pkMotion = NULL;
+
+	if (!GetMountVnum())
+		pkMotion = CMotionManager::instance().GetMotion(GetRaceNum(), MAKE_MOTION_KEY(dwMode, (IsWalking() && IsPC()) ? MOTION_WALK : MOTION_RUN));
+	else
+	{
+		pkMotion = CMotionManager::instance().GetMotion(GetMountVnum(), MAKE_MOTION_KEY(MOTION_MODE_GENERAL, (IsWalking() && IsPC()) ? MOTION_WALK : MOTION_RUN));
+
+		if (!pkMotion)
+			pkMotion = CMotionManager::instance().GetMotion(GetRaceNum(), MAKE_MOTION_KEY(MOTION_MODE_HORSE, (IsWalking() && IsPC()) ? MOTION_WALK : MOTION_RUN));
+	}
+
+	if (pkMotion)
+		return -pkMotion->GetAccumVector().y / pkMotion->GetDuration();
+	else
+	{
+		sys_err("cannot find motion (name %s race %d mode %d)", GetName(), GetRaceNum(), dwMode);
+		return 300.0f;
+	}
+}
+
+float CHARACTER::GetMoveSpeed() const
+{
+	return GetMoveMotionSpeed() * 10000 / CalculateDuration(GetLimitPoint(POINT_MOV_SPEED), 10000);
+}
+
+void CHARACTER::CalculateMoveDuration()
+{
+	m_posStart.x = GetX();
+	m_posStart.y = GetY();
+
+	float fDist = DISTANCE_SQRT(m_posStart.x - m_posDest.x, m_posStart.y - m_posDest.y);
+
+	float motionSpeed = GetMoveMotionSpeed();
+
+	m_dwMoveDuration = CalculateDuration(GetLimitPoint(POINT_MOV_SPEED),
+		(int)((fDist / motionSpeed) * 1000.0f));
+
+	if (IsNPC())
+		sys_log(1, "%s: GOTO: distance %f, spd %u, duration %u, motion speed %f pos %d %d -> %d %d",
+			GetName(), fDist, GetLimitPoint(POINT_MOV_SPEED), m_dwMoveDuration, motionSpeed,
+			m_posStart.x, m_posStart.y, m_posDest.x, m_posDest.y);
+
+	m_dwMoveStartTime = get_dword_time();
+}
+
+// x y ġ ̵ Ѵ. (̵  ִ    Ȯ ϰ Sync ޼ҵ  ̵ Ѵ)
+//  char x, y  ٷ ٲ,
+// Ŭ󿡼  ġ ٲ x, y interpolationѴ.
+// Ȱų ٴ  char m_bNowWalking ޷ִ.
+// Warp ǵ ̶ Show  .
+bool CHARACTER::Move(long x, long y)
+{
+	//  ġ ̵ ʿ  (ڵ )
+	if (GetX() == x && GetY() == y)
+		return true;
+
+	if (test_server)
+		if (m_bDetailLog)
+			sys_log(0, "%s position %u %u", GetName(), x, y);
+
+	OnMove();
+	return Sync(x, y);
+}
+
+void CHARACTER::SendMovePacket(BYTE bFunc, BYTE bArg, DWORD x, DWORD y, DWORD dwDuration, DWORD dwTime, int iRot)
+{
+	TPacketGCMove pack;
+
+	if (bFunc == FUNC_WAIT)
+	{
+		x = m_posDest.x;
+		y = m_posDest.y;
+		dwDuration = m_dwMoveDuration;
+	}
+
+	EncodeMovePacket(pack, GetVID(), bFunc, bArg, x, y, dwDuration, dwTime, iRot == -1 ? (int)GetRotation() / 5 : iRot);
+	PacketView(&pack, sizeof(TPacketGCMove), this);
+}
+
+int64_t CHARACTER::GetRealPoint(BYTE type) const
+{
+	return m_points.points[type];
+}
+
+void CHARACTER::SetRealPoint(BYTE type, int64_t val)
+{
+	m_points.points[type] = val;
+}
+
+int64_t CHARACTER::GetPolymorphPoint(BYTE type) const
+{
+	if (IsPolymorphed() && !IsPolyMaintainStat())
+	{
+		DWORD dwMobVnum = GetPolymorphVnum();
+		const CMob* pMob = CMobManager::instance().Get(dwMobVnum);
+		int iPower = GetPolymorphPower();
+
+		if (pMob)
+		{
+			switch (type)
+			{
+			case POINT_ST:
+				if (GetJob() == JOB_SHAMAN || GetJob() == JOB_SURA && GetSkillGroup() == 2)
+					return pMob->m_table.bStr * iPower / 100 + GetPoint(POINT_IQ);
+				return pMob->m_table.bStr * iPower / 100 + GetPoint(POINT_ST);
+
+			case POINT_HT:
+				return pMob->m_table.bCon * iPower / 100 + GetPoint(POINT_HT);
+
+			case POINT_IQ:
+				return pMob->m_table.bInt * iPower / 100 + GetPoint(POINT_IQ);
+
+			case POINT_DX:
+				return pMob->m_table.bDex * iPower / 100 + GetPoint(POINT_DX);
+			}
+		}
+	}
+
+	return GetPoint(type);
+}
+
+int64_t CHARACTER::GetPoint(BYTE type) const
+{
+	if (type >= POINT_MAX_NUM)
+	{
+		sys_err("Point type overflow (type %u)", type);
+		return 0;
+	}
+
+	int64_t val = m_pointsInstant.points[type];
+	int64_t max_val = LLONG_MAX;
+
+	switch (type)
+	{
+	case POINT_STEAL_HP:
+	case POINT_STEAL_SP:
+		max_val = 50;
+		break;
+	}
+
+	if (val > max_val)
+		sys_err("POINT_ERROR: %s type %d val %d (max: %d)", GetName(), val, max_val);
+
+	return (val);
+}
+
+int64_t CHARACTER::GetLimitPoint(BYTE type) const
+{
+	if (type >= POINT_MAX_NUM)
+	{
+		sys_err("Point type overflow (type %u)", type);
+		return 0;
+	}
+
+	int64_t val = m_pointsInstant.points[type];
+	int64_t max_val = LLONG_MAX;
+	int64_t limit = LLONG_MAX;
+	int64_t min_limit = -LLONG_MAX;
+
+	switch (type)
+	{
+	case POINT_ATT_SPEED:
+		min_limit = 0;
+
+		if (IsPC())
+			limit = 170;
+		else
+			limit = 250;
+		break;
 
-				PointChange(POINT_HP, 50 - GetHP());
-				DeathPenalty(1);
+	case POINT_MOV_SPEED:
+		min_limit = 0;
+
+		if (IsPC())
+			limit = 200;
+		else
+			limit = 250;
+		break;
+
+	case POINT_STEAL_HP:
+	case POINT_STEAL_SP:
+		limit = 50;
+		max_val = 50;
+		break;
+
+	case POINT_MALL_ATTBONUS:
+	case POINT_MALL_DEFBONUS:
+		limit = 20;
+		max_val = 50;
+		break;
+	}
+
+#if defined(__CONQUEROR_LEVEL__)
+	if (IsPC())
+	{
+		switch (type)
+		{
+		case POINT_MOV_SPEED:
+			if (GetSungMaWill(POINT_SUNGMA_MOVE) > GetPoint(POINT_SUNGMA_MOVE))
+				val /= 2;
+			break;
+		}
+	}
+#endif
+
+	if (val > max_val)
+		sys_err("POINT_ERROR: %s type %d val %d (max: %d)", GetName(), val, max_val);
+
+	if (val > limit)
+		val = limit;
+
+	if (val < min_limit)
+		val = min_limit;
+
+	return (val);
+}
+
+void CHARACTER::SetPoint(BYTE type, int64_t val)
+{
+	if (type >= POINT_MAX_NUM)
+	{
+		sys_err("Point type overflow (type %u)", type);
+		return;
+	}
+
+	m_pointsInstant.points[type] = val;
+
+	//  ̵  ȳٸ ̵ ð  ٽ ؾ Ѵ.
+	if (type == POINT_MOV_SPEED && get_dword_time() < m_dwMoveStartTime + m_dwMoveDuration)
+	{
+		CalculateMoveDuration();
+	}
+}
+
+long long CHARACTER::GetAllowedGold() const
+{
+	if (GetLevel() <= 10)
+		return 100000;
+	else if (GetLevel() <= 20)
+		return 500000;
+	else
+		return 50000000;
+}
+
+void CHARACTER::CheckMaximumPoints()
+{
+	if (GetMaxHP() < GetHP())
+		PointChange(POINT_HP, GetMaxHP() - GetHP());
+
+	if (GetMaxSP() < GetSP())
+		PointChange(POINT_SP, GetMaxSP() - GetSP());
+}
+
+void CHARACTER::PointChange(BYTE type, int64_t amount, bool bAmount, bool bBroadcast)
+{
+	int64_t val = 0;
+
+	//sys_log(0, "PointChange %d %d | %d -> %d cHP %d mHP %d", type, amount, GetPoint(type), GetPoint(type)+amount, GetHP(), GetMaxHP());
+
+	switch (type)
+	{
+	case POINT_NONE:
+		return;
+
+#if defined(__CONQUEROR_LEVEL__)
+	case POINT_CONQUEROR_LEVEL:
+	{
+		if ((GetConquerorLevel() + amount) > gPlayerMaxConquerorLevel)
+			return;
+
+		SetConquerorLevel(GetConquerorLevel() + amount);
+		val = GetConquerorLevel();
+
+		sys_log(0, "CONQUEROR_LEVELUP: %s %d NEXT EXP %d", GetName(), GetConquerorLevel(), GetConquerorNextExp());
+
+		PointChange(POINT_CONQUEROR_NEXT_EXP, GetConquerorNextExp(), false);
+	} break;
+
+	case POINT_CONQUEROR_NEXT_EXP:
+	{
+		val = GetConquerorNextExp();
+		bAmount = false; //  bAmount false  Ѵ.
+	} break;
+
+	case POINT_CONQUEROR_EXP:
+	{
+		DWORD exp = GetConquerorExp();
+		DWORD next_exp = GetConquerorNextExp();
+
+		// exp 0 Ϸ  ʵ Ѵ
+		if (amount < 0 && exp <= -amount)
+		{
+			sys_log(0, "%s - Reduce EXP by %d, CUR EXP: %d (setting to zero)", GetName(), -amount, exp);
+			amount = -exp;
+
+			SetConquerorExp(0);
+			val = GetExp();
+		}
+		else
+		{
+			if (GetConquerorLevel() >= gPlayerMaxConquerorLevel)
 				return;
-			}
-#endif
-
-			PIXEL_POSITION pos;
-			if (SECTREE_MANAGER::instance().GetRecallPositionByEmpire(GetMapIndex(), GetEmpire(), pos))
-				WarpSet(pos.x, pos.y);
-			else
-				WarpSet(EMPIRE_START_X(GetEmpire()), EMPIRE_START_Y(GetEmpire()));
-
-			PointChange(POINT_HP, 50 - GetHP());
-			DeathPenalty(1);
-		}
-		break;
-
-		case SCMD_RESTART_HERE:
-		{
-			sys_log(0, "do_restart: restart here");
-
-			RestartAtSamePos();
-			//Show(GetMapIndex(), GetX(), GetY());
-
-			DeathPenalty(0);
-			PointChange(POINT_HP, 50 - GetHP());
-
-			ComputePoints();
-			ReviveInvisible(5);
-		}
-		break;
-
-		case SCMD_RESTART_IMMEDIATE:
-			break;
-
-		case SCMD_RESTART_GIVEUP:
-		{
-#if defined(__DEFENSE_WAVE__)
-			if (GetDefenseWave())
-				GetDefenseWave()->Exit(this);
-#endif
-
-#if defined(__ELEMENTAL_DUNGEON__)
-			if (IS_ELEMENTAL_DUNGEON(GetMapIndex()))
-			{
-				PIXEL_POSITION WarpPos;
-				if (SECTREE_MANAGER::instance().GetRecallPositionByEmpire(MAP_DEFENSEWAVE_PORT, GetEmpire(), WarpPos))
-					WarpSet(WarpPos.x, WarpPos.y);
-				else
-					WarpSet(EMPIRE_START_X(GetEmpire()), EMPIRE_START_Y(GetEmpire()));
-			}
-#endif
-		}
-	}
-}
-
-void CHARACTER::RestartAtSamePos()
-{
-	if (m_bIsObserver)
-		return;
-
-#if defined(__QUEST_EVENT_RESTART_HERE__)
-	quest::CQuestManager::instance().RestartHere(GetPlayerID());
-#endif
-
-#if defined(__SET_ITEM__)
-	// NOTE : Due to the classic pet disappearing when the character dies,
-	// we have to call this function again to check if the pet is spawned.
-	RefreshItemSetBonus();
-	// NOTE : If the player is cruel, he is likely to drop some equipment,
-	// it is necessary to re-check the set bonus.
-	RefreshItemSetBonusByValue();
-#endif
-
-	EncodeRemovePacket(this);
-	EncodeInsertPacket(this);
-
-	ENTITY_MAP::iterator it = m_map_view.begin();
-
-	while (it != m_map_view.end())
-	{
-		LPENTITY entity = (it++)->first;
-
-		EncodeRemovePacket(entity);
-		if (!m_bIsObserver)
-			EncodeInsertPacket(entity);
-
-		if (entity->IsType(ENTITY_CHARACTER))
-		{
-			LPCHARACTER lpChar = (LPCHARACTER)entity;
-			if (lpChar->IsPC() || lpChar->IsNPC() || lpChar->IsMonster())
-			{
-				if (!entity->IsObserverMode())
-					entity->EncodeInsertPacket(this);
-			}
-		}
-		else
-		{
-			if (!entity->IsObserverMode())
-			{
-				entity->EncodeInsertPacket(this);
-			}
-		}
-	}
-}
-
-// Entity  Ÿٰ Ŷ .
-void CHARACTER::EncodeInsertPacket(LPENTITY entity)
-{
-	LPDESC d;
-
-	if (!(d = entity->GetDesc()))
-		return;
-
-	// ̸   ڵ
-	LPCHARACTER ch = (LPCHARACTER)entity;
-#ifdef __OFFLINE_SHOP__
-	if (IsNPC() && GetRaceNum() == COfflineShop::CLOSED_RACE) {
-		auto shopPtr = COfflineShop::Get(GetKeepingOfflineShop());
-		if (shopPtr) {
-			auto shop = shopPtr->get();
-
-			if (shop->IsClosed() && shop->GetOwnerPid() != ch->GetPlayerID()) {
-				return;
-			}
-		}
-	}
-#endif
-	ch->SendGuildName(GetGuild());
-	// ̸   ڵ
-
-	TPacketGCCharacterAdd pack;
-
-	pack.header = HEADER_GC_CHARACTER_ADD;
-	pack.dwVID = m_vid;
-#if defined(__WJ_SHOW_MOB_INFO__)
-	if (IsMonster() || IsStone())
-	{
-		pack.dwLevel = GetLevel();
-		pack.dwAIFlag = IsMonster() ? GetAIFlag() : 0;
-	}
-	else
-	{
-		pack.dwLevel = 0;
-		pack.dwAIFlag = 0;
-	}
-#endif
-	pack.bType = GetCharType();
-	pack.angle = GetRotation();
-	pack.x = GetX();
-	pack.y = GetY();
-	pack.z = GetZ();
-	pack.wRaceNum = GetRaceNum();
-#if defined(__RACE_SWAP__)
-	pack.dwEventRaceNum = GetEventRaceNum();
-#endif
-
-#if defined(__PET_SYSTEM__)
-	if (IsPet())
-	{
-		pack.bMovingSpeed = 150;
-	}
-	else
-#endif
-	{
-		pack.bMovingSpeed = GetLimitPoint(POINT_MOV_SPEED);
-	}
-	pack.bAttackSpeed = GetLimitPoint(POINT_ATT_SPEED);
-	pack.dwAffectFlag[0] = m_afAffectFlag.bits[0];
-	pack.dwAffectFlag[1] = m_afAffectFlag.bits[1];
-	pack.dwAffectFlag[2] = m_afAffectFlag.bits[2];
-
-	pack.bStateFlag = m_bAddChrState;
-
-	int iDur = 0;
-
-	if (m_posDest.x != pack.x || m_posDest.y != pack.y)
-	{
-		iDur = (m_dwMoveStartTime + m_dwMoveDuration) - get_dword_time();
-
-		if (iDur <= 0)
-		{
-			pack.x = m_posDest.x;
-			pack.y = m_posDest.y;
-		}
-	}
-
-	d->Packet(&pack, sizeof(pack));
-
-	if (IsPC() || m_bCharType == CHAR_TYPE_NPC
-		|| m_bCharType == CHAR_TYPE_HORSE
-		|| IsHorse()
-#if defined(__PET_SYSTEM__)
-		|| m_bCharType == CHAR_TYPE_PET_PAY
-		|| IsPet()
-#endif
-		)
-	{
-		TPacketGCCharacterAdditionalInfo addPacket;
-		memset(&addPacket, 0, sizeof(TPacketGCCharacterAdditionalInfo));
-
-		addPacket.header = HEADER_GC_CHAR_ADDITIONAL_INFO;
-		addPacket.dwVID = m_vid;
-
-		addPacket.adwPart[CHR_EQUIPPART_ARMOR] = GetPart(PART_MAIN);
-		addPacket.adwPart[CHR_EQUIPPART_WEAPON] = GetPart(PART_WEAPON);
-		addPacket.adwPart[CHR_EQUIPPART_HEAD] = GetPart(PART_HEAD);
-		addPacket.adwPart[CHR_EQUIPPART_HAIR] = GetPart(PART_HAIR);
-#if defined(__ACCE_COSTUME_SYSTEM__)
-		addPacket.adwPart[CHR_EQUIPPART_ACCE] = GetPart(PART_ACCE);
-#endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-		addPacket.adwPart[CHR_EQUIPPART_AURA] = GetPart(PART_AURA);
-#endif
-#if defined(__QUIVER_SYSTEM__)
-		addPacket.dwArrow = (IsPC() && GetWear(WEAR_ARROW) != NULL) ? GetWear(WEAR_ARROW)->GetOriginalVnum() : 0;
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-		addPacket.wRefineElementAffectType = GetRefineElementEffect();
-#endif
-
-		addPacket.bPKMode = m_bPKMode;
-		addPacket.dwMountVnum = GetMountVnum();
-		addPacket.bEmpire = m_bEmpire;
-		addPacket.dwLevel = 0;
-#if defined(__CONQUEROR_LEVEL__)
-		addPacket.dwConquerorLevel = IsPC() ? GetConquerorLevel() : 0;
-#endif
-		addPacket.dwGuildID = 0;
-#if defined(__GUILD_LEADER_GRADE_NAME__)
-		addPacket.bGuildLeaderGrade = 0;
-#endif
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-		strlcpy(addPacket.szCountry, GetCountry(), sizeof(addPacket.szCountry));
-#endif
-
-		strlcpy(addPacket.name, GetName(), sizeof(addPacket.name));
-
-		if (IsPC())
-		{
-			addPacket.dwLevel = GetLevel();
-		}
-
-#ifdef __GROWTH_PET_SYSTEM__
-		if (IsGrowthPet())
-		{
-			addPacket.dwLevel = GetLevel();
-			addPacket.bCharacterSize = GetCharacterSize();
-		}
-#endif
-
-		if (GetGuild() != NULL)
-		{
-			addPacket.dwGuildID = GetGuild()->GetID();
-#if defined(__GUILD_LEADER_GRADE_NAME__)
-			CGuild* pGuild = this->GetGuild();
-			if (pGuild->GetMasterPID() == GetPlayerID())
-				addPacket.bGuildLeaderGrade = 3;
-			else if (pGuild->GetGeneralPID(GetPlayerID()) != 0)
-				addPacket.bGuildLeaderGrade = 2;
-			else
-				addPacket.bGuildLeaderGrade = 1;
-#endif
-		}
-
-		addPacket.sAlignment = m_iAlignment / 10;
-
-		d->Packet(&addPacket, sizeof(TPacketGCCharacterAdditionalInfo));
-	}
-
-	if (iDur)
-	{
-		TPacketGCMove pack;
-		EncodeMovePacket(pack, GetVID(), FUNC_MOVE, 0, m_posDest.x, m_posDest.y, iDur, 0, (BYTE)(GetRotation() / 5));
-		d->Packet(&pack, sizeof(pack));
-
-		TPacketGCWalkMode p;
-		p.vid = GetVID();
-		p.header = HEADER_GC_WALK_MODE;
-		p.mode = m_bNowWalking ? WALKMODE_WALK : WALKMODE_RUN;
-
-		d->Packet(&p, sizeof(p));
-	}
-
-	if (entity->IsType(ENTITY_CHARACTER) && GetDesc())
-	{
-		if (ch->IsWalking())
-		{
-			TPacketGCWalkMode p;
-			p.vid = ch->GetVID();
-			p.header = HEADER_GC_WALK_MODE;
-			p.mode = ch->m_bNowWalking ? WALKMODE_WALK : WALKMODE_RUN;
-			GetDesc()->Packet(&p, sizeof(p));
-		}
-
-#if defined(__ACCE_COSTUME_SYSTEM__)
-		LPITEM pAcceItem = GetWear(WEAR_COSTUME_ACCE);
-		if (pAcceItem && pAcceItem->GetSocket(ITEM_SOCKET_ACCE_DRAIN_VALUE) > 18)
-		{
-			TPacketGCSpecialEffect p;
-			p.bHeader = HEADER_GC_SEPCIAL_EFFECT;
-			p.bEffectNum = SE_ACCE_BACK;
-			p.dwVID = GetVID();
-			ch->GetDesc()->Packet(&p, sizeof(p));
-			//EffectPacket(SE_ACCE_BACK);
-		}
-#endif
-	}
-
-	if (GetMyShop())
-	{
-		TPacketGCShopSign p;
-		p.bHeader = HEADER_GC_SHOP_SIGN;
-		p.dwVID = GetVID();
-		strlcpy(p.szSign, m_stShopSign.c_str(), sizeof(p.szSign));
-#if defined(__MYSHOP_DECO__)
-		p.bType = GetMyShopDecoType();
-#endif
-		d->Packet(&p, sizeof(TPacketGCShopSign));
-	}
-
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-	if (CGuildDragonLairManager::Instance().IsRedDragonLair(GetMapIndex()))
-	{
-		CGuildDragonLair* pGuildDragonLair = GetGuildDragonLair();
-		if (pGuildDragonLair != NULL)
-		{
-			CAffect* pAffect = ch->FindAffect(AFFECT_RED_DRAGONLAIR_STONE);
-			if (pAffect && pAffect->lApplyValue)
-				ch->EffectPacket(pAffect->lApplyValue);
-		}
-	}
-#endif
-
-#if defined(__SUMMER_EVENT_ROULETTE__)
-	if (GetRaceNum() == CMiniGameRoulette::EVENT_NPC)
-	{
-		if (CMiniGameRoulette::IsActiveEvent() && CMiniGameRoulette::IsSpecialRoulette(ch))
-		{
-			TPacketGCSpecialEffect p;
-			p.bHeader = HEADER_GC_SEPCIAL_EFFECT;
-			p.bEffectNum = SE_SPECIAL_ROULETTE;
-			p.dwVID = GetVID();
-			d->Packet(&p, sizeof(p));
-		}
-	}
-#endif
-
-#ifdef __OFFLINE_SHOP__
-	if (IsNPC()) {
-		auto shopPtr = COfflineShop::Get(GetKeepingOfflineShop());
-		if (shopPtr) {
-			shopPtr->get()->SendSpawnPacket(ch);
-		}
-	}
-#endif
-
-	if (entity->IsType(ENTITY_CHARACTER))
-	{
-		sys_log(3, "EntityInsert %s (RaceNum %d) (%d %d) TO %s",
-			GetName(), GetRaceNum(), GetX() / SECTREE_SIZE, GetY() / SECTREE_SIZE, ((LPCHARACTER)entity)->GetName());
-	}
-}
-
-void CHARACTER::EncodeRemovePacket(LPENTITY entity)
-{
-	if (entity->GetType() != ENTITY_CHARACTER)
-		return;
-
-	LPDESC d;
-
-	if (!(d = entity->GetDesc()))
-		return;
-
-	TPacketGCCharacterDelete pack;
-
-	pack.header = HEADER_GC_CHARACTER_DEL;
-	pack.id = m_vid;
-
-	d->Packet(&pack, sizeof(TPacketGCCharacterDelete));
-
-	if (entity->IsType(ENTITY_CHARACTER))
-		sys_log(3, "EntityRemove %s(%d) FROM %s", GetName(), (DWORD)m_vid, ((LPCHARACTER)entity)->GetName());
-}
-
-void CHARACTER::UpdatePacket()
-{
-	if (IsPC() && (!GetDesc() || !GetDesc()->GetCharacter()))
-		return;
-
-	if (GetSectree() == NULL)
-		return;
-
-	TPacketGCCharacterUpdate pack;
-	TPacketGCCharacterUpdate pack2;
-
-	pack.header = HEADER_GC_CHARACTER_UPDATE;
-	pack.dwVID = m_vid;
-
-	pack.adwPart[CHR_EQUIPPART_ARMOR] = GetPart(PART_MAIN);
-	pack.adwPart[CHR_EQUIPPART_WEAPON] = GetPart(PART_WEAPON);
-	pack.adwPart[CHR_EQUIPPART_HEAD] = GetPart(PART_HEAD);
-	pack.adwPart[CHR_EQUIPPART_HAIR] = GetPart(PART_HAIR);
-#if defined(__ACCE_COSTUME_SYSTEM__)
-	pack.adwPart[CHR_EQUIPPART_ACCE] = GetPart(PART_ACCE);
-#endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-	pack.adwPart[CHR_EQUIPPART_AURA] = GetPart(PART_AURA);
-#endif
-#if defined(__QUIVER_SYSTEM__)
-	pack.dwArrow = GetWear(WEAR_ARROW) != NULL ? GetWear(WEAR_ARROW)->GetOriginalVnum() : 0;
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	pack.wRefineElementAffectType = GetRefineElementEffect();
-#endif
-
-	pack.bMovingSpeed = GetLimitPoint(POINT_MOV_SPEED);
-	pack.bAttackSpeed = GetLimitPoint(POINT_ATT_SPEED);
-	pack.bStateFlag = m_bAddChrState;
-	pack.dwAffectFlag[0] = m_afAffectFlag.bits[0];
-	pack.dwAffectFlag[1] = m_afAffectFlag.bits[1];
-	pack.dwAffectFlag[2] = m_afAffectFlag.bits[2];
-	pack.dwGuildID = GetGuild() ? GetGuild()->GetID() : 0;
-	pack.sAlignment = m_iAlignment / 10;
-	//pack.dwLevel = IsPC() ? GetLevel() : 0;
-	pack.dwLevel = GetLevel();
-#if defined(__CONQUEROR_LEVEL__)
-	pack.dwConquerorLevel = IsPC() ? GetConquerorLevel() : 0;
-#endif
-	pack.bPKMode = m_bPKMode;
-	pack.dwMountVnum = GetMountVnum();
-#if defined(__LEFT_SEAT__)
-	pack.bLeftSeat = IsPC() ? LeftSeat() : false;
-#endif
-
-#if defined(__GUILD_LEADER_GRADE_NAME__)
-	CGuild* pGuild = this->GetGuild();
-	if (pGuild)
-	{
-		if (pGuild->GetMasterPID() == GetPlayerID())
-			pack.bGuildLeaderGrade = 3;
-		else if (pGuild->GetGeneralPID(GetPlayerID()) != 0)
-			pack.bGuildLeaderGrade = 2;
-		else
-			pack.bGuildLeaderGrade = 1;
-	}
-	else
-	{
-		pack.bGuildLeaderGrade = 0;
-	}
-#endif
-
-	pack2 = pack;
-	pack2.dwGuildID = 0;
-	pack2.sAlignment = 0;
-
-	if (false)
-	{
-		if (m_bIsObserver != true)
-		{
-			for (ENTITY_MAP::iterator iter = m_map_view.begin(); iter != m_map_view.end(); iter++)
-			{
-				LPENTITY pEntity = iter->first;
-
-				if (pEntity != NULL)
-				{
-					if (pEntity->IsType(ENTITY_CHARACTER) == true)
-					{
-						if (pEntity->GetDesc() != NULL)
-						{
-							LPCHARACTER pChar = (LPCHARACTER)pEntity;
-
-							if (GetEmpire() == pChar->GetEmpire() || pChar->GetGMLevel() > GM_PLAYER)
-							{
-								pEntity->GetDesc()->Packet(&pack, sizeof(pack));
-							}
-							else
-							{
-								pEntity->GetDesc()->Packet(&pack2, sizeof(pack2));
-							}
-						}
-					}
-					else
-					{
-						if (pEntity->GetDesc() != NULL)
-						{
-							pEntity->GetDesc()->Packet(&pack, sizeof(pack));
-						}
-					}
-				}
-			}
-		}
-
-		if (GetDesc() != NULL)
-		{
-			GetDesc()->Packet(&pack, sizeof(pack));
-		}
-	}
-	else
-	{
-		PacketAround(&pack, sizeof(pack));
-	}
-}
-
-LPCHARACTER CHARACTER::FindCharacterInView(const char* c_pszName, bool bFindPCOnly)
-{
-	ENTITY_MAP::iterator it = m_map_view.begin();
-
-	for (; it != m_map_view.end(); ++it)
-	{
-		if (!it->first->IsType(ENTITY_CHARACTER))
-			continue;
-
-		LPCHARACTER tch = (LPCHARACTER)it->first;
-
-		if (bFindPCOnly && tch->IsNPC())
-			continue;
-
-		if (!strcasecmp(tch->GetName(), c_pszName))
-			return (tch);
-	}
-
-	return NULL;
-}
-
-void CHARACTER::SetPosition(int pos)
-{
-	if (pos == POS_STANDING)
-	{
-		REMOVE_BIT(m_bAddChrState, ADD_CHARACTER_STATE_DEAD);
-		REMOVE_BIT(m_pointsInstant.instant_flag, INSTANT_FLAG_STUN);
-
-		event_cancel(&m_pkDeadEvent);
-		event_cancel(&m_pkStunEvent);
-	}
-	else if (pos == POS_DEAD)
-		SET_BIT(m_bAddChrState, ADD_CHARACTER_STATE_DEAD);
-
-	if (!IsStone())
-	{
-		switch (pos)
-		{
-			case POS_FIGHTING:
-				if (!IsState(m_stateBattle))
-					MonsterLog("[BATTLE] ο ");
-
-				GotoState(m_stateBattle);
-				break;
-
-			default:
-				if (!IsState(m_stateIdle))
-					MonsterLog("[IDLE]  ");
-
-				GotoState(m_stateIdle);
-				break;
-		}
-	}
-
-	m_pointsInstant.position = pos;
-}
-
-void CHARACTER::Save()
-{
-	if (!m_bSkipSave)
-		CHARACTER_MANAGER::instance().DelayedSave(this);
-}
-
-void CHARACTER::CreatePlayerProto(TPlayerTable& tab)
-{
-	memset(&tab, 0, sizeof(TPlayerTable));
-
-	if (GetNewName().empty())
-	{
-		strlcpy(tab.name, GetName(), sizeof(tab.name));
-	}
-	else
-	{
-		strlcpy(tab.name, GetNewName().c_str(), sizeof(tab.name));
-	}
-
-	strlcpy(tab.ip, GetDesc()->GetHostName(), sizeof(tab.ip));
-
-	tab.id = m_dwPlayerID;
-	tab.voice = GetPoint(POINT_VOICE);
-	tab.level = GetLevel();
-	tab.level_step = GetPoint(POINT_LEVEL_STEP);
-	tab.exp = GetExp();
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	tab.inven_stage = GetExtendInvenStage();
-#endif
-	tab.gold = GetGold();
-#if defined(__CHEQUE_SYSTEM__)
-	tab.cheque = GetCheque();
-#endif
-#if defined(__GEM_SYSTEM__)
-	tab.gem = GetGem();
-#endif
-	tab.job = m_points.bJob;
-	tab.part_base = m_pointsInstant.bBasePart;
-	tab.skill_group = m_points.bSkillGroup;
-
-	DWORD dwPlayedTime = (get_dword_time() - m_dwPlayStartTime);
-
-	if (dwPlayedTime > 60000)
-	{
-		if (GetSectree() && !GetSectree()->IsAttr(GetX(), GetY(), ATTR_BANPK))
-		{
-			if (GetRealAlignment() < 0)
-			{
-				if (IsEquipUniqueItem(UNIQUE_ITEM_FASTER_ALIGNMENT_UP_BY_TIME))
-					UpdateAlignment(120 * (dwPlayedTime / 60000));
-				else
-					UpdateAlignment(60 * (dwPlayedTime / 60000));
-			}
-			else
-				UpdateAlignment(5 * (dwPlayedTime / 60000));
-		}
-
-		SetRealPoint(POINT_PLAYTIME, GetRealPoint(POINT_PLAYTIME) + dwPlayedTime / 60000);
-		ResetPlayTime(dwPlayedTime % 60000);
-	}
-
-	tab.playtime = GetRealPoint(POINT_PLAYTIME);
-	tab.lAlignment = m_iRealAlignment;
-
-	if (m_posWarp.x != 0 || m_posWarp.y != 0)
-	{
-		tab.x = m_posWarp.x;
-		tab.y = m_posWarp.y;
-		tab.z = 0;
-		tab.lMapIndex = m_lWarpMapIndex;
-	}
-	else
-	{
-		tab.x = GetX();
-		tab.y = GetY();
-		tab.z = GetZ();
-		tab.lMapIndex = GetMapIndex();
-	}
-
-	if (m_lExitMapIndex == 0)
-	{
-		tab.lExitMapIndex = tab.lMapIndex;
-		tab.lExitX = tab.x;
-		tab.lExitY = tab.y;
-	}
-	else
-	{
-		tab.lExitMapIndex = m_lExitMapIndex;
-		tab.lExitX = m_posExit.x;
-		tab.lExitY = m_posExit.y;
-	}
-
-	sys_log(0, "SAVE: %s %dx%d", GetName(), tab.x, tab.y);
-
-	tab.st = GetRealPoint(POINT_ST);
-	tab.ht = GetRealPoint(POINT_HT);
-	tab.dx = GetRealPoint(POINT_DX);
-	tab.iq = GetRealPoint(POINT_IQ);
-
-	tab.stat_point = GetPoint(POINT_STAT);
-	tab.skill_point = GetPoint(POINT_SKILL);
-	tab.sub_skill_point = GetPoint(POINT_SUB_SKILL);
-	tab.horse_skill_point = GetPoint(POINT_HORSE_SKILL);
-
-	tab.stat_reset_count = GetPoint(POINT_STAT_RESET_COUNT);
-
-	tab.hp = GetHP();
-	tab.sp = GetSP();
-
-	tab.stamina = GetStamina();
-
-	tab.sRandomHP = m_points.iRandomHP;
-	tab.sRandomSP = m_points.iRandomSP;
-
-	for (int i = 0; i < QUICKSLOT_MAX_NUM; ++i)
-		tab.quickslot[i] = m_quickslot[i];
-
-	thecore_memcpy(tab.adwParts, m_pointsInstant.adwParts, sizeof(tab.adwParts));
-
-	// REMOVE_REAL_SKILL_LEVLES
-	thecore_memcpy(tab.skills, m_pSkillLevels, sizeof(TPlayerSkill) * SKILL_MAX_NUM);
-	// END_OF_REMOVE_REAL_SKILL_LEVLES
-
-	tab.horse = GetHorseData();
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	tab.battle_pass_premium_id = GetExtBattlePassPremiumID();
-#endif
-
-#if defined(__CONQUEROR_LEVEL__)
-	tab.conqueror_level = GetConquerorLevel();
-	tab.conqueror_level_step = GetPoint(POINT_CONQUEROR_LEVEL_STEP);
-	tab.conqueror_exp = GetConquerorExp();
-
-	tab.sungma_str = GetRealPoint(POINT_SUNGMA_STR);
-	tab.sungma_hp = GetRealPoint(POINT_SUNGMA_HP);
-	tab.sungma_move = GetRealPoint(POINT_SUNGMA_MOVE);
-	tab.sungma_immune = GetRealPoint(POINT_SUNGMA_IMMUNE);
-
-	tab.conqueror_point = GetPoint(POINT_CONQUEROR_POINT);
-#endif
-}
-
-void CHARACTER::SaveReal()
-{
-	if (m_bSkipSave)
-		return;
-
-	if (!GetDesc())
-	{
-		sys_err("Character::Save : no descriptor when saving (name: %s)", GetName());
-		return;
-	}
-
-	TPlayerTable table;
-	CreatePlayerProto(table);
-
-	db_clientdesc->DBPacket(HEADER_GD_PLAYER_SAVE, GetDesc()->GetHandle(), &table, sizeof(TPlayerTable));
-
-	quest::PC* pkQuestPC = quest::CQuestManager::instance().GetPCForce(GetPlayerID());
-
-	if (!pkQuestPC)
-		sys_err("CHARACTER::Save : null quest::PC pointer! (name %s)", GetName());
-	else
-	{
-		pkQuestPC->Save();
-	}
-
-	marriage::TMarriage* pMarriage = marriage::CManager::instance().Get(GetPlayerID());
-	if (pMarriage)
-		pMarriage->Save();
-}
-
-void CHARACTER::FlushDelayedSaveItem()
-{
-	int i = 0;
-
-	//  ȵ ǰ  Ų.
-	LPITEM item = nullptr;
-
-	for (int i = 0; i < INVENTORY_MAX_NUM; ++i)
-	{
-		if ((item = GetInventoryItem(i)))
-			ITEM_MANAGER::Instance().FlushDelayedSave(item);
-	}
-
-	for (int i = 0; i < EQUIPMENT_MAX_NUM; ++i)
-	{
-		if ((item = GetEquipmentItem(i)))
-			ITEM_MANAGER::Instance().FlushDelayedSave(item);
-	}
-
-#if defined(__DRAGON_SOUL_SYSTEM__)
-	for (int i = 0; i < DRAGON_SOUL_INVENTORY_MAX_NUM; ++i)
-	{
-		if ((item = GetDragonSoulInventoryItem(i)))
-			ITEM_MANAGER::Instance().FlushDelayedSave(item);
-	}
-#endif
-
-	for (int i = 0; i < BELT_INVENTORY_SLOT_COUNT; ++i)
-	{
-		if ((item = GetBeltInventoryItem(i)))
-			ITEM_MANAGER::Instance().FlushDelayedSave(item);
-	}
-}
-
-void CHARACTER::Disconnect(const char* c_pszReason)
-{
-	assert(GetDesc() != NULL);
-
-	sys_log(0, "DISCONNECT: %s (%s)", GetName(), c_pszReason ? c_pszReason : "unset");
-
-	if (GetShop())
-	{
-		GetShop()->RemoveGuest(this);
-		SetShop(NULL);
-	}
-
-	if (GetArena() != NULL)
-	{
-		GetArena()->OnDisconnect(GetPlayerID());
-	}
-
-	if (GetParty() != NULL)
-	{
-		GetParty()->UpdateOfflineState(GetPlayerID());
-	}
-
-	marriage::CManager::instance().Logout(this);
-
-#if defined(__LUCKY_BOX__)
-	LuckyBoxReceive();
-#endif
-
-	// P2P Logout
-	TPacketGGLogout p;
-	p.bHeader = HEADER_GG_LOGOUT;
-	strlcpy(p.szName, GetName(), sizeof(p.szName));
-	P2P_MANAGER::instance().Send(&p, sizeof(TPacketGGLogout));
-	char buf[51];
-#if defined(__CHEQUE_SYSTEM__) && defined(__GEM_SYSTEM__)
-	snprintf(buf, sizeof(buf), "%s %d %d %d %d %ld %d",
-		inet_ntoa(GetDesc()->GetAddr().sin_addr), GetGold(), GetCheque(), GetGem(), g_bChannel, GetMapIndex(), GetAlignment());
-#elif defined(__CHEQUE_SYSTEM__)
-	snprintf(buf, sizeof(buf), "%s %d %d %d %ld %d",
-		inet_ntoa(GetDesc()->GetAddr().sin_addr), GetGold(), GetCheque(), g_bChannel, GetMapIndex(), GetAlignment());
-#else
-	snprintf(buf, sizeof(buf), "%s %d %d %ld %d",
-		inet_ntoa(GetDesc()->GetAddr().sin_addr), GetGold(), g_bChannel, GetMapIndex(), GetAlignment());
-#endif
-	LogManager::instance().CharLog(this, 0, "LOGOUT", buf);
-
-	if (LC_IsYMIR() || LC_IsKorea() || LC_IsBrazil())
-	{
-		long playTime = GetRealPoint(POINT_PLAYTIME) - m_dwLoginPlayTime;
-		LogManager::instance().LoginLog(false, GetDesc()->GetAccountTable().id, GetPlayerID(), GetLevel(), GetJob(), playTime);
-
-		if (LC_IsBrazil() != true)
-			CPCBangManager::instance().Log(GetDesc()->GetHostName(), GetPlayerID(), playTime);
-	}
-
-	if (m_pWarMap)
-		SetWarMap(NULL);
-
-	if (m_pWeddingMap)
-	{
-		SetWeddingMap(NULL);
-	}
-
-	if (GetGuild())
-		GetGuild()->LogoutMember(this);
-
-	quest::CQuestManager::instance().LogoutPC(this);
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	ListExtBattlePassMap::iterator itext = m_listExtBattlePass.begin();
-	while (itext != m_listExtBattlePass.end())
-	{
-		TPlayerExtBattlePassMission* pkMission = *itext++;
-
-		if (!pkMission->bIsUpdated)
-			continue;
-
-		db_clientdesc->DBPacket(HEADER_GD_SAVE_EXT_BATTLE_PASS, 0, pkMission, sizeof(TPlayerExtBattlePassMission));
-	}
-	m_bIsLoadedExtBattlePass = false;
-#endif
-
-	if (GetParty())
-		GetParty()->Unlink(this);
-
-	// ׾  Ӳ ġ ٰ ϱ
-	if (IsStun() || IsDead())
-	{
-		DeathPenalty(0);
-		PointChange(POINT_HP, 50 - GetHP());
-	}
-
-	if (!CHARACTER_MANAGER::instance().FlushDelayedSave(this))
-	{
-		SaveReal();
-	}
-
-	FlushDelayedSaveItem();
-
-	SaveAffect();
-	m_bIsLoadedAffect = false;
-
-	m_bSkipSave = true; //  Ŀ ̻ ϸ ȵȴ.
-
-	quest::CQuestManager::instance().DisconnectPC(this);
-
-	CloseSafebox();
-	CloseMall();
-
-#if defined(__ACCE_COSTUME_SYSTEM__)
-	if (IsAcceRefineWindowOpen())
-		AcceRefineWindowClose(true);
-#endif
-
-#if defined(__AURA_COSTUME_SYSTEM__)
-	if (IsAuraRefineWindowOpen())
-		AuraRefineWindowClose(true);
-#endif
-
-	CPVPManager::instance().Disconnect(this);
-
-	CTargetManager::instance().Logout(GetPlayerID());
-
-	CMessengerManager::instance().Logout(GetName());
-
-#ifdef __OFFLINE_SHOP__
-	COfflineShop::Logout(GetPlayerID());
-	SaveSellHistory();
-#endif
-
-	if (GetDesc())
-	{
-#if defined(__IMPROVED_LOGOUT_POINTS__)
-		packet_point_change pack;
-		pack.bHeader = HEADER_GC_CHARACTER_POINT_CHANGE;
-		pack.dwVID = m_vid;
-		pack.wType = POINT_PLAYTIME;
-		pack.lValue = GetRealPoint(POINT_PLAYTIME) + (get_dword_time() - m_dwPlayStartTime) / 60000;
-		pack.lAmount = 0;
-		GetDesc()->Packet(&pack, sizeof(struct packet_point_change));
-#endif
-		GetDesc()->BindCharacter(NULL);
-		// BindDesc(NULL);
-	}
-
-	M2_DESTROY_CHARACTER(this);
-}
-
-bool CHARACTER::Show(long lMapIndex, long x, long y, long z, bool bShowSpawnMotion/* = false */
-#if defined(__WJ_SHOW_MOB_INFO__)
-	, bool bAggressive
-#endif
-)
-{
-	LPSECTREE sectree = SECTREE_MANAGER::instance().Get(lMapIndex, x, y);
-	if (!sectree)
-	{
-		sys_log(0, "cannot find sectree by %dx%d mapindex %d", x, y, lMapIndex);
-		return false;
-	}
-
-	SetMapIndex(lMapIndex);
-
-	bool bChangeTree = false;
-
-	if (!GetSectree() || GetSectree() != sectree)
-		bChangeTree = true;
-
-	if (bChangeTree)
-	{
-		if (GetSectree())
-			GetSectree()->RemoveEntity(this);
-
-		ViewCleanup();
-	}
-
-	if (!IsNPC())
-	{
-		sys_log(0, "SHOW: %s %dx%dx%d", GetName(), x, y, z);
-		if (GetStamina() < GetMaxStamina())
-			StartAffectEvent();
-	}
-	else if (m_pkMobData)
-	{
-		m_pkMobInst->m_posLastAttacked.x = x;
-		m_pkMobInst->m_posLastAttacked.y = y;
-		m_pkMobInst->m_posLastAttacked.z = z;
-	}
-
-	if (bShowSpawnMotion)
-	{
-		SET_BIT(m_bAddChrState, ADD_CHARACTER_STATE_SPAWN);
-		m_afAffectFlag.Set(AFF_SPAWN);
-	}
-
-#if defined(__WJ_SHOW_MOB_INFO__)
-	if (bAggressive)
-		SetAggressive();
-#endif
-
-	SetXYZ(x, y, z);
-
-	m_posDest.x = x;
-	m_posDest.y = y;
-	m_posDest.z = z;
-
-	m_posStart.x = x;
-	m_posStart.y = y;
-	m_posStart.z = z;
-
-	if (bChangeTree)
-	{
-		EncodeInsertPacket(this);
-		sectree->InsertEntity(this);
-
-		UpdateSectree();
-	}
-	else
-	{
-		ViewReencode();
-		sys_log(0, "      in same sectree");
-	}
-
-	REMOVE_BIT(m_bAddChrState, ADD_CHARACTER_STATE_SPAWN);
-
-	SetValidComboInterval(0);
-	return true;
-}
-
-// BGM_INFO
-struct BGMInfo
-{
-	std::string name;
-	float vol;
-};
-
-typedef std::map<unsigned, BGMInfo> BGMInfoMap;
-
-static BGMInfoMap gs_bgmInfoMap;
-static bool gs_bgmVolEnable = false;
-
-void CHARACTER_SetBGMVolumeEnable()
-{
-	gs_bgmVolEnable = true;
-	sys_log(0, "bgm_info.set_bgm_volume_enable");
-}
-
-void CHARACTER_AddBGMInfo(unsigned mapIndex, const char* name, float vol)
-{
-	BGMInfo newInfo;
-	newInfo.name = name;
-	newInfo.vol = vol;
-
-	gs_bgmInfoMap[mapIndex] = newInfo;
-
-	sys_log(0, "bgm_info.add_info(%d, '%s', %f)", mapIndex, name, vol);
-}
-
-const BGMInfo& CHARACTER_GetBGMInfo(unsigned mapIndex)
-{
-	BGMInfoMap::iterator f = gs_bgmInfoMap.find(mapIndex);
-	if (gs_bgmInfoMap.end() == f)
-	{
-		static BGMInfo s_empty = { "", 0.0f };
-		return s_empty;
-	}
-	return f->second;
-}
-
-bool CHARACTER_IsBGMVolumeEnable()
-{
-	return gs_bgmVolEnable;
-}
-// END_OF_BGM_INFO
-
-void CHARACTER::MainCharacterPacket()
-{
-	const unsigned mapIndex = GetMapIndex();
-	const BGMInfo& bgmInfo = CHARACTER_GetBGMInfo(mapIndex);
-
-	// SUPPORT_BGM
-	if (!bgmInfo.name.empty())
-	{
-		if (CHARACTER_IsBGMVolumeEnable())
-		{
-			sys_log(1, "bgm_info.play_bgm_vol(%d, name='%s', vol=%f)", mapIndex, bgmInfo.name.c_str(), bgmInfo.vol);
-			TPacketGCMainCharacter4_BGM_VOL mainChrPacket;
-			mainChrPacket.header = HEADER_GC_MAIN_CHARACTER4_BGM_VOL;
-			mainChrPacket.dwVID = m_vid;
-			mainChrPacket.wRaceNum = GetRaceNum();
-			mainChrPacket.lx = GetX();
-			mainChrPacket.ly = GetY();
-			mainChrPacket.lz = GetZ();
-			mainChrPacket.empire = GetDesc()->GetEmpire();
-			mainChrPacket.skill_group = GetSkillGroup();
-			strlcpy(mainChrPacket.szChrName, GetName(), sizeof(mainChrPacket.szChrName));
-
-			mainChrPacket.fBGMVol = bgmInfo.vol;
-			strlcpy(mainChrPacket.szBGMName, bgmInfo.name.c_str(), sizeof(mainChrPacket.szBGMName));
-			GetDesc()->Packet(&mainChrPacket, sizeof(TPacketGCMainCharacter4_BGM_VOL));
-		}
-		else
-		{
-			sys_log(1, "bgm_info.play(%d, '%s')", mapIndex, bgmInfo.name.c_str());
-			TPacketGCMainCharacter3_BGM mainChrPacket;
-			mainChrPacket.header = HEADER_GC_MAIN_CHARACTER3_BGM;
-			mainChrPacket.dwVID = m_vid;
-			mainChrPacket.wRaceNum = GetRaceNum();
-			mainChrPacket.lx = GetX();
-			mainChrPacket.ly = GetY();
-			mainChrPacket.lz = GetZ();
-			mainChrPacket.empire = GetDesc()->GetEmpire();
-			mainChrPacket.skill_group = GetSkillGroup();
-			strlcpy(mainChrPacket.szChrName, GetName(), sizeof(mainChrPacket.szChrName));
-			strlcpy(mainChrPacket.szBGMName, bgmInfo.name.c_str(), sizeof(mainChrPacket.szBGMName));
-			GetDesc()->Packet(&mainChrPacket, sizeof(TPacketGCMainCharacter3_BGM));
-		}
-	}
-	// END_OF_SUPPORT_BGM
-	else
-	{
-		sys_log(0, "bgm_info.play(%d, DEFAULT_BGM_NAME)", mapIndex);
-
-		TPacketGCMainCharacter pack;
-		pack.header = HEADER_GC_MAIN_CHARACTER;
-		pack.dwVID = m_vid;
-		pack.wRaceNum = GetRaceNum();
-		pack.lx = GetX();
-		pack.ly = GetY();
-		pack.lz = GetZ();
-		pack.empire = GetDesc()->GetEmpire();
-		pack.skill_group = GetSkillGroup();
-		strlcpy(pack.szName, GetName(), sizeof(pack.szName));
-		GetDesc()->Packet(&pack, sizeof(TPacketGCMainCharacter));
-	}
-}
-
-void CHARACTER::PointsPacket()
-{
-	if (!GetDesc())
-		return;
-
-	TPacketGCPoints Packet;
-	Packet.bHeader = HEADER_GC_CHARACTER_POINTS;
-	Packet.lPoints[POINT_LEVEL] = GetLevel();
-	Packet.lPoints[POINT_EXP] = GetExp();
-	Packet.lPoints[POINT_NEXT_EXP] = GetNextExp();
-	Packet.lPoints[POINT_HP] = GetHP();
-	Packet.lPoints[POINT_MAX_HP] = GetMaxHP();
-	Packet.lPoints[POINT_SP] = GetSP();
-	Packet.lPoints[POINT_MAX_SP] = GetMaxSP();
-	Packet.lPoints[POINT_GOLD] = GetGold();
-	Packet.lPoints[POINT_STAMINA] = GetStamina();
-	Packet.lPoints[POINT_MAX_STAMINA] = GetMaxStamina();
-
-	for (WORD wPointType = POINT_ST; wPointType < POINT_MAX_NUM; ++wPointType)
-		Packet.lPoints[wPointType] = GetPoint(wPointType);
-
-#if defined(__CONQUEROR_LEVEL__)
-	Packet.lPoints[POINT_CONQUEROR_LEVEL] = GetConquerorLevel();
-	Packet.lPoints[POINT_CONQUEROR_EXP] = GetConquerorExp();
-	Packet.lPoints[POINT_CONQUEROR_NEXT_EXP] = GetNextConquerorExp();
-
-	Packet.lPoints[POINT_MOV_SPEED] = GetLimitPoint(POINT_MOV_SPEED);
-#endif
-
-#if defined(__CHEQUE_SYSTEM__)
-	Packet.lPoints[POINT_CHEQUE] = GetCheque();
-#endif
-#if defined(__GEM_SYSTEM__)
-	Packet.lPoints[POINT_GEM] = GetGem();
-#endif
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	Packet.lPoints[POINT_BATTLE_PASS_PREMIUM_ID] = GetExtBattlePassPremiumID();
-#endif
-
-	GetDesc()->Packet(&Packet, sizeof(Packet));
-}
-
-void CHARACTER::UpdatePointsPacket(POINT_TYPE wPointType, POINT_VALUE lPointValue, POINT_VALUE lPointAmount, bool bAmount, bool bBroadcast)
-{
-	if (GetDesc())
-	{
-		TPacketGCPointChange Packet;
-		Packet.bHeader = HEADER_GC_CHARACTER_POINT_CHANGE;
-		Packet.dwVID = m_vid;
-		Packet.wType = wPointType;
-		Packet.lValue = lPointValue;
-		Packet.lAmount = bAmount ? lPointAmount : 0;
-
-		if (!bBroadcast)
-			GetDesc()->Packet(&Packet, sizeof(Packet));
-		else
-			PacketAround(&Packet, sizeof(Packet));
-	}
-}
-
-bool CHARACTER::ChangeSex()
-{
-	int src_race = GetRaceNum();
-
-	switch (src_race)
-	{
-		case MAIN_RACE_WARRIOR_M:
-			m_points.bJob = MAIN_RACE_WARRIOR_W;
-			break;
-
-		case MAIN_RACE_WARRIOR_W:
-			m_points.bJob = MAIN_RACE_WARRIOR_M;
-			break;
-
-		case MAIN_RACE_ASSASSIN_M:
-			m_points.bJob = MAIN_RACE_ASSASSIN_W;
-			break;
-
-		case MAIN_RACE_ASSASSIN_W:
-			m_points.bJob = MAIN_RACE_ASSASSIN_M;
-			break;
-
-		case MAIN_RACE_SURA_M:
-			m_points.bJob = MAIN_RACE_SURA_W;
-			break;
-
-		case MAIN_RACE_SURA_W:
-			m_points.bJob = MAIN_RACE_SURA_M;
-			break;
-
-		case MAIN_RACE_SHAMAN_M:
-			m_points.bJob = MAIN_RACE_SHAMAN_W;
-			break;
-
-		case MAIN_RACE_SHAMAN_W:
-			m_points.bJob = MAIN_RACE_SHAMAN_M;
-			break;
-
-		case MAIN_RACE_WOLFMAN_M:
-			m_points.bJob = MAIN_RACE_WOLFMAN_M;
-			break;
-
-		default:
-			sys_err("CHANGE_SEX: %s unknown race %d", GetName(), src_race);
-			return false;
-	}
-
-	sys_log(0, "CHANGE_SEX: %s (%d -> %d)", GetName(), src_race, m_points.bJob);
-	return true;
-}
-
-bool CHARACTER::IsMale() const
-{
-	switch (GetRaceNum())
-	{
-		case MAIN_RACE_WARRIOR_M:
-		case MAIN_RACE_SURA_M:
-		case MAIN_RACE_ASSASSIN_M:
-		case MAIN_RACE_SHAMAN_M:
-		case MAIN_RACE_WOLFMAN_M:
-			return true;
-	}
-	return false;
-}
-
-bool CHARACTER::IsFemale() const
-{
-	switch (GetRaceNum())
-	{
-		case MAIN_RACE_ASSASSIN_W:
-		case MAIN_RACE_SHAMAN_W:
-		case MAIN_RACE_WARRIOR_W:
-		case MAIN_RACE_SURA_W:
-			return true;
-	}
-	return false;
-}
-
-WORD CHARACTER::GetRaceNum() const
-{
-	if (m_dwPolymorphRace)
-		return m_dwPolymorphRace;
-
-	if (m_pkMobData)
-		return m_pkMobData->m_table.dwVnum;
-
-	return m_points.bJob;
-}
-
-void CHARACTER::SetRace(BYTE race)
-{
-	if (race >= MAIN_RACE_MAX_NUM)
-	{
-		sys_err("CHARACTER::SetRace(name=%s, race=%d).OUT_OF_RACE_RANGE", GetName(), race);
-		return;
-	}
-
-	m_points.bJob = race;
-}
-
-BYTE CHARACTER::GetJob() const
-{
-	BYTE race = m_points.bJob;
-	BYTE job;
-
-	if (RaceToJob(race, &job))
-		return job;
-
-	sys_err("CHARACTER::GetJob(name=%s, race=%d).OUT_OF_RACE_RANGE", GetName(), race);
-	return JOB_WARRIOR;
-}
-
-void CHARACTER::SetLevel(BYTE bValue)
-{
-	m_points.bLevel = bValue;
-
-	if (IsPC())
-	{
-		if (bValue < PK_PROTECT_LEVEL)
-			SetPKMode(PK_MODE_PROTECT);
-		else if (GetGMLevel() != GM_PLAYER)
-			SetPKMode(PK_MODE_PROTECT);
-		else if (m_bPKMode == PK_MODE_PROTECT)
-			SetPKMode(PK_MODE_PEACE);
-	}
-}
-
-void CHARACTER::SetEmpire(BYTE bEmpire)
-{
-	m_bEmpire = bEmpire;
-}
-
-void CHARACTER::SetPlayerProto(const TPlayerTable* t)
-{
-	if (!GetDesc() || !*GetDesc()->GetHostName())
-		sys_err("cannot get desc or hostname");
-	else
-		SetGMLevel();
-
-	m_bCharType = CHAR_TYPE_PC;
-
-	m_dwPlayerID = t->id;
-
-	m_iAlignment = t->lAlignment;
-	m_iRealAlignment = t->lAlignment;
-
-	m_points.bVoice = t->voice;
-
-	m_points.bSkillGroup = t->skill_group;
-
-	m_pointsInstant.bBasePart = t->part_base;
-	SetPart(PART_HAIR, t->adwParts[PART_HAIR]);
-#if defined(__ACCE_COSTUME_SYSTEM__)
-	SetPart(PART_ACCE, t->adwParts[PART_ACCE]);
-#endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-	SetPart(PART_AURA, t->adwParts[PART_AURA]);
-#endif
-
-	m_points.iRandomHP = t->sRandomHP;
-	m_points.iRandomSP = t->sRandomSP;
-
-	// REMOVE_REAL_SKILL_LEVLES
-	if (m_pSkillLevels)
-		M2_DELETE_ARRAY(m_pSkillLevels);
-
-	m_pSkillLevels = M2_NEW TPlayerSkill[SKILL_MAX_NUM];
-	thecore_memcpy(m_pSkillLevels, t->skills, sizeof(TPlayerSkill) * SKILL_MAX_NUM);
-	// END_OF_REMOVE_REAL_SKILL_LEVLES
-
-	if (t->lMapIndex >= 10000)
-	{
-		m_posWarp.x = t->lExitX;
-		m_posWarp.y = t->lExitY;
-		m_lWarpMapIndex = t->lExitMapIndex;
-	}
-
-	SetRealPoint(POINT_PLAYTIME, t->playtime);
-	m_dwLoginPlayTime = t->playtime;
-	SetRealPoint(POINT_ST, t->st);
-	SetRealPoint(POINT_HT, t->ht);
-	SetRealPoint(POINT_DX, t->dx);
-	SetRealPoint(POINT_IQ, t->iq);
-
-	SetPoint(POINT_ST, t->st);
-	SetPoint(POINT_HT, t->ht);
-	SetPoint(POINT_DX, t->dx);
-	SetPoint(POINT_IQ, t->iq);
-
-	SetPoint(POINT_STAT, t->stat_point);
-	SetPoint(POINT_SKILL, t->skill_point);
-	SetPoint(POINT_SUB_SKILL, t->sub_skill_point);
-	SetPoint(POINT_HORSE_SKILL, t->horse_skill_point);
-
-	SetPoint(POINT_STAT_RESET_COUNT, t->stat_reset_count);
-
-	SetPoint(POINT_LEVEL_STEP, t->level_step);
-	SetRealPoint(POINT_LEVEL_STEP, t->level_step);
-
-	SetRace(t->job);
-
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	SetExtendInvenStage(t->inven_stage);
-#endif
-
-	SetLevel(t->level);
-	SetExp(t->exp);
-	SetGold(t->gold);
-#if defined(__CHEQUE_SYSTEM__)
-	SetCheque(t->cheque);
-#endif
-#if defined(__GEM_SYSTEM__)
-	SetGem(t->gem);
-#endif
-
-#if defined(__CONQUEROR_LEVEL__)
-	SetRealPoint(POINT_SUNGMA_STR, t->sungma_str);
-	SetRealPoint(POINT_SUNGMA_HP, t->sungma_hp);
-	SetRealPoint(POINT_SUNGMA_MOVE, t->sungma_move);
-	SetRealPoint(POINT_SUNGMA_IMMUNE, t->sungma_immune);
-
-	SetPoint(POINT_SUNGMA_STR, t->sungma_str);
-	SetPoint(POINT_SUNGMA_HP, t->sungma_hp);
-	SetPoint(POINT_SUNGMA_MOVE, t->sungma_move);
-	SetPoint(POINT_SUNGMA_IMMUNE, t->sungma_immune);
-
-	SetPoint(POINT_CONQUEROR_POINT, t->conqueror_point);
-
-	SetPoint(POINT_CONQUEROR_LEVEL_STEP, t->conqueror_level_step);
-	SetRealPoint(POINT_CONQUEROR_LEVEL_STEP, t->conqueror_level_step);
-
-	SetConquerorLevel(t->conqueror_level);
-	SetConquerorExp(t->conqueror_exp);
-#endif
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	SetExtBattlePassPremiumID(t->battle_pass_premium_id);
-#endif
-
-	SetMapIndex(t->lMapIndex);
-	SetXYZ(t->x, t->y, t->z);
-
-	ComputePoints();
-
-	SetHP(t->hp);
-	SetSP(t->sp);
-	SetStamina(t->stamina);
-
-	// GM϶ ȣ
-	if (GetGMLevel() > GM_LOW_WIZARD)
-		m_afAffectFlag.Set(AFF_YMIR);
-
-	if (GetLevel() < PK_PROTECT_LEVEL)
-		m_bPKMode = PK_MODE_PROTECT;
-
-	SetHorseData(t->horse);
-
-	if (GetHorseLevel() > 0)
-		UpdateHorseDataByLogoff(t->logoff_interval);
-
-	thecore_memcpy(m_aiPremiumTimes, t->aiPremiumTimes, sizeof(t->aiPremiumTimes));
-
-	m_dwLogOffInterval = t->logoff_interval;
-	m_dwLastAttackTime = t->last_play;
-
-	sys_log(0, "PLAYER_LOAD: %s PREMIUM %d %d, LOGGOFF_INTERVAL %u PTR: %p", t->name, m_aiPremiumTimes[0], m_aiPremiumTimes[1], t->logoff_interval, this);
-
-	if (GetGMLevel() != GM_PLAYER)
-	{
-		LogManager::instance().CharLog(this, GetGMLevel(), "GM_LOGIN", "");
-		sys_log(0, "GM_LOGIN(gmlevel=%d, name=%s(%d), pos=(%d, %d)", GetGMLevel(), GetName(), GetPlayerID(), GetX(), GetY());
-	}
-
-#if defined(__PET_SYSTEM__)
-	// NOTE: ϴ ĳͰ PC 쿡 PetSystem  .  ӽŴ ޸  NPC ϱ ..
-	if (m_petSystem)
-	{
-		m_petSystem->Destroy();
-		delete m_petSystem;
-	}
-
-	m_petSystem = M2_NEW CPetSystem(this);
-#endif
-}
-
-EVENTFUNC(kill_ore_load_event)
-{
-	char_event_info* info = dynamic_cast<char_event_info*>(event->info);
-	if (info == NULL)
-	{
-		sys_err("kill_ore_load_even> <Factor> Null pointer");
-		return 0;
-	}
-
-	LPCHARACTER ch = info->ch;
-
-	if (ch == NULL) // <Factor>
-		return 0;
-
-	ch->m_pkMiningEvent = NULL;
-	M2_DESTROY_CHARACTER(ch);
-	return 0;
-}
-
-void CHARACTER::SetProto(const CMob* pkMob)
-{
-	if (m_pkMobInst)
-		M2_DELETE(m_pkMobInst);
-
-	m_pkMobData = pkMob;
-	m_pkMobInst = M2_NEW CMobInstance;
-
-	m_bPKMode = PK_MODE_FREE;
-
-	const TMobTable* t = &m_pkMobData->m_table;
-
-	m_bCharType = t->bType;
-
-	SetLevel(t->bLevel);
-	SetEmpire(t->bEmpire);
-
-	SetExp(t->dwExp);
-	SetRealPoint(POINT_ST, t->bStr);
-	SetRealPoint(POINT_DX, t->bDex);
-	SetRealPoint(POINT_HT, t->bCon);
-	SetRealPoint(POINT_IQ, t->bInt);
-
-#if defined(__CONQUEROR_LEVEL__)
-	SetConquerorExp(t->dwSungMaExp);
-	SetRealPoint(POINT_SUNGMA_STR, t->bSungMaStr);
-	SetRealPoint(POINT_SUNGMA_HP, t->bSungMaDex);
-	SetRealPoint(POINT_SUNGMA_MOVE, t->bSungMaCon);
-	SetRealPoint(POINT_SUNGMA_IMMUNE, t->bSungMaInt);
-#endif
-
-	ComputePoints();
-
-	SetHP(GetMaxHP());
-	SetSP(GetMaxSP());
-
-	////////////////////
-	m_pointsInstant.dwAIFlag = t->dwAIFlag;
-	SetImmuneFlag(t->dwImmuneFlag);
-
-	AssignTriggers(t);
-
-	ApplyMobAttribute(t);
-
-	if (IsStone())
-	{
-		DetermineDropMetinStone();
-	}
-
-	if (IsWarp() || IsGoto())
-	{
-		StartWarpNPCEvent();
-	}
-
-	CHARACTER_MANAGER::instance().RegisterRaceNumMap(this);
-
-#if defined(__XMAS_EVENT_2008__)
-	// XXX X-mas santa hardcoding
-	if (GetRaceNum() == xmas::MOB_XMAS_SANTA_VNUM)
-	{
-		SetPoint(POINT_ATT_GRADE_BONUS, 10);
-		if (g_iUseLocale)
-			SetPoint(POINT_DEF_GRADE_BONUS, 6);
-		else
-			SetPoint(POINT_DEF_GRADE_BONUS, 15);
-
-		// Ÿ
-		//m_dwPlayStartTime = get_dword_time() + 10 * 60 * 1000;
-		// ż 
-		m_dwPlayStartTime = get_dword_time() + 30 * 1000;
-		if (test_server)
-			m_dwPlayStartTime = get_dword_time() + 30 * 1000;
-	}
-#endif
-
-	// XXX CTF GuildWar hardcoding
-	if (warmap::IsWarFlag(GetRaceNum()))
-	{
-		m_stateIdle.Set(this, &CHARACTER::BeginStateEmpty, &CHARACTER::StateFlag, &CHARACTER::EndStateEmpty);
-		m_stateMove.Set(this, &CHARACTER::BeginStateEmpty, &CHARACTER::StateFlag, &CHARACTER::EndStateEmpty);
-		m_stateBattle.Set(this, &CHARACTER::BeginStateEmpty, &CHARACTER::StateFlag, &CHARACTER::EndStateEmpty);
-	}
-
-	if (warmap::IsWarFlagBase(GetRaceNum()))
-	{
-		m_stateIdle.Set(this, &CHARACTER::BeginStateEmpty, &CHARACTER::StateFlagBase, &CHARACTER::EndStateEmpty);
-		m_stateMove.Set(this, &CHARACTER::BeginStateEmpty, &CHARACTER::StateFlagBase, &CHARACTER::EndStateEmpty);
-		m_stateBattle.Set(this, &CHARACTER::BeginStateEmpty, &CHARACTER::StateFlagBase, &CHARACTER::EndStateEmpty);
-	}
-
-	if (IsHorse() ||
-		GetRaceNum() == 20101 ||
-		GetRaceNum() == 20102 ||
-		GetRaceNum() == 20103 ||
-		GetRaceNum() == 20104 ||
-		GetRaceNum() == 20105 ||
-		GetRaceNum() == 20106 ||
-		GetRaceNum() == 20107 ||
-		GetRaceNum() == 20108 ||
-		GetRaceNum() == 20109
-		)
-	{
-		m_stateIdle.Set(this, &CHARACTER::BeginStateEmpty, &CHARACTER::StateHorse, &CHARACTER::EndStateEmpty);
-		m_stateMove.Set(this, &CHARACTER::BeginStateEmpty, &CHARACTER::StateMove, &CHARACTER::EndStateEmpty);
-		m_stateBattle.Set(this, &CHARACTER::BeginStateEmpty, &CHARACTER::StateHorse, &CHARACTER::EndStateEmpty);
-	}
-
-	// MINING
-	if (mining::IsVeinOfOre(GetRaceNum()))
-	{
-		char_event_info* info = AllocEventInfo<char_event_info>();
-
-		info->ch = this;
-
-		m_pkMiningEvent = event_create(kill_ore_load_event, info, PASSES_PER_SEC(number(7 * 60, 15 * 60)));
-	}
-	// END_OF_MINING
-}
-
-const TMobTable& CHARACTER::GetMobTable() const
-{
-	return m_pkMobData->m_table;
-}
-
-BYTE CHARACTER::GetMobRank() const
-{
-	if (!m_pkMobData)
-		return MOB_RANK_KNIGHT; // PC  KNIGHT
-
-	return m_pkMobData->m_table.bRank;
-}
-
-BYTE CHARACTER::GetMobType() const
-{
-	if (!m_pkMobData)
-		return CHAR_TYPE_MONSTER;
-
-	return m_pkMobData->m_table.bType;
-}
-
-BYTE CHARACTER::GetMobBattleType() const
-{
-	if (!m_pkMobData)
-		return BATTLE_TYPE_MELEE;
-
-	return m_pkMobData->m_table.bBattleType;
-}
-
-BYTE CHARACTER::GetMobSize() const
-{
-	if (!m_pkMobData)
-		return MOBSIZE_MEDIUM;
-
-	return m_pkMobData->m_table.bSize;
-}
-
-DWORD CHARACTER::GetMobDamageMin() const
-{
-	return m_pkMobData ? m_pkMobData->m_table.dwDamageRange[0] : 0;
-}
-
-DWORD CHARACTER::GetMobDamageMax() const
-{
-	return m_pkMobData ? m_pkMobData->m_table.dwDamageRange[1] : 0;
-}
-
-WORD CHARACTER::GetMobAttackRange() const
-{
-	WORD wAttackRange = m_pkMobData ? m_pkMobData->m_table.wAttackRange : 0;
-	float fHitRange = m_pkMobData ? m_pkMobData->m_table.fHitRange : 0;
-
-	switch (GetMobBattleType())
-	{
-		case BATTLE_TYPE_RANGE:
-		case BATTLE_TYPE_MAGIC:
-		{
-#if defined(__DEFENSE_WAVE__)
-			if (m_pkMobData && CDefenseWaveManager::Instance().IsHydra(GetRaceNum()) && GetDefenseWave())
-				return wAttackRange + GetPoint(POINT_BOW_DISTANCE) + fHitRange + 2000;
-#endif
-			return wAttackRange + GetPoint(POINT_BOW_DISTANCE) + fHitRange;
-		}
-		default:
-		{
-#if defined(__DEFENSE_WAVE__)
-			if (m_pkMobData && GetDefenseWave())
-				return wAttackRange + fHitRange + 300;
-#endif
-			return wAttackRange + fHitRange;
-		}
-	}
-}
-
-DWORD CHARACTER::GetMobDropItemVnum() const
-{
-	return m_pkMobData ? m_pkMobData->m_table.dwDropItemVnum : 0;
-}
-
-float CHARACTER::GetMobDamageMultiply() const
-{
-	float fDamMultiply = GetMobTable().fDamMultiply;
-
-	if (IsBerserk())
-		fDamMultiply = fDamMultiply * 2.0f; // BALANCE: ȭ  ι
-
-	return fDamMultiply;
-}
-
-#if defined(__ELEMENT_SYSTEM__)
-int CHARACTER::GetMobElement(BYTE bElement) const
-{
-	if (m_pkMobData && bElement >= MOB_ELEMENT_ELECT && bElement < MOB_ELEMENT_MAX_NUM)
-		return m_pkMobData->m_table.cElements[bElement];
-	return 0;
-}
-#endif
-
-float CHARACTER::GetMonsterHitRange() const
-{
-	if (!m_pkMobData)
-		return 70.0f;
-
-	if (m_pkMobData->m_table.fHitRange)
-		return m_pkMobData->m_table.fHitRange;
-
-	return 100.0f;
-}
-
-bool CHARACTER::IsRaceFlag(DWORD dwBit) const
-{
-	return m_pkMobData ? IS_SET(m_pkMobData->m_table.dwRaceFlag, dwBit) : 0;
-}
-
-bool CHARACTER::IsSummonMonster() const
-{
-	return GetSummonVnum() != 0;
-}
-
-DWORD CHARACTER::GetSummonVnum() const
-{
-	return m_pkMobData ? m_pkMobData->m_table.dwSummonVnum : 0;
-}
-
-bool CHARACTER::CanSummonMonster() const
-{
-	if (!IsSummonMonster())
-		return false;
-
-	return (thecore_pulse() > m_lastSummonTime + PASSES_PER_SEC(m_newSummonInterval));
-}
-
-void CHARACTER::MarkSummonedMonster()
-{
-	m_lastSummonTime = thecore_pulse();
-	m_newSummonInterval = number(g_npcGroupRespawnRange[0], g_npcGroupRespawnRange[1]);
-}
-
-DWORD CHARACTER::GetPolymorphItemVnum() const
-{
-	return m_pkMobData ? m_pkMobData->m_table.dwPolymorphItemVnum : 0;
-}
-
-DWORD CHARACTER::GetMonsterDrainSPPoint() const
-{
-	return m_pkMobData ? m_pkMobData->m_table.dwDrainSP : 0;
-}
-
-void CHARACTER::ComputeBattlePoints()
-{
-	if (IsPolymorphed())
-	{
-		DWORD dwMobVnum = GetPolymorphVnum();
-		const CMob* pMob = CMobManager::instance().Get(dwMobVnum);
-		int iAtt = 0;
-		int iDef = 0;
-
-		if (pMob)
-		{
-			iAtt = GetLevel() * 2 + GetPolymorphPoint(POINT_ST) * 2;
-			// lev + con
-			iDef = GetLevel() + GetPolymorphPoint(POINT_HT) + pMob->m_table.wDef;
-		}
-
-		SetPoint(POINT_ATT_GRADE, iAtt);
-		SetPoint(POINT_DEF_GRADE, iDef);
-		SetPoint(POINT_MAGIC_ATT_GRADE, GetPoint(POINT_ATT_GRADE));
-		SetPoint(POINT_MAGIC_DEF_GRADE, GetPoint(POINT_DEF_GRADE));
-	}
-	else if (IsPC())
-	{
-		SetPoint(POINT_ATT_GRADE, 0);
-		SetPoint(POINT_DEF_GRADE, 0);
-		SetPoint(POINT_CLIENT_DEF_GRADE, 0);
-		SetPoint(POINT_MAGIC_ATT_GRADE, GetPoint(POINT_ATT_GRADE));
-		SetPoint(POINT_MAGIC_DEF_GRADE, GetPoint(POINT_DEF_GRADE));
-
-		//
-		// ⺻ ATK = 2lev + 2str,   2str ٲ  
-		//
-		int iAtk = GetLevel() * 2;
-		int iStatAtk = 0;
-
-		switch (GetJob())
-		{
-			case JOB_WARRIOR:
-			case JOB_SURA:
-				iStatAtk = (4 * GetPoint(POINT_ST) + 2 * GetPoint(POINT_DX)) / 3;
-				break;
-
-			case JOB_ASSASSIN:
-				iStatAtk = (5 * GetPoint(POINT_DX) + 1 * GetPoint(POINT_ST)) / 3;
-				break;
-
-			case JOB_SHAMAN:
-				iStatAtk = (5 * GetPoint(POINT_IQ) + 1 * GetPoint(POINT_DX)) / 3;
-				break;
-
-			case JOB_WOLFMAN:
-				iStatAtk = (7 * GetPoint(POINT_DX) + 2 * GetPoint(POINT_HT)) / 3;
-				break;
-
-			default:
-				sys_err("invalid job %d", GetJob());
-				iStatAtk = (2 * GetPoint(POINT_ST));
-				break;
-		}
-
-		//  Ÿ ְ,   ݷ ST*2   ST*2 Ѵ.
-		//  ߸   ݷ   ʰ ϱ ؼ.
-		if (GetMountVnum() && iStatAtk < 2 * GetPoint(POINT_ST))
-			iStatAtk = (2 * GetPoint(POINT_ST));
-
-		iAtk += iStatAtk;
-
-		// ¸() : ˼  
-		if (GetMountVnum())
-		{
-			if (GetJob() == JOB_SURA && GetSkillGroup() == 1)
-			{
-				iAtk += (iAtk * GetHorseLevel()) / 60;
-			}
-			else
-			{
-				iAtk += (iAtk * GetHorseLevel()) / 30;
-			}
-		}
-
-		//
-		// ATK Setting
-		//
-		iAtk += GetPoint(POINT_ATT_GRADE_BONUS);
-
-		PointChange(POINT_ATT_GRADE, iAtk);
-
-		// DEF = LEV + CON + ARMOR
-		int iShowDef = GetLevel() + GetPoint(POINT_HT); // For Ymir(õ)
-		int iDef = GetLevel() + static_cast<int>((GetPoint(POINT_HT) / 1.25)); // For Other
-		int iArmor = 0;
-
-		LPITEM pItem = nullptr;
-		for (BYTE bWearIndex = 0; bWearIndex < WEAR_MAX_NUM; ++bWearIndex)
-		{
-			if ((pItem = GetWear(bWearIndex)) && pItem->GetType() == ITEM_ARMOR)
-			{
-				if (pItem->GetSubType() == ARMOR_BODY
-					|| pItem->GetSubType() == ARMOR_HEAD
-					|| pItem->GetSubType() == ARMOR_FOOTS
-					|| pItem->GetSubType() == ARMOR_SHIELD
-#if defined(__PENDANT_SYSTEM__)
-					|| pItem->GetSubType() == ARMOR_PENDANT
-#endif
-#if defined(__GLOVE_SYSTEM__)
-					|| pItem->GetSubType() == ARMOR_GLOVE
-#endif
-					)
-				{
-#if defined(__ITEM_APPLY_RANDOM__) && defined(__ITEM_VALUE10__)
-					DWORD dwArmorVal = pItem->GetValue(1);
-
-					const DWORD dwMinMax = pItem->GetSocket(ITEM_SOCKET_DEF_MINMAX_RANDOM);
-					if (dwMinMax != 0)
-						dwArmorVal = dwMinMax / ITEM_VALUE_MINMAX_RANDOM_DIVISION_VALUE;
-
-					iArmor += dwArmorVal;
-#else
-					iArmor += pItem->GetValue(1);
-#endif
-					iArmor += (2 * pItem->GetValue(5));
-				}
-			}
-#if defined(__ITEM_APPLY_RANDOM__) && defined(__ITEM_VALUE10__)
-			else if (pItem && pItem->GetType() == ITEM_BELT)
-			{
-				DWORD dwArmorVal = pItem->GetValue(1);
-
-				const DWORD dwMinMax = pItem->GetSocket(ITEM_SOCKET_DEF_MINMAX_RANDOM);
-				if (dwMinMax != 0)
-					dwArmorVal = dwMinMax / ITEM_VALUE_MINMAX_RANDOM_DIVISION_VALUE;
-
-				iArmor += dwArmorVal;
-				iArmor += (2 * pItem->GetValue(5));
-			}
-#endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-			else if (pItem && pItem->GetType() == ITEM_COSTUME && pItem->GetSubType() == COSTUME_AURA)
-			{
-				const DWORD dwLevelSocket = pItem->GetSocket(ITEM_SOCKET_AURA_LEVEL_VALUE);
-				const DWORD dwDrainSocket = pItem->GetSocket(ITEM_SOCKET_AURA_DRAIN_ITEM_VNUM);
-
-				BYTE bCurLevel = (dwLevelSocket / 100000) - 1000;
-				float fAuraDrainPer = (1.0f * bCurLevel / 10.0f) / 100.0f;
-
-				TItemTable* pDrainedItem = nullptr;
-				if (dwDrainSocket != 0)
-					pDrainedItem = ITEM_MANAGER::instance().GetTable(dwDrainSocket);
-
-				if (pDrainedItem != nullptr && pDrainedItem->bType == ITEM_ARMOR && pDrainedItem->bSubType == ARMOR_SHIELD)
-				{
-#if defined(__ITEM_APPLY_RANDOM__) && defined(__ITEM_VALUE10__)
-					DWORD dwArmorVal = pDrainedItem->GetValue(1);
-
-					const DWORD dwMinMax = pItem->GetSocket(ITEM_SOCKET_DEF_MINMAX_RANDOM);
-					if (dwMinMax != 0)
-						dwArmorVal = dwMinMax / ITEM_VALUE_MINMAX_RANDOM_DIVISION_VALUE;
-
-					float fValue = (dwArmorVal + (2 * pDrainedItem->GetValue(5))) * fAuraDrainPer;
-#else
-					float fValue = (pDrainedItem->GetValue(1) + (2 * pDrainedItem->GetValue(5))) * fAuraDrainPer;
-#endif
-					iArmor += static_cast<int>((fValue < 1.0f) ? ceilf(fValue) : truncf(fValue));
-				}
-			}
-#endif
-		}
-
-		//  Ÿ      º    
-		if (IsHorseRiding())
-		{
-			if (iArmor < GetHorseArmor())
-				iArmor = GetHorseArmor();
-
-			const char* pHorseName = CHorseNameManager::instance().GetHorseName(GetPlayerID());
-			if (pHorseName != NULL && strlen(pHorseName))
-			{
-				iArmor += 20;
-			}
-		}
-
-		iArmor += GetPoint(POINT_DEF_GRADE_BONUS);
-		iArmor += GetPoint(POINT_PARTY_DEFENDER_BONUS);
-
-		PointChange(POINT_DEF_GRADE, iDef + iArmor);
-		PointChange(POINT_CLIENT_DEF_GRADE, (iShowDef + iArmor) - GetPoint(POINT_DEF_GRADE));
-		PointChange(POINT_MAGIC_ATT_GRADE, GetLevel() * 2 + GetPoint(POINT_IQ) * 2 + GetPoint(POINT_MAGIC_ATT_GRADE_BONUS));
-		PointChange(POINT_MAGIC_DEF_GRADE, GetLevel() + (GetPoint(POINT_IQ) * 3 + GetPoint(POINT_HT)) / 3 + iArmor / 2 + GetPoint(POINT_MAGIC_DEF_GRADE_BONUS));
-	}
-	else
-	{
-		// 2lev + str * 2
-		int iAtt = GetLevel() * 2 + GetPoint(POINT_ST) * 2;
-		// lev + con
-		int iDef = GetLevel() + GetPoint(POINT_HT) + GetMobTable().wDef;
-
-		SetPoint(POINT_ATT_GRADE, iAtt);
-		SetPoint(POINT_DEF_GRADE, iDef);
-		SetPoint(POINT_MAGIC_ATT_GRADE, GetPoint(POINT_ATT_GRADE));
-		SetPoint(POINT_MAGIC_DEF_GRADE, GetPoint(POINT_DEF_GRADE));
-	}
-}
-
-void CHARACTER::ComputePoints()
-{
-	long lStat = GetPoint(POINT_STAT);
-	long lStatResetCount = GetPoint(POINT_STAT_RESET_COUNT);
-	long lSkillActive = GetPoint(POINT_SKILL);
-	long lSkillSub = GetPoint(POINT_SUB_SKILL);
-	long lSkillHorse = GetPoint(POINT_HORSE_SKILL);
-	long lLevelStep = GetPoint(POINT_LEVEL_STEP);
-
-	long lAttackerBonus = GetPoint(POINT_PARTY_ATTACKER_BONUS);
-	long lTankerBonus = GetPoint(POINT_PARTY_TANKER_BONUS);
-	long lBufferBonus = GetPoint(POINT_PARTY_BUFFER_BONUS);
-	long lSkillMasterBonus = GetPoint(POINT_PARTY_SKILL_MASTER_BONUS);
-	long lHasteBonus = GetPoint(POINT_PARTY_HASTE_BONUS);
-	long lDefenderBonus = GetPoint(POINT_PARTY_DEFENDER_BONUS);
-
-	long lHPRecovery = GetPoint(POINT_HP_RECOVERY);
-	long lSPRecovery = GetPoint(POINT_SP_RECOVERY);
-
-#if defined(__CONQUEROR_LEVEL__)
-	long lConquerorPoint = GetPoint(POINT_CONQUEROR_POINT);
-	long lConquerorLevelStep = GetPoint(POINT_CONQUEROR_LEVEL_STEP);
-
-	long lSungmaStr = GetRealPoint(POINT_SUNGMA_STR);
-	long lSungmaHP = GetRealPoint(POINT_SUNGMA_HP);
-	long lSungmaMove = GetRealPoint(POINT_SUNGMA_MOVE);
-	long lSungmaImmune = GetRealPoint(POINT_SUNGMA_IMMUNE);
-#endif
-
-	memset(m_pointsInstant.points, 0, sizeof(m_pointsInstant.points));
-	BuffOnAttr_ClearAll();
-	m_SkillDamageBonus.clear();
-
-	SetPoint(POINT_STAT, lStat);
-	SetPoint(POINT_SKILL, lSkillActive);
-	SetPoint(POINT_SUB_SKILL, lSkillSub);
-	SetPoint(POINT_HORSE_SKILL, lSkillHorse);
-	SetPoint(POINT_LEVEL_STEP, lLevelStep);
-	SetPoint(POINT_STAT_RESET_COUNT, lStatResetCount);
-
-	SetPoint(POINT_ST, GetRealPoint(POINT_ST));
-	SetPoint(POINT_HT, GetRealPoint(POINT_HT));
-	SetPoint(POINT_DX, GetRealPoint(POINT_DX));
-	SetPoint(POINT_IQ, GetRealPoint(POINT_IQ));
-
-#if defined(__CONQUEROR_LEVEL__)
-	SetPoint(POINT_CONQUEROR_POINT, lConquerorPoint);
-	SetPoint(POINT_CONQUEROR_LEVEL_STEP, lConquerorLevelStep);
-
-	SetPoint(POINT_SUNGMA_STR, lSungmaStr);
-	SetPoint(POINT_SUNGMA_HP, lSungmaHP),
-	SetPoint(POINT_SUNGMA_MOVE, lSungmaMove);
-	SetPoint(POINT_SUNGMA_IMMUNE, lSungmaImmune);
-#endif
-
-	SetPart(PART_MAIN, GetOriginalPart(PART_MAIN));
-	SetPart(PART_WEAPON, GetOriginalPart(PART_WEAPON));
-	SetPart(PART_HEAD, GetOriginalPart(PART_HEAD));
-	SetPart(PART_HAIR, GetOriginalPart(PART_HAIR));
-#if defined(__ACCE_COSTUME_SYSTEM__)
-	SetPart(PART_ACCE, GetOriginalPart(PART_ACCE));
-#endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-	SetPart(PART_AURA, GetOriginalPart(PART_AURA));
-#endif
-
-	SetPoint(POINT_PARTY_ATTACKER_BONUS, lAttackerBonus);
-	SetPoint(POINT_PARTY_TANKER_BONUS, lTankerBonus);
-	SetPoint(POINT_PARTY_BUFFER_BONUS, lBufferBonus);
-	SetPoint(POINT_PARTY_SKILL_MASTER_BONUS, lSkillMasterBonus);
-	SetPoint(POINT_PARTY_HASTE_BONUS, lHasteBonus);
-	SetPoint(POINT_PARTY_DEFENDER_BONUS, lDefenderBonus);
-
-	SetPoint(POINT_HP_RECOVERY, lHPRecovery);
-	SetPoint(POINT_SP_RECOVERY, lSPRecovery);
-
-	// PC_BANG_ITEM_ADD
-	SetPoint(POINT_PC_BANG_EXP_BONUS, 0);
-	SetPoint(POINT_PC_BANG_DROP_BONUS, 0);
-	// END_PC_BANG_ITEM_ADD
-
-	int iMaxHP, iMaxSP;
-	int iMaxStamina;
-
-	if (IsPC())
-	{
-		// ִ /ŷ
-		iMaxHP = JobInitialPoints[GetJob()].max_hp + m_points.iRandomHP + GetPoint(POINT_HT) * JobInitialPoints[GetJob()].hp_per_ht;
-		iMaxSP = JobInitialPoints[GetJob()].max_sp + m_points.iRandomSP + GetPoint(POINT_IQ) * JobInitialPoints[GetJob()].sp_per_iq;
-		iMaxStamina = JobInitialPoints[GetJob()].max_stamina + GetPoint(POINT_HT) * JobInitialPoints[GetJob()].stamina_per_con;
-
-		CSkillProto* pkSk = CSkillManager::instance().Get(SKILL_ADD_HP);
-		if (pkSk)
-		{
-			pkSk->SetPointVar("k", 1.0f * GetSkillPower(SKILL_ADD_HP) / 100.0f);
-			iMaxHP += static_cast<int>(pkSk->kPointPoly.Eval());
-		}
-
-		// ⺻ 
-		SetPoint(POINT_MOV_SPEED, 100);
-		SetPoint(POINT_ATT_SPEED, 100);
-		PointChange(POINT_ATT_SPEED, GetPoint(POINT_PARTY_HASTE_BONUS));
-		SetPoint(POINT_CASTING_SPEED, 100);
-	}
-	else
-	{
-		iMaxHP = m_pkMobData->m_table.dwMaxHP;
-		iMaxSP = 0;
-		iMaxStamina = 0;
-
-		SetPoint(POINT_ATT_SPEED, m_pkMobData->m_table.sAttackSpeed);
-		SetPoint(POINT_MOV_SPEED, m_pkMobData->m_table.sMovingSpeed);
-		SetPoint(POINT_CASTING_SPEED, m_pkMobData->m_table.sAttackSpeed);
-	}
-
-	if (IsPC())
-	{
-		//  Ÿ   ⺻    Ⱥ   .
-		//      ̹Ƿ, / ü  
-		// ä  ö󰡰  ̴.
-		if (GetMountVnum())
-		{
-			if (GetHorseST() > GetPoint(POINT_ST))
-				PointChange(POINT_ST, GetHorseST() - GetPoint(POINT_ST));
-
-			if (GetHorseDX() > GetPoint(POINT_DX))
-				PointChange(POINT_DX, GetHorseDX() - GetPoint(POINT_DX));
-
-			if (GetHorseHT() > GetPoint(POINT_HT))
-				PointChange(POINT_HT, GetHorseHT() - GetPoint(POINT_HT));
-
-			if (GetHorseIQ() > GetPoint(POINT_IQ))
-				PointChange(POINT_IQ, GetHorseIQ() - GetPoint(POINT_IQ));
-		}
-	}
-
-	ComputeBattlePoints();
-
-	// ⺻ HP/SP 
-	if (iMaxHP != GetMaxHP())
-		SetRealPoint(POINT_MAX_HP, iMaxHP); // ⺻HP RealPoint  ´.
-	PointChange(POINT_MAX_HP, 0);
-
-	if (iMaxSP != GetMaxSP())
-		SetRealPoint(POINT_MAX_SP, iMaxSP); // ⺻SP RealPoint  ´.
-	PointChange(POINT_MAX_SP, 0);
-
-	SetMaxStamina(iMaxStamina);
-
-	m_pointsInstant.dwImmuneFlag = 0;
-
-	for (BYTE bWearIndex = 0; bWearIndex < WEAR_MAX_NUM; bWearIndex++)
-	{
-		LPITEM pItem = GetWear(bWearIndex);
-		if (pItem != nullptr)
-		{
-			pItem->ModifyPoints(true);
-			SET_BIT(m_pointsInstant.dwImmuneFlag, GetWear(bWearIndex)->GetImmuneFlag());
-		}
-	}
-
-	// ȥ ý
-	// ComputePoints ɸ  Ӽ ʱȭϰ,
-	// ,   õ  Ӽ ϱ ,
-	// ȥ ý۵ ActiveDeck ִ  ȥ Ӽ ٽ Ѿ Ѵ.
-#if defined(__DRAGON_SOUL_SYSTEM__)
-	if (DragonSoul_IsDeckActivated())
-	{
-		for (BYTE bWearIndex = WEAR_MAX_NUM + DS_SLOT_MAX * DragonSoul_GetActiveDeck();
-			bWearIndex < WEAR_MAX_NUM + DS_SLOT_MAX * (DragonSoul_GetActiveDeck() + 1); bWearIndex++)
-		{
-			LPITEM pItem = GetWear(bWearIndex);
-			if (pItem)
-			{
-				if (DSManager::instance().IsTimeLeftDragonSoul(pItem))
-					pItem->ModifyPoints(true);
-			}
-		}
-	}
-#endif
-
-	//int iCurHP = this->GetHP();
-	//int iCurSP = this->GetSP();
-
-	ComputeSkillPoints();
-
-	RefreshAffect();
-
-	if (GetHP() > GetMaxHP())
-		PointChange(POINT_HP, GetMaxHP() - GetHP());
-
-	if (GetSP() > GetMaxSP())
-		PointChange(POINT_SP, GetMaxSP() - GetSP());
-
-#if defined(__PET_SYSTEM__)
-	CPetSystem* pPetSystem = GetPetSystem();
-	if (pPetSystem != nullptr)
-		pPetSystem->RefreshBuff();
-#endif
-
-	for (const auto& it : m_map_buff_on_attrs)
-		it.second->GiveAllAttributes();
-
-	/*
-	if (IsPC())
-	{
-		if (this->GetHP() != iCurHP)
-			this->PointChange(POINT_HP, iCurHP - this->GetHP());
-
-		if (this->GetSP() != iCurSP)
-			this->PointChange(POINT_SP, iCurSP - this->GetSP());
-	}
-	*/
-
-	PointChange(POINT_MAX_HP, 0);
-	PointChange(POINT_MAX_SP, 0);
-
-	UpdatePacket();
-}
-
-// m_dwPlayStartTime  milisecond. ͺ̽ д ϱ
-//  ÷̽ð   / 60000   ϴµ,    
-//   ⿡ dwTimeRemain ־  ǵ ־ Ѵ.
-void CHARACTER::ResetPlayTime(DWORD dwTimeRemain)
-{
-	m_dwPlayStartTime = get_dword_time() - dwTimeRemain;
-}
-
-const int aiRecoveryPercents[10] = { 1, 5, 5, 5, 5, 5, 5, 5, 5, 5 };
-
-EVENTFUNC(recovery_event)
-{
-	char_event_info* info = dynamic_cast<char_event_info*>(event->info);
-	if (info == NULL)
-	{
-		sys_err("recovery_event> <Factor> Null pointer");
-		return 0;
-	}
-
-	LPCHARACTER ch = info->ch;
-
-	if (ch == NULL) // <Factor>
-		return 0;
-
-	if (!ch->IsPC())
-	{
-		//
-		//  ȸ
-		//
-		if (ch->IsAffectFlag(AFF_POISON))
-			return PASSES_PER_SEC(MAX(1, ch->GetMobTable().bRegenCycle));
-
-		if (ch->IsAffectFlag(AFF_BLEEDING))
-			return PASSES_PER_SEC(MAX(1, ch->GetMobTable().bRegenCycle));
-
-		DWORD vnum = ch->GetMobTable().dwVnum;
-#if defined(__BLUE_DRAGON_RENEWAL__)
-		if (BlueDragon_IsBoss(vnum))
-#else
-		if (vnum == BlueDragon::BossVnum) // Aqua Dragon
-#endif
-		{
-			int regenPct = BlueDragon_GetRangeFactor("hp_regen", ch->GetHPPct());
-			regenPct += ch->GetMobTable().bRegenPercent;
-
-			for (int i = 1; i <= BlueDragon::StoneCount; ++i)
-			{
-				if (REGEN_PECT_BONUS == BlueDragon_GetIndexFactor("DragonStone", i, "effect_type"))
-				{
-#if defined(__LABYRINTH_DUNGEON__)
-					DWORD dwDragonStoneID = BlueDragon_GetIndexFactor("DragonStone", i,
-						BlueDragon_GetVnumFieldByBossVnum(vnum).c_str());
-#else
-					DWORD dwDragonStoneID = BlueDragon_GetIndexFactor("DragonStone", i, "vnum");
-#endif
-					size_t val = BlueDragon_GetIndexFactor("DragonStone", i, "val");
-					size_t cnt = SECTREE_MANAGER::instance().GetMonsterCountInMap(ch->GetMapIndex(), dwDragonStoneID);
-
-					regenPct += (val * cnt);
-
-					break;
-				}
-			}
-
-			ch->MonsterLog("AQUA_HP_REGEN +%d", MAX(1, (ch->GetMaxHP() * regenPct) / 100));
-			ch->PointChange(POINT_HP, MAX(1, (ch->GetMaxHP() * regenPct) / 100));
-		}
-		else if (!ch->IsDoor())
-		{
-			ch->MonsterLog("HP_REGEN +%d", MAX(1, (ch->GetMaxHP() * ch->GetMobTable().bRegenPercent) / 100));
-			ch->PointChange(POINT_HP, MAX(1, (ch->GetMaxHP() * ch->GetMobTable().bRegenPercent) / 100));
-		}
-
-		if (ch->GetHP() >= ch->GetMaxHP())
-		{
-			ch->m_pkRecoveryEvent = NULL;
-			return 0;
-		}
-
-#if defined(__BLUE_DRAGON_RENEWAL__)
-		if (BlueDragon_IsBoss(ch->GetMobTable().dwVnum))
-#else
-		if (BlueDragon::BossVnum == ch->GetMobTable().dwVnum)
-#endif
-		{
-			for (int i = 1; i <= BlueDragon::StoneCount; ++i)
-			{
-				if (REGEN_TIME_BONUS == BlueDragon_GetIndexFactor("DragonStone", i, "effect_type"))
-				{
-#if defined(__LABYRINTH_DUNGEON__)
-					DWORD dwDragonStoneID = BlueDragon_GetIndexFactor("DragonStone", i,
-						BlueDragon_GetVnumFieldByBossVnum(ch->GetMobTable().dwVnum).c_str());
-#else
-					DWORD dwDragonStoneID = BlueDragon_GetIndexFactor("DragonStone", i, "vnum");
-#endif
-					size_t val = BlueDragon_GetIndexFactor("DragonStone", i, "val");
-					size_t cnt = SECTREE_MANAGER::instance().GetMonsterCountInMap(ch->GetMapIndex(), dwDragonStoneID);
-
-					return PASSES_PER_SEC(MAX(1, (ch->GetMobTable().bRegenCycle - (val * cnt))));
-				}
-			}
-		}
-
-		return PASSES_PER_SEC(MAX(1, ch->GetMobTable().bRegenCycle));
-	}
-	else
-	{
-		//
-		// PC ȸ
-		//
-		ch->CheckTarget();
-		//ch->UpdateSectree(); // ⼭ ̰ ?
-		ch->UpdateKillerMode();
-
-		if (ch->IsAffectFlag(AFF_POISON) == true)
-		{
-			// ߵ  ڵȸ 
-			// Ĺ  ڵȸ 
-			return 3;
-		}
-
-		if (ch->IsAffectFlag(AFF_BLEEDING))
-			return 3;
-
-		int iSec = (get_dword_time() - ch->GetLastMoveTime()) / 3000;
-
-		// SP ȸ ƾ.
-		//  ̰ɷ ؼ Լ ° ?!
-		ch->DistributeSP(ch);
-
-		if (ch->GetMaxHP() <= ch->GetHP())
-			return PASSES_PER_SEC(3);
-
-		int iPercent = 0;
-		int iAmount = 0;
-
-		{
-			iPercent = aiRecoveryPercents[MIN(9, iSec)];
-			iAmount = 15 + (ch->GetMaxHP() * iPercent) / 100;
-		}
-
-		iAmount += (iAmount * ch->GetPoint(POINT_HP_REGEN)) / 100;
-
-		sys_log(1, "RECOVERY_EVENT: %s %d HP_REGEN %d HP +%lld", ch->GetName(), iPercent, ch->GetPoint(POINT_HP_REGEN), iAmount);
-
-		ch->PointChange(POINT_HP, iAmount, false);
-		return PASSES_PER_SEC(3);
-	}
-}
-
-void CHARACTER::StartRecoveryEvent()
-{
-	if (m_pkRecoveryEvent)
-		return;
-
-	if (IsDead() || IsStun())
-		return;
-
-	if (IsNPC() && GetHP() >= GetMaxHP()) // ʹ ü    Ѵ.
-		return;
-
-	if (IS_SET(m_pointsInstant.dwAIFlag, AIFLAG_NORECOVERY))
-		return;
-
-	char_event_info* info = AllocEventInfo<char_event_info>();
-	info->ch = this;
-
-	int iSec = IsPC() ? 3 : (MAX(1, GetMobTable().bRegenCycle));
-	m_pkRecoveryEvent = event_create(recovery_event, info, PASSES_PER_SEC(iSec));
-}
-
-void CHARACTER::Standup()
-{
-	struct packet_position pack_position;
-
-	if (!IsPosition(POS_SITTING))
-		return;
-
-	SetPosition(POS_STANDING);
-
-	sys_log(1, "STANDUP: %s", GetName());
-
-	pack_position.header = HEADER_GC_CHARACTER_POSITION;
-	pack_position.vid = GetVID();
-	pack_position.position = POSITION_GENERAL;
-
-	PacketAround(&pack_position, sizeof(pack_position));
-}
-
-void CHARACTER::Sitdown(int is_ground)
-{
-	struct packet_position pack_position;
-
-	if (IsPosition(POS_SITTING))
-		return;
-
-	SetPosition(POS_SITTING);
-	sys_log(1, "SITDOWN: %s", GetName());
-
-	pack_position.header = HEADER_GC_CHARACTER_POSITION;
-	pack_position.vid = GetVID();
-	pack_position.position = POSITION_SITTING_GROUND;
-	PacketAround(&pack_position, sizeof(pack_position));
-}
-
-void CHARACTER::SetRotation(float fRot)
-{
-	m_pointsInstant.fRot = fRot;
-}
-
-// x, y   .
-void CHARACTER::SetRotationToXY(long x, long y)
-{
-	SetRotation(GetDegreeFromPositionXY(GetX(), GetY(), x, y));
-}
-
-bool CHARACTER::CannotMoveByAffect() const
-{
-	return (IsAffectFlag(AFF_STUN));
-}
-
-bool CHARACTER::CanMove() const
-{
-	if (CannotMoveByAffect())
-		return false;
-
-	if (GetMyShop()) //   ¿   
-		return false;
-
-	// 0.2 ̶   .
-	//if (get_float_time() - m_fSyncTime < 0.2f)
-	//	return false;
-
-	return true;
-}
-
-//  x, y ġ ̵ Ų.
-bool CHARACTER::Sync(long x, long y)
-{
-	if (!GetSectree())
-		return false;
-
-	if (IsDestroyed())
-		return false;
-
-	if (IsDead())
-		return false;
-
-	LPSECTREE new_tree = SECTREE_MANAGER::instance().Get(GetMapIndex(), x, y);
-	if (!new_tree)
-	{
-		if (GetDesc())
-		{
-			sys_err("cannot find tree at %d %d (name: %s)", x, y, GetName());
-			GetDesc()->SetPhase(PHASE_CLOSE);
-		}
-		else
-		{
-			sys_err("no tree: %s %d %d %d", GetName(), x, y, GetMapIndex());
-			Dead();
-		}
-
-		return false;
-	}
-
-	SetRotationToXY(x, y);
-	SetXYZ(x, y, 0);
-
-	if (GetDungeon())
-	{
-		//  ̺Ʈ Ӽ ȭ
-		int iLastEventAttr = m_iEventAttr;
-		m_iEventAttr = new_tree->GetEventAttribute(x, y);
-
-		if (m_iEventAttr != iLastEventAttr)
-		{
-			if (GetParty())
-			{
-				quest::CQuestManager::instance().AttrOut(GetParty()->GetLeaderPID(), this, iLastEventAttr);
-				quest::CQuestManager::instance().AttrIn(GetParty()->GetLeaderPID(), this, m_iEventAttr);
-			}
-			else
-			{
-				quest::CQuestManager::instance().AttrOut(GetPlayerID(), this, iLastEventAttr);
-				quest::CQuestManager::instance().AttrIn(GetPlayerID(), this, m_iEventAttr);
-			}
-		}
-	}
-
-#if defined(__DEFENSE_WAVE__)
-	if (GetDefenseWave())
-		GetDefenseWave()->CheckAffect(this, x, y);
-#endif
-
-	if (GetSectree() != new_tree)
-	{
-		if (test_server)
-			if (!IsNPC())
-			{
-				SECTREEID id = new_tree->GetID();
-				SECTREEID old_id = GetSectree()->GetID();
-
-				const float fDist = DISTANCE_SQRT(id.coord.x - old_id.coord.x, id.coord.y - old_id.coord.y);
-				sys_log(0, "SECTREE DIFFER: %s %dx%d was %dx%d dist %.1fm",
-					GetName(),
-					id.coord.x,
-					id.coord.y,
-					old_id.coord.x,
-					old_id.coord.y,
-					fDist);
-			}
-
-		new_tree->InsertEntity(this);
-	}
-
-	return true;
-}
-
-void CHARACTER::Stop()
-{
-	if (!IsState(m_stateIdle))
-		MonsterLog("[IDLE] ");
-
-	GotoState(m_stateIdle);
-
-	m_posDest.x = m_posStart.x = GetX();
-	m_posDest.y = m_posStart.y = GetY();
-}
-
-bool CHARACTER::Goto(long x, long y)
-{
-	// TODO Ÿüũ ʿ
-	//  ġ ̵ ʿ  (ڵ )
-	if (GetX() == x && GetY() == y)
-		return false;
-
-	if (m_posDest.x == x && m_posDest.y == y)
-	{
-		if (!IsState(m_stateMove))
-		{
-			m_dwStateDuration = 4;
-			GotoState(m_stateMove);
-		}
-		return false;
-	}
-
-	m_posDest.x = x;
-	m_posDest.y = y;
-
-	CalculateMoveDuration();
-
-	m_dwStateDuration = 4;
-
-	if (!IsState(m_stateMove))
-	{
-		MonsterLog("[MOVE] %s", GetVictim() ? "To victim" : "Free");
-
-		if (GetVictim())
-		{
-			//MonsterChat(MONSTER_CHAT_CHASE);
-			//MonsterChat(MONSTER_CHAT_ATTACK);
-		}
-	}
-
-	GotoState(m_stateMove);
-
-	return true;
-}
-
-DWORD CHARACTER::GetMotionMode() const
-{
-	DWORD dwMode = MOTION_MODE_GENERAL;
-
-	if (IsPolymorphed())
-		return dwMode;
-
-	LPITEM pkItem;
-
-	if ((pkItem = GetWear(WEAR_WEAPON)))
-	{
-		switch (pkItem->GetProto()->bSubType)
-		{
-			case WEAPON_SWORD:
-				dwMode = MOTION_MODE_ONEHAND_SWORD;
-				break;
-
-			case WEAPON_TWO_HANDED:
-				dwMode = MOTION_MODE_TWOHAND_SWORD;
-				break;
-
-			case WEAPON_DAGGER:
-				dwMode = MOTION_MODE_DUALHAND_SWORD;
-				break;
-
-			case WEAPON_BOW:
-				dwMode = MOTION_MODE_BOW;
-				break;
-
-			case WEAPON_BELL:
-				dwMode = MOTION_MODE_BELL;
-				break;
-
-			case WEAPON_FAN:
-				dwMode = MOTION_MODE_FAN;
-				break;
-
-			case WEAPON_CLAW:
-				dwMode = MOTION_MODE_CLAW;
-				break;
-
-		}
-	}
-	return dwMode;
-}
-
-float CHARACTER::GetMoveMotionSpeed() const
-{
-	DWORD dwMode = GetMotionMode();
-
-	const CMotion* pkMotion = NULL;
-
-	if (!GetMountVnum())
-		pkMotion = CMotionManager::instance().GetMotion(GetRaceNum(), MAKE_MOTION_KEY(dwMode, (IsWalking() && IsPC()) ? MOTION_WALK : MOTION_RUN));
-	else
-	{
-		pkMotion = CMotionManager::instance().GetMotion(GetMountVnum(), MAKE_MOTION_KEY(MOTION_MODE_GENERAL, (IsWalking() && IsPC()) ? MOTION_WALK : MOTION_RUN));
-
-		if (!pkMotion)
-			pkMotion = CMotionManager::instance().GetMotion(GetRaceNum(), MAKE_MOTION_KEY(MOTION_MODE_HORSE, (IsWalking() && IsPC()) ? MOTION_WALK : MOTION_RUN));
-	}
-
-	if (pkMotion)
-		return -pkMotion->GetAccumVector().y / pkMotion->GetDuration();
-	else
-	{
-		sys_err("cannot find motion (name %s race %d mode %d)", GetName(), GetRaceNum(), dwMode);
-		return 300.0f;
-	}
-}
-
-float CHARACTER::GetMoveSpeed() const
-{
-	return GetMoveMotionSpeed() * 10000 / CalculateDuration(GetLimitPoint(POINT_MOV_SPEED), 10000);
-}
-
-void CHARACTER::CalculateMoveDuration()
-{
-	m_posStart.x = GetX();
-	m_posStart.y = GetY();
-
-	float fDist = DISTANCE_SQRT(m_posStart.x - m_posDest.x, m_posStart.y - m_posDest.y);
-
-	float motionSpeed = GetMoveMotionSpeed();
-
-	m_dwMoveDuration = CalculateDuration(GetLimitPoint(POINT_MOV_SPEED),
-		(int)((fDist / motionSpeed) * 1000.0f));
-
-	if (IsNPC())
-		sys_log(1, "%s: GOTO: distance %f, spd %u, duration %u, motion speed %f pos %d %d -> %d %d",
-			GetName(), fDist, GetLimitPoint(POINT_MOV_SPEED), m_dwMoveDuration, motionSpeed,
-			m_posStart.x, m_posStart.y, m_posDest.x, m_posDest.y);
-
-	m_dwMoveStartTime = get_dword_time();
-}
-
-// x y ġ ̵ Ѵ. (̵  ִ    Ȯ ϰ Sync ޼ҵ  ̵ Ѵ)
-//  char x, y  ٷ ٲ,
-// Ŭ󿡼  ġ ٲ x, y interpolationѴ.
-// Ȱų ٴ  char m_bNowWalking ޷ִ.
-// Warp ǵ ̶ Show  .
-bool CHARACTER::Move(long x, long y)
-{
-	if (IsPC() && IsDead())
-		return false;
-
-	//  ġ ̵ ʿ  (ڵ )
-	if (GetX() == x && GetY() == y)
-		return true;
-
-	if (test_server)
-		if (m_bDetailLog)
-			sys_log(0, "%s position %u %u", GetName(), x, y);
-
-	OnMove();
-	return Sync(x, y);
-}
-
-void CHARACTER::SendMovePacket(BYTE bFunc, BYTE bArg, DWORD x, DWORD y, DWORD dwDuration, DWORD dwTime, int iRot)
-{
-	TPacketGCMove pack;
-
-	if (bFunc == FUNC_WAIT)
-	{
-		x = m_posDest.x;
-		y = m_posDest.y;
-		dwDuration = m_dwMoveDuration;
-	}
-
-	EncodeMovePacket(pack, GetVID(), bFunc, bArg, x, y, dwDuration, dwTime, iRot == -1 ? (int)GetRotation() / 5 : iRot);
-	PacketView(&pack, sizeof(TPacketGCMove), this);
-}
-
-POINT_VALUE CHARACTER::GetRealPoint(POINT_TYPE wPointType) const
-{
-	return m_points.lPoints[wPointType];
-}
-
-void CHARACTER::SetRealPoint(POINT_TYPE wPointType, POINT_VALUE lPointValue)
-{
-	m_points.lPoints[wPointType] = lPointValue;
-}
-
-POINT_VALUE CHARACTER::GetPolymorphPoint(POINT_TYPE wPointType) const
-{
-	if (IsPolymorphed() && !IsPolyMaintainStat())
-	{
-		DWORD dwMobVnum = GetPolymorphVnum();
-		const CMob* c_pMob = CMobManager::instance().Get(dwMobVnum);
-		int iPower = GetPolymorphPower();
-
-		if (c_pMob)
-		{
-			switch (wPointType)
-			{
-				case POINT_ST:
-					if (GetJob() == JOB_SHAMAN || GetJob() == JOB_SURA && GetSkillGroup() == 2)
-						return c_pMob->m_table.bStr * iPower / 100 + GetPoint(POINT_IQ);
-					return c_pMob->m_table.bStr * iPower / 100 + GetPoint(POINT_ST);
-
-				case POINT_HT:
-					return c_pMob->m_table.bCon * iPower / 100 + GetPoint(POINT_HT);
-
-				case POINT_IQ:
-					return c_pMob->m_table.bInt * iPower / 100 + GetPoint(POINT_IQ);
-
-				case POINT_DX:
-					return c_pMob->m_table.bDex * iPower / 100 + GetPoint(POINT_DX);
-			}
-		}
-	}
-
-	return GetPoint(wPointType);
-}
-
-POINT_VALUE CHARACTER::GetPoint(POINT_TYPE wPointType) const
-{
-	if (wPointType >= POINT_MAX_NUM)
-	{
-		sys_err("Point type overflow (type %u)", wPointType);
-		return 0;
-	}
-
-	POINT_VALUE lPointValue = m_pointsInstant.points[wPointType];
-	POINT_VALUE llMaxValue = POINT_MAX;
-
-	switch (wPointType)
-	{
-		case POINT_STEAL_HP:
-		case POINT_STEAL_SP:
-		{
-			llMaxValue = 50;
-#if defined(__COSTUME_SYSTEM__) && defined(__MOVE_COSTUME_ATTR__)
-			llMaxValue += 20;
-#endif
-#if defined(__GLOVE_SYSTEM__)
-			llMaxValue += 10;
-#endif
-		}
-		break;
-
-		case POINT_MOV_SPEED:
-		{
-			if (IsAffectFlag(AFF_WAR_FLAG1) || IsAffectFlag(AFF_WAR_FLAG2) || IsAffectFlag(AFF_WAR_FLAG3))
-				lPointValue = 50;
-		}
-		break;
-	}
-
-	if (lPointValue > llMaxValue)
-		sys_err("POINT_ERROR: %s type %d val %d (max: %d)", GetName(), lPointValue, llMaxValue);
-
-	return lPointValue;
-}
-
-POINT_VALUE CHARACTER::GetLimitPoint(POINT_TYPE wPointType) const
-{
-	if (wPointType >= POINT_MAX_NUM)
-	{
-		sys_err("Point type overflow (type %u)", wPointType);
-		return 0;
-	}
-
-	POINT_VALUE lPointValue = m_pointsInstant.points[wPointType];
-
-	POINT_VALUE llMinValue = -POINT_MAX;
-	POINT_VALUE llMaxValue = POINT_MAX;
-	POINT_VALUE llLimitValue = POINT_MAX;
-
-	switch (wPointType)
-	{
-		case POINT_ATT_SPEED:
-		{
-			llMinValue = 0;
-
-			if (IsPC())
-				llLimitValue = 170;
-			else
-				llLimitValue = 250;
-		}
-		break;
-
-		case POINT_MOV_SPEED:
-		{
-			llMinValue = 0;
-
-			if (IsAffectFlag(AFF_WAR_FLAG1) || IsAffectFlag(AFF_WAR_FLAG2) || IsAffectFlag(AFF_WAR_FLAG3))
-				llMinValue = 50;
-
-			if (IsPC())
-				llLimitValue = 200;
-			else
-				llLimitValue = 250;
-		}
-		break;
-
-		case POINT_STEAL_HP:
-		case POINT_STEAL_SP:
-		{
-			llLimitValue = 50;
-			llMaxValue = 50;
-		}
-		break;
-
-		case POINT_MALL_ATTBONUS:
-		case POINT_MALL_DEFBONUS:
-		{
-			llLimitValue = 20;
-			llMaxValue = 50;
-		}
-		break;
-	}
-
-#if defined(__CONQUEROR_LEVEL__)
-	if (IsPC() && wPointType == POINT_MOV_SPEED && IsSungMaCursed(POINT_SUNGMA_MOVE))
-		lPointValue /= 2;
-#endif
-
-	if (lPointValue > llMaxValue)
-		sys_err("POINT_ERROR: %s type %d val %d (max: %d)", GetName(), lPointValue, llMaxValue);
-
-	if (lPointValue > llLimitValue)
-		lPointValue = llLimitValue;
-
-	if (lPointValue < llMinValue)
-		lPointValue = llMinValue;
-
-	return lPointValue;
-}
-
-void CHARACTER::SetPoint(POINT_TYPE wPointType, POINT_VALUE lPointValue)
-{
-	if (wPointType >= POINT_MAX_NUM)
-	{
-		sys_err("Point type overflow (type %u)", wPointType);
-		return;
-	}
-
-	m_pointsInstant.points[wPointType] = lPointValue;
-
-	//  ̵  ȳٸ ̵ ð  ٽ ؾ Ѵ.
-	if (wPointType == POINT_MOV_SPEED && get_dword_time() < m_dwMoveStartTime + m_dwMoveDuration)
-	{
-		CalculateMoveDuration();
-	}
-}
-
-int CHARACTER::GetAllowedGold() const
-{
-	if (GetLevel() <= 10)
-		return 100000;
-	else if (GetLevel() <= 20)
-		return 500000;
-	else
-		return 50000000;
-}
-
-void CHARACTER::CheckMaximumPoints()
-{
-	if (GetMaxHP() < GetHP())
-		PointChange(POINT_HP, GetMaxHP() - GetHP());
-
-	if (GetMaxSP() < GetSP())
-		PointChange(POINT_SP, GetMaxSP() - GetSP());
-}
-
-void CHARACTER::PointChange(POINT_TYPE type, POINT_VALUE amount, bool bAmount, bool bBroadcast)
-{
-	POINT_VALUE val = 0;
-
-	//sys_log(0, "PointChange %d %d | %d -> %d cHP %d mHP %d", type, amount, GetPoint(type), GetPoint(type)+amount, GetHP(), GetMaxHP());
-
-	switch (type)
-	{
-		case POINT_NONE:
-			return;
-
-		case POINT_LEVEL:
-		{
-			if ((GetLevel() + amount) > gPlayerMaxLevel)
-				return;
-
-			SetLevel(GetLevel() + amount);
-			val = GetLevel();
-
-			sys_log(0, "LEVELUP: %s %d NEXT EXP %d", GetName(), GetLevel(), GetNextExp());
-
-			// WOLFMAN  Ưó (  ϳ̹Ƿ, 5 Ǹ  1  . ϵڵ )
-			if (GetJob() == JOB_WOLFMAN)
-			{
-				if ((5 <= val) && (GetSkillGroup() != 1))
-				{
-					ClearSkill();
-					SetSkillGroup(1);
-					SetRealPoint(POINT_SKILL, GetLevel() - 1);
-					SetPoint(POINT_SKILL, GetRealPoint(POINT_SKILL));
-					PointChange(POINT_SKILL, 0);
-				}
-			}
-
-#if defined(__CONQUEROR_LEVEL__)
-			if ((GetConquerorLevel() > 0) && (val < gPlayerMaxLevel))
-				SetConqueror(false);
-#endif
-
-			PointChange(POINT_NEXT_EXP, GetNextExp(), false);
-
-			if (amount)
-			{
-				quest::CQuestManager::instance().LevelUp(GetPlayerID());
-
-				LogManager::instance().LevelLog(this, val, GetRealPoint(POINT_PLAYTIME) + (get_dword_time() - m_dwPlayStartTime) / 60000);
-
-				if (GetGuild())
-					GetGuild()->LevelChange(GetPlayerID(), GetLevel());
-
-				if (GetParty())
-					GetParty()->RequestSetMemberLevel(GetPlayerID(), GetLevel());
-			}
-
-			PointsPacket();
-		} break;
-
-		case POINT_NEXT_EXP:
-		{
-			val = GetNextExp();
-			bAmount = false; //  bAmount false  Ѵ.
-		} break;
-
-		case POINT_EXP:
-		{
-			DWORD exp = GetExp();
-			DWORD next_exp = GetNextExp();
-
-			// exp 0 Ϸ  ʵ Ѵ
-			if (amount < 0 && exp <= -amount)
-			{
-				sys_log(0, "%s - Reduce EXP by %d, CUR EXP: %d (setting to zero)", GetName(), -amount, exp);
-				amount = -(long)exp;
-
-				SetExp(0);
-				val = GetExp();
-			}
-			else
-			{
-#if defined(__CONQUEROR_LEVEL__)
-				DWORD conqueror_exp = next_exp / 4;
-				if (amount > 0 && (GetLevel() >= gPlayerMaxLevel && exp >= conqueror_exp))
-					return;
-#else
-				if (gPlayerMaxLevel <= GetLevel())
-					return;
-#endif
-
-#if defined(__CHATTING_WINDOW_RENEWAL__)
-				ChatPacket(CHAT_TYPE_EXP_INFO, LC_STRING("%d ġ ȹ߽ϴ.", amount));
-#else
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("%d ġ ȹ߽ϴ.", amount));
-#endif
-
-				DWORD iExpBalance = 0;
-
-				//  !
-				if (exp + amount >= next_exp)
-				{
-					iExpBalance = (exp + amount) - next_exp;
-					amount = next_exp - exp;
-
-					SetExp(0);
-					exp = next_exp;
-				}
-#if defined(__CONQUEROR_LEVEL__)
-				else if (GetLevel() >= gPlayerMaxLevel)
-				{
-					if (exp + amount >= conqueror_exp)
-					{
-						SetExp(conqueror_exp);
-						exp = GetExp();
-					}
-					else
-					{
-						SetExp(exp + amount);
-						exp = GetExp();
-					}
-				}
-#endif
-				else
-				{
-					SetExp(exp + amount);
-					exp = GetExp();
-				}
-
-				DWORD q = DWORD(next_exp / 4.0f);
-				int iLevStep = GetRealPoint(POINT_LEVEL_STEP);
-
-				// iLevStep 4 ̸̻  ö ϹǷ ⿡    ̴.
-				if (iLevStep >= 4)
-				{
-					sys_err("%s LEVEL_STEP bigger than 4! (%d)", GetName(), iLevStep);
-					iLevStep = 4;
-				}
-
-				if (exp >= next_exp && iLevStep < 4)
-				{
-					for (int i = 0; i < 4 - iLevStep; ++i)
-						PointChange(POINT_LEVEL_STEP, 1, false, true);
-				}
-				else if (exp >= q * 3 && iLevStep < 3)
-				{
-					for (int i = 0; i < 3 - iLevStep; ++i)
-						PointChange(POINT_LEVEL_STEP, 1, false, true);
-				}
-				else if (exp >= q * 2 && iLevStep < 2)
-				{
-					for (int i = 0; i < 2 - iLevStep; ++i)
-						PointChange(POINT_LEVEL_STEP, 1, false, true);
-				}
-				else if (exp >= q && iLevStep < 1)
-				{
-					PointChange(POINT_LEVEL_STEP, 1);
-				}
-
-				if (iExpBalance)
-				{
-					PointChange(POINT_EXP, iExpBalance);
-				}
-
-				val = GetExp();
-			}
-		}
-		break;
-
-		case POINT_LEVEL_STEP:
-		{
-			if (amount > 0)
-			{
-				val = GetPoint(POINT_LEVEL_STEP) + amount;
-
-				switch (val)
-				{
-					case 1:
-					case 2:
-					case 3:
-						if ((GetLevel() <= gPlayerMaxLevelStats) && (GetLevel() <= gPlayerMaxLevel))
-							PointChange(POINT_STAT, 1);
-						break;
-
-					case 4:
-					{
-						int iHP = number(JobInitialPoints[GetJob()].hp_per_lv_begin, JobInitialPoints[GetJob()].hp_per_lv_end);
-						int iSP = number(JobInitialPoints[GetJob()].sp_per_lv_begin, JobInitialPoints[GetJob()].sp_per_lv_end);
-
-						m_points.iRandomHP += iHP;
-						m_points.iRandomSP += iSP;
-
-						if (GetSkillGroup())
-						{
-							if (GetLevel() >= 5)
-								PointChange(POINT_SKILL, 1);
-
-							if (GetLevel() >= 9)
-								PointChange(POINT_SUB_SKILL, 1);
-						}
-
-						PointChange(POINT_MAX_HP, iHP);
-						PointChange(POINT_MAX_SP, iSP);
-						PointChange(POINT_LEVEL, 1, false, true);
-
-						val = 0;
-					}
-					break;
-				}
-
-				if (GetLevel() <= 10)
-					AutoGiveItem(27001, 2);
-				else if (GetLevel() <= 30)
-					AutoGiveItem(27002, 2);
-				else
-				{
-					AutoGiveItem(27002, 2);
-					// AutoGiveItem(27003, 2);
-				}
-
-				PointChange(POINT_HP, GetMaxHP() - GetHP());
-				PointChange(POINT_SP, GetMaxSP() - GetSP());
-				PointChange(POINT_STAMINA, GetMaxStamina() - GetStamina());
-
-				SetPoint(POINT_LEVEL_STEP, val);
-				SetRealPoint(POINT_LEVEL_STEP, val);
-
-				Save();
-			}
-			else
-				val = GetPoint(POINT_LEVEL_STEP);
-		} break;
-
-		case POINT_HP:
-		{
-			if (IsDead() || IsStun())
-				return;
-
-			int prev_hp = GetHP();
-
-			amount = MIN(GetMaxHP() - GetHP(), amount);
-			SetHP(GetHP() + amount);
-			val = GetHP();
-
-			BroadcastTargetPacket();
-
-			if (GetParty() && IsPC() && val != prev_hp)
-				GetParty()->SendPartyInfoOneToAll(this);
-		}
-		break;
-
-		case POINT_SP:
-		{
-			if (IsDead() || IsStun())
-				return;
-
-			amount = MIN(GetMaxSP() - GetSP(), amount);
-			SetSP(GetSP() + amount);
-			val = GetSP();
-		}
-		break;
-
-		case POINT_STAMINA:
-		{
-			if (IsDead() || IsStun())
-				return;
-
-			int prev_val = GetStamina();
-			amount = MIN(GetMaxStamina() - GetStamina(), amount);
-			SetStamina(GetStamina() + amount);
-			val = GetStamina();
-
-			if (val == 0)
-			{
-				// Stamina  !
-				SetNowWalking(true);
-			}
-			else if (prev_val == 0)
-			{
-				//  ׹̳    
-				ResetWalking();
-			}
-
-			if (amount < 0 && val != 0) // Ҵ ʴ´.
-				return;
-		}
-		break;
-
-		case POINT_MAX_HP:
-		{
-			SetPoint(type, GetPoint(type) + amount);
-
-			//SetMaxHP(GetMaxHP() + amount);
-			// ִ  = (⺻ ִ  + ߰) * ִ%
-			int curMaxHP = GetMaxHP();
-			int hp = GetRealPoint(POINT_MAX_HP);
-			int add_hp = MIN(3500, hp * GetPoint(POINT_MAX_HP_PCT) / 100);
-			add_hp += GetPoint(POINT_MAX_HP);
-			add_hp += GetPoint(POINT_PARTY_TANKER_BONUS);
-
-#if defined(__CONQUEROR_LEVEL__)
-			int max_hp = hp + add_hp;
-
-			if (IsPC() && IsSungMaCursed(POINT_SUNGMA_HP))
-				max_hp /= 2;
-
-			SetMaxHP(max_hp);
-#else
-			SetMaxHP(hp + add_hp);
-#endif
-
-			float fRatio = (float)GetMaxHP() / (float)curMaxHP;
-			PointChange(POINT_HP, GetHP()* fRatio - GetHP());
-
-			val = GetMaxHP();
-		}
-		break;
-
-		case POINT_MAX_SP:
-		{
-			SetPoint(type, GetPoint(type) + amount);
-
-			//SetMaxSP(GetMaxSP() + amount);
-			// ִ ŷ = (⺻ ִ ŷ + ߰) * ִŷ%
-			int curMaxSP = GetMaxSP();
-			int sp = GetRealPoint(POINT_MAX_SP);
-			int add_sp = MIN(800, sp * GetPoint(POINT_MAX_SP_PCT) / 100);
-			add_sp += GetPoint(POINT_MAX_SP);
-			add_sp += GetPoint(POINT_PARTY_SKILL_MASTER_BONUS);
-
-			SetMaxSP(sp + add_sp);
-
-			float fRatio = (float)GetMaxSP() / (float)curMaxSP;
-			PointChange(POINT_SP, GetSP() * fRatio - GetSP());
-
-			val = GetMaxSP();
-		}
-		break;
-
-		case POINT_MAX_HP_PCT:
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-
-			PointChange(POINT_MAX_HP, 0);
-			break;
-
-		case POINT_MAX_SP_PCT:
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-
-			PointChange(POINT_MAX_SP, 0);
-			break;
-
-		case POINT_MAX_STAMINA:
-			SetMaxStamina(GetMaxStamina() + amount);
-			val = GetMaxStamina();
-			break;
-
-		case POINT_GOLD:
-		{
-			/*
-			* The conversion to `int64_t` is necessary in this case because the maximum value
-			* that can be represented by an int may not be sufficient to hold the sum of the
-			* current gold value (GetGold()) and the additional amount of gold (`amount`).
-			*/
-			const int64_t nTotalGold = static_cast<int64_t>(GetGold()) + amount;
-			if (GOLD_MAX <= nTotalGold)
-			{
-				sys_err("[OVERFLOW_GOLD] OriGold %d AddedGold %ld id %u Name %s ", GetGold(), amount, GetPlayerID(), GetName());
-				LogManager::instance().CharLog(this, GetGold() + amount, "OVERFLOW_GOLD", "");
-				return;
-			}
-
-			SetGold(GetGold() + amount);
-			val = GetGold();
-		}
-		break;
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-		case POINT_BATTLE_PASS_PREMIUM_ID:
-			{
-				SetExtBattlePassPremiumID(amount);
-				val = GetExtBattlePassPremiumID();
-			}
-			break;
-#endif
-
-		case POINT_SKILL:
-		case POINT_STAT:
-		case POINT_SUB_SKILL:
-		case POINT_STAT_RESET_COUNT:
-		case POINT_HORSE_SKILL:
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-
-			SetRealPoint(type, val);
-			break;
-
-		case POINT_DEF_GRADE:
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-
-			PointChange(POINT_CLIENT_DEF_GRADE, amount);
-			break;
-
-		case POINT_CLIENT_DEF_GRADE:
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-			break;
-
-		case POINT_ST:
-		case POINT_HT:
-		case POINT_DX:
-		case POINT_IQ:
-		case POINT_HP_REGEN:
-		case POINT_SP_REGEN:
-		case POINT_ATT_SPEED:
-		case POINT_ATT_GRADE:
-		case POINT_MOV_SPEED:
-		case POINT_CASTING_SPEED:
-		case POINT_MAGIC_ATT_GRADE:
-		case POINT_MAGIC_DEF_GRADE:
-		case POINT_BOW_DISTANCE:
-		case POINT_HP_RECOVERY:
-		case POINT_SP_RECOVERY:
-
-		case POINT_ATTBONUS_HUMAN: // 42 ΰ 
-		case POINT_ATTBONUS_ANIMAL: // 43   % 
-		case POINT_ATTBONUS_ORC: // 44 Ϳ  % 
-		case POINT_ATTBONUS_MILGYO: // 45 б  % 
-		case POINT_ATTBONUS_UNDEAD: // 46 ü  % 
-		case POINT_ATTBONUS_DEVIL: // 47 (Ǹ)  % 
-		case POINT_ATTBONUS_INSECT:
-		case POINT_ATTBONUS_DESERT:
-
-		case POINT_ATTBONUS_MONSTER:
-		case POINT_ATTBONUS_SURA:
-		case POINT_ATTBONUS_ASSASSIN:
-		case POINT_ATTBONUS_WARRIOR:
-		case POINT_ATTBONUS_SHAMAN:
-		case POINT_ATTBONUS_WOLFMAN:
-
-		case POINT_POISON_PCT:
-		case POINT_BLEEDING_PCT:
-
-		case POINT_STUN_PCT:
-		case POINT_SLOW_PCT:
-
-		case POINT_BLOCK:
-		case POINT_DODGE:
-
-		case POINT_CRITICAL_PCT:
-		case POINT_RESIST_CRITICAL:
-		case POINT_PENETRATE_PCT:
-		case POINT_RESIST_PENETRATE:
-		case POINT_CURSE_PCT:
-
-		case POINT_STEAL_HP: // 48  
-		case POINT_STEAL_SP: // 49 ŷ 
-
-		case POINT_MANA_BURN_PCT: // 50  
-		case POINT_DAMAGE_SP_RECOVER: // 51 ݴ  ŷ ȸ Ȯ
-		case POINT_RESIST_NORMAL_DAMAGE:
-		case POINT_RESIST_SWORD:
-		case POINT_RESIST_TWOHAND:
-		case POINT_RESIST_DAGGER:
-		case POINT_RESIST_BELL:
-		case POINT_RESIST_FAN:
-		case POINT_RESIST_BOW:
-		case POINT_RESIST_CLAW:
-
-		case POINT_RESIST_FIRE:
-		case POINT_RESIST_ELEC:
-		case POINT_RESIST_MAGIC:
-#if defined(__MAGIC_REDUCTION__)
-		case POINT_RESIST_MAGIC_REDUCTION:
-#endif
-		case POINT_RESIST_WIND:
-		case POINT_RESIST_ICE:
-		case POINT_RESIST_EARTH:
-		case POINT_RESIST_DARK:
-		case POINT_REFLECT_MELEE: // 67  ݻ
-		case POINT_REFLECT_CURSE: // 68  ݻ
-		case POINT_POISON_REDUCE: // 69  
-		case POINT_BLEEDING_REDUCE:
-
-		case POINT_KILL_SP_RECOVER: // 70  Ҹ MP ȸ
-		case POINT_KILL_HP_RECOVERY: // 75
-		case POINT_HIT_HP_RECOVERY:
-		case POINT_HIT_SP_RECOVERY:
-		case POINT_MANASHIELD:
-		case POINT_ATT_BONUS:
-		case POINT_DEF_BONUS:
-		case POINT_SKILL_DAMAGE_BONUS:
-		case POINT_NORMAL_HIT_DAMAGE_BONUS:
-		case POINT_SKILL_DEFEND_BONUS:
-		case POINT_NORMAL_HIT_DEFEND_BONUS:
-			// DEPEND_BONUS_ATTRIBUTES
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-			break;
-			// END_OF_DEPEND_BONUS_ATTRIBUTES
-
-		case POINT_PARTY_ATTACKER_BONUS:
-		case POINT_PARTY_TANKER_BONUS:
-		case POINT_PARTY_BUFFER_BONUS:
-		case POINT_PARTY_SKILL_MASTER_BONUS:
-		case POINT_PARTY_HASTE_BONUS:
-		case POINT_PARTY_DEFENDER_BONUS:
-
-		case POINT_RESIST_WARRIOR:
-		case POINT_RESIST_ASSASSIN:
-		case POINT_RESIST_SURA:
-		case POINT_RESIST_SHAMAN:
-		case POINT_RESIST_WOLFMAN:
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-			break;
-
-		case POINT_MALL_ATTBONUS:
-		case POINT_MALL_DEFBONUS:
-		case POINT_MALL_EXPBONUS:
-		case POINT_MALL_ITEMBONUS:
-		case POINT_MALL_GOLDBONUS:
-		case POINT_MELEE_MAGIC_ATT_BONUS_PER:
-		{
-			//if (GetPoint(type) + amount > 100)
-			//{
-			//	sys_err("MALL_BONUS exceeded over 100!! point type: %d name: %s amount %lld", type, GetName(), amount);
-			//	amount = 100 - GetPoint(type);
-			//}
-
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-		}
-		break;
-
-		// PC_BANG_ITEM_ADD
-		case POINT_PC_BANG_EXP_BONUS:
-		case POINT_PC_BANG_DROP_BONUS:
-		case POINT_RAMADAN_CANDY_BONUS_EXP:
-			SetPoint(type, amount);
-			val = GetPoint(type);
-			break;
-			// END_PC_BANG_ITEM_ADD
-
-		case POINT_EXP_DOUBLE_BONUS:
-		case POINT_GOLD_DOUBLE_BONUS:
-		case POINT_ITEM_DROP_BONUS:
-		case POINT_POTION_BONUS:
-			if (GetPoint(type) + amount > 100)
-			{
-				sys_err("BONUS exceeded over 100!! point type: %d name: %s amount %lld", type, GetName(), amount);
-				amount = 100 - GetPoint(type);
-			}
-
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-			break;
-
-		case POINT_IMMUNE_STUN:
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-			if (val)
-				SET_BIT(m_pointsInstant.dwImmuneFlag, IMMUNE_STUN);
-			else
-				REMOVE_BIT(m_pointsInstant.dwImmuneFlag, IMMUNE_STUN);
-			break;
-
-		case POINT_IMMUNE_SLOW:
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-			if (val)
-				SET_BIT(m_pointsInstant.dwImmuneFlag, IMMUNE_SLOW);
-			else
-				REMOVE_BIT(m_pointsInstant.dwImmuneFlag, IMMUNE_SLOW);
-			break;
-
-		case POINT_IMMUNE_FALL:
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-			if (val)
-				SET_BIT(m_pointsInstant.dwImmuneFlag, IMMUNE_FALL);
-			else
-				REMOVE_BIT(m_pointsInstant.dwImmuneFlag, IMMUNE_FALL);
-			break;
-
-		case POINT_ATT_GRADE_BONUS:
-			SetPoint(type, GetPoint(type) + amount);
-			PointChange(POINT_ATT_GRADE, amount);
-			val = GetPoint(type);
-			break;
-
-		case POINT_DEF_GRADE_BONUS:
-			SetPoint(type, GetPoint(type) + amount);
-			PointChange(POINT_DEF_GRADE, amount);
-			val = GetPoint(type);
-			break;
-
-		case POINT_MAGIC_ATT_GRADE_BONUS:
-			SetPoint(type, GetPoint(type) + amount);
-			PointChange(POINT_MAGIC_ATT_GRADE, amount);
-			val = GetPoint(type);
-			break;
-
-		case POINT_MAGIC_DEF_GRADE_BONUS:
-			SetPoint(type, GetPoint(type) + amount);
-			PointChange(POINT_MAGIC_DEF_GRADE, amount);
-			val = GetPoint(type);
-			break;
-
-		case POINT_VOICE:
-		case POINT_EMPIRE_POINT:
-			//sys_err("CHARACTER::PointChange: %s: point cannot be changed. use SetPoint instead (type: %d)", GetName(), type);
-			val = GetRealPoint(type);
-			break;
-
-		case POINT_POLYMORPH:
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-			SetPolymorph(val);
-			break;
-
-		case POINT_MOUNT:
-		{
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-#if !defined(__MOUNT_COSTUME_SYSTEM__)
-			MountVnum(val);
-#endif
-		}
-		break;
-
-		case POINT_ENERGY:
-		case POINT_COSTUME_ATTR_BONUS:
-		{
-			int old_val = GetPoint(type);
-			SetPoint(type, old_val + amount);
-			val = GetPoint(type);
-			BuffOnAttr_ValueChange(type, old_val, val);
-		}
-		break;
-
-#if defined(__CHEQUE_SYSTEM__)
-		case POINT_CHEQUE:
-		{
-			const POINT_VALUE nTotalCheque = static_cast<POINT_VALUE>(GetCheque()) + amount;
-			if (CHEQUE_MAX < nTotalCheque)
-			{
-				sys_err("[OVERFLOW_CHEQUE] OriCheque %d AddedCheque %ld id %u Name %s ", GetCheque(), amount, GetPlayerID(), GetName());
-				LogManager::instance().CharLog(this, GetCheque() + amount, "OVERFLOW_CHEQUE", "");
-				return;
-			}
-
-			SetCheque(GetCheque() + amount);
-			val = GetCheque();
-		}
-		break;
-#endif
-
-#if defined(__GEM_SYSTEM__)
-		case POINT_GEM:
-		{
-			const POINT_VALUE nTotalGem = static_cast<POINT_VALUE>(GetGem()) + amount;
-			if (GEM_MAX <= nTotalGem)
-			{
-				sys_err("[OVERFLOW_GEM] OriGem %d AddedGem %ld id %u Name %s ", GetGem(), amount, GetPlayerID(), GetName());
-				LogManager::instance().CharLog(this, GetGem() + amount, "OVERFLOW_GEM", "");
-				return;
-			}
-
-			SetGem(GetGem() + amount);
-			val = GetGem();
-		}
-		break;
-#endif
-
-#if defined(__ELEMENT_SYSTEM__)
-		case POINT_ENCHANT_ELECT:
-		case POINT_ENCHANT_FIRE:
-		case POINT_ENCHANT_ICE:
-		case POINT_ENCHANT_WIND:
-		case POINT_ENCHANT_EARTH:
-		case POINT_ENCHANT_DARK:
-		{
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-			BroadcastTargetPacket();
-		}
-		break;
-#endif
-
-		case POINT_RESIST_HUMAN:
-		case POINT_ATTBONUS_CZ:
-		case POINT_ATTBONUS_SWORD:
-		case POINT_ATTBONUS_TWOHAND:
-		case POINT_ATTBONUS_DAGGER:
-		case POINT_ATTBONUS_BELL:
-		case POINT_ATTBONUS_FAN:
-		case POINT_ATTBONUS_BOW:
-		case POINT_ATTBONUS_CLAW:
-		case POINT_RESIST_MOUNT_FALL:
-		case POINT_RESIST_FIST:
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-			break;
-
-		case POINT_PREMIUM_EXPBONUS:
-		case POINT_PRIVILEGE_EXPBONUS:
-		case POINT_MARRIAGE_EXPBONUS:
-		case POINT_DEVILTOWER_EXPBONUS:
-		case POINT_PREMIUM_ITEMBONUS:
-		case POINT_PRIVILEGE_ITEMBONUS:
-		case POINT_PREMIUM_GOLDBONUS:
-		case POINT_PRIVILEGE_GOLDBONUS:
-			// UNUSED
-			break;
-
-		case POINT_SKILL_DAMAGE_SAMYEON:
-		case POINT_SKILL_DAMAGE_TANHWAN:
-		case POINT_SKILL_DAMAGE_PALBANG:
-		case POINT_SKILL_DAMAGE_GIGONGCHAM:
-		case POINT_SKILL_DAMAGE_GYOKSAN:
-		case POINT_SKILL_DAMAGE_GEOMPUNG:
-		case POINT_SKILL_DAMAGE_AMSEOP:
-		case POINT_SKILL_DAMAGE_GUNGSIN:
-		case POINT_SKILL_DAMAGE_CHARYUN:
-		case POINT_SKILL_DAMAGE_SANGONG:
-		case POINT_SKILL_DAMAGE_YEONSA:
-		case POINT_SKILL_DAMAGE_KWANKYEOK:
-		case POINT_SKILL_DAMAGE_GIGUNG:
-		case POINT_SKILL_DAMAGE_HWAJO:
-		case POINT_SKILL_DAMAGE_SWAERYUNG:
-		case POINT_SKILL_DAMAGE_YONGKWON:
-		case POINT_SKILL_DAMAGE_PABEOB:
-		case POINT_SKILL_DAMAGE_MARYUNG:
-		case POINT_SKILL_DAMAGE_HWAYEOMPOK:
-		case POINT_SKILL_DAMAGE_MAHWAN:
-		case POINT_SKILL_DAMAGE_BIPABU:
-		case POINT_SKILL_DAMAGE_YONGBI:
-		case POINT_SKILL_DAMAGE_PAERYONG:
-		case POINT_SKILL_DAMAGE_NOEJEON:
-		case POINT_SKILL_DAMAGE_BYEURAK:
-		case POINT_SKILL_DAMAGE_CHAIN:
-		case POINT_SKILL_DAMAGE_CHAYEOL:
-		case POINT_SKILL_DAMAGE_SALPOONG:
-		case POINT_SKILL_DAMAGE_GONGDAB:
-		case POINT_SKILL_DAMAGE_PASWAE:
-			// UNUSED
-			break;
-
-		case POINT_NORMAL_HIT_DEFEND_BONUS_BOSS_OR_MORE:
-		case POINT_SKILL_DEFEND_BONUS_BOSS_OR_MORE:
-		case POINT_NORMAL_HIT_DAMAGE_BONUS_BOSS_OR_MORE:
-		case POINT_SKILL_DAMAGE_BONUS_BOSS_OR_MORE:
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-			break;
-
-		case POINT_HIT_BUFF_ENCHANT_FIRE:
-		case POINT_HIT_BUFF_ENCHANT_ICE:
-		case POINT_HIT_BUFF_ENCHANT_ELEC:
-		case POINT_HIT_BUFF_ENCHANT_WIND:
-		case POINT_HIT_BUFF_ENCHANT_DARK:
-		case POINT_HIT_BUFF_ENCHANT_EARTH:
-		case POINT_HIT_BUFF_RESIST_FIRE:
-		case POINT_HIT_BUFF_RESIST_ICE:
-		case POINT_HIT_BUFF_RESIST_ELEC:
-		case POINT_HIT_BUFF_RESIST_WIND:
-		case POINT_HIT_BUFF_RESIST_DARK:
-		case POINT_HIT_BUFF_RESIST_EARTH:
-		case POINT_HIT_BUFF_SUNGMA_STR:
-		case POINT_HIT_BUFF_SUNGMA_MOVE:
-		case POINT_HIT_BUFF_SUNGMA_HP:
-		case POINT_HIT_BUFF_SUNGMA_IMMUNE:
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-			break;
-
-		case POINT_USE_SKILL_CHEONGRANG_MOV_SPEED:
-		case POINT_USE_SKILL_CHEONGRANG_CASTING_SPEED:
-		case POINT_USE_SKILL_CHAYEOL_CRITICAL_PCT:
-		case POINT_USE_SKILL_SANGONG_ATT_GRADE_BONUS:
-		case POINT_USE_SKILL_GIGUNG_ATT_GRADE_BONUS:
-		case POINT_USE_SKILL_JEOKRANG_DEF_BONUS:
-		case POINT_USE_SKILL_GWIGEOM_DEF_BONUS:
-		case POINT_USE_SKILL_TERROR_ATT_GRADE_BONUS:
-		case POINT_USE_SKILL_MUYEONG_ATT_GRADE_BONUS:
-		case POINT_USE_SKILL_MANASHILED_CASTING_SPEED:
-		case POINT_USE_SKILL_HOSIN_DEF_BONUS:
-		case POINT_USE_SKILL_GICHEON_ATT_GRADE_BONUS:
-		case POINT_USE_SKILL_JEONGEOP_ATT_GRADE_BONUS:
-		case POINT_USE_SKILL_JEUNGRYEOK_DEF_BONUS:
-		case POINT_USE_SKILL_GIHYEOL_ATT_GRADE_BONUS:
-		case POINT_USE_SKILL_CHUNKEON_CASTING_SPEED:
-		case POINT_USE_SKILL_NOEGEOM_ATT_GRADE_BONUS:
-			// UNUSED
-			break;
-
-		case POINT_SKILL_DURATION_INCREASE_EUNHYUNG:
-		case POINT_SKILL_DURATION_INCREASE_GYEONGGONG:
-		case POINT_SKILL_DURATION_INCREASE_GEOMKYUNG:
-		case POINT_SKILL_DURATION_INCREASE_JEOKRANG:
-			// UNUSED
-			break;
-
-		case POINT_USE_SKILL_PALBANG_HP_ABSORB:
-		case POINT_USE_SKILL_AMSEOP_HP_ABSORB:
-		case POINT_USE_SKILL_YEONSA_HP_ABSORB:
-		case POINT_USE_SKILL_YONGBI_HP_ABSORB:
-		case POINT_USE_SKILL_CHAIN_HP_ABSORB:
-		case POINT_USE_SKILL_PASWAE_SP_ABSORB:
-		case POINT_USE_SKILL_GIGONGCHAM_STUN:
-		case POINT_USE_SKILL_CHARYUN_STUN:
-		case POINT_USE_SKILL_PABEOB_STUN:
-		case POINT_USE_SKILL_MAHWAN_STUN:
-		case POINT_USE_SKILL_GONGDAB_STUN:
-		case POINT_USE_SKILL_SAMYEON_STUN:
-		case POINT_USE_SKILL_GYOKSAN_KNOCKBACK:
-		case POINT_USE_SKILL_SEOMJEON_KNOCKBACK:
-		case POINT_USE_SKILL_SWAERYUNG_KNOCKBACK:
-		case POINT_USE_SKILL_HWAYEOMPOK_KNOCKBACK:
-		case POINT_USE_SKILL_GONGDAB_KNOCKBACK:
-		case POINT_USE_SKILL_KWANKYEOK_KNOCKBACK:
-		case POINT_USE_SKILL_SAMYEON_NEXT_COOLTIME_DECREASE_10PER:
-		case POINT_USE_SKILL_GEOMPUNG_NEXT_COOLTIME_DECREASE_10PER:
-		case POINT_USE_SKILL_GUNGSIN_NEXT_COOLTIME_DECREASE_10PER:
-		case POINT_USE_SKILL_KWANKYEOK_NEXT_COOLTIME_DECREASE_10PER:
-		case POINT_USE_SKILL_YONGKWON_NEXT_COOLTIME_DECREASE_10PER:
-		case POINT_USE_SKILL_MARYUNG_NEXT_COOLTIME_DECREASE_10PER:
-		case POINT_USE_SKILL_BIPABU_NEXT_COOLTIME_DECREASE_10PER:
-		case POINT_USE_SKILL_NOEJEON_NEXT_COOLTIME_DECREASE_10PER:
-		case POINT_USE_SKILL_SALPOONG_NEXT_COOLTIME_DECREASE_10PER:
-		case POINT_USE_SKILL_PASWAE_NEXT_COOLTIME_DECREASE_10PER:
-			// UNUSED
-			break;
-
-		case POINT_ATTBONUS_STONE:
-		case POINT_DAMAGE_HP_RECOVERY:
-		case POINT_DAMAGE_SP_RECOVERY:
-		case POINT_ALIGNMENT_DAMAGE_BONUS:
-		case POINT_NORMAL_DAMAGE_GUARD:
-		case POINT_MORE_THEN_HP90_DAMAGE_REDUCE:
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-			break;
-
-		case POINT_USE_SKILL_TUSOK_HP_ABSORB:
-		case POINT_USE_SKILL_PAERYONG_HP_ABSORB:
-		case POINT_USE_SKILL_BYEURAK_HP_ABSORB:
-		case POINT_USE_SKILL_SAMYEON_NEXT_COOLTIME_DECREASE_20PER:
-		case POINT_USE_SKILL_GEOMPUNG_NEXT_COOLTIME_DECREASE_20PER:
-		case POINT_USE_SKILL_GUNGSIN_NEXT_COOLTIME_DECREASE_20PER:
-		case POINT_USE_SKILL_KWANKYEOK_NEXT_COOLTIME_DECREASE_20PER:
-		case POINT_USE_SKILL_YONGKWON_NEXT_COOLTIME_DECREASE_20PER:
-		case POINT_USE_SKILL_MARYUNG_NEXT_COOLTIME_DECREASE_20PER:
-		case POINT_USE_SKILL_BIPABU_NEXT_COOLTIME_DECREASE_20PER:
-		case POINT_USE_SKILL_NOEJEON_NEXT_COOLTIME_DECREASE_20PER:
-		case POINT_USE_SKILL_SALPOONG_NEXT_COOLTIME_DECREASE_20PER:
-		case POINT_USE_SKILL_PASWAE_NEXT_COOLTIME_DECREASE_20PER:
-		case POINT_USE_SKILL_CHAYEOL_HP_ABSORB:
-			// UNUSED
-			break;
-
-		case POINT_MEDAL_OF_HONOR:
-		case POINT_ALL_STAT_BONUS:
-			// UNUSED
-			break;
-
-#if defined(__CONQUEROR_LEVEL__)
-		case POINT_SUNGMA_STR:
-		{
-			amount *= 1 + (GetPoint(POINT_SUNGMA_PER_STR) / 100);
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-		}
-		break;
-
-		case POINT_SUNGMA_HP:
-		{
-			amount *= 1 + (GetPoint(POINT_SUNGMA_PER_HP) / 100);
-			SetPoint(type, GetPoint(type) + amount);
-
-			PointChange(POINT_MAX_HP, 0);
-			val = GetPoint(type);
-		}
-		break;
-
-		case POINT_SUNGMA_MOVE:
-		{
-			amount *= 1 + (GetPoint(POINT_SUNGMA_PER_MOVE) / 100);
-			SetPoint(type, GetPoint(type) + amount);
-
-			// NOTE : Refresh move speed points. (Client)
-			UpdatePointsPacket(POINT_MOV_SPEED, GetLimitPoint(POINT_MOV_SPEED));
-			val = GetPoint(type);
-		}
-		break;
-
-		case POINT_SUNGMA_IMMUNE:
-		{
-			amount *= 1 + (GetPoint(POINT_SUNGMA_PER_IMMUNE) / 100);
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-		}
-		break;
-
-		case POINT_SUNGMA_PER_STR:
-		case POINT_SUNGMA_PER_HP:
-		case POINT_SUNGMA_PER_MOVE:
-		case POINT_SUNGMA_PER_IMMUNE:
-		{
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-		}
-		break;
-
-		case POINT_CONQUEROR_LEVEL:
-		{
-			if ((GetConquerorLevel() + amount) > gPlayerMaxConquerorLevel)
-				return;
-
-			SetConquerorLevel(GetConquerorLevel() + amount);
-			val = GetConquerorLevel();
-
-			sys_log(0, "CONQUEROR_LEVELUP: %s %d NEXT EXP %d", GetName(), GetConquerorLevel(), GetNextConquerorExp());
-
-			PointChange(POINT_CONQUEROR_NEXT_EXP, GetNextConquerorExp(), false);
-		}
-		break;
-
-		case POINT_CONQUEROR_LEVEL_STEP:
-		{
-			if (amount > 0)
-			{
-				val = GetPoint(POINT_CONQUEROR_LEVEL_STEP) + amount;
-				switch (val)
-				{
-					case 1:
-					case 2:
-					case 3:
-					{
-						if ((GetConquerorLevel() <= gPlayerMaxLevelStats) && (GetConquerorLevel() <= gPlayerMaxConquerorLevel))
-							PointChange(POINT_CONQUEROR_POINT, 1);
-					} break;
-					case 4:
-					{
-						PointChange(POINT_CONQUEROR_POINT, 1);
-						PointChange(POINT_CONQUEROR_LEVEL, 1, false, true);
-						val = 0;
-					} break;
-				}
-
-				SetPoint(POINT_CONQUEROR_LEVEL_STEP, val);
-				SetRealPoint(POINT_CONQUEROR_LEVEL_STEP, val);
-
-				Save();
-			}
-			else
-				val = GetPoint(POINT_CONQUEROR_LEVEL_STEP);
-		}
-		break;
-
-		case POINT_CONQUEROR_EXP:
-		{
-			DWORD exp = GetConquerorExp();
-			DWORD next_exp = GetNextConquerorExp();
-
-			if (amount < 0 && exp <= -amount)
-			{
-				sys_log(0, "%s - Reduce EXP by %d, CUR EXP: %d (setting to zero)", GetName(), -amount, exp);
-				amount = -exp;
-
-				SetConquerorExp(0);
-				val = GetExp();
-			}
-			else
-			{
-				if (GetConquerorLevel() >= gPlayerMaxConquerorLevel)
-					return;
-
-#if defined(__CHATTING_WINDOW_RENEWAL__)
-				ChatPacket(CHAT_TYPE_EXP_INFO, LC_STRING("You have received %lu EXP for your Champion Level.", amount));
-#endif
-
-				DWORD iExpBalance = 0;
-
-				//  !
-				if (exp + amount >= next_exp)
-				{
-					iExpBalance = (exp + amount) - next_exp;
-					amount = next_exp - exp;
-
-					SetConquerorExp(0);
-					exp = next_exp;
-				}
-				else
-				{
-					SetConquerorExp(exp + amount);
-					exp = GetConquerorExp();
-				}
-
-				DWORD q = DWORD(next_exp / 4.0f);
-				int iLevStep = GetRealPoint(POINT_CONQUEROR_LEVEL_STEP);
-
-				if (iLevStep >= 4)
-				{
-					sys_err("%s CONQUEROR_LEVEL_STEP bigger than 4! (%d)", GetName(), iLevStep);
-					iLevStep = 4;
-				}
-
-				if (exp >= next_exp && iLevStep < 4)
-				{
-					for (int i = 0; i < 4 - iLevStep; ++i)
-						PointChange(POINT_CONQUEROR_LEVEL_STEP, 1, false, true);
-				}
-				else if (exp >= q * 3 && iLevStep < 3)
-				{
-					for (int i = 0; i < 3 - iLevStep; ++i)
-						PointChange(POINT_CONQUEROR_LEVEL_STEP, 1, false, true);
-				}
-				else if (exp >= q * 2 && iLevStep < 2)
-				{
-					for (int i = 0; i < 2 - iLevStep; ++i)
-						PointChange(POINT_CONQUEROR_LEVEL_STEP, 1, false, true);
-				}
-				else if (exp >= q && iLevStep < 1)
-					PointChange(POINT_CONQUEROR_LEVEL_STEP, 1);
-
-				if (iExpBalance)
-					PointChange(POINT_CONQUEROR_EXP, iExpBalance);
-
-				val = GetConquerorExp();
-			}
-		}
-		break;
-
-		case POINT_CONQUEROR_NEXT_EXP:
-		{
-			val = GetNextConquerorExp();
-			bAmount = false;
-		}
-		break;
-
-		case POINT_CONQUEROR_POINT:
-		{
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-			SetRealPoint(type, val);
-		}
-		break;
-#endif
-
-		case POINT_HIT_PCT:
-		{
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-			break;
-		}
-
-		case POINT_ATTBONUS_PER_HUMAN:
-		case POINT_ATTBONUS_PER_ANIMAL:
-		case POINT_ATTBONUS_PER_ORC:
-		case POINT_ATTBONUS_PER_MILGYO:
-		case POINT_ATTBONUS_PER_UNDEAD:
-		case POINT_ATTBONUS_PER_DEVIL:
-		case POINT_ENCHANT_PER_ELECT:
-		case POINT_ENCHANT_PER_FIRE:
-		case POINT_ENCHANT_PER_ICE:
-		case POINT_ENCHANT_PER_WIND:
-		case POINT_ENCHANT_PER_EARTH:
-		case POINT_ENCHANT_PER_DARK:
-		case POINT_ATTBONUS_PER_CZ:
-		case POINT_ATTBONUS_PER_INSECT:
-		case POINT_ATTBONUS_PER_DESERT:
-		case POINT_ATTBONUS_PER_STONE:
-		case POINT_ATTBONUS_PER_MONSTER:
-		case POINT_RESIST_PER_HUMAN:
-		case POINT_RESIST_PER_ICE:
-		case POINT_RESIST_PER_DARK:
-		case POINT_RESIST_PER_EARTH:
-		case POINT_RESIST_PER_FIRE:
-		case POINT_RESIST_PER_ELEC:
-		case POINT_RESIST_PER_MAGIC:
-		case POINT_RESIST_PER_WIND:
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-			break;
-
-			//case POINT_MOUNT_MELEE_MAGIC_ATTBONUS_PER:
-			//case POINT_DISMOUNT_MOVE_SPEED_BONUS_PER:
-			//case POINT_HIT_AUTO_HP_RECOVERY:
-			//case POINT_HIT_AUTO_SP_RECOVERY:
-			//case POINT_USE_SKILL_COOLTIME_DECREASE_ALL:
-			//case POINT_HIT_STONE_ATTBONUS_STONE:
-			//case POINT_HIT_STONE_DEF_GRADE_BONUS:
-			//case POINT_KILL_BOSS_ITEM_BONUS:
-			//case POINT_MOB_HIT_MOB_AGGRESSIVE:
-			//case POINT_NO_DEATH_AND_HP_RECOVERY30:
-			//case POINT_AUTO_PICKUP:
-		case POINT_MOUNT_NO_KNOCKBACK:
-
-			//case POINT_IMMUNE_POISON100:
-			//case POINT_IMMUNE_BLEEDING100:
-		case POINT_MONSTER_DEFEND_BONUS:
-			SetPoint(type, GetPoint(type) + amount);
-			val = GetPoint(type);
-			break;
-
-		default:
-			sys_err("CHARACTER::PointChange: %s: unknown point change type %d", GetName(), type);
-			return;
-	}
-
-	switch (type)
-	{
-		case POINT_LEVEL:
-		case POINT_ST:
-		case POINT_DX:
-		case POINT_IQ:
-		case POINT_HT:
-#if defined(__CONQUEROR_LEVEL__)
-		case POINT_CONQUEROR_LEVEL:
-		case POINT_SUNGMA_STR:
-		case POINT_SUNGMA_HP:
-		case POINT_SUNGMA_MOVE:
-		case POINT_SUNGMA_IMMUNE:
-#endif
-			ComputeBattlePoints();
-			break;
-
-		case POINT_MAX_HP:
-		case POINT_MAX_SP:
-		case POINT_MAX_STAMINA:
-			break;
-	}
-
-	if (type == POINT_HP && amount == 0)
-		return;
-
-	UpdatePointsPacket(type, val, amount, bAmount, bBroadcast);
-}
-
-void CHARACTER::ApplyPoint(POINT_TYPE wApplyType, POINT_VALUE lApplyValue)
-{
-	switch (wApplyType)
-	{
-		case APPLY_NONE:						// 0
-			break;
-
-			// NOTE: ۿ  ִHP ʽ Ʈ  ʽ Ȱ  ϹǷ
-			// ׳ MAX_HP ϸ Ʈ    .    ո̱⵵ ϰ..
-			// ٲ   ִ hp  hp    ٲ ִ hp  hp Ѵ.
-			//  PointChange ϴ°      skip..
-			// SP Ȱ Ѵ.
-			// Mantis : 101460 ~ ity ~
-		case APPLY_MAX_HP:						// 1
-		{
-			if (GetMaxHP() == 0) break;
-			PointChange(aApplyInfo[wApplyType].wPointType, lApplyValue);
-		}
-		break;
-
-		case APPLY_MAX_SP:						// 2
-		{
-			if (GetMaxSP() == 0) break;
-			PointChange(aApplyInfo[wApplyType].wPointType, lApplyValue);
-		}
-		break;
-
-		case APPLY_CON:							// 3
-		{
-			PointChange(POINT_HT, lApplyValue);
-			PointChange(POINT_MAX_HP, (lApplyValue * JobInitialPoints[GetJob()].hp_per_ht));
-			PointChange(POINT_MAX_STAMINA, (lApplyValue * JobInitialPoints[GetJob()].stamina_per_con));
-		}
-		break;
-
-		case APPLY_INT:							// 4
-		{
-			PointChange(POINT_IQ, lApplyValue);
-			PointChange(POINT_MAX_SP, (lApplyValue * JobInitialPoints[GetJob()].sp_per_iq));
-		}
-		break;
-
-		case APPLY_STR:							// 5
-		case APPLY_DEX:							// 6
-		case APPLY_ATT_SPEED:					// 7
-		case APPLY_MOV_SPEED:					// 8
-		case APPLY_CAST_SPEED:					// 9
-		case APPLY_HP_REGEN:					// 10
-		case APPLY_SP_REGEN:					// 11
-		case APPLY_POISON_PCT:					// 12
-		case APPLY_STUN_PCT:					// 13
-		case APPLY_SLOW_PCT:					// 14
-		case APPLY_CRITICAL_PCT:				// 15
-		case APPLY_PENETRATE_PCT:				// 16
-		case APPLY_ATTBONUS_HUMAN:				// 17
-		case APPLY_ATTBONUS_ANIMAL:				// 18
-		case APPLY_ATTBONUS_ORC:				// 19
-		case APPLY_ATTBONUS_MILGYO:				// 20
-		case APPLY_ATTBONUS_UNDEAD:				// 21
-		case APPLY_ATTBONUS_DEVIL:				// 22
-		case APPLY_STEAL_HP:					// 23
-		case APPLY_STEAL_SP:					// 24
-		case APPLY_MANA_BURN_PCT:				// 25
-		case APPLY_DAMAGE_SP_RECOVER:			// 26
-		case APPLY_BLOCK:						// 27
-		case APPLY_DODGE:						// 28
-		case APPLY_RESIST_SWORD:				// 29
-		case APPLY_RESIST_TWOHAND:				// 30
-		case APPLY_RESIST_DAGGER:				// 31
-		case APPLY_RESIST_BELL:					// 32
-		case APPLY_RESIST_FAN:					// 33
-		case APPLY_RESIST_BOW:					// 34
-		case APPLY_RESIST_FIRE:					// 35
-		case APPLY_RESIST_ELEC:					// 36
-		case APPLY_RESIST_MAGIC:				// 37
-		case APPLY_RESIST_WIND:					// 38
-		case APPLY_REFLECT_MELEE:				// 39
-		case APPLY_REFLECT_CURSE:				// 40
-		case APPLY_POISON_REDUCE:				// 41
-		case APPLY_KILL_SP_RECOVER:				// 42
-		case APPLY_EXP_DOUBLE_BONUS:			// 43
-		case APPLY_GOLD_DOUBLE_BONUS:			// 44
-		case APPLY_ITEM_DROP_BONUS:				// 45
-		case APPLY_POTION_BONUS:				// 46
-		case APPLY_KILL_HP_RECOVER:				// 47
-		case APPLY_IMMUNE_STUN:					// 48
-		case APPLY_IMMUNE_SLOW:					// 49
-		case APPLY_IMMUNE_FALL:					// 50
-			PointChange(aApplyInfo[wApplyType].wPointType, lApplyValue);
-			break;
-
-		case APPLY_SKILL:						// 51
-			// SKILL_DAMAGE_BONUS
-		{
-			// ֻ Ʈ  8Ʈ vnum, 9Ʈ add, 15Ʈ change
-			// 00000000 00000000 00000000 00000000
-			// ^^^^^^^^  ^^^^^^^^^^^^^^^^^^^^^^^^^
-			// vnum		^ add		change
-			BYTE bSkillVnum = (BYTE)(((DWORD)lApplyValue) >> 24);
-			int iAdd = lApplyValue & 0x00800000;
-			int iChange = lApplyValue & 0x007fffff;
-
-			sys_log(1, "APPLY_SKILL skill %d add? %d change %d", bSkillVnum, iAdd ? 1 : 0, iChange);
-
-			if (0 == iAdd)
-				iChange = -iChange;
-
-			auto iter = m_SkillDamageBonus.find(bSkillVnum);
-			if (iter == m_SkillDamageBonus.end())
-				m_SkillDamageBonus.insert(std::make_pair(bSkillVnum, iChange));
-			else
-				iter->second += iChange;
-		}
-		// END_OF_SKILL_DAMAGE_BONUS
-		break;
-
-		case APPLY_BOW_DISTANCE:				// 52
-		case APPLY_ATT_GRADE_BONUS:				// 53
-		case APPLY_DEF_GRADE_BONUS:				// 54
-		case APPLY_MAGIC_ATT_GRADE:				// 55
-		case APPLY_MAGIC_DEF_GRADE:				// 56
-		case APPLY_CURSE_PCT:					// 57
-		case APPLY_MAX_STAMINA:					// 58
-
-		case APPLY_ATTBONUS_WARRIOR:			// 59
-		case APPLY_ATTBONUS_ASSASSIN:			// 60
-		case APPLY_ATTBONUS_SURA:				// 61
-		case APPLY_ATTBONUS_SHAMAN:				// 62
-		case APPLY_ATTBONUS_MONSTER:			// 63
-
-		case APPLY_MALL_ATTBONUS:				// 64
-		case APPLY_MALL_DEFBONUS:				// 65
-		case APPLY_MALL_EXPBONUS:				// 66 
-		case APPLY_MALL_ITEMBONUS:				// 67
-		case APPLY_MALL_GOLDBONUS:				// 68
-			PointChange(aApplyInfo[wApplyType].wPointType, lApplyValue);
-			break;
-
-		case APPLY_MAX_HP_PCT:					// 69
-		{
-			if (GetMaxHP() == 0) break;
-			PointChange(aApplyInfo[wApplyType].wPointType, lApplyValue);
-		}
-		break;
-		case APPLY_MAX_SP_PCT:					// 70
-		{
-			if (GetMaxSP() == 0) break;
-			PointChange(aApplyInfo[wApplyType].wPointType, lApplyValue);
-		}
-		break;
-
-		case APPLY_SKILL_DAMAGE_BONUS:			// 71
-		case APPLY_NORMAL_HIT_DAMAGE_BONUS:		// 72
-
-			// DEPEND_BONUS_ATTRIBUTES
-		case APPLY_SKILL_DEFEND_BONUS:			// 73
-		case APPLY_NORMAL_HIT_DEFEND_BONUS:		// 74
-			// END_OF_DEPEND_BONUS_ATTRIBUTES
-
-		case APPLY_PC_BANG_EXP_BONUS:			// 75
-		case APPLY_PC_BANG_DROP_BONUS:			// 76
-
-			//case APPLY_EXTRACT_HP_PCT:			// 77  HP Ҹ
-
-		case APPLY_RESIST_WARRIOR:				// 78
-		case APPLY_RESIST_ASSASSIN:				// 79
-		case APPLY_RESIST_SURA:					// 80
-		case APPLY_RESIST_SHAMAN:				// 81
-
-		case APPLY_ENERGY:						// 82 
-		case APPLY_DEF_GRADE:					// 83 . DEF_GRADE_BONUS Ŭ󿡼 ι  ǵ (...) ִ.
-		case APPLY_COSTUME_ATTR_BONUS:			// 84 ڽƬ ۿ  Ӽġ ʽ
-		case APPLY_MAGIC_ATTBONUS_PER:			// 85  ݷ +x%
-		case APPLY_MELEE_MAGIC_ATTBONUS_PER:	// 86  + и ݷ +x%
-
-		case APPLY_RESIST_ICE:					// 87 ñ 
-		case APPLY_RESIST_EARTH:				// 88  
-		case APPLY_RESIST_DARK:					// 89  
-
-		case APPLY_ANTI_CRITICAL_PCT:			// 90 ũƼ 
-		case APPLY_ANTI_PENETRATE_PCT:			// 91 Ÿ 
-
-		case APPLY_BLEEDING_REDUCE:				// 92
-		case APPLY_BLEEDING_PCT:				// 93
-		case APPLY_ATTBONUS_WOLFMAN:			// 94
-		case APPLY_RESIST_WOLFMAN:				// 95
-		case APPLY_RESIST_CLAW:					// 96
-
-		case APPLY_ACCEDRAIN_RATE:
-		case APPLY_RESIST_MAGIC_REDUCTION:
-
-		case APPLY_ENCHANT_ELECT:
-		case APPLY_ENCHANT_FIRE:
-		case APPLY_ENCHANT_ICE:
-		case APPLY_ENCHANT_WIND:
-		case APPLY_ENCHANT_EARTH:
-		case APPLY_ENCHANT_DARK:
-
-		case APPLY_ATTBONUS_CZ:
-		case APPLY_ATTBONUS_INSECT:
-		case APPLY_ATTBONUS_DESERT:
-		case APPLY_ATTBONUS_SWORD:
-		case APPLY_ATTBONUS_TWOHAND:
-		case APPLY_ATTBONUS_DAGGER:
-		case APPLY_ATTBONUS_BELL:
-		case APPLY_ATTBONUS_FAN:
-		case APPLY_ATTBONUS_BOW:
-		case APPLY_ATTBONUS_CLAW:
-
-		case APPLY_RESIST_HUMAN:
-		case APPLY_RESIST_MOUNT_FALL:
-		case APPLY_RESIST_FIST:
-
-		case APPLY_MOUNT:
-
-		case APPLY_SKILL_DAMAGE_SAMYEON:
-		case APPLY_SKILL_DAMAGE_TANHWAN:
-		case APPLY_SKILL_DAMAGE_PALBANG:
-		case APPLY_SKILL_DAMAGE_GIGONGCHAM:
-		case APPLY_SKILL_DAMAGE_GYOKSAN:
-		case APPLY_SKILL_DAMAGE_GEOMPUNG:
-		case APPLY_SKILL_DAMAGE_AMSEOP:
-		case APPLY_SKILL_DAMAGE_GUNGSIN:
-		case APPLY_SKILL_DAMAGE_CHARYUN:
-		case APPLY_SKILL_DAMAGE_SANGONG:
-		case APPLY_SKILL_DAMAGE_YEONSA:
-		case APPLY_SKILL_DAMAGE_KWANKYEOK:
-		case APPLY_SKILL_DAMAGE_GIGUNG:
-		case APPLY_SKILL_DAMAGE_HWAJO:
-		case APPLY_SKILL_DAMAGE_SWAERYUNG:
-		case APPLY_SKILL_DAMAGE_YONGKWON:
-		case APPLY_SKILL_DAMAGE_PABEOB:
-		case APPLY_SKILL_DAMAGE_MARYUNG:
-		case APPLY_SKILL_DAMAGE_HWAYEOMPOK:
-		case APPLY_SKILL_DAMAGE_MAHWAN:
-		case APPLY_SKILL_DAMAGE_BIPABU:
-		case APPLY_SKILL_DAMAGE_YONGBI:
-		case APPLY_SKILL_DAMAGE_PAERYONG:
-		case APPLY_SKILL_DAMAGE_NOEJEON:
-		case APPLY_SKILL_DAMAGE_BYEURAK:
-		case APPLY_SKILL_DAMAGE_CHAIN:
-		case APPLY_SKILL_DAMAGE_CHAYEOL:
-		case APPLY_SKILL_DAMAGE_SALPOONG:
-		case APPLY_SKILL_DAMAGE_GONGDAB:
-		case APPLY_SKILL_DAMAGE_PASWAE:
-
-		case APPLY_NORMAL_HIT_DEFEND_BONUS_BOSS_OR_MORE:
-		case APPLY_SKILL_DEFEND_BONUS_BOSS_OR_MORE:
-		case APPLY_NORMAL_HIT_DAMAGE_BONUS_BOSS_OR_MORE:
-		case APPLY_SKILL_DAMAGE_BONUS_BOSS_OR_MORE:
-
-		case APPLY_HIT_BUFF_ENCHANT_FIRE:
-		case APPLY_HIT_BUFF_ENCHANT_ICE:
-		case APPLY_HIT_BUFF_ENCHANT_ELEC:
-		case APPLY_HIT_BUFF_ENCHANT_WIND:
-		case APPLY_HIT_BUFF_ENCHANT_DARK:
-		case APPLY_HIT_BUFF_ENCHANT_EARTH:
-		case APPLY_HIT_BUFF_RESIST_FIRE:
-		case APPLY_HIT_BUFF_RESIST_ICE:
-		case APPLY_HIT_BUFF_RESIST_ELEC:
-		case APPLY_HIT_BUFF_RESIST_WIND:
-		case APPLY_HIT_BUFF_RESIST_DARK:
-		case APPLY_HIT_BUFF_RESIST_EARTH:
-
-		case APPLY_USE_SKILL_CHEONGRANG_MOV_SPEED:
-		case APPLY_USE_SKILL_CHEONGRANG_CASTING_SPEED:
-		case APPLY_USE_SKILL_CHAYEOL_CRITICAL_PCT:
-		case APPLY_USE_SKILL_SANGONG_ATT_GRADE_BONUS:
-		case APPLY_USE_SKILL_GIGUNG_ATT_GRADE_BONUS:
-		case APPLY_USE_SKILL_JEOKRANG_DEF_BONUS:
-		case APPLY_USE_SKILL_GWIGEOM_DEF_BONUS:
-		case APPLY_USE_SKILL_TERROR_ATT_GRADE_BONUS:
-		case APPLY_USE_SKILL_MUYEONG_ATT_GRADE_BONUS:
-		case APPLY_USE_SKILL_MANASHILED_CASTING_SPEED:
-		case APPLY_USE_SKILL_HOSIN_DEF_BONUS:
-		case APPLY_USE_SKILL_GICHEON_ATT_GRADE_BONUS:
-		case APPLY_USE_SKILL_JEONGEOP_ATT_GRADE_BONUS:
-		case APPLY_USE_SKILL_JEUNGRYEOK_DEF_BONUS:
-		case APPLY_USE_SKILL_GIHYEOL_ATT_GRADE_BONUS:
-		case APPLY_USE_SKILL_CHUNKEON_CASTING_SPEED:
-		case APPLY_USE_SKILL_NOEGEOM_ATT_GRADE_BONUS:
-
-		case APPLY_SKILL_DURATION_INCREASE_EUNHYUNG:
-		case APPLY_SKILL_DURATION_INCREASE_GYEONGGONG:
-		case APPLY_SKILL_DURATION_INCREASE_GEOMKYUNG:
-		case APPLY_SKILL_DURATION_INCREASE_JEOKRANG:
-
-		case APPLY_USE_SKILL_PALBANG_HP_ABSORB:
-		case APPLY_USE_SKILL_AMSEOP_HP_ABSORB:
-		case APPLY_USE_SKILL_YEONSA_HP_ABSORB:
-		case APPLY_USE_SKILL_YONGBI_HP_ABSORB:
-		case APPLY_USE_SKILL_CHAIN_HP_ABSORB:
-		case APPLY_USE_SKILL_PASWAE_SP_ABSORB:
-		case APPLY_USE_SKILL_GIGONGCHAM_STUN:
-		case APPLY_USE_SKILL_CHARYUN_STUN:
-		case APPLY_USE_SKILL_PABEOB_STUN:
-		case APPLY_USE_SKILL_MAHWAN_STUN:
-		case APPLY_USE_SKILL_GONGDAB_STUN:
-		case APPLY_USE_SKILL_SAMYEON_STUN:
-		case APPLY_USE_SKILL_GYOKSAN_KNOCKBACK:
-		case APPLY_USE_SKILL_SEOMJEON_KNOCKBACK:
-		case APPLY_USE_SKILL_SWAERYUNG_KNOCKBACK:
-		case APPLY_USE_SKILL_HWAYEOMPOK_KNOCKBACK:
-		case APPLY_USE_SKILL_GONGDAB_KNOCKBACK:
-		case APPLY_USE_SKILL_KWANKYEOK_KNOCKBACK:
-		case APPLY_USE_SKILL_SAMYEON_NEXT_COOLTIME_DECREASE_10PER:
-		case APPLY_USE_SKILL_GEOMPUNG_NEXT_COOLTIME_DECREASE_10PER:
-		case APPLY_USE_SKILL_GUNGSIN_NEXT_COOLTIME_DECREASE_10PER:
-		case APPLY_USE_SKILL_KWANKYEOK_NEXT_COOLTIME_DECREASE_10PER:
-		case APPLY_USE_SKILL_YONGKWON_NEXT_COOLTIME_DECREASE_10PER:
-		case APPLY_USE_SKILL_MARYUNG_NEXT_COOLTIME_DECREASE_10PER:
-		case APPLY_USE_SKILL_BIPABU_NEXT_COOLTIME_DECREASE_10PER:
-		case APPLY_USE_SKILL_NOEJEON_NEXT_COOLTIME_DECREASE_10PER:
-		case APPLY_USE_SKILL_SALPOONG_NEXT_COOLTIME_DECREASE_10PER:
-		case APPLY_USE_SKILL_PASWAE_NEXT_COOLTIME_DECREASE_10PER:
-
-		case APPLY_ATTBONUS_STONE:
-
-		case APPLY_DAMAGE_HP_RECOVERY:
-		case APPLY_DAMAGE_SP_RECOVERY:
-
-		case APPLY_ALIGNMENT_DAMAGE_BONUS:
-
-		case APPLY_NORMAL_DAMAGE_GUARD:
-		case APPLY_MORE_THEN_HP90_DAMAGE_REDUCE:
-
-		case APPLY_USE_SKILL_TUSOK_HP_ABSORB:
-		case APPLY_USE_SKILL_PAERYONG_HP_ABSORB:
-		case APPLY_USE_SKILL_BYEURAK_HP_ABSORB:
-
-		case APPLY_FIRST_ATTRIBUTE_BONUS:
-		case APPLY_SECOND_ATTRIBUTE_BONUS:
-		case APPLY_THIRD_ATTRIBUTE_BONUS:
-		case APPLY_FOURTH_ATTRIBUTE_BONUS:
-		case APPLY_FIFTH_ATTRIBUTE_BONUS:
-
-		case APPLY_USE_SKILL_SAMYEON_NEXT_COOLTIME_DECREASE_20PER:
-		case APPLY_USE_SKILL_GEOMPUNG_NEXT_COOLTIME_DECREASE_20PER:
-		case APPLY_USE_SKILL_GUNGSIN_NEXT_COOLTIME_DECREASE_20PER:
-		case APPLY_USE_SKILL_KWANKYEOK_NEXT_COOLTIME_DECREASE_20PER:
-		case APPLY_USE_SKILL_YONGKWON_NEXT_COOLTIME_DECREASE_20PER:
-		case APPLY_USE_SKILL_MARYUNG_NEXT_COOLTIME_DECREASE_20PER:
-		case APPLY_USE_SKILL_BIPABU_NEXT_COOLTIME_DECREASE_20PER:
-		case APPLY_USE_SKILL_NOEJEON_NEXT_COOLTIME_DECREASE_20PER:
-		case APPLY_USE_SKILL_SALPOONG_NEXT_COOLTIME_DECREASE_20PER:
-		case APPLY_USE_SKILL_PASWAE_NEXT_COOLTIME_DECREASE_20PER:
-		case APPLY_USE_SKILL_CHAYEOL_HP_ABSORB:
-
-		case APPLY_SUNGMA_STR:
-		case APPLY_SUNGMA_HP:
-		case APPLY_SUNGMA_MOVE:
-		case APPLY_SUNGMA_IMMUNE:
-
-		case APPLY_HIT_PCT:
-			PointChange(aApplyInfo[wApplyType].wPointType, lApplyValue);
-			break;
-
-#if defined(__ITEM_APPLY_RANDOM__)
-		case APPLY_RANDOM:
-			break;
-#endif
-
-		case APPLY_ATTBONUS_PER_HUMAN:
-		case APPLY_ATTBONUS_PER_ANIMAL:
-		case APPLY_ATTBONUS_PER_ORC:
-		case APPLY_ATTBONUS_PER_MILGYO:
-		case APPLY_ATTBONUS_PER_UNDEAD:
-		case APPLY_ATTBONUS_PER_DEVIL:
-
-		case APPLY_ENCHANT_PER_ELECT:
-		case APPLY_ENCHANT_PER_FIRE:
-		case APPLY_ENCHANT_PER_ICE:
-		case APPLY_ENCHANT_PER_WIND:
-		case APPLY_ENCHANT_PER_EARTH:
-		case APPLY_ENCHANT_PER_DARK:
-
-		case APPLY_ATTBONUS_PER_CZ:
-		case APPLY_ATTBONUS_PER_INSECT:
-		case APPLY_ATTBONUS_PER_DESERT:
-		case APPLY_ATTBONUS_PER_STONE:
-		case APPLY_ATTBONUS_PER_MONSTER:
-
-		case APPLY_RESIST_PER_HUMAN:
-		case APPLY_RESIST_PER_ICE:
-		case APPLY_RESIST_PER_DARK:
-		case APPLY_RESIST_PER_EARTH:
-		case APPLY_RESIST_PER_FIRE:
-		case APPLY_RESIST_PER_ELEC:
-		case APPLY_RESIST_PER_MAGIC:
-		case APPLY_RESIST_PER_WIND:
-
-		case APPLY_HIT_BUFF_SUNGMA_STR:
-		case APPLY_HIT_BUFF_SUNGMA_MOVE:
-		case APPLY_HIT_BUFF_SUNGMA_HP:
-		case APPLY_HIT_BUFF_SUNGMA_IMMUNE:
-
-		case APPLY_MOUNT_MELEE_MAGIC_ATTBONUS_PER:
-		case APPLY_DISMOUNT_MOVE_SPEED_BONUS_PER:
-
-		case APPLY_HIT_AUTO_HP_RECOVERY:
-		case APPLY_HIT_AUTO_SP_RECOVERY:
-
-		case APPLY_USE_SKILL_COOLTIME_DECREASE_ALL:
-
-		case APPLY_HIT_STONE_ATTBONUS_STONE:
-		case APPLY_HIT_STONE_DEF_GRADE_BONUS:
-
-		case APPLY_KILL_BOSS_ITEM_BONUS:
-		case APPLY_MOB_HIT_MOB_AGGRESSIVE:
-		case APPLY_NO_DEATH_AND_HP_RECOVERY30:
-
-		case APPLY_AUTO_PICKUP:
-		case APPLY_MOUNT_NO_KNOCKBACK:
-
-		case APPLY_SUNGMA_PER_STR:
-		case APPLY_SUNGMA_PER_HP:
-		case APPLY_SUNGMA_PER_MOVE:
-		case APPLY_SUNGMA_PER_IMMUNE:
-
-		case APPLY_IMMUNE_POISON100:
-		case APPLY_IMMUNE_BLEEDING100:
-
-		case APPLY_MONSTER_DEFEND_BONUS:
-			PointChange(aApplyInfo[wApplyType].wPointType, lApplyValue);
-			break;
-
-		default:
-			sys_err("Unknown apply type %u name %s", wApplyType, GetName());
-			break;
-	}
-}
-
-void CHARACTER::MotionPacketEncode(BYTE motion, LPCHARACTER victim, struct packet_motion* packet)
-{
-	packet->header = HEADER_GC_MOTION;
-	packet->vid = m_vid;
-	packet->motion = motion;
-
-	if (victim)
-		packet->victim_vid = victim->GetVID();
-	else
-		packet->victim_vid = 0;
-}
-
-void CHARACTER::Motion(BYTE motion, LPCHARACTER victim)
-{
-	struct packet_motion pack_motion;
-	MotionPacketEncode(motion, victim, &pack_motion);
-	PacketAround(&pack_motion, sizeof(struct packet_motion));
-}
-
-EVENTFUNC(save_event)
-{
-	char_event_info* info = dynamic_cast<char_event_info*>(event->info);
-	if (info == NULL)
-	{
-		sys_err("save_event> <Factor> Null pointer");
-		return 0;
-	}
-
-	LPCHARACTER ch = info->ch;
-
-	if (ch == NULL) // <Factor>
-		return 0;
-
-	sys_log(1, "SAVE_EVENT: %s", ch->GetName());
-	ch->Save();
-	ch->FlushDelayedSaveItem();
-	return (save_event_second_cycle);
-}
-
-void CHARACTER::StartSaveEvent()
-{
-	if (m_pkSaveEvent)
-		return;
-
-	char_event_info* info = AllocEventInfo<char_event_info>();
-
-	info->ch = this;
-	m_pkSaveEvent = event_create(save_event, info, save_event_second_cycle);
-}
-
-void CHARACTER::MonsterLog(const char* format, ...)
-{
-	if (!test_server)
-		return;
-
-	if (IsPC())
-		return;
-
-	char chatbuf[CHAT_MAX_LEN + 1];
-	int len = snprintf(chatbuf, sizeof(chatbuf), "%u)", (DWORD)GetVID());
-
-	if (len < 0 || len >= (int)sizeof(chatbuf))
-		len = sizeof(chatbuf) - 1;
-
-	va_list args;
-
-	va_start(args, format);
-
-	int len2 = vsnprintf(chatbuf + len, sizeof(chatbuf) - len, format, args);
-
-	if (len2 < 0 || len2 >= (int)sizeof(chatbuf) - len)
-		len += (sizeof(chatbuf) - len) - 1;
-	else
-		len += len2;
-
-	// \0  
-	++len;
-
-	va_end(args);
-
-	TPacketGCChat pack_chat;
-
-	pack_chat.header = HEADER_GC_CHAT;
-	pack_chat.size = sizeof(TPacketGCChat) + len;
-	pack_chat.type = CHAT_TYPE_TALKING;
-	pack_chat.id = (DWORD)GetVID();
-	pack_chat.bEmpire = 0;
-
-	TEMP_BUFFER buf;
-	buf.write(&pack_chat, sizeof(TPacketGCChat));
-	buf.write(chatbuf, len);
-
-	CHARACTER_MANAGER::instance().PacketMonsterLog(this, buf.read_peek(), buf.size());
-}
-
-void CHARACTER::ChatPacket(BYTE type, const char* format, ...)
-{
-	LPDESC d = GetDesc();
-
-	if (!d || !format)
-		return;
-
-	char chatbuf[CHAT_MAX_LEN + 1];
-	va_list args;
-
-	va_start(args, format);
-	int len = vsnprintf(chatbuf, sizeof(chatbuf), format, args);
-	va_end(args);
-
-	struct packet_chat pack_chat;
-
-	pack_chat.header = HEADER_GC_CHAT;
-	pack_chat.size = sizeof(struct packet_chat) + len;
-	pack_chat.type = type;
-	pack_chat.id = 0;
-	pack_chat.bEmpire = d->GetEmpire();
-
-	TEMP_BUFFER buf;
-	buf.write(&pack_chat, sizeof(struct packet_chat));
-	buf.write(chatbuf, len);
-
-	d->Packet(buf.read_peek(), buf.size());
-
-	if (type == CHAT_TYPE_COMMAND && test_server)
-		sys_log(0, "SEND_COMMAND %s %s", GetName(), chatbuf);
-}
-
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-void CHARACTER::ChatPacket(packet_chat pack_chat, const char* format, ...)
-{
-	LPDESC d = GetDesc();
-
-	if (!d || !format)
-		return;
-
-	char chatbuf[CHAT_MAX_LEN + 1];
-	va_list args;
-
-	va_start(args, format);
-	int len = vsnprintf(chatbuf, sizeof(chatbuf), format, args);
-	va_end(args);
-
-	pack_chat.header = HEADER_GC_CHAT;
-	pack_chat.size = sizeof(struct packet_chat) + len;
-	pack_chat.id = 0;
-	pack_chat.bEmpire = d->GetEmpire();
-
-	TEMP_BUFFER buf;
-	buf.write(&pack_chat, sizeof(struct packet_chat));
-	buf.write(chatbuf, len);
-
-	d->Packet(buf.read_peek(), buf.size());
-}
-#endif
-
-// MINING
-void CHARACTER::mining_take()
-{
-	m_pkMiningEvent = NULL;
-}
-
-void CHARACTER::mining_cancel()
-{
-	if (m_pkMiningEvent)
-	{
-		sys_log(0, "XXX MINING CANCEL");
-		event_cancel(&m_pkMiningEvent);
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("ä ߴϿϴ."));
-	}
-}
-
-void CHARACTER::mining(LPCHARACTER chLoad)
-{
-	if (m_pkMiningEvent)
-	{
-		mining_cancel();
-		return;
-	}
-
-	if (!chLoad)
-		return;
-
-	if (IsRiding())
-		return;
-
-	if (GetMapIndex() != chLoad->GetMapIndex() || DISTANCE_APPROX(GetX() - chLoad->GetX(), GetY() - chLoad->GetY()) > 1000)
-		return;
-
-	if (mining::GetRawOreFromLoad(chLoad->GetRaceNum()) == 0)
-		return;
-
-	LPITEM pick = GetWear(WEAR_WEAPON);
-
-	if (!pick || pick->GetType() != ITEM_PICK)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("̸ ϼ."));
-		return;
-	}
-
-	int count = number(5, 15); //  Ƚ,  ۴ 2
-
-	// ä  
-	TPacketGCDigMotion p;
-	p.header = HEADER_GC_DIG_MOTION;
-	p.vid = GetVID();
-	p.target_vid = chLoad->GetVID();
-	p.count = count;
-
-	PacketAround(&p, sizeof(p));
-
-	m_pkMiningEvent = mining::CreateMiningEvent(this, chLoad, count);
-}
-// END_OF_MINING
-
-void CHARACTER::fishing()
-{
-	if (PreventTradeWindow(WND_ALL))
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot fish while other windows are open."));
-		return;
-	}
-
-	if (m_pkFishingEvent)
-	{
-		fishing_take();
-		return;
-	}
-
-	//  Ӽ ø õѴ?
-	{
-		LPSECTREE_MAP pkSectreeMap = SECTREE_MANAGER::instance().GetMap(GetMapIndex());
-
-		int x = GetX();
-		int y = GetY();
-
-		LPSECTREE tree = pkSectreeMap->Find(x, y);
-		DWORD dwAttr = tree->GetAttribute(x, y);
-
-		if (IS_SET(dwAttr, ATTR_BLOCK))
-		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("ø   ִ  ƴմϴ"));
-			return;
-		}
-	}
-
-#ifdef __GROWTH_PET_SYSTEM__
-/*
-	if (GetActiveGrowthPet())
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot fish while your pet is summoned."));
-		return;
-	}
-*/
-
-	if (IsPetHatchWindowOpen())
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("PET_VARKEN_BALIK_TUTAMAZSIN"));
-		return;
-	}
-
-	if (IsPetChangeNameWindowOpen())
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("PET_BONUS_PENCERESI_ACIKKEN_BALIK_TUTAMAZSIN"));
-		return;
-	}
-#endif
-
-	LPITEM rod = GetWear(WEAR_WEAPON);
-
-	// ô 
-	if (!rod || rod->GetType() != ITEM_ROD)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("ô븦  ϼ."));
-		return;
-	}
-
-	if (0 == rod->GetSocket(2))
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("̳   ּ."));
-		return;
-	}
-
-	if (GetEmptyInventory(1) == -1)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("Make sure you have enough space in your inventory before you go fishing."));
-		return;
-	}
-
-	float fx, fy;
-	GetDeltaByDegree(GetRotation(), 400.0f, &fx, &fy);
-
-#if defined(__FISHING_GAME__)
-	SetFishingGameGoals(0);
-#endif
-
-	m_pkFishingEvent = fishing::CreateFishingEvent(this);
-}
-
-void CHARACTER::fishing_take()
-{
-	LPITEM rod = GetWear(WEAR_WEAPON);
-	if (rod && rod->GetType() == ITEM_ROD)
-	{
-		using fishing::fishing_event_info;
-		if (m_pkFishingEvent)
-		{
-			struct fishing_event_info* info = dynamic_cast<struct fishing_event_info*>(m_pkFishingEvent->info);
-
-			if (info)
-				fishing::Take(info, this);
-		}
-	}
-	else
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("ô밡 ƴ  ø   ϴ!"));
-	}
-
-	event_cancel(&m_pkFishingEvent);
-}
-
-bool CHARACTER::StartStateMachine(int iNextPulse)
-{
-	if (CHARACTER_MANAGER::instance().AddToStateList(this))
-	{
-		m_dwNextStatePulse = thecore_heart->pulse + iNextPulse;
-		return true;
-	}
-
-	return false;
-}
-
-void CHARACTER::StopStateMachine()
-{
-	CHARACTER_MANAGER::instance().RemoveFromStateList(this);
-}
-
-void CHARACTER::UpdateStateMachine(DWORD dwPulse)
-{
-	if (dwPulse < m_dwNextStatePulse)
-		return;
-
-	if (IsDead())
-		return;
-
-	Update();
-	m_dwNextStatePulse = dwPulse + m_dwStateDuration;
-}
-
-void CHARACTER::SetNextStatePulse(int iNextPulse)
-{
-	CHARACTER_MANAGER::instance().AddToStateList(this);
-	m_dwNextStatePulse = iNextPulse;
-
-	if (iNextPulse < 10)
-		MonsterLog("·ξ");
-}
-
-// ĳ νϽ Ʈ Լ.
-void CHARACTER::UpdateCharacter(DWORD dwPulse)
-{
-	CFSM::Update();
-}
-
-void CHARACTER::SetShop(LPSHOP pkShop)
-{
-	if ((m_pkShop = pkShop))
-		SET_BIT(m_pointsInstant.instant_flag, INSTANT_FLAG_SHOP);
-	else
-	{
-		REMOVE_BIT(m_pointsInstant.instant_flag, INSTANT_FLAG_SHOP);
-		SetShopOwner(NULL);
-	}
-}
-
-void CHARACTER::SetExchange(CExchange* pkExchange)
-{
-	m_pkExchange = pkExchange;
-}
-
-void CHARACTER::SetPart(BYTE bPartPos, DWORD dwVal)
-{
-	assert(bPartPos < PART_MAX_NUM);
-	m_pointsInstant.adwParts[bPartPos] = dwVal;
-}
-
-DWORD CHARACTER::GetPart(BYTE bPartPos) const
-{
+
+			if (test_server)
+				ChatPacket(CHAT_TYPE_INFO, "You have gained %d exp.", amount);
+
+			DWORD iExpBalance = 0;
+
+			//  !
+			if (exp + amount >= next_exp)
+			{
+				iExpBalance = (exp + amount) - next_exp;
+				amount = next_exp - exp;
+
+				SetConquerorExp(0);
+				exp = next_exp;
+			}
+			else
+			{
+				SetConquerorExp(exp + amount);
+				exp = GetConquerorExp();
+			}
+
+			DWORD q = DWORD(next_exp / 4.0f);
+			int iLevStep = GetRealPoint(POINT_CONQUEROR_LEVEL_STEP);
+
+			// iLevStep 4 ̸̻  ö ϹǷ ⿡    ̴.
+			if (iLevStep >= 4)
+			{
+				sys_err("%s CONQUEROR_LEVEL_STEP bigger than 4! (%d)", GetName(), iLevStep);
+				iLevStep = 4;
+			}
+
+			if (exp >= next_exp && iLevStep < 4)
+			{
+				for (int i = 0; i < 4 - iLevStep; ++i)
+					PointChange(POINT_CONQUEROR_LEVEL_STEP, 1, false, true);
+			}
+			else if (exp >= q * 3 && iLevStep < 3)
+			{
+				for (int i = 0; i < 3 - iLevStep; ++i)
+					PointChange(POINT_CONQUEROR_LEVEL_STEP, 1, false, true);
+			}
+			else if (exp >= q * 2 && iLevStep < 2)
+			{
+				for (int i = 0; i < 2 - iLevStep; ++i)
+					PointChange(POINT_CONQUEROR_LEVEL_STEP, 1, false, true);
+			}
+			else if (exp >= q && iLevStep < 1)
+				PointChange(POINT_CONQUEROR_LEVEL_STEP, 1);
+
+			if (iExpBalance)
+			{
+				PointChange(POINT_CONQUEROR_EXP, iExpBalance);
+			}
+
+			val = GetConquerorExp();
+		}
+	} break;
+
+	case POINT_CONQUEROR_LEVEL_STEP:
+	{
+		if (amount > 0)
+		{
+			val = GetPoint(POINT_CONQUEROR_LEVEL_STEP) + amount;
+			switch (val)
+			{
+			case 1:
+			case 2:
+			case 3:
+			{
+				if ((GetConquerorLevel() <= gPlayerMaxLevelStats) && (GetConquerorLevel() <= gPlayerMaxConquerorLevel))
+					PointChange(POINT_CONQUEROR_POINT, 1);
+			} break;
+			case 4:
+			{
+				PointChange(POINT_CONQUEROR_LEVEL, 1, false, true);
+				val = 0;
+			} break;
+			}
+
+			SetPoint(POINT_CONQUEROR_LEVEL_STEP, val);
+			SetRealPoint(POINT_CONQUEROR_LEVEL_STEP, val);
+
+			Save();
+		}
+		else
+			val = GetPoint(POINT_CONQUEROR_LEVEL_STEP);
+	} break;
+
+	case POINT_SUNGMA_STR:
+	case POINT_SUNGMA_HP:
+	case POINT_SUNGMA_MOVE:
+	case POINT_SUNGMA_IMMUNE:
+	{
+		SetPoint(type, GetPoint(type) + amount);
+		val = GetPoint(type);
+	} break;
+
+	case POINT_CONQUEROR_POINT:
+	{
+		SetPoint(type, GetPoint(type) + amount);
+		val = GetPoint(type);
+
+		SetRealPoint(type, val);
+	} break;
+#endif
+
+	case POINT_LEVEL:
+	{
+		if ((GetLevel() + amount) > gPlayerMaxLevel)
+			return;
+
+		SetLevel(GetLevel() + amount);
+		val = GetLevel();
+
+		sys_log(0, "LEVELUP: %s %d NEXT EXP %d", GetName(), GetLevel(), GetNextExp());
+
+		// WOLFMAN  Ưó (  ϳ̹Ƿ, 5 Ǹ  1  . ϵڵ )
+		if (GetJob() == JOB_WOLFMAN)
+		{
+			if ((5 <= val) && (GetSkillGroup() != 1))
+			{
+				ClearSkill();
+				SetSkillGroup(1);
+				SetRealPoint(POINT_SKILL, GetLevel() - 1);
+				SetPoint(POINT_SKILL, GetRealPoint(POINT_SKILL));
+				PointChange(POINT_SKILL, 0);
+			}
+		}
+
+#if defined(__CONQUEROR_LEVEL__)
+		if ((GetConquerorLevel() > 0) && (val < gPlayerMaxLevel))
+			SetConqueror(false);
+#endif
+
+		PointChange(POINT_NEXT_EXP, GetNextExp(), false);
+
+		if (amount)
+		{
+			quest::CQuestManager::instance().LevelUp(GetPlayerID());
+
+			LogManager::instance().LevelLog(this, val, GetRealPoint(POINT_PLAYTIME) + (get_dword_time() - m_dwPlayStartTime) / 60000);
+
+			if (GetGuild())
+				GetGuild()->LevelChange(GetPlayerID(), GetLevel());
+
+			if (GetParty())
+				GetParty()->RequestSetMemberLevel(GetPlayerID(), GetLevel());
+		}
+
+		PointsPacket();
+	} break;
+
+	case POINT_NEXT_EXP:
+	{
+		val = GetNextExp();
+		bAmount = false; //  bAmount false  Ѵ.
+	} break;
+
+	case POINT_EXP:
+	{
+#if defined(__ANTI_EXP_RING__)
+		if (HasFrozenEXP())
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You have frozen your experience."));
+			return;
+		}
+#endif
+
+		DWORD exp = GetExp();
+		DWORD next_exp = GetNextExp();
+
+		// exp 0 Ϸ  ʵ Ѵ
+		if (amount < 0 && exp <= -amount)
+		{
+			sys_log(0, "%s - Reduce EXP by %d, CUR EXP: %d (setting to zero)", GetName(), -amount, exp);
+			amount = -(long)exp;
+
+			SetExp(0);
+			val = GetExp();
+		}
+		else
+		{
+#if defined(__CONQUEROR_LEVEL__)
+			DWORD conqueror_exp = next_exp / 4;
+			if (GetLevel() >= gPlayerMaxLevel && exp >= conqueror_exp)
+				return;
+#else
+			if (gPlayerMaxLevel <= GetLevel())
+				return;
+#endif
+
+			if (test_server)
+				ChatPacket(CHAT_TYPE_INFO, "You have gained %d exp.", amount);
+
+			DWORD iExpBalance = 0;
+
+			//  !
+			if (exp + amount >= next_exp)
+			{
+				iExpBalance = (exp + amount) - next_exp;
+				amount = next_exp - exp;
+
+				SetExp(0);
+				exp = next_exp;
+			}
+#if defined(__CONQUEROR_LEVEL__)
+			else if (GetLevel() >= gPlayerMaxLevel)
+			{
+				if (exp + amount >= conqueror_exp)
+				{
+					SetExp(conqueror_exp);
+					exp = GetExp();
+				}
+				else
+				{
+					SetExp(exp + amount);
+					exp = GetExp();
+				}
+			}
+#endif
+			else
+			{
+				SetExp(exp + amount);
+				exp = GetExp();
+			}
+
+			DWORD q = DWORD(next_exp / 4.0f);
+			int iLevStep = GetRealPoint(POINT_LEVEL_STEP);
+
+			// iLevStep 4 ̸̻  ö ϹǷ ⿡    ̴.
+			if (iLevStep >= 4)
+			{
+				sys_err("%s LEVEL_STEP bigger than 4! (%d)", GetName(), iLevStep);
+				iLevStep = 4;
+			}
+
+			if (exp >= next_exp && iLevStep < 4)
+			{
+				for (int i = 0; i < 4 - iLevStep; ++i)
+					PointChange(POINT_LEVEL_STEP, 1, false, true);
+			}
+			else if (exp >= q * 3 && iLevStep < 3)
+			{
+				for (int i = 0; i < 3 - iLevStep; ++i)
+					PointChange(POINT_LEVEL_STEP, 1, false, true);
+			}
+			else if (exp >= q * 2 && iLevStep < 2)
+			{
+				for (int i = 0; i < 2 - iLevStep; ++i)
+					PointChange(POINT_LEVEL_STEP, 1, false, true);
+			}
+			else if (exp >= q && iLevStep < 1)
+			{
+				PointChange(POINT_LEVEL_STEP, 1);
+			}
+
+			if (iExpBalance)
+			{
+				PointChange(POINT_EXP, iExpBalance);
+			}
+
+			val = GetExp();
+		}
+	}
+	break;
+
+	case POINT_LEVEL_STEP:
+	{
+		if (amount > 0)
+		{
+			val = GetPoint(POINT_LEVEL_STEP) + amount;
+
+			switch (val)
+			{
+			case 1:
+			case 2:
+			case 3:
+				if ((GetLevel() <= gPlayerMaxLevelStats) && (GetLevel() <= gPlayerMaxLevel))
+					PointChange(POINT_STAT, 1);
+				break;
+
+			case 4:
+			{
+				int iHP = number(JobInitialPoints[GetJob()].hp_per_lv_begin, JobInitialPoints[GetJob()].hp_per_lv_end);
+				int iSP = number(JobInitialPoints[GetJob()].sp_per_lv_begin, JobInitialPoints[GetJob()].sp_per_lv_end);
+
+				m_points.iRandomHP += iHP;
+				m_points.iRandomSP += iSP;
+
+				if (GetSkillGroup())
+				{
+					if (GetLevel() >= 5)
+						PointChange(POINT_SKILL, 1);
+
+					if (GetLevel() >= 9)
+						PointChange(POINT_SUB_SKILL, 1);
+				}
+
+				PointChange(POINT_MAX_HP, iHP);
+				PointChange(POINT_MAX_SP, iSP);
+				PointChange(POINT_LEVEL, 1, false, true);
+
+				val = 0;
+			}
+			break;
+			}
+
+			if (GetLevel() <= 10)
+				AutoGiveItem(27001, 2);
+			else if (GetLevel() <= 30)
+				AutoGiveItem(27002, 2);
+			else
+			{
+				AutoGiveItem(27002, 2);
+				// AutoGiveItem(27003, 2);
+			}
+
+			PointChange(POINT_HP, GetMaxHP() - GetHP());
+			PointChange(POINT_SP, GetMaxSP() - GetSP());
+			PointChange(POINT_STAMINA, GetMaxStamina() - GetStamina());
+
+			SetPoint(POINT_LEVEL_STEP, val);
+			SetRealPoint(POINT_LEVEL_STEP, val);
+
+			Save();
+		}
+		else
+			val = GetPoint(POINT_LEVEL_STEP);
+	} break;
+
+	case POINT_HP:
+	{
+		if (IsDead() || IsStun())
+			return;
+
+		int64_t prev_hp = GetHP();
+
+		amount = MIN(GetMaxHP() - GetHP(), amount);
+		SetHP(GetHP() + amount);
+		val = GetHP();
+
+		BroadcastTargetPacket();
+
+		if (GetParty() && IsPC() && val != prev_hp)
+			GetParty()->SendPartyInfoOneToAll(this);
+	}
+	break;
+
+	case POINT_SP:
+	{
+		if (IsDead() || IsStun())
+			return;
+
+		amount = MIN(GetMaxSP() - GetSP(), amount);
+		SetSP(GetSP() + amount);
+		val = GetSP();
+	}
+	break;
+
+	case POINT_STAMINA:
+	{
+		if (IsDead() || IsStun())
+			return;
+
+		int prev_val = GetStamina();
+		amount = MIN(GetMaxStamina() - GetStamina(), amount);
+		SetStamina(GetStamina() + amount);
+		val = GetStamina();
+
+		if (val == 0)
+		{
+			// Stamina  !
+			SetNowWalking(true);
+		}
+		else if (prev_val == 0)
+		{
+			//  ׹̳    
+			ResetWalking();
+		}
+
+		if (amount < 0 && val != 0) // Ҵ ʴ´.
+			return;
+	}
+	break;
+
+	case POINT_MAX_HP:
+	{
+		SetPoint(type, GetPoint(type) + amount);
+
+		//SetMaxHP(GetMaxHP() + amount);
+		// ִ  = (⺻ ִ  + ߰) * ִ%
+		int64_t curMaxHP = GetMaxHP();
+		int64_t hp = GetRealPoint(POINT_MAX_HP);
+		int64_t add_hp = MIN(3500, hp * GetPoint(POINT_MAX_HP_PCT) / 100);
+		add_hp += GetPoint(POINT_MAX_HP);
+		add_hp += GetPoint(POINT_PARTY_TANKER_BONUS);
+
+		SetMaxHP(hp + add_hp);
+
+		float fRatio = (float)GetMaxHP() / (float)curMaxHP;
+		PointChange(POINT_HP, GetHP() * fRatio - GetHP());
+
+		val = GetMaxHP();
+	}
+	break;
+
+	case POINT_MAX_SP:
+	{
+		SetPoint(type, GetPoint(type) + amount);
+
+		//SetMaxSP(GetMaxSP() + amount);
+		// ִ ŷ = (⺻ ִ ŷ + ߰) * ִŷ%
+		int curMaxSP = GetMaxSP();
+		int sp = GetRealPoint(POINT_MAX_SP);
+		int add_sp = MIN(800, sp * GetPoint(POINT_MAX_SP_PCT) / 100);
+		add_sp += GetPoint(POINT_MAX_SP);
+		add_sp += GetPoint(POINT_PARTY_SKILL_MASTER_BONUS);
+
+		SetMaxSP(sp + add_sp);
+
+		float fRatio = (float)GetMaxSP() / (float)curMaxSP;
+		PointChange(POINT_SP, GetSP() * fRatio - GetSP());
+
+		val = GetMaxSP();
+	}
+	break;
+
+	case POINT_MAX_HP_PCT:
+		SetPoint(type, GetPoint(type) + amount);
+		val = GetPoint(type);
+
+		PointChange(POINT_MAX_HP, 0);
+		break;
+
+	case POINT_MAX_SP_PCT:
+		SetPoint(type, GetPoint(type) + amount);
+		val = GetPoint(type);
+
+		PointChange(POINT_MAX_SP, 0);
+		break;
+
+	case POINT_MAX_STAMINA:
+		SetMaxStamina(GetMaxStamina() + amount);
+		val = GetMaxStamina();
+		break;
+
+	case POINT_GOLD:
+	{
+		const int64_t nTotalGold = static_cast<int64_t>(GetGold()) + static_cast<int64_t>(amount);
+
+		if (g_MaxGold <= nTotalGold)
+		{
+			sys_err("[OVERFLOW_GOLD] OriGold %lld AddedGold %lld id %u Name %s ", GetGold(), amount, GetPlayerID(), GetName());
+			LogManager::instance().CharLog(this, GetGold() + amount, "OVERFLOW_GOLD", "");
+			return;
+		}
+
+		SetGold(GetGold() + amount);
+		val = GetGold();
+	}
+	break;
+
+#if defined(__CHEQUE_SYSTEM__)
+	case POINT_CHEQUE:
+	{
+		const int64_t nTotalCheque = static_cast<int64_t>(GetCheque()) + static_cast<int64_t>(amount);
+
+		if (CHEQUE_MAX <= nTotalCheque)
+		{
+			sys_err("[OVERFLOW_CHEQUE] OriCheque %d AddedCheque %lld id %u Name %s ", GetCheque(), amount, GetPlayerID(), GetName());
+			LogManager::instance().CharLog(this, GetCheque() + amount, "OVERFLOW_CHEQUE", "");
+			return;
+		}
+
+		SetCheque(GetCheque() + amount);
+		val = GetCheque();
+	}
+	break;
+#endif
+
+#if defined(__GEM_SYSTEM__)
+	case POINT_GEM:
+	{
+		const int64_t nTotalGem = static_cast<int64_t>(GetGem()) + static_cast<int64_t>(amount);
+
+		if (GEM_MAX <= nTotalGem)
+		{
+			sys_err("[OVERFLOW_GEM] OriGem %d AddedGem %lld id %u Name %s ", GetGem(), amount, GetPlayerID(), GetName());
+			LogManager::instance().CharLog(this, GetGem() + amount, "OVERFLOW_GEM", "");
+			return;
+		}
+
+		SetGem(GetGem() + amount);
+		val = GetGem();
+	}
+	break;
+#endif
+
+	case POINT_SKILL:
+	case POINT_STAT:
+	case POINT_SUB_SKILL:
+	case POINT_STAT_RESET_COUNT:
+	case POINT_HORSE_SKILL:
+		SetPoint(type, GetPoint(type) + amount);
+		val = GetPoint(type);
+
+		SetRealPoint(type, val);
+		break;
+
+	case POINT_DEF_GRADE:
+		SetPoint(type, GetPoint(type) + amount);
+		val = GetPoint(type);
+
+		PointChange(POINT_CLIENT_DEF_GRADE, amount);
+		break;
+
+	case POINT_CLIENT_DEF_GRADE:
+		SetPoint(type, GetPoint(type) + amount);
+		val = GetPoint(type);
+		break;
+
+	case POINT_ST:
+	case POINT_HT:
+	case POINT_DX:
+	case POINT_IQ:
+	case POINT_HP_REGEN:
+	case POINT_SP_REGEN:
+	case POINT_ATT_SPEED:
+	case POINT_ATT_GRADE:
+	case POINT_MOV_SPEED:
+	case POINT_CASTING_SPEED:
+	case POINT_MAGIC_ATT_GRADE:
+	case POINT_MAGIC_DEF_GRADE:
+	case POINT_BOW_DISTANCE:
+	case POINT_HP_RECOVERY:
+	case POINT_SP_RECOVERY:
+
+	case POINT_ATTBONUS_HUMAN: // 42 ΰ 
+	case POINT_ATTBONUS_ANIMAL: // 43   % 
+	case POINT_ATTBONUS_ORC: // 44 Ϳ  % 
+	case POINT_ATTBONUS_MILGYO: // 45 б  % 
+	case POINT_ATTBONUS_UNDEAD: // 46 ü  % 
+	case POINT_ATTBONUS_DEVIL: // 47 (Ǹ)  % 
+
+	case POINT_ATTBONUS_MONSTER:
+	case POINT_ATTBONUS_SURA:
+	case POINT_ATTBONUS_ASSASSIN:
+	case POINT_ATTBONUS_WARRIOR:
+	case POINT_ATTBONUS_SHAMAN:
+	case POINT_ATTBONUS_WOLFMAN:
+
+	case POINT_POISON_PCT:
+	case POINT_BLEEDING_PCT:
+
+	case POINT_STUN_PCT:
+	case POINT_SLOW_PCT:
+
+	case POINT_BLOCK:
+	case POINT_DODGE:
+
+	case POINT_CRITICAL_PCT:
+	case POINT_RESIST_CRITICAL:
+	case POINT_PENETRATE_PCT:
+	case POINT_RESIST_PENETRATE:
+	case POINT_CURSE_PCT:
+
+	case POINT_STEAL_HP: // 48  
+	case POINT_STEAL_SP: // 49 ŷ 
+
+	case POINT_MANA_BURN_PCT: // 50  
+	case POINT_DAMAGE_SP_RECOVER: // 51 ݴ  ŷ ȸ Ȯ
+	case POINT_RESIST_NORMAL_DAMAGE:
+	case POINT_RESIST_SWORD:
+	case POINT_RESIST_TWOHAND:
+	case POINT_RESIST_DAGGER:
+	case POINT_RESIST_BELL:
+	case POINT_RESIST_FAN:
+	case POINT_RESIST_BOW:
+	case POINT_RESIST_CLAW:
+
+	case POINT_RESIST_FIRE:
+	case POINT_RESIST_ELEC:
+	case POINT_RESIST_MAGIC:
+#if defined(__MAGIC_REDUCTION__)
+	case POINT_RESIST_MAGIC_REDUCTION:
+#endif
+	case POINT_RESIST_WIND:
+	case POINT_RESIST_ICE:
+	case POINT_RESIST_EARTH:
+	case POINT_RESIST_DARK:
+	case POINT_REFLECT_MELEE: // 67  ݻ
+	case POINT_REFLECT_CURSE: // 68  ݻ
+	case POINT_POISON_REDUCE: // 69  
+	case POINT_BLEEDING_REDUCE:
+
+	case POINT_KILL_SP_RECOVER: // 70  Ҹ MP ȸ
+	case POINT_KILL_HP_RECOVERY: // 75
+	case POINT_HIT_HP_RECOVERY:
+	case POINT_HIT_SP_RECOVERY:
+	case POINT_MANASHIELD:
+	case POINT_ATT_BONUS:
+	case POINT_DEF_BONUS:
+	case POINT_SKILL_DAMAGE_BONUS:
+	case POINT_NORMAL_HIT_DAMAGE_BONUS:
+	case POINT_SKILL_DEFEND_BONUS:
+	case POINT_NORMAL_HIT_DEFEND_BONUS:
+
+#if defined(__ELEMENT_SYSTEM__)
+	case POINT_ENCHANT_ELECT:
+	case POINT_ENCHANT_FIRE:
+	case POINT_ENCHANT_ICE:
+	case POINT_ENCHANT_WIND:
+	case POINT_ENCHANT_EARTH:
+	case POINT_ENCHANT_DARK:
+	{
+		SetPoint(type, GetPoint(type) + amount);
+		val = GetPoint(type);
+		BroadcastTargetPacket();
+	} break;
+
+	case POINT_ATTBONUS_CZ:
+	case POINT_ATTBONUS_INSECT:
+	case POINT_ATTBONUS_DESERT:
+
+	case POINT_ATTBONUS_SWORD:
+	case POINT_ATTBONUS_TWOHAND:
+	case POINT_ATTBONUS_DAGGER:
+	case POINT_ATTBONUS_BELL:
+	case POINT_ATTBONUS_FAN:
+	case POINT_ATTBONUS_BOW:
+	case POINT_ATTBONUS_CLAW:
+
+	case POINT_RESIST_HUMAN:
+#endif
+	case POINT_ATTBONUS_STONE:
+		// DEPEND_BONUS_ATTRIBUTES
+		SetPoint(type, GetPoint(type) + amount);
+		val = GetPoint(type);
+		break;
+		// END_OF_DEPEND_BONUS_ATTRIBUTES
+
+	case POINT_PARTY_ATTACKER_BONUS:
+	case POINT_PARTY_TANKER_BONUS:
+	case POINT_PARTY_BUFFER_BONUS:
+	case POINT_PARTY_SKILL_MASTER_BONUS:
+	case POINT_PARTY_HASTE_BONUS:
+	case POINT_PARTY_DEFENDER_BONUS:
+
+	case POINT_RESIST_WARRIOR:
+	case POINT_RESIST_ASSASSIN:
+	case POINT_RESIST_SURA:
+	case POINT_RESIST_SHAMAN:
+	case POINT_RESIST_WOLFMAN:
+		SetPoint(type, GetPoint(type) + amount);
+		val = GetPoint(type);
+		break;
+
+	case POINT_MALL_ATTBONUS:
+	case POINT_MALL_DEFBONUS:
+	case POINT_MALL_EXPBONUS:
+	case POINT_MALL_ITEMBONUS:
+	case POINT_MALL_GOLDBONUS:
+	case POINT_MELEE_MAGIC_ATT_BONUS_PER:
+		if (GetPoint(type) + amount > 100)
+		{
+			sys_err("MALL_BONUS exceeded over 100!! point type: %d name: %s amount %lld", type, GetName(), amount);
+			amount = 100 - GetPoint(type);
+		}
+
+		SetPoint(type, GetPoint(type) + amount);
+		val = GetPoint(type);
+		break;
+
+		// PC_BANG_ITEM_ADD
+	case POINT_PC_BANG_EXP_BONUS:
+	case POINT_PC_BANG_DROP_BONUS:
+	case POINT_RAMADAN_CANDY_BONUS_EXP:
+		SetPoint(type, amount);
+		val = GetPoint(type);
+		break;
+		// END_PC_BANG_ITEM_ADD
+
+	case POINT_EXP_DOUBLE_BONUS: // 71
+	case POINT_GOLD_DOUBLE_BONUS: // 72
+	case POINT_ITEM_DROP_BONUS: // 73
+	case POINT_POTION_BONUS: // 74
+		if (GetPoint(type) + amount > 100)
+		{
+			sys_err("BONUS exceeded over 100!! point type: %d name: %s amount %lld", type, GetName(), amount);
+			amount = 100 - GetPoint(type);
+		}
+
+		SetPoint(type, GetPoint(type) + amount);
+		val = GetPoint(type);
+		break;
+
+	case POINT_IMMUNE_STUN: // 76
+		SetPoint(type, GetPoint(type) + amount);
+		val = GetPoint(type);
+		if (val)
+		{
+			SET_BIT(m_pointsInstant.dwImmuneFlag, IMMUNE_STUN);
+		}
+		else
+		{
+			REMOVE_BIT(m_pointsInstant.dwImmuneFlag, IMMUNE_STUN);
+		}
+		break;
+
+	case POINT_IMMUNE_SLOW: // 77
+		SetPoint(type, GetPoint(type) + amount);
+		val = GetPoint(type);
+		if (val)
+		{
+			SET_BIT(m_pointsInstant.dwImmuneFlag, IMMUNE_SLOW);
+		}
+		else
+		{
+			REMOVE_BIT(m_pointsInstant.dwImmuneFlag, IMMUNE_SLOW);
+		}
+		break;
+
+	case POINT_IMMUNE_FALL: // 78
+		SetPoint(type, GetPoint(type) + amount);
+		val = GetPoint(type);
+		if (val)
+		{
+			SET_BIT(m_pointsInstant.dwImmuneFlag, IMMUNE_FALL);
+		}
+		else
+		{
+			REMOVE_BIT(m_pointsInstant.dwImmuneFlag, IMMUNE_FALL);
+		}
+		break;
+
+	case POINT_ATT_GRADE_BONUS:
+		SetPoint(type, GetPoint(type) + amount);
+		PointChange(POINT_ATT_GRADE, amount);
+		val = GetPoint(type);
+		break;
+
+	case POINT_DEF_GRADE_BONUS:
+		SetPoint(type, GetPoint(type) + amount);
+		PointChange(POINT_DEF_GRADE, amount);
+		val = GetPoint(type);
+		break;
+
+	case POINT_MAGIC_ATT_GRADE_BONUS:
+		SetPoint(type, GetPoint(type) + amount);
+		PointChange(POINT_MAGIC_ATT_GRADE, amount);
+		val = GetPoint(type);
+		break;
+
+	case POINT_MAGIC_DEF_GRADE_BONUS:
+		SetPoint(type, GetPoint(type) + amount);
+		PointChange(POINT_MAGIC_DEF_GRADE, amount);
+		val = GetPoint(type);
+		break;
+
+	case POINT_VOICE:
+	case POINT_EMPIRE_POINT:
+		//sys_err("CHARACTER::PointChange: %s: point cannot be changed. use SetPoint instead (type: %d)", GetName(), type);
+		val = GetRealPoint(type);
+		break;
+
+	case POINT_POLYMORPH:
+		SetPoint(type, GetPoint(type) + amount);
+		val = GetPoint(type);
+		SetPolymorph(val);
+		break;
+
+	case POINT_MOUNT:
+	{
+		SetPoint(type, GetPoint(type) + amount);
+		val = GetPoint(type);
+#if !defined(__MOUNT_COSTUME_SYSTEM__)
+		MountVnum(val);
+#endif
+	}
+	break;
+
+	case POINT_ENERGY:
+	case POINT_COSTUME_ATTR_BONUS:
+	{
+		int old_val = GetPoint(type);
+		SetPoint(type, old_val + amount);
+		val = GetPoint(type);
+		BuffOnAttr_ValueChange(type, old_val, val);
+	}
+	break;
+
+	default:
+		sys_err("CHARACTER::PointChange: %s: unknown point change type %d", GetName(), type);
+		return;
+	}
+
+	switch (type)
+	{
+	case POINT_LEVEL:
+	case POINT_ST:
+	case POINT_DX:
+	case POINT_IQ:
+	case POINT_HT:
+#if defined(__CONQUEROR_LEVEL__)
+	case POINT_CONQUEROR_LEVEL:
+	case POINT_SUNGMA_STR:
+	case POINT_SUNGMA_HP:
+	case POINT_SUNGMA_MOVE:
+	case POINT_SUNGMA_IMMUNE:
+#endif
+		ComputeBattlePoints();
+		break;
+	case POINT_MAX_HP:
+	case POINT_MAX_SP:
+	case POINT_MAX_STAMINA:
+		break;
+	}
+
+	if (type == POINT_HP && amount == 0)
+		return;
+
+	UpdatePointsPacket(type, val, amount, bAmount, bBroadcast);
+}
+
+void CHARACTER::ApplyPoint(BYTE bApplyType, int iVal)
+{
+	switch (bApplyType)
+	{
+	case APPLY_NONE:						// 0
+		break;
+
+		// NOTE: ۿ  ִHP ʽ Ʈ  ʽ Ȱ  ϹǷ
+		// ׳ MAX_HP ϸ Ʈ    .    ո̱⵵ ϰ..
+		// ٲ   ִ hp  hp    ٲ ִ hp  hp Ѵ.
+		//  PointChange ϴ°      skip..
+		// SP Ȱ Ѵ.
+		// Mantis : 101460 ~ ity ~
+	case APPLY_MAX_HP:						// 1
+	{
+		if (GetMaxHP() == 0) break;
+		PointChange(aApplyInfo[bApplyType].bPointType, iVal);
+		break;
+	}
+	case APPLY_MAX_SP:						// 2
+	{
+		if (GetMaxSP() == 0) break;
+		PointChange(aApplyInfo[bApplyType].bPointType, iVal);
+		break;
+	}
+
+	case APPLY_CON:							// 3
+	{
+		PointChange(POINT_HT, iVal);
+		PointChange(POINT_MAX_HP, (iVal * JobInitialPoints[GetJob()].hp_per_ht));
+		PointChange(POINT_MAX_STAMINA, (iVal * JobInitialPoints[GetJob()].stamina_per_con));
+		break;
+	}
+
+	case APPLY_INT:							// 4
+	{
+		PointChange(POINT_IQ, iVal);
+		PointChange(POINT_MAX_SP, (iVal * JobInitialPoints[GetJob()].sp_per_iq));
+		break;
+	}
+
+	case APPLY_STR:							// 5
+	case APPLY_DEX:							// 6
+	case APPLY_ATT_SPEED:					// 7
+	case APPLY_MOV_SPEED:					// 8
+	case APPLY_CAST_SPEED:					// 9
+	case APPLY_HP_REGEN:					// 10
+	case APPLY_SP_REGEN:					// 11
+	case APPLY_POISON_PCT:					// 12
+	case APPLY_STUN_PCT:					// 13
+	case APPLY_SLOW_PCT:					// 14
+	case APPLY_CRITICAL_PCT:				// 15
+	case APPLY_PENETRATE_PCT:				// 16
+	case APPLY_ATTBONUS_HUMAN:				// 17
+	case APPLY_ATTBONUS_ANIMAL:				// 18
+	case APPLY_ATTBONUS_ORC:				// 19
+	case APPLY_ATTBONUS_MILGYO:				// 20
+	case APPLY_ATTBONUS_UNDEAD:				// 21
+	case APPLY_ATTBONUS_DEVIL:				// 22
+	case APPLY_STEAL_HP:					// 23
+	case APPLY_STEAL_SP:					// 24
+	case APPLY_MANA_BURN_PCT:				// 25
+	case APPLY_DAMAGE_SP_RECOVER:			// 26
+	case APPLY_BLOCK:						// 27
+	case APPLY_DODGE:						// 28
+	case APPLY_RESIST_SWORD:				// 29
+	case APPLY_RESIST_TWOHAND:				// 30
+	case APPLY_RESIST_DAGGER:				// 31
+	case APPLY_RESIST_BELL:					// 32
+	case APPLY_RESIST_FAN:					// 33
+	case APPLY_RESIST_BOW:					// 34
+	case APPLY_RESIST_FIRE:					// 35
+	case APPLY_RESIST_ELEC:					// 36
+	case APPLY_RESIST_MAGIC:				// 37
+	case APPLY_RESIST_WIND:					// 38
+	case APPLY_REFLECT_MELEE:				// 39
+	case APPLY_REFLECT_CURSE:				// 40
+	case APPLY_POISON_REDUCE:				// 41
+	case APPLY_KILL_SP_RECOVER:				// 42
+	case APPLY_EXP_DOUBLE_BONUS:			// 43
+	case APPLY_GOLD_DOUBLE_BONUS:			// 44
+	case APPLY_ITEM_DROP_BONUS:				// 45
+	case APPLY_POTION_BONUS:				// 46
+	case APPLY_KILL_HP_RECOVER:				// 47
+	case APPLY_IMMUNE_STUN:					// 48
+	case APPLY_IMMUNE_SLOW:					// 49
+	case APPLY_IMMUNE_FALL:					// 50
+		PointChange(aApplyInfo[bApplyType].bPointType, iVal);
+		break;
+
+	case APPLY_SKILL:						// 51
+	// SKILL_DAMAGE_BONUS
+	{
+		// ֻ Ʈ  8Ʈ vnum, 9Ʈ add, 15Ʈ change
+		// 00000000 00000000 00000000 00000000
+		// ^^^^^^^^  ^^^^^^^^^^^^^^^^^^^^^^^^^
+		// vnum		^ add		change
+		BYTE bSkillVnum = (BYTE)(((DWORD)iVal) >> 24);
+		int iAdd = iVal & 0x00800000;
+		int iChange = iVal & 0x007fffff;
+
+		sys_log(1, "APPLY_SKILL skill %d add? %d change %d", bSkillVnum, iAdd ? 1 : 0, iChange);
+
+		if (0 == iAdd)
+			iChange = -iChange;
+
+		boost::unordered_map<BYTE, int>::iterator iter = m_SkillDamageBonus.find(bSkillVnum);
+
+		if (iter == m_SkillDamageBonus.end())
+			m_SkillDamageBonus.insert(std::make_pair(bSkillVnum, iChange));
+		else
+			iter->second += iChange;
+	}
+	// END_OF_SKILL_DAMAGE_BONUS
+	break;
+
+	case APPLY_BOW_DISTANCE:				// 52
+	case APPLY_ATT_GRADE_BONUS:				// 53
+	case APPLY_DEF_GRADE_BONUS:				// 54
+	case APPLY_MAGIC_ATT_GRADE:				// 55
+	case APPLY_MAGIC_DEF_GRADE:				// 56
+	case APPLY_CURSE_PCT:					// 57
+	case APPLY_MAX_STAMINA:					// 58
+
+	case APPLY_ATT_BONUS_TO_WARRIOR:		// 59
+	case APPLY_ATT_BONUS_TO_ASSASSIN:		// 60
+	case APPLY_ATT_BONUS_TO_SURA:			// 61
+	case APPLY_ATT_BONUS_TO_SHAMAN:			// 62
+	case APPLY_ATT_BONUS_TO_MONSTER:		// 63
+
+	case APPLY_MALL_ATTBONUS:				// 64
+	case APPLY_MALL_DEFBONUS:				// 65
+	case APPLY_MALL_EXPBONUS:				// 66 
+	case APPLY_MALL_ITEMBONUS:				// 67
+	case APPLY_MALL_GOLDBONUS:				// 68
+		PointChange(aApplyInfo[bApplyType].bPointType, iVal);
+		break;
+
+	case APPLY_MAX_HP_PCT:					// 69
+	{
+		if (GetMaxHP() == 0) break;
+		PointChange(aApplyInfo[bApplyType].bPointType, iVal);
+	}
+	break;
+	case APPLY_MAX_SP_PCT:					// 70
+	{
+		if (GetMaxSP() == 0) break;
+		PointChange(aApplyInfo[bApplyType].bPointType, iVal);
+	}
+	break;
+
+	case APPLY_SKILL_DAMAGE_BONUS:			// 71
+	case APPLY_NORMAL_HIT_DAMAGE_BONUS:		// 72
+
+	// DEPEND_BONUS_ATTRIBUTES
+	case APPLY_SKILL_DEFEND_BONUS:			// 73
+	case APPLY_NORMAL_HIT_DEFEND_BONUS:		// 74
+	// END_OF_DEPEND_BONUS_ATTRIBUTES
+
+	case APPLY_PC_BANG_EXP_BONUS:			// 75
+	case APPLY_PC_BANG_DROP_BONUS:			// 76
+
+	// case APPLY_EXTRACT_HP_PCT:			// 77  HP Ҹ
+
+	case APPLY_RESIST_WARRIOR:				// 78
+	case APPLY_RESIST_ASSASSIN:				// 79
+	case APPLY_RESIST_SURA:					// 80
+	case APPLY_RESIST_SHAMAN:				// 81
+
+	case APPLY_ENERGY:						// 82 
+	case APPLY_DEF_GRADE:					// 83 . DEF_GRADE_BONUS Ŭ󿡼 ι  ǵ (...) ִ.
+	case APPLY_COSTUME_ATTR_BONUS:			// 84 ڽƬ ۿ  Ӽġ ʽ
+	case APPLY_MAGIC_ATTBONUS_PER:			// 85  ݷ +x%
+	case APPLY_MELEE_MAGIC_ATTBONUS_PER:	// 86  + и ݷ +x%
+
+	case APPLY_RESIST_ICE:					// 87 ñ 
+	case APPLY_RESIST_EARTH:				// 88  
+	case APPLY_RESIST_DARK:					// 89  
+
+	case APPLY_ANTI_CRITICAL_PCT:			// 90 ũƼ 
+	case APPLY_ANTI_PENETRATE_PCT:			// 91 Ÿ 
+
+	case APPLY_BLEEDING_REDUCE:				// 92
+	case APPLY_BLEEDING_PCT:				// 93
+	case APPLY_ATT_BONUS_TO_WOLFMAN:		// 94
+	case APPLY_RESIST_WOLFMAN:				// 95
+	case APPLY_RESIST_CLAW:					// 96
+
+#if defined(__MOUNT_COSTUME_SYSTEM__)
+	case APPLY_MOUNT:						// 97
+#endif
+
+#if defined(__ACCE_COSTUME_SYSTEM__)
+	case APPLY_ACCEDRAIN_RATE:				// 98
+#endif
+
+#if defined(__MAGIC_REDUCTION__)
+	case APPLY_RESIST_MAGIC_REDUCTION:		// 99
+#endif
+
+#if defined(__ELEMENT_SYSTEM__)
+	case APPLY_ENCHANT_ELECT:				// 100
+	case APPLY_ENCHANT_FIRE:				// 101
+	case APPLY_ENCHANT_ICE:					// 102
+	case APPLY_ENCHANT_WIND:				// 103
+	case APPLY_ENCHANT_EARTH:				// 104
+	case APPLY_ENCHANT_DARK:				// 105
+	case APPLY_ATTBONUS_CZ:					// 106
+	case APPLY_ATTBONUS_INSECT:				// 107
+	case APPLY_ATTBONUS_DESERT:				// 108
+
+	case APPLY_ATTBONUS_SWORD:				// 109
+	case APPLY_ATTBONUS_TWOHAND:			// 110
+	case APPLY_ATTBONUS_DAGGER:				// 111
+	case APPLY_ATTBONUS_BELL:				// 112
+	case APPLY_ATTBONUS_FAN:				// 113
+	case APPLY_ATTBONUS_BOW:				// 114
+	case APPLY_ATTBONUS_CLAW:				// 115
+
+	case APPLY_RESIST_HUMAN:				// 116
+#endif
+	case APPLY_ATTBONUS_STONE:				// 117
+#if defined(__CONQUEROR_LEVEL__)
+	case APPLY_SUNGMA_STR:					// 118
+	case APPLY_SUNGMA_HP:					// 119
+	case APPLY_SUNGMA_MOVE:					// 120
+	case APPLY_SUNGMA_IMMUNE:				// 121
+#endif
+		PointChange(aApplyInfo[bApplyType].bPointType, iVal);
+		break;
+
+#if defined(__ITEM_APPLY_RANDOM__)
+	case APPLY_RANDOM:
+		break;
+#endif
+
+	default:
+		sys_err("Unknown apply type %d name %s", bApplyType, GetName());
+		break;
+	}
+}
+
+void CHARACTER::MotionPacketEncode(BYTE motion, LPCHARACTER victim, struct packet_motion* packet)
+{
+	packet->header = HEADER_GC_MOTION;
+	packet->vid = m_vid;
+	packet->motion = motion;
+
+	if (victim)
+		packet->victim_vid = victim->GetVID();
+	else
+		packet->victim_vid = 0;
+}
+
+void CHARACTER::Motion(BYTE motion, LPCHARACTER victim)
+{
+	struct packet_motion pack_motion;
+	MotionPacketEncode(motion, victim, &pack_motion);
+	PacketAround(&pack_motion, sizeof(struct packet_motion));
+}
+
+EVENTFUNC(save_event)
+{
+	char_event_info* info = dynamic_cast<char_event_info*>(event->info);
+	if (info == NULL)
+	{
+		sys_err("save_event> <Factor> Null pointer");
+		return 0;
+	}
+
+	LPCHARACTER ch = info->ch;
+
+	if (ch == NULL) // <Factor>
+		return 0;
+
+	sys_log(1, "SAVE_EVENT: %s", ch->GetName());
+	ch->Save();
+	ch->FlushDelayedSaveItem();
+	return (save_event_second_cycle);
+}
+
+void CHARACTER::StartSaveEvent()
+{
+	if (m_pkSaveEvent)
+		return;
+
+	char_event_info* info = AllocEventInfo<char_event_info>();
+
+	info->ch = this;
+	m_pkSaveEvent = event_create(save_event, info, save_event_second_cycle);
+}
+
+void CHARACTER::MonsterLog(const char* format, ...)
+{
+	if (!test_server)
+		return;
+
+	if (IsPC())
+		return;
+
+	char chatbuf[CHAT_MAX_LEN + 1];
+	int len = snprintf(chatbuf, sizeof(chatbuf), "%u)", (DWORD)GetVID());
+
+	if (len < 0 || len >= (int)sizeof(chatbuf))
+		len = sizeof(chatbuf) - 1;
+
+	va_list args;
+
+	va_start(args, format);
+
+	int len2 = vsnprintf(chatbuf + len, sizeof(chatbuf) - len, format, args);
+
+	if (len2 < 0 || len2 >= (int)sizeof(chatbuf) - len)
+		len += (sizeof(chatbuf) - len) - 1;
+	else
+		len += len2;
+
+	// \0  
+	++len;
+
+	va_end(args);
+
+	TPacketGCChat pack_chat;
+
+	pack_chat.header = HEADER_GC_CHAT;
+	pack_chat.size = sizeof(TPacketGCChat) + len;
+	pack_chat.type = CHAT_TYPE_TALKING;
+	pack_chat.id = (DWORD)GetVID();
+	pack_chat.bEmpire = 0;
+
+	TEMP_BUFFER buf;
+	buf.write(&pack_chat, sizeof(TPacketGCChat));
+	buf.write(chatbuf, len);
+
+	CHARACTER_MANAGER::instance().PacketMonsterLog(this, buf.read_peek(), buf.size());
+}
+
+void CHARACTER::ChatPacket(BYTE type, const char* format, ...)
+{
+	LPDESC d = GetDesc();
+
+	if (!d || !format)
+		return;
+
+	const char* localeFormat;
+	if (type != CHAT_TYPE_COMMAND)
+		localeFormat = LC_LOCALE_TEXT(format, d->GetLanguage());
+	else
+		localeFormat = format;
+
+	if (!localeFormat)
+		return;
+
+	char chatbuf[CHAT_MAX_LEN + 1];
+	va_list args;
+
+	va_start(args, format);
+	int len = vsnprintf(chatbuf, sizeof(chatbuf), localeFormat, args);
+	va_end(args);
+
+	struct packet_chat pack_chat;
+
+	pack_chat.header = HEADER_GC_CHAT;
+	pack_chat.size = sizeof(struct packet_chat) + len;
+	pack_chat.type = type;
+	pack_chat.id = 0;
+	pack_chat.bEmpire = d->GetEmpire();
+
+	TEMP_BUFFER buf;
+	buf.write(&pack_chat, sizeof(struct packet_chat));
+	buf.write(chatbuf, len);
+
+	d->Packet(buf.read_peek(), buf.size());
+
+	if (type == CHAT_TYPE_COMMAND && test_server)
+		sys_log(0, "SEND_COMMAND %s %s", GetName(), chatbuf);
+}
+
+// MINING
+void CHARACTER::mining_take()
+{
+	m_pkMiningEvent = NULL;
+}
+
+void CHARACTER::mining_cancel()
+{
+	if (m_pkMiningEvent)
+	{
+		sys_log(0, "XXX MINING CANCEL");
+		event_cancel(&m_pkMiningEvent);
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ä ߴϿϴ."));
+	}
+}
+
+void CHARACTER::mining(LPCHARACTER chLoad)
+{
+	if (m_pkMiningEvent)
+	{
+		mining_cancel();
+		return;
+	}
+
+	if (!chLoad)
+		return;
+
+	if (GetMapIndex() != chLoad->GetMapIndex() || DISTANCE_APPROX(GetX() - chLoad->GetX(), GetY() - chLoad->GetY()) > 1000)
+		return;
+
+	if (mining::GetRawOreFromLoad(chLoad->GetRaceNum()) == 0)
+		return;
+
+	LPITEM pick = GetWear(WEAR_WEAPON);
+
+	if (!pick || pick->GetType() != ITEM_PICK)
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̸ ϼ."));
+		return;
+	}
+
+	int count = number(5, 15); //  Ƚ,  ۴ 2
+
+	// ä  
+	TPacketGCDigMotion p;
+	p.header = HEADER_GC_DIG_MOTION;
+	p.vid = GetVID();
+	p.target_vid = chLoad->GetVID();
+	p.count = count;
+
+	PacketAround(&p, sizeof(p));
+
+	m_pkMiningEvent = mining::CreateMiningEvent(this, chLoad, count);
+}
+// END_OF_MINING
+
+void CHARACTER::fishing()
+{
+	if (m_pkFishingEvent)
+	{
+		fishing_take();
+		return;
+	}
+
+	//  Ӽ ø õѴ?
+	{
+		LPSECTREE_MAP pkSectreeMap = SECTREE_MANAGER::instance().GetMap(GetMapIndex());
+
+		int x = GetX();
+		int y = GetY();
+
+		LPSECTREE tree = pkSectreeMap->Find(x, y);
+		DWORD dwAttr = tree->GetAttribute(x, y);
+
+		if (IS_SET(dwAttr, ATTR_BLOCK))
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ø   ִ  ƴմϴ"));
+			return;
+		}
+	}
+	
+#ifdef __GROWTH_PET_SYSTEM__
+	if (GetActiveGrowthPet())
+	{
+		ChatPacket(CHAT_TYPE_INFO, "You cannot fish while your pet is summoned.");
+		return;
+	}
+
+	if (IsPetHatchWindowOpen())
+	{
+		ChatPacket(CHAT_TYPE_INFO, "You cannot fish when your pet is hatched.");
+		return;
+	}
+
+	if (IsPetChangeNameWindowOpen())
+	{
+		ChatPacket(CHAT_TYPE_INFO, "You cannot fish while the pet bonus change window is open.");
+		return;
+	}
+#endif
+
+
+	LPITEM rod = GetWear(WEAR_WEAPON);
+
+	// ô 
+	if (!rod || rod->GetType() != ITEM_ROD)
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ô븦  ϼ."));
+		return;
+	}
+
+	if (0 == rod->GetSocket(2))
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̳   ּ."));
+		return;
+	}
+
+	float fx, fy;
+	GetDeltaByDegree(GetRotation(), 400.0f, &fx, &fy);
+
+	m_pkFishingEvent = fishing::CreateFishingEvent(this);
+}
+
+void CHARACTER::fishing_take()
+{
+	LPITEM rod = GetWear(WEAR_WEAPON);
+	if (rod && rod->GetType() == ITEM_ROD)
+	{
+		using fishing::fishing_event_info;
+		if (m_pkFishingEvent)
+		{
+			struct fishing_event_info* info = dynamic_cast<struct fishing_event_info*>(m_pkFishingEvent->info);
+
+			if (info)
+				fishing::Take(info, this);
+		}
+	}
+	else
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ô밡 ƴ  ø   ϴ!"));
+	}
+
+	event_cancel(&m_pkFishingEvent);
+}
+
+bool CHARACTER::StartStateMachine(int iNextPulse)
+{
+	if (CHARACTER_MANAGER::instance().AddToStateList(this))
+	{
+		m_dwNextStatePulse = thecore_heart->pulse + iNextPulse;
+		return true;
+	}
+
+	return false;
+}
+
+void CHARACTER::StopStateMachine()
+{
+	CHARACTER_MANAGER::instance().RemoveFromStateList(this);
+}
+
+void CHARACTER::UpdateStateMachine(DWORD dwPulse)
+{
+	if (dwPulse < m_dwNextStatePulse)
+		return;
+
+	if (IsDead())
+		return;
+
+	Update();
+	m_dwNextStatePulse = dwPulse + m_dwStateDuration;
+}
+
+void CHARACTER::SetNextStatePulse(int iNextPulse)
+{
+	CHARACTER_MANAGER::instance().AddToStateList(this);
+	m_dwNextStatePulse = iNextPulse;
+
+	if (iNextPulse < 10)
+		MonsterLog("·ξ");
+}
+
+// ĳ νϽ Ʈ Լ.
+void CHARACTER::UpdateCharacter(DWORD dwPulse)
+{
+	CFSM::Update();
+}
+
+void CHARACTER::SetShop(LPSHOP pkShop)
+{
+	if ((m_pkShop = pkShop))
+		SET_BIT(m_pointsInstant.instant_flag, INSTANT_FLAG_SHOP);
+	else
+	{
+		REMOVE_BIT(m_pointsInstant.instant_flag, INSTANT_FLAG_SHOP);
+		SetShopOwner(NULL);
+	}
+}
+
+void CHARACTER::SetExchange(CExchange* pkExchange)
+{
+	m_pkExchange = pkExchange;
+}
+
+void CHARACTER::SetPart(BYTE bPartPos, WORD wVal)
+{
+	assert(bPartPos < PART_MAX_NUM);
+	m_pointsInstant.parts[bPartPos] = wVal;
+}
+
+DWORD CHARACTER::GetPart(BYTE bPartPos) const
+{
 	assert(bPartPos < PART_MAX_NUM);
 #if defined(__HIDE_COSTUME_SYSTEM__)
-	if (bPartPos == PART_MAIN && GetHiddenCostumeByPart(PART_MAIN))
+	if (bPartPos == PART_MAIN && GetWear(WEAR_COSTUME_BODY) && IsBodyCostumeHidden() == true)
 	{
 		if (const LPITEM pArmor = GetWear(WEAR_BODY))
 #if defined(__CHANGE_LOOK_SYSTEM__)
-			return pArmor->GetTransmutationVnum() != 0 ? pArmor->GetTransmutationVnum() : pArmor->GetVnum();
+			return pArmor->GetTransmutation() != 0 ? pArmor->GetTransmutation() : pArmor->GetVnum();
 #else
 			return pArmor->GetVnum();
 #endif
 		else
 			return 0;
 	}
-	else if (bPartPos == PART_WEAPON && GetHiddenCostumeByPart(PART_WEAPON))
+	else if (bPartPos == PART_HAIR && GetWear(WEAR_COSTUME_HAIR) && IsHairCostumeHidden() == true)
+		return 0;
+	else if (bPartPos == PART_ACCE && GetWear(WEAR_COSTUME_ACCE) && IsAcceCostumeHidden() == true)
+		return 0;
+	else if (bPartPos == PART_WEAPON && GetWear(WEAR_COSTUME_WEAPON) && IsWeaponCostumeHidden() == true)
 	{
 		if (const LPITEM pWeapon = GetWear(WEAR_WEAPON))
 #if defined(__CHANGE_LOOK_SYSTEM__)
-			return pWeapon->GetTransmutationVnum() != 0 ? pWeapon->GetTransmutationVnum() : pWeapon->GetVnum();
+			return pWeapon->GetTransmutation() != 0 ? pWeapon->GetTransmutation() : pWeapon->GetVnum();
 #else
 			return pWeapon->GetVnum();
 #endif
 		else
 			return 0;
 	}
-	else
+#endif
+	return m_pointsInstant.parts[bPartPos];
+}
+
+DWORD CHARACTER::GetOriginalPart(BYTE bPartPos) const
+{
+	switch (bPartPos)
 	{
-		if (GetHiddenCostumeByPart(bPartPos))
+	case PART_MAIN:
+#if defined(__HIDE_COSTUME_SYSTEM__)
+		if (GetWear(WEAR_COSTUME_BODY) && IsBodyCostumeHidden() == true)
+			if (const LPITEM pArmor = GetWear(WEAR_BODY))
+				return pArmor->GetVnum();
+#endif
+		if (!IsPC()) // PC ƴ   Ʈ ״ 
+			return GetPart(PART_MAIN);
+		else
+			return m_pointsInstant.bBasePart;
+
+	case PART_HAIR:
+#if defined(__HIDE_COSTUME_SYSTEM__)
+		if (GetWear(WEAR_COSTUME_HAIR) && IsHairCostumeHidden() == true)
+			return 0;
+#endif
+		return GetPart(PART_HAIR);
+
+#if defined(__ACCE_COSTUME_SYSTEM__)
+	case PART_ACCE:
+#if defined(__HIDE_COSTUME_SYSTEM__)
+		if (GetWear(WEAR_COSTUME_ACCE) && IsAcceCostumeHidden() == true)
 			return 0;
+#endif
+		return GetPart(PART_ACCE);
+#endif
+
+#if defined(__WEAPON_COSTUME_SYSTEM__)
+	case PART_WEAPON:
+#if defined(__HIDE_COSTUME_SYSTEM__)
+		if (GetWear(WEAR_COSTUME_WEAPON) && IsWeaponCostumeHidden() == true)
+			if (const LPITEM pWeapon = GetWear(WEAR_WEAPON))
+				return pWeapon->GetVnum();
+#endif
+		return GetWear(WEAR_COSTUME_WEAPON) ? GetPart(PART_WEAPON) : 0;
+#endif
+
+	default:
+		return 0;
 	}
-#endif
-	return m_pointsInstant.adwParts[bPartPos];
-}
-
-DWORD CHARACTER::GetOriginalPart(BYTE bPartPos) const
-{
-	switch (bPartPos)
-	{
-		case PART_MAIN:
-			if (!IsPC()) // PC ƴ   Ʈ ״ 
-				return GetPart(PART_MAIN);
-			else
-				return m_pointsInstant.bBasePart;
-
-		case PART_HAIR:
-			return GetPart(PART_HAIR);
-
-#if defined(__ACCE_COSTUME_SYSTEM__)
-		case PART_ACCE:
-			return GetPart(PART_ACCE);
-#endif
-
-#if defined(__WEAPON_COSTUME_SYSTEM__)
-		case PART_WEAPON:
-			return GetWear(WEAR_COSTUME_WEAPON) ? GetPart(PART_WEAPON) : 0;
-#endif
-
-#if defined(__AURA_COSTUME_SYSTEM__)
-		case PART_AURA:
-			return GetPart(PART_AURA);
-#endif
-
-		default:
-			return 0;
-	}
-}
-
-BYTE CHARACTER::GetCharType() const
-{
-	return m_bCharType;
-}
-
-bool CHARACTER::SetSyncOwner(LPCHARACTER ch, bool bRemoveFromList)
-{
-	if (IsNoMove())
-		return false;
-
-	if (ch)
-	{
-		if (!battle_is_attackable(ch, this))
-		{
-			SendDamagePacket(ch, 0, DAMAGE_BLOCK);
-			return false;
-		}
-	}
-
-	if (ch == this)
-	{
-		sys_err("SetSyncOwner owner == this (%p)", this);
-		return false;
-	}
-
-	if (!ch)
-	{
-		if (bRemoveFromList && m_pkChrSyncOwner)
-		{
-			m_pkChrSyncOwner->m_kLst_pkChrSyncOwned.remove(this);
-		}
-
-		if (m_pkChrSyncOwner)
-			sys_log(1, "SyncRelease %s %p from %s", GetName(), this, m_pkChrSyncOwner->GetName());
-
-		// Ʈ  ʴ ʹ NULL õǾ Ѵ.
-		m_pkChrSyncOwner = NULL;
-	}
-	else
-	{
-		if (!IsSyncOwner(ch))
-			return false;
-
-		// Ÿ 200 ̸̻ SyncOwner   .
-		if (DISTANCE_APPROX(GetX() - ch->GetX(), GetY() - ch->GetY()) > 250)
-		{
-			sys_log(1, "SetSyncOwner distance over than 250 %s %s", GetName(), ch->GetName());
-
-			// SyncOwner  Owner ǥѴ.
-			if (m_pkChrSyncOwner == ch)
-				return true;
-
-			return false;
-		}
-
-		if (m_pkChrSyncOwner != ch)
-		{
-			if (m_pkChrSyncOwner)
-			{
-				sys_log(1, "SyncRelease %s %p from %s", GetName(), this, m_pkChrSyncOwner->GetName());
-				m_pkChrSyncOwner->m_kLst_pkChrSyncOwned.remove(this);
-			}
-
-			m_pkChrSyncOwner = ch;
-			m_pkChrSyncOwner->m_kLst_pkChrSyncOwned.push_back(this);
-
-			// SyncOwner ٲ LastSyncTime ʱȭѴ.
-			static const timeval zero_tv = { 0, 0 };
-			SetLastSyncTime(zero_tv);
-
-			sys_log(1, "SetSyncOwner set %s %p to %s", GetName(), this, ch->GetName());
-		}
-
-		m_fSyncTime = get_float_time();
-	}
-
-	// TODO: Sync Owner   Ŷ  Ƿ,
-	// ȭ  ð 3 ̻   Ǯִ Ŷ
-	//   ϸ Ŷ   ִ.
-	TPacketGCOwnership pack;
-
-	pack.bHeader = HEADER_GC_OWNERSHIP;
-	pack.dwOwnerVID = ch ? ch->GetVID() : 0;
-	pack.dwVictimVID = GetVID();
-
-	PacketAround(&pack, sizeof(TPacketGCOwnership));
-	return true;
-}
-
-struct FuncClearSync
-{
-	void operator () (LPCHARACTER ch)
-	{
-		assert(ch != NULL);
-		ch->SetSyncOwner(NULL, false); // false ÷׷ ؾ for_each   .
-	}
-};
-
-void CHARACTER::ClearSync()
-{
-	SetSyncOwner(NULL);
-
-	// Ʒ for_each  m_pkChrSyncOwner  ڵ ͸ NULL Ѵ.
-	std::for_each(m_kLst_pkChrSyncOwned.begin(), m_kLst_pkChrSyncOwned.end(), FuncClearSync());
-	m_kLst_pkChrSyncOwned.clear();
-}
-
-bool CHARACTER::IsSyncOwner(LPCHARACTER ch) const
-{
-	if (m_pkChrSyncOwner == ch)
-		return true;
-
-	//  ȭ  ð 3 ̻ ٸ  ƹԵ
-	// .  ƹ SyncOwner̹Ƿ true 
-	if (get_float_time() - m_fSyncTime >= 3.0f)
-		return true;
-
-	return false;
-}
-
-void CHARACTER::SetParty(LPPARTY pkParty)
-{
-	if (pkParty == m_pkParty)
-		return;
-
-	if (pkParty && m_pkParty)
-		sys_err("%s is trying to reassigning party (current %p, new party %p)", GetName(), get_pointer(m_pkParty), get_pointer(pkParty));
-
-	sys_log(1, "PARTY set to %p", get_pointer(pkParty));
-
-	if (m_pkDungeon && IsPC() && !pkParty)
-		SetDungeon(NULL);
-
-	m_pkParty = pkParty;
-
-	if (IsPC())
-	{
-		if (m_pkParty)
-			SET_BIT(m_bAddChrState, ADD_CHARACTER_STATE_PARTY);
-		else
-			REMOVE_BIT(m_bAddChrState, ADD_CHARACTER_STATE_PARTY);
-
-		UpdatePacket();
-	}
-}
-
-// PARTY_JOIN_BUG_FIX
-/// Ƽ  event 
-EVENTINFO(TPartyJoinEventInfo)
-{
-	DWORD dwGuestPID; ///< Ƽ  ĳ PID
-	DWORD dwLeaderPID; ///< Ƽ  PID
-
-	TPartyJoinEventInfo()
-		: dwGuestPID(0)
-		, dwLeaderPID(0)
-	{
-	}
-};
-
-EVENTFUNC(party_request_event)
-{
-	TPartyJoinEventInfo* info = dynamic_cast<TPartyJoinEventInfo*>(event->info);
-
-	if (info == NULL)
-	{
-		sys_err("party_request_event> <Factor> Null pointer");
-		return 0;
-	}
-
-	LPCHARACTER ch = CHARACTER_MANAGER::instance().FindByPID(info->dwGuestPID);
-
-	if (ch)
-	{
-		sys_log(0, "PartyRequestEvent %s", ch->GetName());
-		ch->ChatPacket(CHAT_TYPE_COMMAND, "PartyRequestDenied");
-		ch->SetPartyRequestEvent(NULL);
-	}
-
-	return 0;
-}
-
-bool CHARACTER::RequestToParty(LPCHARACTER leader)
-{
-	if (leader->GetParty())
-		leader = leader->GetParty()->GetLeaderCharacter();
-
-	if (!leader)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ƽ  ° ƴ϶ û   ϴ."));
-		return false;
-	}
-
-	if (m_pkPartyRequestEvent)
-		return false;
-
-	if (!IsPC() || !leader->IsPC())
-		return false;
-
-	if (leader->IsBlockMode(BLOCK_PARTY_REQUEST))
-		return false;
-
-	PartyJoinErrCode errcode = IsPartyJoinableCondition(leader, this);
-
-	switch (errcode)
-	{
-		case PERR_NONE:
-			break;
-
-		case PERR_SERVER:
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>   Ƽ  ó   ϴ."));
-			return false;
-
-		case PERR_DIFFEMPIRE:
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> ٸ  Ƽ ̷  ϴ."));
-			return false;
-
-		case PERR_DUNGEON:
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>  ȿ Ƽ ʴ븦   ϴ."));
-			return false;
-
-		case PERR_OBSERVER:
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>  忡 Ƽ ʴ븦   ϴ."));
-			return false;
-
-		case PERR_LVBOUNDARY:
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> -30 ~ +30  ̳ 游 ʴ  ֽϴ."));
-			return false;
-
-		case PERR_LOWLEVEL:
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> Ƽ ְ   30  ʴ  ϴ."));
-			return false;
-
-		case PERR_HILEVEL:
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> Ƽ    30  ʴ  ϴ."));
-			return false;
-
-		case PERR_ALREADYJOIN:
-			return false;
-
-		case PERR_PARTYISFULL:
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>  ̻ Ƽ ʴ  ϴ."));
-			return false;
-
-		default:
-			sys_err("Do not process party join error(%d)", errcode);
-			return false;
-	}
-
-	TPartyJoinEventInfo* info = AllocEventInfo<TPartyJoinEventInfo>();
-
-	info->dwGuestPID = GetPlayerID();
-	info->dwLeaderPID = leader->GetPlayerID();
-
-	SetPartyRequestEvent(event_create(party_request_event, info, PASSES_PER_SEC(10)));
-
-#if defined(__NEW_USER_CARE__)
-	leader->ChatPacket(CHAT_TYPE_COMMAND, "PartyRequest %u %s", (DWORD)GetVID(), GetName());
-#else
-	leader->ChatPacket(CHAT_TYPE_COMMAND, "PartyRequest %u", (DWORD)GetVID());
-#endif
-	ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s Կ Ƽ û ߽ϴ.", leader->GetName()));
-	return true;
-}
-
-void CHARACTER::DenyToParty(LPCHARACTER member)
-{
-	sys_log(1, "DenyToParty %s member %s %p", GetName(), member->GetName(), get_pointer(member->m_pkPartyRequestEvent));
-
-	if (!member->m_pkPartyRequestEvent)
-		return;
-
-	TPartyJoinEventInfo* info = dynamic_cast<TPartyJoinEventInfo*>(member->m_pkPartyRequestEvent->info);
-
-	if (!info)
-	{
-		sys_err("CHARACTER::DenyToParty> <Factor> Null pointer");
-		return;
-	}
-
-	if (info->dwGuestPID != member->GetPlayerID())
-		return;
-
-	if (info->dwLeaderPID != GetPlayerID())
-		return;
-
-	event_cancel(&member->m_pkPartyRequestEvent);
-
-	member->ChatPacket(CHAT_TYPE_COMMAND, "PartyRequestDenied");
-}
-
-void CHARACTER::AcceptToParty(LPCHARACTER member)
-{
-	sys_log(1, "AcceptToParty %s member %s %p", GetName(), member->GetName(), get_pointer(member->m_pkPartyRequestEvent));
-
-	if (!member->m_pkPartyRequestEvent)
-		return;
-
-	TPartyJoinEventInfo* info = dynamic_cast<TPartyJoinEventInfo*>(member->m_pkPartyRequestEvent->info);
-
-	if (!info)
-	{
-		sys_err("CHARACTER::AcceptToParty> <Factor> Null pointer");
-		return;
-	}
-
-	if (info->dwGuestPID != member->GetPlayerID())
-		return;
-
-	if (info->dwLeaderPID != GetPlayerID())
-		return;
-
-	event_cancel(&member->m_pkPartyRequestEvent);
-
-	if (!GetParty())
-		member->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" Ƽ  ʽϴ."));
-	else
-	{
-		if (GetPlayerID() != GetParty()->GetLeaderPID())
-			return;
-
-		PartyJoinErrCode errcode = IsPartyJoinableCondition(this, member);
-		switch (errcode)
-		{
-			case PERR_NONE: member->PartyJoin(this); return;
-			case PERR_SERVER: member->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>   Ƽ  ó   ϴ.")); break;
-			case PERR_DUNGEON: member->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>  ȿ Ƽ ʴ븦   ϴ.")); break;
-			case PERR_OBSERVER: member->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>  忡 Ƽ ʴ븦   ϴ.")); break;
-			case PERR_LVBOUNDARY: member->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> -30 ~ +30  ̳ 游 ʴ  ֽϴ.")); break;
-			case PERR_LOWLEVEL: member->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> Ƽ ְ   30  ʴ  ϴ.")); break;
-			case PERR_HILEVEL: member->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> Ƽ    30  ʴ  ϴ.")); break;
-			case PERR_ALREADYJOIN: break;
-			case PERR_PARTYISFULL: {
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>  ̻ Ƽ ʴ  ϴ."));
-				member->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> Ƽ ο ʰϿ Ƽ   ϴ."));
-				break;
-			}
-			default: sys_err("Do not process party join error(%d)", errcode);
-		}
-	}
-
-	member->ChatPacket(CHAT_TYPE_COMMAND, "PartyRequestDenied");
-}
-
-/**
-* Ƽ ʴ event callback Լ.
-* event  ߵϸ ʴ  óѴ.
-**/
-EVENTFUNC(party_invite_event)
-{
-	TPartyJoinEventInfo* pInfo = dynamic_cast<TPartyJoinEventInfo*>(event->info);
-
-	if (pInfo == NULL)
-	{
-		sys_err("party_invite_event> <Factor> Null pointer");
-		return 0;
-	}
-
-	LPCHARACTER pchInviter = CHARACTER_MANAGER::instance().FindByPID(pInfo->dwLeaderPID);
-
-	if (pchInviter)
-	{
-		sys_log(1, "PartyInviteEvent %s", pchInviter->GetName());
-		pchInviter->PartyInviteDeny(pInfo->dwGuestPID);
-	}
-
-	return 0;
-}
-
-void CHARACTER::PartyInvite(LPCHARACTER pchInvitee)
-{
-	if (GetParty() && GetParty()->GetLeaderPID() != GetPlayerID())
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> Ƽ ʴ  ִ  ϴ."));
-		return;
-	}
-	else if (pchInvitee->IsBlockMode(BLOCK_PARTY_INVITE))
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> %s  Ƽ ź Դϴ.", pchInvitee->GetName()));
-		return;
-	}
-
-	PartyJoinErrCode errcode = IsPartyJoinableCondition(this, pchInvitee);
-
-	switch (errcode)
-	{
-		case PERR_NONE:
-			break;
-
-		case PERR_SERVER:
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>   Ƽ  ó   ϴ."));
-			return;
-
-		case PERR_DIFFEMPIRE:
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> ٸ  Ƽ ̷  ϴ."));
-			return;
-
-		case PERR_DUNGEON:
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>  ȿ Ƽ ʴ븦   ϴ."));
-			return;
-
-		case PERR_OBSERVER:
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>  忡 Ƽ ʴ븦   ϴ."));
-			return;
-
-		case PERR_LVBOUNDARY:
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> -30 ~ +30  ̳ 游 ʴ  ֽϴ."));
-			return;
-
-		case PERR_LOWLEVEL:
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> Ƽ ְ   30  ʴ  ϴ."));
-			return;
-
-		case PERR_HILEVEL:
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> Ƽ    30  ʴ  ϴ."));
-			return;
-
-		case PERR_ALREADYJOIN:
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> ̹ %s Ƽ  ֽϴ.", pchInvitee->GetName()));
-			return;
-
-		case PERR_PARTYISFULL:
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>  ̻ Ƽ ʴ  ϴ."));
-			return;
-
-		default:
-			sys_err("Do not process party join error(%d)", errcode);
-			return;
-	}
-
-	if (m_PartyInviteEventMap.end() != m_PartyInviteEventMap.find(pchInvitee->GetPlayerID()))
-		return;
-
-	//
-	// EventMap  ̺Ʈ ߰
-	//
-	TPartyJoinEventInfo* info = AllocEventInfo<TPartyJoinEventInfo>();
-
-	info->dwGuestPID = pchInvitee->GetPlayerID();
-	info->dwLeaderPID = GetPlayerID();
-
-	m_PartyInviteEventMap.insert(EventMap::value_type(pchInvitee->GetPlayerID(), event_create(party_invite_event, info, PASSES_PER_SEC(10))));
-
-	//
-	// ʴ ޴ character  ʴ Ŷ 
-	//
-
-	TPacketGCPartyInvite p;
-	p.header = HEADER_GC_PARTY_INVITE;
-	p.leader_vid = GetVID();
-	pchInvitee->GetDesc()->Packet(&p, sizeof(p));
-}
-
-void CHARACTER::PartyInviteAccept(LPCHARACTER pchInvitee)
-{
-	EventMap::iterator itFind = m_PartyInviteEventMap.find(pchInvitee->GetPlayerID());
-
-	if (itFind == m_PartyInviteEventMap.end())
-	{
-		sys_log(1, "PartyInviteAccept from not invited character(%s)", pchInvitee->GetName());
-		return;
-	}
-
-	event_cancel(&itFind->second);
-	m_PartyInviteEventMap.erase(itFind);
-
-	if (GetParty() && GetParty()->GetLeaderPID() != GetPlayerID())
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> Ƽ ʴ  ִ  ϴ."));
-		return;
-	}
-
-	PartyJoinErrCode errcode = IsPartyJoinableMutableCondition(this, pchInvitee);
-
-	switch (errcode)
-	{
-		case PERR_NONE:
-			break;
-
-		case PERR_SERVER:
-			pchInvitee->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>   Ƽ  ó   ϴ."));
-			return;
-
-		case PERR_DUNGEON:
-			pchInvitee->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>  ȿ Ƽ ʴ뿡   ϴ."));
-			return;
-
-		case PERR_OBSERVER:
-			pchInvitee->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>  忡 Ƽ ʴ븦   ϴ."));
-			return;
-
-		case PERR_LVBOUNDARY:
-			pchInvitee->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> -30 ~ +30  ̳ 游 ʴ  ֽϴ."));
-			return;
-
-		case PERR_LOWLEVEL:
-			pchInvitee->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> Ƽ ְ   30  ʴ  ϴ."));
-			return;
-
-		case PERR_HILEVEL:
-			pchInvitee->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> Ƽ    30  ʴ  ϴ."));
-			return;
-
-		case PERR_ALREADYJOIN:
-			pchInvitee->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> Ƽ ʴ뿡   ϴ."));
-			return;
-
-		case PERR_PARTYISFULL:
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>  ̻ Ƽ ʴ  ϴ."));
-			pchInvitee->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> Ƽ ο ʰϿ Ƽ   ϴ."));
-			return;
-
-		default:
-			sys_err("ignore party join error(%d)", errcode);
-			return;
-	}
-
-	//
-	// Ƽ  ó
-	//
-
-	if (GetParty())
-		pchInvitee->PartyJoin(this);
-	else
-	{
-		LPPARTY pParty = CPartyManager::instance().CreateParty(this);
-
-		pParty->Join(pchInvitee->GetPlayerID());
-		pParty->Link(pchInvitee);
-		pParty->SendPartyInfoAllToOne(this);
-	}
-}
-
-void CHARACTER::PartyInviteDeny(DWORD dwPID)
-{
-	EventMap::iterator itFind = m_PartyInviteEventMap.find(dwPID);
-
-	if (itFind == m_PartyInviteEventMap.end())
-	{
-		sys_log(1, "PartyInviteDeny to not exist event(inviter PID: %d, invitee PID: %d)", GetPlayerID(), dwPID);
-		return;
-	}
-
-	event_cancel(&itFind->second);
-	m_PartyInviteEventMap.erase(itFind);
-
-	LPCHARACTER pchInvitee = CHARACTER_MANAGER::instance().FindByPID(dwPID);
-	if (pchInvitee)
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> %s Ƽ ʴ븦 ϼ̽ϴ.", pchInvitee->GetName()));
-}
-
-void CHARACTER::PartyJoin(LPCHARACTER pLeader)
-{
-	pLeader->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> %s Ƽ ϼ̽ϴ.", GetName()));
-	ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> %s Ƽ ϼ̽ϴ.", pLeader->GetName()));
-
-	pLeader->GetParty()->Join(GetPlayerID());
-	pLeader->GetParty()->Link(this);
-}
-
-CHARACTER::PartyJoinErrCode CHARACTER::IsPartyJoinableCondition(const LPCHARACTER pchLeader, const LPCHARACTER pchGuest)
-{
-	if (pchLeader->GetEmpire() != pchGuest->GetEmpire())
-		return PERR_DIFFEMPIRE;
-
-	return IsPartyJoinableMutableCondition(pchLeader, pchGuest);
-}
-
-static bool __party_can_join_by_level(LPCHARACTER leader, LPCHARACTER quest)
-{
-	int level_limit = 30;
-
-	if (LC_IsCanada())
-		level_limit = 15;
-	else if (LC_IsBrazil() == true)
-	{
-		level_limit = 10;
-	}
-	else
-		level_limit = 30;
-
-	return (abs(leader->GetLevel() - quest->GetLevel()) <= level_limit);
-}
-
-CHARACTER::PartyJoinErrCode CHARACTER::IsPartyJoinableMutableCondition(const LPCHARACTER pchLeader, const LPCHARACTER pchGuest)
-{
-	if (!CPartyManager::instance().IsEnablePCParty())
-		return PERR_SERVER;
-	else if (pchLeader->GetDungeon()
-#if defined(__GUILD_DRAGONLAIR_PARTY_SYSTEM__)
-		|| pchLeader->GetGuildDragonLair()
-#endif
-#if defined(__DEFENSE_WAVE__)
-		|| pchLeader->GetDefenseWave()
-#endif
-		)
-		return PERR_DUNGEON;
-	else if (pchGuest->IsObserverMode())
-		return PERR_OBSERVER;
-	else if (false == __party_can_join_by_level(pchLeader, pchGuest))
-		return PERR_LVBOUNDARY;
-	else if (pchGuest->GetParty())
-		return PERR_ALREADYJOIN;
-	else if (pchLeader->GetParty())
-	{
-		if (pchLeader->GetParty()->GetMemberCount() == PARTY_MAX_MEMBER)
-			return PERR_PARTYISFULL;
-	}
-
-	return PERR_NONE;
-}
-// END_OF_PARTY_JOIN_BUG_FIX
-
-void CHARACTER::SetDungeon(LPDUNGEON pkDungeon)
-{
-	if (pkDungeon && m_pkDungeon)
-		sys_err("%s is trying to reassigning dungeon (current %p, new party %p)", GetName(), get_pointer(m_pkDungeon), get_pointer(pkDungeon));
-
-	if (m_pkDungeon == pkDungeon)
-		return;
-
-	if (m_pkDungeon)
-	{
-		if (IsPC())
-		{
-			if (GetParty())
-				m_pkDungeon->DecPartyMember(GetParty(), this);
-			else
-				m_pkDungeon->DecMember(this);
-		}
-		else if (IsMonster() || IsStone())
-		{
-			m_pkDungeon->DecMonster();
-		}
-	}
-
-	m_pkDungeon = pkDungeon;
-
-	if (pkDungeon)
-	{
-		//sys_log(0, "%s DUNGEON set to %p, PARTY is %p", GetName(), get_pointer(pkDungeon), get_pointer(m_pkParty));
-
-		if (IsPC())
-		{
-			if (GetParty())
-				m_pkDungeon->IncPartyMember(GetParty(), this);
-			else
-				m_pkDungeon->IncMember(this);
-		}
-		else if (IsMonster() || IsStone())
-		{
-			m_pkDungeon->IncMonster();
-		}
-	}
-}
-
-void CHARACTER::SetWarMap(CWarMap* pWarMap)
-{
-	if (m_pWarMap)
-		m_pWarMap->DecMember(this);
-
-	m_pWarMap = pWarMap;
-
-	if (m_pWarMap)
-		m_pWarMap->IncMember(this);
-}
-
-void CHARACTER::SetWeddingMap(marriage::WeddingMap* pMap)
-{
-	if (m_pWeddingMap)
-		m_pWeddingMap->DecMember(this);
-
-	m_pWeddingMap = pMap;
-
-	if (m_pWeddingMap)
-		m_pWeddingMap->IncMember(this);
-}
-
-bool CHARACTER::IsWearingDress() const
-{
-	LPITEM pkItem = GetWear(WEAR_BODY);
-	if (pkItem && (pkItem->GetVnum() > 11900 && pkItem->GetVnum() < 11915))
-		return true;
-	return false;
-}
-
-void CHARACTER::SetRegen(LPREGEN pkRegen)
-{
-	m_pkRegen = pkRegen;
-	if (pkRegen != NULL)
-	{
-		regen_id_ = pkRegen->id;
-	}
-	m_fRegenAngle = GetRotation();
-	m_posRegen = GetXYZ();
-}
-
-bool CHARACTER::OnIdle()
-{
-	return false;
-}
-
-void CHARACTER::OnMove(bool bIsAttack)
-{
-	m_dwLastMoveTime = get_dword_time();
-#if defined(__LEFT_SEAT__)
-	m_dwLastRequestTime = get_dword_time();
-#endif
-
-	if (bIsAttack)
-	{
-		m_dwLastAttackTime = m_dwLastMoveTime;
-
-		if (IsAffectFlag(AFF_REVIVE_INVISIBLE))
-			RemoveAffect(AFFECT_REVIVE_INVISIBLE);
-
-		if (IsAffectFlag(AFF_EUNHYUNG))
-		{
-			RemoveAffect(SKILL_EUNHYUNG);
-			SetAffectedEunhyung();
-		}
-		else
-		{
-			ClearAffectedEunhyung();
-		}
-
-		/*
-		if (IsAffectFlag(AFF_JEONSIN))
-			RemoveAffect(SKILL_JEONSINBANGEO);
-		*/
-	}
-
-	/*
-	if (IsAffectFlag(AFF_GUNGON))
-		RemoveAffect(SKILL_GUNGON);
-	*/
-
-	// MINING
-	mining_cancel();
-	// END_OF_MINING
-}
-
-void CHARACTER::OnClick(LPCHARACTER pkChrCauser)
-{
-	if (!pkChrCauser)
-	{
-		sys_err("OnClick %s by NULL", GetName());
-		return;
-	}
-
-	DWORD vid = GetVID();
-	sys_log(0, "OnClick %s[vnum %d ServerUniqueID %d, pid %d] by %s", GetName(), GetRaceNum(), vid, GetPlayerID(), pkChrCauser->GetName());
-
-#ifdef ENABLE_QUEEN_NETHIS
-	if ((IsNPC()) && (GetRaceNum() == (WORD)(SnakeLair::PORTAL_VNUM)) && (SnakeLair::CSnk::instance().IsSnakeMap(pkChrCauser->GetMapIndex())))
-	{
-		SnakeLair::CSnk::instance().Start(pkChrCauser);
-		return;
-	}
-#endif
-
-	if (mining::IsVeinOfOre(this->GetRaceNum()))
-	{
-		pkChrCauser->mining(this);
-		return;
-	}
-
-	// ȯ϶ Ʈ   .
-	{
-		if (pkChrCauser->GetExchange())
-		{
-			if (test_server)
-				sys_err("OnClick Fail (%s->%s) - pc is exchanging", pkChrCauser->GetName(), GetName());
-			return;
-		}
-	}
-
-	//  · Ʈ   .
-	{
-		// , ڽ ڽ  Ŭ  ִ.
-		if (pkChrCauser->GetMyShop() && pkChrCauser != this)
-		{
-			if (test_server)
-				sys_err("OnClick Fail (%s->%s) - pc has shop", pkChrCauser->GetName(), GetName());
-			return;
-		}
-	}
-
-	if (IsPC())
-	{
-		// Ÿ   PC  Ŭ Ʈ óϵ մϴ.
-		if (!CTargetManager::instance().GetTargetInfo(pkChrCauser->GetPlayerID(), TARGET_TYPE_VID, GetVID()))
-		{
-			// 20050317.myevan.Ÿ ƴ    ó  ۵Ų.
-			if (GetMyShop())
-			{
-				if (pkChrCauser->IsDead() == true) return;
-
-#ifdef __GROWTH_PET_SYSTEM__
-				if (pkChrCauser->GetPetWindowType() == PET_WINDOW_ATTR_CHANGE || pkChrCauser->GetPetWindowType() == PET_WINDOW_PRIMIUM_FEEDSTUFF)
-				{
-					pkChrCauser->ChatPacket(CHAT_TYPE_INFO, LC_STRING("PET_STATLARINI_DEGISTIRME_UYARI"));
-					return;
-				}
-#endif
-
-				// PREVENT_TRADE_WINDOW
-				if (pkChrCauser == this) // ڱ 
-				{
-					if (PreventTradeWindow(WND_MYSHOP, true/*except*/))
-					{
-						pkChrCauser->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ٸ ŷ(â,ȯ,) λ   ϴ."));
-						return;
-					}
-				}
-				else // ٸ  Ŭ
-				{
-					// Ŭ  ȯ/â/λ/̶̿ Ұ
-					if (pkChrCauser->PreventTradeWindow(WND_ALL))
-					{
-						pkChrCauser->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ٸ ŷ(â,ȯ,) λ   ϴ."));
-						return;
-					}
-
-					// Ŭ  ȯ/â/̶̿ Ұ
-					//if ((GetExchange() || IsOpenSafebox() || GetShopOwner()))
-					if (PreventTradeWindow(WND_MYSHOP | WND_SHOPOWNER, true/*except*/))
-					{
-						pkChrCauser->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ٸ ŷ ϰ ִ Դϴ."));
-						return;
-					}
-				}
-				// END_PREVENT_TRADE_WINDOW
-
-				if (pkChrCauser->GetShop())
-				{
-					pkChrCauser->GetShop()->RemoveGuest(pkChrCauser);
-					pkChrCauser->SetShop(NULL);
-				}
-
-				GetMyShop()->AddGuest(pkChrCauser, GetVID(), false);
-				pkChrCauser->SetShopOwner(this);
-				return;
-			}
-
-			if (test_server)
-				sys_err("%s.OnClickFailure(%s) - target is PC", pkChrCauser->GetName(), GetName());
-
-			return;
-		}
-	}
-
-#ifdef __OFFLINE_SHOP__
-	if (GetRaceNum() >= 30000 && GetRaceNum() <= 30008)
-	{
-		auto offlineShopPtr = COfflineShop::Get(GetKeepingOfflineShop());
-		if (offlineShopPtr) {
-			offlineShopPtr->get()->AddViewer(pkChrCauser);
-			return;
-		}
-	}
-#endif
-
-#ifdef __GROWTH_PET_SYSTEM__
-	if (pkChrCauser->GetPetWindowType() == PET_WINDOW_ATTR_CHANGE || pkChrCauser->GetPetWindowType() == PET_WINDOW_PRIMIUM_FEEDSTUFF)
-	{
-		pkChrCauser->ChatPacket(CHAT_TYPE_INFO, LC_STRING("PET_STATLARINI_DEGISTIRIRKEN_NPC_ACAMAZSIN"));
-		return;
-	}
-#endif
-
-	if (!pkChrCauser->IsDead())
-	{
-		pkChrCauser->SetQuestNPCID(GetVID());
-
-		if (quest::CQuestManager::instance().Click(pkChrCauser->GetPlayerID(), this))
-			return;
-	}
-
-	// NPC    :   
-	if (!IsPC())
-	{
-		if (!m_triggerOnClick.pFunc)
-		{
-			// NPC Ʈ ý α 
-			/*
-			sys_err("%s.OnClickFailure(%s) : triggerOnClick.pFunc is EMPTY(pid=%d)",
-				pkChrCauser->GetName(),
-				GetName(),
-				pkChrCauser->GetPlayerID());
-			*/
-			return;
-		}
-
-		m_triggerOnClick.pFunc(this, pkChrCauser);
-	}
-}
-
-BYTE CHARACTER::GetGMLevel() const
-{
-	if (test_server)
-		return GM_IMPLEMENTOR;
-	return m_pointsInstant.gm_level;
-}
-
-void CHARACTER::SetGMLevel()
-{
-	if (GetDesc())
-	{
-		BYTE myLevel = gm_get_level(GetName(), GetDesc()->GetHostName(), GetDesc()->GetAccountTable().login);
-		m_pointsInstant.gm_level = myLevel;
-	}
-	else
-	{
-		m_pointsInstant.gm_level = GM_PLAYER;
-	}
-}
-
-BOOL CHARACTER::IsGM() const
-{
-	if (test_server)
-		return true;
-
-	if (GetGMLevel() != GM_PLAYER)
-		return true;
-
-	return false;
-}
-
-void CHARACTER::SetStone(LPCHARACTER pkChrStone)
-{
-	m_pkChrStone = pkChrStone;
-
-	if (m_pkChrStone)
-	{
-		if (pkChrStone->m_set_pkChrSpawnedBy.find(this) == pkChrStone->m_set_pkChrSpawnedBy.end())
-			pkChrStone->m_set_pkChrSpawnedBy.insert(this);
-	}
-}
-
-struct FuncDeadSpawnedByStone
-{
-	void operator () (LPCHARACTER ch)
-	{
-		ch->Dead(NULL);
-		ch->SetStone(NULL);
-	}
-};
-
-void CHARACTER::ClearStone()
-{
-	if (!m_set_pkChrSpawnedBy.empty())
-	{
-		//  Ų ͵  δ.
-		FuncDeadSpawnedByStone f;
-		std::for_each(m_set_pkChrSpawnedBy.begin(), m_set_pkChrSpawnedBy.end(), f);
-		m_set_pkChrSpawnedBy.clear();
-	}
-
-	if (!m_pkChrStone)
-		return;
-
-	m_pkChrStone->m_set_pkChrSpawnedBy.erase(this);
-	m_pkChrStone = NULL;
-}
-
-LPCHARACTER CHARACTER::GetTargetSafe()
-{
-	if (!m_pkChrTarget)
-		return nullptr;
-
-	if (m_dwTargetVID == 0)
-		return m_pkChrTarget;
-
-	LPCHARACTER pkReal = CHARACTER_MANAGER::instance().Find(m_dwTargetVID);
-	if (pkReal != m_pkChrTarget)
-	{
-		// Target disappeared or was replaced; clear locally without dereferencing a stale pointer.
-		m_pkChrTarget = nullptr;
-		m_dwTargetVID = 0;
-		return nullptr;
-	}
-
-	return m_pkChrTarget;
-}
-
-void CHARACTER::ClearTarget()
-{
-	if (m_pkChrTarget)
-	{
-		LPCHARACTER pkReal = (m_dwTargetVID ? CHARACTER_MANAGER::instance().Find(m_dwTargetVID) : nullptr);
-		if (pkReal == m_pkChrTarget)
-			pkReal->m_set_pkChrTargetedBy.erase(this);
-		m_pkChrTarget = NULL;
-		m_dwTargetVID = 0;
-	}
-
-	TPacketGCTarget p;
-
-	p.header = HEADER_GC_TARGET;
-	p.dwVID = 0;
-	p.bHPPercent = 0;
-#if defined(__VIEW_TARGET_HP__) || defined(__DEFENSE_WAVE__)
-	p.iMinHP = 0;
-	p.iMaxHP = 0;
-	p.bAlliance = false;
-#endif
-#if defined(__ELEMENT_SYSTEM__)
-	memset(&p.bElement, 0, sizeof(p.bElement));
-#endif
-
-	CHARACTER_SET::iterator it = m_set_pkChrTargetedBy.begin();
-
-	while (it != m_set_pkChrTargetedBy.end())
-	{
-		LPCHARACTER pkChr = *(it++);
-		pkChr->m_pkChrTarget = NULL;
-
-		if (!pkChr->GetDesc())
-		{
-			sys_err("%s %p does not have desc", pkChr->GetName(), get_pointer(pkChr));
-			abort();
-		}
-
-		pkChr->GetDesc()->Packet(&p, sizeof(TPacketGCTarget));
-	}
-
-	m_set_pkChrTargetedBy.clear();
-}
-
-void CHARACTER::SetTarget(LPCHARACTER pkChrTarget)
-{
-	if (m_pkChrTarget == pkChrTarget)
-		return;
-
-	// CASTLE
-	if (IS_CASTLE_MAP(GetMapIndex()) && !IsGM())
-		return;
-	// CASTLE
-
-	if (m_pkChrTarget)
-	{
-		LPCHARACTER pkReal = (m_dwTargetVID ? CHARACTER_MANAGER::instance().Find(m_dwTargetVID) : nullptr);
-		if (pkReal == m_pkChrTarget)
-			pkReal->m_set_pkChrTargetedBy.erase(this);
-	}
-
-	m_pkChrTarget = pkChrTarget;
-	m_dwTargetVID = m_pkChrTarget ? m_pkChrTarget->GetVID() : 0;
-
-	TPacketGCTarget p;
-
-	p.header = HEADER_GC_TARGET;
-
-	if (m_pkChrTarget)
-	{
-		m_pkChrTarget->m_set_pkChrTargetedBy.insert(this);
-
-		p.dwVID = m_pkChrTarget->GetVID();
-
-#if defined(__VIEW_TARGET_PLAYER_HP__)
-		if ((m_pkChrTarget->GetMaxHP() <= 0))
-		{
-			p.bHPPercent = 0;
-#if defined(__VIEW_TARGET_HP__) || defined(__DEFENSE_WAVE__)
-			p.iMinHP = 0;
-			p.iMaxHP = 0;
-#endif
-		}
-		else if (m_pkChrTarget->IsPC() && !m_pkChrTarget->IsPolymorphed())
-		{
-			p.bHPPercent = MINMAX(0, (static_cast<int64_t>(GetHP()) * 100) / GetMaxHP(), 100);
-#if defined(__VIEW_TARGET_HP__)
-			p.iMinHP = m_pkChrTarget->GetHP();
-			p.iMaxHP = m_pkChrTarget->GetMaxHP();
-#endif
-		}
-#else
-		if ((m_pkChrTarget->IsPC() && !m_pkChrTarget->IsPolymorphed()) || (m_pkChrTarget->GetMaxHP() <= 0))
-		{
-			p.bHPPercent = 0;
-#if defined(__VIEW_TARGET_HP__)
-			p.iMinHP = 0;
-			p.iMaxHP = 0;
-#endif
-		}
-#endif
-		else
-		{
-			if (m_pkChrTarget->GetRaceNum() == 20101 ||
-				m_pkChrTarget->GetRaceNum() == 20102 ||
-				m_pkChrTarget->GetRaceNum() == 20103 ||
-				m_pkChrTarget->GetRaceNum() == 20104 ||
-				m_pkChrTarget->GetRaceNum() == 20105 ||
-				m_pkChrTarget->GetRaceNum() == 20106 ||
-				m_pkChrTarget->GetRaceNum() == 20107 ||
-				m_pkChrTarget->GetRaceNum() == 20108 ||
-				m_pkChrTarget->GetRaceNum() == 20109)
-			{
-				LPCHARACTER owner = m_pkChrTarget->GetVictim();
-
-				if (owner)
-				{
-					int iHorseHealth = owner->GetHorseHealth();
-					int iHorseMaxHealth = owner->GetHorseMaxHealth();
-
-					if (iHorseMaxHealth)
-					{
-						p.bHPPercent = MINMAX(0, iHorseHealth * 100 / iHorseMaxHealth, 100);
-#if defined(__VIEW_TARGET_HP__)
-						p.iMinHP = 100;
-						p.iMaxHP = 100;
-#endif
-					}
-					else
-					{
-						p.bHPPercent = 100;
-#if defined(__VIEW_TARGET_HP__)
-						p.iMinHP = 100;
-						p.iMaxHP = 100;
-#endif
-					}
-				}
-				else
-				{
-					p.bHPPercent = 100;
-#if defined(__VIEW_TARGET_HP__)
-					p.iMinHP = 100;
-					p.iMaxHP = 100;
-#endif
-				}
-			}
-			else
-			{
-				if (m_pkChrTarget->GetMaxHP() <= 0)
-				{
-					p.bHPPercent = 0;
-#if defined(__VIEW_TARGET_HP__)
-					p.iMinHP = 0;
-					p.iMaxHP = 0;
-#endif
-				}
-				else
-				{
-					p.bHPPercent = MINMAX(0, (static_cast<int64_t>(m_pkChrTarget->GetHP()) * 100) / m_pkChrTarget->GetMaxHP(), 100);
-#if defined(__VIEW_TARGET_HP__)
-					p.iMinHP = m_pkChrTarget->GetHP();
-					p.iMaxHP = m_pkChrTarget->GetMaxHP();
-#endif
-				}
-			}
-		}
-	}
-	else
-	{
-		p.dwVID = 0;
-		p.bHPPercent = 0;
-#if defined(__VIEW_TARGET_HP__)
-		p.iMinHP = 0;
-		p.iMaxHP = 0;
-#endif
-	}
-
-#if defined(__ELEMENT_SYSTEM__)
-	memset(&p.bElement, 0, sizeof(p.bElement));
-	if (m_pkChrTarget)
-	{
-		if (m_pkChrTarget->IsPC())
-		{
-			p.bElement[MOB_ELEMENT_ELECT] = m_pkChrTarget->GetPoint(POINT_ENCHANT_ELECT);
-			p.bElement[MOB_ELEMENT_FIRE] = m_pkChrTarget->GetPoint(POINT_ENCHANT_FIRE);
-			p.bElement[MOB_ELEMENT_ICE] = m_pkChrTarget->GetPoint(POINT_ENCHANT_ICE);
-			p.bElement[MOB_ELEMENT_WIND] = m_pkChrTarget->GetPoint(POINT_ENCHANT_WIND);
-			p.bElement[MOB_ELEMENT_EARTH] = m_pkChrTarget->GetPoint(POINT_ENCHANT_EARTH);
-			p.bElement[MOB_ELEMENT_DARK] = m_pkChrTarget->GetPoint(POINT_ENCHANT_DARK);
-		}
-		else
-		{
-			p.bElement[MOB_ELEMENT_ELECT] = m_pkChrTarget->GetMobElement(MOB_ELEMENT_ELECT);
-			p.bElement[MOB_ELEMENT_FIRE] = m_pkChrTarget->GetMobElement(MOB_ELEMENT_FIRE);
-			p.bElement[MOB_ELEMENT_ICE] = m_pkChrTarget->GetMobElement(MOB_ELEMENT_ICE);
-			p.bElement[MOB_ELEMENT_WIND] = m_pkChrTarget->GetMobElement(MOB_ELEMENT_WIND);
-			p.bElement[MOB_ELEMENT_EARTH] = m_pkChrTarget->GetMobElement(MOB_ELEMENT_EARTH);
-			p.bElement[MOB_ELEMENT_DARK] = m_pkChrTarget->GetMobElement(MOB_ELEMENT_DARK);
-		}
-	}
-#endif
-
-#if defined(__DEFENSE_WAVE__)
-	p.bAlliance = false;
-#endif
-
-	GetDesc()->Packet(&p, sizeof(TPacketGCTarget));
-}
-
-void CHARACTER::BroadcastTargetPacket()
-{
-	if (m_set_pkChrTargetedBy.empty())
-		return;
-
-	TPacketGCTarget p;
-
-	p.header = HEADER_GC_TARGET;
-	p.dwVID = GetVID();
-
-	if (GetMaxHP() <= 0)
-	{
-		p.bHPPercent = 0;
-#if defined(__VIEW_TARGET_HP__)
-		p.iMinHP = 0;
-		p.iMaxHP = 0;
-#endif
-	}
-	else
-	{
-#if defined(__VIEW_TARGET_PLAYER_HP__)
-		p.bHPPercent = MINMAX(0, (static_cast<int64_t>(GetHP()) * 100) / GetMaxHP(), 100);
-#if defined(__VIEW_TARGET_HP__)
-		p.iMinHP = GetHP();
-		p.iMaxHP = GetMaxHP();
-#endif
-#else
-		if (IsPC())
-		{
-			p.bHPPercent = 0;
-#if defined(__VIEW_TARGET_HP__)
-			p.dwMinHP = 0;
-			p.dwMaxHP = 0;
-#endif
-		}
-		else
-		{
-			p.bHPPercent = MINMAX(0, (static_cast<int64_t>(GetHP()) * 100) / GetMaxHP(), 100);
-#if defined(__VIEW_TARGET_HP__)
-			p.dwMinHP = GetHP();
-			p.dwMaxHP = GetMaxHP();
-#endif
-		}
-#endif
-	}
-
-#if defined(__ELEMENT_SYSTEM__)
-	memset(&p.bElement, 0, sizeof(p.bElement));
-
-	if (IsPC())
-	{
-		p.bElement[MOB_ELEMENT_ELECT] = GetPoint(POINT_ENCHANT_ELECT);
-		p.bElement[MOB_ELEMENT_FIRE] = GetPoint(POINT_ENCHANT_FIRE);
-		p.bElement[MOB_ELEMENT_ICE] = GetPoint(POINT_ENCHANT_ICE);
-		p.bElement[MOB_ELEMENT_WIND] = GetPoint(POINT_ENCHANT_WIND);
-		p.bElement[MOB_ELEMENT_EARTH] = GetPoint(POINT_ENCHANT_EARTH);
-		p.bElement[MOB_ELEMENT_DARK] = GetPoint(POINT_ENCHANT_DARK);
-	}
-	else
-	{
-		p.bElement[MOB_ELEMENT_ELECT] = GetMobElement(MOB_ELEMENT_ELECT);
-		p.bElement[MOB_ELEMENT_FIRE] = GetMobElement(MOB_ELEMENT_FIRE);
-		p.bElement[MOB_ELEMENT_ICE] = GetMobElement(MOB_ELEMENT_ICE);
-		p.bElement[MOB_ELEMENT_WIND] = GetMobElement(MOB_ELEMENT_WIND);
-		p.bElement[MOB_ELEMENT_EARTH] = GetMobElement(MOB_ELEMENT_EARTH);
-		p.bElement[MOB_ELEMENT_DARK] = GetMobElement(MOB_ELEMENT_DARK);
-	}
-#endif
-
-#if defined(__DEFENSE_WAVE__)
-	p.bAlliance = false;
-#endif
-
-	CHARACTER_SET::iterator it = m_set_pkChrTargetedBy.begin();
-
-	while (it != m_set_pkChrTargetedBy.end())
-	{
-		LPCHARACTER pkChr = *it++;
-
-		if (!pkChr->GetDesc())
-		{
-			sys_err("%s %p does not have desc", pkChr->GetName(), get_pointer(pkChr));
-			abort();
-		}
-
-		pkChr->GetDesc()->Packet(&p, sizeof(TPacketGCTarget));
-	}
-}
-
-void CHARACTER::CheckTarget()
-{
-	LPCHARACTER pkTarget = GetTargetSafe();
-	if (!pkTarget)
-		return;
-
-	if (DISTANCE_APPROX(GetX() - pkTarget->GetX(), GetY() - pkTarget->GetY()) >= 4800)
-		SetTarget(NULL);
-}
-
-void CHARACTER::SetWarpLocation(long lMapIndex, long x, long y)
-{
-	m_posWarp.x = x * 100;
-	m_posWarp.y = y * 100;
-	m_lWarpMapIndex = lMapIndex;
-}
-
-void CHARACTER::SaveExitLocation()
-{
-	m_posExit = GetXYZ();
-	m_lExitMapIndex = GetMapIndex();
-}
-
-void CHARACTER::ExitToSavedLocation()
-{
-	sys_log(0, "ExitToSavedLocation");
-	WarpSet(m_posWarp.x, m_posWarp.y, m_lWarpMapIndex);
-
-	m_posExit.x = m_posExit.y = m_posExit.z = 0;
-	m_lExitMapIndex = 0;
-}
-
-// fixme
-// ݱ privateMapIndex    ε  üũ ϴ  ܺο ϰ,
-// ٸ warpset ҷµ
-// ̸ warpset  .
-bool CHARACTER::WarpSet(long x, long y, long lPrivateMapIndex)
-{
-	if (!IsPC())
-		return false;
-
-	long lAddr;
-	long lMapIndex;
-	WORD wPort;
-
-	if (!CMapLocation::instance().Get(x, y, lMapIndex, lAddr, wPort))
-	{
-		sys_err("cannot find map location index %d x %d y %d name %s", lMapIndex, x, y, GetName());
-		return false;
-	}
-
-	// Send Supplementary Data Block if new map requires security packages in loading this map
-	{
-		long lCurAddr;
-		long lCurMapIndex = 0;
-		WORD wCurPort;
-
-		CMapLocation::instance().Get(GetX(), GetY(), lCurMapIndex, lCurAddr, wCurPort);
-
-		// Do not send SDB files if char is in the same map
-		if (lCurMapIndex != lMapIndex)
-		{
-			const TMapRegion* rMapRgn = SECTREE_MANAGER::instance().GetMapRegion(lMapIndex);
-			{
-				DESC_MANAGER::instance().SendClientPackageSDBToLoadMap(GetDesc(), rMapRgn->strMapName.c_str());
-			}
-		}
-	}
-
-	if (lPrivateMapIndex >= 10000)
-	{
-		if (lPrivateMapIndex / 10000 != lMapIndex)
-		{
-			sys_err("Invalid map index %d, must be child of %d", lPrivateMapIndex, lMapIndex);
-			return false;
-		}
-
-		lMapIndex = lPrivateMapIndex;
-	}
-
-	Stop();
-	Save();
-
-	if (GetSectree())
-	{
-		GetSectree()->RemoveEntity(this);
-		ViewCleanup();
-
-		EncodeRemovePacket(this);
-	}
-
-	m_lWarpMapIndex = lMapIndex;
-	m_posWarp.x = x;
-	m_posWarp.y = y;
-
-	sys_log(0, "WarpSet %s %d %d current map %d target map %d", GetName(), x, y, GetMapIndex(), lMapIndex);
-
-	TPacketGCWarp p;
-
-	p.bHeader = HEADER_GC_WARP;
-	p.lX = x;
-	p.lY = y;
-#if defined(__PROXY_IP__)
-	p.lAddr = g_stProxyIP.empty() ? lAddr : inet_addr(g_stProxyIP.c_str());
-#else
-	p.lAddr = lAddr;
-#endif
-	p.wPort = wPort;
-
-	GetDesc()->Packet(&p, sizeof(TPacketGCWarp));
-
-	char buf[256];
-	snprintf(buf, sizeof(buf), "%s MapIdx %ld DestMapIdx%ld DestX%ld DestY%ld Empire%d", GetName(), GetMapIndex(), lPrivateMapIndex, x, y, GetEmpire());
-	LogManager::instance().CharLog(this, 0, "WARP", buf);
-
-	return true;
-}
-
-void CHARACTER::WarpEnd()
-{
-	if (test_server)
-		sys_log(0, "WarpEnd %s", GetName());
-
-	if (m_posWarp.x == 0 && m_posWarp.y == 0)
-		return;
-
-	int index = m_lWarpMapIndex;
-
-	if (index > 10000)
-		index /= 10000;
-
-	if (!map_allow_find(index))
-	{
-		//     Ƿ ϱ  ǥ ǵ.
-		sys_err("location %d %d not allowed to login this server", m_posWarp.x, m_posWarp.y);
-		if (g_bIgnoreDisallowedMap) // 20200807.Owsap : Go home if map index isn't allowed.
-			GoHome();
-		else
-			GetDesc()->SetPhase(PHASE_CLOSE);
-
-		return;
-	}
-
-	sys_log(0, "WarpEnd %s %d %u %u", GetName(), m_lWarpMapIndex, m_posWarp.x, m_posWarp.y);
-
-	Show(m_lWarpMapIndex, m_posWarp.x, m_posWarp.y, 0);
-	Stop();
-
-	m_lWarpMapIndex = 0;
-	m_posWarp.x = m_posWarp.y = m_posWarp.z = 0;
-
-	{
-		// P2P Login
-		TPacketGGLogin p;
-
-		p.bHeader = HEADER_GG_LOGIN;
-		strlcpy(p.szName, GetName(), sizeof(p.szName));
-		p.dwPID = GetPlayerID();
-		p.bEmpire = GetEmpire();
-		p.lMapIndex = SECTREE_MANAGER::instance().GetMapIndex(GetX(), GetY());
-		p.bChannel = g_bChannel;
-
-		P2P_MANAGER::instance().Send(&p, sizeof(TPacketGGLogin));
-	}
-}
-
-bool CHARACTER::Return()
-{
-	if (!IsNPC())
-		return false;
-
-	int x, y;
-	/*
-	float fDist = DISTANCE_SQRT(m_pkMobData->m_posLastAttacked.x - GetX(), m_pkMobData->m_posLastAttacked.y - GetY());
-	float fx, fy;
-	GetDeltaByDegree(GetRotation(), fDist, &fx, &fy);
-	x = GetX() + (int)fx;
-	y = GetY() + (int)fy;
-	*/
-	SetVictim(NULL);
-
-	x = m_pkMobInst->m_posLastAttacked.x;
-	y = m_pkMobInst->m_posLastAttacked.y;
-
-	SetRotationToXY(x, y);
-
-	if (!Goto(x, y))
-		return false;
-
-	SendMovePacket(FUNC_WAIT, 0, 0, 0, 0);
-
-	if (test_server)
-		sys_log(0, "%s %p ϰ ư! %d %d", GetName(), this, x, y);
-
-	if (GetParty())
-		GetParty()->SendMessage(this, PM_RETURN, x, y);
-
-	return true;
-}
-
-bool CHARACTER::Follow(LPCHARACTER pkChr, float fMinDistance)
-{
-	if (IsPC())
-	{
-		sys_err("CHARACTER::Follow : PC cannot use this method", GetName());
-		return false;
-	}
-
-	// TRENT_MONSTER
-	if (IsNoMove())
-	{
-		if (pkChr->IsPC()) // Ѿư 밡 PC 
-		{
-			// If i'm in a party. I must obey party leader's AI.
-			if (!GetParty() || !GetParty()->GetLeader() || GetParty()->GetLeader() == this)
-			{
-				if (get_dword_time() - m_pkMobInst->m_dwLastAttackedTime >= 15000) //  ݹ 15ʰ 
-				{
-					//     50 ̻ ̳ ϰ ư.
-					if (m_pkMobData->m_table.wAttackRange < DISTANCE_APPROX(pkChr->GetX() - GetX(), pkChr->GetY() - GetY()))
-						if (Return())
-							return true;
-				}
-			}
-		}
-		return false;
-	}
-	// END_OF_TRENT_MONSTER
-
-	long x = pkChr->GetX();
-	long y = pkChr->GetY();
-
-	if (pkChr->IsPC()) // Ѿư 밡 PC 
-	{
-		// If i'm in a party. I must obey party leader's AI.
-		if (!GetParty() || !GetParty()->GetLeader() || GetParty()->GetLeader() == this)
-		{
-			if (get_dword_time() - m_pkMobInst->m_dwLastAttackedTime >= 15000) //  ݹ 15ʰ 
-			{
-				//     50 ̻ ̳ ϰ ư.
-				if (5000 < DISTANCE_APPROX(m_pkMobInst->m_posLastAttacked.x - GetX(), m_pkMobInst->m_posLastAttacked.y - GetY()))
-					if (Return())
-						return true;
-			}
-		}
-	}
-
-	if (IsGuardNPC())
-	{
-		if (5000 < DISTANCE_APPROX(m_pkMobInst->m_posLastAttacked.x - GetX(), m_pkMobInst->m_posLastAttacked.y - GetY()))
-			if (Return())
-				return true;
-	}
-
-	SECTREE* sectree = pkChr->GetSectree();
-	if (sectree && sectree->IsAttr(pkChr->GetX(), pkChr->GetY(), ATTR_BANPK))
-		if (Return())
-			return true;
-
-	if (pkChr->IsState(pkChr->m_stateMove) &&
-		GetMobBattleType() != BATTLE_TYPE_RANGE &&
-		GetMobBattleType() != BATTLE_TYPE_MAGIC
-#if defined(__PET_SYSTEM__)
-		&& false == IsPet()
-#endif
-		)
-	{
-		//  ̵̸  ̵ Ѵ
-		//   ӵ Ÿκ  ð  
-		//   ð  ̵Ѵٰ Ͽ ű ̵Ѵ.
-		float rot = pkChr->GetRotation();
-		float rot_delta = GetDegreeDelta(rot, GetDegreeFromPositionXY(GetX(), GetY(), pkChr->GetX(), pkChr->GetY()));
-
-		float yourSpeed = pkChr->GetMoveSpeed();
-		float mySpeed = GetMoveSpeed();
-
-		float fDist = DISTANCE_SQRT(x - GetX(), y - GetY());
-		float fFollowSpeed = mySpeed - yourSpeed * cos(rot_delta * M_PI / 180);
-
-		if (fFollowSpeed >= 0.1f)
-		{
-			float fMeetTime = fDist / fFollowSpeed;
-			float fYourMoveEstimateX, fYourMoveEstimateY;
-
-			if (fMeetTime * yourSpeed <= 100000.0f)
-			{
-				GetDeltaByDegree(pkChr->GetRotation(), fMeetTime * yourSpeed, &fYourMoveEstimateX, &fYourMoveEstimateY);
-
-				x += (long)fYourMoveEstimateX;
-				y += (long)fYourMoveEstimateY;
-
-				float fDistNew = sqrt(((double)x - GetX()) * (x - GetX()) + ((double)y - GetY()) * (y - GetY()));
-				if (fDist < fDistNew)
-				{
-					x = (long)(GetX() + (x - GetX()) * fDist / fDistNew);
-					y = (long)(GetY() + (y - GetY()) * fDist / fDistNew);
-				}
-			}
-		}
-	}
-
-	//  ġ ٶ Ѵ.
-	SetRotationToXY(x, y);
-
-	float fDist = DISTANCE_SQRT(x - GetX(), y - GetY());
-
-	if (fDist <= fMinDistance)
-		return false;
-
-	float fx, fy;
-
-	if (IsChangeAttackPosition(pkChr) && GetMobRank() < MOB_RANK_BOSS)
-	{
-		//  ֺ   ̵
-		SetChangeAttackPositionTime();
-
-		int retry = 16;
-		int dx, dy;
-		int rot = (int)GetDegreeFromPositionXY(x, y, GetX(), GetY());
-
-		while (--retry)
-		{
-			if (fDist < 500.0f)
-				GetDeltaByDegree((rot + number(-90, 90) + number(-90, 90)) % 360, fMinDistance, &fx, &fy);
-			else
-				GetDeltaByDegree(number(0, 359), fMinDistance, &fx, &fy);
-
-			dx = x + (int)fx;
-			dy = y + (int)fy;
-
-			LPSECTREE tree = SECTREE_MANAGER::instance().Get(GetMapIndex(), dx, dy);
-			if (NULL == tree)
-				break;
-
-			if (0 == (tree->GetAttribute(dx, dy) & (ATTR_BLOCK | ATTR_OBJECT)))
-				break;
-		}
-
-		//sys_log(0, "ó 򰡷 ̵ %s retry %d", GetName(), retry);
-		if (!Goto(dx, dy))
-			return false;
-	}
-	else
-	{
-		//  󰡱
-		float fDistToGo = fDist - fMinDistance;
-		GetDeltaByDegree(GetRotation(), fDistToGo, &fx, &fy);
-
-		//sys_log(0, " ̵ %s", GetName());
-		if (!Goto(GetX() + (int)fx, GetY() + (int)fy))
-			return false;
-	}
-
-	SendMovePacket(FUNC_WAIT, 0, 0, 0, 0);
-	//MonsterLog("Ѿư; %s", pkChr->GetName());
-	return true;
-}
-
-float CHARACTER::GetDistanceFromSafeboxOpen() const
-{
-	return DISTANCE_APPROX(GetX() - m_posSafeboxOpen.x, GetY() - m_posSafeboxOpen.y);
-}
-
-void CHARACTER::SetSafeboxOpenPosition()
-{
-	m_posSafeboxOpen = GetXYZ();
-}
-
-CSafebox* CHARACTER::GetSafebox() const
-{
-	return m_pkSafebox;
-}
-
-void CHARACTER::ReqSafeboxLoad(const char* pszPassword)
-{
-#ifdef __GROWTH_PET_SYSTEM__
-	if (GetPetWindowType() == PET_WINDOW_ATTR_CHANGE || GetPetWindowType() == PET_WINDOW_PRIMIUM_FEEDSTUFF)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("PET_STATLARINI_DEGISTIRME_UYARI"));
-		return;
-	}
-#endif
-	if (!*pszPassword || strlen(pszPassword) > SAFEBOX_PASSWORD_MAX_LEN)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("<â> ߸ ȣ Էϼ̽ϴ."));
-		return;
-	}
-	else if (m_pkSafebox)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("<â> â ̹ ֽϴ."));
-		return;
-	}
-
-	int iPulse = thecore_pulse();
-	if (iPulse - GetSafeboxLoadTime() < PASSES_PER_SEC(10))
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("<â> â  10 ȿ   ϴ."));
-		return;
-	}
-	else if (GetDistanceFromSafeboxOpen() > 1000)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("<â> Ÿ ־ â   ϴ."));
-		return;
-	}
-	else if (m_bOpeningSafebox)
-	{
-		sys_log(0, "Overlapped safebox load request from %s", GetName());
-		return;
-	}
-
-	SetSafeboxLoadTime();
-	m_bOpeningSafebox = true;
-
-	TSafeboxLoadPacket p;
-	p.dwID = GetDesc()->GetAccountTable().id;
-	strlcpy(p.szLogin, GetDesc()->GetAccountTable().login, sizeof(p.szLogin));
-	strlcpy(p.szPassword, pszPassword, sizeof(p.szPassword));
-
-	db_clientdesc->DBPacket(HEADER_GD_SAFEBOX_LOAD, GetDesc()->GetHandle(), &p, sizeof(p));
-}
-
-void CHARACTER::LoadSafebox(int iSize, DWORD dwGold, int iItemCount, TPlayerItem* pItems)
-{
-	bool bLoaded = false;
-
-	// PREVENT_TRADE_WINDOW
-	SetOpenSafebox(true);
-	// END_PREVENT_TRADE_WINDOW
-
-	if (m_pkSafebox)
-		bLoaded = true;
-
-	if (!m_pkSafebox)
-		m_pkSafebox = M2_NEW CSafebox(this, iSize, dwGold);
-	else
-		m_pkSafebox->ChangeSize(iSize);
-
-	m_iSafeboxSize = iSize;
-
-	TPacketCGSafeboxSize p;
-	p.bHeader = HEADER_GC_SAFEBOX_SIZE;
-	p.bSize = iSize;
-
-	GetDesc()->Packet(&p, sizeof(TPacketCGSafeboxSize));
-
-	if (!bLoaded)
-	{
-		for (int i = 0; i < iItemCount; ++i, ++pItems)
-		{
-			if (!m_pkSafebox->IsValidPosition(pItems->wPos))
-				continue;
-
-			LPITEM item = ITEM_MANAGER::instance().CreateItem(pItems->dwVnum, pItems->dwCount, pItems->dwID);
-			if (!item)
-			{
-				sys_err("cannot create item vnum %d id %u (name: %s)", pItems->dwVnum, pItems->dwID, GetName());
-				continue;
-			}
-
-			item->SetSkipSave(true);
-#if defined(__SOUL_BIND_SYSTEM__)
-			item->SealItem(pItems->lSealDate);
-#endif
-			item->SetSockets(pItems->alSockets);
-			item->SetAttributes(pItems->aAttr);
-#if defined(__CHANGE_LOOK_SYSTEM__)
-			item->SetTransmutationVnum(pItems->dwTransmutationVnum);
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-			item->SetRefineElement(&pItems->RefineElement);
-#endif
-#if defined(__ITEM_APPLY_RANDOM__)
-			item->SetRandomApplies(pItems->aApplyRandom);
-#endif
-#if defined(__SET_ITEM__)
-			item->SetItemSetValue(pItems->bSetValue);
-#endif
-
-			if (!m_pkSafebox->Add(pItems->wPos, item))
-			{
-				M2_DESTROY_ITEM(item);
-			}
-			else
-				item->SetSkipSave(false);
-		}
-	}
-}
-
-void CHARACTER::ChangeSafeboxSize(BYTE bSize)
-{
-	//if (!m_pkSafebox)
-	//	return;
-
-	TPacketCGSafeboxSize p;
-	p.bHeader = HEADER_GC_SAFEBOX_SIZE;
-	p.bSize = bSize;
-
-	GetDesc()->Packet(&p, sizeof(TPacketCGSafeboxSize));
-
-	if (m_pkSafebox)
-		m_pkSafebox->ChangeSize(bSize);
-
-	m_iSafeboxSize = bSize;
-}
-
-void CHARACTER::CloseSafebox()
-{
-	if (!m_pkSafebox)
-		return;
-
-	// PREVENT_TRADE_WINDOW
-	SetOpenSafebox(false);
-	// END_PREVENT_TRADE_WINDOW
-
-	m_pkSafebox->Save();
-
-	M2_DELETE(m_pkSafebox);
-	m_pkSafebox = NULL;
-
-	ChatPacket(CHAT_TYPE_COMMAND, "CloseSafebox");
-
-	SetSafeboxLoadTime();
-	m_bOpeningSafebox = false;
-
-	Save();
-}
-
-void CHARACTER::LoadSafeboxBuff()
-{
-	if (!g_bSafeboxChangePasswordBuff)
-		return;
-
-	if (FindAffect(AFFECT_SAFE_BOX_BUFF))
-		return;
-
-	char szQuery[254 + 1];
-	snprintf(szQuery, sizeof(szQuery), "SELECT `buff_point`, `buff_value`, `buff_duration` FROM safebox%s WHERE `account_id` = %u",
-		get_table_postfix(), GetDesc()->GetAccountTable().id);
-
-	std::unique_ptr<SQLMsg> pMsg(DBManager::instance().DirectQuery(szQuery));
-	SQLResult* pRes = pMsg->Get();
-	if (pRes->uiNumRows > 0)
-	{
-		MYSQL_ROW row = mysql_fetch_row(pMsg->Get()->pSQLResult);
-
-		BYTE bPoint = POINT_NONE;
-		str_to_number(bPoint, row[0]);
-
-		long lValue = 0;
-		str_to_number(lValue, row[1]);
-
-		long lDuration = 0;
-		str_to_number(lDuration, row[2]);
-
-		if (lDuration > std::time(nullptr))
-		{
-			long lRemainingTime = lDuration - std::time(nullptr);
-			if (lRemainingTime > 300)
-				AddAffect(AFFECT_SAFE_BOX_BUFF, bPoint, lValue, AFF_NONE, lRemainingTime, 0, true);
-		}
-	}
-}
-
-void CHARACTER::SetSafeboxBuff()
-{
-	if (!g_bSafeboxChangePasswordBuff)
-		return;
-
-	if (FindAffect(AFFECT_SAFE_BOX_BUFF))
-		return;
-
-	//
-	// NOTE: Safebox Change Password Buff
-	//
-
-	long lDuration = 60 * 60 * 24 * 90;
-	using SafeboxBuff = struct {
-		BYTE bPoint;
-		long lValue;
-		std::string stText;
-	};
-	using SafeboxBuffVec = std::vector<SafeboxBuff>;
-
-	static SafeboxBuffVec s_vSafeboxBuf{
-		{ POINT_MALL_DEFBONUS, 20, "You have received a storage bonus of %d defence.", },
-		{ POINT_MAX_HP_PCT, 1, "You have received a storage bonus of %d%% HP.", },
-		{ POINT_MALL_EXPBONUS, 5, "You have received a storage bonus of %d%% EXP.", },
-		{ POINT_ATTBONUS_MONSTER, 3, "You have received a storage bonus of %d%% strength against monsters." },
-	};
-
-	SafeboxBuffVec::const_iterator it = s_vSafeboxBuf.begin();
-	std::advance(it, std::rand() % s_vSafeboxBuf.size());
-
-	char szQuery[254 + 1];
-	snprintf(szQuery, sizeof(szQuery), "UPDATE safebox%s SET `buff_point` = %d, `buff_value` = %d, `buff_duration` = %d WHERE `account_id` = %u",
-		get_table_postfix(), it->bPoint, it->lValue, std::time(nullptr) + lDuration, GetDesc()->GetAccountTable().id);
-	std::unique_ptr<SQLMsg> pMsg(DBManager::instance().DirectQuery(szQuery));
-	if (pMsg->Get()->uiAffectedRows > 0)
-	{
-		AddAffect(AFFECT_SAFE_BOX_BUFF, it->bPoint, it->lValue, AFF_NONE, lDuration, 0, true);
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING(it->stText.c_str(), it->lValue));
-	}
-}
-
-CSafebox* CHARACTER::GetMall() const
-{
-	return m_pkMall;
-}
-
-void CHARACTER::LoadMall(int iItemCount, TPlayerItem* pItems)
-{
-	bool bLoaded = false;
-
-	if (m_pkMall)
-		bLoaded = true;
-
-	if (!m_pkMall)
-#if defined(__EXTEND_MALLBOX__)
-		m_pkMall = M2_NEW CSafebox(this, 5 * SAFEBOX_PAGE_SIZE, 0);
-	else
-		m_pkMall->ChangeSize(5 * SAFEBOX_PAGE_SIZE);
-#else
-		m_pkMall = M2_NEW CSafebox(this, 3 * SAFEBOX_PAGE_SIZE, 0);
-	else
-		m_pkMall->ChangeSize(3 * SAFEBOX_PAGE_SIZE);
-#endif
-
-	m_pkMall->SetWindowMode(MALL);
-
-	TPacketCGSafeboxSize p;
-
-	p.bHeader = HEADER_GC_MALL_OPEN;
-#if defined(__EXTEND_MALLBOX__)
-	p.bSize = 5 * SAFEBOX_PAGE_SIZE;
-#else
-	p.bSize = 3 * SAFEBOX_PAGE_SIZE;
-#endif
-
-	GetDesc()->Packet(&p, sizeof(TPacketCGSafeboxSize));
-
-	if (!bLoaded)
-	{
-		for (int i = 0; i < iItemCount; ++i, ++pItems)
-		{
-			if (!m_pkMall->IsValidPosition(pItems->wPos))
-				continue;
-
-			LPITEM item = ITEM_MANAGER::instance().CreateItem(pItems->dwVnum, pItems->dwCount, pItems->dwID);
-
-			if (!item)
-			{
-				sys_err("cannot create item vnum %d id %u (name: %s)", pItems->dwVnum, pItems->dwID, GetName());
-				continue;
-			}
-
-			item->SetSkipSave(true);
-#if defined(__SOUL_BIND_SYSTEM__)
-			item->SealItem(pItems->lSealDate);
-#endif
-			item->SetSockets(pItems->alSockets);
-			item->SetAttributes(pItems->aAttr);
-#if defined(__CHANGE_LOOK_SYSTEM__)
-			item->SetTransmutationVnum(pItems->dwTransmutationVnum);
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-			item->SetRefineElement(&pItems->RefineElement);
-#endif
-#if defined(__ITEM_APPLY_RANDOM__)
-			item->SetRandomApplies(pItems->aApplyRandom);
-#endif
-#if defined(__SET_ITEM__)
-			item->SetItemSetValue(pItems->bSetValue);
-#endif
-
-			if (!m_pkMall->Add(pItems->wPos, item))
-				M2_DESTROY_ITEM(item);
-			else
-				item->SetSkipSave(false);
-		}
-	}
-}
-
-void CHARACTER::CloseMall()
-{
-	if (!m_pkMall)
-		return;
-
-	m_pkMall->Save();
-
-	M2_DELETE(m_pkMall);
-	m_pkMall = NULL;
-
-	ChatPacket(CHAT_TYPE_COMMAND, "CloseMall");
-}
-
-bool CHARACTER::BuildUpdatePartyPacket(TPacketGCPartyUpdate& out)
-{
-	if (!GetParty())
-		return false;
-
-	memset(&out, 0, sizeof(out));
-
-	out.header = HEADER_GC_PARTY_UPDATE;
-	out.pid = GetPlayerID();
-	out.percent_hp = (GetMaxHP() <= 0) ? 0 : MINMAX(0, GetHP() * 100 / GetMaxHP(), 100);
-	out.role = GetParty()->GetRole(GetPlayerID());
-
-	sys_log(1, "PARTY %s role is %d", GetName(), out.role);
-
-	LPCHARACTER l = GetParty()->GetLeaderCharacter();
-
-	if (l && DISTANCE_APPROX(GetX() - l->GetX(), GetY() - l->GetY()) < PARTY_DEFAULT_RANGE)
-	{
-		if (g_iUseLocale)
-			out.affects[0] = GetParty()->GetPartyBonusExpPercent();
-		else
-			out.affects[0] = GetParty()->GetExpBonusPercent();
-		out.affects[1] = GetPoint(POINT_PARTY_ATTACKER_BONUS);
-		out.affects[2] = GetPoint(POINT_PARTY_TANKER_BONUS);
-		out.affects[3] = GetPoint(POINT_PARTY_BUFFER_BONUS);
-		out.affects[4] = GetPoint(POINT_PARTY_SKILL_MASTER_BONUS);
-		out.affects[5] = GetPoint(POINT_PARTY_HASTE_BONUS);
-		out.affects[6] = GetPoint(POINT_PARTY_DEFENDER_BONUS);
-	}
-
-#if defined(__WJ_SHOW_PARTY_ON_MINIMAP__)
-	out.x = GetX();
-	out.y = GetY();
-#endif
-
-	return true;
-}
-
-int CHARACTER::GetLeadershipSkillLevel() const
-{
-	return GetSkillLevel(SKILL_LEADERSHIP);
-}
-
-#if defined(__PARTY_PROFICY__)
-int CHARACTER::GetRoleProficiencySkillLevel() const
-{
-	return GetSkillLevel(SKILL_ROLE_PROFICIENCY );
-}
-#endif
-
-#if defined(__PARTY_INSIGHT__)
-int CHARACTER::GetInSightSkillLevel() const
-{
-	return GetSkillLevel(SKILL_INSIGHT);
-}
-#endif
-
-void CHARACTER::QuerySafeboxSize()
-{
-	if (m_iSafeboxSize == -1)
-	{
-		DBManager::instance().ReturnQuery(QID_SAFEBOX_SIZE,
-			GetPlayerID(),
-			NULL,
-			"SELECT size FROM safebox%s WHERE account_id = %u",
-			get_table_postfix(),
-			GetDesc()->GetAccountTable().id);
-	}
-}
-
-void CHARACTER::SetSafeboxSize(int iSize)
-{
-	sys_log(1, "SetSafeboxSize: %s %d", GetName(), iSize);
-	m_iSafeboxSize = iSize;
-	DBManager::instance().Query("UPDATE safebox%s SET size = %d WHERE account_id = %u", get_table_postfix(), iSize / SAFEBOX_PAGE_SIZE, GetDesc()->GetAccountTable().id);
-}
-
-int CHARACTER::GetSafeboxSize() const
-{
-	return m_iSafeboxSize;
-}
-
-void CHARACTER::SetNowWalking(bool bWalkFlag)
-{
-	//if (m_bNowWalking != bWalkFlag || IsNPC())
-	if (m_bNowWalking != bWalkFlag)
-	{
-		if (bWalkFlag)
-		{
-			m_bNowWalking = true;
-			m_dwWalkStartTime = get_dword_time();
-		}
-		else
-		{
-			m_bNowWalking = false;
-		}
-
-		//if (m_bNowWalking)
-		{
-			TPacketGCWalkMode p;
-			p.vid = GetVID();
-			p.header = HEADER_GC_WALK_MODE;
-			p.mode = m_bNowWalking ? WALKMODE_WALK : WALKMODE_RUN;
-
-			PacketView(&p, sizeof(p));
-		}
-
-		if (IsNPC())
-		{
-			if (m_bNowWalking)
-				MonsterLog("ȴ´");
-			else
-				MonsterLog("ڴ");
-		}
-
-		//sys_log(0, "%s is now %s", GetName(), m_bNowWalking ? "walking." : "running.");
-	}
-}
-
-void CHARACTER::StartStaminaConsume()
-{
-	if (m_bStaminaConsume)
-		return;
-
-	PointChange(POINT_STAMINA, 0);
-	m_bStaminaConsume = true;
-	//ChatPacket(CHAT_TYPE_COMMAND, "StartStaminaConsume %d %d", STAMINA_PER_STEP * passes_per_sec, GetStamina());
-	if (IsStaminaHalfConsume())
-		ChatPacket(CHAT_TYPE_COMMAND, "StartStaminaConsume %d %d", STAMINA_PER_STEP * passes_per_sec / 2, GetStamina());
-	else
-		ChatPacket(CHAT_TYPE_COMMAND, "StartStaminaConsume %d %d", STAMINA_PER_STEP * passes_per_sec, GetStamina());
-}
-
-void CHARACTER::StopStaminaConsume()
-{
-	if (!m_bStaminaConsume)
-		return;
-
-	PointChange(POINT_STAMINA, 0);
-	m_bStaminaConsume = false;
-	ChatPacket(CHAT_TYPE_COMMAND, "StopStaminaConsume %d", GetStamina());
-}
-
-bool CHARACTER::IsStaminaConsume() const
-{
-	return m_bStaminaConsume;
-}
-
-bool CHARACTER::IsStaminaHalfConsume() const
-{
-	return IsEquipUniqueItem(UNIQUE_ITEM_HALF_STAMINA);
-}
-
-void CHARACTER::ResetStopTime()
-{
-	m_dwStopTime = get_dword_time();
-}
-
-DWORD CHARACTER::GetStopTime() const
-{
-	return m_dwStopTime;
-}
-
-void CHARACTER::ResetPoint(int iLv)
-{
-	const BYTE bJob = GetJob();
-
-	PointChange(POINT_LEVEL, iLv - GetLevel(), false, true);
-
-	SetRealPoint(POINT_ST, JobInitialPoints[bJob].st);
-	SetPoint(POINT_ST, GetRealPoint(POINT_ST));
-
-	SetRealPoint(POINT_HT, JobInitialPoints[bJob].ht);
-	SetPoint(POINT_HT, GetRealPoint(POINT_HT));
-
-	SetRealPoint(POINT_DX, JobInitialPoints[bJob].dx);
-	SetPoint(POINT_DX, GetRealPoint(POINT_DX));
-
-	SetRealPoint(POINT_IQ, JobInitialPoints[bJob].iq);
-	SetPoint(POINT_IQ, GetRealPoint(POINT_IQ));
-
-	SetRandomHP((iLv - 1) * number(JobInitialPoints[GetJob()].hp_per_lv_begin, JobInitialPoints[GetJob()].hp_per_lv_end));
-	SetRandomSP((iLv - 1) * number(JobInitialPoints[GetJob()].sp_per_lv_begin, JobInitialPoints[GetJob()].sp_per_lv_end));
-
-	PointChange(POINT_STAT, (MINMAX(1, iLv, gPlayerMaxLevelStats) * 3) + GetPoint(POINT_LEVEL_STEP) - GetPoint(POINT_STAT));
-
-	ComputePoints();
-
-	// ȸ
-	PointChange(POINT_HP, GetMaxHP() - GetHP());
-	PointChange(POINT_SP, GetMaxSP() - GetSP());
-
-	PointsPacket();
-
-	LogManager::instance().CharLog(this, 0, "RESET_POINT", "");
-}
-
-void CHARACTER::ResetExp()
-{
-	SetExp(0);
-
-	PointsPacket();
-
-	UpdatePointsPacket(POINT_EXP, GetExp());
-
-	LogManager::instance().CharLog(this, 0, "RESET_EXP", "");
-}
-
-#if defined(__CONQUEROR_LEVEL__)
-void CHARACTER::ResetConquerorPoint(int iLv)
-{
-	PointChange(POINT_CONQUEROR_LEVEL, MINMAX(0, iLv, gPlayerMaxConquerorLevel) - GetConquerorLevel());
+}
 
-	SetRealPoint(POINT_CONQUEROR_LEVEL_STEP, 0);
-	SetPoint(POINT_CONQUEROR_LEVEL_STEP, GetRealPoint(POINT_CONQUEROR_LEVEL_STEP));
+BYTE CHARACTER::GetCharType() const
+{
+	return m_bCharType;
+}
 
-	SetRealPoint(POINT_CONQUEROR_POINT, MINMAX(0, (iLv * 4) - 4, (4 * (gPlayerMaxConquerorLevel - 1))));
-	SetPoint(POINT_CONQUEROR_POINT, GetRealPoint(POINT_CONQUEROR_POINT));
+bool CHARACTER::SetSyncOwner(LPCHARACTER ch, bool bRemoveFromList)
+{
+	// TRENT_MONSTER
+	if (IS_SET(m_pointsInstant.dwAIFlag, AIFLAG_NOMOVE))
+		return false;
+	// END_OF_TRENT_MONSTER
 
-	SetRealPoint(POINT_SUNGMA_STR, 0);
-	SetPoint(POINT_SUNGMA_STR, GetRealPoint(POINT_SUNGMA_STR));
+	if (ch)
+	{
+		if (!battle_is_attackable(ch, this))
+		{
+			SendDamagePacket(ch, 0, DAMAGE_BLOCK);
+			return false;
+		}
+	}
 
-	SetRealPoint(POINT_SUNGMA_HP, 0);
-	SetPoint(POINT_SUNGMA_HP, GetRealPoint(POINT_SUNGMA_HP));
+	if (ch == this)
+	{
+		sys_err("SetSyncOwner owner == this (%p)", this);
+		return false;
+	}
 
-	SetRealPoint(POINT_SUNGMA_MOVE, 0);
-	SetPoint(POINT_SUNGMA_MOVE, GetRealPoint(POINT_SUNGMA_MOVE));
+	if (!ch)
+	{
+		if (bRemoveFromList && m_pkChrSyncOwner)
+		{
+			m_pkChrSyncOwner->m_kLst_pkChrSyncOwned.remove(this);
+		}
 
-	SetRealPoint(POINT_SUNGMA_IMMUNE, 0);
-	SetPoint(POINT_SUNGMA_IMMUNE, GetRealPoint(POINT_SUNGMA_IMMUNE));
+		if (m_pkChrSyncOwner)
+			sys_log(1, "SyncRelease %s %p from %s", GetName(), this, m_pkChrSyncOwner->GetName());
+
+		// Ʈ  ʴ ʹ NULL õǾ Ѵ.
+		m_pkChrSyncOwner = NULL;
+	}
+	else
+	{
+		if (!IsSyncOwner(ch))
+			return false;
 
-	SetRealPoint(POINT_CONQUEROR_LEVEL_STEP, 0);
-	SetPoint(POINT_CONQUEROR_LEVEL_STEP, GetRealPoint(POINT_CONQUEROR_LEVEL_STEP));
+		// Ÿ 200 ̸̻ SyncOwner   .
+		if (DISTANCE_APPROX(GetX() - ch->GetX(), GetY() - ch->GetY()) > 250)
+		{
+			sys_log(1, "SetSyncOwner distance over than 250 %s %s", GetName(), ch->GetName());
 
-	ComputePoints();
-	PointsPacket();
-
-	LogManager::instance().CharLog(this, 0, "RESET_CONQUEROR_POINT", "");
-}
-
-void CHARACTER::ResetConquerorExp()
-{
-	SetConquerorExp(0);
-
-	PointsPacket();
-
-	UpdatePointsPacket(POINT_CONQUEROR_EXP, GetConquerorExp());
-
-	LogManager::instance().CharLog(this, 0, "RESET_CONQUEROR_EXP", "");
-}
-#endif
-
-bool CHARACTER::IsChangeAttackPosition(LPCHARACTER target) const
-{
-	if (!IsNPC())
-		return true;
-
-	DWORD dwChangeTime = AI_CHANGE_ATTACK_POISITION_TIME_NEAR;
-
-	if (DISTANCE_APPROX(GetX() - target->GetX(), GetY() - target->GetY()) >
-		AI_CHANGE_ATTACK_POISITION_DISTANCE + GetMobAttackRange())
-		dwChangeTime = AI_CHANGE_ATTACK_POISITION_TIME_FAR;
-
-	return get_dword_time() - m_dwLastChangeAttackPositionTime > dwChangeTime;
-}
-
-void CHARACTER::GiveRandomSkillBook()
-{
-	LPITEM item = AutoGiveItem(ITEM_SKILLBOOK_VNUM);
-
-	if (NULL != item)
-	{
-		BYTE bJob = 0;
-
-		if (!number(0, 1))
-			bJob = GetJob() + 1;
-
-		DWORD dwSkillVnum = 0;
-
-		do
-		{
-#if defined(__WOLFMAN_CHARACTER__)
-			dwSkillVnum = number(1, 175);
-			if (dwSkillVnum > 111 && dwSkillVnum < 170)
-				continue;
-#else
-			dwSkillVnum = number(1, 111);
-#endif
-			const CSkillProto* pkSk = CSkillManager::instance().Get(dwSkillVnum);
-
-			if (NULL == pkSk)
-				continue;
-
-			if (bJob && bJob != pkSk->dwType)
-				continue;
-
-			break;
-		} while (true);
-
-		item->SetSocket(0, dwSkillVnum);
-	}
-}
-
-void CHARACTER::ReviveInvisible(int iDur)
-{
-	AddAffect(AFFECT_REVIVE_INVISIBLE, POINT_NONE, 0, AFF_REVIVE_INVISIBLE, iDur, 0, true);
-}
-
-void CHARACTER::ToggleMonsterLog()
-{
-	m_bMonsterLog = !m_bMonsterLog;
-
-	if (m_bMonsterLog)
-	{
-		ChatPacket(CHAT_TYPE_NOTICE, "Registered Monster Log");
-		CHARACTER_MANAGER::instance().RegisterForMonsterLog(this);
-	}
-	else
-	{
-		ChatPacket(CHAT_TYPE_NOTICE, "Unregistered Monster Log");
-		CHARACTER_MANAGER::instance().UnregisterForMonsterLog(this);
-	}
-}
-
-void CHARACTER::SetGuild(CGuild* pGuild)
-{
-	if (m_pGuild != pGuild)
-	{
-		m_pGuild = pGuild;
-		UpdatePacket();
-	}
-}
-
-void CHARACTER::SendGreetMessage()
-{
-	auto v = DBManager::instance().GetGreetMessage();
-	for (auto it = v.begin(); it != v.end(); ++it)
-	{
-		ChatPacket(CHAT_TYPE_NOTICE, it->c_str());
-	}
-}
-
-void CHARACTER::BeginStateEmpty()
-{
-	MonsterLog("!");
-}
-
-void CHARACTER::EffectPacket(BYTE bEffectNum, BYTE bEffectType, const PIXEL_POSITION& rEffectPos)
-{
-	TPacketGCSpecialEffect p;
-	p.bHeader = HEADER_GC_SEPCIAL_EFFECT;
-	p.bEffectNum = bEffectNum;
-	p.dwVID = GetVID();
-	p.bEffectType = bEffectType;
-	p.xEffectPos = rEffectPos.x;
-	p.yEffectPos = rEffectPos.y;
-	PacketAround(&p, sizeof(TPacketGCSpecialEffect));
-}
-
-void CHARACTER::SpecificEffectPacket(const char filename[MAX_EFFECT_FILE_NAME])
-{
-	TPacketGCSpecificEffect p;
-
-	p.header = HEADER_GC_SPECIFIC_EFFECT;
-	p.vid = GetVID();
-	memcpy(p.effect_file, filename, MAX_EFFECT_FILE_NAME);
-
-	PacketAround(&p, sizeof(TPacketGCSpecificEffect));
-}
-
-void CHARACTER::MonsterChat(BYTE bMonsterChatType)
-{
-	if (IsPC())
-		return;
-
-	char sbuf[256 + 1] = { 0 };
-
-	if (IsMonster())
-	{
-		if (number(0, 60))
-			return;
-
-		snprintf(sbuf, sizeof(sbuf),
-			"(locale.monster_chat[%i] and locale.monster_chat[%i][%d] or '')",
-			GetRaceNum(), GetRaceNum(), bMonsterChatType * 3 + number(1, 3));
-	}
-	else
-	{
-		if (bMonsterChatType != MONSTER_CHAT_WAIT)
-			return;
-
-		if (IsGuardNPC())
-		{
-			if (number(0, 6))
-				return;
-		}
-		else
-		{
-			if (number(0, 30))
-				return;
-		}
-
-		snprintf(sbuf, sizeof(sbuf), "(locale.monster_chat[%i] and locale.monster_chat[%i][number(1, table.getn(locale.monster_chat[%i]))] or '')", GetRaceNum(), GetRaceNum(), GetRaceNum());
-	}
-
-	std::string text = quest::ScriptToString(sbuf);
-	if (text.empty())
-		return;
-
-	TPacketGCChat pack_chat;
-	pack_chat.header = HEADER_GC_CHAT;
-	pack_chat.size = sizeof(struct packet_chat) + text.size() + 1;
-	pack_chat.type = CHAT_TYPE_TALKING;
-	pack_chat.id = GetVID();
-	pack_chat.bEmpire = 0;
-
-	TEMP_BUFFER buf;
-	buf.write(&pack_chat, sizeof(struct packet_chat));
-	buf.write(text.c_str(), text.size() + 1);
-
-	PacketAround(buf.read_peek(), buf.size());
-}
-
-void CHARACTER::SetQuestNPCID(DWORD vid)
-{
-	m_dwQuestNPCVID = vid;
-}
-
-LPCHARACTER CHARACTER::GetQuestNPC() const
-{
-	return CHARACTER_MANAGER::instance().Find(m_dwQuestNPCVID);
-}
-
-void CHARACTER::SetQuestItemPtr(LPITEM item)
-{
-	m_pQuestItem = item;
-}
-
-void CHARACTER::ClearQuestItemPtr()
-{
-	m_pQuestItem = NULL;
-}
-
-LPITEM CHARACTER::GetQuestItemPtr() const
-{
-	return m_pQuestItem;
-}
-
-LPDUNGEON CHARACTER::GetDungeonForce() const
-{
-	if (m_lWarpMapIndex > 10000)
-		return CDungeonManager::instance().FindByMapIndex(m_lWarpMapIndex);
-
-	return m_pkDungeon;
-}
-
-void CHARACTER::SetBlockMode(BYTE bFlag)
-{
-	m_pointsInstant.bBlockMode = bFlag;
-
-	ChatPacket(CHAT_TYPE_COMMAND, "setblockmode %d", m_pointsInstant.bBlockMode);
-
-	SetQuestFlag("game_option.block_exchange", bFlag & BLOCK_EXCHANGE ? 1 : 0);
-	SetQuestFlag("game_option.block_party_invite", bFlag & BLOCK_PARTY_INVITE ? 1 : 0);
-	SetQuestFlag("game_option.block_guild_invite", bFlag & BLOCK_GUILD_INVITE ? 1 : 0);
-	SetQuestFlag("game_option.block_whisper", bFlag & BLOCK_WHISPER ? 1 : 0);
-	SetQuestFlag("game_option.block_messenger_invite", bFlag & BLOCK_MESSENGER_INVITE ? 1 : 0);
-	SetQuestFlag("game_option.block_party_request", bFlag & BLOCK_PARTY_REQUEST ? 1 : 0);
-}
-
-#ifdef __OFFLINE_SHOP__
-void CHARACTER::SendUnlockedShopDeco()
-{
-	if (IsOpeningOfflineShop())
-	{
-		ChatPacket(CHAT_TYPE_COMMAND, 
-			"UpdateDecorationTime %d %d %d %d %d %d %d %d"
-			" %d %d %d %d %d",
-			GetQuestFlag("shop_decoration.shop_skin_0"),
-			GetQuestFlag("shop_decoration.shop_skin_1"),
-			GetQuestFlag("shop_decoration.shop_skin_2"),
-			GetQuestFlag("shop_decoration.shop_skin_3"),
-			GetQuestFlag("shop_decoration.shop_skin_4"),
-			GetQuestFlag("shop_decoration.shop_skin_5"),
-			GetQuestFlag("shop_decoration.shop_skin_6"),
-			GetQuestFlag("shop_decoration.shop_skin_7"),
-			GetQuestFlag("shop_decoration.shop_banner_0"),
-			GetQuestFlag("shop_decoration.shop_banner_1"),
-			GetQuestFlag("shop_decoration.shop_banner_2"),
-			GetQuestFlag("shop_decoration.shop_banner_3"),
-			GetQuestFlag("shop_decoration.shop_banner_4"));
-			
-		ChatPacket(CHAT_TYPE_COMMAND, "setshopdeco %d %d", 
-			m_pointsInstant.bUnlockedShopSkin,
-			m_pointsInstant.bUnlockedShopBanner);
-	}
-	else
-	{
-		ChatPacket(CHAT_TYPE_COMMAND, "setshopdeco %d %d", 
-			m_pointsInstant.bUnlockedShopSkin,
-			m_pointsInstant.bUnlockedShopBanner);
-	}
-}
-
-void CHARACTER::SetUnlockShopSkin(BYTE bFlag)
-{
-	m_pointsInstant.bUnlockedShopSkin = bFlag;
-}
-
-void CHARACTER::SetUnlockShopBanner(BYTE bFlag)
-{
-	m_pointsInstant.bUnlockedShopBanner = bFlag;
-}
-#endif
-
-void CHARACTER::SetBlockModeForce(BYTE bFlag)
-{
-	m_pointsInstant.bBlockMode = bFlag;
-	ChatPacket(CHAT_TYPE_COMMAND, "setblockmode %d", m_pointsInstant.bBlockMode);
-}
-
-bool CHARACTER::IsGuardNPC() const
-{
-	return IsNPC() && (GetRaceNum() == 11000 || GetRaceNum() == 11002 || GetRaceNum() == 11004);
-}
-
-int CHARACTER::GetPolymorphPower() const
-{
-	if (test_server)
-	{
-		int value = quest::CQuestManager::instance().GetEventFlag("poly");
-		if (value)
-			return value;
-	}
-	return aiPolymorphPowerByLevel[MINMAX(0, GetSkillLevel(SKILL_POLYMORPH), 40)];
-}
-
-void CHARACTER::SetPolymorph(DWORD dwRaceNum, bool bMaintainStat)
-{
-	if (dwRaceNum < MAIN_RACE_MAX_NUM)
-	{
-		dwRaceNum = 0;
-		bMaintainStat = false;
-	}
-
-	if (m_dwPolymorphRace == dwRaceNum)
-		return;
-
-	m_bPolyMaintainStat = bMaintainStat;
-	m_dwPolymorphRace = dwRaceNum;
-
-	sys_log(0, "POLYMORPH: %s race %u ", GetName(), dwRaceNum);
-
-	if (dwRaceNum != 0)
-		StopRiding();
-
-	SET_BIT(m_bAddChrState, ADD_CHARACTER_STATE_SPAWN);
-	m_afAffectFlag.Set(AFF_SPAWN);
-
-	ViewReencode();
-
-	REMOVE_BIT(m_bAddChrState, ADD_CHARACTER_STATE_SPAWN);
-
-	if (!bMaintainStat)
-	{
-		PointChange(POINT_ST, 0);
-		PointChange(POINT_DX, 0);
-		PointChange(POINT_IQ, 0);
-		PointChange(POINT_HT, 0);
-	}
-
-	//  ¿ ״ ,  Ǯ Ǵµ
-	//   ķ valid combo interval ٸ 
-	// Combo  Ǵ Hacker νϴ 찡 ִ.
-	//   Ǯų  ϰ Ǹ,
-	// valid combo interval resetѴ.
-	SetValidComboInterval(0);
-	SetComboSequence(0);
-
-	ComputeBattlePoints();
-}
-
-int CHARACTER::GetQuestFlag(const std::string& flag) const
-{
-	if (!IsPC())
-	{
-		sys_err("Trying to get qf %s from non player character", flag.c_str());
-		return 0;
-	}
-
-	DWORD pid = GetPlayerID();
-
-	quest::CQuestManager& q = quest::CQuestManager::instance();
-	quest::PC* pPC = q.GetPC(pid);
-
-	if (!pPC)
-	{
-		sys_err("Nullpointer when trying to access questflag %s for player with pid %lu", flag.c_str(), pid);
-		return 0;
-	}
-
-	return pPC->GetFlag(flag);
-}
-
-void CHARACTER::SetQuestFlag(const std::string& flag, int value)
-{
-	DWORD pid = GetPlayerID();
-
-	quest::CQuestManager& q = quest::CQuestManager::instance();
-	quest::PC* pPC = q.GetPC(pid);
-
-	if (!pPC)
-	{
-		sys_err("Nullpointer when trying to set questflag %s for player with pid %lu", flag.c_str(), pid);
-		return;
-	}
-
-	pPC->SetFlag(flag, value);
-}
-
-void CHARACTER::DetermineDropMetinStone()
-{
-#if defined(__MAGIC_REDUCTION__)
-	const int METIN_STONE_NUM = 17;
-#else
-	const int METIN_STONE_NUM = 15;
-#endif
-
-	static DWORD c_adwMetin[METIN_STONE_NUM] =
-	{
-		28030, // 60
-		28031,
-		28032,
-		28033,
-		28034,
-		28035,
-		28036,
-		28037,
-		28038,
-		28039,
-		28040,
-		28041,
-		28042,
-		28043,
-#if defined(__MAGIC_REDUCTION__)
-		28044,
-		28045,
-#endif
-		28012,
-	};
-
-	DWORD stone_num = GetRaceNum();
-	int idx = std::lower_bound(aStoneDrop, aStoneDrop + STONE_INFO_MAX_NUM, stone_num) - aStoneDrop;
-	if (idx >= STONE_INFO_MAX_NUM || aStoneDrop[idx].dwMobVnum != stone_num)
-	{
-		m_dwDropMetinStone = 0;
-	}
-	else
-	{
-		const SStoneDropInfo& info = aStoneDrop[idx];
-		m_bDropMetinStonePct = info.iDropPct;
-		{
-			m_dwDropMetinStone = c_adwMetin[number(0, METIN_STONE_NUM - 1)];
-			int iGradePct = number(1, 100);
-
-			for (int iStoneLevel = 0; iStoneLevel < STONE_LEVEL_MAX_NUM; iStoneLevel++)
-			{
-				int iLevelGradePortion = info.iLevelPct[iStoneLevel];
-
-				if (iGradePct <= iLevelGradePortion)
-				{
-					break;
-				}
-				else
-				{
-					iGradePct -= iLevelGradePortion;
-					m_dwDropMetinStone += 100; //  +a -> +(a+1) ɶ 100 
-				}
-			}
-		}
-	}
-}
-
-void CHARACTER::SendEquipment(LPCHARACTER pChar)
-{
-	TPacketGCViewEquip Packet;
-	Packet.bHeader = HEADER_GC_VIEW_EQUIP;
-	Packet.dwVID = GetVID();
-	for (BYTE bSlotIdx = 0; bSlotIdx < WEAR_MAX_NUM; bSlotIdx++)
-	{
-		LPITEM pItem = GetWear(bSlotIdx);
-		if (pItem)
-		{
-			Packet.Equips[bSlotIdx].dwVnum = pItem->GetVnum();
-			Packet.Equips[bSlotIdx].bCount = static_cast<BYTE>(pItem->GetCount());
-			thecore_memcpy(Packet.Equips[bSlotIdx].alSockets, pItem->GetSockets(), sizeof(Packet.Equips[bSlotIdx].alSockets));
-			thecore_memcpy(Packet.Equips[bSlotIdx].aAttr, pItem->GetAttributes(), sizeof(Packet.Equips[bSlotIdx].aAttr));
-#if defined(__CHANGE_LOOK_SYSTEM__)
-			Packet.Equips[bSlotIdx].dwTransmutationVnum = pItem->GetTransmutationVnum();
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-			thecore_memcpy(&Packet.Equips[bSlotIdx].RefineElement, pItem->GetRefineElement(), sizeof(Packet.Equips[bSlotIdx].RefineElement));
-#endif
-#if defined(__ITEM_APPLY_RANDOM__)
-			thecore_memcpy(Packet.Equips[bSlotIdx].aApplyRandom, pItem->GetRandomApplies(), sizeof(Packet.Equips[bSlotIdx].aApplyRandom));
-#endif
-#if defined(__SET_ITEM__)
-			Packet.Equips[bSlotIdx].bSetValue = pItem->GetItemSetValue();
-#endif
-		}
-		else
-		{
-			Packet.Equips[bSlotIdx].dwVnum = 0;
-			Packet.Equips[bSlotIdx].bCount = 0;
-			memset(&Packet.Equips[bSlotIdx].alSockets, 0, sizeof(Packet.Equips[bSlotIdx].alSockets));
-			memset(&Packet.Equips[bSlotIdx].aAttr, 0, sizeof(Packet.Equips[bSlotIdx].aAttr));
-#if defined(__CHANGE_LOOK_SYSTEM__)
-			Packet.Equips[bSlotIdx].dwTransmutationVnum = 0;
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-			memset(&Packet.Equips[bSlotIdx].RefineElement, 0, sizeof(Packet.Equips[bSlotIdx].RefineElement));
-#endif
-#if defined(__ITEM_APPLY_RANDOM__)
-			memset(&Packet.Equips[bSlotIdx].aApplyRandom, 0, sizeof(Packet.Equips[bSlotIdx].aApplyRandom));
-#endif
-#if defined(__SET_ITEM__)
-			Packet.Equips[bSlotIdx].bSetValue = 0;
-#endif
-		}
-	}
-	pChar->GetDesc()->Packet(&Packet, sizeof(Packet));
-}
-
-bool CHARACTER::CanSummon(int iLeaderShip)
-{
-	return (iLeaderShip >= 30 && m_dwLastDeadTime + 300 > get_dword_time());
-}
-
-void CHARACTER::UnMount(bool bUnequipItem)
-{
-	if (bUnequipItem)
-		UnEquipSpecialRideUniqueItem();
-
-	RemoveAffect(AFFECT_MOUNT);
-	RemoveAffect(AFFECT_MOUNT_BONUS);
-
-	if (IsHorseRiding())
-	{
-		StopRiding();
-	}
-	else if (GetMountVnum())
-	{
-		MountVnum(0);
-	}
-}
-
-void CHARACTER::MountVnum(DWORD vnum)
-{
-	if (IsPolymorphed())
-		return;
-
-	if (m_dwMountVnum == vnum)
-		return;
-
-	if ((m_dwMountVnum != 0) && (vnum != 0))
-		MountVnum(0);
-
-	m_dwMountVnum = vnum;
-	m_dwMountTime = get_dword_time();
-
-	if (m_bIsObserver)
-		return;
-
-	m_posDest.x = m_posStart.x = GetX();
-	m_posDest.y = m_posStart.y = GetY();
-
-	// NOTE : MountѴٰ ؼ Client Side ü  ʴ´.
-	// ׸ Side  ġ ̵  ʴ´. ֳϸ Client Side Coliision Adjust Ҽ ִµ
-	// ü Ҹ״ٰ ġ ̵Ű ̶ collision check  Ƿ 濡 ų հ   Ѵ.
-	m_posDest.x = m_posStart.x = GetX();
-	m_posDest.y = m_posStart.y = GetY();
-#if defined(__MOUNT_ENTITY_REFRESH__)
-	EncodeRemovePacket(this);
-#endif
-	EncodeInsertPacket(this);
-
-	ENTITY_MAP::iterator it = m_map_view.begin();
-
-	while (it != m_map_view.end())
-	{
-		LPENTITY entity = (it++)->first;
-
-		// MountѴٰ ؼ Client Side ü  ʴ´.
-#if defined(__MOUNT_ENTITY_REFRESH__)
-		EncodeRemovePacket(entity);
-		if (!m_bIsObserver)
-			EncodeInsertPacket(entity);
-#else
-		EncodeInsertPacket(entity);
-#endif
-
-#if defined(__MOUNT_ENTITY_REFRESH__)
-		if (!entity->IsObserverMode())
-			entity->EncodeInsertPacket(this);
-#endif
-	}
-
-	SetValidComboInterval(0);
-	SetComboSequence(0);
-
-	ComputePoints();
-}
-
-namespace
-{
-	class FuncCheckWarp
-	{
-	public:
-		FuncCheckWarp(LPCHARACTER pkWarp)
-		{
-			m_lTargetY = 0;
-			m_lTargetX = 0;
-
-			m_lX = pkWarp->GetX();
-			m_lY = pkWarp->GetY();
-
-			m_bInvalid = false;
-			m_bEmpire = pkWarp->GetEmpire();
-
-			char szTmp[64];
-
-			if (3 != sscanf(pkWarp->GetName(), " %s %ld %ld ", szTmp, &m_lTargetX, &m_lTargetY))
-			{
-				if (number(1, 100) < 5)
-					sys_err("Warp NPC name wrong : vnum(%d) name(%s)", pkWarp->GetRaceNum(), pkWarp->GetName());
-
-				m_bInvalid = true;
-
-				return;
-			}
-
-			m_lTargetX *= 100;
-			m_lTargetY *= 100;
-
-			m_bUseWarp = true;
-
-			if (pkWarp->IsGoto())
-			{
-				LPSECTREE_MAP pkSectreeMap = SECTREE_MANAGER::instance().GetMap(pkWarp->GetMapIndex());
-				m_lTargetX += pkSectreeMap->m_setting.iBaseX;
-				m_lTargetY += pkSectreeMap->m_setting.iBaseY;
-				m_bUseWarp = false;
-			}
-		}
-
-		bool Valid()
-		{
-			return !m_bInvalid;
-		}
-
-		void operator () (LPENTITY ent)
-		{
-			if (!Valid())
-				return;
-
-			if (!ent->IsType(ENTITY_CHARACTER))
-				return;
-
-			LPCHARACTER pkChr = (LPCHARACTER)ent;
-
-			if (!pkChr->IsPC())
-				return;
-
-			int iDist = DISTANCE_APPROX(pkChr->GetX() - m_lX, pkChr->GetY() - m_lY);
-
-			if (iDist > 300)
-				return;
-
-			if (m_bEmpire && pkChr->GetEmpire() && m_bEmpire != pkChr->GetEmpire())
-				return;
-
-			if (pkChr->IsHack())
-				return;
-
-			if (!pkChr->CanHandleItem(false, true))
-				return;
-
-			if (m_bUseWarp)
-				pkChr->WarpSet(m_lTargetX, m_lTargetY);
-			else
-			{
-				pkChr->Show(pkChr->GetMapIndex(), m_lTargetX, m_lTargetY);
-				pkChr->Stop();
-			}
-		}
-
-		bool m_bInvalid;
-		bool m_bUseWarp;
-
-		long m_lX;
-		long m_lY;
-		long m_lTargetX;
-		long m_lTargetY;
-
-		BYTE m_bEmpire;
-	};
-}
-
-EVENTFUNC(warp_npc_event)
-{
-	char_event_info* info = dynamic_cast<char_event_info*>(event->info);
-	if (info == NULL)
-	{
-		sys_err("warp_npc_event> <Factor> Null pointer");
-		return 0;
-	}
-
-	LPCHARACTER ch = info->ch;
-
-	if (ch == NULL) // <Factor>
-		return 0;
-
-	if (!ch->GetSectree())
-	{
-		ch->m_pkWarpNPCEvent = NULL;
-		return 0;
-	}
-
-	FuncCheckWarp f(ch);
-	if (f.Valid())
-		ch->GetSectree()->ForEachAround(f);
-
-	return passes_per_sec / 2;
-}
-
-void CHARACTER::StartWarpNPCEvent()
-{
-	if (m_pkWarpNPCEvent)
-		return;
-
-	if (!IsWarp() && !IsGoto())
-		return;
-
-	char_event_info* info = AllocEventInfo<char_event_info>();
-
-	info->ch = this;
-
-	m_pkWarpNPCEvent = event_create(warp_npc_event, info, passes_per_sec / 2);
-}
-
-void CHARACTER::SyncPacket()
-{
-	TEMP_BUFFER buf;
-
-	TPacketCGSyncPositionElement elem;
-
-	elem.dwVID = GetVID();
-	elem.lX = GetX();
-	elem.lY = GetY();
-
-	TPacketGCSyncPosition pack;
-
-	pack.bHeader = HEADER_GC_SYNC_POSITION;
-	pack.wSize = sizeof(TPacketGCSyncPosition) + sizeof(elem);
-
-	buf.write(&pack, sizeof(pack));
-	buf.write(&elem, sizeof(elem));
-
-	PacketAround(buf.read_peek(), buf.size());
-}
-
-LPCHARACTER CHARACTER::GetMarryPartner() const
-{
-	return m_pkChrMarried;
-}
-
-void CHARACTER::SetMarryPartner(LPCHARACTER ch)
-{
-	m_pkChrMarried = ch;
-}
-
-int CHARACTER::GetMarriageBonus(DWORD dwItemVnum, bool bSum)
-{
-	if (IsNPC())
-		return 0;
-
-	marriage::TMarriage* pMarriage = marriage::CManager::instance().Get(GetPlayerID());
-
-	if (!pMarriage)
-		return 0;
-
-	return pMarriage->GetBonus(dwItemVnum, bSum, this);
-}
-
-void CHARACTER::ConfirmWithMsg(const char* szMsg, int iTimeout, DWORD dwRequestPID)
-{
-	if (!IsPC())
-		return;
-
-	TPacketGCQuestConfirm p;
-
-	p.header = HEADER_GC_QUEST_CONFIRM;
-	p.requestPID = dwRequestPID;
-	p.timeout = iTimeout;
-	strlcpy(p.msg, szMsg, sizeof(p.msg));
-
-	GetDesc()->Packet(&p, sizeof(p));
-}
-
-bool CHARACTER::IsRunningQuest() const
-{
-	return quest::CQuestManager::instance().GetPCForce(GetPlayerID())->IsRunning();
-}
-
-int CHARACTER::GetPremiumRemainSeconds(BYTE bType) const
-{
-	if (bType >= PREMIUM_MAX_NUM)
-		return 0;
-
-	return m_aiPremiumTimes[bType] - get_global_time();
-}
-
-bool CHARACTER::WarpToPID(DWORD dwPID, bool bWarpForce)
-{
-	LPCHARACTER victim;
-	if ((victim = (CHARACTER_MANAGER::instance().FindByPID(dwPID))))
-	{
-		int mapIdx = victim->GetMapIndex();
-		if (IS_SUMMONABLE_ZONE(mapIdx))
-		{
-			if (CAN_ENTER_ZONE(this, mapIdx))
-			{
-				WarpSet(victim->GetX(), victim->GetY());
-			}
-			else
-			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ִ    ϴ."));
-				return false;
-			}
-		}
-		else
-		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ִ    ϴ."));
-			return false;
-		}
-	}
-	else
-	{
-		// ٸ  αε   -> ޽  ǥ ޾ƿ
-		// 1. A.pid, B.pid  Ѹ
-		// 2. B.pid   Ѹ A.pid, ǥ  
-		// 3. 
-		CCI* pcci = P2P_MANAGER::instance().FindByPID(dwPID);
-
-		if (!pcci)
-		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ¶ ° ƴմϴ."));
-			return false;
-		}
-
-		if ((pcci->bChannel != g_bChannel) && !bWarpForce)
-		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING(" %d äο ֽϴ. ( ä %d)", pcci->bChannel, g_bChannel));
-			return false;
-		}
-		else if (false == IS_SUMMONABLE_ZONE(pcci->lMapIndex))
-		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ִ    ϴ."));
-			return false;
-		}
-		else
-		{
-			if (!CAN_ENTER_ZONE(this, pcci->lMapIndex))
-			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ִ    ϴ."));
-				return false;
-			}
-
-			TPacketGGFindPosition p;
-			p.header = HEADER_GG_FIND_POSITION;
-			p.dwFromPID = GetPlayerID();
-			p.dwTargetPID = dwPID;
-			pcci->pkDesc->Packet(&p, sizeof(TPacketGGFindPosition));
-
-			if (test_server)
-				ChatPacket(CHAT_TYPE_PARTY, "sent find position packet for teleport");
-		}
-	}
-	return true;
-}
-
-// ADD_REFINE_BUILDING
-CGuild* CHARACTER::GetRefineGuild() const
-{
-	LPCHARACTER chRefineNPC = CHARACTER_MANAGER::instance().Find(m_dwRefineNPCVID);
-
-	return (chRefineNPC ? chRefineNPC->GetGuild() : NULL);
-}
-
-bool CHARACTER::IsRefineThroughGuild() const
-{
-	return GetRefineGuild() != NULL;
-}
-
-int CHARACTER::ComputeRefineFee(int iCost, int iMultiply) const
-{
-	CGuild* pGuild = GetRefineGuild();
-	if (pGuild)
-	{
-		if (pGuild == GetGuild())
-			return iCost * iMultiply * 9 / 10;
-
-		// ٸ   õϴ  ߰ 3 
-		LPCHARACTER chRefineNPC = CHARACTER_MANAGER::instance().Find(m_dwRefineNPCVID);
-		if (chRefineNPC && chRefineNPC->GetEmpire() != GetEmpire())
-			return iCost * iMultiply * 3;
-
-		return iCost * iMultiply;
-	}
-	else
-		return iCost;
-}
-
-void CHARACTER::PayRefineFee(int iTotalMoney)
-{
-	int iFee = iTotalMoney / 10;
-	CGuild* pGuild = GetRefineGuild();
-
-	int iRemain = iTotalMoney;
-
-	if (pGuild)
-	{
-		// ڱ ̸ iTotalMoney ̹ 10% ܵǾִ
-		if (pGuild != GetGuild())
-		{
-			pGuild->RequestDepositMoney(this, iFee);
-			iRemain -= iFee;
-		}
-	}
-
-	PointChange(POINT_GOLD, -iRemain);
-}
-// END_OF_ADD_REFINE_BUILDING
-
-// PREVENT_TRADE_WINDOW
-bool CHARACTER::PreventTradeWindow(int flags, bool except) const
-{
-	if (WND_ALL & flags)
-	{
-		flags = 0x0;
-		except = true;
-	}
-
-	if (except && !(WND_EXCHANGE & flags) || !except && (WND_EXCHANGE & flags))
-		if (GetExchange())
-			return true;
-
-	if (except && !(WND_MYSHOP & flags) || !except && (WND_MYSHOP & flags))
-		if (GetMyShop())
-			return true;
-
-	if (except && !(WND_SHOPOWNER & flags) || !except && (WND_SHOPOWNER & flags))
-		if (GetShopOwner())
-			return true;
-
-	if (except && !(WND_SAFEBOX & flags) || !except && (WND_SAFEBOX & flags))
-		if (IsOpenSafebox())
-			return true;
-
-	if (except && !(WND_REFINE & flags) || !except && (WND_REFINE & flags))
-		if (IsUnderRefine()
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-			|| IsUnderRefineElement()
-#endif
-			)
-			return true;
-
-	if (except && !(WND_CUBE & flags) || !except && (WND_CUBE & flags))
-		if (IsCubeOpen())
-			return true;
-
-#if defined(__MOVE_COSTUME_ATTR__)
-	if (except && !(WND_ITEM_COMB & flags) || !except && (WND_ITEM_COMB & flags))
-		if (IsItemComb())
-			return true;
-#endif
-
-#if defined(__CHANGED_ATTR__)
-	if (except && !(WND_SELECT_ATTR & flags) || !except && (WND_SELECT_ATTR & flags))
-		if (IsSelectAttr())
-			return true;
-#endif
-
-#if defined(__ACCE_COSTUME_SYSTEM__)
-	if (except && !(WND_ACCE & flags) || !except && (WND_ACCE & flags))
-		if (IsAcceRefineWindowOpen())
-			return true;
-#endif
-
-#if defined(__CHANGE_LOOK_SYSTEM__)
-	if (except && !(WND_CHANGELOOK & flags) || !except && (WND_CHANGELOOK & flags))
-		if (GetChangeLook())
-			return true;
-#endif
-
-#if defined(__MAILBOX__)
-	if (except && !(WND_MAILBOX & flags) || !except && (WND_MAILBOX & flags))
-		if (GetMailBox())
-			return true;
-#endif
-
-#if defined(__ATTR_6TH_7TH__)
-	if (except && !(WND_ATTR67ADD & flags) || !except && (WND_ATTR67ADD & flags))
-		if (IsOpenAttr67Add())
-			return true;
-#endif
-
-#if defined(__LUCKY_BOX__)
-	if (except && !(WND_LUCKY_BOX & flags) || !except && (WND_LUCKY_BOX & flags))
-		if (IsLuckyBoxOpen())
-			return true;
-#endif
-
-#if defined(__AURA_COSTUME_SYSTEM__)
-	if (except && !(WND_AURA & flags) || !except && (WND_AURA & flags))
-		if (IsAuraRefineWindowOpen())
-			return true;
-#endif
-
-#if defined(__SUMMER_EVENT_ROULETTE__)
-	if (except && !(WND_MINIGAME_ROULETTE & flags) || !except && (WND_MINIGAME_ROULETTE & flags))
-		if (GetMiniGameRoulette())
-			return true;
-#endif
-
-#ifdef __GROWTH_PET_SYSTEM__
-	if (except && !(PET_WINDOW_ATTR_CHANGE & flags) || !except && (PET_WINDOW_ATTR_CHANGE & flags))
-		if (GetPetWindowType())
-			return true;
-
-	if (except && !(PET_WINDOW_PRIMIUM_FEEDSTUFF & flags) || !except && (PET_WINDOW_PRIMIUM_FEEDSTUFF & flags))
-		if (GetPetWindowType())
-			return true;
-#endif
-
-	return false;
-}
-// END_PREVENT_TRADE_WINDOW
-
-// Hack   üũ.
-bool CHARACTER::IsHack(bool bSendMsg, bool bCheckShopOwner, int limittime)
-{
-	const int iPulse = thecore_pulse();
-
-	if (test_server)
-		bSendMsg = true;
-
-	// â  üũ
-	if (iPulse - GetSafeboxLoadTime() < PASSES_PER_SEC(limittime))
-	{
-		if (bSendMsg)
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("â  %d ̳ ٸ ̵Ҽ ϴ.", limittime));
-
-		if (test_server)
-			ChatPacket(CHAT_TYPE_INFO, "[TestOnly]Pulse %d LoadTime %d PASS %d", iPulse, GetSafeboxLoadTime(), PASSES_PER_SEC(limittime));
-		return true;
-	}
-
-	// ŷ â üũ
-	if (bCheckShopOwner)
-	{
-		if (PreventTradeWindow(WND_ALL))
-		{
-			if (bSendMsg)
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("ŷâ,â   ¿ ٸ ̵, Ҽ ϴ"));
-
-			return true;
-		}
-	}
-	else
-	{
-		if (PreventTradeWindow(WND_SHOPOWNER, true/*except*/))
-		{
-			if (bSendMsg)
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("ŷâ,â   ¿ ٸ ̵, Ҽ ϴ"));
-
-			return true;
-		}
-	}
-
-	// PREVENT_PORTAL_AFTER_EXCHANGE
-	// ȯ  ðüũ
-	if (iPulse - GetExchangeTime() < PASSES_PER_SEC(limittime))
-	{
-		if (bSendMsg)
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("ŷ  %d ̳ ٸ ̵   ϴ.", limittime));
-		return true;
-	}
-	// END_PREVENT_PORTAL_AFTER_EXCHANGE
-
-	// PREVENT_ITEM_COPY
-	if (iPulse - GetMyShopTime() < PASSES_PER_SEC(limittime))
-	{
-		if (bSendMsg)
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("ŷ  %d ̳ ٸ ̵   ϴ.", limittime));
-		return true;
-	}
-
-	if (iPulse - GetRefineTime() < PASSES_PER_SEC(limittime))
-	{
-		if (bSendMsg)
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("  %d ̳ ȯ,ȯθ   ϴ.", limittime));
-		return true;
-	}
-
-#if defined(__MAILBOX__)
-	if (iPulse - GetMyMailBoxTime() < PASSES_PER_SEC(limittime))
-	{
-		if (bSendMsg)
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("You have to wait %d sec. after opening the Mailbox before you can switch channels or teleport.", limittime));
-		return true;
-	}
-#endif
-	// END_PREVENT_ITEM_COPY
-
-	return false;
-}
-
-BOOL CHARACTER::IsMonarch() const
-{
-	// MONARCH_LIMIT
-	if (CMonarch::instance().IsMonarch(GetPlayerID(), GetEmpire()))
-		return true;
-
-	return false;
-
-	// END_MONARCH_LIMIT
-}
-
-void CHARACTER::Say(const std::string& s)
-{
-	struct ::packet_script packet_script;
-
-	packet_script.header = HEADER_GC_SCRIPT;
-	packet_script.skin = 1;
-	packet_script.src_size = s.size();
-	packet_script.size = packet_script.src_size + sizeof(struct packet_script);
-
-	TEMP_BUFFER buf;
-
-	buf.write(&packet_script, sizeof(struct packet_script));
-	buf.write(&s[0], s.size());
-
-	if (IsPC())
-	{
-		GetDesc()->Packet(buf.read_peek(), buf.size());
-	}
-}
-
-//
-// Monarch
-//
-void CHARACTER::InitMC()
-{
-	for (int n = 0; n < MI_MAX; ++n)
-	{
-		m_dwMonarchCooltime[n] = thecore_pulse();
-	}
-
-	m_dwMonarchCooltimelimit[MI_HEAL] = PASSES_PER_SEC(MC_HEAL);
-	m_dwMonarchCooltimelimit[MI_WARP] = PASSES_PER_SEC(MC_WARP);
-	m_dwMonarchCooltimelimit[MI_TRANSFER] = PASSES_PER_SEC(MC_TRANSFER);
-	m_dwMonarchCooltimelimit[MI_TAX] = PASSES_PER_SEC(MC_TAX);
-	m_dwMonarchCooltimelimit[MI_SUMMON] = PASSES_PER_SEC(MC_SUMMON);
-
-	m_dwMonarchCooltime[MI_HEAL] -= PASSES_PER_SEC(GetMCL(MI_HEAL));
-	m_dwMonarchCooltime[MI_WARP] -= PASSES_PER_SEC(GetMCL(MI_WARP));
-	m_dwMonarchCooltime[MI_TRANSFER] -= PASSES_PER_SEC(GetMCL(MI_TRANSFER));
-	m_dwMonarchCooltime[MI_TAX] -= PASSES_PER_SEC(GetMCL(MI_TAX));
-	m_dwMonarchCooltime[MI_SUMMON] -= PASSES_PER_SEC(GetMCL(MI_SUMMON));
-}
-
-DWORD CHARACTER::GetMC(enum MONARCH_INDEX e) const
-{
-	return m_dwMonarchCooltime[e];
-}
-
-void CHARACTER::SetMC(enum MONARCH_INDEX e)
-{
-	m_dwMonarchCooltime[e] = thecore_pulse();
-}
-
-bool CHARACTER::IsMCOK(enum MONARCH_INDEX e) const
-{
-	int iPulse = thecore_pulse();
-
-	if ((iPulse - GetMC(e)) < GetMCL(e))
-	{
-		if (test_server)
-			sys_log(0, " Pulse %d cooltime %d, limit %d", iPulse, GetMC(e), GetMCL(e));
-
-		return false;
-	}
-
-	if (test_server)
-		sys_log(0, " Pulse %d cooltime %d, limit %d", iPulse, GetMC(e), GetMCL(e));
-
-	return true;
-}
-
-DWORD CHARACTER::GetMCL(enum MONARCH_INDEX e) const
-{
-	return m_dwMonarchCooltimelimit[e];
-}
-
-DWORD CHARACTER::GetMCLTime(enum MONARCH_INDEX e) const
-{
-	int iPulse = thecore_pulse();
-
-	if (test_server)
-		sys_log(0, " Pulse %d cooltime %d, limit %d", iPulse, GetMC(e), GetMCL(e));
-
-	return (GetMCL(e)) / passes_per_sec - (iPulse - GetMC(e)) / passes_per_sec;
-}
-
-bool CHARACTER::IsSiegeNPC() const
-{
-	return IsNPC() && (GetRaceNum() == 11000 || GetRaceNum() == 11002 || GetRaceNum() == 11004);
-}
-
-//------------------------------------------------
-void CHARACTER::UpdateDepositPulse()
-{
-	m_deposit_pulse = thecore_pulse() + PASSES_PER_SEC(60 * 5); // 5
-}
-
-bool CHARACTER::CanDeposit() const
-{
-	return (m_deposit_pulse == 0 || (m_deposit_pulse < thecore_pulse()));
-}
-//------------------------------------------------
-
-ESex GET_SEX(LPCHARACTER ch)
-{
-	switch (ch->GetRaceNum())
-	{
-		case MAIN_RACE_WARRIOR_M:
-		case MAIN_RACE_SURA_M:
-		case MAIN_RACE_ASSASSIN_M:
-		case MAIN_RACE_SHAMAN_M:
-		case MAIN_RACE_WOLFMAN_M:
-			return SEX_MALE;
-
-		case MAIN_RACE_ASSASSIN_W:
-		case MAIN_RACE_SHAMAN_W:
-		case MAIN_RACE_WARRIOR_W:
-		case MAIN_RACE_SURA_W:
-			return SEX_FEMALE;
-	}
-
-	/* default sex = male */
-	return SEX_MALE;
-}
-
-int CHARACTER::GetHPPct() const
-{
-	if (GetMaxHP() <= 0)
-		return 0;
-
-	return (GetHP() * 100) / GetMaxHP();
-}
-
-bool CHARACTER::IsBerserk() const
-{
-	if (m_pkMobInst != NULL)
-		return m_pkMobInst->m_IsBerserk;
-	else
-		return false;
-}
-
-void CHARACTER::SetBerserk(bool mode)
-{
-	if (m_pkMobInst != NULL)
-		m_pkMobInst->m_IsBerserk = mode;
-}
-
-bool CHARACTER::IsGodSpeed() const
-{
-	if (m_pkMobInst != NULL)
-	{
-		return m_pkMobInst->m_IsGodSpeed;
-	}
-	else
-	{
-		return false;
-	}
-}
-
-void CHARACTER::SetGodSpeed(bool mode)
-{
-	if (m_pkMobInst != NULL)
-	{
-		m_pkMobInst->m_IsGodSpeed = mode;
-
-		if (mode == true)
-		{
-			SetPoint(POINT_ATT_SPEED, 250);
-		}
-		else
-		{
-			SetPoint(POINT_ATT_SPEED, m_pkMobData->m_table.sAttackSpeed);
-		}
-	}
-}
-
-bool CHARACTER::IsDeathBlow() const
-{
-	if (number(1, 100) <= m_pkMobData->m_table.bDeathBlowPoint)
-	{
-		return true;
-	}
-	else
-	{
-		return false;
-	}
-}
-
-struct FFindReviver
-{
-	FFindReviver()
-	{
-		pChar = NULL;
-		HasReviver = false;
-	}
-
-	void operator() (LPCHARACTER ch)
-	{
-		if (ch->IsMonster() != true)
-		{
-			return;
-		}
-
-		if (ch->IsReviver() == true && pChar != ch && ch->IsDead() != true)
-		{
-			if (number(1, 100) <= ch->GetMobTable().bRevivePoint)
-			{
-				HasReviver = true;
-				pChar = ch;
-			}
-		}
-	}
-
-	LPCHARACTER pChar;
-	bool HasReviver;
-};
-
-bool CHARACTER::HasReviverInParty() const
-{
-	LPPARTY party = GetParty();
-
-	if (party != NULL)
-	{
-		if (party->GetMemberCount() == 1) return false;
-
-		FFindReviver f;
-		party->ForEachMemberPtr(f);
-		return f.HasReviver;
-	}
-
-	return false;
-}
-
-bool CHARACTER::IsRevive() const
-{
-	if (m_pkMobInst != NULL)
-	{
-		return m_pkMobInst->m_IsRevive;
-	}
-
-	return false;
-}
-
-void CHARACTER::SetRevive(bool mode)
-{
-	if (m_pkMobInst != NULL)
-	{
-		m_pkMobInst->m_IsRevive = mode;
-	}
-}
-
-#define IS_SPEED_HACK_PLAYER(ch) (ch->m_speed_hack_count > SPEEDHACK_LIMIT_COUNT)
-
-EVENTFUNC(check_speedhack_event)
-{
-	char_event_info* info = dynamic_cast<char_event_info*>(event->info);
-	if (info == NULL)
-	{
-		sys_err("check_speedhack_event> <Factor> Null pointer");
-		return 0;
-	}
-
-	LPCHARACTER ch = info->ch;
-
-	if (NULL == ch || ch->IsNPC())
-		return 0;
-
-	if (IS_SPEED_HACK_PLAYER(ch))
-	{
-		// Write hack log
-		LogManager::instance().SpeedHackLog(ch->GetPlayerID(), ch->GetX(), ch->GetY(), ch->m_speed_hack_count);
-
-		//if (false == LC_IsEurope())
-		{
-			// Close connection
-			LPDESC desc = ch->GetDesc();
-
-			if (desc)
-			{
-				DESC_MANAGER::instance().DestroyDesc(desc);
-				return 0;
-			}
-		}
-	}
-
-	ch->m_speed_hack_count = 0;
-
-	ch->ResetComboHackCount();
-	return PASSES_PER_SEC(60);
-}
-
-void CHARACTER::StartCheckSpeedHackEvent()
-{
-	if (m_pkCheckSpeedHackEvent)
-		return;
-
-	char_event_info* info = AllocEventInfo<char_event_info>();
-
-	info->ch = this;
-
-	m_pkCheckSpeedHackEvent = event_create(check_speedhack_event, info, PASSES_PER_SEC(60)); // 1
-}
-
-void CHARACTER::GoHome()
-{
-	WarpSet(EMPIRE_START_X(GetEmpire()), EMPIRE_START_Y(GetEmpire()));
-}
-
-void CHARACTER::SendGuildName(CGuild* pGuild)
-{
-	if (NULL == pGuild) return;
-
-	DESC* desc = GetDesc();
-
-	if (NULL == desc) return;
-	if (m_known_guild.find(pGuild->GetID()) != m_known_guild.end()) return;
-
-	m_known_guild.insert(pGuild->GetID());
-
-	TPacketGCGuildName pack;
-	memset(&pack, 0x00, sizeof(pack));
-
-	pack.header = HEADER_GC_GUILD;
-	pack.subheader = GUILD_SUBHEADER_GC_GUILD_NAME;
-	pack.size = sizeof(TPacketGCGuildName);
-	pack.guildID = pGuild->GetID();
-	memcpy(pack.guildName, pGuild->GetName(), GUILD_NAME_MAX_LEN);
-
-	desc->Packet(&pack, sizeof(pack));
-}
-
-void CHARACTER::SendGuildName(DWORD dwGuildID)
-{
-	SendGuildName(CGuildManager::instance().FindGuild(dwGuildID));
-}
-
-EVENTFUNC(destroy_when_idle_event)
-{
-	char_event_info* info = dynamic_cast<char_event_info*>(event->info);
-	if (info == NULL)
-	{
-		sys_err("destroy_when_idle_event> <Factor> Null pointer");
-		return 0;
-	}
-
-	LPCHARACTER ch = info->ch;
-
-	if (ch == NULL) // <Factor>
-		return 0;
-
-	if (ch->GetVictim())
-		return PASSES_PER_SEC(300);
-
-	sys_log(1, "DESTROY_WHEN_IDLE: %s", ch->GetName());
-
-	ch->m_pkDestroyWhenIdleEvent = NULL;
-	M2_DESTROY_CHARACTER(ch);
-	return 0;
-}
-
-void CHARACTER::StartDestroyWhenIdleEvent()
-{
-	if (m_pkDestroyWhenIdleEvent)
-		return;
-
-	char_event_info* info = AllocEventInfo<char_event_info>();
-
-	info->ch = this;
-
-	m_pkDestroyWhenIdleEvent = event_create(destroy_when_idle_event, info, PASSES_PER_SEC(300));
-}
-
-void CHARACTER::SetComboSequence(BYTE seq)
-{
-	m_bComboSequence = seq;
-}
-
-BYTE CHARACTER::GetComboSequence() const
-{
-	return m_bComboSequence;
-}
-
-void CHARACTER::SetLastComboTime(DWORD time)
-{
-	m_dwLastComboTime = time;
-}
-
-#ifdef __SHOP_SEARCH__
-bool CHARACTER::CheckShopSearchFlood()
-{
-	const DWORD now = get_dword_time();
-
-	// reset burst if enough time passed
-	if (now - m_dwLastShopSearchRequestTime > 2000)
-		m_bShopSearchFloodCount = 0;
-
-	const DWORD delta = now - m_dwLastShopSearchRequestTime;
-	m_dwLastShopSearchRequestTime = now;
-
-	// Allow at most ~1 request / 700ms. Faster => ignore, repeated => disconnect.
-	if (delta < 700)
-	{
-		if (m_bShopSearchFloodCount < 255)
-			++m_bShopSearchFloodCount;
-
-		if (m_bShopSearchFloodCount >= 8)
-		{
-			sys_log(0, "SHOP_SEARCH_FLOOD: pid %u name %s count %u", GetPlayerID(), GetName(), m_bShopSearchFloodCount);
-			if (GetDesc())
-				GetDesc()->DelayedDisconnect(3);
-		}
-
-		return false;
-	}
-
-	return true;
-}
-#endif
-
-DWORD CHARACTER::GetLastComboTime() const
-{
-	return m_dwLastComboTime;
-}
-
-void CHARACTER::SetValidComboInterval(int interval)
-{
-	m_iValidComboInterval = interval;
-}
-
-int CHARACTER::GetValidComboInterval() const
-{
-	return m_iValidComboInterval;
-}
-
-BYTE CHARACTER::GetComboIndex() const
-{
-	return m_bComboIndex;
-}
-
-void CHARACTER::IncreaseComboHackCount(int k)
-{
-	m_iComboHackCount += k;
-
-	if (m_iComboHackCount >= 10)
-	{
-		if (GetDesc())
-			if (GetDesc()->DelayedDisconnect(number(2, 7)))
-			{
-				sys_log(0, "COMBO_HACK_DISCONNECT: %s count: %d", GetName(), m_iComboHackCount);
-				LogManager::instance().HackLog("Combo", this);
-			}
-	}
-}
-
-void CHARACTER::ResetComboHackCount()
-{
-	m_iComboHackCount = 0;
-}
-
-void CHARACTER::SkipComboAttackByTime(int interval)
-{
-	m_dwSkipComboAttackByTime = get_dword_time() + interval;
-}
-
-DWORD CHARACTER::GetSkipComboAttackByTime() const
-{
-	return m_dwSkipComboAttackByTime;
-}
-
-// ̳ ٸ Ÿ ֳ?
-bool CHARACTER::IsRiding() const
-{
-	return IsHorseRiding() || GetMountVnum();
-}
-
-bool CHARACTER::CanWarp() const
-{
-	const int iPulse = thecore_pulse();
-	const int limit_time = PASSES_PER_SEC(g_nPortalLimitTime);
-
-	if ((iPulse - GetSafeboxLoadTime()) < limit_time)
-		return false;
-
-	if ((iPulse - GetExchangeTime()) < limit_time)
-		return false;
-
-	if ((iPulse - GetMyShopTime()) < limit_time)
-		return false;
-
-	if ((iPulse - GetRefineTime()) < limit_time)
-		return false;
-
-#if defined(__MAILBOX__)
-	if ((iPulse - GetMyMailBoxTime()) < limit_time)
-		return false;
-#endif
-
-	if (PreventTradeWindow(WND_ALL))
-		return false;
-
-	return true;
-}
-
-DWORD CHARACTER::GetNextExp() const
-{
-	if (PLAYER_EXP_TABLE_MAX < GetLevel())
-		return 2500000000;
-	else
-		return exp_table[GetLevel()];
-}
-
-#if defined(__CONQUEROR_LEVEL__)
-DWORD CHARACTER::GetNextConquerorExp() const
-{
-	if (PLAYER_CONQUEROR_EXP_TABLE_MAX < GetConquerorLevel())
-		return 2500000000;
-	else
-		return conqueror_exp_table[GetConquerorLevel()];
-}
-#endif
-
-int CHARACTER::GetSkillPowerByLevel(int level, bool bMob) const
-{
-	return CTableBySkill::instance().GetSkillPowerByLevelFromType(GetJob(), GetSkillGroup(), MINMAX(0, level, SKILL_MAX_LEVEL), bMob);
-}
-
-#ifdef __GROWTH_PET_SYSTEM__
-bool CHARACTER::SetGrowthPet(LPGROWTH_PET pkPet)
-{
-	auto it = m_growthPetMap.find(pkPet->GetPetID());
-
-	if (it != m_growthPetMap.end())
-		m_growthPetMap.erase(it);
-
-	if (pkPet->GetOwner() != this)
-		pkPet->SetOwner(this);
-
-	m_growthPetMap.emplace(pkPet->GetPetID(), pkPet);
-
-	TPacketGCPetSet packet;
-	packet.header = HEADER_GC_PET_SET;
-	packet.dwID = pkPet->GetPetID();
-	packet.dwSummonItemVnum = pkPet->GetSummonItemVnum();
-
-	strlcpy(packet.szName, pkPet->GetPetName().c_str(), sizeof(packet.szName));
-	thecore_memcpy(packet.aSkill, pkPet->GetPetSkill(), sizeof(packet.aSkill));
-
-	for (int i = 0; i < POINT_UPBRINGING_MAX_NUM; i++)
-		packet.dwPoints[i] = pkPet->GetPetPoint(i);
-
-	if(GetDesc())
-		GetDesc()->Packet(&packet, sizeof(packet));
-
-	return true;
-}
-
-bool CHARACTER::DeleteGrowthPet(DWORD dwID)
-{
-	auto it = m_growthPetMap.find(dwID);
-
-	if (it == m_growthPetMap.end())
-		return false;
-
-	m_growthPetMap.erase(it);
-
-	TPacketGCPetDelete packet;
-	packet.header = HEADER_GC_PET_DEL;
-	packet.dwID = dwID;
-
-	if (GetDesc())
-		GetDesc()->Packet(&packet, sizeof(packet));
-
-	return true;
-}
-
-LPGROWTH_PET CHARACTER::GetGrowthPet(DWORD dwID)
-{
-	auto it = m_growthPetMap.find(dwID);
-
-	if (it != m_growthPetMap.end())
-		return it->second;
-
-	return nullptr;
-}
-
-void CHARACTER::ClearGrowthPet()
-{
-	if (m_activeGrowthPet)
-		m_activeGrowthPet->Unsummon(false);
-
-	if (m_growthPetMap.size())
-	{
-		auto it = m_growthPetMap.begin();
-
-		while (it != m_growthPetMap.end())
-		{
-			LPGROWTH_PET pPet = it->second;
-
-			pPet->Save();
-
-			// Increase the iterator before deleting pet pointer
-			++it;
-
-			CGrowthPetManager::Instance().DeleteGrowthPet(pPet->GetPetID());
-		}
-
-		m_growthPetMap.clear();
-	}
-}
-#endif
-
-bool CHARACTER::IsInSafezone() const
-{
-	LPSECTREE sectree = GetSectree();
-	return (sectree && sectree->IsAttr(GetX(), GetY(), ATTR_BANPK));
-}
-
-bool CHARACTER::IsInBlockedArea(long x, long y) const
-{
-	LPSECTREE sectree = GetSectree();
-	return (sectree && sectree->IsAttr(x > 0 ? x : GetX(), x > 0 ? y : GetY(), ATTR_BLOCK | ATTR_OBJECT));
-}
-
-#if defined(__MOVE_CHANNEL__)
-EVENTINFO(move_channel_info)
-{
-	DynamicCharacterPtr ch;
-	int iSec;
-	long lNewAddr;
-	WORD wNewPort;
-
-	move_channel_info()
-		: iSec(0),
-		ch(),
-		lNewAddr(0),
-		wNewPort(0)
-	{
-	}
-};
-
-EVENTFUNC(move_channel)
-{
-	move_channel_info* info = dynamic_cast<move_channel_info*>(event->info);
-
-	if (!info) // no info
-		return 0;
-
-	LPCHARACTER ch = info->ch;
-
-	if (!ch) // no char
-		return 0;
-
-	if (!ch->GetDesc()) // no desc
-		return 0;
-
-	if (info->iSec > 0)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Moving channel in %d seconds.", info->iSec));
-		--info->iSec;
-		return PASSES_PER_SEC(1);
-	}
-
-	ch->MoveChannel(info->lNewAddr, info->wNewPort);
-	ch->m_pkTimedEvent = NULL;
-
-	return 0;
-}
-
-bool CHARACTER::MoveChannel(long lNewAddr, WORD wNewPort)
-{
-	if (!IsPC())
-		return false;
-
-	if (!CanWarp())
-		return false;
-
-	if (!GetDesc())
-		return false;
-
-	long x = GetX();
-	long y = GetY();
-
-	long lAddr = lNewAddr;
-	long lMapIndex = GetMapIndex();
-	WORD wPort = wNewPort;
-
-	if (lMapIndex >= 10000)
-	{
-		sys_err("Invalid change channel request from dungeon %d!", lMapIndex);
-		return false;
-	}
-
-	if (g_bChannel == 99)
-	{
-		sys_err("%s attempted to change channel from CH99, ignoring request.", GetName());
-		return false;
-	}
-
-	Stop();
-	Save();
-
-	if (GetSectree())
-	{
-		GetSectree()->RemoveEntity(this);
-		ViewCleanup();
-
-		EncodeRemovePacket(this);
-	}
-
-	m_lWarpMapIndex = lMapIndex;
-	m_posWarp.x = x;
-	m_posWarp.y = y;
-
-	sys_log(0, "ChangeChannel %s, %ld %ld map %ld to port %d", GetName(), x, y, GetMapIndex(), wPort);
-
-	TPacketGCWarp p;
-
-	p.bHeader = HEADER_GC_WARP;
-	p.lX = x;
-	p.lY = y;
-#if defined(__PROXY_IP__)
-	p.lAddr = g_stProxyIP.empty() ? lAddr : inet_addr(g_stProxyIP.c_str());
-#else
-	p.lAddr = lAddr;
-#endif
-	p.wPort = wPort;
-
-	GetDesc()->Packet(&p, sizeof(p));
-
-	char buf[256];
-	snprintf(buf, sizeof(buf), "%s Port%d Map%ld x%ld y%ld", GetName(), wPort, GetMapIndex(), x, y);
-	LogManager::instance().CharLog(this, 0, "CHANGE_CH", buf);
-
-	return true;
-}
-
-bool CHARACTER::StartMoveChannel(long lNewAddr, WORD wNewPort)
-{
-	if (IsHack(false, true, 10))
-		return false;
-
-	move_channel_info* info = AllocEventInfo<move_channel_info>();
-	info->ch = this;
-	info->iSec = CanWarp() && !IsPosition(POS_FIGHTING) ? 3 : 10;
-	info->lNewAddr = lNewAddr;
-	info->wNewPort = wNewPort;
-
-	m_pkTimedEvent = event_create(move_channel, info, 1);
-
-	return true;
-}
-#endif
-
-#if defined(__CHANGE_LOOK_SYSTEM__)
-void CHARACTER::SetChangeLook(CChangeLook* pChangeLook)
-{
-	if (m_pkChangeLook != nullptr)
-		delete m_pkChangeLook;
-
-	m_pkChangeLook = pChangeLook;
-}
-
-CChangeLook* CHARACTER::GetChangeLook() const
-{
-	return m_pkChangeLook;
-}
-#endif
-
-#if defined(__MAILBOX__)
-void CHARACTER::SetMailBox(CMailBox* m)
-{
-	if (m_pkMailBox)
-		delete m_pkMailBox;
-
-	m_pkMailBox = m;
-}
-#endif
-
-#if defined(__MINI_GAME_RUMI__)
-void CHARACTER::SetMiniGameRumi(CMiniGameRumi* pClass)
-{
-	if (m_pkMiniGameRumi)
-		delete m_pkMiniGameRumi;
-
-	m_pkMiniGameRumi = pClass;
-}
-#endif
-
-#if defined(__MINI_GAME_YUTNORI__)
-void CHARACTER::SetMiniGameYutnori(CMiniGameYutnori* pClass)
-{
-	if (m_pkMiniGameYutnori)
-		delete m_pkMiniGameYutnori;
-
-	m_pkMiniGameYutnori = pClass;
-}
-#endif
-
-#if defined(__CONQUEROR_LEVEL__)
-void CHARACTER::SetConqueror(bool bSet)
-{
-	if (bSet)
-	{
-		if (GetConquerorLevel() > 0)
-		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("You have already reached the Champion Level."));
-			return;
-		}
-
-		DWORD dwNextExp = GetNextExp() / 4;
-		if ((GetLevel() < gPlayerMaxLevel) || (GetLevel() >= gPlayerMaxLevel && GetExp() < dwNextExp))
-		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("You must fill up at least 1 EXP Marble at level 120 to reach Champion Level."));
-			return;
-		}
-	}
-
-	PointChange(POINT_CONQUEROR_LEVEL, MINMAX(0, bSet ? 1 : 0, gPlayerMaxLevel) - GetConquerorLevel(), false, true);
-
-	SetRealPoint(POINT_CONQUEROR_LEVEL_STEP, 0);
-	SetPoint(POINT_CONQUEROR_LEVEL_STEP, GetRealPoint(POINT_CONQUEROR_LEVEL_STEP));
-
-	SetRealPoint(POINT_CONQUEROR_POINT, 0);
-	SetPoint(POINT_CONQUEROR_POINT, GetRealPoint(POINT_CONQUEROR_POINT));
-
-	SetRealPoint(POINT_SUNGMA_STR, 0);
-	SetPoint(POINT_SUNGMA_STR, GetRealPoint(POINT_SUNGMA_STR));
-
-	SetRealPoint(POINT_SUNGMA_HP, 0);
-	SetPoint(POINT_SUNGMA_HP, GetRealPoint(POINT_SUNGMA_HP));
-
-	SetRealPoint(POINT_SUNGMA_MOVE, 0);
-	SetPoint(POINT_SUNGMA_MOVE, GetRealPoint(POINT_SUNGMA_MOVE));
-
-	SetRealPoint(POINT_SUNGMA_IMMUNE, 0);
-	SetPoint(POINT_SUNGMA_IMMUNE, GetRealPoint(POINT_SUNGMA_IMMUNE));
-
-	SetConquerorExp(0);
-
-	ComputePoints();
-	PointsPacket();
-	UpdatePointsPacket(POINT_CONQUEROR_EXP, GetConquerorExp());
-}
-
-bool CHARACTER::IsNewWorldMapIndex() const
-{
-	return SECTREE_MANAGER::Instance().IsNewWorldMapIndex(GetMapIndex());
-}
-
-long CHARACTER::GetNewWorldSungMa(POINT_TYPE wPointType, bool bPremium) const
-{
-	if (!IsPC())
-		return 0;
-
-	if (!GetConquerorLevel())
-		return 0;
-
-	return SECTREE_MANAGER::Instance().GetNewWorldSungMa(GetMapIndex(), wPointType);
-}
-
-bool CHARACTER::IsSungMaCursed(const POINT_TYPE wPointType) const
-{
-	if (GetNewWorldSungMa(wPointType) > GetPoint(wPointType))
-		return true;
-
-	return false;
-}
-#endif
-
-#if defined(__LOOT_FILTER_SYSTEM__)
-CLootFilter* CHARACTER::GetLootFilter()
-{
-	return m_pLootFilter;
-}
-
-void CHARACTER::SetLootFilter()
-{
-	if (!GetDesc())
-		return;
-
-	if (m_pLootFilter)
-		return;
-
-	m_pLootFilter = new CLootFilter();
-
-	TPacketGCLootFilter p;
-	p.header = HEADER_GC_LOOT_FILTER;
-	p.enable = true;
-	p.vid = 0;
-	GetDesc()->Packet(&p, sizeof(p));
-}
-
-void CHARACTER::ClearLootFilter()
-{
-	if (m_pLootFilter)
-	{
-		delete m_pLootFilter;
-		m_pLootFilter = nullptr;
-	}
-}
-#endif
-
-#if defined(__GEM_SYSTEM__)
-void CHARACTER::SelectItemEx(DWORD dwInventoryPos, BYTE bType)
-{
-	const LPITEM c_lpMetinStoneItem = GetInventoryItem(dwInventoryPos);
-	if (c_lpMetinStoneItem == nullptr)
-		return;
-
-	switch (bType)
-	{
-		default:
-			GemRefine(c_lpMetinStoneItem);
-			break;
-	}
-
-	ChatPacket(CHAT_TYPE_COMMAND, "BINARY_RefreshSelectItemWindowEx");
-}
-
-bool CHARACTER::GemRefine(LPITEM lpMetinStoneItem)
-{
-	const SGemRefineInfo* pGemRefineInfo = &ITEM_MANAGER::instance().GetGemRefineInfo();
-	if (pGemRefineInfo == nullptr)
-		return false;
-
-	TItemTable* pItemTable = ITEM_MANAGER::instance().GetTable(pGemRefineInfo->dwRefineItemVNum);
-	if (!pItemTable || CountSpecifyItem(pItemTable->dwVnum) < pGemRefineInfo->wRefineItemCount)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Gaya] You don't have enough Glimmerstones."));
-		return false;
-	}
-
-	if (GetGem() + pGemRefineInfo->wRefineResultCount >= GEM_MAX)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Gaya] You already have the maximum amount of Gaya."));
-		return 0;
-	}
-
-	if (GetGold() < pGemRefineInfo->wRefineCost)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Gaya] You don't have enough Yang to cut Glimmerstones."));
-		return false;
-	}
-
-	RemoveSpecifyItem(pItemTable->dwVnum, pGemRefineInfo->wRefineItemCount);
-	PointChange(POINT_GOLD, static_cast<int64_t>(-pGemRefineInfo->wRefineCost));
-
-	if (lpMetinStoneItem)
-		lpMetinStoneItem->SetCount(lpMetinStoneItem->GetCount() - 1);
-
-	BYTE bRefinePct = pGemRefineInfo->bRefinePct;
-#	if defined(__CONQUEROR_LEVEL__)
-	bRefinePct = (GetMapIndex() == pGemRefineInfo->iRefineSpecialMapIndex ? pGemRefineInfo->bRefinePctSpecial : pGemRefineInfo->bRefinePct);
-#	endif
-
-	if (number(1, 100) <= bRefinePct)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Gaya] Cutting successful."));
-		PointChange(POINT_GEM, pGemRefineInfo->wRefineResultCount);
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-		UpdateExtBattlePassMissionProgress(GAYA_CRAFT_GAYA, pGemRefineInfo->wRefineResultCount, 0);
-#endif
-		return true;
-	}
-	else
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Gaya] Cutting failed."));
-
-	return false;
-}
-
-#	if defined(__GEM_SHOP__)
-void CHARACTER::SetGemShop(CGemShop* pGemShop)
-{
-	if (m_pGemShop != nullptr)
-		delete m_pGemShop;
-
-	m_pGemShop = pGemShop;
-}
-#	endif
-#endif
-
-#if defined(__EXTEND_INVEN_SYSTEM__)
-void CHARACTER::ExtendInvenRequest()
-{
-	const LPDESC c_pDesc = GetDesc();
-	if (c_pDesc == nullptr)
-		return;
-
-	if (GetExtendInvenStage() >= EX_INVENTORY_STAGE_MAX)
-	{
-		TPacketGCExtendInvenItemUse Packet;
-		Packet.bHeader = HEADER_GC_EXTEND_INVEN_ITEM_USE;
-		Packet.bMsgResult = EX_INVEN_FAIL_FOURTH_PAGE_STAGE_MAX;
-		Packet.bEnoughCount = 0;
-		c_pDesc->Packet(&Packet, sizeof(TPacketGCExtendInvenItemUse));
-		return;
-	}
-
-	const BYTE c_bNeedKeys = abInvenStageKeys[GetExtendInvenStage()];
-	WORD wTicketCount = 0;
-	LPITEM pItem = nullptr;
-	for (WORD wCell = 0; wCell < GetExtendInvenMax(); ++wCell)
-	{
-		pItem = GetInventoryItem(wCell);
-		if (pItem == nullptr)
-			continue;
-
-		switch (pItem->GetVnum())
-		{
-			case ITEM_EXTEND_INVEN_TICKET:
-			case ITEM_EXTEND_INVEN_TICKET_MALL:
-				wTicketCount += pItem->GetCount();
-				break;
-		}
-	}
-
-	TPacketGCExtendInvenItemUse Packet;
-	Packet.bHeader = HEADER_GC_EXTEND_INVEN_ITEM_USE;
-	if (wTicketCount >= c_bNeedKeys)
-	{
-		Packet.bMsgResult = EX_INVEN_SUCCESS;
-		Packet.bEnoughCount = c_bNeedKeys;
-	}
-	else
-	{
-		Packet.bMsgResult = EX_INVEN_FAIL_FALL_SHORT;
-		Packet.bEnoughCount = MINMAX(0, c_bNeedKeys - wTicketCount, c_bNeedKeys);
-	}
-	c_pDesc->Packet(&Packet, sizeof(TPacketGCExtendInvenItemUse));
-}
-
-void CHARACTER::ExtendInvenUpgrade()
-{
-	const BYTE c_bStage = GetExtendInvenStage();
-	if (c_bStage >= EX_INVENTORY_STAGE_MAX)
-		return;
-
-	if (GetExchange())
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot expand your inventory while trading."));
-		return;
-	}
-
-	const WORD c_wMaxInven = GetExtendInvenMax();
-
-	LPITEM pItem = nullptr;
-	WORD wTicketCount = 0;
-
-	std::vector<WORD> vTicketCells;
-	vTicketCells.reserve(c_wMaxInven);
-
-	for (WORD wCell = 0; wCell < c_wMaxInven; ++wCell)
-	{
-		pItem = GetInventoryItem(wCell);
-		if (pItem == nullptr)
-			continue;
-
-		const DWORD dwVnum = pItem->GetVnum();
-		if (dwVnum == ITEM_EXTEND_INVEN_TICKET || dwVnum == ITEM_EXTEND_INVEN_TICKET_MALL)
-		{
-			wTicketCount += pItem->GetCount();
-			vTicketCells.emplace_back(pItem->GetCell());
-		}
-	}
-
-	const BYTE c_bNeedKeys = abInvenStageKeys[c_bStage];
-	if (wTicketCount < c_bNeedKeys)
-		return;
-
-	SetExtendInvenStage(c_bStage + 1);
-	SendExtendInvenPacket();
-
-	for (BYTE bKey = 0; bKey < c_bNeedKeys; ++bKey)
-	{
-		for (const WORD wCell : vTicketCells)
-		{
-			if (pItem = GetInventoryItem(wCell))
-			{
-				RemoveSpecifyItem(pItem->GetVnum());
-				break;
-			}
-		}
-	}
-}
-
-void CHARACTER::SendExtendInvenPacket()
-{
-	TPacketGCExtendInven Packet;
-	Packet.bHeader = HEADER_GC_EXTEND_INVEN;
-	Packet.bStage = GetExtendInvenStage();
-	Packet.wMaxNum = GetExtendInvenMax();
-	GetDesc()->Packet(&Packet, sizeof(TPacketGCExtendInven));
-}
-
-WORD CHARACTER::GetExtendInvenMax() const
-{
-	BYTE bPageSize = INVENTORY_PAGE_SIZE * EX_INVENTORY_PAGE_COUNT;
-	WORD wMaxNum = bPageSize + (INVENTORY_WIDTH * GetExtendInvenStage());
-	if (wMaxNum >= INVENTORY_MAX_NUM)
-		return INVENTORY_MAX_NUM;
-
-	return wMaxNum;
-}
-#endif
-
-#if defined(__ATTR_6TH_7TH__)
-EVENTFUNC(hit_buff_event)
-{
-	const char_event_info* info = dynamic_cast<char_event_info*>(event->info);
-	if (info == nullptr)
-	{
-		sys_err("hit_buff_event> <Factor> Null pointer");
-		return 0;
-	}
-
-	const LPCHARACTER ch = info->ch;
-	if (ch == nullptr)
-		return 0;
-
-	const int buff_cooldown = 60;
-	const long buff_value = 30;
-	std::unordered_map<WORD, WORD> map_buff_point
-	{
-		{ POINT_HIT_BUFF_ENCHANT_FIRE, POINT_ENCHANT_FIRE },
-		{ POINT_HIT_BUFF_ENCHANT_ICE, POINT_ENCHANT_ICE },
-		{ POINT_HIT_BUFF_ENCHANT_ELEC, POINT_ENCHANT_ELECT },
-		{ POINT_HIT_BUFF_ENCHANT_WIND, POINT_ENCHANT_WIND },
-		{ POINT_HIT_BUFF_ENCHANT_DARK, POINT_ENCHANT_DARK },
-		{ POINT_HIT_BUFF_ENCHANT_EARTH, POINT_ENCHANT_EARTH },
-		{ POINT_HIT_BUFF_RESIST_FIRE, POINT_ENCHANT_FIRE },
-		{ POINT_HIT_BUFF_RESIST_ICE, POINT_RESIST_ICE },
-		{ POINT_HIT_BUFF_RESIST_ELEC, POINT_RESIST_ELEC },
-		{ POINT_HIT_BUFF_RESIST_WIND, POINT_RESIST_WIND },
-		{ POINT_HIT_BUFF_RESIST_DARK, POINT_RESIST_DARK },
-		{ POINT_HIT_BUFF_RESIST_EARTH, POINT_RESIST_EARTH },
-
-		{ POINT_HIT_BUFF_SUNGMA_STR, POINT_SUNGMA_STR },
-		{ POINT_HIT_BUFF_SUNGMA_MOVE, POINT_SUNGMA_MOVE },
-		{ POINT_HIT_BUFF_SUNGMA_HP, POINT_SUNGMA_HP },
-		{ POINT_HIT_BUFF_SUNGMA_IMMUNE , POINT_SUNGMA_IMMUNE },
-	};
-
-	for (const auto& point : map_buff_point)
-	{
-		const auto buff_time = ch->GetPoint(point.first);
-		if (buff_time != 0)
-			ch->AddAffect(AFFECT_ELEMENT_BUFF_CRACK, point.second, buff_value, AFF_NONE, buff_time, 0, true, true);
-	}
-
-	return PASSES_PER_SEC(buff_cooldown);
-}
-
-void CHARACTER::StartHitBuffEvent()
-{
-	if (m_pHitBuffEvent)
-		return;
-
-	char_event_info* info = AllocEventInfo<char_event_info>();
-	info->ch = this;
-	m_pHitBuffEvent = event_create(hit_buff_event, info, PASSES_PER_SEC(1));
-}
-
-void CHARACTER::StopHitBuffEvent()
-{
-	event_cancel(&m_pHitBuffEvent);
-}
-#endif
-
-#if defined(__CLIENT_TIMER__)
-void CHARACTER::SendClientTimer(BYTE bSubHeader, DWORD dwEndTime, DWORD dwAlarmSec)
-{
-	TPacketGCClientTimer Packet(bSubHeader);
-	Packet.dwData[ECLIENT_TIMER_END_TIME] = std::time(nullptr) + dwEndTime;
-	Packet.dwData[ECLIENT_TIMER_ALARM_SECOND] = dwAlarmSec;
-	GetDesc()->Packet(&Packet, sizeof(TPacketGCClientTimer));
-}
-#endif
-
-#if defined(__EXPRESSING_EMOTIONS__)
-void CHARACTER::AddEmote(const INT iEmoteIndex)
-{
-	TPacketGDEmote GDPacket = {};
-	GDPacket.dwPID = GetPlayerID();
-	if (iEmoteIndex == 0)
-		db_clientdesc->DBPacket(HEADER_GD_EMOTE_CLEAR, GetDesc()->GetHandle(), &GDPacket, sizeof(GDPacket));
-	else
-	{
-		GDPacket.dwVnum = iEmoteIndex != -1 ? iEmoteIndex : number(SPECIAL_ACTION_START_INDEX, EMOTION_NUM - 1);
-		GDPacket.dwDuration = SPECIAL_ACTION_DURATION;
-
-		int iQFValue = quest::CQuestManager::Instance().GetEventFlag("special_action_duration");
-		if (iQFValue != 0)
-			GDPacket.dwDuration = iQFValue;
-
-		db_clientdesc->DBPacket(HEADER_GD_EMOTE_ADD, GetDesc()->GetHandle(), &GDPacket, sizeof(GDPacket));
-	}
-}
-
-void CHARACTER::SetEmotes(const TPacketGDEmote* pTable, const WORD c_wSize)
-{
-	if (c_wSize == 0)
-	{
-		TPacketGCEmote GCPacket = {};
-		GCPacket.bHeader = HEADER_GC_EMOTE;
-		GCPacket.bSubHeader = SUBHEADER_EMOTE_CLEAR;
-		GetDesc()->Packet(&GCPacket, sizeof(TPacketGCEmote));
-	}
-	else
-	{
-		for (WORD wSize = 0; wSize < c_wSize; ++wSize, ++pTable)
-		{
-			TPacketGCEmote GCPacket = {};
-			GCPacket.bHeader = HEADER_GC_EMOTE;
-			GCPacket.bSubHeader = SUBHEADER_EMOTE_ADD;
-			GCPacket.dwEmoteVnum = pTable->dwVnum;
-			GCPacket.dwDuration = pTable->dwDuration;
-			GetDesc()->Packet(&GCPacket, sizeof(TPacketGCEmote));
-		}
-	}
-}
-#endif
-
-#if defined(__RACE_SWAP__)
-void CHARACTER::SetEventRaceNum(DWORD dwRaceNum)
-{
-	if (m_dwEventRaceNum == dwRaceNum)
-		return;
-
-	m_dwEventRaceNum = dwRaceNum;
-
-	sys_log(0, "EVENT_RACE: %s race %u ", GetName(), dwRaceNum);
-
-	SET_BIT(m_bAddChrState, ADD_CHARACTER_STATE_SPAWN);
-	m_afAffectFlag.Set(AFF_SPAWN);
-
-	ViewReencode();
-
-	REMOVE_BIT(m_bAddChrState, ADD_CHARACTER_STATE_SPAWN);
-
-	SetValidComboInterval(0);
-}
-#endif
-
-#if defined(__HIDE_COSTUME_SYSTEM__)
-void CHARACTER::SetHiddenCostumePart(BYTE bCostumeSubType, bool bHidden, bool bSave)
+			// SyncOwner  Owner ǥѴ.
+			if (m_pkChrSyncOwner == ch)
+				return true;
+
+			return false;
+		}
+
+		if (m_pkChrSyncOwner != ch)
+		{
+			if (m_pkChrSyncOwner)
+			{
+				sys_log(1, "SyncRelease %s %p from %s", GetName(), this, m_pkChrSyncOwner->GetName());
+				m_pkChrSyncOwner->m_kLst_pkChrSyncOwned.remove(this);
+			}
+
+			m_pkChrSyncOwner = ch;
+			m_pkChrSyncOwner->m_kLst_pkChrSyncOwned.push_back(this);
+
+			// SyncOwner ٲ LastSyncTime ʱȭѴ.
+			static const timeval zero_tv = { 0, 0 };
+			SetLastSyncTime(zero_tv);
+
+			sys_log(1, "SetSyncOwner set %s %p to %s", GetName(), this, ch->GetName());
+		}
+
+		m_fSyncTime = get_float_time();
+	}
+
+	// TODO: Sync Owner   Ŷ  Ƿ,
+	// ȭ  ð 3 ̻   Ǯִ Ŷ
+	//   ϸ Ŷ   ִ.
+	TPacketGCOwnership pack;
+
+	pack.bHeader = HEADER_GC_OWNERSHIP;
+	pack.dwOwnerVID = ch ? ch->GetVID() : 0;
+	pack.dwVictimVID = GetVID();
+
+	PacketAround(&pack, sizeof(TPacketGCOwnership));
+	return true;
+}
+
+struct FuncClearSync
 {
-	switch (bCostumeSubType)
+	void operator () (LPCHARACTER ch)
 	{
-		case COSTUME_BODY:
-		case COSTUME_HAIR:
-#if defined(__ACCE_COSTUME_SYSTEM__)
-		case COSTUME_ACCE:
+		assert(ch != NULL);
+		ch->SetSyncOwner(NULL, false); // false ÷׷ ؾ for_each   .
+	}
+};
+
+void CHARACTER::ClearSync()
+{
+	SetSyncOwner(NULL);
+
+	// Ʒ for_each  m_pkChrSyncOwner  ڵ ͸ NULL Ѵ.
+	std::for_each(m_kLst_pkChrSyncOwned.begin(), m_kLst_pkChrSyncOwned.end(), FuncClearSync());
+	m_kLst_pkChrSyncOwned.clear();
+}
+
+bool CHARACTER::IsSyncOwner(LPCHARACTER ch) const
+{
+	if (m_pkChrSyncOwner == ch)
+		return true;
+
+	//  ȭ  ð 3 ̻ ٸ  ƹԵ
+	// .  ƹ SyncOwner̹Ƿ true 
+	if (get_float_time() - m_fSyncTime >= 3.0f)
+		return true;
+
+	return false;
+}
+
+void CHARACTER::SetParty(LPPARTY pkParty)
+{
+	if (pkParty == m_pkParty)
+		return;
+
+	if (pkParty && m_pkParty)
+		sys_err("%s is trying to reassigning party (current %p, new party %p)", GetName(), get_pointer(m_pkParty), get_pointer(pkParty));
+
+	sys_log(1, "PARTY set to %p", get_pointer(pkParty));
+
+	//if (m_pkDungeon && IsPC())
+	//	SetDungeon(NULL);
+	m_pkParty = pkParty;
+
+	if (IsPC())
+	{
+		if (m_pkParty)
+			SET_BIT(m_bAddChrState, ADD_CHARACTER_STATE_PARTY);
+		else
+			REMOVE_BIT(m_bAddChrState, ADD_CHARACTER_STATE_PARTY);
+
+		UpdatePacket();
+	}
+}
+
+// PARTY_JOIN_BUG_FIX
+/// Ƽ  event 
+EVENTINFO(TPartyJoinEventInfo)
+{
+	DWORD dwGuestPID; ///< Ƽ  ĳ PID
+	DWORD dwLeaderPID; ///< Ƽ  PID
+
+	TPartyJoinEventInfo()
+		: dwGuestPID(0)
+		, dwLeaderPID(0)
+	{
+	}
+};
+
+EVENTFUNC(party_request_event)
+{
+	TPartyJoinEventInfo* info = dynamic_cast<TPartyJoinEventInfo*>(event->info);
+
+	if (info == NULL)
+	{
+		sys_err("party_request_event> <Factor> Null pointer");
+		return 0;
+	}
+
+	LPCHARACTER ch = CHARACTER_MANAGER::instance().FindByPID(info->dwGuestPID);
+
+	if (ch)
+	{
+		sys_log(0, "PartyRequestEvent %s", ch->GetName());
+		ch->ChatPacket(CHAT_TYPE_COMMAND, "PartyRequestDenied");
+		ch->SetPartyRequestEvent(NULL);
+	}
+
+	return 0;
+}
+
+bool CHARACTER::RequestToParty(LPCHARACTER leader)
+{
+	if (leader->GetParty())
+		leader = leader->GetParty()->GetLeaderCharacter();
+
+	if (!leader)
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ƽ  ° ƴ϶ û   ϴ."));
+		return false;
+	}
+
+	if (m_pkPartyRequestEvent)
+		return false;
+
+	if (!IsPC() || !leader->IsPC())
+		return false;
+
+	if (leader->IsBlockMode(BLOCK_PARTY_REQUEST))
+		return false;
+
+	PartyJoinErrCode errcode = IsPartyJoinableCondition(leader, this);
+
+	switch (errcode)
+	{
+	case PERR_NONE:
+		break;
+
+	case PERR_SERVER:
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ>   Ƽ  ó   ϴ."));
+		return false;
+
+	case PERR_DIFFEMPIRE:
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> ٸ  Ƽ ̷  ϴ."));
+		return false;
+
+	case PERR_DUNGEON:
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ>  ȿ Ƽ ʴ븦   ϴ."));
+		return false;
+
+	case PERR_OBSERVER:
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ>  忡 Ƽ ʴ븦   ϴ."));
+		return false;
+
+	case PERR_LVBOUNDARY:
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> -30 ~ +30  ̳ 游 ʴ  ֽϴ."));
+		return false;
+
+	case PERR_LOWLEVEL:
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> Ƽ ְ   30  ʴ  ϴ."));
+		return false;
+
+	case PERR_HILEVEL:
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> Ƽ    30  ʴ  ϴ."));
+		return false;
+
+	case PERR_ALREADYJOIN:
+		return false;
+
+	case PERR_PARTYISFULL:
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ>  ̻ Ƽ ʴ  ϴ."));
+		return false;
+
+	default:
+		sys_err("Do not process party join error(%d)", errcode);
+		return false;
+	}
+
+	TPartyJoinEventInfo* info = AllocEventInfo<TPartyJoinEventInfo>();
+
+	info->dwGuestPID = GetPlayerID();
+	info->dwLeaderPID = leader->GetPlayerID();
+
+	SetPartyRequestEvent(event_create(party_request_event, info, PASSES_PER_SEC(10)));
+
+#if defined(__WJ_NEW_USER_CARE__)
+	leader->ChatPacket(CHAT_TYPE_COMMAND, "PartyRequest %u %s", (DWORD)GetVID(), GetName());
+#else
+	leader->ChatPacket(CHAT_TYPE_COMMAND, "PartyRequest %u", (DWORD)GetVID());
 #endif
-#if defined(__ACCE_COSTUME_SYSTEM__)
-		case COSTUME_WEAPON:
+	ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s Կ Ƽ û ߽ϴ."), leader->GetName());
+	return true;
+}
+
+void CHARACTER::DenyToParty(LPCHARACTER member)
+{
+	sys_log(1, "DenyToParty %s member %s %p", GetName(), member->GetName(), get_pointer(member->m_pkPartyRequestEvent));
+
+	if (!member->m_pkPartyRequestEvent)
+		return;
+
+	TPartyJoinEventInfo* info = dynamic_cast<TPartyJoinEventInfo*>(member->m_pkPartyRequestEvent->info);
+
+	if (!info)
+	{
+		sys_err("CHARACTER::DenyToParty> <Factor> Null pointer");
+		return;
+	}
+
+	if (info->dwGuestPID != member->GetPlayerID())
+		return;
+
+	if (info->dwLeaderPID != GetPlayerID())
+		return;
+
+	event_cancel(&member->m_pkPartyRequestEvent);
+
+	member->ChatPacket(CHAT_TYPE_COMMAND, "PartyRequestDenied");
+}
+
+void CHARACTER::AcceptToParty(LPCHARACTER member)
+{
+	sys_log(1, "AcceptToParty %s member %s %p", GetName(), member->GetName(), get_pointer(member->m_pkPartyRequestEvent));
+
+	if (!member->m_pkPartyRequestEvent)
+		return;
+
+	TPartyJoinEventInfo* info = dynamic_cast<TPartyJoinEventInfo*>(member->m_pkPartyRequestEvent->info);
+
+	if (!info)
+	{
+		sys_err("CHARACTER::AcceptToParty> <Factor> Null pointer");
+		return;
+	}
+
+	if (info->dwGuestPID != member->GetPlayerID())
+		return;
+
+	if (info->dwLeaderPID != GetPlayerID())
+		return;
+
+	event_cancel(&member->m_pkPartyRequestEvent);
+
+	if (!GetParty())
+		member->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" Ƽ  ʽϴ."));
+	else
+	{
+		if (GetPlayerID() != GetParty()->GetLeaderPID())
+			return;
+
+		PartyJoinErrCode errcode = IsPartyJoinableCondition(this, member);
+		switch (errcode)
+		{
+		case PERR_NONE: member->PartyJoin(this); return;
+		case PERR_SERVER: member->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ>   Ƽ  ó   ϴ.")); break;
+		case PERR_DUNGEON: member->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ>  ȿ Ƽ ʴ븦   ϴ.")); break;
+		case PERR_OBSERVER: member->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ>  忡 Ƽ ʴ븦   ϴ.")); break;
+		case PERR_LVBOUNDARY: member->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> -30 ~ +30  ̳ 游 ʴ  ֽϴ.")); break;
+		case PERR_LOWLEVEL: member->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> Ƽ ְ   30  ʴ  ϴ.")); break;
+		case PERR_HILEVEL: member->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> Ƽ    30  ʴ  ϴ.")); break;
+		case PERR_ALREADYJOIN: break;
+		case PERR_PARTYISFULL: {
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ>  ̻ Ƽ ʴ  ϴ."));
+			member->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> Ƽ ο ʰϿ Ƽ   ϴ."));
+			break;
+		}
+		default: sys_err("Do not process party join error(%d)", errcode);
+		}
+	}
+
+	member->ChatPacket(CHAT_TYPE_COMMAND, "PartyRequestDenied");
+}
+
+/**
+* Ƽ ʴ event callback Լ.
+* event  ߵϸ ʴ  óѴ.
+**/
+EVENTFUNC(party_invite_event)
+{
+	TPartyJoinEventInfo* pInfo = dynamic_cast<TPartyJoinEventInfo*>(event->info);
+
+	if (pInfo == NULL)
+	{
+		sys_err("party_invite_event> <Factor> Null pointer");
+		return 0;
+	}
+
+	LPCHARACTER pchInviter = CHARACTER_MANAGER::instance().FindByPID(pInfo->dwLeaderPID);
+
+	if (pchInviter)
+	{
+		sys_log(1, "PartyInviteEvent %s", pchInviter->GetName());
+		pchInviter->PartyInviteDeny(pInfo->dwGuestPID);
+	}
+
+	return 0;
+}
+
+void CHARACTER::PartyInvite(LPCHARACTER pchInvitee)
+{
+	if (GetParty() && GetParty()->GetLeaderPID() != GetPlayerID())
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> Ƽ ʴ  ִ  ϴ."));
+		return;
+	}
+	else if (pchInvitee->IsBlockMode(BLOCK_PARTY_INVITE))
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> %s  Ƽ ź Դϴ."), pchInvitee->GetName());
+		return;
+	}
+
+	PartyJoinErrCode errcode = IsPartyJoinableCondition(this, pchInvitee);
+
+	switch (errcode)
+	{
+	case PERR_NONE:
+		break;
+
+	case PERR_SERVER:
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ>   Ƽ  ó   ϴ."));
+		return;
+
+	case PERR_DIFFEMPIRE:
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> ٸ  Ƽ ̷  ϴ."));
+		return;
+
+	case PERR_DUNGEON:
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ>  ȿ Ƽ ʴ븦   ϴ."));
+		return;
+
+	case PERR_OBSERVER:
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ>  忡 Ƽ ʴ븦   ϴ."));
+		return;
+
+	case PERR_LVBOUNDARY:
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> -30 ~ +30  ̳ 游 ʴ  ֽϴ."));
+		return;
+
+	case PERR_LOWLEVEL:
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> Ƽ ְ   30  ʴ  ϴ."));
+		return;
+
+	case PERR_HILEVEL:
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> Ƽ    30  ʴ  ϴ."));
+		return;
+
+	case PERR_ALREADYJOIN:
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> ̹ %s Ƽ  ֽϴ."), pchInvitee->GetName());
+		return;
+
+	case PERR_PARTYISFULL:
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ>  ̻ Ƽ ʴ  ϴ."));
+		return;
+
+	default:
+		sys_err("Do not process party join error(%d)", errcode);
+		return;
+	}
+
+	if (m_PartyInviteEventMap.end() != m_PartyInviteEventMap.find(pchInvitee->GetPlayerID()))
+		return;
+
+	//
+	// EventMap  ̺Ʈ ߰
+	//
+	TPartyJoinEventInfo* info = AllocEventInfo<TPartyJoinEventInfo>();
+
+	info->dwGuestPID = pchInvitee->GetPlayerID();
+	info->dwLeaderPID = GetPlayerID();
+
+	m_PartyInviteEventMap.insert(EventMap::value_type(pchInvitee->GetPlayerID(), event_create(party_invite_event, info, PASSES_PER_SEC(10))));
+
+	//
+	// ʴ ޴ character  ʴ Ŷ 
+	//
+
+	TPacketGCPartyInvite p;
+	p.header = HEADER_GC_PARTY_INVITE;
+	p.leader_vid = GetVID();
+	pchInvitee->GetDesc()->Packet(&p, sizeof(p));
+}
+
+void CHARACTER::PartyInviteAccept(LPCHARACTER pchInvitee)
+{
+	EventMap::iterator itFind = m_PartyInviteEventMap.find(pchInvitee->GetPlayerID());
+
+	if (itFind == m_PartyInviteEventMap.end())
+	{
+		sys_log(1, "PartyInviteAccept from not invited character(%s)", pchInvitee->GetName());
+		return;
+	}
+
+	event_cancel(&itFind->second);
+	m_PartyInviteEventMap.erase(itFind);
+
+	if (GetParty() && GetParty()->GetLeaderPID() != GetPlayerID())
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> Ƽ ʴ  ִ  ϴ."));
+		return;
+	}
+
+	PartyJoinErrCode errcode = IsPartyJoinableMutableCondition(this, pchInvitee);
+
+	switch (errcode)
+	{
+	case PERR_NONE:
+		break;
+
+	case PERR_SERVER:
+		pchInvitee->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ>   Ƽ  ó   ϴ."));
+		return;
+
+	case PERR_DUNGEON:
+		pchInvitee->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ>  ȿ Ƽ ʴ뿡   ϴ."));
+		return;
+
+	case PERR_OBSERVER:
+		pchInvitee->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ>  忡 Ƽ ʴ븦   ϴ."));
+		return;
+
+	case PERR_LVBOUNDARY:
+		pchInvitee->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> -30 ~ +30  ̳ 游 ʴ  ֽϴ."));
+		return;
+
+	case PERR_LOWLEVEL:
+		pchInvitee->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> Ƽ ְ   30  ʴ  ϴ."));
+		return;
+
+	case PERR_HILEVEL:
+		pchInvitee->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> Ƽ    30  ʴ  ϴ."));
+		return;
+
+	case PERR_ALREADYJOIN:
+		pchInvitee->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> Ƽ ʴ뿡   ϴ."));
+		return;
+
+	case PERR_PARTYISFULL:
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ>  ̻ Ƽ ʴ  ϴ."));
+		pchInvitee->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> Ƽ ο ʰϿ Ƽ   ϴ."));
+		return;
+
+	default:
+		sys_err("ignore party join error(%d)", errcode);
+		return;
+	}
+
+	//
+	// Ƽ  ó
+	//
+
+	if (GetParty())
+		pchInvitee->PartyJoin(this);
+	else
+	{
+		LPPARTY pParty = CPartyManager::instance().CreateParty(this);
+
+		pParty->Join(pchInvitee->GetPlayerID());
+		pParty->Link(pchInvitee);
+		pParty->SendPartyInfoAllToOne(this);
+	}
+}
+
+void CHARACTER::PartyInviteDeny(DWORD dwPID)
+{
+	EventMap::iterator itFind = m_PartyInviteEventMap.find(dwPID);
+
+	if (itFind == m_PartyInviteEventMap.end())
+	{
+		sys_log(1, "PartyInviteDeny to not exist event(inviter PID: %d, invitee PID: %d)", GetPlayerID(), dwPID);
+		return;
+	}
+
+	event_cancel(&itFind->second);
+	m_PartyInviteEventMap.erase(itFind);
+
+	LPCHARACTER pchInvitee = CHARACTER_MANAGER::instance().FindByPID(dwPID);
+	if (pchInvitee)
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> %s Ƽ ʴ븦 ϼ̽ϴ."), pchInvitee->GetName());
+}
+
+void CHARACTER::PartyJoin(LPCHARACTER pLeader)
+{
+	pLeader->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> %s Ƽ ϼ̽ϴ."), GetName());
+	ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> %s Ƽ ϼ̽ϴ."), pLeader->GetName());
+
+	pLeader->GetParty()->Join(GetPlayerID());
+	pLeader->GetParty()->Link(this);
+}
+
+CHARACTER::PartyJoinErrCode CHARACTER::IsPartyJoinableCondition(const LPCHARACTER pchLeader, const LPCHARACTER pchGuest)
+{
+	if (pchLeader->GetEmpire() != pchGuest->GetEmpire())
+		return PERR_DIFFEMPIRE;
+
+	return IsPartyJoinableMutableCondition(pchLeader, pchGuest);
+}
+
+static bool __party_can_join_by_level(LPCHARACTER leader, LPCHARACTER quest)
+{
+	int level_limit = 30;
+
+	if (LC_IsCanada())
+		level_limit = 15;
+	else if (LC_IsBrazil() == true)
+	{
+		level_limit = 10;
+	}
+	else
+		level_limit = 30;
+
+	return (abs(leader->GetLevel() - quest->GetLevel()) <= level_limit);
+}
+
+CHARACTER::PartyJoinErrCode CHARACTER::IsPartyJoinableMutableCondition(const LPCHARACTER pchLeader, const LPCHARACTER pchGuest)
+{
+	if (!CPartyManager::instance().IsEnablePCParty())
+		return PERR_SERVER;
+	else if (pchLeader->GetDungeon())
+		return PERR_DUNGEON;
+	else if (pchGuest->IsObserverMode())
+		return PERR_OBSERVER;
+	else if (false == __party_can_join_by_level(pchLeader, pchGuest))
+		return PERR_LVBOUNDARY;
+	else if (pchGuest->GetParty())
+		return PERR_ALREADYJOIN;
+	else if (pchLeader->GetParty())
+	{
+		if (pchLeader->GetParty()->GetMemberCount() == PARTY_MAX_MEMBER)
+			return PERR_PARTYISFULL;
+	}
+
+	return PERR_NONE;
+}
+// END_OF_PARTY_JOIN_BUG_FIX
+
+void CHARACTER::SetDungeon(LPDUNGEON pkDungeon)
+{
+	if (pkDungeon && m_pkDungeon)
+		sys_err("%s is trying to reassigning dungeon (current %p, new party %p)", GetName(), get_pointer(m_pkDungeon), get_pointer(pkDungeon));
+
+	if (m_pkDungeon == pkDungeon)
+		return;
+
+	if (m_pkDungeon)
+	{
+		if (IsPC())
+		{
+			if (GetParty())
+				m_pkDungeon->DecPartyMember(GetParty(), this);
+			else
+				m_pkDungeon->DecMember(this);
+		}
+		else if (IsMonster() || IsStone())
+		{
+			m_pkDungeon->DecMonster();
+		}
+	}
+
+	m_pkDungeon = pkDungeon;
+
+	if (pkDungeon)
+	{
+		sys_log(0, "%s DUNGEON set to %p, PARTY is %p", GetName(), get_pointer(pkDungeon), get_pointer(m_pkParty));
+
+		if (IsPC())
+		{
+			if (GetParty())
+				m_pkDungeon->IncPartyMember(GetParty(), this);
+			else
+				m_pkDungeon->IncMember(this);
+		}
+		else if (IsMonster() || IsStone())
+		{
+			m_pkDungeon->IncMonster();
+		}
+	}
+}
+
+void CHARACTER::SetWarMap(CWarMap* pWarMap)
+{
+	if (m_pWarMap)
+		m_pWarMap->DecMember(this);
+
+	m_pWarMap = pWarMap;
+
+	if (m_pWarMap)
+		m_pWarMap->IncMember(this);
+}
+
+void CHARACTER::SetWeddingMap(marriage::WeddingMap* pMap)
+{
+	if (m_pWeddingMap)
+		m_pWeddingMap->DecMember(this);
+
+	m_pWeddingMap = pMap;
+
+	if (m_pWeddingMap)
+		m_pWeddingMap->IncMember(this);
+}
+
+bool CHARACTER::IsWearingDress() const
+{
+	LPITEM pkItem = GetWear(WEAR_BODY);
+	if (pkItem && (pkItem->GetVnum() > 11900 && pkItem->GetVnum() < 11915))
+		return true;
+	return false;
+}
+
+void CHARACTER::SetRegen(LPREGEN pkRegen)
+{
+	m_pkRegen = pkRegen;
+	if (pkRegen != NULL)
+	{
+		regen_id_ = pkRegen->id;
+	}
+	m_fRegenAngle = GetRotation();
+	m_posRegen = GetXYZ();
+}
+
+bool CHARACTER::OnIdle()
+{
+	return false;
+}
+
+void CHARACTER::OnMove(bool bIsAttack)
+{
+	m_dwLastMoveTime = get_dword_time();
+
+	if (bIsAttack)
+	{
+		m_dwLastAttackTime = m_dwLastMoveTime;
+
+		if (IsAffectFlag(AFF_REVIVE_INVISIBLE))
+			RemoveAffect(AFFECT_REVIVE_INVISIBLE);
+
+		if (IsAffectFlag(AFF_EUNHYUNG))
+		{
+			RemoveAffect(SKILL_EUNHYUNG);
+			SetAffectedEunhyung();
+		}
+		else
+		{
+			ClearAffectedEunhyung();
+		}
+
+		/*
+		if (IsAffectFlag(AFF_JEONSIN))
+			RemoveAffect(SKILL_JEONSINBANGEO);
+		*/
+	}
+
+	/*
+	if (IsAffectFlag(AFF_GUNGON))
+		RemoveAffect(SKILL_GUNGON);
+	*/
+
+	// MINING
+	mining_cancel();
+	// END_OF_MINING
+}
+
+void CHARACTER::OnClick(LPCHARACTER pkChrCauser)
+{
+	if (!pkChrCauser)
+	{
+		sys_err("OnClick %s by NULL", GetName());
+		return;
+	}
+
+	DWORD vid = GetVID();
+	sys_log(0, "OnClick %s[vnum %d ServerUniqueID %d, pid %d] by %s", GetName(), GetRaceNum(), vid, GetPlayerID(), pkChrCauser->GetName());
+
+#if defined(__GUILD_DRAGONLAIR__)
+	if ((IsNPC()) && (GetRaceNum() == (WORD)(MeleyLair::GATE_VNUM)) && (MeleyLair::CMgr::instance().IsMeleyMap(pkChrCauser->GetMapIndex())))
+	{
+		MeleyLair::CMgr::instance().Start(pkChrCauser, pkChrCauser->GetGuild());
+		return;
+	}
 #endif
-#if defined(__ACCE_COSTUME_SYSTEM__)
-		case COSTUME_AURA:
+
+	// ȯ϶ Ʈ   .
+	{
+		if (pkChrCauser->GetExchange())
+		{
+			if (test_server)
+				sys_err("OnClick Fail (%s->%s) - pc is exchanging", pkChrCauser->GetName(), GetName());
+			return;
+		}
+	}
+
+	//  · Ʈ   .
+	{
+		// , ڽ ڽ  Ŭ  ִ.
+		if (pkChrCauser->GetMyShop() && pkChrCauser != this)
+		{
+			if (test_server)
+				sys_err("OnClick Fail (%s->%s) - pc has shop", pkChrCauser->GetName(), GetName());
+			return;
+		}
+	}
+
+	if (IsPC())
+	{
+		// Ÿ   PC  Ŭ Ʈ óϵ մϴ.
+		if (!CTargetManager::instance().GetTargetInfo(pkChrCauser->GetPlayerID(), TARGET_TYPE_VID, GetVID()))
+		{
+			// 2005.03.17.myevan.Ÿ ƴ    ó  ۵Ų.
+			if (GetMyShop())
+			{
+				if (pkChrCauser->IsDead() == true) return;
+				
+#ifdef __GROWTH_PET_SYSTEM__
+				if (pkChrCauser->GetPetWindowType() == PET_WINDOW_ATTR_CHANGE || GetPetWindowType() == PET_WINDOW_PRIMIUM_FEEDSTUFF)
+				{
+					pkChrCauser->ChatPacket(CHAT_TYPE_INFO, "While modifying your pet's stats, you cannot trade, sell items, use the storeroom etc.");
+					return;
+				}
 #endif
-			break;
 
-		default:
+				// PREVENT_TRADE_WINDOW
+				if (pkChrCauser == this) // ڱ 
+				{
+					if (PreventTradeWindow(WND_MYSHOP, true/*except*/))
+					{
+						pkChrCauser->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ٸ ŷ(â,ȯ,) λ   ϴ."));
+						return;
+					}
+				}
+				else // ٸ  Ŭ
+				{
+					// Ŭ  ȯ/â/λ/̶̿ Ұ
+					if (pkChrCauser->PreventTradeWindow(WND_ALL))
+					{
+						pkChrCauser->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ٸ ŷ(â,ȯ,) λ   ϴ."));
+						return;
+					}
+
+					// Ŭ  ȯ/â/̶̿ Ұ
+					//if ((GetExchange() || IsOpenSafebox() || GetShopOwner()))
+					if (PreventTradeWindow(WND_MYSHOP | WND_SHOPOWNER, true/*except*/))
+					{
+						pkChrCauser->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ٸ ŷ ϰ ִ Դϴ."));
+						return;
+					}
+				}
+				// END_PREVENT_TRADE_WINDOW
+
+				if (pkChrCauser->GetShop())
+				{
+					pkChrCauser->GetShop()->RemoveGuest(pkChrCauser);
+					pkChrCauser->SetShop(NULL);
+				}
+
+				GetMyShop()->AddGuest(pkChrCauser, GetVID(), false);
+				pkChrCauser->SetShopOwner(this);
+#if defined(__PRIVATESHOP_SEARCH_SYSTEM__)
+				if (CTargetManager::instance().GetTargetInfo(pkChrCauser->GetPlayerID(), TARGET_TYPE_VID_SHOP_SEARCH, static_cast<DWORD>(GetVID())))
+					CTargetManager::instance().DeleteTarget(pkChrCauser->GetPlayerID(), SHOP_SEARCH_INDEX, "__SHOPSEARCH_TARGET__");
+#endif
+				return;
+			}
+
+			if (test_server)
+				sys_err("%s.OnClickFailure(%s) - target is PC", pkChrCauser->GetName(), GetName());
+
+			return;
+		}
+	}
+	
+#ifdef __GROWTH_PET_SYSTEM__
+	if (pkChrCauser->GetPetWindowType() == PET_WINDOW_ATTR_CHANGE || GetPetWindowType() == PET_WINDOW_PRIMIUM_FEEDSTUFF)
+	{
+		pkChrCauser->ChatPacket(CHAT_TYPE_INFO, "You cannot speak with an NPC while modifying your pet's stats.");
+		return;
+	}
+#endif
+
+	pkChrCauser->SetQuestNPCID(GetVID());
+
+	if (quest::CQuestManager::instance().Click(pkChrCauser->GetPlayerID(), this))
+	{
+		return;
+	}
+
+	// NPC    :   
+	if (!IsPC())
+	{
+		if (!m_triggerOnClick.pFunc)
 		{
-			sys_err("CHARACTER::SetHiddenCostumePart: %s cannot hide unknown costume sub type %u",
-				GetName(), bCostumeSubType);
+			// NPC Ʈ ý α 
+			/*
+			sys_err("%s.OnClickFailure(%s) : triggerOnClick.pFunc is EMPTY(pid=%d)",
+				pkChrCauser->GetName(),
+				GetName(),
+				pkChrCauser->GetPlayerID());
+			*/
 			return;
 		}
-	}
 
-	if (IsDead() || IsWarping())
+		m_triggerOnClick.pFunc(this, pkChrCauser);
+	}
+}
+
+BYTE CHARACTER::GetGMLevel() const
+{
+	if (test_server)
+		return GM_IMPLEMENTOR;
+	return m_pointsInstant.gm_level;
+}
+
+void CHARACTER::SetGMLevel()
+{
+	if (GetDesc())
+	{
+		BYTE myLevel = gm_get_level(GetName(), GetDesc()->GetHostName(), GetDesc()->GetAccountTable().login);
+		m_pointsInstant.gm_level = myLevel;
+	}
+	else
+	{
+		m_pointsInstant.gm_level = GM_PLAYER;
+	}
+}
+
+BOOL CHARACTER::IsGM() const
+{
+	if (test_server)
+		return true;
+
+	if (GetGMLevel() != GM_PLAYER)
+		return true;
+
+	return false;
+}
+
+void CHARACTER::SetStone(LPCHARACTER pkChrStone)
+{
+	m_pkChrStone = pkChrStone;
+
+	if (m_pkChrStone)
+	{
+		if (pkChrStone->m_set_pkChrSpawnedBy.find(this) == pkChrStone->m_set_pkChrSpawnedBy.end())
+			pkChrStone->m_set_pkChrSpawnedBy.insert(this);
+	}
+}
+
+struct FuncDeadSpawnedByStone
+{
+	void operator () (LPCHARACTER ch)
+	{
+		ch->Dead(NULL);
+		ch->SetStone(NULL);
+	}
+};
+
+void CHARACTER::ClearStone()
+{
+	if (!m_set_pkChrSpawnedBy.empty())
+	{
+		//  Ų ͵  δ.
+		FuncDeadSpawnedByStone f;
+		std::for_each(m_set_pkChrSpawnedBy.begin(), m_set_pkChrSpawnedBy.end(), f);
+		m_set_pkChrSpawnedBy.clear();
+	}
+
+	if (!m_pkChrStone)
 		return;
 
-	bool bAttacking = (get_dword_time() - GetLastAttackTime()) < 1500;
-	bool bMoving = (get_dword_time() - GetLastMoveTime()) < 1500;
-	bool bDelayedCMD = false;
-
-	if (IsStateMove() || bAttacking || bMoving)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("You have to stand still to hide your costume."));
-		return;
-	}
-
-	int iPulse = thecore_pulse();
-	if (iPulse - m_dwHideCostumePulse < passes_per_sec * 3)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("You have to wait 3 seconds before you can hide your costume again."));
-		return;
-	}
-
-	m_dwHideCostumePulse = thecore_pulse();
-	m_bHiddenCostumePart[bCostumeSubType] = bHidden;
-
-	if (bSave)
-		SetQuestFlag(HiddenCostumePartMap[bCostumeSubType], bHidden ? 1 : 0);
-
-	UpdatePacket();
+	m_pkChrStone->m_set_pkChrSpawnedBy.erase(this);
+	m_pkChrStone = NULL;
+}
+
+void CHARACTER::ClearTarget()
+{
+	if (m_pkChrTarget)
+	{
+		m_pkChrTarget->m_set_pkChrTargetedBy.erase(this);
+		m_pkChrTarget = NULL;
+	}
+
+	TPacketGCTarget p;
 
-	ChatPacket(CHAT_TYPE_COMMAND, "SetHiddenCostumePart %d %d", bCostumeSubType, bHidden ? 1 : 0);
+	p.header = HEADER_GC_TARGET;
+	p.dwVID = 0;
+	p.bHPPercent = 0;
+#if defined(__VIEW_TARGET_DECIMAL_HP__)
+	p.iMinHP = 0;
+	p.iMaxHP = 0;
+#endif
+#if defined(__ELEMENT_SYSTEM__)
+	memset(&p.bElement, 0, sizeof(p.bElement));
+#endif
+
+	CHARACTER_SET::iterator it = m_set_pkChrTargetedBy.begin();
+
+	while (it != m_set_pkChrTargetedBy.end())
+	{
+		LPCHARACTER pkChr = *(it++);
+		pkChr->m_pkChrTarget = NULL;
+
+		if (!pkChr->GetDesc())
+		{
+			sys_err("%s %p does not have desc", pkChr->GetName(), get_pointer(pkChr));
+			abort();
+		}
+
+		pkChr->GetDesc()->Packet(&p, sizeof(TPacketGCTarget));
+	}
+
+	m_set_pkChrTargetedBy.clear();
 }
-
-bool CHARACTER::CheckComboFlood(DWORD dwTime)
-{
-	// Window is 1 second buckets; allow small burst but block sustained floods.
-	const DWORD dwWindow = dwTime / 1000;
-
-	if (m_dwComboFloodWindow != dwWindow)
-	{
-		m_dwComboFloodWindow = dwWindow;
-		m_bComboFloodCount = 0;
-	}
-
-	++m_bComboFloodCount;
-
-	// Allow up to 2 combo packets / second. Above that: ignore.
-	if (m_bComboFloodCount > 2)
-	{
-		// Hard cap: if someone is clearly flooding, drop them.
-		if (m_bComboFloodCount > 10 && GetDesc())
-			GetDesc()->DelayedDisconnect(3);
-		return true;
-	}
-
-	return false;
-}
 
-bool CHARACTER::GetHiddenCostumeByPart(BYTE bPartPos) const
+void CHARACTER::SetTarget(LPCHARACTER pkChrTarget)
 {
-	switch (bPartPos)
+	if (m_pkChrTarget == pkChrTarget)
+		return;
+
+	// CASTLE
+	if (IS_CASTLE_MAP(GetMapIndex()) && !IsGM())
+		return;
+	// CASTLE
+
+	if (m_pkChrTarget)
+		m_pkChrTarget->m_set_pkChrTargetedBy.erase(this);
+
+	m_pkChrTarget = pkChrTarget;
+
+	TPacketGCTarget p;
+
+	p.header = HEADER_GC_TARGET;
+
+	if (m_pkChrTarget)
 	{
-		case PART_MAIN:
-			if (m_bHiddenCostumePart[COSTUME_BODY] && GetWear(WEAR_COSTUME_BODY))
-				return true;
-			break;
+		m_pkChrTarget->m_set_pkChrTargetedBy.insert(this);
 
-		case PART_HAIR:
-			if (m_bHiddenCostumePart[COSTUME_HAIR] && GetWear(WEAR_COSTUME_HAIR))
-				return true;
-			break;
+		p.dwVID = m_pkChrTarget->GetVID();
 
-#if defined(__ACCE_COSTUME_SYSTEM__)
-		case PART_ACCE:
-			if (m_bHiddenCostumePart[COSTUME_ACCE] && GetWear(WEAR_COSTUME_ACCE))
-				return true;
-			break;
+#if defined(__VIEW_TARGET_PLAYER_HP__)
+		if ((m_pkChrTarget->GetMaxHP() <= 0))
+		{
+			p.bHPPercent = 0;
+#if defined(__VIEW_TARGET_DECIMAL_HP__)
+			p.iMinHP = 0;
+			p.iMaxHP = 0;
+#endif
+		}
+		else if (m_pkChrTarget->IsPC() && !m_pkChrTarget->IsPolymorphed())
+		{
+			p.bHPPercent = MINMAX(0, (m_pkChrTarget->GetHP() * 100) / m_pkChrTarget->GetMaxHP(), 100);
+#if defined(__VIEW_TARGET_DECIMAL_HP__)
+			p.iMinHP = m_pkChrTarget->GetHP();
+			p.iMaxHP = m_pkChrTarget->GetMaxHP();
+#endif
+		}
+#else
+		if ((m_pkChrTarget->IsPC() && !m_pkChrTarget->IsPolymorphed()) || (m_pkChrTarget->GetMaxHP() <= 0))
+		{
+			p.bHPPercent = 0;
+#if defined(__VIEW_TARGET_DECIMAL_HP__)
+			p.iMinHP = 0;
+			p.iMaxHP = 0;
 #endif
+		}
+#endif
+		else
+		{
+			if (m_pkChrTarget->GetRaceNum() == 20101 ||
+				m_pkChrTarget->GetRaceNum() == 20102 ||
+				m_pkChrTarget->GetRaceNum() == 20103 ||
+				m_pkChrTarget->GetRaceNum() == 20104 ||
+				m_pkChrTarget->GetRaceNum() == 20105 ||
+				m_pkChrTarget->GetRaceNum() == 20106 ||
+				m_pkChrTarget->GetRaceNum() == 20107 ||
+				m_pkChrTarget->GetRaceNum() == 20108 ||
+				m_pkChrTarget->GetRaceNum() == 20109)
+			{
+				LPCHARACTER owner = m_pkChrTarget->GetVictim();
 
-#if defined(__WEAPON_COSTUME_SYSTEM__)
-		case PART_WEAPON:
-			if (m_bHiddenCostumePart[COSTUME_WEAPON] && GetWear(WEAR_COSTUME_WEAPON))
-				return true;
-			break;
+				if (owner)
+				{
+					int iHorseHealth = owner->GetHorseHealth();
+					int iHorseMaxHealth = owner->GetHorseMaxHealth();
+
+					if (iHorseMaxHealth)
+					{
+						p.bHPPercent = MINMAX(0, iHorseHealth * 100 / iHorseMaxHealth, 100);
+#if defined(__VIEW_TARGET_DECIMAL_HP__)
+						p.iMinHP = 100;
+						p.iMaxHP = 100;
+#endif
+					}
+					else
+					{
+						p.bHPPercent = 100;
+#if defined(__VIEW_TARGET_DECIMAL_HP__)
+						p.iMinHP = 100;
+						p.iMaxHP = 100;
+#endif
+					}
+				}
+				else
+				{
+					p.bHPPercent = 100;
+#if defined(__VIEW_TARGET_DECIMAL_HP__)
+					p.iMinHP = 100;
+					p.iMaxHP = 100;
 #endif
+				}
+			}
+			else
+			{
+				if (m_pkChrTarget->GetMaxHP() <= 0)
+				{
+					p.bHPPercent = 0;
+#if defined(__VIEW_TARGET_DECIMAL_HP__)
+					p.iMinHP = 0;
+					p.iMaxHP = 0;
+#endif
+				}
+				else
+				{
+					p.bHPPercent = MINMAX(0, (m_pkChrTarget->GetHP() * 100) / m_pkChrTarget->GetMaxHP(), 100);
+#if defined(__VIEW_TARGET_DECIMAL_HP__)
+					p.iMinHP = m_pkChrTarget->GetHP();
+					p.iMaxHP = m_pkChrTarget->GetMaxHP();
+#endif
+				}
+			}
+		}
+	}
+	else
+	{
+		p.dwVID = 0;
+		p.bHPPercent = 0;
+#if defined(__VIEW_TARGET_DECIMAL_HP__)
+		p.iMinHP = 0;
+		p.iMaxHP = 0;
+#endif
+	}
 
-#if defined(__AURA_COSTUME_SYSTEM__)
-		case PART_AURA:
-			if (m_bHiddenCostumePart[COSTUME_AURA] && GetWear(WEAR_COSTUME_AURA))
-				return true;
-			break;
+#if defined(__ELEMENT_SYSTEM__)
+	memset(&p.bElement, 0, sizeof(p.bElement));
+	if (m_pkChrTarget)
+	{
+		if (m_pkChrTarget->IsPC())
+		{
+			p.bElement[MOB_ELEMENT_ELECT] = m_pkChrTarget->GetPoint(POINT_ENCHANT_ELECT);
+			p.bElement[MOB_ELEMENT_FIRE] = m_pkChrTarget->GetPoint(POINT_ENCHANT_FIRE);
+			p.bElement[MOB_ELEMENT_ICE] = m_pkChrTarget->GetPoint(POINT_ENCHANT_ICE);
+			p.bElement[MOB_ELEMENT_WIND] = m_pkChrTarget->GetPoint(POINT_ENCHANT_WIND);
+			p.bElement[MOB_ELEMENT_EARTH] = m_pkChrTarget->GetPoint(POINT_ENCHANT_EARTH);
+			p.bElement[MOB_ELEMENT_DARK] = m_pkChrTarget->GetPoint(POINT_ENCHANT_DARK);
+		}
+		else
+		{
+			p.bElement[MOB_ELEMENT_ELECT] = m_pkChrTarget->GetMobElement(MOB_ELEMENT_ELECT);
+			p.bElement[MOB_ELEMENT_FIRE] = m_pkChrTarget->GetMobElement(MOB_ELEMENT_FIRE);
+			p.bElement[MOB_ELEMENT_ICE] = m_pkChrTarget->GetMobElement(MOB_ELEMENT_ICE);
+			p.bElement[MOB_ELEMENT_WIND] = m_pkChrTarget->GetMobElement(MOB_ELEMENT_WIND);
+			p.bElement[MOB_ELEMENT_EARTH] = m_pkChrTarget->GetMobElement(MOB_ELEMENT_EARTH);
+			p.bElement[MOB_ELEMENT_DARK] = m_pkChrTarget->GetMobElement(MOB_ELEMENT_DARK);
+		}
+	}
 #endif
 
-		default:
+	GetDesc()->Packet(&p, sizeof(TPacketGCTarget));
+}
+
+void CHARACTER::BroadcastTargetPacket()
+{
+	if (m_set_pkChrTargetedBy.empty())
+		return;
+
+	TPacketGCTarget p;
+
+	p.header = HEADER_GC_TARGET;
+	p.dwVID = GetVID();
+
+	if (GetMaxHP() <= 0)
+	{
+		p.bHPPercent = 0;
+#if defined(__VIEW_TARGET_DECIMAL_HP__)
+		p.iMinHP = 0;
+		p.iMaxHP = 0;
+#endif
+	}
+	else
+	{
+#if defined(__VIEW_TARGET_PLAYER_HP__)
+		p.bHPPercent = MINMAX(0, (GetHP() * 100) / GetMaxHP(), 100);
+#if defined(__VIEW_TARGET_DECIMAL_HP__)
+		p.iMinHP = GetHP();
+		p.iMaxHP = GetMaxHP();
+#endif
+#else
+		if (IsPC())
+		{
+			p.bHPPercent = 0;
+#if defined(__VIEW_TARGET_DECIMAL_HP__)
+			p.iMinHP = 0;
+			p.iMaxHP = 0;
+#endif
+		}
+		else
+		{
+			p.bHPPercent = MINMAX(0, (GetHP() * 100) / GetMaxHP(), 100);
+#if defined(__VIEW_TARGET_DECIMAL_HP__)
+			p.iMinHP = GetHP();
+			p.iMaxHP = GetMaxHP();
+#endif
+		}
+#endif
+	}
+
+#if defined(__ELEMENT_SYSTEM__)
+	memset(&p.bElement, 0, sizeof(p.bElement));
+
+	if (IsPC())
+	{
+		p.bElement[MOB_ELEMENT_ELECT] = GetPoint(POINT_ENCHANT_ELECT);
+		p.bElement[MOB_ELEMENT_FIRE] = GetPoint(POINT_ENCHANT_FIRE);
+		p.bElement[MOB_ELEMENT_ICE] = GetPoint(POINT_ENCHANT_ICE);
+		p.bElement[MOB_ELEMENT_WIND] = GetPoint(POINT_ENCHANT_WIND);
+		p.bElement[MOB_ELEMENT_EARTH] = GetPoint(POINT_ENCHANT_EARTH);
+		p.bElement[MOB_ELEMENT_DARK] = GetPoint(POINT_ENCHANT_DARK);
+	}
+	else
+	{
+		p.bElement[MOB_ELEMENT_ELECT] = GetMobElement(MOB_ELEMENT_ELECT);
+		p.bElement[MOB_ELEMENT_FIRE] = GetMobElement(MOB_ELEMENT_FIRE);
+		p.bElement[MOB_ELEMENT_ICE] = GetMobElement(MOB_ELEMENT_ICE);
+		p.bElement[MOB_ELEMENT_WIND] = GetMobElement(MOB_ELEMENT_WIND);
+		p.bElement[MOB_ELEMENT_EARTH] = GetMobElement(MOB_ELEMENT_EARTH);
+		p.bElement[MOB_ELEMENT_DARK] = GetMobElement(MOB_ELEMENT_DARK);
+	}
+#endif
+
+	CHARACTER_SET::iterator it = m_set_pkChrTargetedBy.begin();
+
+	while (it != m_set_pkChrTargetedBy.end())
+	{
+		LPCHARACTER pkChr = *it++;
+
+		if (!pkChr->GetDesc())
+		{
+			sys_err("%s %p does not have desc", pkChr->GetName(), get_pointer(pkChr));
+			abort();
+		}
+
+		pkChr->GetDesc()->Packet(&p, sizeof(TPacketGCTarget));
+	}
+}
+
+void CHARACTER::CheckTarget()
+{
+	if (!m_pkChrTarget)
+		return;
+
+	if (DISTANCE_APPROX(GetX() - m_pkChrTarget->GetX(), GetY() - m_pkChrTarget->GetY()) >= 4800)
+		SetTarget(NULL);
+}
+
+void CHARACTER::SetWarpLocation(long lMapIndex, long x, long y)
+{
+	m_posWarp.x = x * 100;
+	m_posWarp.y = y * 100;
+	m_lWarpMapIndex = lMapIndex;
+}
+
+void CHARACTER::SaveExitLocation()
+{
+	m_posExit = GetXYZ();
+	m_lExitMapIndex = GetMapIndex();
+}
+
+void CHARACTER::ExitToSavedLocation()
+{
+	sys_log(0, "ExitToSavedLocation");
+	WarpSet(m_posWarp.x, m_posWarp.y, m_lWarpMapIndex);
+
+	m_posExit.x = m_posExit.y = m_posExit.z = 0;
+	m_lExitMapIndex = 0;
+}
+
+// fixme
+// ݱ privateMapIndex    ε  üũ ϴ  ܺο ϰ,
+// ٸ warpset ҷµ
+// ̸ warpset  .
+bool CHARACTER::WarpSet(long x, long y, long lPrivateMapIndex)
+{
+	if (!IsPC())
+		return false;
+
+	long lAddr;
+	long lMapIndex;
+	WORD wPort;
+
+	if (!CMapLocation::instance().Get(x, y, lMapIndex, lAddr, wPort))
+	{
+		sys_err("cannot find map location index %d x %d y %d name %s", lMapIndex, x, y, GetName());
+		return false;
+	}
+
+	// Send Supplementary Data Block if new map requires security packages in loading this map
+	{
+		long lCurAddr;
+		long lCurMapIndex = 0;
+		WORD wCurPort;
+
+		CMapLocation::instance().Get(GetX(), GetY(), lCurMapIndex, lCurAddr, wCurPort);
+
+		// Do not send SDB files if char is in the same map
+		if (lCurMapIndex != lMapIndex)
+		{
+			const TMapRegion* rMapRgn = SECTREE_MANAGER::instance().GetMapRegion(lMapIndex);
+			{
+				DESC_MANAGER::instance().SendClientPackageSDBToLoadMap(GetDesc(), rMapRgn->strMapName.c_str());
+			}
+		}
+	}
+
+	if (lPrivateMapIndex >= 10000)
+	{
+		if (lPrivateMapIndex / 10000 != lMapIndex)
+		{
+			sys_err("Invalid map index %d, must be child of %d", lPrivateMapIndex, lMapIndex);
 			return false;
+		}
+
+		lMapIndex = lPrivateMapIndex;
 	}
 
-	return false;
+#if defined(__SORT_INVENTORY_ITEMS__)
+	if (GetSortInventoryPulse() > get_global_time())
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot warp after sorting your inventory."));
+		return false;;
+	}
+
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	if (GetSortSpecialInventoryPulse() > get_global_time())
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot warp after sorting your inventory."));
+		return false;;
+	}
+#endif
+#endif
+
+	Stop();
+	Save();
+
+	if (GetSectree())
+	{
+		GetSectree()->RemoveEntity(this);
+		ViewCleanup();
+
+		EncodeRemovePacket(this);
+	}
+
+	m_lWarpMapIndex = lMapIndex;
+	m_posWarp.x = x;
+	m_posWarp.y = y;
+
+	sys_log(0, "WarpSet %s %d %d current map %d target map %d", GetName(), x, y, GetMapIndex(), lMapIndex);
+
+	TPacketGCWarp p;
+
+	p.bHeader = HEADER_GC_WARP;
+	p.lX = x;
+	p.lY = y;
+	p.lAddr = lAddr;
+	p.wPort = wPort;
+
+	GetDesc()->Packet(&p, sizeof(TPacketGCWarp));
+
+	char buf[256];
+	snprintf(buf, sizeof(buf), "%s MapIdx %ld DestMapIdx%ld DestX%ld DestY%ld Empire%d", GetName(), GetMapIndex(), lPrivateMapIndex, x, y, GetEmpire());
+	LogManager::instance().CharLog(this, 0, "WARP", buf);
+
+	return true;
+}
+
+void CHARACTER::WarpEnd()
+{
+	if (test_server)
+		sys_log(0, "WarpEnd %s", GetName());
+
+	if (m_posWarp.x == 0 && m_posWarp.y == 0)
+		return;
+
+	int index = m_lWarpMapIndex;
+
+	if (index > 10000)
+		index /= 10000;
+
+	if (!map_allow_find(index))
+	{
+		//     Ƿ ϱ  ǥ ǵ.
+		sys_err("location %d %d not allowed to login this server", m_posWarp.x, m_posWarp.y);
+		if (g_bIgnoreDisallowedMap) //< 2020.08.07.Owsap - Go home if map index isn't allowed.
+			GoHome();
+		else
+			GetDesc()->SetPhase(PHASE_CLOSE);
+
+		return;
+	}
+
+	sys_log(0, "WarpEnd %s %d %u %u", GetName(), m_lWarpMapIndex, m_posWarp.x, m_posWarp.y);
+
+	Show(m_lWarpMapIndex, m_posWarp.x, m_posWarp.y, 0);
+	Stop();
+
+	m_lWarpMapIndex = 0;
+	m_posWarp.x = m_posWarp.y = m_posWarp.z = 0;
+
+	{
+		// P2P Login
+		TPacketGGLogin p;
+
+		p.bHeader = HEADER_GG_LOGIN;
+		strlcpy(p.szName, GetName(), sizeof(p.szName));
+		p.dwPID = GetPlayerID();
+		p.bEmpire = GetEmpire();
+		p.lMapIndex = SECTREE_MANAGER::instance().GetMapIndex(GetX(), GetY());
+		p.bChannel = g_bChannel;
+		p.bLanguage = GetLanguage();
+
+		P2P_MANAGER::instance().Send(&p, sizeof(TPacketGGLogin));
+	}
+}
+
+bool CHARACTER::Return()
+{
+	if (!IsNPC())
+		return false;
+
+	int x, y;
+	/*
+	float fDist = DISTANCE_SQRT(m_pkMobData->m_posLastAttacked.x - GetX(), m_pkMobData->m_posLastAttacked.y - GetY());
+	float fx, fy;
+	GetDeltaByDegree(GetRotation(), fDist, &fx, &fy);
+	x = GetX() + (int)fx;
+	y = GetY() + (int)fy;
+	*/
+	SetVictim(NULL);
+
+	x = m_pkMobInst->m_posLastAttacked.x;
+	y = m_pkMobInst->m_posLastAttacked.y;
+
+	SetRotationToXY(x, y);
+
+	if (!Goto(x, y))
+		return false;
+
+	SendMovePacket(FUNC_WAIT, 0, 0, 0, 0);
+
+	if (test_server)
+		sys_log(0, "%s %p ϰ ư! %d %d", GetName(), this, x, y);
+
+	if (GetParty())
+		GetParty()->SendMessage(this, PM_RETURN, x, y);
+
+	return true;
+}
+
+bool CHARACTER::Follow(LPCHARACTER pkChr, float fMinDistance)
+{
+	if (IsPC())
+	{
+		sys_err("CHARACTER::Follow : PC cannot use this method", GetName());
+		return false;
+	}
+
+	// TRENT_MONSTER
+	if (IS_SET(m_pointsInstant.dwAIFlag, AIFLAG_NOMOVE))
+	{
+		if (pkChr->IsPC()) // Ѿư 밡 PC 
+		{
+			// If i'm in a party. I must obey party leader's AI.
+			if (!GetParty() || !GetParty()->GetLeader() || GetParty()->GetLeader() == this)
+			{
+				if (get_dword_time() - m_pkMobInst->m_dwLastAttackedTime >= 15000) //  ݹ 15ʰ 
+				{
+					//     50 ̻ ̳ ϰ ư.
+					if (m_pkMobData->m_table.wAttackRange < DISTANCE_APPROX(pkChr->GetX() - GetX(), pkChr->GetY() - GetY()))
+						if (Return())
+							return true;
+				}
+			}
+		}
+		return false;
+	}
+	// END_OF_TRENT_MONSTER
+
+	long x = pkChr->GetX();
+	long y = pkChr->GetY();
+
+	if (pkChr->IsPC()) // Ѿư 밡 PC 
+	{
+		// If i'm in a party. I must obey party leader's AI.
+		if (!GetParty() || !GetParty()->GetLeader() || GetParty()->GetLeader() == this)
+		{
+			if (get_dword_time() - m_pkMobInst->m_dwLastAttackedTime >= 15000) //  ݹ 15ʰ 
+			{
+				//     50 ̻ ̳ ϰ ư.
+				if (5000 < DISTANCE_APPROX(m_pkMobInst->m_posLastAttacked.x - GetX(), m_pkMobInst->m_posLastAttacked.y - GetY()))
+					if (Return())
+						return true;
+			}
+		}
+	}
+
+	if (IsGuardNPC())
+	{
+		if (5000 < DISTANCE_APPROX(m_pkMobInst->m_posLastAttacked.x - GetX(), m_pkMobInst->m_posLastAttacked.y - GetY()))
+			if (Return())
+				return true;
+	}
+
+	if (pkChr->IsState(pkChr->m_stateMove) &&
+		GetMobBattleType() != BATTLE_TYPE_RANGE &&
+		GetMobBattleType() != BATTLE_TYPE_MAGIC &&
+		false == IsPet() &&
+		false == IsGrowthPet())
+	{
+		//  ̵̸  ̵ Ѵ
+		//   ӵ Ÿκ  ð  
+		//   ð  ̵Ѵٰ Ͽ ű ̵Ѵ.
+		float rot = pkChr->GetRotation();
+		float rot_delta = GetDegreeDelta(rot, GetDegreeFromPositionXY(GetX(), GetY(), pkChr->GetX(), pkChr->GetY()));
+
+		float yourSpeed = pkChr->GetMoveSpeed();
+		float mySpeed = GetMoveSpeed();
+
+		float fDist = DISTANCE_SQRT(x - GetX(), y - GetY());
+		float fFollowSpeed = mySpeed - yourSpeed * cos(rot_delta * M_PI / 180);
+
+		if (fFollowSpeed >= 0.1f)
+		{
+			float fMeetTime = fDist / fFollowSpeed;
+			float fYourMoveEstimateX, fYourMoveEstimateY;
+
+			if (fMeetTime * yourSpeed <= 100000.0f)
+			{
+				GetDeltaByDegree(pkChr->GetRotation(), fMeetTime * yourSpeed, &fYourMoveEstimateX, &fYourMoveEstimateY);
+
+				x += (long)fYourMoveEstimateX;
+				y += (long)fYourMoveEstimateY;
+
+				float fDistNew = sqrt(((double)x - GetX()) * (x - GetX()) + ((double)y - GetY()) * (y - GetY()));
+				if (fDist < fDistNew)
+				{
+					x = (long)(GetX() + (x - GetX()) * fDist / fDistNew);
+					y = (long)(GetY() + (y - GetY()) * fDist / fDistNew);
+				}
+			}
+		}
+	}
+
+	//  ġ ٶ Ѵ.
+	SetRotationToXY(x, y);
+
+	float fDist = DISTANCE_SQRT(x - GetX(), y - GetY());
+
+	if (fDist <= fMinDistance)
+		return false;
+
+	float fx, fy;
+
+	if (IsChangeAttackPosition(pkChr) && GetMobRank() < MOB_RANK_BOSS)
+	{
+		//  ֺ   ̵
+		SetChangeAttackPositionTime();
+
+		int retry = 16;
+		int dx, dy;
+		int rot = (int)GetDegreeFromPositionXY(x, y, GetX(), GetY());
+
+		while (--retry)
+		{
+			if (fDist < 500.0f)
+				GetDeltaByDegree((rot + number(-90, 90) + number(-90, 90)) % 360, fMinDistance, &fx, &fy);
+			else
+				GetDeltaByDegree(number(0, 359), fMinDistance, &fx, &fy);
+
+			dx = x + (int)fx;
+			dy = y + (int)fy;
+
+			LPSECTREE tree = SECTREE_MANAGER::instance().Get(GetMapIndex(), dx, dy);
+
+			if (NULL == tree)
+				break;
+
+			if (0 == (tree->GetAttribute(dx, dy) & (ATTR_BLOCK | ATTR_OBJECT)))
+				break;
+		}
+
+		//sys_log(0, "ó 򰡷 ̵ %s retry %d", GetName(), retry);
+		if (!Goto(dx, dy))
+			return false;
+	}
+	else
+	{
+		//  󰡱
+		float fDistToGo = fDist - fMinDistance;
+		GetDeltaByDegree(GetRotation(), fDistToGo, &fx, &fy);
+
+		//sys_log(0, " ̵ %s", GetName());
+		if (!Goto(GetX() + (int)fx, GetY() + (int)fy))
+			return false;
+	}
+
+	SendMovePacket(FUNC_WAIT, 0, 0, 0, 0);
+	//MonsterLog("Ѿư; %s", pkChr->GetName());
+	return true;
 }
 
-void CHARACTER::SetHiddenCostumeParts()
+float CHARACTER::GetDistanceFromSafeboxOpen() const
 {
-	bool bHidden = false;
-	for (const THiddenCostumePartMap::value_type& it : HiddenCostumePartMap)
+	return DISTANCE_APPROX(GetX() - m_posSafeboxOpen.x, GetY() - m_posSafeboxOpen.y);
+}
+
+void CHARACTER::SetSafeboxOpenPosition()
+{
+	m_posSafeboxOpen = GetXYZ();
+}
+
+CSafebox* CHARACTER::GetSafebox() const
+{
+	return m_pkSafebox;
+}
+
+void CHARACTER::ReqSafeboxLoad(const char* pszPassword)
+{
+#ifdef __GROWTH_PET_SYSTEM__
+	if (GetPetWindowType() == PET_WINDOW_ATTR_CHANGE || GetPetWindowType() == PET_WINDOW_PRIMIUM_FEEDSTUFF)
 	{
-		bHidden = (GetQuestFlag(it.second) != 0 ? 1 : 0);
-		m_bHiddenCostumePart[it.first] = bHidden;
+		ChatPacket(CHAT_TYPE_INFO, "While modifying your pet's stats, you cannot trade, sell items, use the storeroom etc.");
+		return;
+	}
+#endif
 
-		ChatPacket(CHAT_TYPE_COMMAND, "SetHiddenCostumePart %d %d", it.first, static_cast<BYTE>(bHidden));
+	if (!*pszPassword || strlen(pszPassword) > SAFEBOX_PASSWORD_MAX_LEN)
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<â> ߸ ȣ Էϼ̽ϴ."));
+		return;
 	}
+	else if (m_pkSafebox)
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<â> â ̹ ֽϴ."));
+		return;
+	}
+
+	int iPulse = thecore_pulse();
+
+	if (iPulse - GetSafeboxLoadTime() < PASSES_PER_SEC(10))
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<â> â  10 ȿ   ϴ."));
+		return;
+	}
+	else if (GetDistanceFromSafeboxOpen() > 1000)
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<â> Ÿ ־ â   ϴ."));
+		return;
+	}
+	else if (m_bOpeningSafebox)
+	{
+		sys_log(0, "Overlapped safebox load request from %s", GetName());
+		return;
+	}
+
+	SetSafeboxLoadTime();
+	m_bOpeningSafebox = true;
+
+	TSafeboxLoadPacket p;
+	p.dwID = GetDesc()->GetAccountTable().id;
+	strlcpy(p.szLogin, GetDesc()->GetAccountTable().login, sizeof(p.szLogin));
+	strlcpy(p.szPassword, pszPassword, sizeof(p.szPassword));
+
+	db_clientdesc->DBPacket(HEADER_GD_SAFEBOX_LOAD, GetDesc()->GetHandle(), &p, sizeof(p));
 }
+
+void CHARACTER::LoadSafebox(int iSize, DWORD dwGold, int iItemCount, TPlayerItem* pItems)
+{
+	bool bLoaded = false;
+
+	// PREVENT_TRADE_WINDOW
+	SetOpenSafebox(true);
+	// END_PREVENT_TRADE_WINDOW
+
+	if (m_pkSafebox)
+		bLoaded = true;
+
+	if (!m_pkSafebox)
+		m_pkSafebox = M2_NEW CSafebox(this, iSize, dwGold);
+	else
+		m_pkSafebox->ChangeSize(iSize);
+
+	m_iSafeboxSize = iSize;
+
+	TPacketCGSafeboxSize p;
+
+	p.bHeader = HEADER_GC_SAFEBOX_SIZE;
+	p.bSize = iSize;
+
+	GetDesc()->Packet(&p, sizeof(TPacketCGSafeboxSize));
+
+	if (!bLoaded)
+	{
+		for (int i = 0; i < iItemCount; ++i, ++pItems)
+		{
+			if (!m_pkSafebox->IsValidPosition(pItems->pos))
+				continue;
+
+			LPITEM item = ITEM_MANAGER::instance().CreateItem(pItems->vnum, pItems->count, pItems->id);
+
+			if (!item)
+			{
+				sys_err("cannot create item vnum %d id %u (name: %s)", pItems->vnum, pItems->id, GetName());
+				continue;
+			}
+
+			item->SetSkipSave(true);
+			item->SetSockets(pItems->alSockets);
+#if defined(__ITEM_APPLY_RANDOM__)
+			item->SetRandomApplies(pItems->aApplyRandom);
+#endif
+			item->SetAttributes(pItems->aAttr);
+#if defined(__SOUL_BIND_SYSTEM__)
+			item->SetSoulBind(pItems->soulbind);
+#endif
+#if defined(__CHANGE_LOOK_SYSTEM__)
+			item->SetTransmutation(pItems->transmutation);
 #endif
 
-#if defined(__MYSHOP_DECO__)
-void CHARACTER::OpenPrivateShop(BYTE bTabCount, bool bIsCashItem)
-{
-	if (bTabCount > MYSHOP_MAX_TABS)
-		bTabCount = bTabCount;
-
-	if (bIsCashItem == false)
-	{
-		SetMyShopDecoType(0);
-		SetMyShopDecoPolyVnum(30000);
-	}
-
-	SetMyPrivShopTabCount(bTabCount);
-	SetMyPrivShopIsCashItem(bIsCashItem);
-
-	TPacketGCShop Packet;
-	Packet.header = HEADER_GC_SHOP;
-	Packet.subheader = SHOP_SUBHEADER_GC_MYPRIV_SHOP_OPEN;
-
-	TPacketGCMyPrivShopOpen Packet2;
-	Packet2.bCashItem = bIsCashItem;
-	Packet2.bTabCount = bTabCount;
-
-	Packet.size = sizeof(Packet) + sizeof(Packet2);
-
-	if (GetDesc())
-	{
-		GetDesc()->BufferedPacket(&Packet, sizeof(TPacketGCShop));
-		GetDesc()->Packet(&Packet2, sizeof(TPacketGCMyPrivShopOpen));
-	}
+			if (!m_pkSafebox->Add(pItems->pos, item))
+			{
+				M2_DESTROY_ITEM(item);
+			}
+			else
+				item->SetSkipSave(false);
+		}
+	}
+}
+
+void CHARACTER::ChangeSafeboxSize(BYTE bSize)
+{
+	//if (!m_pkSafebox)
+	//	return;
+
+	TPacketCGSafeboxSize p;
+
+	p.bHeader = HEADER_GC_SAFEBOX_SIZE;
+	p.bSize = bSize;
+
+	GetDesc()->Packet(&p, sizeof(TPacketCGSafeboxSize));
+
+	if (m_pkSafebox)
+		m_pkSafebox->ChangeSize(bSize);
+
+	m_iSafeboxSize = bSize;
 }
+
+void CHARACTER::CloseSafebox()
+{
+	if (!m_pkSafebox)
+		return;
+
+	// PREVENT_TRADE_WINDOW
+	SetOpenSafebox(false);
+	// END_PREVENT_TRADE_WINDOW
+
+	m_pkSafebox->Save();
+
+	M2_DELETE(m_pkSafebox);
+	m_pkSafebox = NULL;
+
+	ChatPacket(CHAT_TYPE_COMMAND, "CloseSafebox");
+
+	SetSafeboxLoadTime();
+	m_bOpeningSafebox = false;
+
+	Save();
+}
+
+CSafebox* CHARACTER::GetMall() const
+{
+	return m_pkMall;
+}
+
+void CHARACTER::LoadMall(int iItemCount, TPlayerItem* pItems)
+{
+	bool bLoaded = false;
+
+	if (m_pkMall)
+		bLoaded = true;
+
+	if (!m_pkMall)
+		m_pkMall = M2_NEW CSafebox(this, 3 * SAFEBOX_PAGE_SIZE, 0);
+	else
+		m_pkMall->ChangeSize(3 * SAFEBOX_PAGE_SIZE);
+
+	m_pkMall->SetWindowMode(MALL);
+
+	TPacketCGSafeboxSize p;
+
+	p.bHeader = HEADER_GC_MALL_OPEN;
+	p.bSize = 3 * SAFEBOX_PAGE_SIZE;
+
+	GetDesc()->Packet(&p, sizeof(TPacketCGSafeboxSize));
+
+	if (!bLoaded)
+	{
+		for (int i = 0; i < iItemCount; ++i, ++pItems)
+		{
+			if (!m_pkMall->IsValidPosition(pItems->pos))
+				continue;
+
+			LPITEM item = ITEM_MANAGER::instance().CreateItem(pItems->vnum, pItems->count, pItems->id);
+
+			if (!item)
+			{
+				sys_err("cannot create item vnum %d id %u (name: %s)", pItems->vnum, pItems->id, GetName());
+				continue;
+			}
+
+			item->SetSkipSave(true);
+			item->SetSockets(pItems->alSockets);
+#if defined(__ITEM_APPLY_RANDOM__)
+			item->SetRandomApplies(pItems->aApplyRandom);
+#endif
+			item->SetAttributes(pItems->aAttr);
+#if defined(__SOUL_BIND_SYSTEM__)
+			item->SetSoulBind(pItems->soulbind);
+#endif
+#if defined(__CHANGE_LOOK_SYSTEM__)
+			item->SetTransmutation(pItems->transmutation);
 #endif
 
-#if defined(__LEFT_SEAT__)
-EVENTFUNC(left_seat_wait_timer_event)
+			if (!m_pkMall->Add(pItems->pos, item))
+				M2_DESTROY_ITEM(item);
+			else
+				item->SetSkipSave(false);
+		}
+	}
+}
+
+void CHARACTER::CloseMall()
 {
-	char_event_info* info = dynamic_cast<char_event_info*>(event->info);
-	if (info == NULL)
+	if (!m_pkMall)
+		return;
+
+	m_pkMall->Save();
+
+	M2_DELETE(m_pkMall);
+	m_pkMall = NULL;
+
+	ChatPacket(CHAT_TYPE_COMMAND, "CloseMall");
+}
+
+bool CHARACTER::BuildUpdatePartyPacket(TPacketGCPartyUpdate& out)
+{
+	if (!GetParty())
+		return false;
+
+	memset(&out, 0, sizeof(out));
+
+	out.header = HEADER_GC_PARTY_UPDATE;
+	out.pid = GetPlayerID();
+	out.percent_hp = (GetMaxHP() <= 0) ? 0 : MINMAX(0, GetHP() * 100 / GetMaxHP(), 100);
+	out.role = GetParty()->GetRole(GetPlayerID());
+
+	sys_log(1, "PARTY %s role is %d", GetName(), out.role);
+
+	LPCHARACTER l = GetParty()->GetLeaderCharacter();
+
+	if (l && DISTANCE_APPROX(GetX() - l->GetX(), GetY() - l->GetY()) < PARTY_DEFAULT_RANGE)
+	{
+		if (g_iUseLocale)
+			out.affects[0] = GetParty()->GetPartyBonusExpPercent();
+		else
+			out.affects[0] = GetParty()->GetExpBonusPercent();
+		out.affects[1] = GetPoint(POINT_PARTY_ATTACKER_BONUS);
+		out.affects[2] = GetPoint(POINT_PARTY_TANKER_BONUS);
+		out.affects[3] = GetPoint(POINT_PARTY_BUFFER_BONUS);
+		out.affects[4] = GetPoint(POINT_PARTY_SKILL_MASTER_BONUS);
+		out.affects[5] = GetPoint(POINT_PARTY_HASTE_BONUS);
+		out.affects[6] = GetPoint(POINT_PARTY_DEFENDER_BONUS);
+	}
+
+	return true;
+}
+
+int CHARACTER::GetLeadershipSkillLevel() const
+{
+	return GetSkillLevel(SKILL_LEADERSHIP);
+}
+
+int CHARACTER::GetRoleProficiencySkillLevel() const
+{
+	return GetSkillLevel(SKILL_ROLE_PROFICIENCY);
+}
+
+int CHARACTER::GetInSightSkillLevel() const
+{
+	return GetSkillLevel(SKILL_INSIGHT);
+}
+
+void CHARACTER::QuerySafeboxSize()
+{
+	if (m_iSafeboxSize == -1)
+	{
+		DBManager::instance().ReturnQuery(QID_SAFEBOX_SIZE,
+			GetPlayerID(),
+			NULL,
+			"SELECT size FROM safebox%s WHERE account_id = %u",
+			get_table_postfix(),
+			GetDesc()->GetAccountTable().id);
+	}
+}
+
+void CHARACTER::SetSafeboxSize(int iSize)
+{
+	sys_log(1, "SetSafeboxSize: %s %d", GetName(), iSize);
+	m_iSafeboxSize = iSize;
+	DBManager::instance().Query("UPDATE safebox%s SET size = %d WHERE account_id = %u", get_table_postfix(), iSize / SAFEBOX_PAGE_SIZE, GetDesc()->GetAccountTable().id);
+}
+
+int CHARACTER::GetSafeboxSize() const
+{
+	return m_iSafeboxSize;
+}
+
+void CHARACTER::SetNowWalking(bool bWalkFlag)
+{
+	//if (m_bNowWalking != bWalkFlag || IsNPC())
+	if (m_bNowWalking != bWalkFlag)
+	{
+		if (bWalkFlag)
+		{
+			m_bNowWalking = true;
+			m_dwWalkStartTime = get_dword_time();
+		}
+		else
+		{
+			m_bNowWalking = false;
+		}
+
+		//if (m_bNowWalking)
+		{
+			TPacketGCWalkMode p;
+			p.vid = GetVID();
+			p.header = HEADER_GC_WALK_MODE;
+			p.mode = m_bNowWalking ? WALKMODE_WALK : WALKMODE_RUN;
+
+			PacketView(&p, sizeof(p));
+		}
+
+		if (IsNPC())
+		{
+			if (m_bNowWalking)
+				MonsterLog("ȴ´");
+			else
+				MonsterLog("ڴ");
+		}
+
+		//sys_log(0, "%s is now %s", GetName(), m_bNowWalking ? "walking." : "running.");
+	}
+}
+
+void CHARACTER::StartStaminaConsume()
+{
+	if (m_bStaminaConsume)
+		return;
+
+	PointChange(POINT_STAMINA, 0);
+	m_bStaminaConsume = true;
+	//ChatPacket(CHAT_TYPE_COMMAND, "StartStaminaConsume %d %d", STAMINA_PER_STEP * passes_per_sec, GetStamina());
+	if (IsStaminaHalfConsume())
+		ChatPacket(CHAT_TYPE_COMMAND, "StartStaminaConsume %d %d", STAMINA_PER_STEP * passes_per_sec / 2, GetStamina());
+	else
+		ChatPacket(CHAT_TYPE_COMMAND, "StartStaminaConsume %d %d", STAMINA_PER_STEP * passes_per_sec, GetStamina());
+}
+
+void CHARACTER::StopStaminaConsume()
+{
+	if (!m_bStaminaConsume)
+		return;
+
+	PointChange(POINT_STAMINA, 0);
+	m_bStaminaConsume = false;
+	ChatPacket(CHAT_TYPE_COMMAND, "StopStaminaConsume %d", GetStamina());
+}
+
+bool CHARACTER::IsStaminaConsume() const
+{
+	return m_bStaminaConsume;
+}
+
+bool CHARACTER::IsStaminaHalfConsume() const
+{
+	return IsEquipUniqueItem(UNIQUE_ITEM_HALF_STAMINA);
+}
+
+void CHARACTER::ResetStopTime()
+{
+	m_dwStopTime = get_dword_time();
+}
+
+DWORD CHARACTER::GetStopTime() const
+{
+	return m_dwStopTime;
+}
+
+void CHARACTER::ResetPoint(int iLv)
+{
+	BYTE bJob = GetJob();
+
+	PointChange(POINT_LEVEL, iLv - GetLevel());
+
+	SetRealPoint(POINT_ST, JobInitialPoints[bJob].st);
+	SetPoint(POINT_ST, GetRealPoint(POINT_ST));
+
+	SetRealPoint(POINT_HT, JobInitialPoints[bJob].ht);
+	SetPoint(POINT_HT, GetRealPoint(POINT_HT));
+
+	SetRealPoint(POINT_DX, JobInitialPoints[bJob].dx);
+	SetPoint(POINT_DX, GetRealPoint(POINT_DX));
+
+	SetRealPoint(POINT_IQ, JobInitialPoints[bJob].iq);
+	SetPoint(POINT_IQ, GetRealPoint(POINT_IQ));
+
+	SetRandomHP((iLv - 1) * number(JobInitialPoints[GetJob()].hp_per_lv_begin, JobInitialPoints[GetJob()].hp_per_lv_end));
+	SetRandomSP((iLv - 1) * number(JobInitialPoints[GetJob()].sp_per_lv_begin, JobInitialPoints[GetJob()].sp_per_lv_end));
+
+	PointChange(POINT_STAT, (MINMAX(1, iLv, gPlayerMaxLevelStats) * 3) + GetPoint(POINT_LEVEL_STEP) - GetPoint(POINT_STAT));
+
+	ComputePoints();
+
+	// ȸ
+	PointChange(POINT_HP, GetMaxHP() - GetHP());
+	PointChange(POINT_SP, GetMaxSP() - GetSP());
+
+	PointsPacket();
+
+	LogManager::instance().CharLog(this, 0, "RESET_POINT", "");
+}
+
+void CHARACTER::ResetExp()
+{
+	SetExp(0);
+
+	PointsPacket();
+
+	UpdatePointsPacket(POINT_EXP, GetExp());
+
+	LogManager::instance().CharLog(this, 0, "RESET_EXP", "");
+}
+
+bool CHARACTER::IsChangeAttackPosition(LPCHARACTER target) const
+{
+	if (!IsNPC())
+		return true;
+
+	DWORD dwChangeTime = AI_CHANGE_ATTACK_POISITION_TIME_NEAR;
+
+	if (DISTANCE_APPROX(GetX() - target->GetX(), GetY() - target->GetY()) >
+		AI_CHANGE_ATTACK_POISITION_DISTANCE + GetMobAttackRange())
+		dwChangeTime = AI_CHANGE_ATTACK_POISITION_TIME_FAR;
+
+	return get_dword_time() - m_dwLastChangeAttackPositionTime > dwChangeTime;
+}
+
+void CHARACTER::GiveRandomSkillBook()
+{
+	LPITEM item = AutoGiveItem(ITEM_SKILLBOOK_VNUM);
+
+	if (NULL != item)
+	{
+		BYTE bJob = 0;
+
+		if (!number(0, 1))
+			bJob = GetJob() + 1;
+
+		DWORD dwSkillVnum = 0;
+
+		do
+		{
+#if defined(__WOLFMAN_CHARACTER__)
+			dwSkillVnum = number(1, 175);
+			if (dwSkillVnum > 111 && dwSkillVnum < 170)
+				continue;
+#else
+			dwSkillVnum = number(1, 111);
+#endif
+			const CSkillProto* pkSk = CSkillManager::instance().Get(dwSkillVnum);
+
+			if (NULL == pkSk)
+				continue;
+
+			if (bJob && bJob != pkSk->dwType)
+				continue;
+
+			break;
+		} while (true);
+
+		item->SetSocket(0, dwSkillVnum);
+	}
+}
+
+void CHARACTER::ReviveInvisible(int iDur)
+{
+	AddAffect(AFFECT_REVIVE_INVISIBLE, POINT_NONE, 0, AFF_REVIVE_INVISIBLE, iDur, 0, true);
+}
+
+void CHARACTER::ToggleMonsterLog()
+{
+	m_bMonsterLog = !m_bMonsterLog;
+
+	if (m_bMonsterLog)
+	{
+		ChatPacket(CHAT_TYPE_NOTICE, "Registered Monster Log");
+		CHARACTER_MANAGER::instance().RegisterForMonsterLog(this);
+	}
+	else
+	{
+		ChatPacket(CHAT_TYPE_NOTICE, "Unregistered Monster Log");
+		CHARACTER_MANAGER::instance().UnregisterForMonsterLog(this);
+	}
+}
+
+void CHARACTER::SetGuild(CGuild* pGuild)
+{
+	if (m_pGuild != pGuild)
+	{
+		m_pGuild = pGuild;
+		UpdatePacket();
+	}
+}
+
+void CHARACTER::SendGreetMessage()
+{
+	__typeof__(DBManager::instance().GetGreetMessage()) v = DBManager::instance().GetGreetMessage();
+
+	for (itertype(v) it = v.begin(); it != v.end(); ++it)
+	{
+		ChatPacket(CHAT_TYPE_NOTICE, it->c_str());
+	}
+}
+
+void CHARACTER::BeginStateEmpty()
+{
+	MonsterLog("!");
+}
+
+void CHARACTER::EffectPacket(int enumEffectType)
+{
+	TPacketGCSpecialEffect p;
+
+	p.header = HEADER_GC_SEPCIAL_EFFECT;
+	p.type = enumEffectType;
+	p.vid = GetVID();
+
+	PacketAround(&p, sizeof(TPacketGCSpecialEffect));
+}
+
+void CHARACTER::SpecificEffectPacket(const char filename[MAX_EFFECT_FILE_NAME])
+{
+	TPacketGCSpecificEffect p;
+
+	p.header = HEADER_GC_SPECIFIC_EFFECT;
+	p.vid = GetVID();
+	memcpy(p.effect_file, filename, MAX_EFFECT_FILE_NAME);
+
+	PacketAround(&p, sizeof(TPacketGCSpecificEffect));
+}
+
+void CHARACTER::MonsterChat(BYTE bMonsterChatType)
+{
+	if (IsPC())
+		return;
+
+	char sbuf[256 + 1];
+
+	if (IsMonster())
+	{
+		if (number(0, 60))
+			return;
+
+		snprintf(sbuf, sizeof(sbuf),
+			"(locale.monster_chat[%i] and locale.monster_chat[%i][%d] or '')",
+			GetRaceNum(), GetRaceNum(), bMonsterChatType * 3 + number(1, 3));
+	}
+	else
+	{
+		if (bMonsterChatType != MONSTER_CHAT_WAIT)
+			return;
+
+		if (IsGuardNPC())
+		{
+			if (number(0, 6))
+				return;
+		}
+		else
+		{
+			if (number(0, 30))
+				return;
+		}
+
+		snprintf(sbuf, sizeof(sbuf), "(locale.monster_chat[%i] and locale.monster_chat[%i][number(1, table.getn(locale.monster_chat[%i]))] or '')", GetRaceNum(), GetRaceNum(), GetRaceNum());
+	}
+
+	std::string text = quest::ScriptToString(sbuf);
+
+	if (text.empty())
+		return;
+
+	struct packet_chat pack_chat;
+
+	pack_chat.header = HEADER_GC_CHAT;
+	pack_chat.size = sizeof(struct packet_chat) + text.size() + 1;
+	pack_chat.type = CHAT_TYPE_TALKING;
+	pack_chat.id = GetVID();
+	pack_chat.bEmpire = 0;
+
+	TEMP_BUFFER buf;
+	buf.write(&pack_chat, sizeof(struct packet_chat));
+	buf.write(text.c_str(), text.size() + 1);
+
+	PacketAround(buf.read_peek(), buf.size());
+}
+
+void CHARACTER::SetQuestNPCID(DWORD vid)
+{
+	m_dwQuestNPCVID = vid;
+}
+
+LPCHARACTER CHARACTER::GetQuestNPC() const
+{
+	return CHARACTER_MANAGER::instance().Find(m_dwQuestNPCVID);
+}
+
+void CHARACTER::SetQuestItemPtr(LPITEM item)
+{
+	m_pQuestItem = item;
+}
+
+void CHARACTER::ClearQuestItemPtr()
+{
+	m_pQuestItem = NULL;
+}
+
+LPITEM CHARACTER::GetQuestItemPtr() const
+{
+	return m_pQuestItem;
+}
+
+LPDUNGEON CHARACTER::GetDungeonForce() const
+{
+	if (m_lWarpMapIndex > 10000)
+		return CDungeonManager::instance().FindByMapIndex(m_lWarpMapIndex);
+
+	return m_pkDungeon;
+}
+
+void CHARACTER::SetBlockMode(BYTE bFlag)
+{
+	m_pointsInstant.bBlockMode = bFlag;
+
+	ChatPacket(CHAT_TYPE_COMMAND, "setblockmode %d", m_pointsInstant.bBlockMode);
+
+	SetQuestFlag("game_option.block_exchange", bFlag & BLOCK_EXCHANGE ? 1 : 0);
+	SetQuestFlag("game_option.block_party_invite", bFlag & BLOCK_PARTY_INVITE ? 1 : 0);
+	SetQuestFlag("game_option.block_guild_invite", bFlag & BLOCK_GUILD_INVITE ? 1 : 0);
+	SetQuestFlag("game_option.block_whisper", bFlag & BLOCK_WHISPER ? 1 : 0);
+	SetQuestFlag("game_option.block_messenger_invite", bFlag & BLOCK_MESSENGER_INVITE ? 1 : 0);
+	SetQuestFlag("game_option.block_party_request", bFlag & BLOCK_PARTY_REQUEST ? 1 : 0);
+}
+
+void CHARACTER::SetBlockModeForce(BYTE bFlag)
+{
+	m_pointsInstant.bBlockMode = bFlag;
+	ChatPacket(CHAT_TYPE_COMMAND, "setblockmode %d", m_pointsInstant.bBlockMode);
+}
+
+bool CHARACTER::IsGuardNPC() const
+{
+	return IsNPC() && (GetRaceNum() == 11000 || GetRaceNum() == 11002 || GetRaceNum() == 11004);
+}
+
+int CHARACTER::GetPolymorphPower() const
+{
+	if (test_server)
 	{
-		sys_err("left_seat_wait_timer_event> <Factor> Null pointer");
+		int value = quest::CQuestManager::instance().GetEventFlag("poly");
+		if (value)
+			return value;
+	}
+	return aiPolymorphPowerByLevel[MINMAX(0, GetSkillLevel(SKILL_POLYMORPH), 40)];
+}
+
+void CHARACTER::SetPolymorph(DWORD dwRaceNum, bool bMaintainStat)
+{
+	if (dwRaceNum < MAIN_RACE_MAX_NUM)
+	{
+		dwRaceNum = 0;
+		bMaintainStat = false;
+	}
+
+	if (m_dwPolymorphRace == dwRaceNum)
+		return;
+
+	m_bPolyMaintainStat = bMaintainStat;
+	m_dwPolymorphRace = dwRaceNum;
+
+	sys_log(0, "POLYMORPH: %s race %u ", GetName(), dwRaceNum);
+
+	if (dwRaceNum != 0)
+		StopRiding();
+
+	SET_BIT(m_bAddChrState, ADD_CHARACTER_STATE_SPAWN);
+	m_afAffectFlag.Set(AFF_SPAWN);
+
+	ViewReencode();
+
+	REMOVE_BIT(m_bAddChrState, ADD_CHARACTER_STATE_SPAWN);
+
+	if (!bMaintainStat)
+	{
+		PointChange(POINT_ST, 0);
+		PointChange(POINT_DX, 0);
+		PointChange(POINT_IQ, 0);
+		PointChange(POINT_HT, 0);
+	}
+
+	//  ¿ ״ ,  Ǯ Ǵµ
+	//   ķ valid combo interval ٸ 
+	// Combo  Ǵ Hacker νϴ 찡 ִ.
+	//   Ǯų  ϰ Ǹ,
+	// valid combo interval resetѴ.
+	SetValidComboInterval(0);
+	SetComboSequence(0);
+
+	ComputeBattlePoints();
+}
+
+int CHARACTER::GetQuestFlag(const std::string& flag) const
+{
+	if (!IsPC())
+	{
+		sys_err("Trying to get qf %s from non player character", flag.c_str());
 		return 0;
 	}
 
-	LPCHARACTER ch = info->ch;
-	if (ch == NULL) // <Factor>
+	DWORD pid = GetPlayerID();
+
+	quest::CQuestManager& q = quest::CQuestManager::instance();
+	quest::PC* pPC = q.GetPC(pid);
+
+	if (!pPC)
+	{
+		sys_err("Nullpointer when trying to access questflag %s for player with pid %lu", flag.c_str(), pid);
 		return 0;
+	}
+
+	return pPC->GetFlag(flag);
+}
 
-	if (ch->GetMyShop())
-		return PASSES_PER_SEC(LEFT_SEAT_PULSE);
+void CHARACTER::SetQuestFlag(const std::string& flag, int value)
+{
+	DWORD pid = GetPlayerID();
 
-	if (ch->IsRunningQuest())
-		return PASSES_PER_SEC(LEFT_SEAT_PULSE);
+	quest::CQuestManager& q = quest::CQuestManager::instance();
+	quest::PC* pPC = q.GetPC(pid);
 
-	if (get_dword_time() - ch->GetLastRequestTime() > 1000 * ch->GetLeftSeatWaitTime())
+	if (!pPC)
 	{
-		if (ch->LeftSeat() == false)
+		sys_err("Nullpointer when trying to set questflag %s for player with pid %lu", flag.c_str(), pid);
+		return;
+	}
+
+	pPC->SetFlag(flag, value);
+}
+
+void CHARACTER::DetermineDropMetinStone()
+{
+#if defined(__MAGIC_REDUCTION__)
+	const int METIN_STONE_NUM = 17;
+#else
+	const int METIN_STONE_NUM = 15;
+#endif
+
+	static DWORD c_adwMetin[METIN_STONE_NUM] =
+	{
+		28030, // 60
+		28031,
+		28032,
+		28033,
+		28034,
+		28035,
+		28036,
+		28037,
+		28038,
+		28039,
+		28040,
+		28041,
+		28042,
+		28043,
+#if defined(__MAGIC_REDUCTION__)
+		28044,
+		28045,
+#endif
+		28012,
+	};
+
+	DWORD stone_num = GetRaceNum();
+	int idx = std::lower_bound(aStoneDrop, aStoneDrop + STONE_INFO_MAX_NUM, stone_num) - aStoneDrop;
+	if (idx >= STONE_INFO_MAX_NUM || aStoneDrop[idx].dwMobVnum != stone_num)
+	{
+		m_dwDropMetinStone = 0;
+	}
+	else
+	{
+		const SStoneDropInfo& info = aStoneDrop[idx];
+		m_bDropMetinStonePct = info.iDropPct;
+		{
+			m_dwDropMetinStone = c_adwMetin[number(0, METIN_STONE_NUM - 1)];
+			int iGradePct = number(1, 100);
+
+			for (int iStoneLevel = 0; iStoneLevel < STONE_LEVEL_MAX_NUM; iStoneLevel++)
+			{
+				int iLevelGradePortion = info.iLevelPct[iStoneLevel];
+
+				if (iGradePct <= iLevelGradePortion)
+				{
+					break;
+				}
+				else
+				{
+					iGradePct -= iLevelGradePortion;
+					m_dwDropMetinStone += 100; //  +a -> +(a+1) ɶ 100 
+				}
+			}
+		}
+	}
+}
+
+void CHARACTER::SendEquipment(LPCHARACTER ch)
+{
+	TPacketViewEquip p;
+	p.header = HEADER_GC_VIEW_EQUIP;
+	p.vid = GetVID();
+	for (int i = 0; i < WEAR_MAX_NUM; i++)
+	{
+		LPITEM item = GetWear(i);
+		if (item)
 		{
-			ch->SetLeftSeat(true);
+			p.equips[i].vnum = item->GetVnum();
+			p.equips[i].count = (BYTE)item->GetCount();
 
-			if (ch->GetLeftSeatLogoutTime())
-				ch->RestartLeftSeatLogoutTimer();
+			thecore_memcpy(p.equips[i].alSockets, item->GetSockets(), sizeof(p.equips[i].alSockets));
+			thecore_memcpy(p.equips[i].aAttr, item->GetAttributes(), sizeof(p.equips[i].aAttr));
+		}
+		else
+		{
+			p.equips[i].vnum = 0;
 		}
 	}
+	ch->GetDesc()->Packet(&p, sizeof(p));
+}
 
-	return PASSES_PER_SEC(LEFT_SEAT_PULSE);
+bool CHARACTER::CanSummon(int iLeaderShip)
+{
+	return (iLeaderShip >= 30 && m_dwLastDeadTime + 300 > get_dword_time());
 }
 
-void CHARACTER::RestartLeftSeatWaitTimer()
+void CHARACTER::UnMount(bool bUnequipItem)
 {
-	if (m_pLeftSeatWaitTimerEvent)
-		event_cancel(&m_pLeftSeatWaitTimerEvent);
+	if (bUnequipItem)
+		UnEquipSpecialRideUniqueItem();
+
+	RemoveAffect(AFFECT_MOUNT);
+	RemoveAffect(AFFECT_MOUNT_BONUS);
+
+	if (IsHorseRiding())
+	{
+		StopRiding();
+	}
+	else if (GetMountVnum())
+	{
+		MountVnum(0);
+	}
+}
+
+void CHARACTER::MountVnum(DWORD vnum)
+{
+	if (m_dwMountVnum == vnum)
+		return;
+
+	if ((m_dwMountVnum != 0) && (vnum != 0))
+		MountVnum(0);
+
+	m_dwMountVnum = vnum;
+	m_dwMountTime = get_dword_time();
+
+	if (m_bIsObserver)
+		return;
+
+	m_posDest.x = m_posStart.x = GetX();
+	m_posDest.y = m_posStart.y = GetY();
+
+	// NOTE : MountѴٰ ؼ Client Side ü  ʴ´.
+	// ׸ Side  ġ ̵  ʴ´. ֳϸ Client Side Coliision Adjust Ҽ ִµ
+	// ü Ҹ״ٰ ġ ̵Ű ̶ collision check  Ƿ 濡 ų հ   Ѵ.
+	m_posDest.x = m_posStart.x = GetX();
+	m_posDest.y = m_posStart.y = GetY();
+#ifdef __MOUNT_ENTITY_REFRESH__
+	EncodeRemovePacket(this);
+#endif
+	EncodeInsertPacket(this);
+
+	ENTITY_MAP::iterator it = m_map_view.begin();
+
+	while (it != m_map_view.end())
+	{
+		LPENTITY entity = (it++)->first;
+
+		// MountѴٰ ؼ Client Side ü  ʴ´.
+#ifdef __MOUNT_ENTITY_REFRESH__
+		EncodeRemovePacket(entity);
+		if (!m_bIsObserver)
+			EncodeInsertPacket(entity);
+#else
+		EncodeInsertPacket(entity);
+#endif
+
+#ifdef __MOUNT_ENTITY_REFRESH__
+		if (!entity->IsObserverMode())
+			entity->EncodeInsertPacket(this);
+#endif
+	}
+
+	SetValidComboInterval(0);
+	SetComboSequence(0);
+
+	ComputePoints();
+}
+
+namespace
+{
+	class FuncCheckWarp
+	{
+	public:
+		FuncCheckWarp(LPCHARACTER pkWarp)
+		{
+			m_lTargetY = 0;
+			m_lTargetX = 0;
+
+			m_lX = pkWarp->GetX();
+			m_lY = pkWarp->GetY();
+
+			m_bInvalid = false;
+			m_bEmpire = pkWarp->GetEmpire();
+
+			char szTmp[64];
+
+			if (3 != sscanf(pkWarp->GetName(), " %s %ld %ld ", szTmp, &m_lTargetX, &m_lTargetY))
+			{
+				if (number(1, 100) < 5)
+					sys_err("Warp NPC name wrong : vnum(%d) name(%s)", pkWarp->GetRaceNum(), pkWarp->GetName());
+
+				m_bInvalid = true;
+
+				return;
+			}
+
+			m_lTargetX *= 100;
+			m_lTargetY *= 100;
+
+			m_bUseWarp = true;
+
+			if (pkWarp->IsGoto())
+			{
+				LPSECTREE_MAP pkSectreeMap = SECTREE_MANAGER::instance().GetMap(pkWarp->GetMapIndex());
+				m_lTargetX += pkSectreeMap->m_setting.iBaseX;
+				m_lTargetY += pkSectreeMap->m_setting.iBaseY;
+				m_bUseWarp = false;
+			}
+		}
+
+		bool Valid()
+		{
+			return !m_bInvalid;
+		}
+
+		void operator () (LPENTITY ent)
+		{
+			if (!Valid())
+				return;
+
+			if (!ent->IsType(ENTITY_CHARACTER))
+				return;
+
+			LPCHARACTER pkChr = (LPCHARACTER)ent;
+
+			if (!pkChr->IsPC())
+				return;
+
+			int iDist = DISTANCE_APPROX(pkChr->GetX() - m_lX, pkChr->GetY() - m_lY);
+
+			if (iDist > 300)
+				return;
+
+			if (m_bEmpire && pkChr->GetEmpire() && m_bEmpire != pkChr->GetEmpire())
+				return;
+
+			if (pkChr->IsHack())
+				return;
+
+			if (!pkChr->CanHandleItem(false, true))
+				return;
+
+			if (m_bUseWarp)
+				pkChr->WarpSet(m_lTargetX, m_lTargetY);
+			else
+			{
+				pkChr->Show(pkChr->GetMapIndex(), m_lTargetX, m_lTargetY);
+				pkChr->Stop();
+			}
+		}
+
+		bool m_bInvalid;
+		bool m_bUseWarp;
+
+		long m_lX;
+		long m_lY;
+		long m_lTargetX;
+		long m_lTargetY;
+
+		BYTE m_bEmpire;
+	};
+}
+
+EVENTFUNC(warp_npc_event)
+{
+	char_event_info* info = dynamic_cast<char_event_info*>(event->info);
+	if (info == NULL)
+	{
+		sys_err("warp_npc_event> <Factor> Null pointer");
+		return 0;
+	}
+
+	LPCHARACTER ch = info->ch;
+
+	if (ch == NULL) // <Factor>
+		return 0;
+
+	if (!ch->GetSectree())
+	{
+		ch->m_pkWarpNPCEvent = NULL;
+		return 0;
+	}
+
+	FuncCheckWarp f(ch);
+	if (f.Valid())
+		ch->GetSectree()->ForEachAround(f);
+
+	return passes_per_sec / 2;
+}
+
+void CHARACTER::StartWarpNPCEvent()
+{
+	if (m_pkWarpNPCEvent)
+		return;
+
+	if (!IsWarp() && !IsGoto())
+		return;
 
 	char_event_info* info = AllocEventInfo<char_event_info>();
+
 	info->ch = this;
-	m_pLeftSeatWaitTimerEvent = event_create(left_seat_wait_timer_event, info, PASSES_PER_SEC(LEFT_SEAT_PULSE));
+
+	m_pkWarpNPCEvent = event_create(warp_npc_event, info, passes_per_sec / 2);
+}
+
+void CHARACTER::SyncPacket()
+{
+	TEMP_BUFFER buf;
+
+	TPacketCGSyncPositionElement elem;
+
+	elem.dwVID = GetVID();
+	elem.lX = GetX();
+	elem.lY = GetY();
+
+	TPacketGCSyncPosition pack;
+
+	pack.bHeader = HEADER_GC_SYNC_POSITION;
+	pack.wSize = sizeof(TPacketGCSyncPosition) + sizeof(elem);
+
+	buf.write(&pack, sizeof(pack));
+	buf.write(&elem, sizeof(elem));
+
+	PacketAround(buf.read_peek(), buf.size());
+}
+
+LPCHARACTER CHARACTER::GetMarryPartner() const
+{
+	return m_pkChrMarried;
+}
+
+void CHARACTER::SetMarryPartner(LPCHARACTER ch)
+{
+	m_pkChrMarried = ch;
+}
+
+int CHARACTER::GetMarriageBonus(DWORD dwItemVnum, bool bSum)
+{
+	if (IsNPC())
+		return 0;
+
+	marriage::TMarriage* pMarriage = marriage::CManager::instance().Get(GetPlayerID());
+
+	if (!pMarriage)
+		return 0;
+
+	return pMarriage->GetBonus(dwItemVnum, bSum, this);
+}
+
+void CHARACTER::ConfirmWithMsg(const char* szMsg, int iTimeout, DWORD dwRequestPID)
+{
+	if (!IsPC())
+		return;
+
+	TPacketGCQuestConfirm p;
+
+	p.header = HEADER_GC_QUEST_CONFIRM;
+	p.requestPID = dwRequestPID;
+	p.timeout = iTimeout;
+	strlcpy(p.msg, szMsg, sizeof(p.msg));
+
+	GetDesc()->Packet(&p, sizeof(p));
+}
+
+int CHARACTER::GetPremiumRemainSeconds(BYTE bType) const
+{
+	if (bType >= PREMIUM_MAX_NUM)
+		return 0;
+
+	return m_aiPremiumTimes[bType] - get_global_time();
 }
 
-void CHARACTER::SetLeftSeatWaitTime(BYTE bIndex)
+bool CHARACTER::WarpToPID(DWORD dwPID, bool bWarpForce)
 {
-	DWORD dwTime = 0;
-	switch (bIndex)
+	LPCHARACTER victim;
+	if ((victim = (CHARACTER_MANAGER::instance().FindByPID(dwPID))))
 	{
-		case LEFT_SEAT_TIME_10_MIN:
-			dwTime = 60 * 10;
-			break;
-		case LEFT_SEAT_TIME_30_MIN:
-			dwTime = 60 * 30;
-			break;
-		case LEFT_SEAT_TIME_90_MIN:
-			dwTime = 60 * 90;
-			break;
-		default:
-			dwTime = 60 * 10;
-			break;
+		int mapIdx = victim->GetMapIndex();
+		if (IS_SUMMONABLE_ZONE(mapIdx))
+		{
+			if (CAN_ENTER_ZONE(this, mapIdx))
+			{
+				WarpSet(victim->GetX(), victim->GetY());
+			}
+			else
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ִ    ϴ."));
+				return false;
+			}
+		}
+		else
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ִ    ϴ."));
+			return false;
+		}
+	}
+	else
+	{
+		// ٸ  αε   -> ޽  ǥ ޾ƿ
+		// 1. A.pid, B.pid  Ѹ
+		// 2. B.pid   Ѹ A.pid, ǥ  
+		// 3. 
+		CCI* pcci = P2P_MANAGER::instance().FindByPID(dwPID);
+
+		if (!pcci)
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ¶ ° ƴմϴ."));
+			return false;
+		}
+
+		if ((pcci->bChannel != g_bChannel) && !bWarpForce)
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" %d äο ֽϴ. ( ä %d)"), pcci->bChannel, g_bChannel);
+			return false;
+		}
+		else if (false == IS_SUMMONABLE_ZONE(pcci->lMapIndex))
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ִ    ϴ."));
+			return false;
+		}
+		else
+		{
+			if (!CAN_ENTER_ZONE(this, pcci->lMapIndex))
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ִ    ϴ."));
+				return false;
+			}
+
+			TPacketGGFindPosition p;
+			p.header = HEADER_GG_FIND_POSITION;
+			p.dwFromPID = GetPlayerID();
+			p.dwTargetPID = dwPID;
+			pcci->pkDesc->Packet(&p, sizeof(TPacketGGFindPosition));
+
+			if (test_server)
+				ChatPacket(CHAT_TYPE_PARTY, "sent find position packet for teleport");
+		}
 	}
+	return true;
+}
+
+// ADD_REFINE_BUILDING
+CGuild* CHARACTER::GetRefineGuild() const
+{
+	LPCHARACTER chRefineNPC = CHARACTER_MANAGER::instance().Find(m_dwRefineNPCVID);
 
-	//if (test_server)
-	//	dwTime = 10;
+	return (chRefineNPC ? chRefineNPC->GetGuild() : NULL);
+}
+
+bool CHARACTER::IsRefineThroughGuild() const
+{
+	return GetRefineGuild() != NULL;
+}
+
+int CHARACTER::ComputeRefineFee(int iCost, int iMultiply) const
+{
+	CGuild* pGuild = GetRefineGuild();
+	if (pGuild)
+	{
+		if (pGuild == GetGuild())
+			return iCost * iMultiply * 9 / 10;
+
+		// ٸ   õϴ  ߰ 3 
+		LPCHARACTER chRefineNPC = CHARACTER_MANAGER::instance().Find(m_dwRefineNPCVID);
+		if (chRefineNPC && chRefineNPC->GetEmpire() != GetEmpire())
+			return iCost * iMultiply * 3;
+
+		return iCost * iMultiply;
+	}
+	else
+		return iCost;
+}
 
-	m_dwLeftSeatWaitTime = dwTime;
-	RestartLeftSeatWaitTimer();
+void CHARACTER::PayRefineFee(int iTotalMoney)
+{
+	int iFee = iTotalMoney / 10;
+	CGuild* pGuild = GetRefineGuild();
+
+	int iRemain = iTotalMoney;
+
+	if (pGuild)
+	{
+		// ڱ ̸ iTotalMoney ̹ 10% ܵǾִ
+		if (pGuild != GetGuild())
+		{
+			pGuild->RequestDepositMoney(this, iFee);
+			iRemain -= iFee;
+		}
+	}
+
+	PointChange(POINT_GOLD, -iRemain);
+}
+// END_OF_ADD_REFINE_BUILDING
+
+// PREVENT_TRADE_WINDOW
+bool CHARACTER::PreventTradeWindow(int flags, bool except) const
+{
+	if (WND_ALL & flags)
+	{
+		flags = 0x0;
+		except = true;
+	}
+
+	if (except && !(WND_EXCHANGE & flags) || !except && (WND_EXCHANGE & flags))
+		if (GetExchange())
+			return true;
+
+	if (except && !(WND_MYSHOP & flags) || !except && (WND_MYSHOP & flags))
+		if (GetMyShop())
+			return true;
+
+	if (except && !(WND_SHOPOWNER & flags) || !except && (WND_SHOPOWNER & flags))
+		if (GetShopOwner())
+			return true;
+
+	if (except && !(WND_SAFEBOX & flags) || !except && (WND_SAFEBOX & flags))
+		if (IsOpenSafebox())
+			return true;
+
+	if (except && !(WND_REFINE & flags) || !except && (WND_REFINE & flags))
+		if (IsUnderRefine())
+			return true;
+
+	if (except && !(WND_CUBE & flags) || !except && (WND_CUBE & flags))
+		if (IsCubeOpen())
+			return true;
+
+#if defined(__PRIVATESHOP_SEARCH_SYSTEM__)
+	if (except && !(WND_SHOPSEARCH & flags) || !except && (WND_SHOPSEARCH & flags))
+		if (GetPrivateShopSearchState() != SHOP_SEARCH_OFF)
+			return true;
+#endif
+	
+#if defined(__MAILBOX__)
+	if (except && !(WND_MAILBOX & flags) || !except && (WND_MAILBOX & flags))
+		if (GetMailBox())
+			return true;
+#endif
+
+#if defined(__SOUL_ROULETTE__)
+	if (except && !(WND_ROULETTE & flags) || !except && (WND_ROULETTE & flags))
+		if (GetSoulRoulette())
+			return true;
+#endif
+
+#if defined(__ATTR_6TH_7TH__)
+	if (except && !(WND_ATTR67ADD & flags) || !except && (WND_ATTR67ADD & flags))
+		if (IsOpenAttr67Add())
+			return true;
+#endif
+
+	return false;
+}
+// END_PREVENT_TRADE_WINDOW
+
+// Hack   üũ.
+bool CHARACTER::IsHack(bool bSendMsg, bool bCheckShopOwner, int limittime)
+{
+	const int iPulse = thecore_pulse();
+
+	if (test_server)
+		bSendMsg = true;
+
+	// â  üũ
+	if (iPulse - GetSafeboxLoadTime() < PASSES_PER_SEC(limittime))
+	{
+		if (bSendMsg)
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("â  %d ̳ ٸ ̵Ҽ ϴ."), limittime);
+
+		if (test_server)
+			ChatPacket(CHAT_TYPE_INFO, "[TestOnly]Pulse %d LoadTime %d PASS %d", iPulse, GetSafeboxLoadTime(), PASSES_PER_SEC(limittime));
+		return true;
+	}
+
+	// ŷ â üũ
+	if (bCheckShopOwner)
+	{
+		if (PreventTradeWindow(WND_ALL))
+		{
+			if (bSendMsg)
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ŷâ,â   ¿ ٸ ̵, Ҽ ϴ"));
+
+			return true;
+		}
+	}
+	else
+	{
+		if (PreventTradeWindow(WND_SHOPOWNER, true/*except*/))
+		{
+			if (bSendMsg)
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ŷâ,â   ¿ ٸ ̵, Ҽ ϴ"));
+
+			return true;
+		}
+	}
+
+	// PREVENT_PORTAL_AFTER_EXCHANGE
+	// ȯ  ðüũ
+	if (iPulse - GetExchangeTime() < PASSES_PER_SEC(limittime))
+	{
+		if (bSendMsg)
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ŷ  %d ̳ ٸ ̵   ϴ."), limittime);
+		return true;
+	}
+	// END_PREVENT_PORTAL_AFTER_EXCHANGE
+
+	// PREVENT_ITEM_COPY
+	if (iPulse - GetMyShopTime() < PASSES_PER_SEC(limittime))
+	{
+		if (bSendMsg)
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ŷ  %d ̳ ٸ ̵   ϴ."), limittime);
+		return true;
+	}
+
+	if (iPulse - GetRefineTime() < PASSES_PER_SEC(limittime))
+	{
+		if (bSendMsg)
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  %d ̳ ȯ,ȯθ   ϴ."), limittime);
+		return true;
+	}
+
+#if defined(__MAILBOX__)
+	if (iPulse - GetMyMailBoxTime() < PASSES_PER_SEC(limittime))
+	{
+		if (bSendMsg)
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You have to wait %d sec. after opening the Mailbox before you can switch channels or teleport."), limittime);
+		return true;
+	}
+#endif
+	// END_PREVENT_ITEM_COPY
+
+	return false;
+}
+
+BOOL CHARACTER::IsMonarch() const
+{
+	// MONARCH_LIMIT
+	if (CMonarch::instance().IsMonarch(GetPlayerID(), GetEmpire()))
+		return true;
+
+	return false;
+
+	// END_MONARCH_LIMIT
+}
+
+void CHARACTER::Say(const std::string& s)
+{
+	struct ::packet_script packet_script;
+
+	packet_script.header = HEADER_GC_SCRIPT;
+	packet_script.skin = 1;
+	packet_script.src_size = s.size();
+	packet_script.size = packet_script.src_size + sizeof(struct packet_script);
+
+	TEMP_BUFFER buf;
+
+	buf.write(&packet_script, sizeof(struct packet_script));
+	buf.write(&s[0], s.size());
+
+	if (IsPC())
+	{
+		GetDesc()->Packet(buf.read_peek(), buf.size());
+	}
+}
+
+//
+// Monarch
+//
+void CHARACTER::InitMC()
+{
+	for (int n = 0; n < MI_MAX; ++n)
+	{
+		m_dwMonarchCooltime[n] = thecore_pulse();
+	}
+
+	m_dwMonarchCooltimelimit[MI_HEAL] = PASSES_PER_SEC(MC_HEAL);
+	m_dwMonarchCooltimelimit[MI_WARP] = PASSES_PER_SEC(MC_WARP);
+	m_dwMonarchCooltimelimit[MI_TRANSFER] = PASSES_PER_SEC(MC_TRANSFER);
+	m_dwMonarchCooltimelimit[MI_TAX] = PASSES_PER_SEC(MC_TAX);
+	m_dwMonarchCooltimelimit[MI_SUMMON] = PASSES_PER_SEC(MC_SUMMON);
+
+	m_dwMonarchCooltime[MI_HEAL] -= PASSES_PER_SEC(GetMCL(MI_HEAL));
+	m_dwMonarchCooltime[MI_WARP] -= PASSES_PER_SEC(GetMCL(MI_WARP));
+	m_dwMonarchCooltime[MI_TRANSFER] -= PASSES_PER_SEC(GetMCL(MI_TRANSFER));
+	m_dwMonarchCooltime[MI_TAX] -= PASSES_PER_SEC(GetMCL(MI_TAX));
+	m_dwMonarchCooltime[MI_SUMMON] -= PASSES_PER_SEC(GetMCL(MI_SUMMON));
+}
+
+DWORD CHARACTER::GetMC(enum MONARCH_INDEX e) const
+{
+	return m_dwMonarchCooltime[e];
 }
 
-EVENTFUNC(left_seat_logout_timer_event)
+void CHARACTER::SetMC(enum MONARCH_INDEX e)
+{
+	m_dwMonarchCooltime[e] = thecore_pulse();
+}
+
+bool CHARACTER::IsMCOK(enum MONARCH_INDEX e) const
+{
+	int iPulse = thecore_pulse();
+
+	if ((iPulse - GetMC(e)) < GetMCL(e))
+	{
+		if (test_server)
+			sys_log(0, " Pulse %d cooltime %d, limit %d", iPulse, GetMC(e), GetMCL(e));
+
+		return false;
+	}
+
+	if (test_server)
+		sys_log(0, " Pulse %d cooltime %d, limit %d", iPulse, GetMC(e), GetMCL(e));
+
+	return true;
+}
+
+DWORD CHARACTER::GetMCL(enum MONARCH_INDEX e) const
+{
+	return m_dwMonarchCooltimelimit[e];
+}
+
+DWORD CHARACTER::GetMCLTime(enum MONARCH_INDEX e) const
+{
+	int iPulse = thecore_pulse();
+
+	if (test_server)
+		sys_log(0, " Pulse %d cooltime %d, limit %d", iPulse, GetMC(e), GetMCL(e));
+
+	return (GetMCL(e)) / passes_per_sec - (iPulse - GetMC(e)) / passes_per_sec;
+}
+
+bool CHARACTER::IsSiegeNPC() const
+{
+	return IsNPC() && (GetRaceNum() == 11000 || GetRaceNum() == 11002 || GetRaceNum() == 11004);
+}
+
+//------------------------------------------------
+void CHARACTER::UpdateDepositPulse()
+{
+	m_deposit_pulse = thecore_pulse() + PASSES_PER_SEC(60 * 5); // 5
+}
+
+bool CHARACTER::CanDeposit() const
+{
+	return (m_deposit_pulse == 0 || (m_deposit_pulse < thecore_pulse()));
+}
+//------------------------------------------------
+
+ESex GET_SEX(LPCHARACTER ch)
+{
+	switch (ch->GetRaceNum())
+	{
+	case MAIN_RACE_WARRIOR_M:
+	case MAIN_RACE_SURA_M:
+	case MAIN_RACE_ASSASSIN_M:
+	case MAIN_RACE_SHAMAN_M:
+	case MAIN_RACE_WOLFMAN_M:
+		return SEX_MALE;
+
+	case MAIN_RACE_ASSASSIN_W:
+	case MAIN_RACE_SHAMAN_W:
+	case MAIN_RACE_WARRIOR_W:
+	case MAIN_RACE_SURA_W:
+		return SEX_FEMALE;
+
+	}
+
+	/* default sex = male */
+	return SEX_MALE;
+}
+
+#if defined(__CONQUEROR_LEVEL__)
+int64_t CHARACTER::GetMaxHP() const
+{
+	int64_t iMaxHP = m_pointsInstant.iMaxHP;
+	if (GetSungMaWill(POINT_SUNGMA_HP) > GetPoint(POINT_SUNGMA_HP))
+		if (iMaxHP > 0) iMaxHP /= 2;
+	return iMaxHP;
+}
+#endif
+
+int CHARACTER::GetHPPct() const
+{
+	if (GetMaxHP() <= 0)
+		return 0;
+
+	return (GetHP() * 100) / GetMaxHP();
+}
+
+bool CHARACTER::IsBerserk() const
+{
+	if (m_pkMobInst != NULL)
+		return m_pkMobInst->m_IsBerserk;
+	else
+		return false;
+}
+
+void CHARACTER::SetBerserk(bool mode)
+{
+	if (m_pkMobInst != NULL)
+		m_pkMobInst->m_IsBerserk = mode;
+}
+
+bool CHARACTER::IsGodSpeed() const
+{
+	if (m_pkMobInst != NULL)
+	{
+		return m_pkMobInst->m_IsGodSpeed;
+	}
+	else
+	{
+		return false;
+	}
+}
+
+void CHARACTER::SetGodSpeed(bool mode)
+{
+	if (m_pkMobInst != NULL)
+	{
+		m_pkMobInst->m_IsGodSpeed = mode;
+
+		if (mode == true)
+		{
+			SetPoint(POINT_ATT_SPEED, 250);
+		}
+		else
+		{
+			SetPoint(POINT_ATT_SPEED, m_pkMobData->m_table.sAttackSpeed);
+		}
+	}
+}
+
+bool CHARACTER::IsDeathBlow() const
+{
+	if (number(1, 100) <= m_pkMobData->m_table.bDeathBlowPoint)
+	{
+		return true;
+	}
+	else
+	{
+		return false;
+	}
+}
+
+struct FFindReviver
+{
+	FFindReviver()
+	{
+		pChar = NULL;
+		HasReviver = false;
+	}
+
+	void operator() (LPCHARACTER ch)
+	{
+		if (ch->IsMonster() != true)
+		{
+			return;
+		}
+
+		if (ch->IsReviver() == true && pChar != ch && ch->IsDead() != true)
+		{
+			if (number(1, 100) <= ch->GetMobTable().bRevivePoint)
+			{
+				HasReviver = true;
+				pChar = ch;
+			}
+		}
+	}
+
+	LPCHARACTER pChar;
+	bool HasReviver;
+};
+
+bool CHARACTER::HasReviverInParty() const
+{
+	LPPARTY party = GetParty();
+
+	if (party != NULL)
+	{
+		if (party->GetMemberCount() == 1) return false;
+
+		FFindReviver f;
+		party->ForEachMemberPtr(f);
+		return f.HasReviver;
+	}
+
+	return false;
+}
+
+bool CHARACTER::IsRevive() const
+{
+	if (m_pkMobInst != NULL)
+	{
+		return m_pkMobInst->m_IsRevive;
+	}
+
+	return false;
+}
+
+void CHARACTER::SetRevive(bool mode)
+{
+	if (m_pkMobInst != NULL)
+	{
+		m_pkMobInst->m_IsRevive = mode;
+	}
+}
+
+#define IS_SPEED_HACK_PLAYER(ch) (ch->m_speed_hack_count > SPEEDHACK_LIMIT_COUNT)
+
+EVENTFUNC(check_speedhack_event)
 {
 	char_event_info* info = dynamic_cast<char_event_info*>(event->info);
 	if (info == NULL)
 	{
-		sys_err("left_seat_logout_timer_event> <Factor> Null pointer");
+		sys_err("check_speedhack_event> <Factor> Null pointer");
 		return 0;
 	}
 
-	LPCHARACTER ch = info->ch;
-	if (ch == NULL) // <Factor>
+	LPCHARACTER ch = info->ch;
+
+	if (NULL == ch || ch->IsNPC())
 		return 0;
 
-	LPDESC d = ch->GetDesc();
-	if (ch->LeftSeat())
-	{
-		ch->Disconnect("LEFT_SEAT");
-		if (d)
-			d->SetPhase(PHASE_CLOSE);
+	if (IS_SPEED_HACK_PLAYER(ch))
+	{
+		// Write hack log
+		LogManager::instance().SpeedHackLog(ch->GetPlayerID(), ch->GetX(), ch->GetY(), ch->m_speed_hack_count);
+
+		//if (false == LC_IsEurope())
+		{
+			// Close connection
+			LPDESC desc = ch->GetDesc();
+
+			if (desc)
+			{
+				DESC_MANAGER::instance().DestroyDesc(desc);
+				return 0;
+			}
+		}
 	}
 
-	return 0;
+	ch->m_speed_hack_count = 0;
+
+	ch->ResetComboHackCount();
+	return PASSES_PER_SEC(60);
+}
+
+void CHARACTER::StartCheckSpeedHackEvent()
+{
+	if (m_pkCheckSpeedHackEvent)
+		return;
+
+	char_event_info* info = AllocEventInfo<char_event_info>();
+
+	info->ch = this;
+
+	m_pkCheckSpeedHackEvent = event_create(check_speedhack_event, info, PASSES_PER_SEC(60)); // 1
 }
 
-void CHARACTER::RestartLeftSeatLogoutTimer()
+void CHARACTER::GoHome()
 {
-	if (m_pLeftSeatLogoutTimerEvent)
-		event_cancel(&m_pLeftSeatLogoutTimerEvent);
+	WarpSet(EMPIRE_START_X(GetEmpire()), EMPIRE_START_Y(GetEmpire()));
+}
+
+void CHARACTER::SendGuildName(CGuild* pGuild)
+{
+	if (NULL == pGuild) return;
+
+	DESC* desc = GetDesc();
+
+	if (NULL == desc) return;
+	if (m_known_guild.find(pGuild->GetID()) != m_known_guild.end()) return;
+
+	m_known_guild.insert(pGuild->GetID());
+
+	TPacketGCGuildName pack;
+	memset(&pack, 0x00, sizeof(pack));
+
+	pack.header = HEADER_GC_GUILD;
+	pack.subheader = GUILD_SUBHEADER_GC_GUILD_NAME;
+	pack.size = sizeof(TPacketGCGuildName);
+	pack.guildID = pGuild->GetID();
+	memcpy(pack.guildName, pGuild->GetName(), GUILD_NAME_MAX_LEN);
+
+	desc->Packet(&pack, sizeof(pack));
+}
+
+void CHARACTER::SendGuildName(DWORD dwGuildID)
+{
+	SendGuildName(CGuildManager::instance().FindGuild(dwGuildID));
+}
 
-	const DWORD dwTime = GetLeftSeatLogoutTime();
-	if (dwTime == 0)
+EVENTFUNC(destroy_when_idle_event)
+{
+	char_event_info* info = dynamic_cast<char_event_info*>(event->info);
+	if (info == NULL)
+	{
+		sys_err("destroy_when_idle_event> <Factor> Null pointer");
+		return 0;
+	}
+
+	LPCHARACTER ch = info->ch;
+
+	if (ch == NULL) // <Factor>
+		return 0;
+
+	if (ch->GetVictim())
+		return PASSES_PER_SEC(300);
+
+	sys_log(1, "DESTROY_WHEN_IDLE: %s", ch->GetName());
+
+	ch->m_pkDestroyWhenIdleEvent = NULL;
+	M2_DESTROY_CHARACTER(ch);
+	return 0;
+}
+
+void CHARACTER::StartDestroyWhenIdleEvent()
+{
+	if (m_pkDestroyWhenIdleEvent)
 		return;
 
 	char_event_info* info = AllocEventInfo<char_event_info>();
+
 	info->ch = this;
-	m_pLeftSeatLogoutTimerEvent = event_create(left_seat_logout_timer_event, info, PASSES_PER_SEC(dwTime));
+
+	m_pkDestroyWhenIdleEvent = event_create(destroy_when_idle_event, info, PASSES_PER_SEC(300));
+}
+
+void CHARACTER::SetComboSequence(BYTE seq)
+{
+	m_bComboSequence = seq;
+}
+
+BYTE CHARACTER::GetComboSequence() const
+{
+	return m_bComboSequence;
+}
+
+void CHARACTER::SetLastComboTime(DWORD time)
+{
+	m_dwLastComboTime = time;
+}
+
+DWORD CHARACTER::GetLastComboTime() const
+{
+	return m_dwLastComboTime;
+}
+
+void CHARACTER::SetValidComboInterval(int interval)
+{
+	m_iValidComboInterval = interval;
 }
 
-void CHARACTER::SetLeftSeatLogoutTime(BYTE bIndex)
+int CHARACTER::GetValidComboInterval() const
 {
-	DWORD dwTime = 0;
-	switch (bIndex)
+	return m_iValidComboInterval;
+}
+
+BYTE CHARACTER::GetComboIndex() const
+{
+	return m_bComboIndex;
+}
+
+void CHARACTER::IncreaseComboHackCount(int k)
+{
+	m_iComboHackCount += k;
+
+	if (m_iComboHackCount >= 10)
 	{
-		case LEFT_SEAT_LOGOUT_TIME_30_MIN:
-			dwTime = 60 * 30;
-			break;
-		case LEFT_SEAT_LOGOUT_TIME_60_MIN:
-			dwTime = 60 * 60;
-			break;
-		case LEFT_SEAT_LOGOUT_TIME_120_MIN:
-			dwTime = 60 * 120;
+		if (GetDesc())
+			if (GetDesc()->DelayedDisconnect(number(2, 7)))
+			{
+				sys_log(0, "COMBO_HACK_DISCONNECT: %s count: %d", GetName(), m_iComboHackCount);
+				LogManager::instance().HackLog("Combo", this);
+			}
+	}
+}
+
+void CHARACTER::ResetComboHackCount()
+{
+	m_iComboHackCount = 0;
+}
+
+void CHARACTER::SkipComboAttackByTime(int interval)
+{
+	m_dwSkipComboAttackByTime = get_dword_time() + interval;
+}
+
+DWORD CHARACTER::GetSkipComboAttackByTime() const
+{
+	return m_dwSkipComboAttackByTime;
+}
+
+// ̳ ٸ Ÿ ֳ?
+bool CHARACTER::IsRiding() const
+{
+	return IsHorseRiding() || GetMountVnum();
+}
+
+bool CHARACTER::CanWarp() const
+{
+	const int iPulse = thecore_pulse();
+	const int limit_time = PASSES_PER_SEC(g_nPortalLimitTime);
+
+	if ((iPulse - GetSafeboxLoadTime()) < limit_time)
+		return false;
+
+	if ((iPulse - GetExchangeTime()) < limit_time)
+		return false;
+
+	if ((iPulse - GetMyShopTime()) < limit_time)
+		return false;
+
+	if ((iPulse - GetRefineTime()) < limit_time)
+		return false;
+
+#if defined(__MAILBOX__)
+	if ((iPulse - GetMyMailBoxTime()) < limit_time)
+		return false;
+#endif
+
+	if (PreventTradeWindow(WND_ALL))
+		return false;
+
+	return true;
+}
+
+DWORD CHARACTER::GetNextExp() const
+{
+	if (PLAYER_EXP_TABLE_MAX < GetLevel())
+		return 2500000000;
+	else
+		return exp_table[GetLevel()];
+}
+
+#if defined(__CONQUEROR_LEVEL__)
+DWORD CHARACTER::GetConquerorNextExp() const
+{
+	if (PLAYER_CONQUEROR_EXP_TABLE_MAX < GetConquerorLevel())
+		return 2500000000;
+	else
+		return conqueror_exp_table[GetConquerorLevel()];
+}
+#endif
+
+int CHARACTER::GetSkillPowerByLevel(int level, bool bMob) const
+{
+	return CTableBySkill::instance().GetSkillPowerByLevelFromType(GetJob(), GetSkillGroup(), MINMAX(0, level, SKILL_MAX_LEVEL), bMob);
+}
+
+#if defined(__ACCE_COSTUME_SYSTEM__)
+bool CHARACTER::IsOpenAcce()
+{
+	if (m_bAcceCombination || m_bAcceAbsorption)
+		return true;
+
+	return false;
+}
+
+void CHARACTER::OpenAcce(bool bCombination)
+{
+	if (isAcceOpened(bCombination))
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Drag the items into the window."));
+		return;
+	}
+
+	if (bCombination)
+	{
+		if (m_bAcceAbsorption)
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot use this item while the windows for absorption and combination are open."));
+			return;
+		}
+
+		m_bAcceCombination = true;
+	}
+	else
+	{
+		if (m_bAcceCombination)
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot use this item while the windows for absorption and combination are open."));
+			return;
+		}
+
+		m_bAcceAbsorption = true;
+	}
+
+	TItemPos tPos;
+	tPos.window_type = INVENTORY;
+	tPos.cell = 0;
+
+	TPacketAcce sPacket;
+	sPacket.header = HEADER_GC_ACCE;
+	sPacket.subheader = ACCE_SUBHEADER_GC_OPEN;
+	sPacket.bWindow = bCombination;
+	sPacket.dwPrice = 0;
+	sPacket.bPos = 0;
+	sPacket.tPos = tPos;
+	sPacket.dwItemVnum = 0;
+	sPacket.dwMinAbs = 0;
+	sPacket.dwMaxAbs = 0;
+	GetDesc()->Packet(&sPacket, sizeof(TPacketAcce));
+
+	ClearAcceMaterials();
+}
+
+void CHARACTER::CloseAcce()
+{
+	if ((!m_bAcceCombination) && (!m_bAcceAbsorption))
+		return;
+
+	bool bWindow = (m_bAcceCombination == true ? true : false);
+
+	TItemPos tPos;
+	tPos.window_type = INVENTORY;
+	tPos.cell = 0;
+
+	TPacketAcce sPacket;
+	sPacket.header = HEADER_GC_ACCE;
+	sPacket.subheader = ACCE_SUBHEADER_GC_CLOSE;
+	sPacket.bWindow = bWindow;
+	sPacket.dwPrice = 0;
+	sPacket.bPos = 0;
+	sPacket.tPos = tPos;
+	sPacket.dwItemVnum = 0;
+	sPacket.dwMinAbs = 0;
+	sPacket.dwMaxAbs = 0;
+	GetDesc()->Packet(&sPacket, sizeof(TPacketAcce));
+
+	if (bWindow)
+		m_bAcceCombination = false;
+	else
+		m_bAcceAbsorption = false;
+
+	ClearAcceMaterials();
+}
+
+void CHARACTER::ClearAcceMaterials()
+{
+	LPITEM* pkItemMaterial;
+	pkItemMaterial = GetAcceMaterials();
+	for (int i = 0; i < ACCE_WINDOW_MAX_MATERIALS; ++i)
+	{
+		if (!pkItemMaterial[i])
+			continue;
+
+		pkItemMaterial[i]->Lock(false);
+		pkItemMaterial[i] = NULL;
+	}
+}
+
+bool CHARACTER::AcceIsSameGrade(long lGrade)
+{
+	LPITEM* pkItemMaterial;
+	pkItemMaterial = GetAcceMaterials();
+	if (!pkItemMaterial[0])
+		return false;
+
+	bool bReturn = (pkItemMaterial[0]->GetValue(ACCE_GRADE_VALUE_FIELD) == lGrade ? true : false);
+	return bReturn;
+}
+
+DWORD CHARACTER::GetAcceCombinePrice(long lGrade)
+{
+	DWORD dwPrice = 0;
+	switch (lGrade)
+	{
+	case 2:
+		dwPrice = ACCE_GRADE_2_PRICE;
+		break;
+
+	case 3:
+		dwPrice = ACCE_GRADE_3_PRICE;
+		break;
+
+	case 4:
+		dwPrice = ACCE_GRADE_4_PRICE;
+		break;
+
+	default:
+		dwPrice = ACCE_GRADE_1_PRICE;
+		break;
+	}
+
+	return dwPrice;
+}
+
+BYTE CHARACTER::CheckEmptyMaterialSlot()
+{
+	LPITEM* pkItemMaterial;
+	pkItemMaterial = GetAcceMaterials();
+	for (int i = 0; i < ACCE_WINDOW_MAX_MATERIALS; ++i)
+	{
+		if (!pkItemMaterial[i])
+			return i;
+	}
+
+	return 255;
+}
+
+void CHARACTER::GetAcceCombineResult(DWORD& dwItemVnum, DWORD& dwMinAbs, DWORD& dwMaxAbs)
+{
+	LPITEM* pkItemMaterial;
+	pkItemMaterial = GetAcceMaterials();
+
+	if (m_bAcceCombination)
+	{
+		if ((pkItemMaterial[0]) && (pkItemMaterial[1]))
+		{
+			long lVal = pkItemMaterial[0]->GetValue(ACCE_GRADE_VALUE_FIELD);
+			if (lVal == 4)
+			{
+				dwItemVnum = pkItemMaterial[0]->GetOriginalVnum();
+				dwMinAbs = pkItemMaterial[0]->GetSocket(ACCE_ABSORPTION_SOCKET);
+				DWORD dwMaxAbsCalc = (dwMinAbs + ACCE_GRADE_4_ABS_RANGE > ACCE_GRADE_4_ABS_MAX ? ACCE_GRADE_4_ABS_MAX : (dwMinAbs + ACCE_GRADE_4_ABS_RANGE));
+				dwMaxAbs = dwMaxAbsCalc;
+			}
+			else
+			{
+				DWORD dwMaskVnum = pkItemMaterial[0]->GetOriginalVnum();
+				TItemTable* pTable = ITEM_MANAGER::instance().GetTable(dwMaskVnum + 1);
+				if (pTable)
+					dwMaskVnum += 1;
+
+				dwItemVnum = dwMaskVnum;
+				switch (lVal)
+				{
+				case 2:
+				{
+					dwMinAbs = ACCE_GRADE_3_ABS;
+					dwMaxAbs = ACCE_GRADE_3_ABS;
+				}
+				break;
+				case 3:
+				{
+					dwMinAbs = ACCE_GRADE_4_ABS_MIN;
+					dwMaxAbs = ACCE_GRADE_4_ABS_MAX_COMB;
+				}
+				break;
+				default:
+				{
+					dwMinAbs = ACCE_GRADE_2_ABS;
+					dwMaxAbs = ACCE_GRADE_2_ABS;
+				}
+				break;
+				}
+			}
+		}
+		else
+		{
+			dwItemVnum = 0;
+			dwMinAbs = 0;
+			dwMaxAbs = 0;
+		}
+	}
+	else
+	{
+		if ((pkItemMaterial[0]) && (pkItemMaterial[1]))
+		{
+			dwItemVnum = pkItemMaterial[0]->GetOriginalVnum();
+			dwMinAbs = pkItemMaterial[0]->GetSocket(ACCE_ABSORPTION_SOCKET);
+			dwMaxAbs = dwMinAbs;
+		}
+		else
+		{
+			dwItemVnum = 0;
+			dwMinAbs = 0;
+			dwMaxAbs = 0;
+		}
+	}
+}
+
+void CHARACTER::AddAcceMaterial(TItemPos tPos, BYTE bPos)
+{
+	if (bPos >= ACCE_WINDOW_MAX_MATERIALS)
+	{
+		if (bPos == 255)
+		{
+			bPos = CheckEmptyMaterialSlot();
+			if (bPos >= ACCE_WINDOW_MAX_MATERIALS)
+				return;
+		}
+		else
+			return;
+	}
+
+	LPITEM pkItem = GetItem(tPos);
+	if (!pkItem)
+		return;
+
+	if ((pkItem->GetCell() >= INVENTORY_MAX_NUM) || (pkItem->IsEquipped()) || (tPos.IsBeltInventoryPosition()) || (pkItem->IsDragonSoul()))
+		return;
+	else if ((pkItem->GetType() != ITEM_COSTUME) && (m_bAcceCombination))
+		return;
+	else if ((pkItem->GetType() != ITEM_COSTUME) && (bPos == 0) && (m_bAcceAbsorption))
+		return;
+
+	if (pkItem->isLocked())
+		return;
+
+#if defined(__SOUL_BIND_SYSTEM__)
+	if (pkItem->IsSealed())
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot use a soulbound item."));
+		return;
+	}
+#endif
+
+	if ((m_bAcceCombination) && (bPos == 1) && (!AcceIsSameGrade(pkItem->GetValue(ACCE_GRADE_VALUE_FIELD))))
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("These sashes cannot be combined."));
+		return;
+	}
+
+	if ((m_bAcceCombination) && (pkItem->GetSocket(ACCE_ABSORPTION_SOCKET) >= ACCE_GRADE_4_ABS_MAX))
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("The sash cannot take on any further bonuses."));
+		return;
+	}
+
+	if ((bPos == 1) && (m_bAcceAbsorption))
+	{
+		if ((pkItem->GetType() != ITEM_WEAPON) && (pkItem->GetType() != ITEM_ARMOR))
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You can only use Shoulder Sashes as well as weapons and armour pieces."));
+			return;
+		}
+		else if ((pkItem->GetType() == ITEM_ARMOR) && (pkItem->GetSubType() != ARMOR_BODY))
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You can only use Shoulder Sashes as well as weapons and armour pieces."));
+			return;
+		}
+	}
+	else if ((pkItem->GetSubType() != COSTUME_ACCE) && (m_bAcceCombination))
+		return;
+	else if ((pkItem->GetSubType() != COSTUME_ACCE) && (bPos == 0) && (m_bAcceAbsorption))
+		return;
+	else if ((pkItem->GetSocket(ACCE_ABSORBED_SOCKET) > 0) && (bPos == 0) && (m_bAcceAbsorption))
+		return;
+
+	LPITEM* pkItemMaterial;
+	pkItemMaterial = GetAcceMaterials();
+	if ((bPos == 1) && (!pkItemMaterial[0]))
+		return;
+
+	if (pkItemMaterial[bPos])
+		return;
+
+	pkItemMaterial[bPos] = pkItem;
+	pkItemMaterial[bPos]->Lock(true);
+
+	DWORD dwItemVnum, dwMinAbs, dwMaxAbs;
+	GetAcceCombineResult(dwItemVnum, dwMinAbs, dwMaxAbs);
+
+	TPacketAcce sPacket;
+	sPacket.header = HEADER_GC_ACCE;
+	sPacket.subheader = ACCE_SUBHEADER_GC_ADDED;
+	sPacket.bWindow = m_bAcceCombination == true ? true : false;
+	sPacket.dwPrice = GetAcceCombinePrice(pkItem->GetValue(ACCE_GRADE_VALUE_FIELD));
+	sPacket.bPos = bPos;
+	sPacket.tPos = tPos;
+	sPacket.dwItemVnum = dwItemVnum;
+	sPacket.dwMinAbs = dwMinAbs;
+	sPacket.dwMaxAbs = dwMaxAbs;
+	GetDesc()->Packet(&sPacket, sizeof(TPacketAcce));
+}
+
+void CHARACTER::RemoveAcceMaterial(BYTE bPos)
+{
+	if (bPos >= ACCE_WINDOW_MAX_MATERIALS)
+		return;
+
+	LPITEM* pkItemMaterial;
+	pkItemMaterial = GetAcceMaterials();
+
+	DWORD dwPrice = 0;
+
+	if (bPos == 1)
+	{
+		if (pkItemMaterial[bPos])
+		{
+			pkItemMaterial[bPos]->Lock(false);
+			pkItemMaterial[bPos] = NULL;
+		}
+
+		if (pkItemMaterial[0])
+			dwPrice = GetAcceCombinePrice(pkItemMaterial[0]->GetValue(ACCE_GRADE_VALUE_FIELD));
+	}
+	else
+		ClearAcceMaterials();
+
+	TItemPos tPos;
+	tPos.window_type = INVENTORY;
+	tPos.cell = 0;
+
+	TPacketAcce sPacket;
+	sPacket.header = HEADER_GC_ACCE;
+	sPacket.subheader = ACCE_SUBHEADER_GC_REMOVED;
+	sPacket.bWindow = m_bAcceCombination == true ? true : false;
+	sPacket.dwPrice = dwPrice;
+	sPacket.bPos = bPos;
+	sPacket.tPos = tPos;
+	sPacket.dwItemVnum = 0;
+	sPacket.dwMinAbs = 0;
+	sPacket.dwMaxAbs = 0;
+	GetDesc()->Packet(&sPacket, sizeof(TPacketAcce));
+}
+
+BYTE CHARACTER::CanRefineAcceMaterials()
+{
+	BYTE bReturn = 0;
+	LPITEM* pkItemMaterial;
+	pkItemMaterial = GetAcceMaterials();
+	if (m_bAcceCombination)
+	{
+		for (int i = 0; i < ACCE_WINDOW_MAX_MATERIALS; ++i)
+		{
+			if (pkItemMaterial[i])
+			{
+				if ((pkItemMaterial[i]->GetType() == ITEM_COSTUME) && (pkItemMaterial[i]->GetSubType() == COSTUME_ACCE))
+					bReturn = 1;
+				else
+				{
+					bReturn = 0;
+					break;
+				}
+			}
+			else
+			{
+				bReturn = 0;
+				break;
+			}
+		}
+	}
+	else if (m_bAcceAbsorption)
+	{
+		if ((pkItemMaterial[0]) && (pkItemMaterial[1]))
+		{
+			if ((pkItemMaterial[0]->GetType() == ITEM_COSTUME) && (pkItemMaterial[0]->GetSubType() == COSTUME_ACCE))
+				bReturn = 2;
+			else
+				bReturn = 0;
+
+			if ((pkItemMaterial[1]->GetType() == ITEM_WEAPON) || ((pkItemMaterial[1]->GetType() == ITEM_ARMOR) && (pkItemMaterial[1]->GetSubType() == ARMOR_BODY)))
+				bReturn = 2;
+			else
+				bReturn = 0;
+
+			if (pkItemMaterial[0]->GetSocket(ACCE_ABSORBED_SOCKET) > 0)
+				bReturn = 0;
+		}
+		else
+			bReturn = 0;
+	}
+
+	return bReturn;
+}
+
+void CHARACTER::RefineAcceMaterials()
+{
+	if (PreventTradeWindow(WND_ALL))
+	{
+		CloseAcce();
+		return;
+	}
+
+	BYTE bCan = CanRefineAcceMaterials();
+	if (bCan == 0)
+		return;
+
+	LPITEM* pkItemMaterial;
+	pkItemMaterial = GetAcceMaterials();
+
+	DWORD dwItemVnum, dwMinAbs, dwMaxAbs;
+	GetAcceCombineResult(dwItemVnum, dwMinAbs, dwMaxAbs);
+	unsigned long long llPrice = GetAcceCombinePrice(pkItemMaterial[0]->GetValue(ACCE_GRADE_VALUE_FIELD));
+
+	if (bCan == 1)
+	{
+		int iSuccessChance = 0;
+		long lVal = pkItemMaterial[0]->GetValue(ACCE_GRADE_VALUE_FIELD);
+		switch (lVal)
+		{
+		case 2:
+			iSuccessChance = ACCE_COMBINE_GRADE_2;
 			break;
-		case LEFT_SEAT_LOGOUT_TIME_180_MIN:
-			dwTime = 60 * 180;
+
+		case 3:
+			iSuccessChance = ACCE_COMBINE_GRADE_3;
 			break;
-		case LEFT_SEAT_LOGOUT_TIME_OFF:
-			dwTime = 0;
+
+		case 4:
+			iSuccessChance = ACCE_COMBINE_GRADE_4;
 			break;
+
 		default:
-			dwTime = 60 * 30;
+			iSuccessChance = ACCE_COMBINE_GRADE_1;
 			break;
+		}
+
+		if (GetGold() < llPrice)
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ϰų  ü  ȲԴϴ"));
+			return;
+		}
+
+		int iChance = number(1, 100);
+		bool bSucces = (iChance <= iSuccessChance ? true : false);
+
+		if (bSucces)
+		{
+			LPITEM pkItem = ITEM_MANAGER::instance().CreateItem(dwItemVnum, 1, 0, false);
+			if (!pkItem)
+			{
+				sys_err("%d can't be created.", dwItemVnum);
+				return;
+			}
+
+			ITEM_MANAGER::CopyAllAttrTo(pkItemMaterial[0], pkItem);
+			LogManager::instance().ItemLog(this, pkItem, "COMBINE SUCCESS", pkItem->GetName());
+			DWORD dwAbs = (dwMinAbs == dwMaxAbs ? dwMinAbs : number(dwMinAbs + 1, dwMaxAbs));
+
+			if (g_bAcceCombineIncAbsOnLastGrade)
+			{
+				if (lVal == 4)
+					dwAbs = pkItem->GetSocket(ACCE_ABSORPTION_SOCKET) + 1;
+			}
+
+			pkItem->SetSocket(ACCE_ABSORPTION_SOCKET, dwAbs);
+			pkItem->SetSocket(ACCE_ABSORBED_SOCKET, pkItemMaterial[0]->GetSocket(ACCE_ABSORBED_SOCKET));
+
+			PointChange(POINT_GOLD, -llPrice);
+			DBManager::instance().SendMoneyLog(MONEY_LOG_REFINE, pkItemMaterial[0]->GetVnum(), -llPrice);
+
+			WORD wCell = pkItemMaterial[0]->GetCell();
+			ITEM_MANAGER::instance().RemoveItem(pkItemMaterial[0], "COMBINE (REFINE SUCCESS)");
+			ITEM_MANAGER::instance().RemoveItem(pkItemMaterial[1], "COMBINE (REFINE SUCCESS)");
+
+			pkItem->AddToCharacter(this, TItemPos(INVENTORY, wCell));
+			ITEM_MANAGER::instance().FlushDelayedSave(pkItem);
+			pkItem->AttrLog();
+
+			if (lVal == 4)
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("New absorption rate: %d"), dwAbs);
+			else
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Success!"));
+
+			EffectPacket(SE_ACCE_SUCESS_ABSORB);
+			LogManager::instance().AcceLog(GetPlayerID(), GetX(), GetY(), dwItemVnum, pkItem->GetID(), 1, dwAbs, 1);
+
+			ClearAcceMaterials();
+		}
+		else
+		{
+			PointChange(POINT_GOLD, -llPrice);
+			DBManager::instance().SendMoneyLog(MONEY_LOG_REFINE, pkItemMaterial[0]->GetVnum(), -llPrice);
+
+			ITEM_MANAGER::instance().RemoveItem(pkItemMaterial[1], "COMBINE (REFINE FAIL)");
+
+			if (lVal == 4)
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("New absorption rate: %d"), pkItemMaterial[0]->GetSocket(ACCE_ABSORPTION_SOCKET));
+			else
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Failed!"));
+
+			LogManager::instance().AcceLog(GetPlayerID(), GetX(), GetY(), dwItemVnum, 0, 0, 0, 0);
+
+			pkItemMaterial[1] = NULL;
+		}
+
+		TItemPos tPos;
+		tPos.window_type = INVENTORY;
+		tPos.cell = 0;
+
+		TPacketAcce sPacket;
+		sPacket.header = HEADER_GC_ACCE;
+		sPacket.subheader = ACCE_SUBHEADER_CG_REFINED;
+		sPacket.bWindow = m_bAcceCombination == true ? true : false;
+		sPacket.dwPrice = llPrice;
+		sPacket.bPos = 0;
+		sPacket.tPos = tPos;
+		sPacket.dwItemVnum = 0;
+		sPacket.dwMinAbs = 0;
+		if (bSucces)
+			sPacket.dwMaxAbs = 100;
+		else
+			sPacket.dwMaxAbs = 0;
+
+		GetDesc()->Packet(&sPacket, sizeof(TPacketAcce));
+	}
+	else
+	{
+		pkItemMaterial[1]->CopyAttributeTo(pkItemMaterial[0]);
+		LogManager::instance().ItemLog(this, pkItemMaterial[0], "ABSORB (REFINE SUCCESS)", pkItemMaterial[0]->GetName());
+		pkItemMaterial[0]->SetSocket(ACCE_ABSORBED_SOCKET, pkItemMaterial[1]->GetOriginalVnum());
+		for (int i = 0; i < ITEM_ATTRIBUTE_MAX_NUM; ++i)
+		{
+			if (pkItemMaterial[0]->GetAttributeValue(i) < 0)
+				pkItemMaterial[0]->SetForceAttribute(i, pkItemMaterial[0]->GetAttributeType(i), 0);
+		}
+
+		ITEM_MANAGER::instance().RemoveItem(pkItemMaterial[1], "ABSORBED (REFINE SUCCESS)");
+
+		ITEM_MANAGER::instance().FlushDelayedSave(pkItemMaterial[0]);
+		pkItemMaterial[0]->AttrLog();
+
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Success!"));
+
+		ClearAcceMaterials();
+
+		TItemPos tPos;
+		tPos.window_type = INVENTORY;
+		tPos.cell = 0;
+
+		TPacketAcce sPacket;
+		sPacket.header = HEADER_GC_ACCE;
+		sPacket.subheader = ACCE_SUBHEADER_CG_REFINED;
+		sPacket.bWindow = m_bAcceCombination == true ? true : false;
+		sPacket.dwPrice = llPrice;
+		sPacket.bPos = 255;
+		sPacket.tPos = tPos;
+		sPacket.dwItemVnum = 0;
+		sPacket.dwMinAbs = 0;
+		sPacket.dwMaxAbs = 1;
+		GetDesc()->Packet(&sPacket, sizeof(TPacketAcce));
+	}
+}
+
+bool CHARACTER::CleanAcceAttr(LPITEM pkItem, LPITEM pkTarget)
+{
+	if (!CanHandleItem())
+		return false;
+
+	if ((!pkItem) || (!pkTarget))
+		return false;
+
+	if (!pkTarget->IsCostumeAcce())
+		return false;
+
+#if defined(__SOUL_BIND_SYSTEM__)
+	if ((pkTarget->IsSealed()))
+		return false;
+#endif
+
+	if (pkTarget->isLocked())
+		return false;
+
+	if (pkTarget->GetSocket(ACCE_ABSORBED_SOCKET) <= 0)
+		return false;
+
+	pkTarget->SetSocket(ACCE_ABSORBED_SOCKET, 0);
+	for (int i = 0; i < ITEM_ATTRIBUTE_MAX_NUM; ++i)
+		pkTarget->SetForceAttribute(i, 0, 0);
+
+	pkItem->SetCount(pkItem->GetCount() - 1);
+	LogManager::instance().ItemLog(this, pkTarget, "USE_ITEM (ACCE REVERSE ATTR)", pkTarget->GetName());
+	return true;
+}
+#endif
+
+#if defined(__SORT_INVENTORY_ITEMS__)
+static bool SortItems(const LPITEM& s1, const LPITEM& s2)
+{
+	std::string name(s1->GetLocaleName());
+	std::string name2(s2->GetLocaleName());
+
+	return name < name2;
+}
+
+void CHARACTER::SortInventoryItems()
+{
+	if (IsDead() || PreventTradeWindow(WND_ALL))
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Please close other windows before sorting your inventory."));
+		return;
+	}
+
+	if (GetSortInventoryPulse() > get_global_time())
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Please wait %d seconds to sort your inventory again."), GetSortInventoryPulse() - get_global_time());
+		return;
+	}
+
+	//< 2020.08.08.Owsap - Prevent sorting items while running quest.
+	if (quest::CQuestManager::instance().GetPCForce(GetPlayerID())->IsRunning() == true)
+		return;
+
+	if (m_pkTimedEvent)
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" Ǿϴ."));
+		event_cancel(&m_pkTimedEvent);
+		// Cancel timer event and continue with sorting...
+	}
+	//>
+
+	std::vector<LPITEM> vec_pkItems;
+	LPITEM pkItem;
+	const auto size = static_cast<WORD>(INVENTORY_MAX_NUM);
+
+	for (WORD i = 0; i < size; ++i)
+	{
+		if (pkItem = GetInventoryItem(i))
+		{
+			vec_pkItems.emplace_back(pkItem);
+			pkItem->RemoveFromCharacter();
+			SyncQuickslot(QUICKSLOT_TYPE_ITEM, static_cast<BYTE>(i), WORD_MAX);
+		}
+	}
+
+	std::sort(vec_pkItems.begin(), vec_pkItems.end(), SortItems);
+
+	for (const auto& item : vec_pkItems)
+	{
+		const auto itemTable = ITEM_MANAGER::instance().GetTable(item->GetVnum());
+		if (!itemTable)
+			continue;
+
+		static const std::initializer_list<DWORD> excepList = {
+			ITEM_AUTO_HP_RECOVERY_S,
+			ITEM_AUTO_HP_RECOVERY_M,
+			ITEM_AUTO_HP_RECOVERY_L,
+			ITEM_AUTO_HP_RECOVERY_X,
+			ITEM_AUTO_SP_RECOVERY_S,
+			ITEM_AUTO_SP_RECOVERY_M,
+			ITEM_AUTO_SP_RECOVERY_L,
+			ITEM_AUTO_SP_RECOVERY_X,
+			REWARD_BOX_ITEM_AUTO_HP_RECOVERY_S,
+			REWARD_BOX_ITEM_AUTO_SP_RECOVERY_XS,
+			REWARD_BOX_ITEM_AUTO_SP_RECOVERY_S,
+			REWARD_BOX_ITEM_AUTO_HP_RECOVERY_S,
+			REWARD_BOX_ITEM_AUTO_HP_RECOVERY_XS,
+			FUCKING_BRAZIL_ITEM_AUTO_SP_RECOVERY_S,
+			FUCKING_BRAZIL_ITEM_AUTO_HP_RECOVERY_S
+		};
+
+		if (itemTable->dwFlags & ITEM_FLAG_STACKABLE && itemTable->bType != ITEM_BLEND &&
+			(std::find(excepList.begin(), excepList.end(), item->GetVnum()) == excepList.end() && IS_SUMMON_ITEM(item->GetVnum()) == false))
+		{
+#if defined(__WJ_PICKUP_ITEM_EFFECT__)
+			AutoGiveItem(item->GetVnum(), item->GetCount(), -1, false, false);
+#else
+			AutoGiveItem(item->GetVnum(), item->GetCount(), -1, false);
+#endif
+			M2_DESTROY_ITEM(item);
+		}
+		else
+#if defined(__WJ_PICKUP_ITEM_EFFECT__)
+			AutoGiveItem(item, false, false);
+#else
+			AutoGiveItem(item, false);
+#endif
+	};
+
+	SetSortInventoryPulse(get_global_time() + 15);
+	ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Your inventory items have been sorted."));
+}
+
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+void CHARACTER::SortSpecialInventoryItems(BYTE type)
+{
+	if (IsDead() || PreventTradeWindow(WND_ALL))
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Please close other windows before sorting your inventory."));
+		return;
+	}
+
+	if (GetSortSpecialInventoryPulse() > get_global_time())
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Please wait %d seconds to sort your inventory again."), GetSortSpecialInventoryPulse() - get_global_time());
+		return;
+	}
+
+	//< 2020.08.08.Owsap - Prevent sorting items while running quest and m_pkTimedEvent
+	if (quest::CQuestManager::instance().GetPCForce(GetPlayerID())->IsRunning() == true)
+		return;
+
+	if (m_pkTimedEvent)
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" Ǿϴ."));
+		event_cancel(&m_pkTimedEvent);
+		// Cancel timer event and continue with sorting...
+	}
+	//>
+
+	std::vector<LPITEM> vec_pkItems;
+	LPITEM pkItem;
+	const auto size = static_cast<WORD>(INVENTORY_MAX_NUM);
+
+	switch (type)
+	{
+	case 0:
+		for (WORD i = SKILL_BOOK_INVENTORY_SLOT_START; i < SKILL_BOOK_INVENTORY_SLOT_END; ++i)
+		{
+			if (pkItem = GetSkillBookInventoryItem(i))
+			{
+				vec_pkItems.emplace_back(pkItem);
+				pkItem->RemoveFromCharacter();
+			}
+		}
+		break;
+
+	case 1:
+		for (WORD i = UPGRADE_ITEMS_INVENTORY_SLOT_START; i < UPGRADE_ITEMS_INVENTORY_SLOT_END; ++i)
+		{
+			if (pkItem = GetUpgradeItemsInventoryItem(i))
+			{
+				vec_pkItems.emplace_back(pkItem);
+				pkItem->RemoveFromCharacter();
+			}
+		}
+		break;
+
+	case 2:
+		for (WORD i = STONE_INVENTORY_SLOT_START; i < STONE_INVENTORY_SLOT_END; ++i)
+		{
+			if (pkItem = GetStoneInventoryItem(i))
+			{
+				vec_pkItems.emplace_back(pkItem);
+				pkItem->RemoveFromCharacter();
+			}
+		}
+		break;
+
+	case 3:
+		for (WORD i = GIFT_BOX_INVENTORY_SLOT_START; i < GIFT_BOX_INVENTORY_SLOT_END; ++i)
+		{
+			if (pkItem = GetGiftBoxInventoryItem(i))
+			{
+				vec_pkItems.emplace_back(pkItem);
+				pkItem->RemoveFromCharacter();
+			}
+		}
+		break;
+
+	default:
+		for (WORD i = SKILL_BOOK_INVENTORY_SLOT_START; i < SKILL_BOOK_INVENTORY_SLOT_END; ++i)
+		{
+			if (pkItem = GetSkillBookInventoryItem(i))
+			{
+				vec_pkItems.emplace_back(pkItem);
+				pkItem->RemoveFromCharacter();
+			}
+		}
+		break;
+	}
+
+	std::sort(vec_pkItems.begin(), vec_pkItems.end(), SortItems);
+
+	for (const auto& item : vec_pkItems)
+	{
+		const auto itemTable = ITEM_MANAGER::instance().GetTable(item->GetVnum());
+		if (!itemTable)
+			continue;
+
+		if (itemTable->dwFlags & ITEM_FLAG_STACKABLE && itemTable->bType != ITEM_BLEND)
+		{
+#if defined(__WJ_PICKUP_ITEM_EFFECT__)
+			//< 2020.08.08.Owsap - Fix book stacking while sorting.
+			if (item->GetType() == ITEM_SKILLBOOK || item->GetType() == ITEM_SKILLFORGET)
+			{
+				GiveSkillBook(item->GetSocket(0), item->GetCount());
+			}
+			//>
+			else
+				AutoGiveItem(item->GetVnum(), item->GetCount(), -1, false, false);
+#else
+			AutoGiveItem(item->GetVnum(), item->GetCount(), -1, false);
+#endif
+			M2_DESTROY_ITEM(item);
+		}
+		else
+#if defined(__WJ_PICKUP_ITEM_EFFECT__)
+			AutoGiveItem(item, false, false);
+#else
+			AutoGiveItem(item, false);
+#endif
+	};
+
+	SetSortSpecialInventoryPulse(get_global_time() + 15);
+	ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Your special inventory items have been sorted."));
+}
+#endif
+#endif
+
+#if defined(__CHANGE_LOOK_SYSTEM__)
+void CHARACTER::ChangeLookWindow(bool bOpen, bool bRequest)
+{
+	if ((bOpen) && (isChangeLookOpened()))
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("[Transmutation] The window is already opened."));
+		return;
+	}
+
+	if ((!bOpen) && (!isChangeLookOpened()))
+	{
+		if (!bRequest)
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("[Transmutation] The window is not opened."));
+
+		return;
+	}
+
+	TItemPos tPos;
+	tPos.window_type = INVENTORY;
+	tPos.cell = 0;
+
+	TPacketChangeLook sPacket;
+	sPacket.bHeader = HEADER_GC_CHANGE_LOOK;
+	sPacket.bSubHeader = bOpen ? SUBHEADER_CHANGE_LOOK_OPEN : SUBHEADER_CHANGE_LOOK_CLOSE;
+	sPacket.dwCost = bOpen ? CHANGE_LOOK_TRANSMUTATION_PRICE : 0;
+	sPacket.bPos = 0;
+	sPacket.tPos = tPos;
+	GetDesc()->Packet(&sPacket, sizeof(TPacketChangeLook));
+
+	m_bChangeLook = bOpen;
+	ClearChangeLookWindowMaterials();
+}
+
+void CHARACTER::ClearChangeLookWindowMaterials()
+{
+	LPITEM* pkItemMaterial;
+	pkItemMaterial = GetChangeLookWindowMaterials();
+
+	for (int i = 0; i < CHANGE_LOOK_WINDOW_MAX_MATERIALS; ++i)
+	{
+		if (!pkItemMaterial[i])
+			continue;
+
+		pkItemMaterial[i]->Lock(false);
+		pkItemMaterial[i] = NULL;
+	}
+}
+
+BYTE CHARACTER::CheckChangeLookEmptyMaterialSlot()
+{
+	LPITEM* pkItemMaterial;
+	pkItemMaterial = GetChangeLookWindowMaterials();
+
+	for (int i = 0; i < CHANGE_LOOK_WINDOW_MAX_MATERIALS; ++i)
+	{
+		if (!pkItemMaterial[i])
+			return i;
+	}
+
+	return 255;
+}
+
+void CHARACTER::AddChangeLookMaterial(TItemPos tPos, BYTE bPos)
+{
+	if (!isChangeLookOpened())
+		return;
+
+	if (bPos >= CHANGE_LOOK_WINDOW_MAX_MATERIALS)
+	{
+		if (bPos != 255)
+			return;
+
+		LPITEM pkScroll = GetItem(tPos);
+		if (!pkScroll)
+			return;
+
+		if (CItemVnumHelper::IsTransmutationTicket(pkScroll->GetVnum()))
+			bPos = 2;
+		else
+			bPos = CheckChangeLookEmptyMaterialSlot();
+
+		if (bPos >= CHANGE_LOOK_WINDOW_MAX_MATERIALS)
+			return;
+	}
+
+	LPITEM pkItem = GetItem(tPos);
+	if (!pkItem)
+		return;
+
+	if ((pkItem->GetCell() >= INVENTORY_MAX_NUM) || (tPos.IsBeltInventoryPosition()))
+		return;
+
+	if (pkItem->IsEquipped())
+		return;
+
+	if ((bPos == 2 && !CItemVnumHelper::IsTransmutationTicket(pkItem->GetVnum())) || bPos != 2 && CItemVnumHelper::IsTransmutationTicket(pkItem->GetVnum()))
+		return;
+
+	if (!CItemVnumHelper::IsTransmutationTicket(pkItem->GetVnum()))
+	{
+		if (!pkItem->IsWeapon() && !pkItem->IsArmor() && !pkItem->IsCostume())
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("This item cannot be transmuted."));
+			return;
+		}
+		else if (pkItem->IsWeapon() && !pkItem->IsMainWeapon())
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("This item cannot be transmuted."));
+			return;
+		}
+		else if (pkItem->IsArmor() && !pkItem->IsArmorBody())
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("This item cannot be transmuted."));
+			return;
+		}
+		else if (pkItem->IsCostume() && (!pkItem->IsCostumeBody()
+#if defined(__MOUNT_CHANGE_LOOK__)
+			&& !pkItem->IsCostumeMount()
+#endif
+			))
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("This item cannot be transmuted."));
+			return;
+		}
+
+		if (pkItem->isLocked())
+			return;
+
+#if defined(__SOUL_BIND_SYSTEM__)
+		if ((pkItem->IsSealed()))
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot use a soulbound item. 4"));
+			return;
+		}
+#endif
+
+		if (pkItem->GetTransmutation() != 0)
+			return;
+	}
+
+	LPITEM* pkItemMaterial;
+	pkItemMaterial = GetChangeLookWindowMaterials();
+	if ((bPos == 1) && (!pkItemMaterial[0]))
+		return;
+
+	if (pkItemMaterial[bPos])
+		return;
+
+	if ((bPos == 2 && (!pkItemMaterial[0] && !pkItemMaterial[1])))
+		return;
+
+	if (bPos == 1)
+	{
+		bool bStop = false;
+		if ((pkItem->GetType() != pkItemMaterial[0]->GetType()))
+		{
+			if (pkItem->IsCostumeBody() && pkItemMaterial[0]->IsArmorBody())
+				bStop = false;
+			else if (pkItem->IsCostumeWeapon() && pkItemMaterial[0]->IsMainWeapon())
+				bStop = false;
+			else if (pkItem->IsArmorBody() && pkItemMaterial[0]->IsCostumeBody())
+				bStop = false;
+			else if (pkItem->IsMainWeapon() && pkItemMaterial[0]->IsCostumeWeapon())
+				bStop = false;
+			else
+				bStop = true;
+		}
+		else
+		{
+			if (pkItemMaterial[0]->GetType() != pkItem->GetType())
+				bStop = true;
+			else if (pkItemMaterial[0]->GetSubType() != pkItem->GetSubType())
+				bStop = true;
+		}
+
+		if (pkItemMaterial[0]->GetOriginalVnum() == pkItem->GetOriginalVnum())
+			bStop = true;
+		else if (((IS_SET(pkItemMaterial[0]->GetAntiFlag(), ITEM_ANTIFLAG_FEMALE)) && (!IS_SET(pkItem->GetAntiFlag(), ITEM_ANTIFLAG_FEMALE)))
+			|| ((IS_SET(pkItemMaterial[0]->GetAntiFlag(), ITEM_ANTIFLAG_MALE)) && (!IS_SET(pkItem->GetAntiFlag(), ITEM_ANTIFLAG_MALE))))
+			bStop = true;
+		else if ((pkItem->GetAntiFlag() & ITEM_ANTIFLAG_WARRIOR) && (!IS_SET(pkItemMaterial[0]->GetAntiFlag(), ITEM_ANTIFLAG_WARRIOR)))
+			bStop = true;
+		else if ((pkItem->GetAntiFlag() & ITEM_ANTIFLAG_ASSASSIN) && (!IS_SET(pkItemMaterial[0]->GetAntiFlag(), ITEM_ANTIFLAG_ASSASSIN)))
+			bStop = true;
+		else if ((pkItem->GetAntiFlag() & ITEM_ANTIFLAG_SHAMAN) && (!IS_SET(pkItemMaterial[0]->GetAntiFlag(), ITEM_ANTIFLAG_SHAMAN)))
+			bStop = true;
+		else if ((pkItem->GetAntiFlag() & ITEM_ANTIFLAG_SURA) && (!IS_SET(pkItemMaterial[0]->GetAntiFlag(), ITEM_ANTIFLAG_SURA)))
+			bStop = true;
+		else if ((pkItem->GetAntiFlag() & ITEM_ANTIFLAG_WOLFMAN) && (!IS_SET(pkItemMaterial[0]->GetAntiFlag(), ITEM_ANTIFLAG_WOLFMAN)))
+			bStop = true;
+		else if (IS_SET(pkItemMaterial[0]->GetAntiFlag(), ITEM_ANTIFLAG_CHANGELOOK) || IS_SET(pkItem->GetAntiFlag(), ITEM_ANTIFLAG_CHANGELOOK))
+			bStop = true;
+		else if ((pkItem->IsCostume() && pkItemMaterial[0]->IsCostume()) && ((pkItem->IsCostumeWeapon()) && (pkItemMaterial[0]->IsCostumeWeapon())))
+			if (pkItem->GetValue(3) != pkItemMaterial[0]->GetValue(3))
+				bStop = true;
+
+		if (bStop)
+			return;
+	}
+
+	pkItemMaterial[bPos] = pkItem;
+	pkItemMaterial[bPos]->Lock(true);
+
+	TPacketChangeLook sPacket;
+	sPacket.bHeader = HEADER_GC_CHANGE_LOOK;
+	sPacket.bSubHeader = SUBHEADER_CHANGE_LOOK_ADD;
+	sPacket.dwCost = 0;
+	sPacket.bPos = bPos;
+	sPacket.tPos = tPos;
+	GetDesc()->Packet(&sPacket, sizeof(TPacketChangeLook));
+}
+
+void CHARACTER::RemoveChangeLookMaterial(BYTE bPos)
+{
+	if (bPos >= CHANGE_LOOK_WINDOW_MAX_MATERIALS)
+		return;
+
+	LPITEM* pkItemMaterial;
+	pkItemMaterial = GetChangeLookWindowMaterials();
+
+	if (!pkItemMaterial[bPos])
+		return;
+
+	if (bPos == 1 || bPos == 2)
+	{
+		pkItemMaterial[bPos]->Lock(false);
+		pkItemMaterial[bPos] = NULL;
 	}
+	else
+		ClearChangeLookWindowMaterials();
+
+	TItemPos tPos;
+	tPos.window_type = INVENTORY;
+	tPos.cell = 0;
+
+	TPacketChangeLook sPacket;
+	sPacket.bHeader = HEADER_GC_CHANGE_LOOK;
+	sPacket.bSubHeader = SUBHEADER_CHANGE_LOOK_REMOVE;
+	sPacket.dwCost = 0;
+	sPacket.bPos = bPos;
+	sPacket.tPos = tPos;
+	GetDesc()->Packet(&sPacket, sizeof(TPacketChangeLook));
+}
+
+void CHARACTER::RefineChangeLookMaterials()
+{
+	LPITEM* pkItemMaterial;
+	pkItemMaterial = GetChangeLookWindowMaterials();
+
+	if (!pkItemMaterial[0])
+		return;
+
+	if (!pkItemMaterial[1])
+		return;
+
+	unsigned long long llPrice = CHANGE_LOOK_TRANSMUTATION_PRICE;
+	bool isNeedGold = true;
+
+	if (pkItemMaterial[2] && CItemVnumHelper::IsTransmutationTicket(pkItemMaterial[2]->GetVnum()))
+		isNeedGold = false;
+
+	if (isNeedGold == true)
+	{
+		if (GetGold() < llPrice)
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ϰų  ü  ȲԴϴ"));
+			return;
+		}
+	}
+
+	DWORD dwVnum = pkItemMaterial[1]->GetVnum();
+	if (isNeedGold == false)
+		ITEM_MANAGER::instance().RemoveItem(pkItemMaterial[2], "SPECIFY ITEM TRANSMUTED");
+	else
+		PointChange(POINT_GOLD, -llPrice);
+
+	DBManager::instance().SendMoneyLog(MONEY_LOG_REFINE, pkItemMaterial[0]->GetVnum(), -llPrice);
+	ITEM_MANAGER::instance().RemoveItem(pkItemMaterial[1], "TRANSMUTED (SUCCESSFULLY)");
+
+	pkItemMaterial[0]->SetTransmutation(dwVnum, true);
+	ClearChangeLookWindowMaterials();
+
+	TItemPos tPos;
+	tPos.window_type = INVENTORY;
+	tPos.cell = 0;
+
+	TPacketChangeLook sPacket;
+	sPacket.bHeader = HEADER_GC_CHANGE_LOOK;
+	sPacket.bSubHeader = SUBHEADER_CHANGE_LOOK_REFINE;
+	sPacket.dwCost = 0;
+	sPacket.bPos = 0;
+	sPacket.tPos = tPos;
+	GetDesc()->Packet(&sPacket, sizeof(TPacketChangeLook));
+}
+
+bool CHARACTER::CleanTransmutation(LPITEM pkItem, LPITEM pkTarget)
+{
+	if (!CanHandleItem())
+		return false;
 
-	//if (test_server)
-	//	dwTime = 10;
+	if ((!pkItem) || (!pkTarget))
+		return false;
 
-	m_dwLeftSeatLogoutTime = dwTime;
+	if ((pkTarget->GetType() != ITEM_WEAPON) &&
+		(pkTarget->GetType() != ITEM_ARMOR) &&
+		(pkTarget->GetType() != ITEM_COSTUME)
+		)
+		return false;
+
+#if defined(__SOUL_BIND_SYSTEM__)
+	if ((pkTarget->IsSealed()))
+		return false;
+#endif
+
+	if (pkTarget->isLocked())
+		return false;
+
+	if (pkTarget->GetTransmutation() == 0)
+		return false;
+
+	pkTarget->SetTransmutation(0);
+	pkItem->SetCount(pkItem->GetCount() - 1);
+	LogManager::instance().ItemLog(this, pkTarget, "USE_ITEM (REVERSE TRANSMUTATION)", pkTarget->GetName());
+	return true;
 }
 
-void CHARACTER::DisableLeftSeatLogOutState(bool bClosePopup)
+void CHARACTER::ClearChangeLookWindow()
 {
-	if (bClosePopup)
-		ChatPacket(CHAT_TYPE_COMMAND, "CloseLeftSeatDialog");
+	if (!isChangeLookOpened())
+		return;
 
-	if (m_pLeftSeatLogoutTimerEvent)
-		event_cancel(&m_pLeftSeatLogoutTimerEvent);
+	RemoveChangeLookMaterial(0);
+	RemoveChangeLookMaterial(1);
+}
+#endif
 
-	m_dwLastRequestTime = get_dword_time();
+#if defined(__HIDE_COSTUME_SYSTEM__)
+void CHARACTER::SetBodyCostumeHidden(bool hidden)
+{
+	m_bHideBodyCostume = hidden;
+	ChatPacket(CHAT_TYPE_COMMAND, "SetBodyCostumeHidden %d", m_bHideBodyCostume ? 1 : 0);
+	SetQuestFlag("costume_option.hide_body", m_bHideBodyCostume ? 1 : 0);
+}
 
-	SetLeftSeat(false);
-	RestartLeftSeatWaitTimer();
+void CHARACTER::SetHairCostumeHidden(bool hidden)
+{
+	m_bHideHairCostume = hidden;
+	ChatPacket(CHAT_TYPE_COMMAND, "SetHairCostumeHidden %d", m_bHideHairCostume ? 1 : 0);
+	SetQuestFlag("costume_option.hide_hair", m_bHideHairCostume ? 1 : 0);
 }
 
-void CHARACTER::SetLeftSeat(bool bLeftSeat)
+#if defined(__ACCE_COSTUME_SYSTEM__)
+void CHARACTER::SetAcceCostumeHidden(bool hidden)
 {
-	if (bLeftSeat)
-		ChatPacket(CHAT_TYPE_COMMAND, "OpenLeftSeatDialog");
+	m_bHideAcceCostume = hidden;
+	ChatPacket(CHAT_TYPE_COMMAND, "SetAcceCostumeHidden %d", m_bHideAcceCostume ? 1 : 0);
+	SetQuestFlag("costume_option.hide_acce", m_bHideAcceCostume ? 1 : 0);
+}
+#endif
 
-	m_bLeftSeat = bLeftSeat;
+#if defined(__WEAPON_COSTUME_SYSTEM__)
+void CHARACTER::SetWeaponCostumeHidden(bool hidden)
+{
+	m_bHideWeaponCostume = hidden;
+	ChatPacket(CHAT_TYPE_COMMAND, "SetWeaponCostumeHidden %d", m_bHideWeaponCostume ? 1 : 0);
+	SetQuestFlag("costume_option.hide_weapon", m_bHideWeaponCostume ? 1 : 0);
+}
+#endif
+#endif
+
+#if defined(__ANTI_EXP_RING__)
+bool CHARACTER::HasFrozenEXP()
+{
+	if (g_bAntiExpRing)
+	{
+		int iAntiExp = GetQuestFlag("anti_exp.freeze");
+		if (iAntiExp != 0)
+			return true;
+		else
+			return false;
+	}
+	else
+		return false;
+}
+
+void CHARACTER::FreezeEXP()
+{
+	return SetQuestFlag("anti_exp.freeze", 1);
+}
+
+void CHARACTER::UnfreezeEXP()
+{
+	return SetQuestFlag("anti_exp.freeze", 0);
+}
+#endif
+
+bool CHARACTER::IsInSafezone() const
+{
+	LPSECTREE sectree = GetSectree();
+	return (sectree && sectree->IsAttr(GetX(), GetY(), ATTR_BANPK));
+}
+
+bool CHARACTER::IsInBlockedArea(long x, long y) const
+{
+	LPSECTREE sectree = GetSectree();
+	return (sectree && sectree->IsAttr(x > 0 ? x : GetX(), x > 0 ? y : GetY(), ATTR_BLOCK | ATTR_OBJECT));
+}
+
+#if defined(__MOVE_CHANNEL__)
+EVENTINFO(move_channel_info)
+{
+	DynamicCharacterPtr ch;
+	int iSec;
+	long lNewAddr;
+	WORD wNewPort;
+
+	move_channel_info()
+		: iSec(0),
+		ch(),
+		lNewAddr(0),
+		wNewPort(0)
+	{
+	}
+};
+
+EVENTFUNC(move_channel)
+{
+	move_channel_info* info = dynamic_cast<move_channel_info*>(event->info);
+
+	if (!info) // no info
+		return 0;
+
+	LPCHARACTER ch = info->ch;
+
+	if (!ch) // no char
+		return 0;
+
+	if (!ch->GetDesc()) // no desc
+		return 0;
+
+	if (info->iSec > 0)
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Moving channel in %d seconds."), info->iSec);
+		--info->iSec;
+		return PASSES_PER_SEC(1);
+	}
+
+	ch->MoveChannel(info->lNewAddr, info->wNewPort);
+	ch->m_pkTimedEvent = NULL;
+
+	return 0;
+}
+
+bool CHARACTER::MoveChannel(long lNewAddr, WORD wNewPort)
+{
+	if (!IsPC())
+		return false;
+
+	if (!CanWarp())
+		return false;
+
+	if (!GetDesc())
+		return false;
+
+	long x = GetX();
+	long y = GetY();
+
+	long lAddr = lNewAddr;
+	long lMapIndex = GetMapIndex();
+	WORD wPort = wNewPort;
+
+	if (lMapIndex >= 10000)
+	{
+		sys_err("Invalid change channel request from dungeon %d!", lMapIndex);
+		return false;
+	}
+
+	if (g_bChannel == 99)
+	{
+		sys_err("%s attempted to change channel from CH99, ignoring request.", GetName());
+		return false;
+	}
+
+	Stop();
+	Save();
+
+	if (GetSectree())
+	{
+		GetSectree()->RemoveEntity(this);
+		ViewCleanup();
+
+		EncodeRemovePacket(this);
+	}
+
+	m_lWarpMapIndex = lMapIndex;
+	m_posWarp.x = x;
+	m_posWarp.y = y;
+
+	sys_log(0, "ChangeChannel %s, %ld %ld map %ld to port %d", GetName(), x, y, GetMapIndex(), wPort);
+
+	TPacketGCWarp p;
+
+	p.bHeader = HEADER_GC_WARP;
+	p.lX = x;
+	p.lY = y;
+	p.lAddr = lAddr;
+	p.wPort = wPort;
+
+	GetDesc()->Packet(&p, sizeof(p));
+
+	char buf[256];
+	snprintf(buf, sizeof(buf), "%s Port%d Map%ld x%ld y%ld", GetName(), wPort, GetMapIndex(), x, y);
+	LogManager::instance().CharLog(this, 0, "CHANGE_CH", buf);
+
+	return true;
+}
+
+bool CHARACTER::StartMoveChannel(long lNewAddr, WORD wNewPort)
+{
+	if (IsHack(false, true, 10))
+		return false;
+
+	move_channel_info* info = AllocEventInfo<move_channel_info>();
+	info->ch = this;
+	info->iSec = CanWarp() && !IsPosition(POS_FIGHTING) ? 3 : 10;
+	info->lNewAddr = lNewAddr;
+	info->wNewPort = wNewPort;
+
+	m_pkTimedEvent = event_create(move_channel, info, 1);
+
+	return true;
+}
+#endif
+
+#if defined(__SKILL_COLOR_SYSTEM__)
+void CHARACTER::SetSkillColor(DWORD* dwSkillColor)
+{
+	memcpy(m_dwSkillColor, dwSkillColor, sizeof(m_dwSkillColor));
 	UpdatePacket();
 }
 #endif
 
-#if defined(__ELEMENTAL_DUNGEON__)
-EVENTFUNC(elemental_curse_event)
-{
-	char_event_info* info = dynamic_cast<char_event_info*>(event->info);
-	if (info == NULL)
-	{
-		sys_err("elemental_curse_event> <Factor> Null pointer");
-		return 0;
-	}
-
-	LPCHARACTER ch = info->ch;
-	if (ch == NULL)
-		return 0;
-
-	const static float fReductionPct[10] = { 1.0f, 2.5f, 4.5f, 6.5f, 8.5f, 10.5f, 12.5f, 15.0f, 16.5f, 18.0f };
-	DWORD dwAccumulatedDamage = ch->GetAccumulatedDamage();
-
-	// NOTE : Increase the hp reduction level every 200.000 damage.
-	int iReductionLevel = MINMAX(1, dwAccumulatedDamage / 200000, 10);
-	int iDropHP = static_cast<int>(ch->GetMaxHP() * (fReductionPct[iReductionLevel - 1] / 100.0f));
-
-	CAffect* pAffect = ch->FindAffect(AFFECT_CURSE_OF_ELEMENTAL);
-	if (pAffect == NULL || iReductionLevel > pAffect->lApplyValue)
-		ch->AddAffect(AFFECT_CURSE_OF_ELEMENTAL, APPLY_NONE, iReductionLevel, AFF_NONE, INFINITE_AFFECT_DURATION, 0, true);
-
-	if (ch->FindAffect(AFFECT_PROTECTION_OF_ELEMENTAL))
-	{
-		if (test_server)
-			ch->ChatPacket(CHAT_TYPE_PARTY, "elemental_curse_event> protection success");
-
-		return PASSES_PER_SEC(15);
-	}
-
-	if (test_server)
-		ch->ChatPacket(CHAT_TYPE_PARTY, "elemental_curse_event> drain hp -%d (reduction level %d)",
-			-iDropHP, ch->GetMaxHP(), iReductionLevel);
-
-	ch->PointChange(POINT_HP, -iDropHP);
-
-	return PASSES_PER_SEC(15);
-}
-
-void CHARACTER::StartElementalCurseEvent()
-{
-	if (m_pElementalCurseEvent)
-		return;
-
-	if (test_server)
-		ChatPacket(CHAT_TYPE_PARTY, "Elemental Curse SUCCESS");
-
-	char_event_info* info = AllocEventInfo<char_event_info>();
-	info->ch = this;
-	m_pElementalCurseEvent = event_create(elemental_curse_event, info, PASSES_PER_SEC(1));
-}
-
-void CHARACTER::StopElementalCurseEvent()
-{
-	if (m_pElementalCurseEvent)
-		event_cancel(&m_pElementalCurseEvent);
-
-	m_pElementalCurseEvent = NULL;
-
-	RemoveAffect(AFFECT_CURSE_OF_ELEMENTAL);
-}
-
-void CHARACTER::SetAccumulatedDamage(DWORD dwDamage)
-{
-	if (m_dwAccumulatedDamage > UINT32_MAX - dwDamage)
-		m_dwAccumulatedDamage = UINT32_MAX;
-	else
-		m_dwAccumulatedDamage += dwDamage;
-}
-#endif
-
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-void CHARACTER::SetGuildDragonLair(CGuildDragonLair* pGuildDragonLair)
-{
-	if (pGuildDragonLair && m_pGuildDragonLair)
-		sys_err("%s is trying to reassign guild_dragonlair (current %p, new %p)",
-			GetName(), get_pointer(m_pGuildDragonLair), get_pointer(pGuildDragonLair));
-
-	if (m_pGuildDragonLair == pGuildDragonLair)
-		return;
-
-	if (IsPC() && m_pGuildDragonLair)
-		m_pGuildDragonLair->DecMember(this);
-
-	m_pGuildDragonLair = pGuildDragonLair;
-
-	if (IsPC() && pGuildDragonLair)
-		m_pGuildDragonLair->IncMember(this);
-}
-#endif
-
-#if defined(__SUMMER_EVENT_ROULETTE__)
-void CHARACTER::SetMiniGameRoulette(CMiniGameRoulette* pMiniGameRoulette)
-{
-	if (m_pMiniGameRoulette)
-		M2_DELETE(m_pMiniGameRoulette);
-
-	m_pMiniGameRoulette = pMiniGameRoulette;
-}
-#endif
-
-#if defined(__DEFENSE_WAVE__)
-void CHARACTER::SetDefenseWave(LPDEFENSE_WAVE pDefenseWave)
-{
-	if (pDefenseWave && m_pDefenseWave)
-		sys_err("%s is trying to reassign defense_wave (current %p, new %p)",
-			GetName(), get_pointer(m_pDefenseWave), get_pointer(pDefenseWave));
-
-	if (m_pDefenseWave == pDefenseWave)
-		return;
-
-	m_pDefenseWave = pDefenseWave;
-	SetDungeon(m_pDefenseWave);
-}
-
-LPDEFENSE_WAVE CHARACTER::GetDefenseWave() const
-{
-	if (m_pDefenseWave)
-		return m_pDefenseWave;
-
-	if (CDefenseWaveManager::Instance().IsDefenseWaveMap(GetMapIndex()))
-		return dynamic_cast<LPDEFENSE_WAVE>(m_pkDungeon);
-
-	return NULL;
-}
-#endif
-
-#ifdef ENABLE_QUEEN_NETHIS
-bool CHARACTER::IsSnakeMap()
-{
-	return SnakeLair::CSnk::instance().IsSnakeMap(GetMapIndex());
-}
-#endif
-
-#ifdef __OFFLINE_SHOP__
-void CHARACTER::SetProtectTime(const std::string& flagname, int value)
-{
-	auto it = m_protection_Time.find(flagname);
-	if (it != m_protection_Time.end())
-	{
-		it->second = value;
-	}
-	else
-	{
-		m_protection_Time.insert(std::make_pair(flagname, value));
-	}
-}
-
-int CHARACTER::GetProtectTime(const std::string& flagname) const
-{
-	auto it = m_protection_Time.find(flagname);
-	if (it != m_protection_Time.end())
-	{
-		return it->second;
-	}
-	return 0;
-}
-
-void CHARACTER::SetKeepingOfflineShop(uint32_t keepingOfflineShop)
-{
-	keepingOfflineShop_ = keepingOfflineShop;
-}
-
-uint32_t CHARACTER::GetKeepingOfflineShop() const
-{
-	return keepingOfflineShop_;
-}
-
-void CHARACTER::AddViewingOfflineShop(uint32_t id)
-{
-	// RemoveFromViewingOfflineShops();
-	viewingOfflineShops_.insert(id);
-}
-
-bool CHARACTER::IsViewingOfflineShop()
-{
-	return (viewingOfflineShops_.size() >= 1);
-}
-
-void CHARACTER::RemoveViewingOfflineShop(uint32_t id)
-{
-	viewingOfflineShops_.erase(id);
-}
-
-void CHARACTER::RemoveFromViewingOfflineShops()
-{
-	if (viewingOfflineShops_.size() < 1) {
-		return;
-	}
-
-	auto shops = viewingOfflineShops_;
-	for (const auto& id : shops) {
-		auto shop = COfflineShop::Get(id);
-		if (!shop) {
-			continue;
-		}
-
-		shop->get()->RemoveViewer(this);
-	}
-}
-
-void CHARACTER::SetOpeningOfflineShopState(bool isOpeningOfflineShop)
-{
-	isOpeningOfflineShop_ = isOpeningOfflineShop;
-}
-
-bool CHARACTER::IsOpeningOfflineShop() const
-{
-	return isOpeningOfflineShop_;
-}
-
-void CHARACTER::SetOfflineShopOpeningItem(CItem* item)
-{
-	offlineShopOpeningItem_ = item;
-}
-
-CItem* CHARACTER::GetOfflineShopOpeningItem() const
-{
-	return offlineShopOpeningItem_;
-}
-
-
-bool CHARACTER::IsAffectOfflineShopDecoration()
-{
-	return FindAffect(AFFECT_OFFLINE_SHOP_DECORATION) != NULL;
-}
-
-void CHARACTER::WarpToShop(long x, long y, long mapIndex, BYTE channel)
-{
-	if (!CanWarp())
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("TUM_PENCERELERI_KAPAT_OYLE_DENE"));
-		return;
-	}
-	
-	if (mapIndex < 10000 && x > 0 && y > 0)
-	{
-		PIXEL_POSITION mapBasePosition;
-		if (!SECTREE_MANAGER::Instance().GetMapBasePositionByMapIndex(mapIndex, mapBasePosition))
-			return;
-		
-		WarpSet(x + mapBasePosition.x, y + mapBasePosition.y);
-		Stop();
-	}
-}
-struct FSortSellHistory : public std::__binary_function<TMySellHistory, TMySellHistory, bool>
-{
-	bool operator () (TMySellHistory d1, TMySellHistory d2) const
-	{
-		if (d1.iTimeStamp > d2.iTimeStamp)
-			return true;
-		if (d1.iTimeStamp < d2.iTimeStamp)
-			return false;
- 
-		return false;
-	}
-};
-
-void CHARACTER::AddToSellHistory(TMySellHistory newItem)
-{
-	if (GetSellHistoryLoaded())
-		m_vecSellHistory.push_back(newItem);
-	
-	ChatPacket(CHAT_TYPE_COMMAND, "UpdateSellLog");
-}
-
-void CHARACTER::SaveSellHistory()
-{
-	char szQuery[2048];
-
-	for (auto & el : m_vecSellHistory)
-	{
-		if (!el.bIsSaved)
-		{
-			snprintf(szQuery, sizeof(szQuery), 
-				"INSERT INTO player.offline_shop_history "
-				"(pid, vnum, count, price, buyer, sold, transmutation, "
-				"socket0, socket1, socket2, socket3, socket4, socket5, "
-#if defined(__ITEM_APPLY_RANDOM__)
-				"apply_type0, apply_value0, apply_path0, "
-				"apply_type1, apply_value1, apply_path1, "
-				"apply_type2, apply_value2, apply_path2, "
-				"apply_type3, apply_value3, apply_path3, "
-#endif
-				"attrtype0, attrvalue0, attrtype1, attrvalue1, "
-				"attrtype2, attrvalue2, attrtype3, attrvalue3, "
-				"attrtype4, attrvalue4, attrtype5, attrvalue5, "
-				"attrtype6, attrvalue6) VALUES (%d, %d, %d, %lld, '%s', %d, %d, "
-				"%d, %d, %d, %d, %d, 0, "
-#if defined(__ITEM_APPLY_RANDOM__)
-				"%d, %d, %d, "
-				"%d, %d, %d, "
-				"%d, %d, %d, "
-				"%d, %d, %d, "
-#endif
-				"%d, %d, %d, %d, %d, %d, %d, %d, %d, %d, %d, %d, %d, %d)", 
-				GetPlayerID(), el.dwVnum, el.dwCount, el.llPrice, 
-				el.szBuyer, el.iTimeStamp, el.dwTransmutationVnum, 
-				el.alSockets[0], el.alSockets[1], el.alSockets[2], el.alSockets[3], 
-				el.alSockets[4], 
-#if defined(__ITEM_APPLY_RANDOM__)
-				el.aApplyRandom[0].wType, el.aApplyRandom[0].lValue, el.aApplyRandom[0].bPath,
-				el.aApplyRandom[1].wType, el.aApplyRandom[1].lValue, el.aApplyRandom[1].bPath,
-				el.aApplyRandom[2].wType, el.aApplyRandom[2].lValue, el.aApplyRandom[2].bPath,
-				el.aApplyRandom[3].wType, el.aApplyRandom[3].lValue, el.aApplyRandom[3].bPath,
-#endif
-				el.aAttr[0].wType, el.aAttr[0].lValue, el.aAttr[1].wType, el.aAttr[1].lValue,
-				el.aAttr[2].wType, el.aAttr[2].lValue, el.aAttr[3].wType, el.aAttr[3].lValue,
-				el.aAttr[4].wType, el.aAttr[4].lValue, el.aAttr[5].wType, el.aAttr[5].lValue,
-				el.aAttr[6].wType, el.aAttr[6].lValue);
-				
-				std::unique_ptr<SQLMsg> pMsg(DBManager::instance().DirectQuery(szQuery));
-		}
-	}
-}
-
-void CHARACTER::RequestSellHistory(BYTE bPage)
-{
-	if (!GetSellHistoryLoaded())
-	{
-		//Load data from mysql into vector
-		
-		// pid, vnum, price, buyer, sold, transmutation, 
-		// socket0, socket1, socket2, socket3, socket4, socket5,
-		// attrtype0, attrvalue0, attrtype1, attrvalue1
-		// attrtype2, attrvalue2, attrtype3, attrvalue3
-		// attrtype4, attrvalue4, attrtype5, attrvalue5
-		// attrtype6, attrvalue6, count
-		char szQuery[4096];
-		snprintf(szQuery, sizeof(szQuery), "SELECT pid, vnum, price, buyer, sold, transmutation, "
-			" socket0, socket1, socket2, socket3, socket4, socket5, "
-#if defined(__ITEM_APPLY_RANDOM__)
-			" apply_type0, apply_value0, apply_path0, "
-			" apply_type1, apply_value1, apply_path1, "
-			" apply_type2, apply_value2, apply_path2, "
-			" apply_type3, apply_value3, apply_path3, "
-#endif
-			" attrtype0, attrvalue0, attrtype1, attrvalue1, "
-			" attrtype2, attrvalue2, attrtype3, attrvalue3, "
-			" attrtype4, attrvalue4, attrtype5, attrvalue5, "
-			" attrtype6, attrvalue6, count "
-			"FROM player.offline_shop_history "
-			"WHERE pid = %d ORDER BY sold DESC LIMIT 100", GetPlayerID());
-			
-		std::unique_ptr<SQLMsg> pMsg(DBManager::instance().DirectQuery(szQuery));
-		if (pMsg->Get()->uiNumRows != 0)
-		{
-			MYSQL_ROW row;
-			while (NULL != (row = mysql_fetch_row(pMsg->Get()->pSQLResult)))
-			{
-				DWORD vnum = 0;
-				str_to_number(vnum, row[1]);
-				
-				long long price = 0;
-				str_to_number(price, row[2]);
-				
-				const char* buyer = row[3];
-				
-				int timeSold = 0;
-				str_to_number(timeSold, row[4]);
-				
-				DWORD dwTransmutationVnum = 0;
-				str_to_number(dwTransmutationVnum, row[5]);
-				
-				long sockets[ITEM_SOCKET_MAX_NUM];
-				str_to_number(sockets[0], row[6]);
-				str_to_number(sockets[1], row[7]);
-				str_to_number(sockets[2], row[8]);
-				str_to_number(sockets[3], row[9]);
-				str_to_number(sockets[4], row[10]);
-				// str_to_number(sockets[5], row[11]);
-				
-				int iCurRow = 12;
-
-#if defined(__ITEM_APPLY_RANDOM__)
-				TPlayerItemAttribute aApplyRandom[4];
-				for (int i = 0; i < 4; ++i) {
-					aApplyRandom[i].wType = atoi(row[iCurRow++]);
-					aApplyRandom[i].lValue = atoi(row[iCurRow++]);
-					aApplyRandom[i].bPath = atoi(row[iCurRow++]);
-				}
-#endif
-
-				TPlayerItemAttribute aAttr[7];
-				for (int j = 0; j < 7; j++)
-				{
-					
-					str_to_number(aAttr[j].wType, row[iCurRow++]);
-					str_to_number(aAttr[j].lValue, row[iCurRow++]);
-				}
-				
-				DWORD count = 1;
-				str_to_number(count, row[iCurRow]);
-				
-				//Add to vector
-				TMySellHistory newItem;
-				
-				newItem.dwVnum = vnum;
-				newItem.dwCount = count;
-				newItem.llPrice = price;
-				strlcpy(newItem.szBuyer, buyer, sizeof(newItem.szBuyer));
-				newItem.iTimeStamp = timeSold;
-				newItem.dwTransmutationVnum = dwTransmutationVnum;
-				newItem.bIsSaved = true;
-				
-				thecore_memcpy(newItem.alSockets, sockets, sizeof(newItem.alSockets));
-#if defined(__ITEM_APPLY_RANDOM__)
-				thecore_memcpy(newItem.aApplyRandom, aApplyRandom, sizeof(newItem.aApplyRandom));
-#endif
-				thecore_memcpy(newItem.aAttr, aAttr, sizeof(newItem.aAttr));
-
-				m_vecSellHistory.push_back(newItem);
-			}
-		}
-		
-		SetSellHistoryLoaded(1);
-	}
-	
-	if (m_vecSellHistory.size() > 100)
-		m_vecSellHistory.resize(100);
-	
-	// sys_err("[DEBUG_INFO_1] Sorting sell history for %s", GetName());
-	std::sort(m_vecSellHistory.begin(), m_vecSellHistory.end(), FSortSellHistory());
-	// sys_err("[DEBUG_INFO_2] Sorting sell history for %s FINISHED", GetName());
-
-	int minItems = ((bPage-1)*10) + 1;
-	if (bPage > 1 && m_vecSellHistory.size() < minItems)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("BU_SAYFA_ICIN_ESYA_YOK"));
-		ChatPacket(CHAT_TYPE_COMMAND, "RevertPageSellLog");
-		return;
-	}
-	else if (bPage == 1 && !m_vecSellHistory.size())
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("HENUZ_ESYA_SATMADIN"));
-		ChatPacket(CHAT_TYPE_COMMAND, "RefreshSellLog");
-		return;
-	}
-	
-	//Send data to client
-	// page 1 = 1-10
-	// page 2 = 11-20
-	// page 3 = 21-30
-	int iHelp = 0;
-	for (auto & element : m_vecSellHistory)
-	{
-		if (bPage == 1 && iHelp == 10)
-			break;
-		
-		if (bPage > 1 && iHelp >= bPage*10)
-			break;
-		
-		iHelp++;
-		if (bPage > 1 && iHelp < minItems)
-			continue;
-#if defined(__ITEM_APPLY_RANDOM__)
-		ChatPacket(CHAT_TYPE_COMMAND, "AddSellLog %d %d %d %lld %d %s %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d",
-#else
-		ChatPacket(CHAT_TYPE_COMMAND, "AddSellLog %d %d %d %lld %d %s %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d",
-#endif
-			iHelp, element.dwVnum, element.dwCount, element.llPrice, element.iTimeStamp, element.szBuyer, 
-			element.alSockets[0], element.alSockets[1], element.alSockets[2],
-			element.alSockets[3], element.alSockets[4],
-#if defined(__ITEM_APPLY_RANDOM__)
-			element.aApplyRandom[0].wType, element.aApplyRandom[0].lValue, element.aApplyRandom[0].bPath,
-			element.aApplyRandom[1].wType, element.aApplyRandom[1].lValue, element.aApplyRandom[1].bPath,
-			element.aApplyRandom[2].wType, element.aApplyRandom[2].lValue, element.aApplyRandom[2].bPath,
-			element.aApplyRandom[3].wType, element.aApplyRandom[3].lValue, element.aApplyRandom[3].bPath,
-#endif
-			element.aAttr[0].wType, element.aAttr[0].lValue, element.aAttr[1].wType, element.aAttr[1].lValue, 
-			element.aAttr[2].wType, element.aAttr[2].lValue, element.aAttr[3].wType, element.aAttr[3].lValue, 
-			element.aAttr[4].wType, element.aAttr[4].lValue, element.aAttr[5].wType, element.aAttr[5].lValue, 
-			element.aAttr[6].wType, element.aAttr[6].lValue, element.dwTransmutationVnum);
-		
-
-	}
-	
-	ChatPacket(CHAT_TYPE_COMMAND, "RefreshSellLog");
-}
-#endif
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-void CHARACTER::SetLastReciveExtBattlePassInfoTime(DWORD time)
-{
-	m_dwLastReciveExtBattlePassInfoTime = time;
-}
-
-void CHARACTER::SetLastReciveExtBattlePassOpenRanking(DWORD time)
-{
-	m_dwLastExtBattlePassOpenRankingTime = time;
-}
-
-void CHARACTER::LoadExtBattlePass(DWORD dwCount, TPlayerExtBattlePassMission* data)
-{
-	m_bIsLoadedExtBattlePass = false;
-
-	for (int i = 0; i < dwCount; ++i, ++data)
-	{
-		TPlayerExtBattlePassMission* newMission = new TPlayerExtBattlePassMission;
-		newMission->dwPlayerId = data->dwPlayerId;
-		newMission->dwBattlePassType = data->dwBattlePassType;
-		newMission->dwMissionIndex = data->dwMissionIndex;
-		newMission->dwMissionType = data->dwMissionType;
-		newMission->dwBattlePassId = data->dwBattlePassId;
-		newMission->dwExtraInfo = data->dwExtraInfo;
-		newMission->bCompleted = data->bCompleted;
-		newMission->bIsUpdated = data->bIsUpdated;
-
-		m_listExtBattlePass.push_back(newMission);
-	}
-
-	m_bIsLoadedExtBattlePass = true;
-}
-
-DWORD CHARACTER::GetExtBattlePassMissionProgress(DWORD dwBattlePassType, BYTE bMissionIndex, BYTE bMissionType)
-{
-	DWORD BattlePassID;
-	if (dwBattlePassType == 1)
-		BattlePassID = CBattlePassManager::instance().GetNormalBattlePassID();
-	else if (dwBattlePassType == 2)
-		BattlePassID = CBattlePassManager::instance().GetPremiumBattlePassID();
-	else if (dwBattlePassType == 3)
-		BattlePassID = CBattlePassManager::instance().GetEventBattlePassID();
-	else {
-		sys_err("Unknown BattlePassType (%d)", dwBattlePassType);
-		return 0;
-	}
-	
-	ListExtBattlePassMap::iterator it = m_listExtBattlePass.begin();
-	while (it != m_listExtBattlePass.end())
-	{
-		TPlayerExtBattlePassMission* pkMission = *it++;
-		if (pkMission->dwBattlePassType == dwBattlePassType && pkMission->dwMissionIndex == bMissionIndex && pkMission->dwMissionType == bMissionType && pkMission->dwBattlePassId == BattlePassID)
-			return pkMission->dwExtraInfo;
-	}
-	return 0;
-}
-
-bool CHARACTER::IsExtBattlePassCompletedMission(DWORD dwBattlePassType, BYTE bMissionIndex, BYTE bMissionType)
-{
-	DWORD BattlePassID;
-	if (dwBattlePassType == 1)
-		BattlePassID = CBattlePassManager::instance().GetNormalBattlePassID();
-	else if (dwBattlePassType == 2)
-		BattlePassID = CBattlePassManager::instance().GetPremiumBattlePassID();
-	else if (dwBattlePassType == 3)
-		BattlePassID = CBattlePassManager::instance().GetEventBattlePassID();
-	else {
-		sys_err("Unknown BattlePassType (%d)", dwBattlePassType);
-		return false;
-	}
-	ListExtBattlePassMap::iterator it = m_listExtBattlePass.begin();
-	while (it != m_listExtBattlePass.end())
-	{
-		TPlayerExtBattlePassMission* pkMission = *it++;
-		if (pkMission->dwBattlePassType == dwBattlePassType && pkMission->dwMissionIndex == bMissionIndex && pkMission->dwMissionType == bMissionType && pkMission->dwBattlePassId == BattlePassID)
-			return (pkMission->bCompleted ? true : false);
-	}
-	return false;
-}
-
-bool CHARACTER::IsExtBattlePassRegistered(BYTE bBattlePassType, DWORD dwBattlePassID)
-{
-	std::unique_ptr<SQLMsg> pMsg(DBManager::instance().DirectQuery("SELECT * FROM player.battlepass_playerindex WHERE player_id = %d and battlepass_type = %d and battlepass_id = %d", GetPlayerID(), bBattlePassType, dwBattlePassID));
-	if (pMsg->Get()->uiNumRows != 0)
-		return true;
-
-	return false;
-}
-
-void CHARACTER::UpdateExtBattlePassMissionProgress(DWORD dwMissionType, DWORD dwUpdateValue, DWORD dwCondition, bool isOverride)
-{
-	if (!GetDesc())
-		return;
-
-	if (!m_bIsLoadedExtBattlePass)
-		return;
-
-	DWORD dwSafeCondition = dwCondition;
-	for (BYTE bBattlePassType = 1; bBattlePassType <= 3 ; ++bBattlePassType)
-	{
-		bool foundMission = false;
-		DWORD dwSaveProgress = 0;
-		dwCondition = dwSafeCondition;
-		
-		BYTE bBattlePassID;
-		BYTE bMissionIndex = CBattlePassManager::instance().GetMissionIndex(bBattlePassType, dwMissionType, dwCondition);
-
-		if (bBattlePassType == 1)
-			bBattlePassID = CBattlePassManager::instance().GetNormalBattlePassID();
-		if (bBattlePassType == 2){
-			bBattlePassID = CBattlePassManager::instance().GetPremiumBattlePassID();
-			if (bBattlePassID != GetExtBattlePassPremiumID())
-				continue;
-		}
-		if (bBattlePassType == 3)
-			bBattlePassID = CBattlePassManager::instance().GetEventBattlePassID();
-
-		DWORD dwFirstInfo, dwSecondInfo;
-		if (CBattlePassManager::instance().BattlePassMissionGetInfo(bBattlePassType, bMissionIndex, bBattlePassID, dwMissionType, &dwFirstInfo, &dwSecondInfo))
-		{
-			if (dwFirstInfo == 0)
-				dwCondition = 0;
-			
-			if (dwMissionType == 2 and dwFirstInfo <= dwCondition or dwMissionType == 4 and dwFirstInfo <= dwCondition or dwMissionType == 20 and dwFirstInfo <= dwCondition)
-				dwCondition = dwFirstInfo;
-
-			if (dwFirstInfo == dwCondition && GetExtBattlePassMissionProgress(bBattlePassType, bMissionIndex, dwMissionType) < dwSecondInfo)
-			{
-				ListExtBattlePassMap::iterator it = m_listExtBattlePass.begin();
-				while (it != m_listExtBattlePass.end())
-				{
-					TPlayerExtBattlePassMission* pkMission = *it++;
-
-					if (pkMission->dwBattlePassType == bBattlePassType && pkMission->dwMissionIndex == bMissionIndex && pkMission->dwMissionType == dwMissionType && pkMission->dwBattlePassId == bBattlePassID)
-					{
-						pkMission->bIsUpdated = 1;
-
-						if (isOverride)
-							pkMission->dwExtraInfo = dwUpdateValue;
-						else
-							pkMission->dwExtraInfo += dwUpdateValue;
-
-						if (pkMission->dwExtraInfo >= dwSecondInfo)
-						{
-							pkMission->dwExtraInfo = dwSecondInfo;
-							pkMission->bCompleted = 1;
-
-							std::string stMissionName = CBattlePassManager::instance().GetMissionNameByType(pkMission->dwMissionType);
-							std::string stBattlePassName = CBattlePassManager::instance().GetNormalBattlePassNameByID(pkMission->dwBattlePassId);
-
-							CBattlePassManager::instance().BattlePassRewardMission(this, bBattlePassType, bBattlePassID, bMissionIndex);
-							if (bBattlePassType == 1) {
-								EffectPacket(SE_EFFECT_BP_NORMAL_MISSION_COMPLETED);
-								ChatPacket(CHAT_TYPE_NOTICE, LC_STRING("BATTLEPASS_COMPLETE_NORMAL_MISSION"));
-							}
-							if (bBattlePassType == 2) {
-								EffectPacket(SE_EFFECT_BP_PREMIUM_MISSION_COMPLETED);
-								ChatPacket(CHAT_TYPE_NOTICE, LC_STRING("BATTLEPASS_COMPLETE_PREMIUM_MISSION"));
-							}
-							if (bBattlePassType == 3) {
-								EffectPacket(SE_EFFECT_BP_EVENT_MISSION_COMPLETED);
-								ChatPacket(CHAT_TYPE_NOTICE, LC_STRING("BATTLEPASS_COMPLETE_EVENT_MISSION"));
-							}
-							
-							TPacketGCExtBattlePassMissionUpdate packet;
-							packet.bHeader = HEADER_GC_EXT_BATTLE_PASS_MISSION_UPDATE;
-							packet.bBattlePassType = bBattlePassType;
-							packet.bMissionIndex = bMissionIndex;
-							packet.dwNewProgress = pkMission->dwExtraInfo;
-							GetDesc()->Packet(&packet, sizeof(TPacketGCExtBattlePassMissionUpdate));
-						}
-
-						dwSaveProgress = pkMission->dwExtraInfo;
-						foundMission = true;
-
-						if (pkMission->bCompleted != 1) {
-							TPacketGCExtBattlePassMissionUpdate packet;
-							packet.bHeader = HEADER_GC_EXT_BATTLE_PASS_MISSION_UPDATE;
-							packet.bBattlePassType = bBattlePassType;
-							packet.bMissionIndex = bMissionIndex;
-							packet.dwNewProgress = dwSaveProgress;
-							GetDesc()->Packet(&packet, sizeof(TPacketGCExtBattlePassMissionUpdate));
-						}
-						break;
-					}
-					
-				}
-
-				if (!foundMission)
-				{
-					if (!IsExtBattlePassRegistered(bBattlePassType, bBattlePassID))
-						DBManager::instance().DirectQuery("INSERT INTO player.battlepass_playerindex SET player_id=%d, player_name='%s', battlepass_type=%d, battlepass_id=%d, start_time=NOW()", GetPlayerID(), GetName(), bBattlePassType, bBattlePassID);
-					
-					TPlayerExtBattlePassMission* newMission = new TPlayerExtBattlePassMission;
-					newMission->dwPlayerId = GetPlayerID();
-					newMission->dwBattlePassType = bBattlePassType;
-					newMission->dwMissionType = dwMissionType;
-					newMission->dwBattlePassId = bBattlePassID;
-
-					if (dwUpdateValue >= dwSecondInfo)
-					{
-						newMission->dwMissionIndex = CBattlePassManager::instance().GetMissionIndex(bBattlePassType, dwMissionType, dwCondition);
-						newMission->dwExtraInfo = dwSecondInfo;
-						newMission->bCompleted = 1;
-
-						CBattlePassManager::instance().BattlePassRewardMission(this, bBattlePassType, bBattlePassID, bMissionIndex);
-						if (bBattlePassType == 1) {
-							EffectPacket(SE_EFFECT_BP_NORMAL_MISSION_COMPLETED);
-							ChatPacket(CHAT_TYPE_NOTICE, LC_STRING("BATTLEPASS_COMPLETE_NORMAL_MISSION"));
-						}
-						if (bBattlePassType == 2) {
-							EffectPacket(SE_EFFECT_BP_PREMIUM_MISSION_COMPLETED);
-							ChatPacket(CHAT_TYPE_NOTICE, LC_STRING("BATTLEPASS_COMPLETE_PREMIUM_MISSION"));
-						}
-						if (bBattlePassType == 3) {
-							EffectPacket(SE_EFFECT_BP_EVENT_MISSION_COMPLETED);
-							ChatPacket(CHAT_TYPE_NOTICE, LC_STRING("BATTLEPASS_COMPLETE_EVENT_MISSION"));
-						}
-
-						dwSaveProgress = dwSecondInfo;
-					}
-					else
-					{
-						newMission->dwMissionIndex = CBattlePassManager::instance().GetMissionIndex(bBattlePassType, dwMissionType, dwCondition);
-						newMission->dwExtraInfo = dwUpdateValue;
-						newMission->bCompleted = 0;
-
-						dwSaveProgress = dwUpdateValue;
-					}
-
-					newMission->bIsUpdated = 1;
-
-					m_listExtBattlePass.push_back(newMission);
-
-					TPacketGCExtBattlePassMissionUpdate packet;
-					packet.bHeader = HEADER_GC_EXT_BATTLE_PASS_MISSION_UPDATE;
-					packet.bBattlePassType = bBattlePassType;
-					packet.bMissionIndex = bMissionIndex;
-					packet.dwNewProgress = dwSaveProgress;
-					GetDesc()->Packet(&packet, sizeof(TPacketGCExtBattlePassMissionUpdate));
-				}
-			}
-		}
-	}
-}
-
-void CHARACTER::SetExtBattlePassMissionProgress(BYTE bBattlePassType, DWORD dwMissionIndex, DWORD dwMissionType, DWORD dwUpdateValue)
-{
-	if (!GetDesc())
-		return;
-
-	if (!m_bIsLoadedExtBattlePass)
-		return;
-
-	bool foundMission = false;
-	DWORD dwSaveProgress = 0;
-	
-	BYTE bBattlePassID;
-	if (bBattlePassType == 1)
-		bBattlePassID = CBattlePassManager::instance().GetNormalBattlePassID();
-	else if (bBattlePassType == 2)
-		bBattlePassID = CBattlePassManager::instance().GetPremiumBattlePassID();
-	else if (bBattlePassType == 3)
-		bBattlePassID = CBattlePassManager::instance().GetEventBattlePassID();
-	else {
-		sys_err("Unknown BattlePassType (%d)", bBattlePassType);
-		return;
-	}
-	
-	DWORD dwFirstInfo, dwSecondInfo;
-	if (CBattlePassManager::instance().BattlePassMissionGetInfo(bBattlePassType, dwMissionIndex, bBattlePassID, dwMissionType, &dwFirstInfo, &dwSecondInfo))
-	{
-		ListExtBattlePassMap::iterator it = m_listExtBattlePass.begin();
-		while (it != m_listExtBattlePass.end())
-		{
-			TPlayerExtBattlePassMission* pkMission = *it++;
-
-			if (pkMission->dwBattlePassType == bBattlePassType && pkMission->dwMissionIndex == dwMissionIndex && pkMission->dwMissionType == dwMissionType && pkMission->dwBattlePassId == bBattlePassID)
-			{
-				pkMission->bIsUpdated = 1;
-				pkMission->bCompleted = 0;
-				
-				pkMission->dwExtraInfo = dwUpdateValue;
-
-				if (pkMission->dwExtraInfo >= dwSecondInfo)
-				{
-					pkMission->dwExtraInfo = dwSecondInfo;
-					pkMission->bCompleted = 1;
-
-					std::string stMissionName = CBattlePassManager::instance().GetMissionNameByType(pkMission->dwMissionType);
-					std::string stBattlePassName = CBattlePassManager::instance().GetNormalBattlePassNameByID(pkMission->dwBattlePassId);
-					//ChatPacket(CHAT_TYPE_NOTICE, LC_STRING("New Value : %d"), pkMission->dwExtraInfo);
-
-					CBattlePassManager::instance().BattlePassRewardMission(this, bBattlePassType, bBattlePassID, dwMissionIndex);
-					if (bBattlePassType == 1) {
-						EffectPacket(SE_EFFECT_BP_NORMAL_MISSION_COMPLETED);
-						ChatPacket(CHAT_TYPE_NOTICE, LC_STRING("BATTLEPASS_COMPLETE_NORMAL_MISSION"));
-					}
-					if (bBattlePassType == 2) {
-						EffectPacket(SE_EFFECT_BP_PREMIUM_MISSION_COMPLETED);
-						ChatPacket(CHAT_TYPE_NOTICE, LC_STRING("BATTLEPASS_COMPLETE_PREMIUM_MISSION"));
-					}
-					if (bBattlePassType == 3) {
-						EffectPacket(SE_EFFECT_BP_EVENT_MISSION_COMPLETED);
-						ChatPacket(CHAT_TYPE_NOTICE, LC_STRING("BATTLEPASS_COMPLETE_EVENT_MISSION"));
-					}
-					
-					TPacketGCExtBattlePassMissionUpdate packet;
-					packet.bHeader = HEADER_GC_EXT_BATTLE_PASS_MISSION_UPDATE;
-					packet.bBattlePassType = bBattlePassType;
-					packet.bMissionIndex = dwMissionIndex;
-					packet.dwNewProgress = pkMission->dwExtraInfo;
-					GetDesc()->Packet(&packet, sizeof(TPacketGCExtBattlePassMissionUpdate));
-				}
-
-				dwSaveProgress = pkMission->dwExtraInfo;
-				foundMission = true;
-
-				if (pkMission->bCompleted != 1) {
-					TPacketGCExtBattlePassMissionUpdate packet;
-					packet.bHeader = HEADER_GC_EXT_BATTLE_PASS_MISSION_UPDATE;
-					packet.bBattlePassType = bBattlePassType;
-					packet.bMissionIndex = dwMissionIndex;
-					packet.dwNewProgress = dwSaveProgress;
-					GetDesc()->Packet(&packet, sizeof(TPacketGCExtBattlePassMissionUpdate));
-				}
-				break;
-			}
-		}
-
-		if (!foundMission)
-		{
-			if (!IsExtBattlePassRegistered(bBattlePassType, bBattlePassID))
-				DBManager::instance().DirectQuery("INSERT INTO player.battlepass_playerindex SET player_id=%d, player_name='%s', battlepass_type=%d, battlepass_id=%d, start_time=NOW()", GetPlayerID(), GetName(), bBattlePassType, bBattlePassID);
-
-			TPlayerExtBattlePassMission* newMission = new TPlayerExtBattlePassMission;
-			newMission->dwPlayerId = GetPlayerID();
-			newMission->dwBattlePassType = bBattlePassType;
-			newMission->dwMissionType = dwMissionType;
-			newMission->dwBattlePassId = bBattlePassID;
-
-			if (dwUpdateValue >= dwSecondInfo)
-			{
-				newMission->dwMissionIndex = dwMissionIndex;
-				newMission->dwExtraInfo = dwSecondInfo;
-				newMission->bCompleted = 1;
-
-				CBattlePassManager::instance().BattlePassRewardMission(this, bBattlePassType, bBattlePassID, dwMissionIndex);
-				if (bBattlePassType == 1) {
-					EffectPacket(SE_EFFECT_BP_NORMAL_MISSION_COMPLETED);
-					ChatPacket(CHAT_TYPE_NOTICE, LC_STRING("BATTLEPASS_COMPLETE_NORMAL_MISSION"));
-				}
-				if (bBattlePassType == 2) {
-					EffectPacket(SE_EFFECT_BP_PREMIUM_MISSION_COMPLETED);
-					ChatPacket(CHAT_TYPE_NOTICE, LC_STRING("BATTLEPASS_COMPLETE_PREMIUM_MISSION"));
-				}
-				if (bBattlePassType == 3) {
-					EffectPacket(SE_EFFECT_BP_EVENT_MISSION_COMPLETED);
-					ChatPacket(CHAT_TYPE_NOTICE, LC_STRING("BATTLEPASS_COMPLETE_EVENT_MISSION"));
-				}
-
-				dwSaveProgress = dwSecondInfo;
-			}
-			else
-			{
-				newMission->dwMissionIndex = dwMissionIndex;
-				newMission->dwExtraInfo = dwUpdateValue;
-				newMission->bCompleted = 0;
-
-				dwSaveProgress = dwUpdateValue;
-			}
-
-			newMission->bIsUpdated = 1;
-
-			m_listExtBattlePass.push_back(newMission);
-
-			TPacketGCExtBattlePassMissionUpdate packet;
-			packet.bHeader = HEADER_GC_EXT_BATTLE_PASS_MISSION_UPDATE;
-			packet.bBattlePassType = bBattlePassType;
-			packet.bMissionIndex = dwMissionIndex;
-			packet.dwNewProgress = dwSaveProgress;
-			GetDesc()->Packet(&packet, sizeof(TPacketGCExtBattlePassMissionUpdate));
-		}
-	}
-}
-#endif
+BYTE CHARACTER::GetLanguage() const
+{
+	if (IsPC() && (!GetDesc() || !GetDesc()->GetCharacter()))
+		return LOCALE_DEFAULT;
+
+	if (GetDesc())
+		return GetDesc()->GetLanguage();
+
+	return LOCALE_DEFAULT;
+}
+
+bool CHARACTER::ChangeLanguage(BYTE bLanguage)
+{
+	if (!IsPC())
+		return false;
+
+	if (!CanWarp())
+		return false;
+
+	TPacketChangeLanguage packet;
+	packet.bHeader = HEADER_GC_REQUEST_CHANGE_LANGUAGE;
+	packet.bLanguage = bLanguage;
+	GetDesc()->Packet(&packet, sizeof(packet));
+
+	GetDesc()->SetLanguage(bLanguage);
+	UpdatePacket();
+
+	char buf[256];
+	snprintf(buf, sizeof(buf), "%s Language %d", GetName(), bLanguage);
+	LogManager::instance().CharLog(this, 0, "CHANGE_LANGUAGE", buf);
+
+	return true;
+}
+
+#ifdef __GROWTH_PET_SYSTEM__
+bool CHARACTER::SetGrowthPet(LPGROWTH_PET pkPet)
+{
+	auto it = m_growthPetMap.find(pkPet->GetPetID());
+
+	if (it != m_growthPetMap.end())
+		m_growthPetMap.erase(it);
+
+	if (pkPet->GetOwner() != this)
+		pkPet->SetOwner(this);
+
+	m_growthPetMap.emplace(pkPet->GetPetID(), pkPet);
+
+	TPacketGCPetSet packet;
+	packet.header = HEADER_GC_PET_SET;
+	packet.dwID = pkPet->GetPetID();
+	packet.dwSummonItemVnum = pkPet->GetSummonItemVnum();
+
+	strlcpy(packet.szName, pkPet->GetPetName().c_str(), sizeof(packet.szName));
+	thecore_memcpy(packet.aSkill, pkPet->GetPetSkill(), sizeof(packet.aSkill));
+
+	for (int i = 0; i < POINT_UPBRINGING_MAX_NUM; i++)
+		packet.dwPoints[i] = pkPet->GetPetPoint(i);
+
+	if(GetDesc())
+		GetDesc()->Packet(&packet, sizeof(packet));
+
+	return true;
+}
+
+bool CHARACTER::DeleteGrowthPet(DWORD dwID)
+{
+	auto it = m_growthPetMap.find(dwID);
+
+	if (it == m_growthPetMap.end())
+		return false;
+
+	m_growthPetMap.erase(it);
+
+	TPacketGCPetDelete packet;
+	packet.header = HEADER_GC_PET_DEL;
+	packet.dwID = dwID;
+
+	if (GetDesc())
+		GetDesc()->Packet(&packet, sizeof(packet));
+
+	return true;
+}
+
+LPGROWTH_PET CHARACTER::GetGrowthPet(DWORD dwID)
+{
+	auto it = m_growthPetMap.find(dwID);
+
+	if (it != m_growthPetMap.end())
+		return it->second;
+
+	return nullptr;
+}
+
+void CHARACTER::ClearGrowthPet()
+{
+	if (m_activeGrowthPet)
+		m_activeGrowthPet->Unsummon();
+
+	if (m_growthPetMap.size())
+	{
+		auto it = m_growthPetMap.begin();
+
+		while (it != m_growthPetMap.end())
+		{
+			LPGROWTH_PET pPet = it->second;
+
+			pPet->Save();
+
+			// Increase the iterator before deleting pet pointer
+			++it;
+
+			CGrowthPetManager::Instance().DeleteGrowthPet(pPet->GetPetID());
+		}
+
+		m_growthPetMap.clear();
+	}
+}
+
+void CHARACTER::SendDeadPetMessage()
+{
+	for (auto kv : m_growthPetMap)
+	{
+		LPGROWTH_PET pPet = kv.second;
+
+
+		if (pPet->GetState() != STATE_UPBRINGING)
+			continue;
+
+		if (pPet->GetPetPoint(POINT_UPBRINGING_DURATION) < get_global_time())
+		{
+			TItemTable* pProto = ITEM_MANAGER::instance().GetTable(pPet->GetSummonItemVnum());
+			if (!pProto)
+				continue;
+
+			//ChatPacket(CHAT_TYPE_INFO, "%s is currently fast asleep.", pProto->szLocaleName);
+		}
+	}
+}
+#endif
+
+#if defined(__PRIVATESHOP_SEARCH_SYSTEM__)
+void CHARACTER::OpenPrivateShopSearch(DWORD dwVnum)
+{
+	if (GetDesc() == NULL)
+		return;
+
+	if (PreventTradeWindow(WND_SHOPSEARCH, true/*except*/))
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("SHOP_SEARCH_CLOSE_TABS"));
+		return;
+	}
+
+	TPacketGCPrivateShopSearchOpen p;
+	p.header = HEADER_GC_PRIVATESHOP_SEARCH_OPEN;
+	GetDesc()->Packet(&p, sizeof(p));
+
+	bPrivateShopSearchState = (dwVnum == PRIVATESHOP_SEARCH_LOOKING_GLASS) ? SHOP_SEARCH_LOOKING : SHOP_SEARCH_TRADING;
+}
+#endif
+
+#if defined(__MAILBOX__)
+void CHARACTER::SetMailBox(CMailBox* m)
+{
+	if (m_pkMailBox)
+		delete m_pkMailBox;
+
+	m_pkMailBox = m;
+}
+#endif
+
+#if defined(__CONQUEROR_LEVEL__)
+bool CHARACTER::IsNewWorldMap(long lMapIndex)
+{
+	TSungMaWillMap::iterator it = SungMaWillMap.find(lMapIndex);
+	return (it != SungMaWillMap.end() ? true : false);
+}
+
+void CHARACTER::SetConqueror(bool bSet)
+{
+	if (bSet)
+	{
+		if (GetConquerorLevel() > 0)
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You have already reached the Champion Level."));
+			return;
+		}
+
+		DWORD dwNextExp = GetNextExp() / 4;
+		if ((GetLevel() < gPlayerMaxLevel) || (GetLevel() >= gPlayerMaxLevel && GetExp() < dwNextExp))
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You must fill up at least 1 EXP Marble at level 120 to reach Champion Level."));
+			return;
+		}
+	}
+
+	PointChange(POINT_CONQUEROR_LEVEL, MINMAX(0, bSet ? 1 : 0, gPlayerMaxLevel) - GetConquerorLevel());
+
+	SetRealPoint(POINT_SUNGMA_STR, 0);
+	SetPoint(POINT_SUNGMA_STR, GetRealPoint(POINT_SUNGMA_STR));
+
+	SetRealPoint(POINT_SUNGMA_HP, 0);
+	SetPoint(POINT_SUNGMA_HP, GetRealPoint(POINT_SUNGMA_HP));
+
+	SetRealPoint(POINT_SUNGMA_MOVE, 0);
+	SetPoint(POINT_SUNGMA_MOVE, GetRealPoint(POINT_SUNGMA_MOVE));
+
+	SetRealPoint(POINT_SUNGMA_IMMUNE, 0);
+	SetPoint(POINT_SUNGMA_IMMUNE, GetRealPoint(POINT_SUNGMA_IMMUNE));
+
+	PointChange(POINT_CONQUEROR_POINT, (MINMAX(0, bSet ? 1 : 0, gPlayerMaxLevelStats) * 1) + GetPoint(POINT_CONQUEROR_LEVEL_STEP) - GetPoint(POINT_CONQUEROR_POINT));
+
+	SetConquerorExp(0);
+
+	ComputePoints();
+	PointsPacket();
+	UpdatePointsPacket(POINT_CONQUEROR_EXP, GetConquerorExp());
+}
+
+void CHARACTER::SetSungMaWill()
+{
+	if (IsPC() == false)
+		return;
+
+	if (GetConquerorLevel() <= 0)
+		return;
+
+	TSungMaWillMap::iterator it = SungMaWillMap.find(GetMapIndex());
+	if (it != SungMaWillMap.end())
+		ChatPacket(CHAT_TYPE_COMMAND, "SungMaAttr %d %d %d %d", it->second.str, it->second.hp, it->second.move, it->second.immune);
+}
+
+uint8_t CHARACTER::GetSungMaWill(uint8_t type) const
+{
+	if (IsPC() == false)
+		return 0;
+
+	if (GetConquerorLevel() <= 0)
+		return 0;
+
+	TSungMaWillMap::iterator it = SungMaWillMap.find(GetMapIndex());
+	if (it != SungMaWillMap.end())
+	{
+		switch (type)
+		{
+		case POINT_SUNGMA_STR:
+			return it->second.str;
+		case POINT_SUNGMA_HP:
+			return it->second.hp;
+		case POINT_SUNGMA_MOVE:
+			return it->second.move;
+		case POINT_SUNGMA_IMMUNE:
+			return it->second.immune;
+		default:
+			return 0;
+		}
+	}
+	return 0;
+}
+#endif
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/char.h final/server/server/home/metin2/Source/Server/game/src/char.h
--- baseline/server/server/home/metin2/Source/Server/game/src/char.h	2026-02-18 18:38:50.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/char.h	2022-04-27 12:12:32.000000000 +0000
@@ -1,6 +1,8 @@
 #ifndef __INC_CHAR_H__
 #define __INC_CHAR_H__
 
+#include <boost/unordered_map.hpp>
+
 #include "../../common/stl.h"
 #include "entity.h"
 #include "FSM.h"
@@ -11,54 +13,15 @@
 #include "affect_flag.h"
 #include "cube.h"
 #include "mining.h"
-#include "packet.h"
-
-#if defined(__LUCKY_BOX__)
-#	include "item_manager.h"
-#endif
-#if defined(__CHANGE_LOOK_SYSTEM__)
-#	include "changelook.h"
+#if defined(__MINI_GAME_CATCH_KING__)
+#	include "packet.h"
 #endif
 #if defined(__MAILBOX__)
 #	include "MailBox.h"
 #endif
-#if defined(__GEM_SHOP__)
-#	include "GemShop.h"
-#endif
-#if defined(__RANKING_SYSTEM__)
-#	include "Ranking.h"
-#endif
-#if defined(__MINI_GAME_RUMI__)
-#	include "minigame_rumi.h"
-#endif
-#if defined(__MINI_GAME_YUTNORI__)
-#	include "minigame_yutnori.h"
-#endif
-#if defined(__MINI_GAME_CATCH_KING__)
-#	include "minigame_catchking.h"
-#endif
-#if defined(__FLOWER_EVENT__)
-#	include "flower_event.h"
-#endif
-#if defined(__SUMMER_EVENT_ROULETTE__)
-#	include "minigame_roulette.h"
-#endif
-#if defined(__INGAME_EVENT_MANAGER__)
-#	include "ingame_event_manager.h"
-#endif
-
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-#	include "guild_dragonlair.h"
-#endif
 
 class CBuffOnAttributes;
 class CPetSystem;
-#if defined(__LOOT_FILTER_SYSTEM__)
-class CLootFilter;
-#endif
-#ifdef __OFFLINE_SHOP__
-class COfflineShop;
-#endif
 
 #define INSTANT_FLAG_DEATH_PENALTY (1 << 0)
 #define INSTANT_FLAG_SHOP (1 << 1)
@@ -71,30 +34,29 @@
 #define AI_FLAG_HELPER (1 << 2)
 #define AI_FLAG_STAYZONE (1 << 3)
 
+#if defined(__MINI_GAME_OKEY__)
+#	define MAX_CARDS_IN_HAND 5
+#	define MAX_CARDS_IN_FIELD 3
+#endif
+
 #define SET_OVER_TIME(ch, time) (ch)->SetOverTime(time)
 
 #ifdef __GROWTH_PET_SYSTEM__
 #include "growth_pet.h"
 #endif
+
 extern int g_nPortalLimitTime;
 
-extern bool IS_SUMMON_ITEM(LPITEM item, int map_index = 0);
+extern bool IS_SUMMON_ITEM(int vnum);
 extern bool IS_SUMMONABLE_ZONE(int map_index);
 
 extern bool IS_MONKEY_DUNGEON(int map_index);
 extern bool IS_MAZE_DUNGEON(int map_index);
 
-#if defined(__SNOW_DUNGEON__)
-extern bool IS_SNOW_DUNGEON(int map_index);
-#endif
-
-#if defined(__ELEMENTAL_DUNGEON__)
-extern bool IS_ELEMENTAL_DUNGEON(int map_index);
-#endif
-
 extern bool CAN_ENTER_ZONE(const LPCHARACTER& ch, int map_index);
-extern bool IS_BLOCKED_PET(int map_index); // char.cpp
-extern bool IS_BLOCKED_PET_DUNGEON_MAP(int map_index);
+extern bool IS_BLOCKED_PET_SUMMON_MAP(int map_index, bool isHorse);
+extern bool IS_BLOCKED_MOUNT_SUMMON_MAP(int map_index);
+extern bool IS_BLOCKED_MOUNT_DUNGEON_MAP(int map_index);
 
 enum
 {
@@ -120,6 +82,9 @@
 	AI_CHANGE_ATTACK_POISITION_TIME_FAR = 1000,
 	AI_CHANGE_ATTACK_POISITION_DISTANCE = 100,
 	SUMMON_MONSTER_COUNT = 3,
+#if defined(__EREBUS_DUNGEON__)
+	SUMMON_HEALER_COUNT = 4,
+#endif
 };
 
 enum
@@ -145,10 +110,6 @@
 	FLY_QUIVER_ATTACK_NORMAL,
 #endif
 #if defined(__CONQUEROR_LEVEL__)
-	FLY_ILGWANGPYO_NORMAL,
-	FLY_ILGWANGPYO_MASTER,
-	FLY_ILGWANGPYO_GRAND_MASTER,
-	FLY_ILGWANGPYO_PERFECT_MASTER,
 	FLY_CONQUEROR_EXP,
 #endif
 };
@@ -181,74 +142,6 @@
 	DAMAGE_BLEEDING = (1 << 6),
 };
 
-enum EPKModes
-{
-	PK_MODE_PEACE,
-	PK_MODE_REVENGE,
-	PK_MODE_FREE,
-	PK_MODE_PROTECT,
-	PK_MODE_GUILD,
-	PK_MODE_MAX_NUM
-};
-
-enum EPositions
-{
-	POS_DEAD,
-	POS_SLEEPING,
-	POS_RESTING,
-	POS_SITTING,
-	POS_FISHING,
-	POS_FIGHTING,
-	POS_MOUNTING,
-	POS_STANDING
-};
-
-enum EBlockAction
-{
-	BLOCK_EXCHANGE = (1 << 0),
-	BLOCK_PARTY_INVITE = (1 << 1),
-	BLOCK_GUILD_INVITE = (1 << 2),
-	BLOCK_WHISPER = (1 << 3),
-	BLOCK_MESSENGER_INVITE = (1 << 4),
-	BLOCK_PARTY_REQUEST = (1 << 5),
-};
-
-#ifdef __OFFLINE_SHOP__
-enum EUnlockShopSkin
-{
-	UNLOCK_SHOP_SKIN_1 = (1 << 0),
-	UNLOCK_SHOP_SKIN_2 = (1 << 1),
-	UNLOCK_SHOP_SKIN_3 = (1 << 2),
-	UNLOCK_SHOP_SKIN_4 = (1 << 3),
-	UNLOCK_SHOP_SKIN_5 = (1 << 4),
-	UNLOCK_SHOP_SKIN_6 = (1 << 5),
-	UNLOCK_SHOP_SKIN_7 = (1 << 6),
-	UNLOCK_SHOP_SKIN_8 = (1 << 7),
-};
-
-enum EUnlockShopBanner
-{
-	UNLOCK_SHOP_BANNER_1 = (1 << 0),
-	UNLOCK_SHOP_BANNER_2 = (1 << 1),
-	UNLOCK_SHOP_BANNER_3 = (1 << 2),
-	UNLOCK_SHOP_BANNER_4 = (1 << 3),
-	UNLOCK_SHOP_BANNER_5 = (1 << 4),
-};
-#endif
-
-enum EAlignmentGrade
-{
-	ALIGN_GRADE_GOOD_4,
-	ALIGN_GRADE_GOOD_3,
-	ALIGN_GRADE_GOOD_2,
-	ALIGN_GRADE_GOOD_1,
-	ALIGN_GRADE_NORMAL,
-	ALIGN_GRADE_EVIL_1,
-	ALIGN_GRADE_EVIL_2,
-	ALIGN_GRADE_EVIL_3,
-	ALIGN_GRADE_EVIL_4,
-};
-
 enum EPointTypes
 {
 	POINT_NONE,								// 0
@@ -447,229 +340,94 @@
 	POINT_RESIST_CLAW = 142,				// 142
 
 #if defined(__ACCE_COSTUME_SYSTEM__)
-	POINT_ACCEDRAIN_RATE,
+	POINT_ACCEDRAIN_RATE,					// 143
 #endif
+
 #if defined(__MAGIC_REDUCTION__)
-	POINT_RESIST_MAGIC_REDUCTION,
+	POINT_RESIST_MAGIC_REDUCTION,			// 144
 #endif
+
+#if defined(__ELEMENT_SYSTEM__)
+	POINT_ENCHANT_ELECT,					// 145
+	POINT_ENCHANT_FIRE,						// 146
+	POINT_ENCHANT_ICE,						// 147
+	POINT_ENCHANT_WIND,						// 148
+	POINT_ENCHANT_EARTH,					// 149
+	POINT_ENCHANT_DARK,						// 150
+	POINT_ATTBONUS_CZ,						// 151
+	POINT_ATTBONUS_SWORD,					// 152
+	POINT_ATTBONUS_TWOHAND,					// 153
+	POINT_ATTBONUS_DAGGER,					// 154
+	POINT_ATTBONUS_BELL,					// 155
+	POINT_ATTBONUS_FAN,						// 156
+	POINT_ATTBONUS_BOW,						// 157
+	POINT_ATTBONUS_CLAW,					// 158
+	POINT_RESIST_HUMAN,						// 159
+#endif
+	POINT_ATTBONUS_STONE,					// 160
+
+	// 20220314.owsap   Ʈ.
+	POINT_RESERVED_200 = 200,
+	POINT_RESERVED_201,
+	POINT_RESERVED_202,
+	POINT_RESERVED_203,
+	POINT_RESERVED_204,
+
+#if defined(__CONQUEROR_LEVEL__)
+	POINT_SUNGMA_STR = 219,
+	POINT_SUNGMA_HP = 220,
+	POINT_SUNGMA_MOVE = 221,
+	POINT_SUNGMA_IMMUNE = 222,
+
+	POINT_CONQUEROR_LEVEL = 223,
+	POINT_CONQUEROR_LEVEL_STEP = 224,
+	POINT_CONQUEROR_EXP = 225,
+	POINT_CONQUEROR_NEXT_EXP = 226,
+	POINT_CONQUEROR_POINT = 227,
+#endif
+
+	// 20220314.owsap Ư Ʈ   ֹ.
+	POINT_RESERVED_240 = 240,
 #if defined(__CHEQUE_SYSTEM__)
-	POINT_CHEQUE,
+	POINT_CHEQUE = 241,
 #endif
-	POINT_BATTLE_POINT,
-	POINT_RESIST_HUMAN,
-	POINT_ENCHANT_ELECT,
-	POINT_ENCHANT_FIRE,
-	POINT_ENCHANT_ICE,
-	POINT_ENCHANT_WIND,
-	POINT_ENCHANT_EARTH,
-	POINT_ENCHANT_DARK,
-	POINT_ATTBONUS_CZ,
-	POINT_BEAD,
 #if defined(__GEM_SYSTEM__)
-	POINT_GEM,
-#endif
-	POINT_ATTBONUS_SWORD,
-	POINT_ATTBONUS_TWOHAND,
-	POINT_ATTBONUS_DAGGER,
-	POINT_ATTBONUS_BELL,
-	POINT_ATTBONUS_FAN,
-	POINT_ATTBONUS_BOW,
-	POINT_ATTBONUS_CLAW,
-	POINT_RESIST_MOUNT_FALL,
-	POINT_RESIST_FIST,
-	POINT_PREMIUM_EXPBONUS,
-	POINT_PRIVILEGE_EXPBONUS,
-	POINT_MARRIAGE_EXPBONUS,
-	POINT_DEVILTOWER_EXPBONUS,
-	POINT_PREMIUM_ITEMBONUS,
-	POINT_PRIVILEGE_ITEMBONUS,
-	POINT_PREMIUM_GOLDBONUS,
-	POINT_PRIVILEGE_GOLDBONUS,
-	POINT_SKILL_DAMAGE_SAMYEON,
-	POINT_SKILL_DAMAGE_TANHWAN,
-	POINT_SKILL_DAMAGE_PALBANG,
-	POINT_SKILL_DAMAGE_GIGONGCHAM,
-	POINT_SKILL_DAMAGE_GYOKSAN,
-	POINT_SKILL_DAMAGE_GEOMPUNG,
-	POINT_SKILL_DAMAGE_AMSEOP,
-	POINT_SKILL_DAMAGE_GUNGSIN,
-	POINT_SKILL_DAMAGE_CHARYUN,
-	POINT_SKILL_DAMAGE_SANGONG,
-	POINT_SKILL_DAMAGE_YEONSA,
-	POINT_SKILL_DAMAGE_KWANKYEOK,
-	POINT_SKILL_DAMAGE_GIGUNG,
-	POINT_SKILL_DAMAGE_HWAJO,
-	POINT_SKILL_DAMAGE_SWAERYUNG,
-	POINT_SKILL_DAMAGE_YONGKWON,
-	POINT_SKILL_DAMAGE_PABEOB,
-	POINT_SKILL_DAMAGE_MARYUNG,
-	POINT_SKILL_DAMAGE_HWAYEOMPOK,
-	POINT_SKILL_DAMAGE_MAHWAN,
-	POINT_SKILL_DAMAGE_BIPABU,
-	POINT_SKILL_DAMAGE_YONGBI,
-	POINT_SKILL_DAMAGE_PAERYONG,
-	POINT_SKILL_DAMAGE_NOEJEON,
-	POINT_SKILL_DAMAGE_BYEURAK,
-	POINT_SKILL_DAMAGE_CHAIN,
-	POINT_SKILL_DAMAGE_CHAYEOL,
-	POINT_SKILL_DAMAGE_SALPOONG,
-	POINT_SKILL_DAMAGE_GONGDAB,
-	POINT_SKILL_DAMAGE_PASWAE,
-	POINT_NORMAL_HIT_DEFEND_BONUS_BOSS_OR_MORE,
-	POINT_SKILL_DEFEND_BONUS_BOSS_OR_MORE,
-	POINT_NORMAL_HIT_DAMAGE_BONUS_BOSS_OR_MORE,
-	POINT_SKILL_DAMAGE_BONUS_BOSS_OR_MORE,
-	POINT_HIT_BUFF_ENCHANT_FIRE,
-	POINT_HIT_BUFF_ENCHANT_ICE,
-	POINT_HIT_BUFF_ENCHANT_ELEC,
-	POINT_HIT_BUFF_ENCHANT_WIND,
-	POINT_HIT_BUFF_ENCHANT_DARK,
-	POINT_HIT_BUFF_ENCHANT_EARTH,
-	POINT_HIT_BUFF_RESIST_FIRE,
-	POINT_HIT_BUFF_RESIST_ICE,
-	POINT_HIT_BUFF_RESIST_ELEC,
-	POINT_HIT_BUFF_RESIST_WIND,
-	POINT_HIT_BUFF_RESIST_DARK,
-	POINT_HIT_BUFF_RESIST_EARTH,
-	POINT_USE_SKILL_CHEONGRANG_MOV_SPEED,
-	POINT_USE_SKILL_CHEONGRANG_CASTING_SPEED,
-	POINT_USE_SKILL_CHAYEOL_CRITICAL_PCT,
-	POINT_USE_SKILL_SANGONG_ATT_GRADE_BONUS,
-	POINT_USE_SKILL_GIGUNG_ATT_GRADE_BONUS,
-	POINT_USE_SKILL_JEOKRANG_DEF_BONUS,
-	POINT_USE_SKILL_GWIGEOM_DEF_BONUS,
-	POINT_USE_SKILL_TERROR_ATT_GRADE_BONUS,
-	POINT_USE_SKILL_MUYEONG_ATT_GRADE_BONUS,
-	POINT_USE_SKILL_MANASHILED_CASTING_SPEED,
-	POINT_USE_SKILL_HOSIN_DEF_BONUS,
-	POINT_USE_SKILL_GICHEON_ATT_GRADE_BONUS,
-	POINT_USE_SKILL_JEONGEOP_ATT_GRADE_BONUS,
-	POINT_USE_SKILL_JEUNGRYEOK_DEF_BONUS,
-	POINT_USE_SKILL_GIHYEOL_ATT_GRADE_BONUS,
-	POINT_USE_SKILL_CHUNKEON_CASTING_SPEED,
-	POINT_USE_SKILL_NOEGEOM_ATT_GRADE_BONUS,
-	POINT_SKILL_DURATION_INCREASE_EUNHYUNG,
-	POINT_SKILL_DURATION_INCREASE_GYEONGGONG,
-	POINT_SKILL_DURATION_INCREASE_GEOMKYUNG,
-	POINT_SKILL_DURATION_INCREASE_JEOKRANG,
-	POINT_USE_SKILL_PALBANG_HP_ABSORB,
-	POINT_USE_SKILL_AMSEOP_HP_ABSORB,
-	POINT_USE_SKILL_YEONSA_HP_ABSORB,
-	POINT_USE_SKILL_YONGBI_HP_ABSORB,
-	POINT_USE_SKILL_CHAIN_HP_ABSORB,
-	POINT_USE_SKILL_PASWAE_SP_ABSORB,
-	POINT_USE_SKILL_GIGONGCHAM_STUN,
-	POINT_USE_SKILL_CHARYUN_STUN,
-	POINT_USE_SKILL_PABEOB_STUN,
-	POINT_USE_SKILL_MAHWAN_STUN,
-	POINT_USE_SKILL_GONGDAB_STUN,
-	POINT_USE_SKILL_SAMYEON_STUN,
-	POINT_USE_SKILL_GYOKSAN_KNOCKBACK,
-	POINT_USE_SKILL_SEOMJEON_KNOCKBACK,
-	POINT_USE_SKILL_SWAERYUNG_KNOCKBACK,
-	POINT_USE_SKILL_HWAYEOMPOK_KNOCKBACK,
-	POINT_USE_SKILL_GONGDAB_KNOCKBACK,
-	POINT_USE_SKILL_KWANKYEOK_KNOCKBACK,
-	POINT_USE_SKILL_SAMYEON_NEXT_COOLTIME_DECREASE_10PER,
-	POINT_USE_SKILL_GEOMPUNG_NEXT_COOLTIME_DECREASE_10PER,
-	POINT_USE_SKILL_GUNGSIN_NEXT_COOLTIME_DECREASE_10PER,
-	POINT_USE_SKILL_KWANKYEOK_NEXT_COOLTIME_DECREASE_10PER,
-	POINT_USE_SKILL_YONGKWON_NEXT_COOLTIME_DECREASE_10PER,
-	POINT_USE_SKILL_MARYUNG_NEXT_COOLTIME_DECREASE_10PER,
-	POINT_USE_SKILL_BIPABU_NEXT_COOLTIME_DECREASE_10PER,
-	POINT_USE_SKILL_NOEJEON_NEXT_COOLTIME_DECREASE_10PER,
-	POINT_USE_SKILL_SALPOONG_NEXT_COOLTIME_DECREASE_10PER,
-	POINT_USE_SKILL_PASWAE_NEXT_COOLTIME_DECREASE_10PER,
-	POINT_ATTBONUS_STONE,
-	POINT_DAMAGE_HP_RECOVERY,
-	POINT_DAMAGE_SP_RECOVERY,
-	POINT_ALIGNMENT_DAMAGE_BONUS,
-	POINT_NORMAL_DAMAGE_GUARD,
-	POINT_MORE_THEN_HP90_DAMAGE_REDUCE,
-	POINT_USE_SKILL_TUSOK_HP_ABSORB,
-	POINT_USE_SKILL_PAERYONG_HP_ABSORB,
-	POINT_USE_SKILL_BYEURAK_HP_ABSORB,
-	POINT_USE_SKILL_SAMYEON_NEXT_COOLTIME_DECREASE_20PER,
-	POINT_USE_SKILL_GEOMPUNG_NEXT_COOLTIME_DECREASE_20PER,
-	POINT_USE_SKILL_GUNGSIN_NEXT_COOLTIME_DECREASE_20PER,
-	POINT_USE_SKILL_KWANKYEOK_NEXT_COOLTIME_DECREASE_20PER,
-	POINT_USE_SKILL_YONGKWON_NEXT_COOLTIME_DECREASE_20PER,
-	POINT_USE_SKILL_MARYUNG_NEXT_COOLTIME_DECREASE_20PER,
-	POINT_USE_SKILL_BIPABU_NEXT_COOLTIME_DECREASE_20PER,
-	POINT_USE_SKILL_NOEJEON_NEXT_COOLTIME_DECREASE_20PER,
-	POINT_USE_SKILL_SALPOONG_NEXT_COOLTIME_DECREASE_20PER,
-	POINT_USE_SKILL_PASWAE_NEXT_COOLTIME_DECREASE_20PER,
-	POINT_USE_SKILL_CHAYEOL_HP_ABSORB,
-	POINT_MEDAL_OF_HONOR,
-	POINT_ALL_STAT_BONUS,
-	POINT_SUNGMA_STR,
-	POINT_SUNGMA_HP,
-	POINT_SUNGMA_MOVE,
-	POINT_SUNGMA_IMMUNE,
-	POINT_CONQUEROR_LEVEL,
-	POINT_CONQUEROR_LEVEL_STEP,
-	POINT_CONQUEROR_EXP,
-	POINT_CONQUEROR_NEXT_EXP,
-	POINT_CONQUEROR_POINT,
-	POINT_HIT_PCT,
-	POINT_ATTBONUS_PER_HUMAN,
-	POINT_ATTBONUS_PER_ANIMAL,
-	POINT_ATTBONUS_PER_ORC,
-	POINT_ATTBONUS_PER_MILGYO,
-	POINT_ATTBONUS_PER_UNDEAD,
-	POINT_ATTBONUS_PER_DEVIL,
-	POINT_ENCHANT_PER_ELECT,
-	POINT_ENCHANT_PER_FIRE,
-	POINT_ENCHANT_PER_ICE,
-	POINT_ENCHANT_PER_WIND,
-	POINT_ENCHANT_PER_EARTH,
-	POINT_ENCHANT_PER_DARK,
-	POINT_ATTBONUS_PER_CZ,
-	POINT_ATTBONUS_PER_INSECT,
-	POINT_ATTBONUS_PER_DESERT,
-	POINT_ATTBONUS_PER_STONE,
-	POINT_ATTBONUS_PER_MONSTER,
-	POINT_RESIST_PER_HUMAN,
-	POINT_RESIST_PER_ICE,
-	POINT_RESIST_PER_DARK,
-	POINT_RESIST_PER_EARTH,
-	POINT_RESIST_PER_FIRE,
-	POINT_RESIST_PER_ELEC,
-	POINT_RESIST_PER_MAGIC,
-	POINT_RESIST_PER_WIND,
-	POINT_HIT_BUFF_SUNGMA_STR,
-	POINT_HIT_BUFF_SUNGMA_MOVE,
-	POINT_HIT_BUFF_SUNGMA_HP,
-	POINT_HIT_BUFF_SUNGMA_IMMUNE,
-	POINT_MOUNT_MELEE_MAGIC_ATTBONUS_PER,
-	POINT_DISMOUNT_MOVE_SPEED_BONUS_PER,
-	POINT_HIT_AUTO_HP_RECOVERY,
-	POINT_HIT_AUTO_SP_RECOVERY,
-	POINT_USE_SKILL_COOLTIME_DECREASE_ALL,
-	POINT_HIT_STONE_ATTBONUS_STONE,
-	POINT_HIT_STONE_DEF_GRADE_BONUS,
-	POINT_KILL_BOSS_ITEM_BONUS,
-	POINT_MOB_HIT_MOB_AGGRESSIVE,
-	POINT_NO_DEATH_AND_HP_RECOVERY30,
-	POINT_AUTO_PICKUP,
-	POINT_MOUNT_NO_KNOCKBACK,
-	POINT_SUNGMA_PER_STR,
-	POINT_SUNGMA_PER_HP,
-	POINT_SUNGMA_PER_MOVE,
-	POINT_SUNGMA_PER_IMMUNE,
-	POINT_IMMUNE_POISON100,
-	POINT_IMMUNE_BLEEDING100,
-	POINT_MONSTER_DEFEND_BONUS,
-
-	// Ŭ̾Ʈ Ʈ
-	POINT_MIN_WEP,
-	POINT_MAX_WEP,
-	POINT_MIN_MAGIC_WEP,
-	POINT_MAX_MAGIC_WEP,
-	POINT_HIT_RATE,
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	POINT_BATTLE_PASS_PREMIUM_ID
+	POINT_GEM = 242,
 #endif
+
+	//POINT_MAX_NUM = 255, // common/length.h
+};
+
+enum EPKModes
+{
+	PK_MODE_PEACE,
+	PK_MODE_REVENGE,
+	PK_MODE_FREE,
+	PK_MODE_PROTECT,
+	PK_MODE_GUILD,
+	PK_MODE_MAX_NUM
+};
+
+enum EPositions
+{
+	POS_DEAD,
+	POS_SLEEPING,
+	POS_RESTING,
+	POS_SITTING,
+	POS_FISHING,
+	POS_FIGHTING,
+	POS_MOUNTING,
+	POS_STANDING
+};
+
+enum EBlockAction
+{
+	BLOCK_EXCHANGE = (1 << 0),
+	BLOCK_PARTY_INVITE = (1 << 1),
+	BLOCK_GUILD_INVITE = (1 << 2),
+	BLOCK_WHISPER = (1 << 3),
+	BLOCK_MESSENGER_INVITE = (1 << 4),
+	BLOCK_PARTY_REQUEST = (1 << 5),
 };
 
 // <Factor> Dynamically evaluated CHARACTER* equivalent.
@@ -711,46 +469,47 @@
 /* ϴ  */
 typedef struct character_point
 {
-	POINT_VALUE lPoints[POINT_MAX_NUM];
+	int64_t points[POINT_MAX_NUM];
 
-	BYTE bJob;
-	BYTE bVoice;
+	BYTE job;
+	BYTE voice;
 
-	BYTE bLevel;
-	DWORD dwExp;
+	BYTE level;
+	DWORD exp;
 
 #if defined(__CONQUEROR_LEVEL__)
-	BYTE bConquerorLevel;
-	DWORD dwConquerorExp;
+	BYTE conqueror_level;
+	DWORD conqueror_exp;
 #endif
 
-	int iGold;
+	long long gold;
 #if defined(__CHEQUE_SYSTEM__)
-	int iCheque;
+	int cheque;
 #endif
 #if defined(__GEM_SYSTEM__)
-	int iGem;
+	int gem;
 #endif
 
-	int iHP, iSP;
-	int iRandomHP, iRandomSP;
-	int iStamina;
+	int64_t hp;
+	int64_t sp;
 
-	BYTE bSkillGroup;
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	int battle_pass_premium_id;
-#endif
+	int iRandomHP;
+	int iRandomSP;
+
+	int stamina;
+
+	BYTE skill_group;
 } CHARACTER_POINT;
 
 /*  ʴ ĳ  */
 typedef struct character_point_instant
 {
-	POINT_VALUE points[POINT_MAX_NUM];
+	long long points[POINT_MAX_NUM];
 
 	float fRot;
 
-	int iMaxHP;
-	int iMaxSP;
+	int64_t iMaxHP;
+	int64_t iMaxSP;
 
 	long position;
 
@@ -759,37 +518,25 @@
 	DWORD dwImmuneFlag;
 	DWORD dwLastShoutPulse;
 
-	DWORD adwParts[PART_MAX_NUM];
+	WORD parts[PART_MAX_NUM];
 
-	LPITEM pInventoryItems[INVENTORY_MAX_NUM];
-	WORD wInventoryItemGrid[INVENTORY_MAX_NUM];
+	LPITEM pItems[INVENTORY_AND_EQUIP_SLOT_MAX];
+	WORD bItemGrid[INVENTORY_AND_EQUIP_SLOT_MAX];
 
-	LPITEM pEquipmentItems[EQUIPMENT_MAX_NUM];
-	BYTE bEquipmentItemGrid[EQUIPMENT_MAX_NUM];
-
-#if defined(__DRAGON_SOUL_SYSTEM__)
 	// ȥ κ丮.
-	LPITEM pDragonSoulInventoryItems[DRAGON_SOUL_INVENTORY_MAX_NUM];
-	WORD wDragonSoulInventoryItemGrid[DRAGON_SOUL_INVENTORY_MAX_NUM];
-#endif
+	LPITEM pDSItems[DRAGON_SOUL_INVENTORY_MAX_NUM];
+	WORD wDSItemGrid[DRAGON_SOUL_INVENTORY_MAX_NUM];
 
-	LPITEM pBeltInventoryItems[BELT_INVENTORY_MAX_NUM];
-	BYTE bBeltInventoryItemGrid[BELT_INVENTORY_MAX_NUM];
-
-#if !defined(__CUBE_RENEWAL__)
 	// by mhh
 	LPITEM pCubeItems[CUBE_MAX_NUM];
-#endif
 	LPCHARACTER pCubeNpc;
-#if defined(__MOVE_COSTUME_ATTR__)
-	LPCHARACTER pItemCombNpc;
-#endif
-#if defined(__SUMMER_EVENT_ROULETTE__)
-	LPCHARACTER pRouletteNPC;
+#if defined(__ACCE_COSTUME_SYSTEM__)
+	LPITEM pAcceMaterials[ACCE_WINDOW_MAX_MATERIALS];
 #endif
-#if defined(__ATTR_6TH_7TH__)
-	LPITEM pNPCStorageItems;
+#if defined(__CHANGE_LOOK_SYSTEM__)
+	LPITEM pChangeLookMaterials[CHANGE_LOOK_WINDOW_MAX_MATERIALS];
 #endif
+	LPCHARACTER battle_victim;
 
 	BYTE gm_level;
 
@@ -798,19 +545,9 @@
 	int iMaxStamina;
 
 	BYTE bBlockMode;
-#ifdef __OFFLINE_SHOP__
-	BYTE bUnlockedShopSkin;
-	BYTE bUnlockedShopBanner;
-#endif
+
 	int iDragonSoulActiveDeck;
-	int iDragonSoulRefineDeckSnapshot;
 	LPENTITY m_pDragonSoulRefineWindowOpener;
-#if defined(__ACCE_COSTUME_SYSTEM__)
-	LPENTITY m_pAcceRefineWindowOpener;
-#endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-	LPENTITY m_pAuraRefineWindowOpener;
-#endif
 } CHARACTER_POINT_INSTANT;
 
 #define TRIGGERPARAM LPCHARACTER ch, LPCHARACTER causer
@@ -849,7 +586,7 @@
 	DWORD dwVID;
 	bool isGrandMaster;
 
-	std::unordered_map<DWORD, std::size_t> TargetVIDMap;
+	boost::unordered_map<DWORD, size_t> TargetVIDMap;
 
 	TSkillUseInfo()
 		: iHitCount(0), iMaxHitCount(0), iSplashCount(0), dwNextSkillUsableTime(0), iRange(0), bUsed(false),
@@ -869,9 +606,6 @@
 class CSkillProto;
 class CParty;
 class CDungeon;
-#if defined(__DEFENSE_WAVE__)
-class CDefenseWave;
-#endif
 class CWarMap;
 class CAffect;
 class CGuild;
@@ -901,7 +635,7 @@
 };
 
 typedef std::list<CAffect*> AffectContainerList;
-typedef std::unordered_map<DWORD, BYTE> AffectStackMap;
+typedef TR1_NS::unordered_map<DWORD, BYTE> AffectStackMap;
 typedef std::map<int, LPEVENT> MobSkillEventMap;
 
 class CHARACTER : public CEntity, public CFSM, public CHorseRider
@@ -942,7 +676,7 @@
 public:
 	DWORD GetAIFlag() const { return m_pointsInstant.dwAIFlag; }
 
-	void SetAggressive(bool bSet = true);
+	void SetAggressive();
 	bool IsAggressive() const;
 
 	void SetCoward();
@@ -961,13 +695,9 @@
 	void SetAttackMob();
 	bool IsAttackMob() const;
 
-	void SetNoMove();
-	bool IsNoMove() const;
-
 	virtual void BeginStateEmpty();
 	virtual void EndStateEmpty() {}
 
-	void Restart(BYTE bSubCMD);
 	void RestartAtSamePos();
 
 protected:
@@ -989,6 +719,15 @@
 	//////////////////////////////////////////////////////////////////////////////////
 	// Basic Points
 
+#if defined(__SEND_TARGET_INFO__)
+private:
+	DWORD dwLastTargetInfoPulse;
+
+public:
+	DWORD GetLastTargetInfoPulse() const { return dwLastTargetInfoPulse; }
+	void SetLastTargetInfoPulse(DWORD pulse) { dwLastTargetInfoPulse = pulse; }
+#endif
+
 public:
 	DWORD GetPlayerID() const { return m_dwPlayerID; }
 
@@ -1002,6 +741,13 @@
 	void SaveReal(); //  
 	void FlushDelayedSaveItem();
 
+#if defined(__EXTENDED_BLEND_AFFECT__)
+	bool UseExtendedBlendAffect(LPITEM item, int affect_type, int apply_type, int apply_value, int apply_duration);
+#endif
+#if defined(__BLEND_AFFECT__)
+	bool SetBlendAffect(LPITEM item);
+#endif
+
 	const char* GetName() const;
 	const VID& GetVID() const { return m_vid; }
 
@@ -1023,6 +769,7 @@
 
 	bool IsPC() const { return GetDesc() ? true : false; }
 	bool IsNPC() const { return m_bCharType != CHAR_TYPE_PC; }
+
 	bool IsMonster() const { return m_bCharType == CHAR_TYPE_MONSTER; }
 	bool IsStone() const { return m_bCharType == CHAR_TYPE_STONE; }
 	bool IsDoor() const { return m_bCharType == CHAR_TYPE_DOOR; }
@@ -1030,36 +777,30 @@
 	bool IsWarp() const { return m_bCharType == CHAR_TYPE_WARP; }
 	bool IsGoto() const { return m_bCharType == CHAR_TYPE_GOTO; }
 	bool IsHorse() const { return m_bCharType == CHAR_TYPE_HORSE; }
-	bool IsPetPay() const { return m_bCharType == CHAR_TYPE_PET_PAY; }
-	//bool IsPet() const { return m_bCharType == CHAR_TYPE_PET; }
 
 	DWORD GetLastShoutPulse() const { return m_pointsInstant.dwLastShoutPulse; }
 	void SetLastShoutPulse(DWORD pulse) { m_pointsInstant.dwLastShoutPulse = pulse; }
-
-	BYTE GetGMLevel() const;
-	BOOL IsGM() const;
-	void SetGMLevel();
-
-	void SetLevel(BYTE bValue);
-	BYTE GetLevel() const { return m_points.bLevel; }
-
-	void SetExp(DWORD dwValue) { m_points.dwExp = dwValue; }
-	DWORD GetExp() const { return m_points.dwExp; }
-	DWORD GetNextExp() const;
+	int GetLevel() const { return m_points.level; }
+	void SetLevel(BYTE level);
 
 #if defined(__CONQUEROR_LEVEL__)
 	void SetConqueror(bool bSet = true);
+	int GetConquerorLevel() const { return m_points.conqueror_level; }
+	void SetConquerorLevel(BYTE level) { m_points.conqueror_level = level; }
 
-	void SetConquerorLevel(BYTE bValue) { m_points.bConquerorLevel = bValue; }
-	BYTE GetConquerorLevel() const { return m_points.bConquerorLevel; }
-
-	void SetConquerorExp(DWORD dwValue) { m_points.dwConquerorExp = dwValue; }
-	DWORD GetConquerorExp() const { return m_points.dwConquerorExp; }
-	DWORD GetNextConquerorExp() const;
+	DWORD GetConquerorExp() const { return m_points.conqueror_exp; }
+	void SetConquerorExp(DWORD exp) { m_points.conqueror_exp = exp; }
+	DWORD GetConquerorNextExp() const;
 #endif
 
-	LPCHARACTER DistributeExp(); //     Ѵ.
+	BYTE GetGMLevel() const;
+	BOOL IsGM() const;
+	void SetGMLevel();
 
+	DWORD GetExp() const { return m_points.exp; }
+	void SetExp(DWORD exp) { m_points.exp = exp; }
+	DWORD GetNextExp() const;
+	LPCHARACTER DistributeExp(); //     Ѵ.
 	void DistributeHP(LPCHARACTER pkKiller);
 	void DistributeSP(LPCHARACTER pkKiller, int iMethod = 0);
 
@@ -1067,48 +808,50 @@
 	bool IsPosition(int pos) const { return m_pointsInstant.position == pos ? true : false; }
 	int GetPosition() const { return m_pointsInstant.position; }
 
-	void SetPart(BYTE bPartPos, DWORD dwVal);
+	void SetPart(BYTE bPartPos, WORD wVal);
 	DWORD GetPart(BYTE bPartPos) const;
 	DWORD GetOriginalPart(BYTE bPartPos) const;
 
-	void SetHP(int val) { m_points.iHP = val; }
-	int GetHP() const { return m_points.iHP; }
+	void SetHP(int64_t hp) { m_points.hp = hp; }
+	int64_t GetHP() const { return m_points.hp; }
 
-	void SetSP(int val) { m_points.iSP = val; }
-	int GetSP() const { return m_points.iSP; }
+	void SetSP(int64_t sp) { m_points.sp = sp; }
+	int64_t GetSP() const { return m_points.sp; }
 
-	void SetMaxHP(int val) { m_pointsInstant.iMaxHP = val; }
-	int GetMaxHP() const { return m_pointsInstant.iMaxHP; }
+	void SetMaxHP(int64_t iVal) { m_pointsInstant.iMaxHP = iVal; }
+#if defined(__CONQUEROR_LEVEL__)
+	int64_t GetMaxHP() const;
+#else
+	int64_t GetMaxHP() const { return m_pointsInstant.iMaxHP; }
+#endif
 
-	void SetMaxSP(int val) { m_pointsInstant.iMaxSP = val; }
-	int GetMaxSP() const { return m_pointsInstant.iMaxSP; }
+	void SetMaxSP(int64_t iVal) { m_pointsInstant.iMaxSP = iVal; }
+	int64_t GetMaxSP() const { return m_pointsInstant.iMaxSP; }
 
-	void SetStamina(int iValue) { m_points.iStamina = iValue; }
-	int GetStamina() const { return m_points.iStamina; }
+	void SetStamina(int64_t stamina) { m_points.stamina = stamina; }
+	int64_t GetStamina() const { return m_points.stamina; }
 
-	void SetMaxStamina(int iValue) { m_pointsInstant.iMaxStamina = iValue; }
-	int GetMaxStamina() const { return m_pointsInstant.iMaxStamina; }
+	void SetMaxStamina(int64_t iVal) { m_pointsInstant.iMaxStamina = iVal; }
+	int64_t GetMaxStamina() const { return m_pointsInstant.iMaxStamina; }
 
-	void SetRandomHP(int iValue) { m_points.iRandomHP = iValue; }
-	int GetRandomHP() const { return m_points.iRandomHP; }
+	void SetRandomHP(int v) { m_points.iRandomHP = v; }
+	void SetRandomSP(int v) { m_points.iRandomSP = v; }
 
-	void SetRandomSP(int iValue) { m_points.iRandomSP = iValue; }
+	int GetRandomHP() const { return m_points.iRandomHP; }
 	int GetRandomSP() const { return m_points.iRandomSP; }
 
 	int GetHPPct() const;
 
-	void SetRealPoint(POINT_TYPE wPointType, POINT_VALUE lPointValue);
-	POINT_VALUE GetRealPoint(POINT_TYPE wPointType) const;
+	void SetRealPoint(BYTE idx, int64_t val);
+	int64_t GetRealPoint(BYTE idx) const;
 
-	void SetPoint(POINT_TYPE wPointType, POINT_VALUE lPointValue);
-	POINT_VALUE GetPoint(POINT_TYPE wPointType) const;
-
-	POINT_VALUE GetLimitPoint(POINT_TYPE wPointType) const;
-	POINT_VALUE GetPolymorphPoint(POINT_TYPE wPointType) const;
+	void SetPoint(BYTE idx, int64_t val);
+	int64_t GetPoint(BYTE idx) const;
+	int64_t GetLimitPoint(BYTE idx) const;
+	int64_t GetPolymorphPoint(BYTE idx) const;
 
 	const TMobTable& GetMobTable() const;
 	BYTE GetMobRank() const;
-	BYTE GetMobType() const;
 	BYTE GetMobBattleType() const;
 	BYTE GetMobSize() const;
 	DWORD GetMobDamageMin() const;
@@ -1119,7 +862,6 @@
 #if defined(__ELEMENT_SYSTEM__)
 	int GetMobElement(BYTE bElement) const;
 #endif
-	float GetMonsterHitRange() const;
 
 	// NEWAI
 	bool IsBerserker() const;
@@ -1136,7 +878,6 @@
 	bool IsDeathBlow() const;
 
 	bool IsHealer() const;
-	bool IsFaller() const;
 
 	bool IsReviver() const;
 	bool HasReviverInParty() const;
@@ -1150,7 +891,9 @@
 
 	int m_newSummonInterval;
 	int m_lastSummonTime;
-
+#if defined(__EREBUS_DUNGEON__)
+	int m_iLastHealerSummonDelay;
+#endif
 	bool CanSummonMonster() const;
 	void MarkSummonedMonster();
 
@@ -1161,20 +904,17 @@
 
 	void ComputePoints();
 	void ComputeBattlePoints();
-
-	void PointChange(POINT_TYPE wPointType, POINT_VALUE lPointAmount, bool bAmount = false, bool bBroadcast = false);
+	void PointChange(BYTE type, int64_t amount, bool bAmount = false, bool bBroadcast = false);
 	void PointsPacket();
-	void UpdatePointsPacket(POINT_TYPE wPointType, POINT_VALUE lPointValue, POINT_VALUE lPointAmount = 0, bool bAmount = false, bool bBroadcast = false);
-
-	void ApplyPoint(POINT_TYPE wApplyType, POINT_VALUE lApplyValue);
+	void UpdatePointsPacket(BYTE type, long long val, long long amount = 0, bool bAmount = false, bool bBroadcast = false);
+	void ApplyPoint(BYTE bApplyType, int iVal);
 	void CheckMaximumPoints(); // HP, SP    ִ밪   ˻ϰ ٸ .
 
-
-	bool Show(long lMapIndex, long x, long y, long z = LONG_MAX, bool bShowSpawnMotion = false
 #if defined(__WJ_SHOW_MOB_INFO__)
-		, bool bAggressive = false
+	bool Show(long lMapIndex, long x, long y, long z = LONG_MAX, bool bShowSpawnMotion = false, bool bAggressive = false);
+#else
+	bool Show(long lMapIndex, long x, long y, long z = LONG_MAX, bool bShowSpawnMotion = false);
 #endif
-	);
 
 	void Sitdown(int is_ground);
 	void Standup();
@@ -1187,30 +927,16 @@
 	void Motion(BYTE motion, LPCHARACTER victim = NULL);
 
 	void ChatPacket(BYTE type, const char* format, ...);
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-	void ChatPacket(packet_chat pack_chat, const char* format, ...);
-#endif
 	void MonsterChat(BYTE bMonsterChatType);
 	void SendGreetMessage();
 
 	void ResetPoint(int iLv);
 	void ResetExp();
 
-#if defined(__CONQUEROR_LEVEL__)
-	void ResetConquerorPoint(int iLv);
-	void ResetConquerorExp();
-#endif
-
 	void SetBlockMode(BYTE bFlag);
 	void SetBlockModeForce(BYTE bFlag);
 	bool IsBlockMode(BYTE bFlag) const { return (m_pointsInstant.bBlockMode & bFlag) ? true : false; }
-#ifdef __OFFLINE_SHOP__
-	void SendUnlockedShopDeco();
-	void SetUnlockShopSkin(BYTE bFlag);
-	void SetUnlockShopBanner(BYTE bFlag);
-	bool IsUnlockedShopSkin(BYTE bFlag) const { return (m_pointsInstant.bUnlockedShopSkin & bFlag) ? true : false; }
-	bool IsUnlockedShopBanner(BYTE bFlag) const { return (m_pointsInstant.bUnlockedShopBanner & bFlag) ? true : false; }
-#endif
+
 	bool IsPolymorphed() const { return m_dwPolymorphRace > 0; }
 	bool IsPolyMaintainStat() const { return m_bPolyMaintainStat; } //   ϴ .
 	void SetPolymorph(DWORD dwRaceNum, bool bMaintainStat = false);
@@ -1220,16 +946,25 @@
 	// FISING
 	void fishing();
 	void fishing_take();
-	bool IsFishing() const { return m_pkFishingEvent ? true : false; }
 	// END_OF_FISHING
 
 	// MINING
 	void mining(LPCHARACTER chLoad);
 	void mining_cancel();
 	void mining_take();
-	bool IsMining() const { return m_pkMiningEvent ? true : false; }
 	// END_OF_MINING
 
+#if defined(__ANTI_EXP_RING__)
+	bool HasFrozenEXP();
+	void FreezeEXP();
+	void UnfreezeEXP();
+#endif
+
+#if defined(__SOUL_SYSTEM__)
+	void UseSoulAttack(BYTE bSoulType);
+	bool CheckSoulItem();
+#endif
+
 	void ResetPlayTime(DWORD dwTimeRemain = 0);
 
 	void CreateFly(BYTE bType, LPCHARACTER pkVictim);
@@ -1247,7 +982,6 @@
 	bool m_bPolyMaintainStat;
 	DWORD m_dwLoginPlayTime;
 	DWORD m_dwPlayerID;
-	DWORD m_dwTargetVID;
 	VID m_vid;
 	std::string m_stName;
 	BYTE m_bCharType;
@@ -1322,6 +1056,9 @@
 	bool StartMoveChannel(long lNewAddr, WORD wNewPort);
 #endif
 
+	BYTE GetLanguage() const;
+	bool ChangeLanguage(BYTE bLanguage);
+
 protected:
 	void ClearSync();
 
@@ -1354,39 +1091,19 @@
 	// Quickslot 
 public:
 	void SyncQuickslot(BYTE bType, WORD wOldPos, WORD wNewPos);
+#if defined(__SWAP_ITEM_SYSTEM__)
+	int GetQuickslotPosition(BYTE bType, WORD bInventoryPos);
+#endif
 	bool GetQuickslot(BYTE pos, TQuickslot** ppSlot);
 	bool SetQuickslot(BYTE pos, TQuickslot& rSlot);
 	bool DelQuickslot(BYTE pos);
 	bool SwapQuickslot(BYTE a, BYTE b);
 	void ChainQuickslotItem(LPITEM pItem, BYTE bType, WORD wOldPos);
-	void MoveQuickSlotItem(BYTE bOldType, WORD wOldPos, BYTE bNewType, WORD wNewPos);
-
-	void CheckQuickSlotItems();
-	bool CanAddToQuickSlot(LPITEM pItem);
 
 protected:
 	TQuickslot m_quickslot[QUICKSLOT_MAX_NUM];
-
-#if defined(__LUCKY_BOX__)
-public:
-	void SetLuckyBoxSrcItem(LPITEM lpItem);
-	void SendLuckyBoxInfo();
-	void LuckyBoxRetry();
-	void LuckyBoxReceive();
-	int GetLuckyBoxPrice() const;
-	bool IsLuckyBoxOpen() const;
-	void ResetLuckyBoxData();
-
-private:
-	struct
-	{
-		DWORD dwSrcItemVNum;
-		DWORD dwSrcItemID;
-		WORD wSrcSlotIndex;
-		BYTE bTryCount;
-		DWORD dwItemVNum;
-		BYTE bItemCount;
-	} m_sLuckyBox;
+#if defined(__SWAP_ITEM_SYSTEM__)
+	std::vector<TQuickslot> m_tmpQuickslots;
 #endif
 
 	////////////////////////////////////////////////////////////////////////////////////////
@@ -1394,23 +1111,10 @@
 public:
 	void StartAffectEvent();
 	void ClearAffect(bool bSave = false);
-	void ComputeAffect(const CAffect* pkAff, bool bAdd);
-	bool AddAffect(DWORD dwType, POINT_TYPE wApplyOn, POINT_VALUE lApplyValue, DWORD dwFlag, long lDuration, long lSPCost, bool bOverride, bool IsCube = false
-#if defined(__AFFECT_RENEWAL__)
-		, bool bRealTime = false
-#endif
-#if defined(__9TH_SKILL__)
-		, long lValue = 0 /* Skill iAmount2 */
-#endif
-	);
-#if defined(__AFFECT_RENEWAL__)
-	bool AddRealTimeAffect(DWORD dwType, POINT_TYPE wApplyOn, POINT_VALUE lApplyValue, DWORD dwFlag, long lDuration, long lSPCost, bool bOverride, bool IsCube = false, bool bRealTime = true);
-#endif
+	void ComputeAffect(CAffect* pkAff, bool bAdd);
+	bool AddAffect(DWORD dwType, BYTE bApplyOn, long lApplyValue, DWORD dwFlag, long lDuration, long lSPCost, bool bOverride, bool IsCube = false);
 	void RefreshAffect();
 	bool RemoveAffect(DWORD dwType);
-#if defined(__SOUL_SYSTEM__)
-	void RemoveAffect(DWORD dwType, POINT_TYPE wApplyType);
-#endif
 	bool IsAffectFlag(DWORD dwAff) const;
 
 	bool UpdateAffect(); // called from EVENT
@@ -1419,6 +1123,22 @@
 	void LoadAffect(DWORD dwCount, TPacketAffectElement* pElements);
 	void SaveAffect();
 
+	struct load_affect_login_event_info
+	{
+		DWORD pid;
+		DWORD count;
+		char* data;
+
+		load_affect_login_event_info()
+			: pid(0)
+			, count(0)
+			, data(0)
+		{
+		}
+	};
+
+	load_affect_login_event_info* affectInfo;
+
 public:
 	// Affect loading  ΰ?
 	bool IsLoadedAffect() const { return m_bIsLoadedAffect; }
@@ -1428,15 +1148,15 @@
 	void RemoveGoodAffect();
 	void RemoveBadAffect();
 
-	CAffect* FindAffect(DWORD dwType, POINT_TYPE wApplyType = APPLY_NONE) const;
+	CAffect* FindAffect(DWORD dwType, BYTE bApply = APPLY_NONE) const;
 	const AffectContainerList& GetAffectContainer() const { return m_list_pkAffect; }
-	bool RemoveAffect(CAffect* pkAff);
+	bool RemoveAffect(CAffect* pkAff, bool single = true);
 
-	//void SetAffectStack(CAffect* pkAff, BYTE value);
-	//BYTE GetAffectStack(CAffect* pkAff);
-	//void ClearAffectStack(CAffect* pkAff);
-	//
-	//AffectStackMap m_map_affectStack;
+	void SetAffectStack(CAffect* pkAff, BYTE value);
+	BYTE GetAffectStack(CAffect* pkAff);
+	void ClearAffectStack(CAffect* pkAff);
+
+	AffectStackMap m_map_affectStack;
 
 protected:
 	bool m_bIsLoadedAffect;
@@ -1476,12 +1196,8 @@
 
 	bool BuildUpdatePartyPacket(TPacketGCPartyUpdate& out);
 	int GetLeadershipSkillLevel() const;
-#if defined(__PARTY_PROFICY__)
 	int GetRoleProficiencySkillLevel() const;
-#endif
-#if defined(__PARTY_INSIGHT__)
 	int GetInSightSkillLevel() const;
-#endif
 
 	bool CanSummon(int iLeaderShip);
 
@@ -1582,27 +1298,48 @@
 
 	void ClearItem();
 
-	LPITEM GetInventoryItem(WORD wCell) const;
-	LPITEM GetEquipmentItem(WORD wCell) const;
-	LPITEM GetDragonSoulInventoryItem(WORD wCell) const;
-	LPITEM GetBeltInventoryItem(WORD wCell) const;
+#if defined(__SORT_INVENTORY_ITEMS__)
+	void SortInventoryItems();
+	void SetSortInventoryPulse(int pulse) { m_sortInventoryPulse = pulse; }
+	int GetSortInventoryPulse() { return m_sortInventoryPulse; }
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	void SortSpecialInventoryItems(BYTE type);
+	void SetSortSpecialInventoryPulse(int pulse) { m_sortSpecialInventoryPulse = pulse; }
+	int GetSortSpecialInventoryPulse() { return m_sortSpecialInventoryPulse; }
+#endif
+#endif
 
-	void SetItem(TItemPos Cell, LPITEM item
 #if defined(__WJ_PICKUP_ITEM_EFFECT__)
-		, bool isHighLight = false
+	void SetItem(TItemPos Cell, LPITEM item, bool isHighLight = false);
+#else
+	void SetItem(TItemPos Cell, LPITEM item);
 #endif
-	);
 
 	LPITEM GetItem(TItemPos Cell) const;
+#if defined(__SWAP_ITEM_SYSTEM__)
+	LPITEM GetItem_NEW(TItemPos Cell) const;
+#endif
+	LPITEM GetInventoryItem(WORD wCell) const;
+	LPITEM GetDragonSoulItem(const WORD& wCell) const;
+
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	LPITEM GetSkillBookInventoryItem(WORD wCell) const;
+	LPITEM GetUpgradeItemsInventoryItem(WORD wCell) const;
+	LPITEM GetStoneInventoryItem(WORD wCell) const;
+	LPITEM GetGiftBoxInventoryItem(WORD wCell) const;
+#endif
 
 	bool IsEmptyItemGrid(TItemPos Cell, BYTE size, int iExceptionCell = -1) const;
+	bool IsEmptyItemGridSpecial(TItemPos Cell, BYTE bSize, int iExceptionCell, std::vector<WORD>& vec) const;
 
-	void SetWear(WORD wCell, LPITEM item);
-	LPITEM GetWear(WORD wCell) const;
+	void SetWear(UINT bCell, LPITEM item);
+	LPITEM GetWear(UINT bCell) const;
 
 	// MYSHOP_PRICE_LIST
 	void UseSilkBotary(void); ///    
-
+#if defined(__MYSHOP_DECO__)
+	void UseDecoBundle(void);
+#endif
 	/// DB ĳ÷  ޾ƿ  Ʈ  ϰ    óѴ.
 	/**
 	* @param [in] p  Ʈ Ŷ
@@ -1633,7 +1370,7 @@
 	void ProcessRecallItem(LPITEM item);
 
 	// void PotionPacket(int iPotionType);
-	void EffectPacket(BYTE bEffectNum, BYTE bEffectType = SE_TYPE_NORMAL, const PIXEL_POSITION& rEffectPos = { 0, 0, 0 });
+	void EffectPacket(int enumEffectType);
 	void SpecificEffectPacket(const char filename[128]);
 
 	// ADD_MONSTER_REFINE
@@ -1641,14 +1378,7 @@
 	// END_OF_ADD_MONSTER_REFINE
 
 	bool DoRefineWithScroll(LPITEM item);
-	bool RefineInformation(WORD wCell, BYTE bType, int iAdditionalCell = -1);
-
-	struct SRefineScrollData
-	{
-		BYTE bSuccessProb;
-		bool bKeepGrade;
-	};
-	SRefineScrollData GetScrollRefinePct(BYTE bProb, BYTE bRefineLevel, BYTE bScrollType);
+	bool RefineInformation(BYTE bCell, BYTE bType, int iAdditionalCell = -1);
 
 	void SetRefineMode(int iAdditionalCell = -1);
 	void ClearRefineMode();
@@ -1661,71 +1391,43 @@
 	bool GiveItemFromSpecialItemGroup(DWORD dwGroupNum);
 
 	bool MoveItem(TItemPos pos, TItemPos change_pos, WORD num);
-	bool PickupItem(DWORD vid
-#if defined(__PET_LOOT_AI__)
-		, bool PetLoot = false
-#endif
-	);
+	bool PickupItem(DWORD vid);
 	bool EquipItem(LPITEM item, int iCandidateCell = -1);
 	bool UnequipItem(LPITEM item);
-
 	//  item   ִ  Ȯϰ, Ұ ϴٸ ĳͿ  ˷ִ Լ
 	bool CanEquipNow(const LPITEM item, const TItemPos& srcCell = NPOS, const TItemPos& destCell = NPOS);
+
 	//  item   ִ  Ȯϰ, Ұ ϴٸ ĳͿ  ˷ִ Լ
 	bool CanUnequipNow(const LPITEM item, const TItemPos& srcCell = NPOS, const TItemPos& destCell = NPOS);
+	//  item   ִ  Ȯϰ, Ұ ϴٸ ĳͿ  ˷ִ Լ
+	// bool CanUnequipNow(const LPITEM item, const TItemPos& swapCell = NPOS);
 
-	bool SwapItem(WORD wCell, WORD wDestCell);
-
-	LPITEM AutoGiveItem(DWORD dwItemVnum, WORD wCount = 1, int iRarePct = -1, bool bMsg = true
-#if defined(__WJ_PICKUP_ITEM_EFFECT__)
-		, bool isHighLight = false
-#endif
-#if defined(__NEW_USER_CARE__)
-		, bool bSystemDrop = true
-#endif
-	);
-
-	void AutoGiveItem(LPITEM item, bool longOwnerShip = false, bool bMsg = true
+	bool SwapItem(UINT bCell, UINT bDestCell);
 #if defined(__WJ_PICKUP_ITEM_EFFECT__)
-		, bool isHighLight = false
+	LPITEM AutoGiveItem(DWORD dwItemVnum, WORD bCount = 1, int iRarePct = -1, bool bMsg = true, bool isHighLight = false);
+	void AutoGiveItem(LPITEM item, bool longOwnerShip = false, bool isHighLight = false);
+#else
+	LPITEM AutoGiveItem(DWORD dwItemVnum, WORD wCount = 1, int iRarePct = -1, bool bMsg = true);
+	void AutoGiveItem(LPITEM item, bool longOwnerShip = false);
 #endif
-	);
 
 	int GetEmptyInventory(BYTE size) const;
 	int GetEmptyInventoryCount(BYTE size) const;
-
-#if defined(__DRAGON_SOUL_SYSTEM__)
 	int GetEmptyDragonSoulInventory(LPITEM pItem) const;
-	void CopyDragonSoulItemGrid(std::vector<WORD>& vDragonSoulItemGrid) const;
+	int GetEmptyDragonSoulInventoryWithExceptions(LPITEM pItem, std::vector<WORD>& vec /*= -1*/) const;
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	int GetEmptySkillBookInventory(BYTE size) const;
+	int GetEmptyUpgradeItemsInventory(BYTE size) const;
+	int GetEmptyStoneInventory(BYTE size) const;
+	int GetEmptyGiftBoxInventory(BYTE size) const;
 #endif
+	void CopyDragonSoulItemGrid(std::vector<WORD>& vDragonSoulItemGrid) const;
 
 	int CountEmptyInventory() const;
-	bool HasEnoughInventorySpace(std::vector<TItemData>& vItems) const;
 
-	int CountSpecifyItem(DWORD vnum, int iExceptionCell = -1
-#if defined(__SOUL_BIND_SYSTEM__)
-		, bool bIgnoreSealedItem = false
-#endif
-#if defined(__SET_ITEM__)
-		, bool bIgnoreSetValue = false
-#endif
-	) const;
-	void RemoveSpecifyItem(DWORD vnum, DWORD count = 1, int iExceptionCell = -1
-#if defined(__SOUL_BIND_SYSTEM__)
-		, bool bIgnoreSealedItem = false
-#endif
-#if defined(__SET_ITEM__)
-		, bool bIgnoreSetValue = false
-#endif
-	);
-	LPITEM FindSpecifyItem(DWORD dwVnum
-#if defined(__SOUL_BIND_SYSTEM__)
-		, bool bIgnoreSealedItem = false
-#endif
-#if defined(__SET_ITEM__)
-		, bool bIgnoreSetValue = false
-#endif
-	) const;
+	int CountSpecifyItem(DWORD vnum, int iExceptionCell = -1) const;
+	void RemoveSpecifyItem(DWORD vnum, DWORD count = 1, int iExceptionCell = -1);
+	LPITEM FindSpecifyItem(DWORD vnum) const;
 	LPITEM FindItemByID(DWORD id) const;
 
 	int CountSpecifyTypeItem(BYTE type) const;
@@ -1737,7 +1439,7 @@
 	bool IsEquipUniqueGroup(DWORD dwGroupVnum) const;
 	// END_OF_CHECK_UNIQUE_GROUP
 
-	void SendEquipment(LPCHARACTER pChar);
+	void SendEquipment(LPCHARACTER ch);
 	// End of Item
 
 protected:
@@ -1746,11 +1448,11 @@
 	* @param [in] dwItemVnum  vnum
 	* @param [in] dwItemPrice  
 	**/
-	void SendMyShopPriceListCmd(DWORD dwItemVnum, DWORD dwItemPrice
 #if defined(__CHEQUE_SYSTEM__)
-		, DWORD dwItemCheque
+	void SendMyShopPriceListCmd(DWORD dwItemVnum, DWORD dwItemPrice, DWORD dwItemPriceCheque);
+#else
+	void SendMyShopPriceListCmd(DWORD dwItemVnum, DWORD dwItemPrice);
 #endif
-	);
 
 	bool m_bNoOpenedShop; ///< ̹   λ   ִ (  ٸ true)
 
@@ -1764,30 +1466,38 @@
 	bool m_bUnderRefine;
 	DWORD m_dwRefineNPCVID;
 
-public:
-	int GetGold() const { return m_points.iGold; }
-	void SetGold(int iValue) { m_points.iGold = iValue; }
-
-	bool DropGold(int iAmount);
-	void GiveGold(int iAmount); // Ƽ  Ƽ й, α  ó
+	int m_sortInventoryPulse;
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	int m_sortSpecialInventoryPulse;
+#endif
 
-	int GetAllowedGold() const;
+public:
+	////////////////////////////////////////////////////////////////////////////////////////
+	// Money related
+	long long GetGold() const { return m_points.gold; }
+	void SetGold(long long gold) { m_points.gold = gold; }
+	bool DropGold(INT gold);
+	long long GetAllowedGold() const;
+	void GiveGold(long long llAmount); // Ƽ  Ƽ й, α  ó
+	// End of Money
 
 #if defined(__CHEQUE_SYSTEM__)
 	////////////////////////////////////////////////////////////////////////////////////////
 	// Cheque related
-	int GetCheque() const { return m_points.iCheque; }
-	void SetCheque(int iValue) { m_points.iCheque = iValue; }
-	bool DropCheque(int iAmount);
-	void GiveCheque(int iAmount);
+	INT GetCheque() const { return m_points.cheque; }
+	void SetCheque(INT cheque) { m_points.cheque = cheque; }
+	bool DropCheque(INT cheque);
+	void GiveCheque(INT iAmount);
 	// End of Cheque
 #endif
 
 #if defined(__GEM_SYSTEM__)
 	////////////////////////////////////////////////////////////////////////////////////////
-	int GetGem() const { return m_points.iGem; }
-	void SetGem(int iValue) { m_points.iGem = iValue; }
-	void GiveGem(int iAmount);
+	// Gem related
+	INT GetGem() const { return m_points.gem; }
+	void SetGem(INT gem) { m_points.gem = gem; }
+	void GiveGem(INT iAmount);
+	// End of Gem
 #endif
 
 	////////////////////////////////////////////////////////////////////////////////////////
@@ -1800,12 +1510,7 @@
 	void SetShopOwner(LPCHARACTER ch) { m_pkChrShopOwner = ch; }
 	LPCHARACTER GetShopOwner() const { return m_pkChrShopOwner; }
 
-#ifdef __OFFLINE_SHOP__
-	void SetShowOfflineShop(DWORD option) { dwIsShowShops = option; UpdateSectree();}
-	DWORD GetShowOfflineShop()  const { return dwIsShowShops;}
-#endif
-
-	void OpenMyShop(const char* c_pszSign, TShopItemTable* pTable, BYTE bItemCount);
+	void OpenMyShop(const char* c_pszSign, TShopItemTable* pTable, WORD wItemCount);
 	LPSHOP GetMyShop() const { return m_pkMyShop; }
 	void CloseMyShop();
 
@@ -1816,8 +1521,13 @@
 	LPCHARACTER m_pkChrShopOwner;
 	// End of shop
 
-#ifdef __OFFLINE_SHOP__
-	DWORD dwIsShowShops;
+#if defined(__SKILL_COLOR_SYSTEM__)
+public:
+	void SetSkillColor(DWORD* dwSkillColor);
+	DWORD* GetSkillColor() { return m_dwSkillColor[0]; }
+
+protected:
+	DWORD m_dwSkillColor[ESkillColorLength::MAX_SKILL_COUNT + ESkillColorLength::MAX_BUFF_COUNT][ESkillColorLength::MAX_EFFECT_COUNT];
 #endif
 
 	////////////////////////////////////////////////////////////////////////////////////////
@@ -1831,6 +1541,13 @@
 	CExchange* m_pkExchange;
 	// End of Exchange
 
+public:
+	void SetDamage(int iDmg) { iDamage = iDmg; }
+	int GetDamage() { return iDamage; }
+
+private:
+	int iDamage;
+
 	////////////////////////////////////////////////////////////////////////////////////////
 	// Battle
 public:
@@ -1876,7 +1593,7 @@
 	bool Shoot(BYTE bType);
 	void FlyTarget(DWORD dwTargetVID, long x, long y, BYTE bHeader);
 
-	void ForgetMyAttacker(bool bRevive = true);
+	void ForgetMyAttacker();
 	void AggregateMonster();
 	void AttractRanger();
 	void PullMonster();
@@ -1900,8 +1617,6 @@
 	int GetRealAlignment() const;
 	void ShowAlignment(bool bShow);
 
-	UINT GetAlignmentGrade() const;
-
 	void SetKillerMode(bool bOn);
 	bool IsKillerMode() const;
 	void UpdateKillerMode();
@@ -1932,9 +1647,6 @@
 	void SkipComboAttackByTime(int interval);
 	DWORD GetSkipComboAttackByTime() const;
 
-		// Flood guard: rate-limit FUNC_COMBO packets (DoS mitigation)
-		bool CheckComboFlood(DWORD dwTime);
-
 protected:
 	BYTE m_bComboSequence;
 	DWORD m_dwLastComboTime;
@@ -1942,8 +1654,6 @@
 	BYTE m_bComboIndex;
 	int m_iComboHackCount;
 	DWORD m_dwSkipComboAttackByTime;
-	DWORD m_dwComboFloodWindow;
-	BYTE m_bComboFloodCount;
 
 protected:
 	void UpdateAggrPointEx(LPCHARACTER ch, EDamageType type, int dam, TBattleInfo& info);
@@ -1965,6 +1675,16 @@
 	int m_iMaxAggro;
 	// End of Battle
 
+#if defined(__MOUNT_COSTUME_SYSTEM__)
+	// Ride after Death
+public:
+	void MountAfterDeath();
+	bool WasRidingBeforeDeath() { return m_bWasRidingBeforeDeath; }
+	void WasRidingBeforeDeath(bool bWasRiding) { m_bWasRidingBeforeDeath = bWasRiding; }
+
+	void RidingItemBeforeDeath(LPITEM item) { m_pRidingItemBeforeDeath = item; }
+	LPITEM RidingItemBeforeDeath() { return m_pRidingItemBeforeDeath; }
+#endif
 	// Stone
 public:
 	void SetStone(LPCHARACTER pkChrStone);
@@ -1993,6 +1713,9 @@
 	};
 
 	void SkillLevelPacket();
+#if defined(__7AND8TH_SKILLS__)
+	bool SkillCanUp(DWORD dwVnum);
+#endif
 	void SkillLevelUp(DWORD dwVnum, BYTE bMethod = SKILL_UP_BY_POINT);
 	bool SkillLevelDown(DWORD dwVnum);
 	// ADD_GRANDMASTER_SKILL
@@ -2019,19 +1742,13 @@
 	void SkillLearnWaitMoreTimeMessage(DWORD dwVnum);
 
 	void ComputePassiveSkill(DWORD dwVnum);
-#ifdef ENABLE_QUEEN_NETHIS
-	int ComputeSnakeSkill(DWORD dwVnum, LPCHARACTER pkVictim, BYTE bSkillLevel);
-#endif
 	int ComputeSkill(DWORD dwVnum, LPCHARACTER pkVictim, BYTE bSkillLevel = 0);
 	int ComputeSkillParty(DWORD dwVnum, LPCHARACTER pkVictim, BYTE bSkillLevel = 0);
 	int ComputeSkillAtPosition(DWORD dwVnum, const PIXEL_POSITION& posTarget, BYTE bSkillLevel = 0);
-#if defined(__PVP_BALANCE_IMPROVING__)
-	int ComputeGyeongGongSkill(DWORD dwVnum, LPCHARACTER pkVictim, BYTE bSkillLevel = 0);
-#endif
 	void ComputeSkillPoints();
 
 	void SetSkillGroup(BYTE bSkillGroup);
-	BYTE GetSkillGroup() const { return m_points.bSkillGroup; }
+	BYTE GetSkillGroup() const { return m_points.skill_group; }
 
 	int ComputeCooltime(int time);
 
@@ -2042,10 +1759,6 @@
 	bool LearnSkillByBook(DWORD dwSkillVnum, BYTE bProb = 0);
 	bool LearnGrandMasterSkill(DWORD dwSkillVnum);
 
-#if defined(__CONQUEROR_LEVEL__)
-	bool IsConquerorSkill(DWORD dwVnum) const;
-#endif
-
 private:
 	bool m_bDisableCooltime;
 	DWORD m_dwLastSkillTime; ///<  skill   ð(millisecond).
@@ -2068,24 +1781,13 @@
 	void StartMuyeongEvent();
 	void StopMuyeongEvent();
 
-#if defined(__PVP_BALANCE_IMPROVING__)
-	void StartGyeongGongEvent();
-	void StopGyeongGongEvent();
-#endif
-
 #if defined(__9TH_SKILL__)
-	void StartCheonunEvent(BYTE bChance, BYTE bDuration);
+	void StartCheonunEvent(long lApplyValue);
 	void StopCheonunEvent();
 #endif
 
 private:
 	LPEVENT m_pkMuyeongEvent;
-#ifdef ENABLE_QUEEN_NETHIS
-	LPEVENT m_pkSnakeSkillEvent;
-#endif
-#if defined(__PVP_BALANCE_IMPROVING__)
-	LPEVENT m_pkGyeongGongEvent;
-#endif
 #if defined(__9TH_SKILL__)
 	LPEVENT m_pkCheonunEvent;
 #endif
@@ -2117,7 +1819,7 @@
 	//
 protected:
 	TPlayerSkill* m_pSkillLevels;
-	std::unordered_map<BYTE, int> m_SkillDamageBonus;
+	boost::unordered_map<BYTE, int> m_SkillDamageBonus;
 	std::map<int, TSkillUseInfo> m_SkillUseInfo;
 
 	////////////////////////////////////////////////////////////////////////////////////////
@@ -2160,7 +1862,6 @@
 	void ClearTarget();
 	void CheckTarget();
 	LPCHARACTER GetTarget() const { return m_pkChrTarget; }
-	LPCHARACTER GetTargetSafe();
 
 	////////////////////////////////////////////////////////////////////////////////////////
 	// Safebox
@@ -2200,9 +1901,6 @@
 	void SetSafeboxOpenPosition();
 	float GetDistanceFromSafeboxOpen() const;
 
-	void LoadSafeboxBuff();
-	void SetSafeboxBuff();
-
 protected:
 	CSafebox* m_pkSafebox;
 	int m_iSafeboxSize;
@@ -2240,7 +1938,7 @@
 	virtual void SendHorseInfo();
 	virtual void ClearHorseInfo();
 
-	void HorseSummon(bool bSummon, bool bFromFar = false, DWORD dwVnum = 0, const char* pHorseName = 0);
+	void HorseSummon(bool bSummon, bool bFromFar = false, DWORD dwVnum = 0, const char* name = 0);
 
 	LPCHARACTER GetHorse() const { return m_chHorse; } //  ȯ 
 	LPCHARACTER GetRider() const; // rider on horse
@@ -2257,49 +1955,50 @@
 
 public:
 #endif
-
+		//bool	IsPet() const { return m_bCharType == CHAR_TYPE_PET_PAY; }
+		bool	IsGrowthPet() { return m_bCharType == CHAR_TYPE_PET; };
+		
 #ifdef __GROWTH_PET_SYSTEM__
-public:
-	bool	IsPet() const { return m_bCharType == CHAR_TYPE_PET_PAY; }
-	bool	IsGrowthPet() { return m_bCharType == CHAR_TYPE_PET; };
-	void	SetInvincible(bool bInvincible) { m_bInvincible = bInvincible; }
-	bool	IsInvincible() { return m_bInvincible; }
+		void	SetInvincible(bool bInvincible) { m_bInvincible = bInvincible; }
+		bool	IsInvincible() { return m_bInvincible; }
 
-	void	SetPetHatchWindow(bool bState) { m_bIsPetHatchOpen = bState; }
-	bool	IsPetHatchWindowOpen() { return m_bIsPetHatchOpen; }
-	void	SetPetChangeNameWindow(bool bState) { m_bIsPetChangeNameOpen = bState; }
-	bool	IsPetChangeNameWindowOpen() { return m_bIsPetChangeNameOpen; }
+		void	SetPetHatchWindow(bool bState) { m_bIsPetHatchOpen = bState; }
+		bool	IsPetHatchWindowOpen() { return m_bIsPetHatchOpen; }
+		void	SetPetChangeNameWindow(bool bState) { m_bIsPetChangeNameOpen = bState; }
+		bool	IsPetChangeNameWindowOpen() { return m_bIsPetChangeNameOpen; }
 
-	void	SetPetWindowType(BYTE bType) { m_bPetWindowType = bType; }
-	BYTE	GetPetWindowType() const { return m_bPetWindowType; }
+		void	SetPetWindowType(BYTE bType) { m_bPetWindowType = bType; }
+		BYTE	GetPetWindowType() { return m_bPetWindowType; }
 
-	void	SetGrowthPetLoaded(bool bState) { m_bIsGrowthPetLoaded = bState; }
-	bool	IsGrowthPetLoaded() { return m_bIsGrowthPetLoaded; }
+		void	SetGrowthPetLoaded(bool bState) { m_bIsGrowthPetLoaded = bState; }
+		bool	IsGrowthPetLoaded() { return m_bIsGrowthPetLoaded; }
 
-	void	SetCharacterSize(BYTE bSize) { m_bCharacterSize = bSize; }
-	BYTE	GetCharacterSize() { return m_bCharacterSize; }
+		void	SetCharacterSize(BYTE bSize) { m_bCharacterSize = bSize; }
+		BYTE	GetCharacterSize() { return m_bCharacterSize; }
 
-	bool			SetGrowthPet(LPGROWTH_PET pkPet);
-	bool			DeleteGrowthPet(DWORD dwID);
-	LPGROWTH_PET	GetGrowthPet(DWORD dwID);
-	void			ClearGrowthPet();
+		bool			SetGrowthPet(LPGROWTH_PET pkPet);
+		bool			DeleteGrowthPet(DWORD dwID);
+		LPGROWTH_PET	GetGrowthPet(DWORD dwID);
+		void			ClearGrowthPet();
 
-	void			SetActiveGrowthPet(LPGROWTH_PET pkPet) { m_activeGrowthPet = pkPet;  }
-	LPGROWTH_PET	GetActiveGrowthPet() { return m_activeGrowthPet; }
+		void			SetActiveGrowthPet(LPGROWTH_PET pkPet) { m_activeGrowthPet = pkPet;  }
+		LPGROWTH_PET	GetActiveGrowthPet() { return m_activeGrowthPet; }
 
-private:
-	DWORD	m_bInvincible;
-	bool	m_bIsPetHatchOpen;
-	bool	m_bIsPetChangeNameOpen;
-	BYTE	m_bPetWindowType;
+		void			SendDeadPetMessage();
 
-	bool	m_bIsGrowthPetLoaded;
+	private:
+		DWORD	m_bInvincible;
+		bool	m_bIsPetHatchOpen;
+		bool	m_bIsPetChangeNameOpen;
+		BYTE	m_bPetWindowType;
 
-	CGrowthPetManager::TGrowthPetMap m_growthPetMap;
-	LPGROWTH_PET m_activeGrowthPet;
+		bool	m_bIsGrowthPetLoaded;
 
-	BYTE m_bCharacterSize;
-#endif
+		CGrowthPetManager::TGrowthPetMap	m_growthPetMap;
+		LPGROWTH_PET	m_activeGrowthPet;
+
+		BYTE			m_bCharacterSize;
+#endif 
 
 protected:
 	LPCHARACTER m_chHorse;
@@ -2373,7 +2072,6 @@
 	void SetQuestFlag(const std::string& flag, int value);
 
 	void ConfirmWithMsg(const char* szMsg, int iTimeout, DWORD dwRequestPID);
-	bool IsRunningQuest() const;
 
 private:
 	DWORD m_dwQuestNPCVID;
@@ -2428,9 +2126,6 @@
 	LPEVENT m_pkPoisonEvent;
 	LPEVENT m_pkBleedingEvent;
 	LPEVENT m_pkFireEvent;
-#if defined(__DAWNMIST_DUNGEON__)
-	LPEVENT m_pkHealEvent;
-#endif
 	LPEVENT m_pkWarpNPCEvent;
 	// DELAYED_WARP
 	// END_DELAYED_WARP
@@ -2524,7 +2219,7 @@
 	// END_PREVENT_TRADE_WINDOW
 
 public:
-	int GetSkillPowerByLevel(int iLevel, bool bMob = false) const;
+	int GetSkillPowerByLevel(int level, bool bMob = false) const;
 
 	// PREVENT_REFINE_HACK
 	int GetRefineTime() const { return m_iRefineTime; }
@@ -2548,6 +2243,25 @@
 	int GetMyShopTime() const { return m_iMyShopTime; }
 	void SetMyShopTime() { m_iMyShopTime = thecore_pulse(); }
 
+#if defined(__MYSHOP_DECO__)
+public:
+	BYTE GetMyShopDecoType() const { return m_bMyShopDecoType; }
+	void SetMyShopDecoType(BYTE bType) { m_bMyShopDecoType = bType; }
+
+	DWORD GetMyShopDecoPolyVnum() const { return m_dwMyShopDecoPolyVnum; }
+	void SetMyShopDecoPolyVnum(DWORD dwPolyVnum) { m_dwMyShopDecoPolyVnum = dwPolyVnum; }
+
+	BYTE GetMyShopTabs() const { return m_bMyShopTabs; }
+	void SetMyShopTabs(BYTE bTabs) { m_bMyShopTabs = bTabs; }
+
+private:
+	BYTE m_bMyShopDecoType;
+	DWORD m_dwMyShopDecoPolyVnum;
+	BYTE m_bMyShopTabs;
+
+public:
+#endif
+
 	// PREVENT_TRADE_WINDOW
 	bool PreventTradeWindow(int flags, bool except = false) const;
 	// END_PREVENT_TRADE_WINDOW
@@ -2592,12 +2306,9 @@
 public:
 	bool ItemProcess_Polymorph(LPITEM item);
 
-#if !defined(__CUBE_RENEWAL__)
 	// by mhh
 	LPITEM* GetCubeItem() { return m_pointsInstant.pCubeItems; }
-#endif
 	bool IsCubeOpen() const { return (m_pointsInstant.pCubeNpc ? true : false); }
-	LPCHARACTER GetCubeNpc() const { return m_pointsInstant.pCubeNpc; }
 	void SetCubeNpc(LPCHARACTER npc) { m_pointsInstant.pCubeNpc = npc; }
 	bool CanDoCube() const;
 
@@ -2623,6 +2334,9 @@
 
 private:
 	void __OpenPrivateShop();
+#if defined(__MYSHOP_DECO__)
+	void __OpenMyShopDeco();
+#endif
 
 public:
 	struct AttackedLog
@@ -2665,7 +2379,11 @@
 	DWORD GetLastPlay() const { return m_dwLastPlay; }
 
 public:
+#if defined(__MOUNT_COSTUME_SYSTEM__)
+	bool UnEquipSpecialRideUniqueItem(bool isOnDeath);
+#else
 	bool UnEquipSpecialRideUniqueItem();
+#endif
 
 	bool CanWarp() const;
 	bool IsInSafezone() const;
@@ -2685,10 +2403,10 @@
 	void BuffOnAttr_RemoveBuffsFromItem(LPITEM pItem);
 
 private:
-	void BuffOnAttr_ValueChange(POINT_TYPE wPointType, POINT_VALUE lOldValue, POINT_VALUE lNewValue);
+	void BuffOnAttr_ValueChange(BYTE bType, BYTE bOldValue, BYTE bNewValue);
 	void BuffOnAttr_ClearAll();
 
-	typedef std::map<DWORD, CBuffOnAttributes*> TMapBuffOnAttrs;
+	typedef std::map <BYTE, CBuffOnAttributes*> TMapBuffOnAttrs;
 	TMapBuffOnAttrs m_map_buff_on_attrs;
 	//  : Ȱ ׽Ʈ Ͽ.
 
@@ -2735,28 +2453,6 @@
 	void SetItemAward_cmd(char* cmd) { strcpy(itemAward_cmd, cmd); }
 	//void SetItemAward_flag(bool flag) { itemAward_flag = flag; }
 
-#if defined(__MOVE_COSTUME_ATTR__)
-public:
-	void ItemCombination(const short MediumIndex, const short BaseIndex, const short MaterialIndex);
-	void OpenItemComb();
-
-	bool IsItemComb() const { return m_pointsInstant.pItemCombNpc != NULL; }
-	void SetItemCombNpc(const LPCHARACTER npc) { m_pointsInstant.pItemCombNpc = npc; }
-#endif
-
-#if defined(__CHANGED_ATTR__)
-public:
-	void SelectAttr(LPITEM material, LPITEM item);
-	void SelectAttrResult(const bool bNew, const TItemPos& pos);
-	bool IsSelectAttr() const;
-private:
-	struct SItemSelectAttr
-	{
-		DWORD dwItemID;
-		TPlayerItemAttribute Attr[ITEM_ATTRIBUTE_MAX_NUM];
-	} m_ItemSelectAttr;
-#endif
-
 #if defined(__MINI_GAME_CATCH_KING__)
 public:
 	void MiniGameCatchKingSetFieldCards(std::vector<TCatchKingCard> vec) { m_vecCatchKingFieldCards = vec; }
@@ -2787,7 +2483,6 @@
 	DWORD dwCatchKingTotalScore;
 #endif
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
 public:
 	// ȥ
 
@@ -2800,7 +2495,7 @@
 
 	int DragonSoul_GetActiveDeck() const;
 	bool DragonSoul_IsDeckActivated() const;
-	bool DragonSoul_ActivateDeck(int iDeckIdx);
+	bool DragonSoul_ActivateDeck(int deck_idx);
 
 	void DragonSoul_DeactivateAll();
 	// ݵ ClearItem  ҷ Ѵ.
@@ -2815,24 +2510,15 @@
 	void DragonSoul_CleanUp();
 
 #if defined(__DS_SET__)
-	// Dragon Soul Set Bonus
-public:
-	void DragonSoul_SetBonus();
-	void DragonSoul_ActivateAll();
+	void DragonSoul_HandleSetBonus(/*bool bSet = true*/);
 #endif
 
 	// ȥ ȭâ
 public:
 	bool DragonSoul_RefineWindow_Open(LPENTITY pEntity);
-#if defined(__DS_CHANGE_ATTR__)
-	bool DragonSoul_RefineWindow_ChangeAttr_Open(LPENTITY pEntity);
-#endif
 	bool DragonSoul_RefineWindow_Close();
 	LPENTITY DragonSoul_RefineWindow_GetOpener() { return m_pointsInstant.m_pDragonSoulRefineWindowOpener; }
-	int DragonSoul_RefineWindow_GetDeckSnapshot() const { return m_pointsInstant.iDragonSoulRefineDeckSnapshot; }
-	void DragonSoul_RefineWindow_SetDeckSnapshot(int iDeck) { m_pointsInstant.iDragonSoulRefineDeckSnapshot = iDeck; }
 	bool DragonSoul_RefineWindow_CanRefine();
-#endif
 
 private:
 	// SyncPosition ǿϿ Ÿ ̻    ϱ Ͽ,
@@ -2845,462 +2531,218 @@
 	void SetSyncHackCount(int iCount) { m_iSyncHackCount = iCount; }
 	int GetSyncHackCount() { return m_iSyncHackCount; }
 
-#if defined(__CHANGE_LOOK_SYSTEM__)
+#if defined(__HIDE_COSTUME_SYSTEM__)
 public:
-	void SetChangeLook(CChangeLook* c);
-	CChangeLook* GetChangeLook() const;
-protected:
-	CChangeLook* m_pkChangeLook;
-#endif
+	void SetHideCostumePulse(int iPulse) { m_HideCostumePulse = iPulse; }
+	int GetHideCostumePulse() { return m_HideCostumePulse; }
 
-#if defined(__MAILBOX__)
-public:
-	int GetMyMailBoxTime() const { return m_iMyMailBoxTime; }
-	void SetMyMailBoxTime() { m_iMyMailBoxTime = thecore_pulse(); }
+	void SetBodyCostumeHidden(bool hidden);
+	bool IsBodyCostumeHidden() const { return m_bHideBodyCostume; };
 
-	void SetMailBox(CMailBox* m);
+	void SetHairCostumeHidden(bool hidden);
+	bool IsHairCostumeHidden() const { return m_bHideHairCostume; };
 
-	void SetMailBoxLoading(const bool b) { bMailBoxLoading = b; }
-	bool IsMailBoxLoading() const { return bMailBoxLoading; }
-
-	CMailBox* GetMailBox() const { return m_pkMailBox; }
-
-private:
-	CMailBox* m_pkMailBox;
-	bool bMailBoxLoading;
-	int m_iMyMailBoxTime;
-#endif
-
-#if defined(__MINI_GAME_RUMI__)
-public:
-	void SetMiniGameRumi(CMiniGameRumi* pClass);
-	CMiniGameRumi* GetMiniGameRumi() const { return m_pkMiniGameRumi; }
-private:
-	CMiniGameRumi* m_pkMiniGameRumi;
+#if defined(__ACCE_COSTUME_SYSTEM__)
+	void SetAcceCostumeHidden(bool hidden);
+	bool IsAcceCostumeHidden() const { return m_bHideAcceCostume; };
 #endif
 
-#if defined(__CONQUEROR_LEVEL__)
-public:
-	bool IsNewWorldMapIndex() const;
-	long GetNewWorldSungMa(POINT_TYPE wPointType, bool bPremium = true) const;
-	bool IsSungMaCursed(POINT_TYPE wPointType) const;
+#if defined(__WEAPON_COSTUME_SYSTEM__)
+	void SetWeaponCostumeHidden(bool hidden);
+	bool IsWeaponCostumeHidden() const { return m_bHideWeaponCostume; };
 #endif
 
-#if defined(__LOOT_FILTER_SYSTEM__)
-public:
-	CLootFilter* GetLootFilter();
-	void SetLootFilter();
-	void ClearLootFilter();
 private:
-	CLootFilter* m_pLootFilter;
+	int m_HideCostumePulse;
+	bool m_bHideBodyCostume;
+	bool m_bHideHairCostume;
+#if defined(__ACCE_COSTUME_SYSTEM__)
+	bool m_bHideAcceCostume;
 #endif
-
-#if defined(__ATTR_6TH_7TH__)
-public:
-	bool IsOpenAttr67Add() const { return m_bIsOpenAttr67Add ? true : false; }
-	void SetOpenAttr67Add(bool bOpen) { m_bIsOpenAttr67Add = bOpen; }
-
-	LPITEM GetNPCStorageItem(BYTE bCell = 0) const;
-	bool Attr67Add(const TAttr67AddData kAttr67AddData);
-
-private:
-	bool m_bIsOpenAttr67Add;
+#if defined(__WEAPON_COSTUME_SYSTEM__)
+	bool m_bHideWeaponCostume;
 #endif
-
-#if defined(__FISHING_GAME__)
-public:
-	void SetFishingGameGoals(BYTE bCount) { m_bFishingGameGoals = bCount; }
-	BYTE GetFishingGameGoals() { return m_bFishingGameGoals; }
-private:
-	BYTE m_bFishingGameGoals;
 #endif
 
-#if defined(__GEM_SYSTEM__)
+#if defined(__GEM_MARKET_SYSTEM__)
 public:
-	void SelectItemEx(DWORD dwInventoryPos, BYTE bType);
-	bool GemRefine(LPITEM lpMetinStoneItem);
-
-#	if defined(__GEM_SHOP__)
-public:
-	void SetGemShop(CGemShop* pGemShop);
-	CGemShop* GetGemShop() const { return m_pGemShop; }
+	struct Gem_Shop_Values
+	{
+		int value_1;
+		int value_2;
+		int value_3;
+		int value_4;
+		int value_5;
+		int value_6;
+		bool operator == (const Gem_Shop_Values& b)
+		{
+			return (this->value_1 == b.value_1) && (this->value_2 == b.value_2) &&
+				(this->value_3 == b.value_3) && (this->value_4 == b.value_4) &&
+				(this->value_5 == b.value_5) && (this->value_6 == b.value_6);
+		}
+	};
 
-	void SetGemShopLoading(const bool c_bLoading) { m_bGemShopLoading = c_bLoading; }
-	bool IsGemShopLoading() const { return m_bGemShopLoading; }
+	struct Gem_Load_Values
+	{
+		DWORD items;
+		DWORD gem;
+		DWORD count;
+		DWORD glimmerstone;
+		DWORD gem_expansion;
+		DWORD gem_refresh;
+		DWORD glimmerstone_count;
+		DWORD gem_expansion_count;
+		DWORD gem_refresh_count;
+		DWORD grade_stone;
+		DWORD give_gem;
+		DWORD prob_gem;
+		DWORD cost_gem_yang;
+	};
 
-private:
-	CGemShop* m_pGemShop;
-	bool m_bGemShopLoading;
-#	endif
+	bool CheckItemsFull();
+	void UpdateItemsGemMarker0();
+	void UpdateItemsGemMarker();
+	void InfoGemMarker();
+	void ClearGemMarket();
+	bool CheckSlotGemMarket(int slot);
+	void UpdateSlotGemMarket(int slot);
+	void BuyItemsGemMarket(int slot);
+	void RefreshItemsGemMarket();
+	void CraftGemItems(int slot);
+	void MarketGemItems(int slot);
+	void RefreshGemItems();
+	void LoadGemSystem();
+	int GetGemState(const std::string& state) const;
+	void SetGemState(const std::string& state, int szValue);
+	void StartCheckTimeMarket();
+	void StartCheckTimeMarketLogin();
+
+private:
+	std::vector<Gem_Shop_Values> info_items;
+	std::vector<Gem_Shop_Values> info_slots;
+	std::vector<Gem_Load_Values> load_gem_items;
+	Gem_Load_Values load_gem_values;
+	LPEVENT GemUpdateTime;
 #endif
 
 #if defined(__ACCE_COSTUME_SYSTEM__)
-	//////////////////////////////////////////////////////////////////////////////////
-	// Acce Costume System
-public:
-	void AcceRefineWindowOpen(const LPENTITY pEntity, BYTE bType);
-	void AcceRefineWindowClose(bool bServerClose = false);
-	bool IsAcceRefineWindowOpen() const { return m_bAcceRefineWindowOpen; }
-	bool GetAcceRefineWindowType() const { return m_bAcceRefineWindowType; }
-
-	bool IsAcceRefineWindowCanRefine();
-	LPENTITY GetAcceRefineWindowOpener() const { return m_pointsInstant.m_pAcceRefineWindowOpener; }
-
-	void AcceRefineWindowCheckIn(BYTE bType, TItemPos SelectedPos, TItemPos AttachedPos);
-	void AcceRefineWindowCheckOut(BYTE bType, TItemPos SelectedPos);
-	void AcceRefineWindowAccept(BYTE bType);
-
-	int GetAcceWeaponAttack() const;
-	int GetAcceWeaponMagicAttack() const;
-
-	void ModifyAccePoints(const LPITEM& rAcceItem, bool bAdd);
-
 protected:
-	int __CalculateAcceDrainValues(BYTE bWeaponAttackType) const;
-	int __CheckAcceRefineItem(const LPITEM& rLeftItem, const LPITEM& rRightItem) const;
-	BYTE __GetNextDrainRate(const LPITEM& rAcceItem, BYTE bMinDrainRate) const;
-
-private:
-	bool m_bAcceRefineWindowOpen;
-	BYTE m_bAcceRefineWindowType;
-	TItemPos m_pAcceRefineWindowItemSlot[ACCE_SLOT_MAX];
-#endif
-
-#if defined(__AURA_COSTUME_SYSTEM__)
-	//////////////////////////////////////////////////////////////////////////////////
-	// Aura Costume System
-public:
-	void OpenAuraRefineWindow(const LPENTITY pEntity, BYTE bType);
-	void AuraRefineWindowClose(bool bServerClose = false);
-	bool IsAuraRefineWindowOpen() const { return m_bAuraRefineWindowOpen; }
-	BYTE GetAuraRefineWindowType() const { return m_bAuraRefineWindowType; }
-
-	bool IsAuraRefineWindowCanRefine();
-	LPENTITY GetAuraRefineWindowOpener() const { return m_pointsInstant.m_pAuraRefineWindowOpener; }
-
-	void AuraRefineWindowCheckIn(BYTE bType, TItemPos SelectedPos, TItemPos AttachedPos);
-	void AuraRefineWindowCheckOut(BYTE bType, TItemPos SelectedPos);
-	void AuraRefineWindowAccept(BYTE bType);
-
-	void ModifyAuraPoints(const LPITEM& rAuraItem, bool bAdd);
-
-private:
-	BYTE m_bAuraRefineWindowType;
-	bool m_bAuraRefineWindowOpen;
-	TItemPos m_pAuraRefineWindowItemSlot[AURA_SLOT_MAX];
-	TAuraRefineInfo m_bAuraRefineInfo[AURA_REFINE_INFO_SLOT_MAX];
-
-protected:
-	TAuraRefineInfo __GetAuraRefineInfo(TItemPos Cell);
-	TAuraRefineInfo __CalcAuraRefineInfo(TItemPos Cell, TItemPos MaterialCell);
-	TAuraRefineInfo __GetAuraEvolvedRefineInfo(TItemPos Cell);
-#endif
-
-#if defined(__SOUL_SYSTEM__)
-public:
-	void SoulItemProcess(ESoulSubTypes eSubType);
+	bool m_bAcceCombination, m_bAcceAbsorption;
 
-	int GetSoulDamage(ESoulSubTypes eSubType) const;
-	bool DoRefineSoul(LPITEM item);
-#endif
-
-#if defined(__EXTEND_INVEN_SYSTEM__)
-public:
-	void SetExtendInvenStage(BYTE bStage) { m_bExtendInvenStage = bStage; }
-	BYTE GetExtendInvenStage() const { return m_bExtendInvenStage; }
-
-	WORD GetExtendInvenMax() const;
-
-	void ExtendInvenRequest();
-	void ExtendInvenUpgrade();
-
-	void SendExtendInvenPacket();
-
-private:
-	BYTE m_bExtendInvenStage;
-#endif
-
-#if defined(__ATTR_6TH_7TH__)
-public:
-	void StartHitBuffEvent();
-	void StopHitBuffEvent();
-private:
-	LPEVENT m_pHitBuffEvent;
-#endif
-
-#if defined(__CLIENT_TIMER__)
-public:
-	void SendClientTimer(BYTE bSubHeader, DWORD dwEndTime = 0, DWORD dwAlarmSec = 0);
-#endif
-
-#if defined(__EXPRESSING_EMOTIONS__)
-public:
-	void AddEmote(const INT iEmoteIndex = -1);
-	void SetEmotes(const TPacketGDEmote* pTable, const WORD c_wSize);
-#endif
-
-#if defined(__SET_ITEM__)
 public:
-	using SetItemCountMap = std::map<BYTE, BYTE>;
-	SetItemCountMap GetItemSetCountMap() const;
-
-	void RefreshItemSetBonus();
-	void RefreshItemSetBonusByValue();
+	bool IsOpenAcce();
+	bool isAcceOpened(bool bCombination) { return bCombination ? m_bAcceCombination : m_bAcceAbsorption; }
+	void OpenAcce(bool bCombination);
+	void CloseAcce();
+	void ClearAcceMaterials();
+	bool CleanAcceAttr(LPITEM pkItem, LPITEM pkTarget);
+	LPITEM* GetAcceMaterials() { return m_pointsInstant.pAcceMaterials; }
+	bool AcceIsSameGrade(long lGrade);
+	DWORD GetAcceCombinePrice(long lGrade);
+	void GetAcceCombineResult(DWORD& dwItemVnum, DWORD& dwMinAbs, DWORD& dwMaxAbs);
+	BYTE CheckEmptyMaterialSlot();
+	void AddAcceMaterial(TItemPos tPos, BYTE bPos);
+	void RemoveAcceMaterial(BYTE bPos);
+	BYTE CanRefineAcceMaterials();
+	void RefineAcceMaterials();
 #endif
 
-#if defined(__RACE_SWAP__)
+#if defined(__MINI_GAME_OKEY__)
 public:
-	void SetEventRaceNum(DWORD dwRaceNum);
-	DWORD GetEventRaceNum() const { return m_dwEventRaceNum; }
-private:
-	DWORD m_dwEventRaceNum;
-#endif
-
-#if defined(__GAME_OPTION_ESCAPE__)
-public:
-	void SetEscapeCooltime(const DWORD dwTime) { m_dwEscapeCooltime = dwTime; }
-	DWORD GetEscapeCooltime() const { return m_dwEscapeCooltime; }
-private:
-	DWORD m_dwEscapeCooltime;
-#endif
-
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-public:
-	void RefineElementInformation(const LPITEM& rSrcItem, const TItemPos& kItemDestCell);
-	void RefineElement(WORD wElementType);
-
-	bool IsUnderRefineElement() const { return m_bUnderRefineElement; }
-	void SetUnderRefineElement(bool bState, BYTE bRefineType = 0, const TItemPos& rkSrcPos = NPOS, const TItemPos& rkDestPos = NPOS);
-
-	WORD GetRefineElementEffect() const;
-
-private:
-	struct SRefineElementItemPos
+	struct S_CARD
 	{
-		SRefineElementItemPos() : RefineType(0), SrcPos(NPOS), DestPos(NPOS) {}
-		BYTE RefineType;
-		TItemPos SrcPos, DestPos;
-	} m_kRefineElementItemPos;
-	bool m_bUnderRefineElement;
-#endif
-
-#if defined(__HIDE_COSTUME_SYSTEM__)
-public:
-	void SetHiddenCostumePart(BYTE bCostumeSubType, bool bHidden, bool bSave = true);
-	bool GetHiddenCostumeByPart(BYTE bPartPos) const;
-
-	void SetHiddenCostumeParts();
-private:
-	DWORD m_dwHideCostumePulse;
-	bool m_bHiddenCostumePart[COSTUME_NUM_TYPES];
-#endif
+		DWORD type;
+		DWORD value;
+	};
 
-#if defined(__MINI_GAME_YUTNORI__)
-public:
-	void SetMiniGameYutnori(CMiniGameYutnori* pClass);
-	CMiniGameYutnori* GetMiniGameYutnori() const { return m_pkMiniGameYutnori; }
-private:
-	CMiniGameYutnori* m_pkMiniGameYutnori;
-#endif
+	struct CARDS_INFO
+	{
+		S_CARD cards_in_hand[MAX_CARDS_IN_HAND];
+		S_CARD cards_in_field[MAX_CARDS_IN_FIELD];
+		DWORD cards_left;
+		DWORD field_points;
+		DWORD points;
+	};
 
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-public:
-	void SetCountry(const std::string& country) { m_stCountry = country; }
-	const char* GetCountry() const { return m_stCountry.c_str(); }
+	void Cards_open(DWORD safemode);
+	void Cards_clean_list();
+	DWORD GetEmptySpaceInHand();
+	void Cards_pullout();
+	void RandomizeCards();
+	bool CardWasRandomized(DWORD type, DWORD value);
+	void SendUpdatedInformations();
+	void SendReward();
+	void CardsDestroy(DWORD reject_index);
+	void CardsAccept(DWORD accept_index);
+	void CardsRestore(DWORD restore_index);
+	DWORD GetEmptySpaceInField();
+	DWORD GetAllCardsCount();
+	bool TypesAreSame();
+	bool ValuesAreSame();
+	bool CardsMatch();
+	DWORD GetLowestCard();
+	bool CheckReward();
+	void CheckCards();
+	void RestoreField();
+	void ResetField();
+	void CardsEnd();
+	void GetGlobalRank(char* buffer, size_t buflen);
+	void GetRundRank(char* buffer, size_t buflen);
 
 protected:
-	std::string m_stCountry;
-#endif
-
-#if defined(__MYSHOP_DECO__)
-public:
-	void SetMyShopDecoState(BYTE bState) { m_bMyShopDecoState = bState; };
-	BYTE GetMyShopDecoState() const { return m_bMyShopDecoState; };
-
-	void SetMyShopDecoType(BYTE bShopType) { m_bMyShopDecoType = bShopType; };
-	BYTE GetMyShopDecoType() const { return m_bMyShopDecoType; };
-
-	void SetMyShopDecoPolyVnum(DWORD dwPolyVnum) { m_bMyShopDecoPolyVnum = dwPolyVnum; };
-	DWORD GetMyShopDecoPolyVnum() const { return m_bMyShopDecoPolyVnum; };
-
-	void SetMyPrivShopTabCount(BYTE bTabCount) { m_bMyPrivShopTabCount = bTabCount; };
-	BYTE GetMyPrivShopTabCount() const { return m_bMyPrivShopTabCount; };
-
-	void SetMyPrivShopIsCashItem(bool bIsCashItem) { m_bMyPrivShopIsCashItem = bIsCashItem; };
-	bool GetMyPrivShopIsCashItem() const { return m_bMyPrivShopIsCashItem; };
-
-	void OpenPrivateShop(BYTE bTabCount = 1, bool bIsCashItem = false);
-
-private:
-	BYTE m_bMyShopDecoState;
-	BYTE m_bMyShopDecoType;
-	DWORD m_bMyShopDecoPolyVnum;
-
-	BYTE m_bMyPrivShopTabCount;
-	bool m_bMyPrivShopIsCashItem;
+	CARDS_INFO character_cards;
+	S_CARD randomized_cards[24];
 #endif
 
-#if defined(__LEFT_SEAT__)
-public:
-	void SetLeftSeat(bool bLeftSeat);
-	bool LeftSeat() const { return m_bLeftSeat; }
-
-	void SetLeftSeatWaitTime(BYTE bIndex);
-	DWORD GetLeftSeatWaitTime() const { return m_dwLeftSeatWaitTime; }
-
-	void SetLeftSeatLogoutTime(BYTE bIndex);
-	DWORD GetLeftSeatLogoutTime() const { return m_dwLeftSeatLogoutTime; }
-
-	void DisableLeftSeatLogOutState(bool bClosePopup = false);
-
-	void RestartLeftSeatWaitTimer();
-	void RestartLeftSeatLogoutTimer();
-
-	void SetLastRequestTime(DWORD dwRequestTime) { m_dwLastRequestTime = dwRequestTime; }
-	DWORD GetLastRequestTime() const { return m_dwLastRequestTime; }
-
-#ifdef __SHOP_SEARCH__
-	bool CheckShopSearchFlood();
-#endif
-
-public:
-	LPEVENT m_pLeftSeatWaitTimerEvent;
-	LPEVENT m_pLeftSeatLogoutTimerEvent;
-
-private:
-	BOOL m_bLeftSeat;
-	DWORD m_dwLeftSeatWaitTime;
-	DWORD m_dwLeftSeatLogoutTime;
-	DWORD m_dwLastRequestTime;
-#ifdef __SHOP_SEARCH__
-	DWORD m_dwLastShopSearchRequestTime;
-	BYTE m_bShopSearchFloodCount;
-#endif
-#endif
-
-#if defined(__ELEMENTAL_DUNGEON__)
-public:
-	void StartElementalCurseEvent();
-	void StopElementalCurseEvent();
-
-	void SetAccumulatedDamage(DWORD dwDamage);
-	DWORD GetAccumulatedDamage() const { return m_dwAccumulatedDamage; }
-
-private:
-	LPEVENT m_pElementalCurseEvent;
-	DWORD m_dwAccumulatedDamage;
-#endif
-
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-public:
-	void SetGuildDragonLair(CGuildDragonLair* pGuildDragonLair);
-	CGuildDragonLair* GetGuildDragonLair() const { return m_pGuildDragonLair; }
-private:
-	CGuildDragonLair* m_pGuildDragonLair;
-#endif
-
-#if defined(__SUMMER_EVENT_ROULETTE__)
-public:
-	void SetMiniGameRoulette(CMiniGameRoulette* pMiniGameRoulette);
-	CMiniGameRoulette* GetMiniGameRoulette() const { return m_pMiniGameRoulette; }
-
-	void SetMiniGameRoulette_RewardMapperNum(BYTE bMapNum) { m_bMiniGameRoulette_RewardMapperNum = bMapNum; }
-	BYTE GetMiniGameRoulette_RewardMapperNum() const { return m_bMiniGameRoulette_RewardMapperNum; }
-
-private:
-	CMiniGameRoulette* m_pMiniGameRoulette;
-	BYTE m_bMiniGameRoulette_RewardMapperNum;
-#endif
+#if defined(__CHANGE_LOOK_SYSTEM__)
+protected:
+	bool m_bChangeLook;
 
-#if defined(__FLOWER_EVENT__)
 public:
-	void SetLastFlowerEventExchangePulse(DWORD dwPulse) { m_dwLastFlowerEventExchangePulse = dwPulse; }
-	DWORD GetLastFlowerEventExchangePulse() const { return m_dwLastFlowerEventExchangePulse; }
-private:
-	DWORD m_dwLastFlowerEventExchangePulse;
+	bool isChangeLookOpened() { return m_bChangeLook; }
+	void ChangeLookWindow(bool bOpen = false, bool bRequest = false);
+	void ClearChangeLookWindowMaterials();
+	LPITEM* GetChangeLookWindowMaterials() { return m_pointsInstant.pChangeLookMaterials; }
+	BYTE CheckChangeLookEmptyMaterialSlot();
+	void AddChangeLookMaterial(TItemPos tPos, BYTE bPos);
+	void RemoveChangeLookMaterial(BYTE bPos);
+	void RefineChangeLookMaterials();
+	bool CleanTransmutation(LPITEM pkItem, LPITEM pkTarget);
+	void ClearChangeLookWindow();
 #endif
 
-#if defined(__DEFENSE_WAVE__)
+#if defined(__PRIVATESHOP_SEARCH_SYSTEM__)
 public:
-	void SetDefenseWave(LPDEFENSE_WAVE pDefenseWave);
-	LPDEFENSE_WAVE GetDefenseWave() const;
-private:
-	LPDEFENSE_WAVE m_pDefenseWave;
+	BYTE GetPrivateShopSearchState() const { return bPrivateShopSearchState; }
+	void SetPrivateShopSearchState(BYTE bState) { bPrivateShopSearchState = bState; }
+	void OpenPrivateShopSearch(DWORD dwVnum);
+protected:
+	BYTE bPrivateShopSearchState;
 #endif
 
-#ifdef ENABLE_QUEEN_NETHIS
+#if defined(__MAILBOX__)
 public:
-	bool IsSnakeMap();
-#endif
-#ifdef __OFFLINE_SHOP__
-private:
-	uint32_t keepingOfflineShop_;
-
-	std::set<uint32_t> viewingOfflineShops_;
-
-	bool isOpeningOfflineShop_;
-	CItem* offlineShopOpeningItem_;
+	int GetMyMailBoxTime() const { return m_iMyMailBoxTime; }
+	void SetMyMailBoxTime() { m_iMyMailBoxTime = thecore_pulse(); }
 
-public:
-	void SetKeepingOfflineShop(uint32_t keepingOfflineShop);
-	uint32_t GetKeepingOfflineShop() const;
+	void SetMailBox(CMailBox* m);
 
-	void AddViewingOfflineShop(uint32_t id);
-	bool IsViewingOfflineShop();
-	void RemoveViewingOfflineShop(uint32_t id);
-	void RemoveFromViewingOfflineShops();
+	void SetMailBoxLoading(const bool b) { bMailBoxLoading = b; }
+	bool IsMailBoxLoading() const { return bMailBoxLoading; }
 
-	bool UseItemOpenOfflineShop(CItem* item);
-	void SetOpeningOfflineShopState(bool isOpeningOfflineShop);
-	bool IsOpeningOfflineShop() const;
-	void SetOfflineShopOpeningItem(CItem* item);
-	CItem* GetOfflineShopOpeningItem() const;
-	bool IsAffectOfflineShopDecoration();
-	void WarpToShop(long x, long y, long mapIndex, BYTE channel);
+	CMailBox* GetMailBox() const { return m_pkMailBox; }
 
 private:
-	std::map<std::string, int> m_protection_Time;
-
-public:
-	int GetProtectTime(const std::string& flagname) const;
-	void SetProtectTime(const std::string& flagname, int time);
-
-public:
-	void	AddToSellHistory(TMySellHistory newItem);
-	void	SaveSellHistory();
-	void	RequestSellHistory(BYTE bPage);
-	void	SetSellHistoryLoaded(BYTE bStatus) {  m_bSellHistoryLoaded = bStatus; }
-	BYTE	GetSellHistoryLoaded() { return m_bSellHistoryLoaded; }
-protected:
-	BYTE	m_bSellHistoryLoaded;
-	std::vector<TMySellHistory> m_vecSellHistory;
+	CMailBox* m_pkMailBox;
+	bool bMailBoxLoading;
+	int m_iMyMailBoxTime;
 #endif
 
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-typedef std::list<TPlayerExtBattlePassMission*> ListExtBattlePassMap;
+#if defined(__CONQUEROR_LEVEL__)
 public:
-	void LoadExtBattlePass(DWORD dwCount, TPlayerExtBattlePassMission* data);
-	DWORD GetExtBattlePassMissionProgress(DWORD dwBattlePassType, BYTE bMissionIndex, BYTE bMissionType);
-	bool IsExtBattlePassCompletedMission(DWORD dwBattlePassType, BYTE bMissionIndex, BYTE bMissionType);
-	bool IsExtBattlePassRegistered(BYTE bBattlePassType, DWORD dwBattlePassID);
-	void UpdateExtBattlePassMissionProgress(DWORD dwMissionID, DWORD dwUpdateValue, DWORD dwCondition, bool isOverride = false);
-	void SetExtBattlePassMissionProgress(BYTE bBattlePassType, DWORD dwMissionIndex, DWORD dwMissionType, DWORD dwUpdateValue);
-	
-	bool		IsLoadedExtBattlePass()		const	{ return m_bIsLoadedExtBattlePass; }
-	int			GetExtBattlePassPremiumID()	const	{ return m_points.battle_pass_premium_id;	}
-	void		SetExtBattlePassPremiumID(int battle_pass_premium_id)	{ m_points.battle_pass_premium_id = battle_pass_premium_id;}
-
-	void				SetLastReciveExtBattlePassInfoTime(DWORD time);
-	DWORD			GetLastReciveExtBattlePassInfoTime() const	{ return m_dwLastReciveExtBattlePassInfoTime; }
-	void				SetLastReciveExtBattlePassOpenRanking(DWORD time);
-	DWORD			GetLastReciveExtBattlePassOpenRanking() const	{ return m_dwLastExtBattlePassOpenRankingTime; }
-protected:
-	DWORD	m_dwLastReciveExtBattlePassInfoTime;
-	DWORD	m_dwLastExtBattlePassOpenRankingTime;
-	
-private:
-	bool m_bIsLoadedExtBattlePass;
-	ListExtBattlePassMap m_listExtBattlePass;
+	bool IsNewWorldMap(long lMapIndex);
+	void SetSungMaWill();
+	uint8_t GetSungMaWill(uint8_t type) const;
 #endif
 };
 
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/char_aura.cpp final/server/server/home/metin2/Source/Server/game/src/char_aura.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/char_aura.cpp	2024-12-28 03:09:36.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/char_aura.cpp	2021-08-17 11:31:58.000000000 +0000
@@ -1,978 +1,1092 @@
-/**
-* Filename: char_aura.cpp
-* Author: Owsap
-**/
-
-#include "stdafx.h"
-
-#if defined(__AURA_COSTUME_SYSTEM__)
-#include "char.h"
-#include "item.h"
-#include "desc.h"
-#include "utils.h"
-
-void CHARACTER::OpenAuraRefineWindow(const LPENTITY pEntity, BYTE bType)
-{
-	if (pEntity == nullptr)
-	{
-		sys_err("OpenAuraRefineWindow(pEntity=%p, bType=%d): NULL ENTITY CHAR %s",
-			get_pointer(pEntity), GetName());
-		return;
-	}
-
-	if (PreventTradeWindow(WND_ALL))
-		return;
-
-	int iDist = DISTANCE_APPROX(GetX() - pEntity->GetX(), GetY() - pEntity->GetY());
-	if (iDist >= WINDOW_OPENER_MAX_DISTANCE)
-		return;
-
-	TPacketGCAuraRefine Packet;
-	Packet.wSize = sizeof(TPacketGCAuraRefine) + sizeof(TSubPacketGCAuraRefineOpenClose);
-	Packet.bSubHeader = AURA_REFINE_SUBHEADER_GC_OPEN;
-
-	TSubPacketGCAuraRefineOpenClose SubPacket;
-	switch (bType)
-	{
-		case AURA_WINDOW_TYPE_ABSORB:
-		case AURA_WINDOW_TYPE_GROWTH:
-		case AURA_WINDOW_TYPE_EVOLVE:
-			SubPacket.bType = bType;
-			break;
-
-		case AURA_WINDOW_TYPE_MAX:
-			return;
-	}
-
-	const LPDESC pDesc = GetDesc();
-	if (pDesc == nullptr)
-	{
-		sys_err("OpenAuraRefineWindow:: NULL DESC CHAR %s", GetName());
-		return;
-	}
-
-	TEMP_BUFFER TempBuffer;
-	TempBuffer.write(&Packet, sizeof(TPacketGCAuraRefine));
-	TempBuffer.write(&SubPacket, sizeof(TSubPacketGCAuraRefineOpenClose));
-
-	if (m_pointsInstant.m_pAuraRefineWindowOpener == nullptr)
-		m_pointsInstant.m_pAuraRefineWindowOpener = pEntity;
-
-	m_bAuraRefineWindowType = bType;
-	m_bAuraRefineWindowOpen = AURA_WINDOW_TYPE_MAX != m_bAuraRefineWindowType;
-
-	pDesc->Packet(TempBuffer.read_peek(), TempBuffer.size());
-}
-
-void CHARACTER::AuraRefineWindowClose(bool bServerClose)
-{
-	const LPDESC pDesc = GetDesc();
-	if (pDesc == nullptr)
-	{
-		sys_err("AuraRefineWindowClose:: NULL DESC CHAR %s", GetName());
-		return;
-	}
-
-	m_pointsInstant.m_pAuraRefineWindowOpener = nullptr;
-	m_bAuraRefineWindowType = AURA_WINDOW_TYPE_MAX;
-	m_bAuraRefineWindowOpen = false;
-
-	for (BYTE bSlotIndex = 0; bSlotIndex < AURA_SLOT_MAX; ++bSlotIndex)
-	{
-		if (m_pAuraRefineWindowItemSlot[bSlotIndex] != NPOS)
-		{
-			const LPITEM pItem = GetItem(m_pAuraRefineWindowItemSlot[bSlotIndex]);
-			if (pItem != nullptr)
-				pItem->Lock(false);
-
-			m_pAuraRefineWindowItemSlot[bSlotIndex] = NPOS;
-		}
-	}
-
-	TPacketGCAuraRefine Packet;
-	Packet.bSubHeader = AURA_REFINE_SUBHEADER_GC_CLOSE;
-	Packet.wSize = sizeof(TPacketGCAuraRefine) + sizeof(TSubPacketGCAuraRefineOpenClose);
-
-	TSubPacketGCAuraRefineOpenClose SubPacket;
-	SubPacket.bType = AURA_WINDOW_TYPE_MAX;
-	SubPacket.bServerClose = bServerClose;
-
-	TEMP_BUFFER TempBuffer;
-	TempBuffer.write(&Packet, sizeof(TPacketGCAuraRefine));
-	TempBuffer.write(&SubPacket, sizeof(TSubPacketGCAuraRefineOpenClose));
-	pDesc->Packet(TempBuffer.read_peek(), TempBuffer.size());
-}
-
-bool CHARACTER::IsAuraRefineWindowCanRefine()
-{
-	if (!IsAuraRefineWindowOpen())
-		return false;
-
-	if (!CanHandleItem())
-		return false;
-
-	const LPENTITY pEntity = GetAuraRefineWindowOpener();
-	if (pEntity == nullptr)
-		return false;
-
-	int iDist = DISTANCE_APPROX(GetX() - pEntity->GetX(), GetY() - pEntity->GetY());
-	if (iDist >= WINDOW_OPENER_MAX_DISTANCE)
-		return false;
-
-	return true;
-}
-
-void CHARACTER::AuraRefineWindowCheckIn(BYTE bType, TItemPos SelectedPos, TItemPos AttachedPos)
-{
-	if (SelectedPos.window_type != AURA_REFINE || SelectedPos.cell >= AURA_SLOT_RESULT)
-		return;
-
-	if (!AttachedPos.IsValidItemPosition() || AttachedPos.IsEquipPosition())
-		return;
-
-	if (m_bAuraRefineWindowType != bType)
-		return;
-
-	const LPDESC pDesc = GetDesc();
-	if (pDesc == nullptr)
-	{
-		sys_err("AuraRefineWindowCheckIn(bType=%d):: NULL DESC CHAR %s", bType, GetName());
-		return;
-	}
-
-	if (!IsAuraRefineWindowOpen())
-		return;
-
-	if (!IsAuraRefineWindowCanRefine())
-		if (!IsAuraRefineWindowOpen() || !GetAuraRefineWindowOpener())
-			return;
-	
-	const LPITEM pAttachedItem = GetItem(AttachedPos);
-	if (pAttachedItem == nullptr)
-		return;
-
-	if (pAttachedItem->isLocked() || pAttachedItem->IsExchanging() || pAttachedItem->IsEquipped())
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Aura] Cannot be improved."));
-		return;
-	}
-
-#if defined(__SOUL_BIND_SYSTEM__)
-	if (pAttachedItem->IsSealed())
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Aura] Does not work with soulbound items."));
-		return;
-	}
-#endif
-
-	switch (bType)
-	{
-		case AURA_WINDOW_TYPE_ABSORB:
-		{
-			if (m_pAuraRefineWindowItemSlot[SelectedPos.cell] != NPOS)
-				return;
-
-			if (SelectedPos.cell == AURA_SLOT_MAIN && !(pAttachedItem->IsCostumeAura()))
-			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Aura] Only Aura Outfit can be inserted."));
-				return;
-			}
-
-			if (SelectedPos.cell == AURA_SLOT_MAIN && pAttachedItem->GetSocket(ITEM_SOCKET_AURA_DRAIN_ITEM_VNUM))
-			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Aura] Does not work with an Aura Outfit onto which an item has already been transmitted."));
-				return;
-			}
-
-			if (SelectedPos.cell == AURA_SLOT_SUB && !(pAttachedItem->IsArmorType(ARMOR_SHIELD) || pAttachedItem->IsArmorType(ARMOR_WRIST) || pAttachedItem->IsArmorType(ARMOR_NECK) || pAttachedItem->IsArmorType(ARMOR_EAR)))
-			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Aura] Only Aura Outfit, Shield, Necklace, Earring or Armband can be inserted."));
-				return;
-			}
-
-			pAttachedItem->Lock(true);
-			m_pAuraRefineWindowItemSlot[SelectedPos.cell] = AttachedPos;
-
-			TPacketGCAuraRefine Packet;
-			Packet.wSize = sizeof(TPacketGCAuraRefine) + sizeof(TSubPacketGCAuraRefineSetItem);
-			Packet.bSubHeader = AURA_REFINE_SUBHEADER_GC_SET_ITEM;
-
-			TSubPacketGCAuraRefineSetItem SubPacket;
-			SubPacket.AttachedPos = AttachedPos;
-			SubPacket.SelectedPos = SelectedPos;
-			SubPacket.Item.dwVnum = pAttachedItem->GetVnum();
-			SubPacket.Item.dwCount = pAttachedItem->GetCount();
-			SubPacket.Item.dwFlags = pAttachedItem->GetFlag();
-			SubPacket.Item.dwAntiFlags = pAttachedItem->GetAntiFlag();
-			thecore_memcpy(SubPacket.Item.alSockets, pAttachedItem->GetSockets(), sizeof(SubPacket.Item.alSockets));
-			thecore_memcpy(SubPacket.Item.aAttr, pAttachedItem->GetAttributes(), sizeof(SubPacket.Item.aAttr));
-#if defined(__ITEM_APPLY_RANDOM__)
-			thecore_memcpy(SubPacket.Item.aApplyRandom, pAttachedItem->GetRandomApplies(), sizeof(SubPacket.Item.aApplyRandom));
-#endif
-
-			TEMP_BUFFER TempBuffer;
-			TempBuffer.write(&Packet, sizeof(TPacketGCAuraRefine));
-			TempBuffer.write(&SubPacket, sizeof(TSubPacketGCAuraRefineSetItem));
-			pDesc->Packet(TempBuffer.read_peek(), TempBuffer.size());
-
-			if ((NPOS != m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN]) && (NPOS != m_pAuraRefineWindowItemSlot[AURA_SLOT_SUB]))
-			{
-				const LPITEM pMainItem = GetItem(m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN]), pSubItem = GetItem(m_pAuraRefineWindowItemSlot[AURA_SLOT_SUB]);
-				if (!pMainItem || !pSubItem)
-					return;
-
-				TPacketGCAuraRefine Packet2;
-				Packet2.wSize = sizeof(TPacketGCAuraRefine) + sizeof(TSubPacketGCAuraRefineSetItem);
-				Packet2.bSubHeader = AURA_REFINE_SUBHEADER_GC_SET_ITEM;
-
-				TSubPacketGCAuraRefineSetItem SubPacket2;
-				SubPacket2.AttachedPos = TItemPos(RESERVED_WINDOW, 0);
-				SubPacket2.SelectedPos = TItemPos(AURA_REFINE, AURA_SLOT_RESULT);
-				SubPacket2.Item.dwVnum = pMainItem->GetOriginalVnum();
-				SubPacket2.Item.dwCount = pMainItem->GetCount();
-				SubPacket2.Item.dwFlags = pMainItem->GetFlag();
-				SubPacket2.Item.dwAntiFlags = pMainItem->GetAntiFlag();
-				thecore_memcpy(SubPacket2.Item.alSockets, pMainItem->GetSockets(), sizeof(SubPacket2.Item.alSockets));
-				SubPacket2.Item.alSockets[ITEM_SOCKET_AURA_DRAIN_ITEM_VNUM] = pSubItem->GetOriginalVnum();
-				thecore_memcpy(SubPacket2.Item.aAttr, pSubItem->GetAttributes(), sizeof(SubPacket2.Item.aAttr));
-#if defined(__ITEM_APPLY_RANDOM__)
-				thecore_memcpy(SubPacket2.Item.aApplyRandom, pSubItem->GetRandomApplies(), sizeof(SubPacket2.Item.aApplyRandom));
-#endif
-
-				TEMP_BUFFER TempBuffer;
-				TempBuffer.write(&Packet2, sizeof(TPacketGCAuraRefine));
-				TempBuffer.write(&SubPacket2, sizeof(TSubPacketGCAuraRefineSetItem));
-				pDesc->Packet(TempBuffer.read_peek(), TempBuffer.size());
-			}
-		}
-		break;
-
-		case AURA_WINDOW_TYPE_GROWTH:
-		{
-			if (SelectedPos.cell == AURA_SLOT_MAIN)
-			{
-				if (!pAttachedItem->IsCostumeAura())
-				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Aura] Only Aura Outfit can be inserted."));
-					return;
-				}
-				else
-				{
-					const long lLevelSocket = pAttachedItem->GetSocket(ITEM_SOCKET_AURA_LEVEL_VALUE);
-					const BYTE bCurrentLevel = (lLevelSocket / 100000) - 1000;
-					const WORD wCurrentExp = lLevelSocket % 100000;
-					const int* aiAuraRefineTable = GetAuraRefineInfo(bCurrentLevel);
-					if (bCurrentLevel == aiAuraRefineTable[AURA_REFINE_INFO_LEVEL_MAX] && wCurrentExp == aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP])
-					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Aura] Cannot be improved."));
-						if (aiAuraRefineTable[AURA_REFINE_INFO_STEP] == AURA_GRADE_RADIANT)
-							ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Aura] Your Aura Outfit has reached the maximum level."));
-
-						return;
-					}
-				}
-			}
-
-			if (SelectedPos.cell == AURA_SLOT_SUB)
-			{
-				if (NPOS == m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN])
-				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Aura] Can only be done once an Aura Outfit has been inserted."));
-					return;
-				}
-				else if (!(pAttachedItem->GetType() == ITEM_RESOURCE && pAttachedItem->GetSubType() == RESOURCE_AURA))
-				{
-					if (test_server)
-						ChatPacket(CHAT_TYPE_INFO, "[Aura Test] Required aura resource.");
-					return;
-				}
-			}
-
-			if (m_pAuraRefineWindowItemSlot[SelectedPos.cell] != NPOS)
-				return;
-
-			pAttachedItem->Lock(true);
-			m_pAuraRefineWindowItemSlot[SelectedPos.cell] = AttachedPos;
-
-			TPacketGCAuraRefine Packet;
-			Packet.wSize = sizeof(TPacketGCAuraRefine) + sizeof(TSubPacketGCAuraRefineSetItem);
-			Packet.bSubHeader = AURA_REFINE_SUBHEADER_GC_SET_ITEM;
-
-			TSubPacketGCAuraRefineSetItem SubPacket;
-			SubPacket.AttachedPos = AttachedPos;
-			SubPacket.SelectedPos = SelectedPos;
-			SubPacket.Item.dwVnum = pAttachedItem->GetVnum();
-			SubPacket.Item.dwCount = pAttachedItem->GetCount();
-			SubPacket.Item.dwFlags = pAttachedItem->GetFlag();
-			SubPacket.Item.dwAntiFlags = pAttachedItem->GetAntiFlag();
-			thecore_memcpy(SubPacket.Item.alSockets, pAttachedItem->GetSockets(), sizeof(SubPacket.Item.alSockets));
-			thecore_memcpy(SubPacket.Item.aAttr, pAttachedItem->GetAttributes(), sizeof(SubPacket.Item.aAttr));
-#if defined(__ITEM_APPLY_RANDOM__)
-			thecore_memcpy(SubPacket.Item.aApplyRandom, pAttachedItem->GetRandomApplies(), sizeof(SubPacket.Item.aApplyRandom));
-#endif
-
-			TEMP_BUFFER TempBuffer;
-			TempBuffer.write(&Packet, sizeof(TPacketGCAuraRefine));
-			TempBuffer.write(&SubPacket, sizeof(TSubPacketGCAuraRefineSetItem));
-			pDesc->Packet(TempBuffer.read_peek(), TempBuffer.size());
-
-			{
-				const LPITEM pAttachedItem = GetItem(AttachedPos);
-				if (!pAttachedItem)
-					return;
-
-				TPacketGCAuraRefine Packet;
-				Packet.wSize = sizeof(TPacketGCAuraRefine) + sizeof(TSubPacketGCAuraRefineInfo);
-				Packet.bSubHeader = AURA_REFINE_SUBHEADER_GC_INFO;
-
-				TSubPacketGCAuraRefineInfo SubPacket;
-				TAuraRefineInfo RefineInfo = {};
-				if (SelectedPos.cell == AURA_SLOT_MAIN)
-				{
-					SubPacket.bInfoType = AURA_REFINE_INFO_SLOT_CURRENT;
-					RefineInfo = __GetAuraRefineInfo(AttachedPos);
-				}
-				if (SelectedPos.cell == AURA_SLOT_SUB)
-				{
-					SubPacket.bInfoType = AURA_REFINE_INFO_SLOT_NEXT;
-					RefineInfo = __CalcAuraRefineInfo(m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN], AttachedPos);
-				}
-				SubPacket.bInfoLevel = RefineInfo.bLevel;
-				SubPacket.bInfoExpPercent = RefineInfo.bExpPercent;
-
-				TEMP_BUFFER TempBuffer;
-				TempBuffer.write(&Packet, sizeof(TPacketGCAuraRefine));
-				TempBuffer.write(&SubPacket, sizeof(TSubPacketGCAuraRefineInfo));
-				pDesc->Packet(TempBuffer.read_peek(), TempBuffer.size());
-			}
-		}
-		break;
-
-		case AURA_WINDOW_TYPE_EVOLVE:
-		{
-			if (SelectedPos.cell == AURA_SLOT_MAIN)
-			{
-				if (!(pAttachedItem->IsCostumeAura()))
-				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Aura] Only Aura Outfit can be inserted."));
-					return;
-				}
-				else
-				{
-					const long lLevelSocket = pAttachedItem->GetSocket(ITEM_SOCKET_AURA_LEVEL_VALUE);
-					const BYTE bCurrentLevel = (lLevelSocket / 100000) - 1000;
-					const WORD wCurrentExp = lLevelSocket % 100000;
-					const int* aiAuraRefineTable = GetAuraRefineInfo(bCurrentLevel);
-					if (!(bCurrentLevel == aiAuraRefineTable[AURA_REFINE_INFO_LEVEL_MAX] && wCurrentExp == aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP]))
-					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Aura] You cannot evolve your Aura Outfit until you have improved it."));
-						if (test_server)
-							ChatPacket(CHAT_TYPE_INFO, "[Aura Test] Required level %d with %d experience.", aiAuraRefineTable[AURA_REFINE_INFO_LEVEL_MAX], aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP]);
-						return;
-					}
-				}
-			}
-
-			if (SelectedPos.cell == AURA_SLOT_SUB)
-			{
-				if (NPOS == m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN])
-				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Aura] Can only be done once an Aura Outfit has been inserted."));
-					return;
-				}
-				else
-				{
-					const LPITEM pMainItem = GetItem(m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN]);
-					const long lLevelSocket = pMainItem->GetSocket(ITEM_SOCKET_AURA_LEVEL_VALUE);
-					const BYTE bCurrentLevel = (lLevelSocket / 100000) - 1000;
-					const int* aiAuraRefineTable = GetAuraRefineInfo(bCurrentLevel);
-					if (pAttachedItem->GetOriginalVnum() != aiAuraRefineTable[AURA_REFINE_INFO_MATERIAL_VNUM])
-					{
-						if (test_server)
-						{
-							ChatPacket(CHAT_TYPE_INFO, "[Aura Test] Required aura resource.");
-							ChatPacket(CHAT_TYPE_INFO, "[Aura Test] Need, %s - %u", LC_ITEM(aiAuraRefineTable[AURA_REFINE_INFO_MATERIAL_VNUM]), aiAuraRefineTable[AURA_REFINE_INFO_MATERIAL_COUNT]);
-						}
-						return;
-					}
-					else
-					{
-						if (CountSpecifyItem(pAttachedItem->GetOriginalVnum()) > aiAuraRefineTable[AURA_REFINE_INFO_MATERIAL_COUNT])
-							ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Aura] The amount of inserted materials has been adjusted to match the required amount."));
-					}
-				}
-			}
-
-			if (m_pAuraRefineWindowItemSlot[SelectedPos.cell] != NPOS)
-				return;
-
-			pAttachedItem->Lock(true);
-			m_pAuraRefineWindowItemSlot[SelectedPos.cell] = AttachedPos;
-
-			TPacketGCAuraRefine Packet;
-			Packet.wSize = sizeof(TPacketGCAuraRefine) + sizeof(TSubPacketGCAuraRefineSetItem);
-			Packet.bSubHeader = AURA_REFINE_SUBHEADER_GC_SET_ITEM;
-
-			TSubPacketGCAuraRefineSetItem SubPacket;
-			SubPacket.AttachedPos = AttachedPos;
-			SubPacket.SelectedPos = SelectedPos;
-			SubPacket.Item.dwVnum = pAttachedItem->GetVnum();
-			SubPacket.Item.dwCount = pAttachedItem->GetCount();
-			SubPacket.Item.dwFlags = pAttachedItem->GetFlag();
-			SubPacket.Item.dwAntiFlags = pAttachedItem->GetAntiFlag();
-			thecore_memcpy(SubPacket.Item.alSockets, pAttachedItem->GetSockets(), sizeof(SubPacket.Item.alSockets));
-			thecore_memcpy(SubPacket.Item.aAttr, pAttachedItem->GetAttributes(), sizeof(SubPacket.Item.aAttr));
-#if defined(__ITEM_APPLY_RANDOM__)
-			thecore_memcpy(SubPacket.Item.aApplyRandom, pAttachedItem->GetRandomApplies(), sizeof(SubPacket.Item.aApplyRandom));
-#endif
-
-			TEMP_BUFFER TempBuffer;
-			TempBuffer.write(&Packet, sizeof(TPacketGCAuraRefine));
-			TempBuffer.write(&SubPacket, sizeof(TSubPacketGCAuraRefineSetItem));
-			pDesc->Packet(TempBuffer.read_peek(), TempBuffer.size());
-
-			if (SelectedPos.cell == AURA_SLOT_MAIN)
-			{
-				LPITEM pMainItem = GetItem(AttachedPos);
-				if (pMainItem == nullptr)
-					return;
-
-				TPacketGCAuraRefine Packet;
-				TSubPacketGCAuraRefineInfo SubPacketA;
-				TSubPacketGCAuraRefineInfo SubPacketB;
-				Packet.wSize = sizeof(TPacketGCAuraRefine) + 2 * sizeof(TSubPacketGCAuraRefineInfo);
-				Packet.bSubHeader = AURA_REFINE_SUBHEADER_GC_INFO;
-
-				TAuraRefineInfo RefineInfo = __GetAuraRefineInfo(AttachedPos);
-				SubPacketA.bInfoType = AURA_REFINE_INFO_SLOT_CURRENT;
-				SubPacketA.bInfoLevel = RefineInfo.bLevel;
-				SubPacketA.bInfoExpPercent = RefineInfo.bExpPercent;
-
-				RefineInfo = __GetAuraEvolvedRefineInfo(AttachedPos);
-				SubPacketB.bInfoType = AURA_REFINE_INFO_SLOT_EVOLVED;
-				SubPacketB.bInfoLevel = RefineInfo.bLevel;
-				SubPacketB.bInfoExpPercent = RefineInfo.bExpPercent;
-
-				TEMP_BUFFER TempBuffer;
-				TempBuffer.write(&Packet, sizeof(TPacketGCAuraRefine));
-				TempBuffer.write(&SubPacketA, sizeof(TSubPacketGCAuraRefineInfo));
-				TempBuffer.write(&SubPacketB, sizeof(TSubPacketGCAuraRefineInfo));
-				pDesc->Packet(TempBuffer.read_peek(), TempBuffer.size());
-			}
-		}
-		break;
-	}
-}
-
-void CHARACTER::AuraRefineWindowCheckOut(BYTE bType, TItemPos SelectedPos)
-{
-	if (SelectedPos.window_type != AURA_REFINE || SelectedPos.cell >= AURA_SLOT_RESULT)
-		return;
-
-	if (m_bAuraRefineWindowType != bType)
-		return;
-
-	if (m_pAuraRefineWindowItemSlot[SelectedPos.cell] == NPOS)
-		return;
-
-	const LPDESC pDesc = GetDesc();
-	if (pDesc == nullptr)
-	{
-		sys_err("AuraRefineWindowCheckOut(bType=%d, SelectedPos=TItemPos(%d, %d)): NULL DESC CHAR %s",
-			bType, SelectedPos.window_type, SelectedPos.cell, GetName());
-		return;
-	}
-
-	if (!IsAuraRefineWindowOpen())
-		return;
-
-	if (!IsAuraRefineWindowCanRefine())
-		if (!IsAuraRefineWindowOpen() || !GetAuraRefineWindowOpener())
-			return;
-
-	if (SelectedPos.cell == AURA_SLOT_MAIN && m_pAuraRefineWindowItemSlot[AURA_SLOT_SUB] != NPOS)
-	{
-		const LPITEM pMainItem = GetItem(m_pAuraRefineWindowItemSlot[SelectedPos.cell]), pSubItem = GetItem(m_pAuraRefineWindowItemSlot[AURA_SLOT_SUB]);
-		if (!pMainItem || !pSubItem)
-			return;
-
-		pMainItem->Lock(false);
-		pSubItem->Lock(false);
-
-		m_pAuraRefineWindowItemSlot[SelectedPos.cell] = NPOS;
-		m_pAuraRefineWindowItemSlot[AURA_SLOT_SUB] = NPOS;
-
-		TPacketGCAuraRefine Packet;
-		Packet.wSize = sizeof(TPacketGCAuraRefine);
-		Packet.bSubHeader = AURA_REFINE_SUBHEADER_GC_CLEAR_ALL;
-		pDesc->Packet(&Packet, sizeof(TPacketGCAuraRefine));
-	}
-	else
-	{
-		const LPITEM pItem = GetItem(m_pAuraRefineWindowItemSlot[SelectedPos.cell]);
-		if (pItem == nullptr)
-			return;
-
-		pItem->Lock(false);
-		m_pAuraRefineWindowItemSlot[SelectedPos.cell] = NPOS;
-
-		TPacketGCAuraRefine Packet;
-		Packet.wSize = sizeof(TPacketGCAuraRefine) + sizeof(TSubPacketGCAuraRefineClearSlot);
-		Packet.bSubHeader = AURA_REFINE_SUBHEADER_GC_CLEAR_SLOT;
-
-		TSubPacketGCAuraRefineClearSlot SubPacket;
-		SubPacket.bSlotIndex = SelectedPos.cell;
-
-		TEMP_BUFFER TempBuffer;
-		TempBuffer.write(&Packet, sizeof(TPacketGCAuraRefine));
-		TempBuffer.write(&SubPacket, sizeof(TSubPacketGCAuraRefineClearSlot));
-		pDesc->Packet(TempBuffer.read_peek(), TempBuffer.size());
-	}
-}
-
-void CHARACTER::AuraRefineWindowAccept(BYTE bType)
-{
-	if (m_bAuraRefineWindowType != bType)
-		return;
-
-	if (m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN] == NPOS || m_pAuraRefineWindowItemSlot[AURA_SLOT_SUB] == NPOS)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Aura] You have to insert items."));
-		return;
-	}
-
-	const LPDESC pDesc = GetDesc();
-	if (pDesc == nullptr)
-	{
-		sys_err("AcceRefineWindowAccept(bType=%d): NULL DESC char %s", bType, GetName());
-		return;
-	}
-
-	if (!IsAuraRefineWindowOpen())
-		return;
-
-	if (!IsAuraRefineWindowCanRefine())
-		if (!IsAuraRefineWindowOpen() || !GetAuraRefineWindowOpener())
-			return;
-
-	const LPITEM pMainItem = GetItem(m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN]);
-	if (!pMainItem || !m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN].IsValidItemPosition())
-		return;
-
-	const LPITEM pSubItem = GetItem(m_pAuraRefineWindowItemSlot[AURA_SLOT_SUB]);
-	if (!pSubItem || !m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN].IsValidItemPosition())
-		return;
-
-	if (pMainItem->IsExchanging() || pSubItem->IsExchanging())
-		return;
-
-	if (pMainItem->IsEquipped() || pSubItem->IsEquipped())
-		return;
-
-#if defined(__SOUL_BIND_SYSTEM__)
-	if (pMainItem->IsSealed() || pSubItem->IsSealed())
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Aura] Does not work with soulbound items."));
-		return;
-	}
-#endif
-
-	switch (m_bAuraRefineWindowType)
-	{
-		case AURA_WINDOW_TYPE_ABSORB:
-		{
-			pMainItem->Lock(false);
-
-			const long lLevelSocket = pMainItem->GetSocket(ITEM_SOCKET_AURA_LEVEL_VALUE);
-
-			pSubItem->CopySocketTo(pMainItem);
-			pSubItem->CopyAttributeTo(pMainItem);
-#if defined(__ITEM_APPLY_RANDOM__)
-			pSubItem->CopyRandomAppliesTo(pMainItem);
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-			pSubItem->CopyElementTo(pMainItem);
-#endif
-
-			pMainItem->SetSocket(ITEM_SOCKET_AURA_DRAIN_ITEM_VNUM, pSubItem->GetOriginalVnum());
-			pMainItem->SetSocket(ITEM_SOCKET_AURA_LEVEL_VALUE, lLevelSocket);
-#if defined(__SET_ITEM__)
-			pMainItem->SetItemSetValue(pSubItem->GetItemSetValue());
-#endif
-			pMainItem->UpdatePacket();
-
-			ITEM_MANAGER::Instance().RemoveItem(pSubItem, "AURA SUB ITEM REMOVE (ABSORPTION SUCCESS)");
-
-			m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN] = NPOS;
-			m_pAuraRefineWindowItemSlot[AURA_SLOT_SUB] = NPOS;
-
-			TPacketGCAuraRefine Packet;
-			Packet.wSize = sizeof(TPacketGCAuraRefine);
-			Packet.bSubHeader = AURA_REFINE_SUBHEADER_GC_CLEAR_ALL;
-			pDesc->Packet(&Packet, sizeof(TPacketGCAuraRefine));
-		}
-		break;
-
-		case AURA_WINDOW_TYPE_GROWTH:
-		{
-			const long lLevelSocket = pMainItem->GetSocket(ITEM_SOCKET_AURA_LEVEL_VALUE);
-			BYTE bNextLevel = (lLevelSocket / 100000) - 1000;
-			const int* aiAuraRefineTable = GetAuraRefineInfo(bNextLevel);
-			WORD wCurExp = lLevelSocket % 100000;
-
-			if (bNextLevel == aiAuraRefineTable[AURA_REFINE_INFO_LEVEL_MAX] && wCurExp == aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP])
-			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Aura] Cannot be improved."));
-				if (aiAuraRefineTable[AURA_REFINE_INFO_STEP] == AURA_GRADE_RADIANT)
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Aura] Your Aura Outfit has reached the maximum level."));
-
-				return;
-			}
-
-			int iAdditionalExp = pSubItem->GetCount() * pSubItem->GetValue(ITEM_AURA_MATERIAL_EXP_VALUE);
-			WORD wUsedItemCount = 0;
-			while (true)
-			{
-				wUsedItemCount += 1;
-				int iNeedExp = aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP] - wCurExp;
-
-				if (wCurExp + iAdditionalExp < aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP])
-				{
-					wCurExp += iAdditionalExp;
-					iAdditionalExp = 0;
-					wUsedItemCount = pSubItem->GetCount();
-					break;
-				}
-
-				if (bNextLevel >= aiAuraRefineTable[AURA_REFINE_INFO_LEVEL_MAX])
-				{
-					if (wCurExp + pSubItem->GetValue(ITEM_AURA_MATERIAL_EXP_VALUE) >= aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP])
-					{
-						wCurExp += iNeedExp;
-						iAdditionalExp -= iNeedExp;
-						break;
-					}
-				}
-
-				if (wCurExp + pSubItem->GetValue(ITEM_AURA_MATERIAL_EXP_VALUE) >= aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP])
-				{
-					wCurExp = 0;
-					iAdditionalExp -= iNeedExp;
-					bNextLevel += 1;
-					continue;
-				}
-
-				wCurExp += pSubItem->GetValue(ITEM_AURA_MATERIAL_EXP_VALUE);
-				iAdditionalExp -= pSubItem->GetValue(ITEM_AURA_MATERIAL_EXP_VALUE);
-			}
-
-			pMainItem->Lock(false);
-			pMainItem->SetSocket(ITEM_SOCKET_AURA_LEVEL_VALUE, (1000 + bNextLevel) * 100000 + wCurExp);
-			pMainItem->UpdatePacket();
-
-			if (bNextLevel == aiAuraRefineTable[AURA_REFINE_INFO_LEVEL_MAX] && wCurExp == aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP])
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Aura] Improvement successful. Evolution is now possible."));
-			else
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Aura] Improvement successful!"));
-
-			m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN] = NPOS;
-			m_pAuraRefineWindowItemSlot[AURA_SLOT_SUB] = NPOS;
-
-			TPacketGCAuraRefine Packet;
-			Packet.wSize = sizeof(TPacketGCAuraRefine);
-			Packet.bSubHeader = AURA_REFINE_SUBHEADER_GC_CLEAR_ALL;
-			pDesc->Packet(&Packet, sizeof(TPacketGCAuraRefine));
-
-			if (IS_SET(pSubItem->GetFlag(), ITEM_FLAG_STACKABLE) && !IS_SET(pSubItem->GetAntiFlag(), ITEM_ANTIFLAG_STACK) && pSubItem->GetCount() > wUsedItemCount)
-			{
-				pSubItem->Lock(false);
-				pSubItem->SetCount(pSubItem->GetCount() - wUsedItemCount);
-			}
-			else
-				ITEM_MANAGER::Instance().RemoveItem(pSubItem, "AURA SUB ITEM REMOVE (GROWTH SUCCESS)");
-		}
-		break;
-
-		case AURA_WINDOW_TYPE_EVOLVE:
-		{
-			const long lLevelSocket = pMainItem->GetSocket(ITEM_SOCKET_AURA_LEVEL_VALUE);
-			BYTE bNextLevel = (lLevelSocket / 100000) - 1000;
-			const int* aiAuraRefineTable = GetAuraRefineInfo(bNextLevel);
-			WORD wCurExp = lLevelSocket % 100000;
-
-			if (bNextLevel < aiAuraRefineTable[AURA_REFINE_INFO_LEVEL_MAX] || wCurExp != aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP] || aiAuraRefineTable[AURA_REFINE_INFO_STEP] == AURA_GRADE_RADIANT)
-			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Aura] Cannot be evolved."));
-				if (aiAuraRefineTable[AURA_REFINE_INFO_STEP] == AURA_GRADE_RADIANT)
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Aura] Your Aura Outfit has reached the maximum level."));
-
-				return;
-			}
-
-			const int iPrice = static_cast<int>(aiAuraRefineTable[AURA_REFINE_INFO_NEED_GOLD]);
-			if (GetGold() < iPrice)
-			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Aura] You dont have enough money to evolve your Aura Outfit."));
-				return;
-			}
-
-			if (CountSpecifyItem(aiAuraRefineTable[AURA_REFINE_INFO_MATERIAL_VNUM]) < aiAuraRefineTable[AURA_REFINE_INFO_MATERIAL_COUNT])
-				return;
-
-			const BYTE bRefinePct = aiAuraRefineTable[AURA_REFINE_INFO_EVOLVE_PCT];
-			DWORD dwRefinedAuraVnum = pMainItem->GetRefineSet() == 409 ? pMainItem->GetRefinedVnum() : pMainItem->GetOriginalVnum();
-			if (number(1, 100) <= bRefinePct)
-			{
-				const LPITEM pNewItem = ITEM_MANAGER::Instance().CreateItem(dwRefinedAuraVnum, 1, 0, false);
-				if (pNewItem)
-				{
-					pMainItem->Lock(false);
-					pMainItem->CopySocketTo(pNewItem);
-					pMainItem->CopyAttributeTo(pNewItem);
-#if defined(__ITEM_APPLY_RANDOM__)
-					pMainItem->CopyRandomAppliesTo(pNewItem);
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-					pMainItem->CopyElementTo(pNewItem);
-#endif
-
-					pNewItem->SetSocket(ITEM_SOCKET_AURA_LEVEL_VALUE, (1000 + bNextLevel + 1) * 100000);
-#if defined(__SET_ITEM__)
-					pNewItem->SetItemSetValue(pMainItem->GetItemSetValue());
-#endif
-
-					ITEM_MANAGER::Instance().RemoveItem(pMainItem, "AURA MAIN ITEM REMOVE (EVOLVE SUCCESS)");
-
-					pNewItem->AddToCharacter(this, m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN]);
-					ITEM_MANAGER::Instance().FlushDelayedSave(pNewItem);
-
-					if (IS_SET(pSubItem->GetFlag(), ITEM_FLAG_STACKABLE) && !IS_SET(pSubItem->GetAntiFlag(), ITEM_ANTIFLAG_STACK) && pSubItem->GetCount() > aiAuraRefineTable[AURA_REFINE_INFO_MATERIAL_COUNT])
-					{
-						pSubItem->Lock(false);
-						pSubItem->SetCount(pSubItem->GetCount() - aiAuraRefineTable[AURA_REFINE_INFO_MATERIAL_COUNT]);
-					}
-					else
-						ITEM_MANAGER::Instance().RemoveItem(pSubItem, "AURA SUB ITEM REMOVE (EVOLVE SUCCESS)");
-
-					PointChange(POINT_GOLD, -iPrice, true);
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Aura] Evolution successful!"));
-
-					m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN] = NPOS;
-					m_pAuraRefineWindowItemSlot[AURA_SLOT_SUB] = NPOS;
-
-					TPacketGCAuraRefine Packet;
-					Packet.wSize = sizeof(TPacketGCAuraRefine);
-					Packet.bSubHeader = AURA_REFINE_SUBHEADER_GC_CLEAR_ALL;
-					pDesc->Packet(&Packet, sizeof(TPacketGCAuraRefine));
-				}
-				else
-				{
-					sys_err("AuraRefineWindowAccept:: ITEM VNUM %d cannot be created for CHAR %s, Window Type %d",
-						dwRefinedAuraVnum, GetName(), bType);
-				}
-			}
-			else
-			{
-				if (IS_SET(pSubItem->GetFlag(), ITEM_FLAG_STACKABLE) && !IS_SET(pSubItem->GetAntiFlag(), ITEM_ANTIFLAG_STACK) && pSubItem->GetCount() > aiAuraRefineTable[AURA_REFINE_INFO_MATERIAL_COUNT])
-				{
-					pSubItem->SetCount(pSubItem->GetCount() - aiAuraRefineTable[AURA_REFINE_INFO_MATERIAL_COUNT]);
-				}
-				else
-					ITEM_MANAGER::Instance().RemoveItem(pSubItem, "AURA SUB ITEM REMOVE (EVOLVE FAIL)");
-
-				pMainItem->Lock(false);
-				m_pAuraRefineWindowItemSlot[AURA_SLOT_SUB] = NPOS;
-
-				TPacketGCAuraRefine Packet;
-				Packet.wSize = sizeof(TPacketGCAuraRefine) + sizeof(TSubPacketGCAuraRefineClearSlot);
-				Packet.bSubHeader = AURA_REFINE_SUBHEADER_GC_CLEAR_SLOT;
-
-				TSubPacketGCAuraRefineClearSlot SubPacket;
-				SubPacket.bSlotIndex = AURA_SLOT_SUB;
-
-				TEMP_BUFFER TempBuffer;
-				TempBuffer.write(&Packet, sizeof(TPacketGCAuraRefine));
-				TempBuffer.write(&SubPacket, sizeof(TSubPacketGCAuraRefineClearSlot));
-				pDesc->Packet(TempBuffer.read_peek(), TempBuffer.size());
-
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("Upgrade change failed."));
-			}
-		}
-		break;
-	}
-}
-
-void CHARACTER::ModifyAuraPoints(const LPITEM& rAuraItem, bool bAdd)
-{
-	float fDrainPer = 0.0f;
-
-	const long lLevelSocket = rAuraItem->GetSocket(ITEM_SOCKET_AURA_LEVEL_VALUE);
-	const long lDrainSocket = rAuraItem->GetSocket(ITEM_SOCKET_AURA_DRAIN_ITEM_VNUM);
-
-	BYTE bCurLevel = (lLevelSocket / 100000) - 1000;
-	fDrainPer = (1.0f * bCurLevel / 10.0f) / 100.0f;
-
-	TItemTable* pDrainedItem = nullptr;
-	if (lDrainSocket != 0)
-		pDrainedItem = ITEM_MANAGER::Instance().GetTable(lDrainSocket);
-
-	if (pDrainedItem != nullptr && (pDrainedItem->bType == ITEM_ARMOR))
-	{
-		switch (pDrainedItem->bSubType)
-		{
-			case ARMOR_SHIELD:
-			case ARMOR_WRIST:
-			case ARMOR_NECK:
-			case ARMOR_EAR:
-			{
-				for (BYTE bApplyIndex = 0; bApplyIndex < ITEM_APPLY_MAX_NUM; ++bApplyIndex)
-				{
-					if (pDrainedItem->aApplies[bApplyIndex].wType == APPLY_NONE || pDrainedItem->aApplies[bApplyIndex].wType == APPLY_MOUNT || pDrainedItem->aApplies[bApplyIndex].wType == APPLY_MOV_SPEED || pDrainedItem->aApplies[bApplyIndex].lValue <= 0)
-						continue;
-
-					float fValue = pDrainedItem->aApplies[bApplyIndex].lValue * fDrainPer;
-					int iValue = static_cast<int>((fValue < 1.0f) ? ceilf(fValue) : truncf(fValue));
-					if (pDrainedItem->aApplies[bApplyIndex].wType == APPLY_SKILL)
-						ApplyPoint(pDrainedItem->aApplies[bApplyIndex].wType, bAdd ? iValue : iValue ^ 0x00800000);
-#if defined(__ITEM_APPLY_RANDOM__)
-					else if (pDrainedItem->aApplies[bApplyIndex].wType == APPLY_RANDOM)
-					{
-						const TPlayerItemAttribute& rRandomApply = rAuraItem->GetRandomApply(bApplyIndex);
-						if (rRandomApply.lValue <= 0)
-							continue;
-
-						fValue = rRandomApply.lValue * fDrainPer;
-						iValue = static_cast<int>((fValue < 1.0f) ? ceilf(fValue) : truncf(fValue));
-						if (rRandomApply.wType == APPLY_SKILL)
-							ApplyPoint(rRandomApply.wType, bAdd ? iValue : iValue ^ 0x00800000);
-						else
-							ApplyPoint(rRandomApply.wType, bAdd ? iValue : -iValue);
-					}
-#endif
-					else
-						ApplyPoint(pDrainedItem->aApplies[bApplyIndex].wType, bAdd ? iValue : -iValue);
-				}
-			}
-			break;
-		}
-	}
-
-	for (BYTE bAttrIndex = 0; bAttrIndex < ITEM_ATTRIBUTE_MAX_NUM; ++bAttrIndex)
-	{
-		if (rAuraItem->GetAttributeType(bAttrIndex))
-		{
-			const TPlayerItemAttribute& rItemAttribute = rAuraItem->GetAttribute(bAttrIndex);
-			if (rItemAttribute.lValue <= 0)
-				continue;
-
-			float fValue = rItemAttribute.lValue * fDrainPer;
-			int iDrainValue = static_cast<int>((fValue < 1.0f) ? ceilf(fValue) : truncf(fValue));
-			if (rItemAttribute.wType == APPLY_SKILL)
-				ApplyPoint(rItemAttribute.wType, bAdd ? iDrainValue : iDrainValue ^ 0x00800000);
-			else
-				ApplyPoint(rItemAttribute.wType, bAdd ? iDrainValue : -iDrainValue);
-		}
-	}
-}
-
-TAuraRefineInfo CHARACTER::__GetAuraRefineInfo(TItemPos ItemPos)
-{
-	TAuraRefineInfo RefineInfo = {};
-	const LPITEM pItem = GetItem(ItemPos);
-	if (pItem == nullptr)
-	{
-		RefineInfo.bLevel = 0;
-		RefineInfo.bExpPercent = 0;
-		return RefineInfo;
-	}
-
-	const long lLevelSocket = pItem->GetSocket(ITEM_SOCKET_AURA_LEVEL_VALUE);
-	RefineInfo.bLevel = (lLevelSocket / 100000) - 1000;
-	const int* aiAuraRefineTable = GetAuraRefineInfo(RefineInfo.bLevel);
-	RefineInfo.bExpPercent = static_cast<BYTE>((lLevelSocket % 100000) * 1.0f / aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP] * 100);
-	return RefineInfo;
-}
-
-TAuraRefineInfo CHARACTER::__CalcAuraRefineInfo(TItemPos MainPos, TItemPos SubPos)
-{
-	TAuraRefineInfo RefineInfo = {};
-	const LPITEM pMainItem = GetItem(MainPos);
-	const LPITEM pSubItem = GetItem(SubPos);
-	if (pMainItem == nullptr || pSubItem == nullptr)
-	{
-		RefineInfo.bLevel = 0;
-		RefineInfo.bExpPercent = 0;
-		return RefineInfo;
-	}
-
-	const long lLevelSocket = pMainItem->GetSocket(ITEM_SOCKET_AURA_LEVEL_VALUE);
-	BYTE bNextLevel = (lLevelSocket / 100000) - 1000;
-	const int* aiAuraRefineTable = GetAuraRefineInfo(bNextLevel);
-	WORD wCurExp = lLevelSocket % 100000;
-	int iAdditionalExp = pSubItem->GetCount() * pSubItem->GetValue(ITEM_AURA_MATERIAL_EXP_VALUE);
-	WORD wUsedItemCount = 0;
-	while (true)
-	{
-		wUsedItemCount += 1;
-		int iNeedExp = aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP] - wCurExp;
-
-		if (wCurExp + iAdditionalExp < aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP])
-		{
-			wCurExp += iAdditionalExp;
-			iAdditionalExp = 0;
-			wUsedItemCount = pSubItem->GetCount();
-			break;
-		}
-
-		if (bNextLevel >= aiAuraRefineTable[AURA_REFINE_INFO_LEVEL_MAX])
-		{
-			if (wCurExp + pSubItem->GetValue(ITEM_AURA_MATERIAL_EXP_VALUE) >= aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP])
-			{
-				wCurExp += iNeedExp;
-				iAdditionalExp -= iNeedExp;
-				break;
-			}
-		}
-
-		if (wCurExp + pSubItem->GetValue(ITEM_AURA_MATERIAL_EXP_VALUE) >= aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP])
-		{
-			wCurExp = 0;
-			iAdditionalExp -= iNeedExp;
-			bNextLevel += 1;
-			continue;
-		}
-
-		wCurExp += pSubItem->GetValue(ITEM_AURA_MATERIAL_EXP_VALUE);
-		iAdditionalExp -= pSubItem->GetValue(ITEM_AURA_MATERIAL_EXP_VALUE);
-	}
-
-	RefineInfo.bLevel = bNextLevel;
-	RefineInfo.bExpPercent = static_cast<BYTE>(wCurExp * 1.0f / aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP] * 100);
-	return RefineInfo;
-}
-
-TAuraRefineInfo CHARACTER::__GetAuraEvolvedRefineInfo(TItemPos ItemPos)
-{
-	TAuraRefineInfo RefineInfo = {};
-	RefineInfo.bLevel = 0;
-	RefineInfo.bExpPercent = 0;
-
-	const LPITEM pItem = GetItem(ItemPos);
-	if (pItem == nullptr)
-		return RefineInfo;
-
-	const long lLevelSocket = pItem->GetSocket(ITEM_SOCKET_AURA_LEVEL_VALUE);
-	BYTE bCurLevel = (lLevelSocket / 100000) - 1000;
-	const int* aiAuraRefineTable = GetAuraRefineInfo(bCurLevel);
-	WORD wCurExp = lLevelSocket % 100000;
-
-	if (bCurLevel < aiAuraRefineTable[AURA_REFINE_INFO_LEVEL_MAX] || wCurExp < aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP])
-		return RefineInfo;
-
-	if (aiAuraRefineTable[AURA_REFINE_INFO_STEP] == AURA_GRADE_RADIANT)
-		return RefineInfo;
-
-	RefineInfo.bLevel = bCurLevel + 1;
-	return RefineInfo;
-}
-#endif
+#include "stdafx.h"
+#include "config.h"
+#include "char.h"
+#include "item.h"
+#include "desc.h"
+#include "log.h"
+#include "item_manager.h"
+#include "buffer_manager.h"
+#include "unique_item.h"
+#include "utils.h"
+#include "constants.h"
+
+#ifdef __AURA_SYSTEM__
+void CHARACTER::OpenAuraRefineWindow(LPENTITY pOpener, EAuraWindowType type)
+{
+	if (IsAuraRefineWindowOpen())
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> ƿ  â ÿ ϳ   ֽϴ."));
+		return;
+	}
+
+	int iDist = DISTANCE_APPROX(GetX() - pOpener->GetX(), GetY() - pOpener->GetY());
+	if (iDist >= AURA_REFINE_MAX_DISTANCE)
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> ƿ â   ϴ."));
+		return;
+	}
+
+	TEMP_BUFFER buf;
+	TPacketGCAura pack;
+	TSubPacketGCAuraOpenClose sub;
+	pack.wSize = sizeof(TPacketGCAura) + sizeof(TSubPacketGCAuraOpenClose);
+	pack.bSubHeader = AURA_SUBHEADER_GC_OPEN;
+	switch (type)
+	{
+		case AURA_WINDOW_TYPE_ABSORB:
+		case AURA_WINDOW_TYPE_GROWTH:
+		case AURA_WINDOW_TYPE_EVOLVE:
+			sub.bAuraWindowType = type;
+			break;
+		case AURA_WINDOW_TYPE_MAX:
+			return;
+	}
+
+	LPDESC desc = GetDesc();
+	if (!desc)
+	{
+		sys_err("User(%s)'s DESC is NULL POINT.", GetName());
+		return;
+	}
+
+	buf.write(&pack, sizeof(TPacketGCAura));
+	buf.write(&sub, sizeof(TSubPacketGCAuraOpenClose));
+
+	if (NULL == m_pointsInstant.m_pAuraRefineWindowOpener)
+		m_pointsInstant.m_pAuraRefineWindowOpener = pOpener;
+
+	m_bAuraRefineWindowType = type;
+	m_bAuraRefineWindowOpen = AURA_WINDOW_TYPE_MAX != m_bAuraRefineWindowType;
+
+	desc->Packet(buf.read_peek(), buf.size());
+}
+
+void CHARACTER::AuraRefineWindowClose()
+{
+	LPDESC desc = GetDesc();
+	if (!desc)
+	{
+		sys_err("User(%s)'s DESC is NULL POINT.", GetName());
+		return;
+	}
+
+	m_pointsInstant.m_pAuraRefineWindowOpener = NULL;
+	m_bAuraRefineWindowType = AURA_WINDOW_TYPE_MAX;
+	m_bAuraRefineWindowOpen = false;
+	for (BYTE i = 0; i < AURA_SLOT_MAX; ++i)
+	{
+		if (m_pAuraRefineWindowItemSlot[i] != NPOS)
+		{
+			LPITEM pItem = GetItem(m_pAuraRefineWindowItemSlot[i]);
+			if (pItem)
+				pItem->Lock(false);
+			m_pAuraRefineWindowItemSlot[i] = NPOS;
+		}
+	}
+
+	TPacketGCAura pack;
+	TSubPacketGCAuraOpenClose sub;
+	pack.bSubHeader = AURA_SUBHEADER_GC_CLOSE;
+	pack.wSize = sizeof(TPacketGCAura) + sizeof(TSubPacketGCAuraOpenClose);
+
+	sub.bAuraWindowType = AURA_WINDOW_TYPE_MAX;
+
+	TEMP_BUFFER buf;
+	buf.write(&pack, sizeof(TPacketGCAura));
+	buf.write(&sub, sizeof(TSubPacketGCAuraOpenClose));
+	desc->Packet(buf.read_peek(), buf.size());
+}
+
+bool CHARACTER::IsAuraRefineWindowCanRefine()
+{
+	if (!CanHandleItem())
+		return false;
+
+	if (!IsAuraRefineWindowOpen())
+		return false;
+
+	LPENTITY pOpener = GetAuraRefineWindowOpener();
+	if (!pOpener)
+		return false;
+
+	int iDist = DISTANCE_APPROX(GetX() - pOpener->GetX(), GetY() - pOpener->GetY());
+	if (iDist >= AURA_REFINE_MAX_DISTANCE)
+		return false;
+
+	return true;
+}
+
+BYTE CHARACTER::__GetAuraAbsorptionRate(BYTE bLevel, BYTE bBoostIndex) const
+{
+	BYTE bBoostValue = 0;
+	if (bBoostIndex > ITEM_AURA_BOOST_ERASER && bBoostIndex < ITEM_AURA_BOOST_MAX)
+	{
+		DWORD dwBoosterItemVnum = ITEM_AURA_BOOST_ITEM_VNUM_BASE + bBoostIndex;
+		TItemTable* pProto = ITEM_MANAGER::instance().GetTable(dwBoosterItemVnum);
+		if (!pProto)
+		{
+			sys_err("THERE IS NO PROTO FOR AURA BOOST ITEM %lu", dwBoosterItemVnum);
+		}
+		else
+			bBoostValue += BYTE(pProto->alValues[ITEM_AURA_BOOST_PERCENT_VALUE]);
+	}
+
+	return bBoostValue;
+}
+
+TAuraRefineInfo CHARACTER::__GetAuraRefineInfo(TItemPos Cell)
+{
+	TAuraRefineInfo info;
+
+	LPITEM pItem = GetItem(Cell);
+	if (!pItem)
+	{
+		info.bAuraRefineInfoLevel = 0;
+		info.bAuraRefineInfoExpPercent = 0;
+		return info;
+	}
+
+	const long c_lLevelSocket = pItem->GetSocket(ITEM_SOCKET_AURA_CURRENT_LEVEL);
+	info.bAuraRefineInfoLevel = (c_lLevelSocket / 100000) - 1000;
+	int* aiAuraRefineTable = GetAuraRefineInfo(info.bAuraRefineInfoLevel);
+	info.bAuraRefineInfoExpPercent = BYTE((c_lLevelSocket % 100000) * 1.0f / aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP] * 100);
+	return info;
+}
+
+TAuraRefineInfo CHARACTER::__CalcAuraRefineInfo(TItemPos Cell, TItemPos MaterialCell)
+{
+	TAuraRefineInfo info;
+	LPITEM pItem = GetItem(Cell);
+	LPITEM pMaterial = GetItem(MaterialCell);
+	if (!pItem || !pMaterial)
+	{
+		info.bAuraRefineInfoLevel = 0;
+		info.bAuraRefineInfoExpPercent = 0;
+		return info;
+	}
+
+	const long c_lLevelSocket = pItem->GetSocket(ITEM_SOCKET_AURA_CURRENT_LEVEL);
+	BYTE bNextLevel = (c_lLevelSocket / 100000) - 1000;
+	int* aiAuraRefineTable = GetAuraRefineInfo(bNextLevel);
+	WORD wCurExp = c_lLevelSocket % 100000;
+	int iAdditionalExp = pMaterial->GetCount() * pMaterial->GetValue(ITEM_AURA_MATERIAL_EXP_VALUE);
+	WORD wUsedItemCount = 0;
+	while (true)
+	{
+		wUsedItemCount += 1;
+		int iNeedExp = aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP] - wCurExp;
+
+		if (wCurExp + iAdditionalExp < aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP])
+		{
+			wCurExp += iAdditionalExp;
+			iAdditionalExp = 0;
+			wUsedItemCount = pMaterial->GetCount();
+			break;
+		}
+
+		if (bNextLevel >= aiAuraRefineTable[AURA_REFINE_INFO_LEVEL_MAX])
+		{
+			if (wCurExp + pMaterial->GetValue(ITEM_AURA_MATERIAL_EXP_VALUE) >= aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP])
+			{
+				wCurExp += iNeedExp;
+				iAdditionalExp -= iNeedExp;
+				break;
+			}
+		}
+
+		if (wCurExp + pMaterial->GetValue(ITEM_AURA_MATERIAL_EXP_VALUE) >= aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP])
+		{
+			wCurExp = 0;
+			iAdditionalExp -= iNeedExp;
+			bNextLevel += 1;
+			continue;
+		}
+
+		wCurExp += pMaterial->GetValue(ITEM_AURA_MATERIAL_EXP_VALUE);
+		iAdditionalExp -= pMaterial->GetValue(ITEM_AURA_MATERIAL_EXP_VALUE);
+	}
+
+	info.bAuraRefineInfoLevel = bNextLevel;
+	info.bAuraRefineInfoExpPercent = BYTE(wCurExp * 1.0f / aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP] * 100);
+	return info;
+}
+
+TAuraRefineInfo CHARACTER::__GetAuraEvolvedRefineInfo(TItemPos Cell)
+{
+	TAuraRefineInfo info;
+	info.bAuraRefineInfoLevel = 0;
+	info.bAuraRefineInfoExpPercent = 0;
+
+	LPITEM pItem = GetItem(Cell);
+	if (!pItem)
+		return info;
+
+	const long c_lLevelSocket = pItem->GetSocket(ITEM_SOCKET_AURA_CURRENT_LEVEL);
+	BYTE bCurLevel = (c_lLevelSocket / 100000) - 1000;
+	int* aiAuraRefineTable = GetAuraRefineInfo(bCurLevel);
+	WORD wCurExp = c_lLevelSocket % 100000;
+
+	if (bCurLevel < aiAuraRefineTable[AURA_REFINE_INFO_LEVEL_MAX] || wCurExp < aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP])
+		return info;
+
+	if (aiAuraRefineTable[AURA_REFINE_INFO_STEP] == AURA_GRADE_RADIANT)
+		return info;
+
+	info.bAuraRefineInfoLevel = bCurLevel + 1;
+	return info;
+}
+
+void CHARACTER::AuraRefineWindowCheckIn(BYTE bAuraRefineWindowType, TItemPos AuraCell, TItemPos ItemCell)
+{ 
+	// ChatPacket(CHAT_TYPE_INFO, "checkin with AuraCell(%u, %u) AURA_REFINE(%d) ItemCell(%u, %u) on WindowType(%u)", AuraCell.window_type, AuraCell.cell, AURA_REFINE, ItemCell.window_type, ItemCell.cell, bAuraRefineWindowType);
+	if (AuraCell.window_type != AURA_REFINE || AuraCell.cell >= AURA_SLOT_RESULT)
+		return;
+
+	LPDESC desc = GetDesc();
+	if (!desc)
+	{
+		sys_err("User(%s)'s DESC is NULL POINT.", GetName());
+		return;
+	}
+
+	if (!IsAuraRefineWindowOpen())
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  Ư   â մϴ."));
+		return;
+	}
+
+	if (!IsAuraRefineWindowCanRefine())
+	{
+		if (IsAuraRefineWindowOpen() && NULL != GetAuraRefineWindowOpener())
+		{
+#if _WIN32
+			__asm {
+				nop;
+			}
+#endif
+		}
+		else
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> μ Ϸ  â ʽÿ."));
+			return;
+		}
+	}
+
+	if (m_bAuraRefineWindowType != bAuraRefineWindowType)
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> ƿ  μ  ߻Ͽ   ϴ."));
+		return;
+	}
+
+	switch (bAuraRefineWindowType)
+	{
+		case AURA_WINDOW_TYPE_ABSORB:
+		{
+			if (!ItemCell.IsValidItemPosition())
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  ׸    ϴ."));
+				return;
+			}
+
+			if (ItemCell.IsEquipPosition())
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>         ϴ."));
+				return;
+			}
+
+			LPITEM pItem = GetItem(ItemCell);
+			if (!pItem)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> ǵ   ߻߽ϴ."));
+				return;
+			}
+
+			/*
+				New antiflag for special items which cannot be absorbed
+			*/
+			//if (IS_SET(pItem->GetAntiFlag(), ITEM_ANTIFLAG_ABSORB))
+			//{
+			//	ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>        ϴ."));
+			//	return;
+			//}
+
+			if (pItem->IsExchanging())
+				return;
+
+			if (pItem->isLocked())
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>   Ǹ      ϴ."));
+				return;
+			}
+
+#ifdef __SOUL_BIND_SYSTEM__
+			if (pItem->IsSealed())
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>   ȥ        ϴ."));
+				return;
+			}
+#endif
+
+			if (AuraCell.cell == AURA_SLOT_MAIN && !(pItem->GetType() == ITEM_COSTUME && pItem->GetSubType() == COSTUME_AURA))
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  Կ  ǻ     ֽϴ."));
+				return;
+			}
+
+			if (AuraCell.cell == AURA_SLOT_MAIN && pItem->GetSocket(ITEM_SOCKET_AURA_DRAIN_ITEM_VNUM))
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  ƿ ǻ ̹   ֽϴ."));
+				return;
+			}
+
+			if (AuraCell.cell == AURA_SLOT_SUB && !(pItem->GetType() == ITEM_ARMOR && (pItem->GetSubType() == ARMOR_SHIELD || pItem->GetSubType() == ARMOR_WRIST || pItem->GetSubType() == ARMOR_NECK || pItem->GetSubType() == ARMOR_EAR)))
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  Կ , ,   Ͱ     ֽϴ."));
+				return;
+			}
+
+			if (m_pAuraRefineWindowItemSlot[AuraCell.cell] != NPOS)
+				return;
+
+			pItem->Lock(true);
+
+			m_pAuraRefineWindowItemSlot[AuraCell.cell] = ItemCell;
+
+			TPacketGCAura pack;
+			TSubPacketGCAuraSetItem sub;
+			pack.wSize = sizeof(TPacketGCAura) + sizeof(TSubPacketGCAuraSetItem);
+			pack.bSubHeader = AURA_SUBHEADER_GC_SET_ITEM;
+
+			sub.Cell = ItemCell;
+			sub.AuraCell = AuraCell;
+			sub.vnum = pItem->GetVnum();
+			sub.count = pItem->GetCount();
+#if defined(__SOUL_BIND_SYSTEM__)
+			sub.soulbind = pItem->GetSealedTime();
+#endif
+#if defined(__CHANGE_LOOK_SYSTEM__)
+			sub.transmutation = pItem->GetTransmutation();
+#endif
+			sub.flags = pItem->GetFlag();
+			sub.anti_flags = pItem->GetAntiFlag();
+			thecore_memcpy(sub.alSockets, pItem->GetSockets(), sizeof(sub.alSockets));
+			thecore_memcpy(sub.aAttr, pItem->GetAttributes(), sizeof(sub.aAttr));
+
+			TEMP_BUFFER buf;
+			buf.write(&pack, sizeof(TPacketGCAura));
+			buf.write(&sub, sizeof(TSubPacketGCAuraSetItem));
+			desc->Packet(buf.read_peek(), buf.size());
+
+			if (NPOS != m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN] && NPOS != m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN])
+			{
+				LPITEM srcItem = GetItem(m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN]);
+				if (!srcItem || !IsValidItemPosition(m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN]) || srcItem->IsExchanging() || srcItem->IsEquipped())
+					return;
+
+				LPITEM mtrlItem = GetItem(m_pAuraRefineWindowItemSlot[AURA_SLOT_SUB]);
+				if (!mtrlItem || !IsValidItemPosition(m_pAuraRefineWindowItemSlot[AURA_SLOT_SUB]) || mtrlItem->IsExchanging() || mtrlItem->IsEquipped())
+					return;
+
+				TPacketGCAura pack2;
+				TSubPacketGCAuraSetItem sub2;
+				pack2.wSize = sizeof(TPacketGCAura) + sizeof(TSubPacketGCAuraSetItem);
+				pack2.bSubHeader = AURA_SUBHEADER_GC_SET_ITEM;
+
+				sub2.Cell = TItemPos(RESERVED_WINDOW, 0);
+				sub2.AuraCell = TItemPos(AURA_REFINE, AURA_SLOT_RESULT);
+				sub2.vnum = srcItem->GetOriginalVnum();
+				sub2.count = srcItem->GetCount();
+#if defined(__SOUL_BIND_SYSTEM__)
+				sub2.soulbind = srcItem->GetSealedTime();
+#endif
+#if defined(__CHANGE_LOOK_SYSTEM__)
+				sub2.transmutation = srcItem->GetTransmutation();
+#endif
+				sub2.flags = srcItem->GetFlag();
+				sub2.anti_flags = srcItem->GetAntiFlag();
+				thecore_memcpy(sub2.alSockets, srcItem->GetSockets(), sizeof(sub2.alSockets));
+				sub2.alSockets[ITEM_SOCKET_AURA_DRAIN_ITEM_VNUM] = mtrlItem->GetOriginalVnum();
+				thecore_memcpy(sub2.aAttr, mtrlItem->GetAttributes(), sizeof(sub2.aAttr));
+
+				TEMP_BUFFER buf;
+				buf.write(&pack2, sizeof(TPacketGCAura));
+				buf.write(&sub2, sizeof(TSubPacketGCAuraSetItem));
+				desc->Packet(buf.read_peek(), buf.size());
+			}
+		}
+		break;
+
+		case AURA_WINDOW_TYPE_GROWTH:
+		{
+			if (!ItemCell.IsValidItemPosition())
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>   ׷̵   ϴ."));
+				return;
+			}
+
+			if (ItemCell.IsEquipPosition())
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> ׷̵带        ϴ."));
+				return;
+			}
+
+			LPITEM pItem = GetItem(ItemCell);
+			if (!pItem)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> ǵ   ߻߽ϴ."));
+				return;
+			}
+
+			/*
+				New antiflag for special items which cannot be absorbed
+			*/
+			//if (IS_SET(pItem->GetAntiFlag(), ITEM_ANTIFLAG_ABSORB))
+			//{
+			//	ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> ׷̵带  ׸ ÷   ϴ."));
+			//	return;
+			//}
+
+			if (pItem->IsExchanging())
+				return;
+
+			if (pItem->isLocked())
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>    ̸ ׷̵带     ϴ."));
+				return;
+			}
+
+#ifdef __SOUL_BIND_SYSTEM__
+			if (pItem->IsSealed())
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>   ȥ   ׷̵带     ϴ."));
+				return;
+			}
+#endif
+
+			if (AuraCell.cell == AURA_SLOT_MAIN)
+			{
+				if (!(pItem->GetType() == ITEM_COSTUME && pItem->GetSubType() == COSTUME_AURA))
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  Կ  ǻ     ֽϴ."));
+					return;
+				}
+				else
+				{
+					const long c_lLevelSocket = pItem->GetSocket(ITEM_SOCKET_AURA_CURRENT_LEVEL);
+					const BYTE c_bCurrentLevel = (c_lLevelSocket / 100000) - 1000;
+					const WORD c_wCurrentExp = c_lLevelSocket % 100000;
+					int* aiAuraRefineTable = GetAuraRefineInfo(c_bCurrentLevel);
+					if (c_bCurrentLevel == aiAuraRefineTable[AURA_REFINE_INFO_LEVEL_MAX] && c_wCurrentExp == aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP])
+					{
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  ƿ ǻ ׷̵   ϴ."));
+						if (aiAuraRefineTable[AURA_REFINE_INFO_STEP] == AURA_GRADE_RADIANT)
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  ƿ ǻ ִ  ޿ ߽ϴ."));
+						else
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> ߰ ܰ üȭ â Ͻʽÿ."));
+						return;
+					}
+				}
+			}
+			if (AuraCell.cell == AURA_SLOT_SUB)
+			{
+				if (NPOS == m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN])
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  ƿ ǻ ؾմϴ."));
+					return;
+				}
+				else if (!(pItem->GetType() == ITEM_RESOURCE && pItem->GetSubType() == RESOURCE_AURA))
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  Կ       ֽϴ."));
+					return;
+				}
+			}
+
+			if (m_pAuraRefineWindowItemSlot[AuraCell.cell] != NPOS)
+				return;
+
+			pItem->Lock(true);
+
+			m_pAuraRefineWindowItemSlot[AuraCell.cell] = ItemCell;
+
+			TPacketGCAura pack;
+			TSubPacketGCAuraSetItem sub;
+			pack.wSize = sizeof(TPacketGCAura) + sizeof(TSubPacketGCAuraSetItem);
+			pack.bSubHeader = AURA_SUBHEADER_GC_SET_ITEM;
+
+			sub.Cell = ItemCell;
+			sub.AuraCell = AuraCell;
+			sub.vnum = pItem->GetVnum();
+			sub.count = pItem->GetCount();
+#if defined(__SOUL_BIND_SYSTEM__)
+			sub.soulbind = pItem->GetSealedTime();
+#endif
+#if defined(__CHANGE_LOOK_SYSTEM__)
+			sub.transmutation = pItem->GetTransmutation();
+#endif
+			sub.flags = pItem->GetFlag();
+			sub.anti_flags = pItem->GetAntiFlag();
+			thecore_memcpy(sub.alSockets, pItem->GetSockets(), sizeof(sub.alSockets));
+			thecore_memcpy(sub.aAttr, pItem->GetAttributes(), sizeof(sub.aAttr));
+
+			TEMP_BUFFER buf;
+			buf.write(&pack, sizeof(TPacketGCAura));
+			buf.write(&sub, sizeof(TSubPacketGCAuraSetItem));
+			desc->Packet(buf.read_peek(), buf.size());
+
+			{
+				LPITEM srcItem = GetItem(ItemCell);
+				if (!srcItem || !ItemCell.IsValidItemPosition() || srcItem->IsExchanging() || srcItem->IsEquipped())
+					return;
+
+				TPacketGCAura pack;
+				TSubPacketGCAuraRefineInfo sub;
+				pack.wSize = sizeof(TPacketGCAura) + sizeof(TSubPacketGCAuraRefineInfo);
+				pack.bSubHeader = AURA_SUBHEADER_GC_REFINE_INFO;
+
+				TAuraRefineInfo info;
+				if (AuraCell.cell == AURA_SLOT_MAIN)
+				{
+					sub.bAuraRefineInfoType = AURA_REFINE_INFO_SLOT_CURRENT;
+					info = __GetAuraRefineInfo(ItemCell);
+				}
+				if (AuraCell.cell == AURA_SLOT_SUB)
+				{
+					sub.bAuraRefineInfoType = AURA_REFINE_INFO_SLOT_NEXT;
+					info = __CalcAuraRefineInfo(m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN], ItemCell);
+				}
+				sub.bAuraRefineInfoLevel = info.bAuraRefineInfoLevel;
+				sub.bAuraRefineInfoExpPercent = info.bAuraRefineInfoExpPercent;
+
+				TEMP_BUFFER buf;
+				buf.write(&pack, sizeof(TPacketGCAura));
+				buf.write(&sub, sizeof(TSubPacketGCAuraRefineInfo));
+				desc->Packet(buf.read_peek(), buf.size());
+			}
+		}
+		break;
+
+		case AURA_WINDOW_TYPE_EVOLVE:
+		{
+			if (!ItemCell.IsValidItemPosition())
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>   ٵ  ϴ."));
+				return;
+			}
+
+			if (ItemCell.IsEquipPosition())
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> ȭ        ϴ."));
+				return;
+			}
+
+			LPITEM pItem = GetItem(ItemCell);
+			if (!pItem)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> ǵ   ߻߽ϴ."));
+				return;
+			}
+
+			if (pItem->IsExchanging())
+				return;
+
+			if (pItem->isLocked())
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>   Ǹ ȭ     ϴ."));
+				return;
+			}
+
+#ifdef __SOUL_BIND_SYSTEM__
+			if (pItem->IsSealed())
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>    ȥ   ȭ    ϴ."));
+				return;
+			}
+#endif
+
+			if (AuraCell.cell == AURA_SLOT_MAIN)
+			{
+				if (!(pItem->GetType() == ITEM_COSTUME && pItem->GetSubType() == COSTUME_AURA))
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  Կ  ǻ     ֽϴ."));
+					return;
+				}
+				else
+				{
+					const long c_lLevelSocket = pItem->GetSocket(ITEM_SOCKET_AURA_CURRENT_LEVEL);
+					const BYTE c_bCurrentLevel = (c_lLevelSocket / 100000) - 1000;
+					const WORD c_wCurrentExp = c_lLevelSocket % 100000;
+					int* aiAuraRefineTable = GetAuraRefineInfo(c_bCurrentLevel);
+					if (!(c_bCurrentLevel == aiAuraRefineTable[AURA_REFINE_INFO_LEVEL_MAX] && c_wCurrentExp == aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP]))
+					{
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  ƿ ǻ     ϴ."));
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> %d ġ %d  ־մϴ."), aiAuraRefineTable[AURA_REFINE_INFO_LEVEL_MAX], aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP]);
+						return;
+					}
+				}
+			}
+
+			if (AuraCell.cell == AURA_SLOT_SUB)
+			{
+				if (NPOS == m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN])
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  ƿ ǻ ؾմϴ."));
+					return;
+				}
+				else
+				{
+					const LPITEM c_pAuraItem = GetItem(m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN]);
+					const long c_lLevelSocket = c_pAuraItem->GetSocket(ITEM_SOCKET_AURA_CURRENT_LEVEL);
+					const BYTE c_bCurrentLevel = (c_lLevelSocket / 100000) - 1000;
+					int* aiAuraRefineTable = GetAuraRefineInfo(c_bCurrentLevel);
+					if (pItem->GetOriginalVnum() != aiAuraRefineTable[AURA_REFINE_INFO_MATERIAL_VNUM])
+					{
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  Կ Ư       ֽϴ."));
+						TItemTable* pTable = ITEM_MANAGER::instance().GetTable(aiAuraRefineTable[AURA_REFINE_INFO_MATERIAL_VNUM]);
+						if (pTable)
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> , %s - %u"), pTable->szLocaleName, aiAuraRefineTable[AURA_REFINE_INFO_MATERIAL_COUNT]);
+						return;
+					}
+				}
+			}
+
+			if (m_pAuraRefineWindowItemSlot[AuraCell.cell] != NPOS)
+				return;
+
+			pItem->Lock(true);
+
+			m_pAuraRefineWindowItemSlot[AuraCell.cell] = ItemCell;
+
+			TPacketGCAura pack;
+			TSubPacketGCAuraSetItem sub;
+			pack.wSize = sizeof(TPacketGCAura) + sizeof(TSubPacketGCAuraSetItem);
+			pack.bSubHeader = AURA_SUBHEADER_GC_SET_ITEM;
+
+			sub.Cell = ItemCell;
+			sub.AuraCell = AuraCell;
+			sub.vnum = pItem->GetVnum();
+			sub.count = pItem->GetCount();
+#if defined(__SOUL_BIND_SYSTEM__)
+			sub.soulbind = pItem->GetSealedTime();
+#endif
+#if defined(__CHANGE_LOOK_SYSTEM__)
+			sub.transmutation = pItem->GetTransmutation();
+#endif
+			sub.flags = pItem->GetFlag();
+			sub.anti_flags = pItem->GetAntiFlag();
+			thecore_memcpy(sub.alSockets, pItem->GetSockets(), sizeof(sub.alSockets));
+			thecore_memcpy(sub.aAttr, pItem->GetAttributes(), sizeof(sub.aAttr));
+
+			TEMP_BUFFER buf;
+			buf.write(&pack, sizeof(TPacketGCAura));
+			buf.write(&sub, sizeof(TSubPacketGCAuraSetItem));
+			desc->Packet(buf.read_peek(), buf.size());
+
+			if (AuraCell.cell == AURA_SLOT_MAIN)
+			{
+				LPITEM srcItem = GetItem(ItemCell);
+				if (!srcItem || !ItemCell.IsValidItemPosition() || srcItem->IsExchanging() || srcItem->IsEquipped())
+					return;
+
+				TPacketGCAura pack;
+				TSubPacketGCAuraRefineInfo sub;
+				TSubPacketGCAuraRefineInfo sub2;
+				pack.wSize = sizeof(TPacketGCAura) + 2*sizeof(TSubPacketGCAuraRefineInfo);
+				pack.bSubHeader = AURA_SUBHEADER_GC_REFINE_INFO;
+
+				TAuraRefineInfo info = __GetAuraRefineInfo(ItemCell);
+				sub.bAuraRefineInfoType = AURA_REFINE_INFO_SLOT_CURRENT;
+				sub.bAuraRefineInfoLevel = info.bAuraRefineInfoLevel;
+				sub.bAuraRefineInfoExpPercent = info.bAuraRefineInfoExpPercent;
+
+				info = __GetAuraEvolvedRefineInfo(ItemCell);
+				sub2.bAuraRefineInfoType = AURA_REFINE_INFO_SLOT_EVOLVED;
+				sub2.bAuraRefineInfoLevel = info.bAuraRefineInfoLevel;
+				sub2.bAuraRefineInfoExpPercent = info.bAuraRefineInfoExpPercent;
+
+				TEMP_BUFFER buf;
+				buf.write(&pack, sizeof(TPacketGCAura));
+				buf.write(&sub, sizeof(TSubPacketGCAuraRefineInfo));
+				buf.write(&sub2, sizeof(TSubPacketGCAuraRefineInfo));
+				desc->Packet(buf.read_peek(), buf.size());
+			}
+		}
+		break;
+	}
+}
+
+void CHARACTER::AuraRefineWindowCheckOut(BYTE bAuraRefineWindowType, TItemPos AuraCell)
+{
+	if (AuraCell.window_type != AURA_REFINE || AuraCell.cell >= AURA_SLOT_RESULT)
+		return;
+
+	LPDESC desc = GetDesc();
+	if (!desc)
+	{
+		sys_err("User(%s)'s DESC is NULL POINT.", GetName());
+		return;
+	}
+
+	if (!IsAuraRefineWindowOpen())
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> ƿ â    ¿ ۾    ϴ."));
+		return;
+	}
+
+	if (!IsAuraRefineWindowCanRefine())
+	{
+		if (IsAuraRefineWindowOpen() && NULL != GetAuraRefineWindowOpener())
+		{
+#if _WIN32
+			__asm {
+				nop;
+			}
+#endif
+		}
+		else
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> μ Ϸ  â ʽÿ."));
+			return;
+		}
+	}
+
+	if (m_bAuraRefineWindowType != bAuraRefineWindowType)
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> ٸ ƿ â ִ ȿ ۾    ϴ."));
+		return;
+	}
+
+	if (m_pAuraRefineWindowItemSlot[AuraCell.cell] == NPOS)
+		return;
+
+	if (AuraCell.cell == AURA_SLOT_MAIN && m_pAuraRefineWindowItemSlot[AURA_SLOT_SUB] != NPOS)
+	{
+		LPITEM pItem = GetItem(m_pAuraRefineWindowItemSlot[AuraCell.cell]), pMaterial = GetItem(m_pAuraRefineWindowItemSlot[AURA_SLOT_SUB]);
+		if (!pItem || !pMaterial)
+			return;
+
+		pItem->Lock(false);
+		pMaterial->Lock(false);
+		m_pAuraRefineWindowItemSlot[AuraCell.cell] = NPOS;
+		m_pAuraRefineWindowItemSlot[AURA_SLOT_SUB] = NPOS;
+
+		TPacketGCAura pack;
+		pack.wSize = sizeof(TPacketGCAura);
+		pack.bSubHeader = AURA_SUBHEADER_GC_CLEAR_ALL;
+		desc->Packet(&pack, sizeof(TPacketGCAura));
+	}
+	else
+	{
+		LPITEM pItem = GetItem(m_pAuraRefineWindowItemSlot[AuraCell.cell]);
+		if (!pItem)
+			return;
+
+		pItem->Lock(false);
+		m_pAuraRefineWindowItemSlot[AuraCell.cell] = NPOS;
+
+		TPacketGCAura pack;
+		TSubPacketGCAuraClearSlot sub;
+		pack.wSize = sizeof(TPacketGCAura) + sizeof(TSubPacketGCAuraClearSlot);
+		pack.bSubHeader = AURA_SUBHEADER_GC_CLEAR_SLOT;
+
+		sub.bAuraSlotPos = AuraCell.cell;
+
+		TEMP_BUFFER buf;
+		buf.write(&pack, sizeof(TPacketGCAura));
+		buf.write(&sub, sizeof(TSubPacketGCAuraClearSlot));
+		desc->Packet(buf.read_peek(), buf.size());
+	}
+}
+
+void CHARACTER::AuraRefineWindowAccept(BYTE bAuraRefineWindowType)
+{
+	LPDESC desc = GetDesc();
+	if (!desc)
+	{
+		sys_err("User(%s)'s DESC is NULL POINT.", GetName());
+		return;
+	}
+
+	if (!IsAuraRefineWindowOpen())
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> ƿ â    ¿ ۾    ϴ."));
+		return;
+	}
+
+	if (!IsAuraRefineWindowCanRefine())
+	{
+		if (IsAuraRefineWindowOpen() && NULL != GetAuraRefineWindowOpener())
+		{
+#if _WIN32
+			__asm {
+				nop;
+			}
+#endif
+		}
+		else
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> μ Ϸ  â ʽÿ."));
+			return;
+		}
+	}
+
+	if (m_bAuraRefineWindowType != bAuraRefineWindowType)
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> ٸ ƿ â ִ ȿ ۾    ϴ."));
+		return;
+	}
+
+	if (m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN] == NPOS || m_pAuraRefineWindowItemSlot[AURA_SLOT_SUB] == NPOS)
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> â ׸ ÷Ͻʽÿ."));
+		return;
+	}
+
+	LPITEM auraItem = GetItem(m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN]);
+	if (!auraItem || !m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN].IsValidItemPosition())
+		return;
+
+	LPITEM mtrlItem = GetItem(m_pAuraRefineWindowItemSlot[AURA_SLOT_SUB]);
+	if (!mtrlItem || !m_pAuraRefineWindowItemSlot[AURA_SLOT_SUB].IsValidItemPosition())
+		return;
+
+	if (auraItem->IsExchanging() || mtrlItem->IsExchanging())
+		return;
+
+	if (auraItem->IsEquipped() || mtrlItem->IsEquipped())
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>      ϴ."));
+		return;
+	}
+
+#ifdef __SOUL_BIND_SYSTEM__
+	if (auraItem->IsSealed() || mtrlItem->IsSealed())
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> ȥ     ϴ."));
+		return;
+	}
+#endif
+	switch (bAuraRefineWindowType)
+	{
+		case AURA_WINDOW_TYPE_ABSORB:
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  ϷǾϴ."));
+
+			auraItem->Lock(false);
+			auraItem->SetSocket(ITEM_SOCKET_AURA_DRAIN_ITEM_VNUM, mtrlItem->GetOriginalVnum());
+			mtrlItem->CopyAttributeTo(auraItem);
+			auraItem->UpdatePacket();
+
+			sys_log(1, "%s[%d] - Aura Absorption Success [%d][%d]", GetName(), GetPlayerID(), auraItem->GetID(), mtrlItem->GetID());
+			LogManager::instance().ItemLog(this, auraItem, "AURA ABSORPTION SUCCESS", auraItem->GetName());
+			ITEM_MANAGER::instance().RemoveItem(mtrlItem, "AURA MATERIAL ITEM REMOVE (ABSORPTION SUCCESS)");
+
+			m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN] = NPOS;
+			m_pAuraRefineWindowItemSlot[AURA_SLOT_SUB] = NPOS;
+
+			TPacketGCAura pack;
+			pack.wSize = sizeof(TPacketGCAura);
+			pack.bSubHeader = AURA_SUBHEADER_GC_CLEAR_ALL;
+			desc->Packet(&pack, sizeof(TPacketGCAura));
+		}
+		break;
+
+		case AURA_WINDOW_TYPE_GROWTH:
+		{
+			const long c_lLevelSocket = auraItem->GetSocket(ITEM_SOCKET_AURA_CURRENT_LEVEL);
+			BYTE bNextLevel = (c_lLevelSocket / 100000) - 1000;
+			int* aiAuraRefineTable = GetAuraRefineInfo(bNextLevel);
+			WORD wCurExp = c_lLevelSocket % 100000;
+			if (bNextLevel == aiAuraRefineTable[AURA_REFINE_INFO_LEVEL_MAX] && wCurExp == aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP])
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  ƿ ǻ ׷̵   ϴ."));
+				if (aiAuraRefineTable[AURA_REFINE_INFO_STEP] == AURA_GRADE_RADIANT)
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  ƿ ǻ ִ  ޿ ߽ϴ."));
+				else
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> ߰ ܰ üȭ â Ͻʽÿ."));
+				return;
+			}
+			int iAdditionalExp = mtrlItem->GetCount() * mtrlItem->GetValue(ITEM_AURA_MATERIAL_EXP_VALUE);
+			WORD wUsedItemCount = 0;
+			while (true)
+			{
+				wUsedItemCount += 1;
+				int iNeedExp = aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP] - wCurExp;
+
+				if (wCurExp + iAdditionalExp < aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP])
+				{
+					wCurExp += iAdditionalExp;
+					iAdditionalExp = 0;
+					wUsedItemCount = mtrlItem->GetCount();
+					break;
+				}
+
+				if (bNextLevel >= aiAuraRefineTable[AURA_REFINE_INFO_LEVEL_MAX])
+				{
+					if (wCurExp + mtrlItem->GetValue(ITEM_AURA_MATERIAL_EXP_VALUE) >= aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP])
+					{
+						wCurExp += iNeedExp;
+						iAdditionalExp -= iNeedExp;
+						break;
+					}
+				}
+
+				if (wCurExp + mtrlItem->GetValue(ITEM_AURA_MATERIAL_EXP_VALUE) >= aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP])
+				{
+					wCurExp = 0;
+					iAdditionalExp -= iNeedExp;
+					bNextLevel += 1;
+					continue;
+				}
+
+				wCurExp += mtrlItem->GetValue(ITEM_AURA_MATERIAL_EXP_VALUE);
+				iAdditionalExp -= mtrlItem->GetValue(ITEM_AURA_MATERIAL_EXP_VALUE);
+			}
+
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> ׷̵尡 ϷǾϴ."));
+
+			auraItem->Lock(false);
+			auraItem->SetSocket(ITEM_SOCKET_AURA_CURRENT_LEVEL, (1000 + bNextLevel) * 100000 + wCurExp);
+			auraItem->UpdatePacket();
+
+			sys_log(1, "%s[%d] - Aura Upgrade Success [%d][%d]", GetName(), GetPlayerID(), auraItem->GetID(), mtrlItem->GetID());
+
+			TPacketGCAura pack;
+			m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN] = NPOS;
+			m_pAuraRefineWindowItemSlot[AURA_SLOT_SUB] = NPOS;
+
+			pack.wSize = sizeof(TPacketGCAura);
+			pack.bSubHeader = AURA_SUBHEADER_GC_CLEAR_ALL;
+			desc->Packet(&pack, sizeof(TPacketGCAura));
+
+			LogManager::instance().ItemLog(this, auraItem, "AURA UPGRADE SUCCESS", auraItem->GetName());
+			if (IS_SET(mtrlItem->GetFlag(), ITEM_FLAG_STACKABLE) && !IS_SET(mtrlItem->GetAntiFlag(), ITEM_ANTIFLAG_STACK) && mtrlItem->GetCount() > wUsedItemCount)
+			{
+
+				char szHint[64];
+				snprintf(szHint, sizeof(szHint), "%s %u ", mtrlItem->GetName(), wUsedItemCount);
+				LogManager::instance().ItemLog(this, mtrlItem, "AURA MATERIAL ITEM REMOVE (UPGRADE SUCCESS)", szHint);
+
+				mtrlItem->Lock(false);
+				mtrlItem->SetCount(mtrlItem->GetCount() - wUsedItemCount);
+			}
+			else
+				ITEM_MANAGER::instance().RemoveItem(mtrlItem, "AURA MATERIAL ITEM REMOVE (UPGRADE SUCCESS)");
+		}
+		break;
+
+		case AURA_WINDOW_TYPE_EVOLVE:
+		{
+			const long c_lLevelSocket = auraItem->GetSocket(ITEM_SOCKET_AURA_CURRENT_LEVEL);
+			BYTE bNextLevel = (c_lLevelSocket / 100000) - 1000;
+			int* aiAuraRefineTable = GetAuraRefineInfo(bNextLevel);
+			WORD wCurExp = c_lLevelSocket % 100000;
+			if (bNextLevel < aiAuraRefineTable[AURA_REFINE_INFO_LEVEL_MAX] || wCurExp != aiAuraRefineTable[AURA_REFINE_INFO_NEED_EXP] || aiAuraRefineTable[AURA_REFINE_INFO_STEP] == AURA_GRADE_RADIANT)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  ƿ ǻ ٵ  ϴ."));
+				if (aiAuraRefineTable[AURA_REFINE_INFO_STEP] == AURA_GRADE_RADIANT)
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  ƿ ǻ ִ  ޿ ߽ϴ."));
+				else
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> ߰ ܰ ׷̵ â Ͻʽÿ."));
+				return;
+			}
+
+			long long llNeedGold = static_cast<long long>(aiAuraRefineTable[AURA_REFINE_INFO_NEED_GOLD]);
+			if (GetGold() < llNeedGold)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  ǻ ٵŭ  մϴ."));
+				return;
+			}
+
+			if (CountSpecifyItem(aiAuraRefineTable[AURA_REFINE_INFO_MATERIAL_VNUM]) < aiAuraRefineTable[AURA_REFINE_INFO_MATERIAL_COUNT])
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> ƿ ǻ ٵ  ʿ ᰡ ϴ."));
+				return;
+			}
+
+
+			const BYTE c_bRefinePct = aiAuraRefineTable[AURA_REFINE_INFO_EVOLVE_PCT];
+			DWORD dwRefinedAuraVnum = auraItem->GetRefineSet() == 409 ? auraItem->GetRefinedVnum() : auraItem->GetOriginalVnum();
+			if (number(1, 100) <= c_bRefinePct)
+			{
+				LPITEM pkNewItem = ITEM_MANAGER::instance().CreateItem(dwRefinedAuraVnum, 1, 0, false);
+				if (pkNewItem)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> ׷̵忡 ߽ϴ."));
+
+					auraItem->Lock(false);
+					auraItem->CopySocketTo(pkNewItem);
+					auraItem->CopyAttributeTo(pkNewItem);
+
+					LogManager::instance().ItemLog(this, pkNewItem, "AURA REFINE SUCCESS", pkNewItem->GetName());
+
+					sys_log(1, "%s[%d] - Aura Refine Success [%d][%d]", GetName(), GetPlayerID(), auraItem->GetID(), mtrlItem->GetID());
+
+					ITEM_MANAGER::instance().RemoveItem(auraItem, "AURA SRC ITEM REMOVE (REFINE SUCCESS)");
+
+					pkNewItem->SetSocket(ITEM_SOCKET_AURA_CURRENT_LEVEL, (1000 + bNextLevel + 1) * 100000);
+					pkNewItem->AddToCharacter(this, m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN]);
+
+					ITEM_MANAGER::instance().FlushDelayedSave(pkNewItem);
+
+					if (IS_SET(mtrlItem->GetFlag(), ITEM_FLAG_STACKABLE) && !IS_SET(mtrlItem->GetAntiFlag(), ITEM_ANTIFLAG_STACK) && mtrlItem->GetCount() > aiAuraRefineTable[AURA_REFINE_INFO_MATERIAL_COUNT])
+					{
+						char szHint[64];
+						snprintf(szHint, sizeof(szHint), "%s %u ", mtrlItem->GetName(), aiAuraRefineTable[AURA_REFINE_INFO_MATERIAL_COUNT]);
+						LogManager::instance().ItemLog(this, mtrlItem, "AURA MATERIAL ITEM REMOVE (REFINE SUCCESS)", szHint);
+
+						mtrlItem->Lock(false);
+						mtrlItem->SetCount(mtrlItem->GetCount() - aiAuraRefineTable[AURA_REFINE_INFO_MATERIAL_COUNT]);
+					}
+					else
+						ITEM_MANAGER::instance().RemoveItem(mtrlItem, "AURA MATERIAL ITEM REMOVE (REFINE SUCCESS)");
+
+					PointChange(POINT_GOLD, -(llNeedGold), true);
+
+					m_pAuraRefineWindowItemSlot[AURA_SLOT_MAIN] = NPOS;
+					m_pAuraRefineWindowItemSlot[AURA_SLOT_SUB] = NPOS;
+
+					TPacketGCAura pack;
+					pack.wSize = sizeof(TPacketGCAura);
+					pack.bSubHeader = AURA_SUBHEADER_GC_CLEAR_ALL;
+					desc->Packet(&pack, sizeof(TPacketGCAura));
+				}
+				else
+					sys_err("aura cannot create item %lu", dwRefinedAuraVnum);
+			}
+			else
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ> ׷̵ ߽ϴ."));
+
+				sys_log(1, "%s[%d] - Aura Refine Failure [%d][%d]", GetName(), GetPlayerID(), auraItem->GetID(), mtrlItem->GetID());
+				LogManager::instance().ItemLog(this, auraItem, "AURA REFINE FAILED", auraItem->GetName());
+
+				if (IS_SET(mtrlItem->GetFlag(), ITEM_FLAG_STACKABLE) && !IS_SET(mtrlItem->GetAntiFlag(), ITEM_ANTIFLAG_STACK) && mtrlItem->GetCount() > aiAuraRefineTable[AURA_REFINE_INFO_MATERIAL_COUNT])
+				{
+					char szHint[64];
+					snprintf(szHint, sizeof(szHint), "%s %u ", mtrlItem->GetName(), aiAuraRefineTable[AURA_REFINE_INFO_MATERIAL_COUNT]);
+					LogManager::instance().ItemLog(this, mtrlItem, "AURA MATERIAL ITEM REMOVE (REFINE FAIL)", szHint);
+
+					mtrlItem->SetCount(mtrlItem->GetCount() - aiAuraRefineTable[AURA_REFINE_INFO_MATERIAL_COUNT]);
+				}
+				else
+					ITEM_MANAGER::instance().RemoveItem(mtrlItem, "AURA MATERIAL ITEM REMOVE (REFINE FAIL)");
+
+				auraItem->Lock(false);
+				m_pAuraRefineWindowItemSlot[AURA_SLOT_SUB] = NPOS;
+
+				TPacketGCAura pack;
+				TSubPacketGCAuraClearSlot sub;
+				pack.wSize = sizeof(TPacketGCAura) + sizeof(TSubPacketGCAuraClearSlot);
+				pack.bSubHeader = AURA_SUBHEADER_GC_CLEAR_SLOT;
+				sub.bAuraSlotPos = AURA_SLOT_SUB;
+
+				TEMP_BUFFER buf;
+				buf.write(&pack, sizeof(TPacketGCAura));
+				buf.write(&sub, sizeof(TSubPacketGCAuraClearSlot));
+				desc->Packet(buf.read_peek(), buf.size());
+			}
+		}
+		break;
+	}
+}
+#endif
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/char_battle.cpp final/server/server/home/metin2/Source/Server/game/src/char_battle.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/char_battle.cpp	2026-02-17 18:19:58.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/char_battle.cpp	2022-04-27 12:12:54.000000000 +0000
@@ -37,25 +37,18 @@
 #include "questmanager.h"
 #include "questlua.h"
 #include "threeway_war.h"
-#ifdef ENABLE_QUEEN_NETHIS
-#include "SnakeLair.h"
-#endif
 #include "BlueDragon.h"
 #include "DragonLair.h"
-#if defined(__MT_THUNDER_DUNGEON__)
-#	include "mt_thunder_dungeon.h"
-#endif
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-#	include "guild_dragonlair.h"
-#endif
-#if defined(__DEFENSE_WAVE__)
-#	include "defense_wave.h"
-#endif
 
-#if defined(__PET_LOOT__)
-#	include "PetSystem.h"
-#endif
+#include <random>
+#include <algorithm>
 
+#if defined(__GUILD_DRAGONLAIR__)
+#include "MeleyLair.h"
+#endif
+#if defined(__TEMPLE_OCHAO__)
+#include "TempleOchao.h"
+#endif
 #ifdef __GROWTH_PET_SYSTEM__
 #include "growth_pet.h"
 #endif
@@ -91,22 +84,12 @@
 	if (!CanMove())
 		return false;
 
-	// HARDENING: prevent initiating combat with tools that have no combat motion data (rod/pick)
-	const LPITEM pkWeapon = GetWear(WEAR_WEAPON);
-	if (pkWeapon)
-	{
-		const BYTE type = pkWeapon->GetType();
-		if (type == ITEM_ROD || type == ITEM_PICK)
-			return false;
-	}
-
 	return m_pointsInstant.position == POS_STANDING && !IsDead() && !IsStun();
 }
 
 void CHARACTER::BeginFight(LPCHARACTER pkVictim)
 {
 	SetVictim(pkVictim);
-	SetNowWalking(false);
 	SetPosition(POS_FIGHTING);
 	SetNextStatePulse(1);
 }
@@ -216,28 +199,13 @@
 		return false;
 
 	// CASTLE
-	if (IS_CASTLE_MAP(GetMapIndex()) && false == castle_can_attack(this, pkVictim))
+	if (IS_CASTLE_MAP(GetMapIndex()) && !castle_can_attack(this, pkVictim))
 		return false;
 	// CASTLE
 
-#if defined(__DEFENSE_WAVE__)
-	if (GetDefenseWave() && CDefenseWaveManager::Instance().CanAttack(this, pkVictim) == false)
-		return false;
-#endif
-
 	if (!battle_is_attackable(this, pkVictim))
 		return false;
 
-	// [Anti-Exploit] Prevent remote aggro / "Mob Puller" via packet spam.
-	// Attack() sets SyncOwner/BeginFight before distance checks; a forged packet could
-	// start combat from very far away. This hard cap is far above any legitimate range.
-	if (IsPC() && pkVictim && (pkVictim->IsMonster() || pkVictim->IsStone()))
-	{
-		const int iDist = DISTANCE_APPROX(GetX() - pkVictim->GetX(), GetY() - pkVictim->GetY());
-		if (iDist > 5000)
-			return false;
-	}
-
 	DWORD dwCurrentTime = get_dword_time();
 
 	if (IsPC())
@@ -253,6 +221,11 @@
 		MonsterChat(MONSTER_CHAT_ATTACK);
 	}
 
+#if defined(__TEMPLE_OCHAO__)
+	if ((pkVictim->IsMonster()) && (pkVictim->GetMobTable().dwVnum == TempleOchao::GUARDIAN) && (pkVictim->GetMapIndex() == TempleOchao::MAP_INDEX))
+		TempleOchao::CMgr::instance().AttackedGuardian(pkVictim);
+#endif
+
 	pkVictim->SetSyncOwner(this);
 
 	if (pkVictim->CanBeginFight())
@@ -262,42 +235,47 @@
 
 	if (bType == 0)
 	{
+#if defined(__SOUL_SYSTEM__)
+		if (IsAffectFlag(AFF_SOUL_RED) || IsAffectFlag(AFF_SOUL_MIX))
+			UseSoulAttack(RED_SOUL);
+#endif
+
 		//
 		// Ϲ 
 		//
 		switch (GetMobBattleType())
 		{
-			case BATTLE_TYPE_MELEE:
-			case BATTLE_TYPE_POWER:
-			case BATTLE_TYPE_TANKER:
-			case BATTLE_TYPE_SUPER_POWER:
-			case BATTLE_TYPE_SUPER_TANKER:
-				iRet = battle_melee_attack(this, pkVictim);
-				break;
-
-			case BATTLE_TYPE_RANGE:
-				FlyTarget(pkVictim->GetVID(), pkVictim->GetX(), pkVictim->GetY(), HEADER_CG_FLY_TARGETING);
-				iRet = Shoot(0) ? BATTLE_DAMAGE : BATTLE_NONE;
-				break;
-
-			case BATTLE_TYPE_MAGIC:
-				FlyTarget(pkVictim->GetVID(), pkVictim->GetX(), pkVictim->GetY(), HEADER_CG_FLY_TARGETING);
-				iRet = Shoot(1) ? BATTLE_DAMAGE : BATTLE_NONE;
-				break;
-
-			default:
-				sys_err("Unhandled battle type %d", GetMobBattleType());
-				iRet = BATTLE_NONE;
-				break;
-		}
+		case BATTLE_TYPE_MELEE:
+		case BATTLE_TYPE_POWER:
+		case BATTLE_TYPE_TANKER:
+		case BATTLE_TYPE_SUPER_POWER:
+		case BATTLE_TYPE_SUPER_TANKER:
+			iRet = battle_melee_attack(this, pkVictim);
+			break;
 
-#if defined(__SOUL_SYSTEM__)
-		if (IsPC() && iRet != BATTLE_NONE)
-			SoulItemProcess(RED_SOUL);
-#endif
+		case BATTLE_TYPE_RANGE:
+			FlyTarget(pkVictim->GetVID(), pkVictim->GetX(), pkVictim->GetY(), HEADER_CG_FLY_TARGETING);
+			iRet = Shoot(0) ? BATTLE_DAMAGE : BATTLE_NONE;
+			break;
+
+		case BATTLE_TYPE_MAGIC:
+			FlyTarget(pkVictim->GetVID(), pkVictim->GetX(), pkVictim->GetY(), HEADER_CG_FLY_TARGETING);
+			iRet = Shoot(1) ? BATTLE_DAMAGE : BATTLE_NONE;
+			break;
+
+		default:
+			sys_err("Unhandled battle type %d", GetMobBattleType());
+			iRet = BATTLE_NONE;
+			break;
+		}
 	}
 	else
 	{
+#if defined(__SOUL_SYSTEM__)
+		if (IsAffectFlag(AFF_SOUL_BLUE) || IsAffectFlag(AFF_SOUL_MIX))
+			UseSoulAttack(BLUE_SOUL);
+#endif
+
 		if (IsPC() == true)
 		{
 			if (dwCurrentTime - m_dwLastSkillTime > 1500)
@@ -310,18 +288,8 @@
 
 		sys_log(1, "Attack call ComputeSkill %d %s", bType, pkVictim ? pkVictim->GetName() : "");
 		iRet = ComputeSkill(bType, pkVictim);
-
-#if defined(__SOUL_SYSTEM__)
-		if (IsPC() && iRet != BATTLE_NONE)
-			SoulItemProcess(BLUE_SOUL);
-#endif
 	}
 
-#if defined(__ATTR_6TH_7TH__)
-	if (IsPC() && iRet != BATTLE_NONE)
-		this->StartHitBuffEvent();
-#endif
-
 	//if (test_server && IsPC())
 		//sys_log(0, "%s Attack %s type %u ret %d", GetName(), pkVictim->GetName(), bType, iRet);
 
@@ -344,10 +312,12 @@
 {
 	sys_log(1, "DEATH_PERNALY_CHECK(%s) town(%d)", GetName(), bTown);
 
-#if defined(__CUBE_RENEWAL__)
-	CCubeManager::Instance().CloseCube(this);
-#else
 	Cube_close(this);
+#if defined(__ACCE_COSTUME_SYSTEM__)
+	CloseAcce();
+#endif
+#if defined(__CHANGE_LOOK_SYSTEM__)
+	ChangeLookWindow(false, true);
 #endif
 
 	if (CBattleArena::instance().IsBattleArenaMap(GetMapIndex()) == true)
@@ -358,14 +328,14 @@
 	if (GetLevel() < 10)
 	{
 		sys_log(0, "NO_DEATH_PENALTY_LESS_LV10(%s)", GetName());
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȣ ġ  ʾҽϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ȣ ġ  ʾҽϴ."));
 		return;
 	}
 
 	if (number(0, 2))
 	{
 		sys_log(0, "NO_DEATH_PENALTY_LUCK(%s)", GetName());
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȣ ġ  ʾҽϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ȣ ġ  ʾҽϴ."));
 		return;
 	}
 
@@ -379,7 +349,7 @@
 			if (FindAffect(AFFECT_NO_DEATH_PENALTY))
 			{
 				sys_log(0, "NO_DEATH_PENALTY_AFFECT(%s)", GetName());
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȣ ġ  ʾҽϴ."));
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ȣ ġ  ʾҽϴ."));
 				RemoveAffect(AFFECT_NO_DEATH_PENALTY);
 				return;
 			}
@@ -389,7 +359,7 @@
 			if (FindAffect(AFFECT_NO_DEATH_PENALTY))
 			{
 				sys_log(0, "NO_DEATH_PENALTY_AFFECT(%s)", GetName());
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȣ ġ  ʾҽϴ."));
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ȣ ġ  ʾҽϴ."));
 				RemoveAffect(AFFECT_NO_DEATH_PENALTY);
 				return;
 			}
@@ -546,41 +516,12 @@
 	if (ch->GetDesc())
 	{
 		ch->GetDesc()->SetPhase(PHASE_GAME);
-		ch->SetPosition(POS_STANDING);
-
-		long lMapIndex = ch->GetMapIndex();
 
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-		if (CGuildDragonLairManager::Instance().IsRedDragonLair(lMapIndex))
-		{
-			CGuildDragonLairManager::Instance().Exit(ch);
-			return 0;
-		}
-#endif
-
-#if defined(__ELEMENTAL_DUNGEON__)
-		if (IS_ELEMENTAL_DUNGEON(ch->GetMapIndex()))
-		{
-			PIXEL_POSITION WarpPos;
-			if (SECTREE_MANAGER::instance().GetRecallPositionByEmpire(MAP_DEFENSEWAVE_PORT, ch->GetEmpire(), WarpPos))
-				ch->WarpSet(WarpPos.x, WarpPos.y);
-			else
-			{
-				sys_err("cannot find spawn position (name %s)", ch->GetName());
-				ch->WarpSet(EMPIRE_START_X(ch->GetEmpire()), EMPIRE_START_Y(ch->GetEmpire()));
-			}
-
-			ch->PointChange(POINT_HP, (ch->GetMaxHP() / 2) - ch->GetHP(), true);
-			ch->DeathPenalty(0);
-			ch->StartRecoveryEvent();
-			ch->ChatPacket(CHAT_TYPE_COMMAND, "CloseRestartWindow");
-
-			return 0;
-		}
-#endif
+		ch->SetPosition(POS_STANDING);
 
 		PIXEL_POSITION pos;
-		if (SECTREE_MANAGER::instance().GetRecallPositionByEmpire(lMapIndex, ch->GetEmpire(), pos))
+
+		if (SECTREE_MANAGER::instance().GetRecallPositionByEmpire(ch->GetMapIndex(), ch->GetEmpire(), pos))
 			ch->WarpSet(pos.x, pos.y);
 		else
 		{
@@ -589,15 +530,18 @@
 		}
 
 		ch->PointChange(POINT_HP, (ch->GetMaxHP() / 2) - ch->GetHP(), true);
+
 		ch->DeathPenalty(0);
+
 		ch->StartRecoveryEvent();
+
 		ch->ChatPacket(CHAT_TYPE_COMMAND, "CloseRestartWindow");
 	}
 	else
 	{
-		if (ch->IsMonster())
+		if (ch->IsMonster() == true)
 		{
-			if (!ch->IsRevive() && ch->HasReviverInParty())
+			if (ch->IsRevive() == false && ch->HasReviverInParty() == true)
 			{
 				ch->SetPosition(POS_STANDING);
 				ch->SetHP(ch->GetMaxHP());
@@ -632,7 +576,8 @@
 	// ADD_PREMIUM
 	bool isAutoLoot =
 		(pkAttacker->GetPremiumRemainSeconds(PREMIUM_AUTOLOOT) > 0 ||
-			pkAttacker->IsEquipUniqueGroup(UNIQUE_GROUP_AUTO_LOOT))
+			pkAttacker->IsEquipUniqueGroup(UNIQUE_GROUP_AUTOLOOT) ||
+			pkAttacker->IsEquipUniqueItem(UNIQUE_ITEM_AUTOLOOT_GOLD))
 		? true : false; // 3 
 	// END_OF_ADD_PREMIUM
 
@@ -804,9 +749,6 @@
 				if (isAutoLoot)
 				{
 					pkAttacker->GiveGold(iGold / iSplitCount);
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-					pkAttacker->UpdateExtBattlePassMissionProgress(YANG_COLLECT, iGold / iSplitCount, pkAttacker->GetMapIndex());
-#endif
 				}
 				else if ((item = ITEM_MANAGER::instance().CreateItem(1, iGold / iSplitCount)))
 				{
@@ -870,7 +812,6 @@
 	if (pkAttacker->IsPC())
 	{
 		if (GetLevel() - pkAttacker->GetLevel() >= -10)
-		{
 			if (pkAttacker->GetRealAlignment() < 0)
 			{
 				if (pkAttacker->IsEquipUniqueItem(UNIQUE_ITEM_FASTER_ALIGNMENT_UP_BY_KILL))
@@ -880,26 +821,11 @@
 			}
 			else
 				pkAttacker->UpdateAlignment(2);
-		}
 
 		pkAttacker->SetQuestNPCID(GetVID());
 		quest::CQuestManager::instance().Kill(pkAttacker->GetPlayerID(), GetRaceNum());
 		CHARACTER_MANAGER::instance().KillLog(GetRaceNum());
 
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-		pkAttacker->UpdateExtBattlePassMissionProgress(KILL_MONSTER, 1, GetRaceNum());
-#endif
-
-#if defined(__PARTY_KILL_RENEWAL__)
-		if (pkAttacker->GetParty())
-		{
-			quest::CQuestManager::instance().PartyKill(pkAttacker->GetPlayerID(), GetRaceNum());
-
-			FPartyKill f(this, pkAttacker);
-			pkAttacker->GetParty()->ForEachNearMember(f);
-		}
-#endif
-
 		if (!number(0, 9))
 		{
 			if (pkAttacker->GetPoint(POINT_KILL_HP_RECOVERY))
@@ -951,38 +877,31 @@
 		else if (s_vec_item.size() == 1)
 		{
 			item = s_vec_item[0];
+			item->AddToGround(GetMapIndex(), pos);
 
-#if defined(__DICE_SYSTEM__)
-			FPartyDropDiceRoll f(item, pkAttacker);
-			f.Process(this);
-#endif
-
-#if defined (__PET_SYSTEM__) && defined(__PET_LOOT__)
-			if ((f.GetItemOwner() == pkAttacker) && (pkAttacker->GetPetSystem() && pkAttacker->GetPetSystem()->LootItem(item)))
-				pkAttacker->AutoGiveItem(item, true, true
-#if defined(__WJ_PICKUP_ITEM_EFFECT__)
-					, true
-#endif
-				);
-			else
-#endif
+			if (CBattleArena::instance().IsBattleArenaMap(pkAttacker->GetMapIndex()) == false)
 			{
-				item->AddToGround(GetMapIndex(), pos);
-				if (CBattleArena::instance().IsBattleArenaMap(pkAttacker->GetMapIndex()) == false)
 #if defined(__DICE_SYSTEM__)
-					item->SetOwnership(f.GetItemOwner());
-#else
+				if (pkAttacker->GetParty())
+				{
+					FPartyDropDiceRoll f(item, pkAttacker);
+					f.Process(this);
+				}
+				else
 					item->SetOwnership(pkAttacker);
+#else
+				item->SetOwnership(pkAttacker);
 #endif
-				item->StartDestroyEvent();
+			}
 
-				pos.x = number(-7, 7) * 20;
-				pos.y = number(-7, 7) * 20;
-				pos.x += GetX();
-				pos.y += GetY();
+			item->StartDestroyEvent();
 
-				sys_log(0, "DROP_ITEM: %s %d %d from %s", item->GetName(), pos.x, pos.y, GetName());
-			}
+			pos.x = number(-7, 7) * 20;
+			pos.y = number(-7, 7) * 20;
+			pos.x += GetX();
+			pos.y += GetY();
+
+			sys_log(0, "DROP_ITEM: %s %d %d from %s", item->GetName(), pos.x, pos.y, GetName());
 		}
 		else
 		{
@@ -1029,9 +948,6 @@
 					}
 
 					item->AddToGround(GetMapIndex(), pos);
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-					pkAttacker->UpdateExtBattlePassMissionProgress(BP_ITEM_COLLECT, item->GetCount(), item->GetVnum());
-#endif
 					// 10%     Ǿ
 					//item->SetOwnership(pkAttacker);
 					item->StartDestroyEvent();
@@ -1059,6 +975,8 @@
 						continue;
 					}
 
+					item->AddToGround(GetMapIndex(), pos);
+
 					LPCHARACTER ch = *it;
 
 					if (ch->GetParty())
@@ -1069,39 +987,29 @@
 					if (it == v.end())
 						it = v.begin();
 
-#if defined(__DICE_SYSTEM__)
-					FPartyDropDiceRoll f(item, ch);
-					f.Process(this);
-#endif
-
-#if defined(__PET_SYSTEM__) && defined(__PET_LOOT__)
-					if ((f.GetItemOwner() == pkAttacker) && (pkAttacker->GetPetSystem() && pkAttacker->GetPetSystem()->LootItem(item)))
-						pkAttacker->AutoGiveItem(item, true, true
-#if defined(__WJ_PICKUP_ITEM_EFFECT__)
-							, true
-#endif
-						);
-					else
-#endif
+					if (CBattleArena::instance().IsBattleArenaMap(ch->GetMapIndex()) == false)
 					{
-						item->AddToGround(GetMapIndex(), pos);
-						if (CBattleArena::instance().IsBattleArenaMap(ch->GetMapIndex()) == false)
-						{
 #if defined(__DICE_SYSTEM__)
-							item->SetOwnership(f.GetItemOwner());
-#else
+						if (ch->GetParty())
+						{
+							FPartyDropDiceRoll f(item, ch);
+							f.Process(this);
+						}
+						else
 							item->SetOwnership(ch);
+#else
+						item->SetOwnership(ch);
 #endif
-						}
-						item->StartDestroyEvent();
+					}
 
-						pos.x = number(-7, 7) * 20;
-						pos.y = number(-7, 7) * 20;
-						pos.x += GetX();
-						pos.y += GetY();
+					item->StartDestroyEvent();
 
-						sys_log(0, "DROP_ITEM: %s %d %d by %s", item->GetName(), pos.x, pos.y, GetName());
-					}
+					pos.x = number(-7, 7) * 20;
+					pos.y = number(-7, 7) * 20;
+					pos.x += GetX();
+					pos.y += GetY();
+
+					sys_log(0, "DROP_ITEM: %s %d %d by %s", item->GetName(), pos.x, pos.y, GetName());
 				}
 			}
 		}
@@ -1125,10 +1033,10 @@
 	{ 0, 0, 0, 0 }, // 
 	{ 0, 0, 0, 0 }, // 
 	{ 0, 0, 0, 0 }, // 
-	{ 20, 5, 5, 1 }, // 
-	{ 30, 10, 10, 2 }, // 
-	{ 40, 20, 35, 3 }, // 
-	{ 80, 40, 40, 4 }, // п
+	{ 25, 1, 5, 1 }, // 
+	{ 50, 2, 10, 1 }, // 
+	{ 75, 4, 15, 1 }, // 
+	{ 100, 8, 20, 1 }, // п
 };
 
 void CHARACTER::ItemDropPenalty(LPCHARACTER pkKiller)
@@ -1143,11 +1051,10 @@
 			return;
 	}
 
-	if (CArenaManager::Instance().IsArenaMap(GetMapIndex()))
-		return;
-
 	if (CBattleArena::instance().IsBattleArenaMap(GetMapIndex()) == true)
+	{
 		return;
+	}
 
 	struct TItemDropPenalty* table = &aItemDropPenalty_kor[0];
 
@@ -1155,6 +1062,7 @@
 		return;
 
 	int iAlignIndex;
+
 	if (GetRealAlignment() >= 120000)
 		iAlignIndex = 0;
 	else if (GetRealAlignment() >= 80000)
@@ -1195,15 +1103,11 @@
 
 	if (bDropInventory) // Drop Inventory
 	{
-		const bool bIsRunningQuest = IsRunningQuest();
 		std::vector<BYTE> vec_bSlots;
 
 		for (i = 0; i < INVENTORY_MAX_NUM; ++i)
-		{
-			pkItem = GetInventoryItem(i);
-			if (pkItem && !(bIsRunningQuest && pkItem->GetType() == ITEM_QUEST))
+			if (GetInventoryItem(i))
 				vec_bSlots.push_back(i);
-		}
 
 		if (!vec_bSlots.empty())
 		{
@@ -1220,11 +1124,7 @@
 			{
 				pkItem = GetInventoryItem(vec_bSlots[i]);
 
-#if defined(__MAILBOX__)
-				if (IS_SET(pkItem->GetAntiFlag(), ITEM_ANTIFLAG_GIVE | ITEM_ANTIFLAG_PKDROP | ITEM_ANTIFLAG_MYSHOP | ITEM_ANTIFLAG_MAIL))
-#else
-				if (IS_SET(pkItem->GetAntiFlag(), ITEM_ANTIFLAG_GIVE | ITEM_ANTIFLAG_PKDROP | ITEM_ANTIFLAG_MYSHOP))
-#endif
+				if (IS_SET(pkItem->GetAntiFlag(), ITEM_ANTIFLAG_GIVE | ITEM_ANTIFLAG_PKDROP))
 					continue;
 
 #if defined(__SOUL_BIND_SYSTEM__)
@@ -1232,7 +1132,7 @@
 					continue;
 #endif
 
-				SyncQuickslot(SLOT_TYPE_INVENTORY, vec_bSlots[i], WORD_MAX);
+				SyncQuickslot(QUICKSLOT_TYPE_ITEM, vec_bSlots[i], 255);
 				vec_item.push_back(std::make_pair(pkItem->RemoveFromCharacter(), INVENTORY));
 			}
 		}
@@ -1244,8 +1144,8 @@
 	{
 		std::vector<BYTE> vec_bSlots;
 
-		for (i = 0; i < EQUIPMENT_MAX_NUM; ++i)
-			if (GetEquipmentItem(i))
+		for (i = 0; i < WEAR_MAX_NUM; ++i)
+			if (GetWear(i))
 				vec_bSlots.push_back(i);
 
 		if (!vec_bSlots.empty())
@@ -1265,26 +1165,17 @@
 
 			for (i = 0; i < iQty; ++i)
 			{
-				pkItem = GetEquipmentItem(vec_bSlots[i]);
+				pkItem = GetWear(vec_bSlots[i]);
 
-#if defined(__MAILBOX__)
-				if (IS_SET(pkItem->GetAntiFlag(), ITEM_ANTIFLAG_GIVE | ITEM_ANTIFLAG_PKDROP | ITEM_ANTIFLAG_MYSHOP | ITEM_ANTIFLAG_MAIL))
-#else
-				if (IS_SET(pkItem->GetAntiFlag(), ITEM_ANTIFLAG_GIVE | ITEM_ANTIFLAG_PKDROP | ITEM_ANTIFLAG_MYSHOP))
-#endif
+				if (IS_SET(pkItem->GetAntiFlag(), ITEM_ANTIFLAG_GIVE | ITEM_ANTIFLAG_PKDROP))
 					continue;
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
-				if (pkItem->IsDragonSoul())
-					continue;
-#endif
-
 #if defined(__SOUL_BIND_SYSTEM__)
 				if (pkItem->IsSealed())
 					continue;
 #endif
 
-				SyncQuickslot(SLOT_TYPE_INVENTORY, vec_bSlots[i], WORD_MAX);
+				SyncQuickslot(QUICKSLOT_TYPE_ITEM, vec_bSlots[i], 255);
 				vec_item.push_back(std::make_pair(pkItem->RemoveFromCharacter(), EQUIPMENT));
 			}
 		}
@@ -1298,7 +1189,7 @@
 
 		if (pkItem && pkItem->GetVnum() == UNIQUE_ITEM_SKIP_ITEM_DROP_PENALTY)
 		{
-			SyncQuickslot(SLOT_TYPE_INVENTORY, WEAR_UNIQUE1, WORD_MAX);
+			SyncQuickslot(QUICKSLOT_TYPE_ITEM, WEAR_UNIQUE1, 255);
 			vec_item.push_back(std::make_pair(pkItem->RemoveFromCharacter(), EQUIPMENT));
 		}
 
@@ -1306,7 +1197,7 @@
 
 		if (pkItem && pkItem->GetVnum() == UNIQUE_ITEM_SKIP_ITEM_DROP_PENALTY)
 		{
-			SyncQuickslot(SLOT_TYPE_INVENTORY, WEAR_UNIQUE2, WORD_MAX);
+			SyncQuickslot(QUICKSLOT_TYPE_ITEM, WEAR_UNIQUE2, 255);
 			vec_item.push_back(std::make_pair(pkItem->RemoveFromCharacter(), EQUIPMENT));
 		}
 	}
@@ -1376,10 +1267,13 @@
 		return;
 
 #if !defined(__MOUNT_COSTUME_SYSTEM__)
+	UnMount(true);
+#else
 	if (IsHorseRiding())
 	{
 		StopRiding();
 	}
+#if !defined(__MOUNT_COSTUME_SYSTEM__)
 	else if (GetMountVnum())
 	{
 		RemoveAffect(AFFECT_MOUNT_BONUS);
@@ -1390,6 +1284,7 @@
 		UpdatePacket();
 	}
 #endif
+#endif
 
 	if (!pkKiller && m_dwKillerPID)
 		pkKiller = CHARACTER_MANAGER::instance().FindByPID(m_dwKillerPID);
@@ -1401,11 +1296,10 @@
 		ResetSkillCoolTimes();
 #endif
 
-	// 20200716.Owsap : Remove bad affects on death.
+	//< 2020.07.16.Owsap - Remove bad affects on death
 	if (IsPC())
 		RemoveBadAffect();
-
-	ForgetMyAttacker(false);
+	//>
 
 	bool isAgreedPVP = false;
 	bool isUnderGuildWar = false;
@@ -1440,12 +1334,10 @@
 
 	if (IsPC())
 	{
-#if defined(__QUEST_EVENT_DEAD__)
 		if (pkKiller)
 			SetQuestNPCID(pkKiller->GetVID());
 
-		quest::CQuestManager::Instance().Dead(GetPlayerID(), (pkKiller) ? pkKiller->GetRaceNum() : quest::QUEST_NO_NPC);
-#endif
+		quest::CQuestManager::instance().Die(GetPlayerID(), (pkKiller) ? pkKiller->GetRaceNum() : quest::QUEST_NO_NPC);
 
 		// CHECK_FORKEDROAD_WAR
 		if (CThreeWayWar::instance().IsThreeWayWarMapIndex(GetMapIndex()))
@@ -1503,10 +1395,6 @@
 			sys_log(1, "DEAD_BY_PC: %s %p KILLER %s %p", GetName(), this, pkKiller->GetName(), get_pointer(pkKiller));
 			REMOVE_BIT(m_pointsInstant.instant_flag, INSTANT_FLAG_DEATH_PENALTY);
 
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-			pkKiller->UpdateExtBattlePassMissionProgress(KILL_PLAYER, 1, GetLevel());
-#endif
-
 			if (GetEmpire() != pkKiller->GetEmpire())
 			{
 				int iEP = MIN(GetPoint(POINT_EMPIRE_POINT), pkKiller->GetPoint(POINT_EMPIRE_POINT));
@@ -1542,13 +1430,13 @@
 					}
 
 					if (number(1, 100) < iNoPenaltyProb)
-						pkKiller->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȣ   ʾҽϴ."));
+						pkKiller->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ȣ   ʾҽϴ."));
 					else
 					{
 						if (g_iUseLocale && pkKiller->GetParty())
 						{
 							FPartyAlignmentCompute f(-20000, pkKiller->GetX(), pkKiller->GetY());
-							pkKiller->GetParty()->ForEachOnMapMember(f, pkKiller->GetMapIndex());
+							pkKiller->GetParty()->ForEachOnlineMember(f);
 
 							if (f.m_iCount == 0)
 								pkKiller->UpdateAlignment(-20000);
@@ -1557,7 +1445,7 @@
 								sys_log(0, "ALIGNMENT PARTY count %d amount %d", f.m_iCount, f.m_iAmount);
 
 								f.m_iStep = 1;
-								pkKiller->GetParty()->ForEachOnMapMember(f, pkKiller->GetMapIndex());
+								pkKiller->GetParty()->ForEachOnlineMember(f);
 							}
 						}
 						else
@@ -1626,7 +1514,7 @@
 				if (pkKiller->m_dwUnderGuildWarInfoMessageTime < get_dword_time())
 				{
 					pkKiller->m_dwUnderGuildWarInfoMessageTime = get_dword_time() + 60000;
-					pkKiller->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> ߿ ɿ   ϴ."));
+					pkKiller->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> ߿ ɿ   ϴ."));
 				}
 			}
 		}
@@ -1647,14 +1535,6 @@
 	TPacketGCDead pack;
 	pack.header = HEADER_GC_DEAD;
 	pack.vid = m_vid;
-	pack.map_index = GetMapIndex();
-	pack.dialog_type = DEAD_DIALOG_NORMAL;
-
-#if defined(__ELEMENTAL_DUNGEON__)
-	if (IS_ELEMENTAL_DUNGEON(GetMapIndex()))
-		pack.dialog_type = DEAD_DIALOG_GIVE_UP;
-#endif
-
 	PacketAround(&pack, sizeof(pack));
 
 	REMOVE_BIT(m_pointsInstant.instant_flag, INSTANT_FLAG_STUN);
@@ -1665,7 +1545,8 @@
 		//
 		// Ŭ̾Ʈ Ʈ Ŷ ٽ .
 		//
-		auto it = m_list_pkAffect.begin();
+		itertype(m_list_pkAffect) it = m_list_pkAffect.begin();
+
 		while (it != m_list_pkAffect.end())
 			SendAffectAddPacket(GetDesc(), *it++);
 	}
@@ -1688,7 +1569,9 @@
 			ClearStone();
 
 		if (GetDungeon())
+		{
 			GetDungeon()->DeadCharacter(this);
+		}
 
 		SCharDeadEventInfo* pEventInfo = AllocEventInfo<SCharDeadEventInfo>();
 
@@ -1728,34 +1611,39 @@
 
 	if (IsCubeOpen() == true)
 	{
-#if defined(__CUBE_RENEWAL__)
-		CCubeManager::Instance().CloseCube(this);
-#else
 		Cube_close(this);
-#endif
 	}
 
-	CShopManager::instance().StopShopping(this);
-	CloseMyShop();
-	CloseSafebox();
-
 #if defined(__ACCE_COSTUME_SYSTEM__)
-	if (IsAcceRefineWindowOpen())
-		AcceRefineWindowClose(true);
+	if (IsPC())
+	{
+		CloseAcce();
+		LPITEM pkAcce = GetWear(WEAR_COSTUME_ACCE);
+		if (pkAcce && pkAcce->IsEquipped())
+			this->UpdatePacket();
+	}
 #endif
 
-#if defined(__AURA_COSTUME_SYSTEM__)
-	if (IsAuraRefineWindowOpen())
-		AuraRefineWindowClose(true);
+#if defined(__CHANGE_LOOK_SYSTEM__)
+	if (IsPC())
+		ChangeLookWindow(false, true);
 #endif
 
-#if defined(__MT_THUNDER_DUNGEON__)
-	if (IsMonster() && GetMobTable().dwVnum == CMTThunderDungeon::GUARDIAN_VNUM)
-		if ((pkKiller) && (pkKiller->GetMapIndex() == CMTThunderDungeon::MAP_INDEX))
-			CMTThunderDungeon::Instance().SpawnPortal(this);
+	CShopManager::instance().StopShopping(this);
+	CloseMyShop();
+	CloseSafebox();
+
+#if defined(__TEMPLE_OCHAO__)
+	if (IsMonster() && GetMobTable().dwVnum == TempleOchao::GUARDIAN)
+	{
+		if (pkKiller && pkKiller->GetMapIndex() == TempleOchao::MAP_INDEX)
+			TempleOchao::CMgr::instance().OnGuardianKilled(pkKiller->GetX(), pkKiller->GetY(), pkKiller->GetZ());
+		else
+			sys_err("TempleOchao: Guardian killed by nobody.");
+	}
 #endif
 
-	if (IsMonster() && BlueDragon::BossVnum == GetMobTable().dwVnum)
+	if (true == IsMonster() && 2493 == GetMobTable().dwVnum)
 	{
 		if (NULL != pkKiller && NULL != pkKiller->GetGuild())
 		{
@@ -1767,25 +1655,15 @@
 		}
 	}
 
-#ifdef ENABLE_QUEEN_NETHIS
+#if defined(__GUILD_DRAGONLAIR__)
 	if ((IsStone()) || (IsMonster()))
 	{
-		if (pkKiller && pkKiller->IsPC())
-		{
-			if (SnakeLair::CSnk::instance().IsSnakeMap(pkKiller->GetMapIndex()))
-				SnakeLair::CSnk::instance().OnKill(this, pkKiller);
-		}
-	}
-#endif
-
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-	if (pkKiller && CGuildDragonLairManager::Instance().IsRedDragonLair(pkKiller->GetMapIndex()))
-	{
-		if (IsMonster() || IsStone())
+		if (pkKiller)
 		{
-			CGuildDragonLair* pGuildDragonLair = pkKiller->GetGuildDragonLair();
-			if (pGuildDragonLair)
-				pGuildDragonLair->Kill(this);
+			if (((GetMobTable().dwVnum == (DWORD)(MeleyLair::MOBVNUM_RESPAWN_STONE_STEP2)) || (GetMobTable().dwVnum == (DWORD)(MeleyLair::MOBVNUM_RESPAWN_BOSS_STEP3))) && (MeleyLair::CMgr::instance().IsMeleyMap(pkKiller->GetMapIndex())))
+				MeleyLair::CMgr::instance().OnKill(GetMobTable().dwVnum, pkKiller->GetGuild());
+			else if (MeleyLair::CMgr::instance().IsMeleyMap(pkKiller->GetMapIndex()))
+				MeleyLair::CMgr::instance().OnKillCommon(this, pkKiller, pkKiller->GetGuild());
 		}
 	}
 #endif
@@ -1815,6 +1693,7 @@
 
 void CHARACTER::SendDamagePacket(LPCHARACTER pAttacker, int Damage, BYTE DamageFlag)
 {
+	if (IsPC() == true || (pAttacker->IsPC() == true && pAttacker->GetTarget() == this))
 	{
 		TPacketGCDamageInfo damageInfo;
 		memset(&damageInfo, 0, sizeof(TPacketGCDamageInfo));
@@ -1829,12 +1708,10 @@
 			GetDesc()->Packet(&damageInfo, sizeof(TPacketGCDamageInfo));
 		}
 
-		if (pAttacker && pAttacker->GetDesc())
+		if (pAttacker->GetDesc() != NULL)
 		{
-			if (pAttacker->GetTarget() == this)
-				pAttacker->GetDesc()->Packet(&damageInfo, sizeof(TPacketGCDamageInfo));
+			pAttacker->GetDesc()->Packet(&damageInfo, sizeof(TPacketGCDamageInfo));
 		}
-
 		/*
 		if (GetArenaObserverMode() == false && GetArena() != NULL)
 		{
@@ -1858,13 +1735,16 @@
 //
 bool CHARACTER::Damage(LPCHARACTER pAttacker, int dam, EDamageType type /*= DAMAGE_TYPE_NORMAL*/) // returns true if dead
 {
+	if (!pAttacker)
+		return false;
+
 	if (IsPC() && IsDead())
 		return false;
 
 	if (!GetSectree() || GetSectree()->IsAttr(GetX(), GetY(), ATTR_BANPK))
 		return false;
 
-	// 20190823.Owsap : Check skill affect without weapon.
+	//< 2019.08.23.owsap - Check skill affect without weapon
 	if (pAttacker && this)
 	{
 		if (pAttacker->IsAffectFlag(AFF_GWIGUM) && !pAttacker->GetWear(WEAR_WEAPON))
@@ -1879,47 +1759,37 @@
 			return false;
 		}
 	}
+	//>
 
-#if defined(__9TH_SKILL__)
-	if (pAttacker && FindAffect(AFFECT_CHEONUN_INVINCIBILITY))
-	{
-		SendDamagePacket(pAttacker, 0, DAMAGE_BLOCK);
-		return false;
-	}
-#endif
-
-#if defined(__CONQUEROR_LEVEL__)
-	if (pAttacker && pAttacker->IsNewWorldMapIndex() && pAttacker->IsPC() && !IsStone())
+#if defined(__GUILD_DRAGONLAIR__)
+	if (pAttacker)
 	{
-		if (pAttacker->IsSungMaCursed(POINT_SUNGMA_STR))
-			dam /= 2;
-
-		int iHitPct = pAttacker->GetNewWorldSungMa(POINT_HIT_PCT);
-		if (iHitPct > 0 && iHitPct > pAttacker->GetPoint(POINT_HIT_PCT))
+		if ((GetRaceNum() == (WORD)(MeleyLair::STATUE_VNUM)) && (MeleyLair::CMgr::instance().IsMeleyMap(pAttacker->GetMapIndex())) && (!MeleyLair::CMgr::instance().Damage(this, pAttacker->GetGuild())))
 		{
-			int iMissHitPct = ((iHitPct - pAttacker->GetPoint(POINT_HIT_PCT)) * 100.0) / iHitPct;
-			if (number(1, 100) <= iMissHitPct)
-			{
-				SendDamagePacket(pAttacker, 0, DAMAGE_BLOCK);
-				return false;
-			}
+			SendDamagePacket(pAttacker, 0, DAMAGE_BLOCK);
+			return false;
+		}
+		else if ((GetRaceNum() == (WORD)(MeleyLair::BOSS_VNUM)) && (MeleyLair::CMgr::instance().IsMeleyMap(pAttacker->GetMapIndex())))
+		{
+			SendDamagePacket(pAttacker, 0, DAMAGE_BLOCK);
+			return false;
 		}
 	}
 #endif
 
-#if defined(__SNOW_DUNGEON__)
-	if (pAttacker && IS_SNOW_DUNGEON(pAttacker->GetMapIndex()))
+	// HANMA_TOWER - Check Hanma (Nemere) Tower conditions.
+	UINT uiIgnoreHanmaConditions = quest::CQuestManager::instance().GetEventFlag("ignore_hanma_conditions") > 0 ? TRUE : FALSE;
+	if (pAttacker && uiIgnoreHanmaConditions == FALSE)
 	{
 		LPDUNGEON pDungeon = pAttacker->GetDungeon();
 		if (pDungeon)
 		{
-			switch (GetRaceNum())
+			long lMapIndex = pDungeon->GetMapIndex();
+			if (lMapIndex >= 352 * 10000 && lMapIndex < (352 + 1) * 10000)
 			{
-				case 8058: // Metin of Cold
-#if defined(__LABYRINTH_DUNGEON__)
-				case 8125: // TR: Metin of Cold
-				case 8135: // RX: Metin of Cold
-#endif
+				switch (GetRaceNum())
+				{
+				case 8058:
 				{
 					if (pDungeon->GetFlag("level") == 6)
 					{
@@ -1929,14 +1799,8 @@
 							return false;
 						}
 					}
-				}
-				break;
-
-				case 20399: // North Dragon Pillar
-#if defined(__LABYRINTH_DUNGEON__)
-				case 20518: // TR: North Dragon Pillar
-				case 20538: // RX: North Dragon Pillar
-#endif
+				} break;
+				case 20399:
 				{
 					if (pDungeon->GetFlag("level") == 9)
 					{
@@ -1946,14 +1810,8 @@
 							return false;
 						}
 					}
-				}
-				break;
-
-				case 6151: // Szel
-#if defined(__LABYRINTH_DUNGEON__)
-				case 4249: // TR: Szel
-				case 4329: // RX: Szel
-#endif
+				} break;
+				case 6151:
 				{
 					if (pDungeon->GetFlag("level") == 4)
 					{
@@ -1971,49 +1829,22 @@
 							return false;
 						}
 					}
+				} break;
 				}
-				break;
-
 			}
 		}
 	}
-#endif
-
-#if defined(__BLUE_DRAGON_RENEWAL__)
-	if (BlueDragon_IsBoss(GetRaceNum()))
-	{
-		if (BlueDragon_Block(pAttacker->GetMapIndex()))
-		{
-			SendDamagePacket(pAttacker, 0, DAMAGE_BLOCK);
-			return false;
-		}
-	}
-#endif
+	// END_OF_HANMA_TOWER
 
-#if defined(__DEFENSE_WAVE__)
-	if (pAttacker && GetDefenseWave())
+	if (DAMAGE_TYPE_MAGIC == type)
 	{
-		if (GetDefenseWave()->Damage(this) == false)
-		{
-			SendDamagePacket(pAttacker, 0, DAMAGE_BLOCK);
-			return false;
-		}
+		dam = (int)((float)dam * (100 + (pAttacker->GetPoint(POINT_MAGIC_ATT_BONUS_PER) + pAttacker->GetPoint(POINT_MELEE_MAGIC_ATT_BONUS_PER))) / 100.f + 0.5f);
 	}
-#endif
 
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-	if (pAttacker && CGuildDragonLairManager::Instance().IsRedDragonLair(pAttacker->GetMapIndex()))
+#if defined(__9TH_SKILL__)
+	if (pAttacker)
 	{
-		if (CGuildDragonLairManager::Instance().IsStone(GetRaceNum()))
-		{
-			CGuildDragonLair* pGuildDragonLair = pAttacker->GetGuildDragonLair();
-			if (pGuildDragonLair && pGuildDragonLair->Damage(this) == false)
-			{
-				SendDamagePacket(pAttacker, 0, DAMAGE_BLOCK);
-				return false;
-			}
-		}
-		else if (CGuildDragonLairManager::Instance().IsKing(GetRaceNum()))
+		if (IsAffectFlag(AFF_CHUNWOON_MOOJUK))
 		{
 			SendDamagePacket(pAttacker, 0, DAMAGE_BLOCK);
 			return false;
@@ -2021,20 +1852,6 @@
 	}
 #endif
 
-	if (EDamageType::DAMAGE_TYPE_MAGIC == type)
-	{
-		dam = (int)((float)dam * (100 + (pAttacker->GetPoint(POINT_MAGIC_ATT_BONUS_PER) + pAttacker->GetPoint(POINT_MELEE_MAGIC_ATT_BONUS_PER))) / 100.f + 0.5f);
-		
-		int iMtkBonus = pAttacker->GetPoint(POINT_MAGIC_ATT_GRADE_BONUS);
-		if (iMtkBonus > 0)
-		{
-			int iRawMtkBonus = dam * iMtkBonus / 100;
-			float fAdjFactor = iMtkBonus / 10.0f - 2.5f;
-			int iFinalMtkBonus = int(iRawMtkBonus / 100.0f * fAdjFactor + 0.5f);
-			dam += iFinalMtkBonus;
-		}
-	}
-
 	if (GetRaceNum() == 5001)
 	{
 		bool bDropMoney = false;
@@ -2099,7 +1916,7 @@
 	}
 
 	// Ÿ ƴ   ó
-	if (type != EDamageType::DAMAGE_TYPE_NORMAL && type != EDamageType::DAMAGE_TYPE_NORMAL_RANGE)
+	if (type != DAMAGE_TYPE_NORMAL && type != DAMAGE_TYPE_NORMAL_RANGE)
 	{
 		if (IsAffectFlag(AFF_TERROR))
 		{
@@ -2110,8 +1927,8 @@
 		}
 	}
 
-	int iCurHP = GetHP();
-	int iCurSP = GetSP();
+	int64_t iCurHP = GetHP();
+	int64_t iCurSP = GetSP();
 
 	bool IsCritical = false;
 	bool IsPenetrate = false;
@@ -2128,7 +1945,7 @@
 	//
 	// 20091109 : 簡  û   г,     70% 
 	//
-	if (type == EDamageType::DAMAGE_TYPE_MELEE || type == EDamageType::DAMAGE_TYPE_RANGE || type == EDamageType::DAMAGE_TYPE_MAGIC)
+	if (type == DAMAGE_TYPE_MELEE || type == DAMAGE_TYPE_RANGE || type == DAMAGE_TYPE_MAGIC)
 	{
 		if (pAttacker)
 		{
@@ -2151,10 +1968,7 @@
 				if (number(1, 100) <= iCriticalPct)
 				{
 					IsCritical = true;
-
-					// NOTE : According to the planner, in 2018 the critical damage multiplier in PvP
-					// was adjusted from 2 to 1.5 in order to balance the damage.
-					dam *= 1.5; // 2.0
+					dam *= 2;
 
 					EffectPacket(SE_CRITICAL);
 
@@ -2203,11 +2017,9 @@
 					IsPenetrate = true;
 
 					if (test_server)
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ߰  %d", GetPoint(POINT_DEF_GRADE) * (100 + GetPoint(POINT_DEF_BONUS)) / 100));
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ߰  %d"), GetPoint(POINT_DEF_GRADE) * (100 + GetPoint(POINT_DEF_BONUS)) / 100);
 
 					dam += GetPoint(POINT_DEF_GRADE) * (100 + GetPoint(POINT_DEF_BONUS)) / 100;
-					if (iPenetratePct > 100)
-						dam += dam * (iPenetratePct - 100) / 200;
 
 					EffectPacket(SE_PENETRATE);
 
@@ -2222,38 +2034,32 @@
 	//
 	// ޺ , Ȱ ,  Ÿ   Ӽ  Ѵ.
 	//
-	else if (type == EDamageType::DAMAGE_TYPE_NORMAL || type == EDamageType::DAMAGE_TYPE_NORMAL_RANGE)
+	else if (type == DAMAGE_TYPE_NORMAL || type == DAMAGE_TYPE_NORMAL_RANGE)
 	{
-		if (type == EDamageType::DAMAGE_TYPE_NORMAL)
+		if (type == DAMAGE_TYPE_NORMAL)
 		{
 			//  Ÿ    
 			if (GetPoint(POINT_BLOCK) && number(1, 100) <= GetPoint(POINT_BLOCK))
 			{
 				if (test_server)
 				{
-					pAttacker->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s ! (%d%%)", GetName(), GetPoint(POINT_BLOCK)));
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s ! (%d%%)", GetName(), GetPoint(POINT_BLOCK)));
+					pAttacker->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s ! (%d%%)"), GetName(), GetPoint(POINT_BLOCK));
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s ! (%d%%)"), GetName(), GetPoint(POINT_BLOCK));
 				}
 
 				SendDamagePacket(pAttacker, 0, DAMAGE_BLOCK);
 				return false;
 			}
-
-			if (GetPoint(POINT_NORMAL_DAMAGE_GUARD) && number(1, 100) <= GetPoint(POINT_NORMAL_DAMAGE_GUARD))
-			{
-				SendDamagePacket(pAttacker, 0, DAMAGE_BLOCK);
-				return false;
-			}
 		}
-		else if (type == EDamageType::DAMAGE_TYPE_NORMAL_RANGE)
+		else if (type == DAMAGE_TYPE_NORMAL_RANGE)
 		{
 			// Ÿ Ÿ    
 			if (GetPoint(POINT_DODGE) && number(1, 100) <= GetPoint(POINT_DODGE))
 			{
 				if (test_server)
 				{
-					pAttacker->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s ȸ! (%d%%)", GetName(), GetPoint(POINT_DODGE)));
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s ȸ! (%d%%)", GetName(), GetPoint(POINT_DODGE)));
+					pAttacker->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s ȸ! (%d%%)"), GetName(), GetPoint(POINT_DODGE));
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s ȸ! (%d%%)"), GetName(), GetPoint(POINT_DODGE));
 				}
 
 				SendDamagePacket(pAttacker, 0, DAMAGE_DODGE);
@@ -2275,7 +2081,7 @@
 		//
 		if (pAttacker)
 		{
-			if (type == EDamageType::DAMAGE_TYPE_NORMAL)
+			if (type == DAMAGE_TYPE_NORMAL)
 			{
 				// ݻ
 				if (GetPoint(POINT_REFLECT_MELEE))
@@ -2287,8 +2093,7 @@
 					if (pAttacker->IsImmune(IMMUNE_REFLECT))
 						reflectDamage = int(reflectDamage / 3.0f + 0.5f);
 
-					if (reflectDamage > 0)
-						pAttacker->Damage(this, reflectDamage, DAMAGE_TYPE_SPECIAL);
+					pAttacker->Damage(this, reflectDamage, DAMAGE_TYPE_SPECIAL);
 				}
 			}
 
@@ -2330,7 +2135,7 @@
 
 			if (iPenetratePct)
 			{
-				// Ÿ   .
+				//Ÿ   .
 				iPenetratePct -= GetPoint(POINT_RESIST_PENETRATE);
 
 				if (number(1, 100) <= iPenetratePct)
@@ -2338,11 +2143,9 @@
 					IsPenetrate = true;
 
 					if (test_server)
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ߰  %d", GetPoint(POINT_DEF_GRADE) * (100 + GetPoint(POINT_DEF_BONUS)) / 100));
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ߰  %d"), GetPoint(POINT_DEF_GRADE) * (100 + GetPoint(POINT_DEF_BONUS)) / 100);
 
 					dam += GetPoint(POINT_DEF_GRADE) * (100 + GetPoint(POINT_DEF_BONUS)) / 100;
-					if (iPenetratePct > 100)
-						dam += dam * (iPenetratePct - 100) / 200;
 
 					EffectPacket(SE_PENETRATE);
 				}
@@ -2355,7 +2158,7 @@
 
 				if (number(1, 10) <= pct)
 				{
-					int iHP = MIN(dam, MAX(0, iCurHP)) * pAttacker->GetPoint(POINT_STEAL_HP) / 100;
+					int64_t iHP = MIN(dam, MAX(0, iCurHP)) * pAttacker->GetPoint(POINT_STEAL_HP) / 100;
 
 					if (iHP > 0 && GetHP() >= iHP)
 					{
@@ -2373,14 +2176,14 @@
 
 				if (number(1, 10) <= pct)
 				{
-					int iCur;
+					int64_t iCur;
 
 					if (IsPC())
 						iCur = iCurSP;
 					else
 						iCur = iCurHP;
 
-					int iSP = MIN(dam, MAX(0, iCur)) * pAttacker->GetPoint(POINT_STEAL_SP) / 100;
+					int64_t iSP = MIN(dam, MAX(0, iCur)) * pAttacker->GetPoint(POINT_STEAL_SP) / 100;
 
 					if (iSP > 0 && iCur >= iSP)
 					{
@@ -2398,7 +2201,7 @@
 			{
 				if (number(1, 100) <= pAttacker->GetPoint(POINT_STEAL_GOLD))
 				{
-					long llAmount = number(1, GetLevel());
+					long long llAmount = number(1, GetLevel());
 					pAttacker->PointChange(POINT_GOLD, llAmount);
 					DBManager::instance().SendMoneyLog(MONEY_LOG_MISC, 1, llAmount);
 				}
@@ -2407,7 +2210,7 @@
 			// ĥ  HPȸ
 			if (pAttacker->GetPoint(POINT_HIT_HP_RECOVERY) && number(0, 4) > 0) // 80% Ȯ
 			{
-				int i = ((iCurHP >= 0) ? MIN(dam, iCurHP) : dam) * pAttacker->GetPoint(POINT_HIT_HP_RECOVERY) / 100;
+				int64_t i = ((iCurHP >= 0) ? MIN(dam, iCurHP) : dam) * pAttacker->GetPoint(POINT_HIT_HP_RECOVERY) / 100;
 
 				if (i)
 				{
@@ -2419,7 +2222,7 @@
 			// ĥ  SPȸ
 			if (pAttacker->GetPoint(POINT_HIT_SP_RECOVERY) && number(0, 4) > 0) // 80% Ȯ
 			{
-				int i = ((iCurHP >= 0) ? MIN(dam, iCurHP) : dam) * pAttacker->GetPoint(POINT_HIT_SP_RECOVERY) / 100;
+				int64_t i = ((iCurSP >= 0) ? MIN(dam, iCurSP) : dam) * pAttacker->GetPoint(POINT_HIT_SP_RECOVERY) / 100;
 
 				if (i)
 				{
@@ -2442,76 +2245,31 @@
 	//
 	switch (type)
 	{
-		case EDamageType::DAMAGE_TYPE_NORMAL:
-		case EDamageType::DAMAGE_TYPE_NORMAL_RANGE:
-		{
-			if (pAttacker)
-			{
-				if (pAttacker->GetPoint(POINT_NORMAL_HIT_DAMAGE_BONUS))
-					dam = dam * (100 + pAttacker->GetPoint(POINT_NORMAL_HIT_DAMAGE_BONUS)) / 100;
-
-#if defined(__SOUL_SYSTEM__) && !defined(__SOUL_SYSTEM_CALC_FINAL_DAMAGE__)
-				if (pAttacker->FindAffect(AFFECT_SOUL, AFF_SOUL_RED))
-					dam = dam * (100 + pAttacker->GetSoulDamage(RED_SOUL)) / 100;
-#endif
-			}
-
-			dam = dam * (100 - MIN(99, GetPoint(POINT_NORMAL_HIT_DEFEND_BONUS))) / 100;
-
-			{
-				DWORD dwDmgHPRecover = GetPoint(POINT_DAMAGE_HP_RECOVERY);
-				if (dwDmgHPRecover != 0)
-				{
-					int iHPRecover = (float(dwDmgHPRecover) / 100) * dam;
-					PointChange(POINT_HP, iHPRecover);
-					CreateFly(FLY_HP_SMALL, this);
-				}
+	case DAMAGE_TYPE_NORMAL:
+	case DAMAGE_TYPE_NORMAL_RANGE:
+		if (pAttacker)
+			if (pAttacker->GetPoint(POINT_NORMAL_HIT_DAMAGE_BONUS))
+				dam = dam * (100 + pAttacker->GetPoint(POINT_NORMAL_HIT_DAMAGE_BONUS)) / 100;
 
-				DWORD dwDmgSPRecover = GetPoint(POINT_DAMAGE_SP_RECOVERY);
-				if (dwDmgSPRecover != 0)
-				{
-					int iSPRecover = (float(dwDmgSPRecover) / 100) * dam;
-					PointChange(POINT_SP, iSPRecover);
-					CreateFly(FLY_SP_SMALL, this);
-				}
-			}
-		}
+		dam = dam * (100 - MIN(99, GetPoint(POINT_NORMAL_HIT_DEFEND_BONUS))) / 100;
 		break;
 
-		case EDamageType::DAMAGE_TYPE_MELEE:
-		case EDamageType::DAMAGE_TYPE_RANGE:
-		case EDamageType::DAMAGE_TYPE_FIRE:
-		case EDamageType::DAMAGE_TYPE_ICE:
-		case EDamageType::DAMAGE_TYPE_ELEC:
-		case EDamageType::DAMAGE_TYPE_MAGIC:
-		{
-			if (pAttacker)
-			{
-				if (pAttacker->GetPoint(POINT_SKILL_DAMAGE_BONUS))
-					dam = dam * (100 + pAttacker->GetPoint(POINT_SKILL_DAMAGE_BONUS)) / 100;
-
-#if defined(__SOUL_SYSTEM__) && !defined(__SOUL_SYSTEM_CALC_FINAL_DAMAGE__)
-				if (pAttacker->FindAffect(AFFECT_SOUL, AFF_SOUL_BLUE))
-					dam = dam * (100 + pAttacker->GetSoulDamage(BLUE_SOUL)) / 100;
-#endif
-
-#if defined(__ATTR_6TH_7TH__)
-				if (pAttacker->GetPoint(POINT_SKILL_DAMAGE_BONUS_BOSS_OR_MORE))
-					if (IsMonster() && GetMobRank() >= MOB_RANK_BOSS)
-						dam = dam * (100 + pAttacker->GetPoint(POINT_SKILL_DAMAGE_BONUS_BOSS_OR_MORE)) / 100;
-
-				if (GetPoint(POINT_SKILL_DEFEND_BONUS_BOSS_OR_MORE))
-					if (pAttacker->IsMonster() && pAttacker->GetMobRank() >= MOB_RANK_BOSS)
-						dam = dam * (100 - MIN(99, GetPoint(POINT_SKILL_DEFEND_BONUS_BOSS_OR_MORE))) / 100;
-#endif
-			}
+	case DAMAGE_TYPE_MELEE:
+	case DAMAGE_TYPE_RANGE:
+	case DAMAGE_TYPE_FIRE:
+	case DAMAGE_TYPE_ICE:
+	case DAMAGE_TYPE_ELEC:
+	case DAMAGE_TYPE_MAGIC:
+		//case DAMAGE_TYPE_EARTH:
+		if (pAttacker)
+			if (pAttacker->GetPoint(POINT_SKILL_DAMAGE_BONUS))
+				dam = dam * (100 + pAttacker->GetPoint(POINT_SKILL_DAMAGE_BONUS)) / 100;
 
-			dam = dam * (100 - MIN(99, GetPoint(POINT_SKILL_DEFEND_BONUS))) / 100;
-		}
+		dam = dam * (100 - MIN(99, GetPoint(POINT_SKILL_DEFEND_BONUS))) / 100;
 		break;
 
-		default:
-			break;
+	default:
+		break;
 	}
 
 	//
@@ -2624,45 +2382,6 @@
 			// 10%  
 			dam -= dam / 10;
 		}
-
-#if defined(__SOUL_SYSTEM__) && defined(__SOUL_SYSTEM_CALC_FINAL_DAMAGE__)
-		switch (type)
-		{
-			case EDamageType::DAMAGE_TYPE_NORMAL:
-			case EDamageType::DAMAGE_TYPE_NORMAL_RANGE:
-			{
-				if (pAttacker->FindAffect(AFFECT_SOUL, AFF_SOUL_RED))
-				{
-					if (!pAttacker->IsPolymorphed() && !IsPC())
-					{
-						float fDamMultiplier = static_cast<float>(100 * pAttacker->GetSoulDamage(RED_SOUL)) / 1000;
-						if (fDamMultiplier != 0)
-							dam = (int)(dam * fDamMultiplier);
-					}
-				}
-			}
-			break;
-
-			case EDamageType::DAMAGE_TYPE_MELEE:
-			case EDamageType::DAMAGE_TYPE_RANGE:
-			case EDamageType::DAMAGE_TYPE_FIRE:
-			case EDamageType::DAMAGE_TYPE_ICE:
-			case EDamageType::DAMAGE_TYPE_ELEC:
-			case EDamageType::DAMAGE_TYPE_MAGIC:
-			{
-				if (pAttacker->FindAffect(AFFECT_SOUL, AFF_SOUL_BLUE))
-				{
-					if (!pAttacker->IsPolymorphed() && !IsPC())
-					{
-						float fDamMultiplier = static_cast<float>(100 * pAttacker->GetSoulDamage(BLUE_SOUL)) / 1000;
-						if (fDamMultiplier != 0)
-							dam = (int)(dam * fDamMultiplier);
-					}
-				}
-			}
-			break;
-		}
-#endif
 	}
 	//puAttr.Pop();
 
@@ -2741,54 +2460,51 @@
 			}
 		}
 
-		// MOUNT_FALL
-		if (pAttacker->IsMonster() && pAttacker->IsFaller())
-		{
-			unsigned int iUnMountChance = 30 - GetPoint(POINT_RESIST_MOUNT_FALL);
-			if (number(1, 100) <= iUnMountChance)
-			{
-				if (!FindAffect(AFFECT_MOUNT_FALL))
-					AddAffect(AFFECT_MOUNT_FALL, POINT_NONE, 0, AFF_NONE, 5, 0, true);
-			}
-		}
-		// END_OF_MOUNT_FALL
-
 		dam = BlueDragon_Damage(this, pAttacker, dam);
-	}
-
-	BYTE damageFlag = 0;
-
-	if (type == DAMAGE_TYPE_POISON)
-		damageFlag = DAMAGE_POISON;
-	else if (type == DAMAGE_TYPE_BLEEDING)
-		damageFlag = DAMAGE_BLEEDING;
-	else
-		damageFlag = DAMAGE_NORMAL;
 
-	if (IsCritical == true)
-		damageFlag |= DAMAGE_CRITICAL;
+		BYTE damageFlag = 0;
 
-	if (IsPenetrate == true)
-		damageFlag |= DAMAGE_PENETRATE;
+		if (type == DAMAGE_TYPE_POISON)
+			damageFlag = DAMAGE_POISON;
+		else if (type == DAMAGE_TYPE_BLEEDING)
+			damageFlag = DAMAGE_BLEEDING;
+		else
+			damageFlag = DAMAGE_NORMAL;
 
-	//   
-	float damMul = this->GetDamMul();
-	float tempDam = dam;
-	dam = tempDam * damMul + 0.5f;
+		if (IsCritical == true)
+			damageFlag |= DAMAGE_CRITICAL;
 
-	//if (pAttacker)
-	SendDamagePacket(pAttacker, dam, damageFlag);
+		if (IsPenetrate == true)
+			damageFlag |= DAMAGE_PENETRATE;
 
-	if (test_server && g_bTestMobLog)
-	{
-		int iPercent = 0;
-		if (GetMaxHP() >= 0)
-			iPercent = (GetHP() * 100) / GetMaxHP();
+		//   
+		float damMul = this->GetDamMul();
+		float tempDam = dam;
+		dam = tempDam * damMul + 0.5f;
 
 		if (pAttacker)
+			SendDamagePacket(pAttacker, dam, damageFlag);
+
+		if (test_server && g_bTestMobLog)
 		{
-			pAttacker->ChatPacket(CHAT_TYPE_INFO, "-> %s, DAM %d HP %d(%d%%) %s%s",
-				GetName(),
+			int iPercent = 0;
+			if (GetMaxHP() >= 0)
+				iPercent = (GetHP() * 100) / GetMaxHP();
+
+			if (pAttacker)
+			{
+				pAttacker->ChatPacket(CHAT_TYPE_INFO, "-> %s, DAM %d HP %d(%d%%) %s%s",
+					GetName(),
+					dam,
+					GetHP(),
+					iPercent,
+					IsCritical ? "crit " : "",
+					IsPenetrate ? "pene " : "",
+					IsDeathBlow ? "deathblow " : "");
+			}
+
+			ChatPacket(CHAT_TYPE_PARTY, "<- %s, DAM %d HP %d(%d%%) %s%s",
+				pAttacker ? pAttacker->GetName() : 0,
 				dam,
 				GetHP(),
 				iPercent,
@@ -2797,61 +2513,28 @@
 				IsDeathBlow ? "deathblow " : "");
 		}
 
-		ChatPacket(CHAT_TYPE_PARTY, "<- %s, DAM %d HP %d(%d%%) %s%s",
-			pAttacker ? pAttacker->GetName() : 0,
-			dam,
-			GetHP(),
-			iPercent,
-			IsCritical ? "crit " : "",
-			IsPenetrate ? "pene " : "",
-			IsDeathBlow ? "deathblow " : "");
-	}
-
-	if (pAttacker)
-	{
 		if (m_bDetailLog)
 		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s[%d]  ġ: %d %d", pAttacker->GetName(), (DWORD)pAttacker->GetVID(), pAttacker->GetX(), pAttacker->GetY()));
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s[%d]  ġ: %d %d"), pAttacker->GetName(), (DWORD)pAttacker->GetVID(), pAttacker->GetX(), pAttacker->GetY());
 		}
 	}
 
 	//
 	// !!!!!!!!!  HP ̴ κ !!!!!!!!!
 	//
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	if (type != DAMAGE_TYPE_POISON)
-	{
-		if (IsPC())
-			pAttacker->UpdateExtBattlePassMissionProgress(DAMAGE_PLAYER, dam, GetLevel());
-		else
-			pAttacker->UpdateExtBattlePassMissionProgress(DAMAGE_MONSTER, dam, GetRaceNum());
-	}
-#endif
-
 	if (!cannot_dead)
 	{
 		dam = (GetHP() - dam <= 0) ? GetHP() : dam;
 
-#if defined(__QUEST_EVENT_DAMAGE__)
-		if (pAttacker && pAttacker->IsPC())
+		if (pAttacker)
 		{
+			pAttacker->SetDamage(dam);
 			pAttacker->SetQuestNPCID(GetVID());
-			quest::CQuestManager::instance().Damage(pAttacker->GetPlayerID(), GetRaceNum());
+			//quest::CQuestManager::instance().Damage(pAttacker->GetPlayerID(), GetRaceNum());
+			quest::CQuestManager::instance().Die(pAttacker->GetPlayerID(), (pAttacker) ? GetRaceNum() : quest::QUEST_NO_NPC);
 		}
-#endif
 
 		PointChange(POINT_HP, -dam, false);
-
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-		if (pAttacker && CGuildDragonLairManager::Instance().IsRedDragonLair(pAttacker->GetMapIndex()))
-		{
-			if (GetHP() == 0 && CGuildDragonLairManager::Instance().IsStone(GetRaceNum()))
-			{
-				PointChange(POINT_HP, 1, false);
-			}
-		}
-#endif
 	}
 
 	//puRest1.Pop();
@@ -2880,8 +2563,6 @@
 		//PROF_UNIT puRest22("Rest22");
 		UpdateAggrPointEx(pAttacker, type, dam, it->second);
 		//puRest22.Pop();
-
-		pAttacker->SetAccumulatedDamage(dam);
 	}
 	//puRest2.Pop();
 
@@ -2908,85 +2589,150 @@
 		return;
 }
 
-#if defined(__CONQUEROR_LEVEL__)
-static void GiveExp(LPCHARACTER from, LPCHARACTER to, int iExp, int iConquerorExp)
-#else
 static void GiveExp(LPCHARACTER from, LPCHARACTER to, int iExp)
-#endif
 {
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	to->UpdateExtBattlePassMissionProgress(EXP_COLLECT, iExp, from->GetRaceNum());
-#endif
-	{
-		LPITEM pkItem;
-
-		pkItem = to->GetWear(WEAR_UNIQUE1);
-
-		if (pkItem && pkItem->GetVnum() == UNIQUE_ITEM_ANTI_EXP)
-		{
-			if (test_server)
-				to->ChatPacket(CHAT_TYPE_INFO, "exp blocked by ring %d", UNIQUE_ITEM_ANTI_EXP);
-			return;
-		}
-
-		pkItem = to->GetWear(WEAR_UNIQUE2);
-		if (pkItem && pkItem->GetVnum() == UNIQUE_ITEM_ANTI_EXP)
-		{
-			if (test_server)
-				to->ChatPacket(CHAT_TYPE_INFO, "exp blocked by ring %d", UNIQUE_ITEM_ANTI_EXP);
-			return;
-		}
-	}
-
 	//  ġ 
 	iExp = CALCULATE_VALUE_LVDELTA(to->GetLevel(), from->GetLevel(), iExp);
-	const int iBaseExp = iExp;
 
-#if defined(__CONQUEROR_LEVEL__)
-	iConquerorExp = CALCULATE_VALUE_LVDELTA(to->GetLevel(), from->GetLevel(), iConquerorExp);
-	const int iBaseConquerorExp = iConquerorExp;
-#endif
+	// ܺ ׽Ʈ  ġ 3 ʽ
+	if (distribution_test_server)
+		iExp *= 3;
 
-	int iRate = 100;
+	int iBaseExp = iExp;
 
 	// , ȸ ġ ̺Ʈ 
-	iRate += CPrivManager::instance().GetPriv(to, PRIV_EXP_PCT);
+	iExp = iExp * (100 + CPrivManager::instance().GetPriv(to, PRIV_EXP_PCT)) / 100;
 
 	// ӳ ⺻ Ǵ ġ ʽ
 	{
 		// 뵿 ޴
 		if (to->IsEquipUniqueItem(UNIQUE_ITEM_LARBOR_MEDAL))
-			iRate += 20;
+			iExp += iExp * 20 / 100;
 
 		// Devil tower experience bonus
 		if (to->GetMapIndex() >= 660000 && to->GetMapIndex() < 670000)
-			iRate += 20; // 1.2 (20%)
+			iExp += iExp * 20 / 100; // 1.2 (20%)
 
 		//  ġ ι Ӽ
 		if (to->GetPoint(POINT_EXP_DOUBLE_BONUS))
 			if (number(1, 100) <= to->GetPoint(POINT_EXP_DOUBLE_BONUS))
-				iRate += 30; // 1.3 (30%)
+				iExp += iExp * 30 / 100; // 1.3 (30%)
 
 		//   (2ð¥)
-		// NOTE: Experience rings now work like special rings.
-		/*
-		if (to->IsEquipUniqueGroup(UNIQUE_GROUP_RING_OF_EXP))
+		if (to->IsEquipUniqueItem(UNIQUE_ITEM_DOUBLE_EXP))
 		{
-			iRate += 50; // (50%)
+			iExp += iExp * 50 / 100; // (50%)
 			if (test_server)
 				to->ChatPacket(CHAT_TYPE_INFO, "exp bonus + 50% (using ring)");
 		}
-		*/
 
-		//   Ǹ ġ ʽ
-		if (to->GetPremiumRemainSeconds(PREMIUM_EXP) > 0) //  : ġ 
-			iRate += 50;
-
-		iRate += to->GetMarriageBonus(UNIQUE_ITEM_MARRIAGE_EXP_BONUS); // ȥ ʽ
-		iRate += to->GetPoint(POINT_RAMADAN_CANDY_BONUS_EXP);
-		iRate += to->GetPoint(POINT_MALL_EXPBONUS);
+		switch (to->GetMountVnum())
+		{
+		case 20110:
+		case 20111:
+		case 20112:
+		case 20113:
+			if (to->IsEquipUniqueItem(71115) || to->IsEquipUniqueItem(71117) || to->IsEquipUniqueItem(71119) ||
+				to->IsEquipUniqueItem(71121))
+			{
+				iExp += iExp * 10 / 100;
+			}
+			break;
+
+		case 20114:
+		case 20120:
+		case 20121:
+		case 20122:
+		case 20123:
+		case 20124:
+		case 20125:
+			//  ġ ʽ
+			iExp += iExp * 30 / 100;
+			break;
+		}
+	}
+
+	//   Ǹ ġ ʽ
+	if (LC_IsHongKong() || LC_IsEurope() || LC_IsCanada())
+	{
+		//  : ġ 
+		if (to->GetPremiumRemainSeconds(PREMIUM_EXP) > 0)
+		{
+			iExp += (iExp * 50 / 100);
+		}
+
+		if (to->IsEquipUniqueGroup(UNIQUE_GROUP_RING_OF_EXP) == true)
+		{
+			iExp += (iExp * 50 / 100);
+		}
+
+		// PC  ġ ʽ
+		if (to->GetPoint(POINT_PC_BANG_EXP_BONUS) > 0)
+		{
+			if (to->IsPCBang() == true)
+				iExp += (iExp * to->GetPoint(POINT_PC_BANG_EXP_BONUS) / 100);
+		}
+
+		// ȥ ʽ
+		iExp += iExp * to->GetMarriageBonus(UNIQUE_ITEM_MARRIAGE_EXP_BONUS) / 100;
+	}
+	else if (/* LC_IsNewCIBN() || */LC_IsBrazil())
+	{
+		//  : ġ 
+		if (to->GetPremiumRemainSeconds(PREMIUM_EXP) > 0)
+		{
+			iExp += iExp;
+		}
+
+		if (to->IsEquipUniqueGroup(UNIQUE_GROUP_RING_OF_EXP) == true)
+		{
+			iExp += iExp;
+		}
+
+		// PC  ġ ʽ
+		if (to->GetPoint(POINT_PC_BANG_EXP_BONUS) > 0)
+		{
+			if (to->IsPCBang() == true)
+				iExp += (iExp * to->GetPoint(POINT_PC_BANG_EXP_BONUS) / 100);
+		}
+
+		// ȥ ʽ
+		iExp += iExp * to->GetMarriageBonus(UNIQUE_ITEM_MARRIAGE_EXP_BONUS) / 100;
 	}
+	else
+	{
+		//  : ġ 
+		if (to->GetPremiumRemainSeconds(PREMIUM_EXP) > 0)
+		{
+			iExp += (iExp * 20 / 100);
+		}
 
+		if (to->IsEquipUniqueGroup(UNIQUE_GROUP_RING_OF_EXP) == true)
+		{
+			iExp += (iExp * 20 / 100);
+		}
+
+		// PC  ġ ʽ
+		if (to->GetPoint(POINT_PC_BANG_EXP_BONUS) > 0)
+		{
+			if (to->IsPCBang() == true)
+				iExp += (iExp * to->GetPoint(POINT_PC_BANG_EXP_BONUS) / 100);
+		}
+
+		// ȥ ʽ
+		iExp += iExp * to->GetMarriageBonus(UNIQUE_ITEM_MARRIAGE_EXP_BONUS) / 100;
+	}
+
+	iExp += (iExp * to->GetPoint(POINT_RAMADAN_CANDY_BONUS_EXP) / 100);
+	iExp += (iExp * to->GetPoint(POINT_MALL_EXPBONUS) / 100);
+	iExp += (iExp * to->GetPoint(POINT_EXP) / 100);
+
+	/*
+	if (speed_server)
+	{
+		iExp += iExp * CSpeedServerManager::ExpBonus();
+	}
+	*/
 	if (test_server)
 	{
 		sys_log(0, "Bonus Exp : Ramadan Candy: %d MallExp: %d PointExp: %d",
@@ -2997,31 +2743,49 @@
 	}
 
 	// ȹ  2005.04.21  85%
-	iRate *= CHARACTER_MANAGER::instance().GetMobExpRate(to) / 100;
-
-	iExp *= (iRate / 100.0);
-#if defined(__CONQUEROR_LEVEL__)
-	iConquerorExp *= (iRate / 100.0);
-#endif
+	iExp = iExp * CHARACTER_MANAGER::instance().GetMobExpRate(to) / 100;
 
 	// ġ ѹ ȹ淮 
-	//iExp = MIN(to->GetNextExp() / 10, iExp);
-
-	//iExp = AdjustExpByLevel(to, iExp);
+	iExp = MIN(to->GetNextExp() / 10, iExp);
 
-	if (iBaseExp)
+	if (test_server)
 	{
-		to->PointChange(POINT_EXP, iExp, true);
-		from->CreateFly(FLY_EXP, to);
+		if (quest::CQuestManager::instance().GetEventFlag("exp_bonus_log") && iBaseExp > 0)
+			to->ChatPacket(CHAT_TYPE_INFO, "exp bonus %d%%", (iExp - iBaseExp) * 100 / iBaseExp);
 	}
 
+	iExp = AdjustExpByLevel(to, iExp);
+
 #if defined(__CONQUEROR_LEVEL__)
-	if (iBaseConquerorExp && to->GetConquerorLevel() > 0)
+	if (to->GetConquerorLevel() > 0)
 	{
-		to->PointChange(POINT_CONQUEROR_EXP, iConquerorExp, true);
-		from->CreateFly(FLY_CONQUEROR_EXP, to);
+#if defined(__ANTI_EXP_RING__)
+		if (!to->HasFrozenEXP())
+#endif
+		{
+			if (to->IsNewWorldMap(to->GetMapIndex()))
+			{
+				to->PointChange(POINT_CONQUEROR_EXP, iExp, true);
+				from->CreateFly(FLY_CONQUEROR_EXP, to);
+			}
+			else
+			{
+				to->PointChange(POINT_EXP, iExp, true);
+				from->CreateFly(FLY_EXP, to);
+			}
+		}
 	}
+	else
 #endif
+	{
+#if defined(__ANTI_EXP_RING__)
+		if (!to->HasFrozenEXP())
+#endif
+		{
+			to->PointChange(POINT_EXP, iExp, true);
+			from->CreateFly(FLY_EXP, to);
+		}
+	}
 
 	{
 		LPCHARACTER you = to->GetMarryPartner();
@@ -3033,9 +2797,9 @@
 
 			if (to->GetPremiumRemainSeconds(PREMIUM_MARRIAGE_FAST) > 0 ||
 				you->GetPremiumRemainSeconds(PREMIUM_MARRIAGE_FAST) > 0)
-				dwUpdatePoint *= 3;
+				dwUpdatePoint = (DWORD)(dwUpdatePoint * 3);
 
-			marriage::TMarriage* pMarriage = marriage::CManager::Instance().Get(to->GetPlayerID());
+			marriage::TMarriage* pMarriage = marriage::CManager::instance().Get(to->GetPlayerID());
 
 			// DIVORCE_NULL_BUG_FIX
 			if (pMarriage && pMarriage->IsNear())
@@ -3043,6 +2807,7 @@
 			// END_OF_DIVORCE_NULL_BUG_FIX
 		}
 	}
+	
 #ifdef __GROWTH_PET_SYSTEM__
 	if (to->GetActiveGrowthPet())
 	{
@@ -3080,19 +2845,11 @@
 		LPCHARACTER c;
 		int x, y;
 		DWORD _iExp;
-#if defined(__CONQUEROR_LEVEL__)
-		DWORD _iConquerorExp;
-#endif
 		int m_iMode;
 		int m_iMemberCount;
 
-#if defined(__CONQUEROR_LEVEL__)
-		FPartyDistributor(LPCHARACTER center, int member_count, int total, DWORD iExp, DWORD iConquerorExp, int iMode)
-			: total(total), c(center), x(center->GetX()), y(center->GetY()), _iExp(iExp), _iConquerorExp(iConquerorExp), m_iMode(iMode), m_iMemberCount(member_count)
-#else
 		FPartyDistributor(LPCHARACTER center, int member_count, int total, DWORD iExp, int iMode)
 			: total(total), c(center), x(center->GetX()), y(center->GetY()), _iExp(iExp), m_iMode(iMode), m_iMemberCount(member_count)
-#endif
 		{
 			if (m_iMemberCount == 0)
 				m_iMemberCount = 1;
@@ -3102,37 +2859,24 @@
 		{
 			if (DISTANCE_APPROX(ch->GetX() - x, ch->GetY() - y) <= PARTY_DEFAULT_RANGE)
 			{
-				DWORD iExp = 0;
-#if defined(__CONQUEROR_LEVEL__)
-				DWORD iConquerorExp = 0;
-#endif
+				DWORD iExp2 = 0;
 
 				switch (m_iMode)
 				{
-					case PARTY_EXP_DISTRIBUTION_NON_PARITY:
-						iExp = (DWORD)(_iExp * (float)party_exp_distribute_table[ch->GetLevel()] / total);
-#if defined(__CONQUEROR_LEVEL__)
-						iConquerorExp = (DWORD)(_iConquerorExp * (float)party_exp_distribute_table[ch->GetLevel()] / total);
-#endif
-						break;
+				case PARTY_EXP_DISTRIBUTION_NON_PARITY:
+					iExp2 = (DWORD)(_iExp * (float)party_exp_distribute_table[ch->GetLevel()] / total);
+					break;
+
+				case PARTY_EXP_DISTRIBUTION_PARITY:
+					iExp2 = _iExp / m_iMemberCount;
+					break;
 
-					case PARTY_EXP_DISTRIBUTION_PARITY:
-						iExp = _iExp / m_iMemberCount;
-#if defined(__CONQUEROR_LEVEL__)
-						iConquerorExp = _iConquerorExp / m_iMemberCount;
-#endif
-						break;
-
-					default:
-						sys_err("Unknown party exp distribution mode %d", m_iMode);
-						return;
+				default:
+					sys_err("Unknown party exp distribution mode %d", m_iMode);
+					return;
 				}
 
-#if defined(__CONQUEROR_LEVEL__)
-				GiveExp(c, ch, iExp, iConquerorExp);
-#else
-				GiveExp(c, ch, iExp);
-#endif
+				GiveExp(c, ch, iExp2);
 			}
 		}
 	};
@@ -3150,41 +2894,17 @@
 		pParty = NULL;
 	}
 
-#if defined(__CONQUEROR_LEVEL__)
-	inline void Distribute(LPCHARACTER ch, int iExp, int iConquerorExp)
-#else
 	inline void Distribute(LPCHARACTER ch, int iExp)
-#endif
 	{
 		if (pAttacker)
-		{
-#if defined(__CONQUEROR_LEVEL__)
-			GiveExp(ch, pAttacker, iExp, iConquerorExp);
-#else
 			GiveExp(ch, pAttacker, iExp);
-#endif
-		}
 		else if (pParty)
 		{
 			NPartyExpDistribute::FPartyTotaler f(ch);
-			pParty->ForEachOnMapMember(f, ch->GetMapIndex());
+			pParty->ForEachOnlineMember(f);
 
 			if (pParty->IsPositionNearLeader(ch))
-			{
-				const int iBonus = pParty->GetExpBonusPercent();
-				long long llExp = (long long)iExp * (100 + iBonus);
-				llExp /= 100;
-				if (llExp > INT_MAX) llExp = INT_MAX;
-				if (llExp < 0) llExp = 0;
-				iExp = (int)llExp;
-#if defined(__CONQUEROR_LEVEL__)
-				long long llConqExp = (long long)iConquerorExp * (100 + iBonus);
-				llConqExp /= 100;
-				if (llConqExp > INT_MAX) llConqExp = INT_MAX;
-				if (llConqExp < 0) llConqExp = 0;
-				iConquerorExp = (int)llConqExp;
-#endif
-			}
+				iExp = iExp * (100 + pParty->GetExpBonusPercent()) / 100;
 
 			if (test_server)
 			{
@@ -3202,42 +2922,22 @@
 					int iExpCenteralize = (int)(iExp * 0.05f);
 					iExp -= iExpCenteralize;
 
-#if defined(__CONQUEROR_LEVEL__)
-					int iConquerorExpCenteralize = (int)(iExp * 0.05f);
-					iConquerorExp -= iConquerorExpCenteralize;
-
-					GiveExp(ch, pParty->GetExpCentralizeCharacter(), iExpCenteralize, iConquerorExpCenteralize);
-#else
 					GiveExp(ch, pParty->GetExpCentralizeCharacter(), iExpCenteralize);
-#endif
 				}
 			}
 
-#if defined(__CONQUEROR_LEVEL__)
-			NPartyExpDistribute::FPartyDistributor fDist(ch, f.member_count, f.total, iExp, iConquerorExp, pParty->GetExpDistributionMode());
-#else
 			NPartyExpDistribute::FPartyDistributor fDist(ch, f.member_count, f.total, iExp, pParty->GetExpDistributionMode());
-#endif
-			pParty->ForEachOnMapMember(fDist, ch->GetMapIndex());
+			pParty->ForEachOnlineMember(fDist);
 		}
 	}
 } TDamageInfo;
 
 LPCHARACTER CHARACTER::DistributeExp()
 {
-#if defined(__CONQUEROR_LEVEL__)
 	int iExpToDistribute = GetExp();
-	if (iExpToDistribute <= 0)
-		iExpToDistribute = 0;
 
-	int iConquerorExpToDistribute = GetConquerorExp();
-	if (iConquerorExpToDistribute <= 0)
-		iConquerorExpToDistribute = 0;
-#else
-	int iExpToDistribute = GetExp();
 	if (iExpToDistribute <= 0)
 		return NULL;
-#endif
 
 	int iTotalDam = 0;
 	LPCHARACTER pkChrMostAttacked = NULL;
@@ -3309,9 +3009,6 @@
 	}
 
 	SetExp(0);
-#if defined(__CONQUEROR_LEVEL__)
-	SetConquerorExp(0);
-#endif
 	//m_map_kDamage.clear();
 
 	if (iTotalDam == 0) //  ذ 0̸ 
@@ -3352,11 +3049,6 @@
 		int iExp = iExpToDistribute / 5;
 		iExpToDistribute -= iExp;
 
-#if defined(__CONQUEROR_LEVEL__)
-		int	iConquerorExp = iConquerorExpToDistribute / 5;
-		iConquerorExpToDistribute -= iConquerorExp;
-#endif
-
 		float fPercent = (float)di->iDam / iTotalDam;
 
 		if (fPercent > 1.0f)
@@ -3366,17 +3058,10 @@
 		}
 
 		iExp += (int)(iExpToDistribute * fPercent);
-#if defined(__CONQUEROR_LEVEL__)
-		iConquerorExp += (int)(iConquerorExpToDistribute * fPercent);
-#endif
 
 		//sys_log(0, "%s given exp percent %.1f + 20 dam %d", GetName(), fPercent * 100.0f, di.iDam);
 
-#if defined(__CONQUEROR_LEVEL__)
-		di->Distribute(this, iExp, iConquerorExp);
-#else
 		di->Distribute(this, iExp);
-#endif
 
 		// 100%  Ծ Ѵ.
 		if (fPercent == 1.0f)
@@ -3402,11 +3087,7 @@
 			}
 
 			//sys_log(0, "%s given exp percent %.1f dam %d", GetName(), fPercent * 100.0f, di.iDam);
-#if defined(__CONQUEROR_LEVEL__)
-			di.Distribute(this, (int)(iExpToDistribute * fPercent), (int)(iConquerorExpToDistribute * fPercent));
-#else
 			di.Distribute(this, (int)(iExpToDistribute * fPercent));
-#endif
 		}
 	}
 
@@ -3417,10 +3098,14 @@
 int CHARACTER::GetArrowAndBow(LPITEM* ppkBow, LPITEM* ppkArrow, int iArrowCount/* = 1 */)
 {
 	LPITEM pkBow;
-	if (!(pkBow = GetWear(WEAR_WEAPON)) || pkBow->GetSubType() != WEAPON_BOW)
+
+	if (!(pkBow = GetWear(WEAR_WEAPON)) || pkBow->GetProto()->bSubType != WEAPON_BOW)
+	{
 		return 0;
+	}
 
 	LPITEM pkArrow;
+
 #if defined(__QUIVER_SYSTEM__)
 	if (!(pkArrow = GetWear(WEAR_ARROW)) || pkArrow->GetType() != ITEM_WEAPON || (pkArrow->GetSubType() != WEAPON_ARROW && pkArrow->GetSubType() != WEAPON_QUIVER))
 #else
@@ -3512,124 +3197,100 @@
 
 		switch (m_bType)
 		{
-			case 0: // ϹȰ
-			{
-				int iDam = 0;
+		case 0: // ϹȰ
+		{
+			int iDam = 0;
 
-				if (m_me->IsPC())
-				{
-					if (m_me->GetJob() != JOB_ASSASSIN)
-						return;
+			if (m_me->IsPC())
+			{
+				if (m_me->GetJob() != JOB_ASSASSIN)
+					return;
 
-					if (0 == m_me->GetArrowAndBow(&pkBow, &pkArrow))
-						return;
+				if (0 == m_me->GetArrowAndBow(&pkBow, &pkArrow))
+					return;
 
-					if (m_me->GetSkillGroup() != 0)
-						if (!m_me->IsNPC() && m_me->GetSkillGroup() != 2)
-						{
-							if (m_me->GetSP() < 5)
-								return;
+				if (m_me->GetSkillGroup() != 0)
+					if (!m_me->IsNPC() && m_me->GetSkillGroup() != 2)
+					{
+						if (m_me->GetSP() < 5)
+							return;
 
-							m_me->PointChange(POINT_SP, -5);
-						}
+						m_me->PointChange(POINT_SP, -5);
+					}
 
-					iDam = CalcArrowDamage(m_me, pkVictim, pkBow, pkArrow);
-					m_me->UseArrow(pkArrow, 1);
+				iDam = CalcArrowDamage(m_me, pkVictim, pkBow, pkArrow);
+				m_me->UseArrow(pkArrow, 1);
 
-					// Check speed hack
-					DWORD dwCurrentTime = get_dword_time();
-					if (IS_SPEED_HACK(m_me, pkVictim, dwCurrentTime))
-					{
-						iDam = 0;
-						return;
-					}
+				// Check speed hack
+				DWORD dwCurrentTime = get_dword_time();
+				if (IS_SPEED_HACK(m_me, pkVictim, dwCurrentTime))
+				{
+					iDam = 0;
+					return;
 				}
-				else
-					iDam = CalcMeleeDamage(m_me, pkVictim);
+			}
+			else
+				iDam = CalcMeleeDamage(m_me, pkVictim);
 
-				NormalAttackAffect(m_me, pkVictim);
+			NormalAttackAffect(m_me, pkVictim);
 
-				//  
-				iDam = iDam * (100 - pkVictim->GetPoint(POINT_RESIST_BOW)) / 100;
+			//  
+			iDam = iDam * (100 - pkVictim->GetPoint(POINT_RESIST_BOW)) / 100;
 
-				//sys_log(0, "%s arrow %s dam %d", m_me->GetName(), pkVictim->GetName(), iDam);
+			//sys_log(0, "%s arrow %s dam %d", m_me->GetName(), pkVictim->GetName(), iDam);
 
-				m_me->OnMove(true);
-				pkVictim->OnMove();
+			m_me->OnMove(true);
+			pkVictim->OnMove();
 
-				if (pkVictim->CanBeginFight())
-					pkVictim->BeginFight(m_me);
+			if (pkVictim->CanBeginFight())
+				pkVictim->BeginFight(m_me);
 
-				pkVictim->Damage(m_me, iDam, EDamageType::DAMAGE_TYPE_NORMAL_RANGE);
-				// Ÿġ  
-			}
-			break;
+			pkVictim->Damage(m_me, iDam, DAMAGE_TYPE_NORMAL_RANGE);
+			// Ÿġ  
+		}
+		break;
 
-			case 1: // Ϲ 
-			{
-				int iDam;
+		case 1: // Ϲ 
+		{
+			int iDam;
 
-				if (m_me->IsPC())
-					return;
+			if (m_me->IsPC())
+				return;
 
-				iDam = CalcMagicDamage(m_me, pkVictim);
+			iDam = CalcMagicDamage(m_me, pkVictim);
 
-				NormalAttackAffect(m_me, pkVictim);
+			NormalAttackAffect(m_me, pkVictim);
 
-				//  
+			//  
 #if defined(__MAGIC_REDUCTION__)
-				const int c_iResMagic = MINMAX(0, pkVictim->GetPoint(POINT_RESIST_MAGIC), 100);
-				const int c_iResMagicReduction = MINMAX(0, (m_me->GetJob() == JOB_SURA) ? m_me->GetPoint(POINT_RESIST_MAGIC_REDUCTION) / 2 : m_me->GetPoint(POINT_RESIST_MAGIC_REDUCTION), 50);
-				const int c_iTotalMagicRes = MINMAX(0, c_iResMagic - c_iResMagicReduction, 100);
-				iDam = iDam * (100 - c_iTotalMagicRes) / 100;
+			const int c_iResMagic = MINMAX(0, pkVictim->GetPoint(POINT_RESIST_MAGIC), 100);
+			const int c_iResMagicReduction = MINMAX(0, (m_me->GetJob() == JOB_SURA) ? m_me->GetPoint(POINT_RESIST_MAGIC_REDUCTION) / 2 : m_me->GetPoint(POINT_RESIST_MAGIC_REDUCTION), 50);
+			const int c_iTotalMagicRes = MINMAX(0, c_iResMagic - c_iResMagicReduction, 100);
+			iDam = iDam * (100 - c_iTotalMagicRes) / 100;
 #else
-				iDam = iDam * (100 - pkVictim->GetPoint(POINT_RESIST_MAGIC)) / 100;
+			iDam = iDam * (100 - pkVictim->GetPoint(POINT_RESIST_MAGIC)) / 100;
 #endif
 
-				//sys_log(0, "%s arrow %s dam %d", m_me->GetName(), pkVictim->GetName(), iDam);
+			//sys_log(0, "%s arrow %s dam %d", m_me->GetName(), pkVictim->GetName(), iDam);
 
-				m_me->OnMove(true);
-				pkVictim->OnMove();
+			m_me->OnMove(true);
+			pkVictim->OnMove();
 
-				if (pkVictim->CanBeginFight())
-					pkVictim->BeginFight(m_me);
+			if (pkVictim->CanBeginFight())
+				pkVictim->BeginFight(m_me);
 
-				pkVictim->Damage(m_me, iDam, DAMAGE_TYPE_MAGIC);
-				// Ÿġ  
-			}
-			break;
-
-			case SKILL_YEONSA: // 
-			{
-				//int iUseArrow = 2 + (m_me->GetSkillPower(SKILL_YEONSA) *6/100);
-				int iUseArrow = 1;
-
-				// Ż ϴ°
-				{
-					if (iUseArrow == m_me->GetArrowAndBow(&pkBow, &pkArrow, iUseArrow))
-					{
-						m_me->OnMove(true);
-						pkVictim->OnMove();
-
-						if (pkVictim->CanBeginFight())
-							pkVictim->BeginFight(m_me);
-
-						m_me->ComputeSkill(m_bType, pkVictim);
-						m_me->UseArrow(pkArrow, iUseArrow);
+			pkVictim->Damage(m_me, iDam, DAMAGE_TYPE_MAGIC);
+			// Ÿġ  
+		}
+		break;
 
-						if (pkVictim->IsDead())
-							break;
-					}
-					else
-						break;
-				}
-			}
-			break;
+		case SKILL_YEONSA: // 
+		{
+			//int iUseArrow = 2 + (m_me->GetSkillPower(SKILL_YEONSA) *6/100);
+			int iUseArrow = 1;
 
-			case SKILL_KWANKYEOK:
+			// Ż ϴ°
 			{
-				int iUseArrow = 1;
-
 				if (iUseArrow == m_me->GetArrowAndBow(&pkBow, &pkArrow, iUseArrow))
 				{
 					m_me->OnMove(true);
@@ -3638,90 +3299,44 @@
 					if (pkVictim->CanBeginFight())
 						pkVictim->BeginFight(m_me);
 
-					sys_log(0, "%s kwankeyok %s", m_me->GetName(), pkVictim->GetName());
 					m_me->ComputeSkill(m_bType, pkVictim);
 					m_me->UseArrow(pkArrow, iUseArrow);
-				}
-			}
-			break;
-
-			case SKILL_GIGUNG:
-#if defined(__9TH_SKILL__)
-			case SKILL_PUNGLOEPO:
-#endif
-			{
-				int iUseArrow = 1;
-				if (iUseArrow == m_me->GetArrowAndBow(&pkBow, &pkArrow, iUseArrow))
-				{
-					m_me->OnMove(true);
-					pkVictim->OnMove();
-
-					if (pkVictim->CanBeginFight())
-						pkVictim->BeginFight(m_me);
 
-#if defined(__9TH_SKILL__)
-					if (m_bType == SKILL_PUNGLOEPO)
-						sys_log(0, "%s pungloepo %s", m_me->GetName(), pkVictim->GetName());
-					else
-						sys_log(0, "%s gigung %s", m_me->GetName(), pkVictim->GetName());
-#else
-					sys_log(0, "%s gigung %s", m_me->GetName(), pkVictim->GetName());
-#endif
-
-					m_me->ComputeSkill(m_bType, pkVictim);
-					m_me->UseArrow(pkArrow, iUseArrow);
+					if (pkVictim->IsDead())
+						break;
 				}
+				else
+					break;
 			}
-			break;
-
-			case SKILL_HWAJO:
-			{
-				int iUseArrow = 1;
-				if (iUseArrow == m_me->GetArrowAndBow(&pkBow, &pkArrow, iUseArrow))
-				{
-					m_me->OnMove(true);
-					pkVictim->OnMove();
-
-					if (pkVictim->CanBeginFight())
-						pkVictim->BeginFight(m_me);
+		}
+		break;
 
-					sys_log(0, "%s hwajo %s", m_me->GetName(), pkVictim->GetName());
-					m_me->ComputeSkill(m_bType, pkVictim);
-					m_me->UseArrow(pkArrow, iUseArrow);
-				}
-			}
-			break;
+		case SKILL_KWANKYEOK:
+		{
+			int iUseArrow = 1;
 
-			case SKILL_HORSE_WILDATTACK_RANGE:
+			if (iUseArrow == m_me->GetArrowAndBow(&pkBow, &pkArrow, iUseArrow))
 			{
-				int iUseArrow = 1;
-				if (iUseArrow == m_me->GetArrowAndBow(&pkBow, &pkArrow, iUseArrow))
-				{
-					m_me->OnMove(true);
-					pkVictim->OnMove();
+				m_me->OnMove(true);
+				pkVictim->OnMove();
 
-					if (pkVictim->CanBeginFight())
-						pkVictim->BeginFight(m_me);
+				if (pkVictim->CanBeginFight())
+					pkVictim->BeginFight(m_me);
 
-					sys_log(0, "%s horse_wildattack %s", m_me->GetName(), pkVictim->GetName());
-					m_me->ComputeSkill(m_bType, pkVictim);
-					m_me->UseArrow(pkArrow, iUseArrow);
-				}
+				sys_log(0, "%s kwankeyok %s", m_me->GetName(), pkVictim->GetName());
+				m_me->ComputeSkill(m_bType, pkVictim);
+				m_me->UseArrow(pkArrow, iUseArrow);
 			}
-			break;
+		}
+		break;
 
-			case SKILL_MARYUNG:
-			case SKILL_TUSOK:
-			case SKILL_BIPABU:
+		case SKILL_GIGUNG:
 #if defined(__9TH_SKILL__)
-			case SKILL_ILGWANGPYO:
-			case SKILL_MABEOBAGGWI:
+		case SKILL_PUNGLOEPO:
 #endif
-			case SKILL_NOEJEON:
-			case SKILL_GEOMPUNG:
-			case SKILL_SANGONG:
-			case SKILL_MAHWAN:
-			case SKILL_PABEOB:
+		{
+			int iUseArrow = 1;
+			if (iUseArrow == m_me->GetArrowAndBow(&pkBow, &pkArrow, iUseArrow))
 			{
 				m_me->OnMove(true);
 				pkVictim->OnMove();
@@ -3729,12 +3344,25 @@
 				if (pkVictim->CanBeginFight())
 					pkVictim->BeginFight(m_me);
 
-				sys_log(0, "%s - Skill %d -> %s", m_me->GetName(), m_bType, pkVictim->GetName());
+#if defined(__9TH_SKILL__)
+				if (m_bType == SKILL_PUNGLOEPO)
+					sys_log(0, "%s pungloepo %s", m_me->GetName(), pkVictim->GetName());
+				else
+					sys_log(0, "%s gigung %s", m_me->GetName(), pkVictim->GetName());
+#else
+				sys_log(0, "%s gigung %s", m_me->GetName(), pkVictim->GetName());
+#endif
+
 				m_me->ComputeSkill(m_bType, pkVictim);
+				m_me->UseArrow(pkArrow, iUseArrow);
 			}
-			break;
+		}
+		break;
 
-			case SKILL_CHAIN:
+		case SKILL_HWAJO:
+		{
+			int iUseArrow = 1;
+			if (iUseArrow == m_me->GetArrowAndBow(&pkBow, &pkArrow, iUseArrow))
 			{
 				m_me->OnMove(true);
 				pkVictim->OnMove();
@@ -3742,32 +3370,89 @@
 				if (pkVictim->CanBeginFight())
 					pkVictim->BeginFight(m_me);
 
-				sys_log(0, "%s - Skill %d -> %s", m_me->GetName(), m_bType, pkVictim->GetName());
+				sys_log(0, "%s hwajo %s", m_me->GetName(), pkVictim->GetName());
 				m_me->ComputeSkill(m_bType, pkVictim);
-
-				// TODO     ϱ
+				m_me->UseArrow(pkArrow, iUseArrow);
 			}
-			break;
+		}
+		break;
 
-			/*
-			case SKILL_BUDONG:
+		case SKILL_HORSE_WILDATTACK_RANGE:
+		{
+			int iUseArrow = 1;
+			if (iUseArrow == m_me->GetArrowAndBow(&pkBow, &pkArrow, iUseArrow))
 			{
 				m_me->OnMove(true);
 				pkVictim->OnMove();
 
-				DWORD * pdw;
-				DWORD dwEI = AllocEventInfo(sizeof(DWORD) * 2, &pdw);
-				pdw[0] = m_me->GetVID();
-				pdw[1] = pkVictim->GetVID();
+				if (pkVictim->CanBeginFight())
+					pkVictim->BeginFight(m_me);
 
-				event_create(budong_event_func, dwEI, PASSES_PER_SEC(1));
+				sys_log(0, "%s horse_wildattack %s", m_me->GetName(), pkVictim->GetName());
+				m_me->ComputeSkill(m_bType, pkVictim);
+				m_me->UseArrow(pkArrow, iUseArrow);
 			}
-			break;
-			*/
+		}
+		break;
+
+		case SKILL_MARYUNG:
+		case SKILL_TUSOK:
+		case SKILL_BIPABU:
+#if defined(__9TH_SKILL__)
+		case SKILL_ILGWANGPYO:
+		case SKILL_MABEOBAGGWI:
+#endif
+		case SKILL_NOEJEON:
+		case SKILL_GEOMPUNG:
+		case SKILL_SANGONG:
+		case SKILL_MAHWAN:
+		case SKILL_PABEOB:
+		{
+			m_me->OnMove(true);
+			pkVictim->OnMove();
+
+			if (pkVictim->CanBeginFight())
+				pkVictim->BeginFight(m_me);
 
-			default:
-				sys_err("CFuncShoot: I don't know this type [%d] of range attack.", (int)m_bType);
-				break;
+			sys_log(0, "%s - Skill %d -> %s", m_me->GetName(), m_bType, pkVictim->GetName());
+			m_me->ComputeSkill(m_bType, pkVictim);
+		}
+		break;
+
+		case SKILL_CHAIN:
+		{
+			m_me->OnMove(true);
+			pkVictim->OnMove();
+
+			if (pkVictim->CanBeginFight())
+				pkVictim->BeginFight(m_me);
+
+			sys_log(0, "%s - Skill %d -> %s", m_me->GetName(), m_bType, pkVictim->GetName());
+			m_me->ComputeSkill(m_bType, pkVictim);
+
+			// TODO     ϱ
+		}
+		break;
+
+		/*
+		case SKILL_BUDONG:
+		{
+			m_me->OnMove(true);
+			pkVictim->OnMove();
+
+			DWORD * pdw;
+			DWORD dwEI = AllocEventInfo(sizeof(DWORD) * 2, &pdw);
+			pdw[0] = m_me->GetVID();
+			pdw[1] = pkVictim->GetVID();
+
+			event_create(budong_event_func, dwEI, PASSES_PER_SEC(1));
+		}
+		break;
+		*/
+
+		default:
+			sys_err("CFuncShoot: I don't know this type [%d] of range attack.", (int)m_bType);
+			break;
 		}
 
 		m_bSucceed = TRUE;
@@ -3937,23 +3622,12 @@
 {
 	bool bShow = false;
 
-#ifdef ENABLE_QUEEN_NETHIS
-	if (IsSnakeMap() && iAmount < 0)
-		return;
-#endif
-
 	if (m_iAlignment == m_iRealAlignment)
 		bShow = true;
 
 	int i = m_iAlignment / 10;
 
-	// Avoid 32-bit signed overflow/underflow on long-running servers or malformed packets.
-	long long llNewAlignment = (long long)m_iRealAlignment + (long long)iAmount;
-	if (llNewAlignment > 200000LL)
-		llNewAlignment = 200000LL;
-	else if (llNewAlignment < -200000LL)
-		llNewAlignment = -200000LL;
-	m_iRealAlignment = (int)llNewAlignment;
+	m_iRealAlignment = MINMAX(-200000, m_iRealAlignment + iAmount, 200000);
 
 	if (bShow)
 	{
@@ -3964,32 +3638,6 @@
 	}
 }
 
-UINT CHARACTER::GetAlignmentGrade() const
-{
-	const int iAlignment = GetRealAlignment();
-
-	if (iAlignment >= 12000)
-		return ALIGN_GRADE_GOOD_4;
-	else if (iAlignment >= 8000)
-		return ALIGN_GRADE_GOOD_3;
-	else if (iAlignment >= 4000)
-		return ALIGN_GRADE_GOOD_2;
-	else if (iAlignment >= 1000)
-		return ALIGN_GRADE_GOOD_1;
-	else if (iAlignment >= 0)
-		return ALIGN_GRADE_NORMAL;
-	else if (iAlignment > -4000)
-		return ALIGN_GRADE_EVIL_1;
-	else if (iAlignment > -8000)
-		return ALIGN_GRADE_EVIL_2;
-	else if (iAlignment > -12000)
-		return ALIGN_GRADE_EVIL_3;
-	else
-		return ALIGN_GRADE_EVIL_4;
-
-	return 0;
-}
-
 void CHARACTER::SetKillerMode(bool isOn)
 {
 	if ((isOn ? ADD_CHARACTER_STATE_KILLER : 0) == IS_SET(m_bAddChrState, ADD_CHARACTER_STATE_KILLER))
@@ -4029,6 +3677,13 @@
 	if (m_bPKMode == bPKMode)
 		return;
 
+	/*
+	#if defined(__GUILD_DRAGONLAIR__)
+		if ((MeleyLair::CMgr::instance().IsMeleyMap(GetMapIndex())) && (bPKMode != PK_MODE_GUILD))
+			bPKMode = PK_MODE_GUILD;
+	#endif
+	*/
+
 	if (bPKMode == PK_MODE_GUILD && !GetGuild())
 		bPKMode = PK_MODE_FREE;
 
@@ -4169,7 +3824,7 @@
 	}
 };
 
-void CHARACTER::ForgetMyAttacker(bool bRevive)
+void CHARACTER::ForgetMyAttacker()
 {
 	LPSECTREE pSec = GetSectree();
 	if (pSec)
@@ -4177,9 +3832,7 @@
 		FuncForgetMyAttacker f(this);
 		pSec->ForEachAround(f);
 	}
-
-	if (bRevive)
-		ReviveInvisible(5);
+	ReviveInvisible(5);
 }
 
 void CHARACTER::AggregateMonster()
@@ -4215,34 +3868,23 @@
 
 void CHARACTER::UpdateAggrPointEx(LPCHARACTER pAttacker, EDamageType type, int dam, CHARACTER::TBattleInfo& info)
 {
-#if defined(__DEFENSE_WAVE__)
-	if (GetDefenseWave())
-	{
-		if (CDefenseWaveManager::Instance().IsHydraSpawn(GetRaceNum()))
-			return;
-
-		if (CDefenseWaveManager::Instance().IsHydra(GetRaceNum()))
-			return;
-	}
-#endif
-
 	// Ư ŸԿ   ö󰣴
 	switch (type)
 	{
-		case EDamageType::DAMAGE_TYPE_NORMAL_RANGE:
-			dam = (int)(dam * 1.2f);
-			break;
+	case DAMAGE_TYPE_NORMAL_RANGE:
+		dam = (int)(dam * 1.2f);
+		break;
 
-		case EDamageType::DAMAGE_TYPE_RANGE:
-			dam = (int)(dam * 1.5f);
-			break;
+	case DAMAGE_TYPE_RANGE:
+		dam = (int)(dam * 1.5f);
+		break;
 
-		case EDamageType::DAMAGE_TYPE_MAGIC:
-			dam = (int)(dam * 1.2f);
-			break;
+	case DAMAGE_TYPE_MAGIC:
+		dam = (int)(dam * 1.2f);
+		break;
 
-		default:
-			break;
+	default:
+		break;
 	}
 
 	// ڰ    ʽ ش.
@@ -4279,6 +3921,7 @@
 		return;
 
 	TDamageMap::iterator it = m_map_kDamage.find(pAttacker->GetVID());
+
 	if (it == m_map_kDamage.end())
 	{
 		m_map_kDamage.insert(TDamageMap::value_type(pAttacker->GetVID(), TBattleInfo(0, dam)));
@@ -4322,7 +3965,7 @@
 		if (itFind != m_map_kDamage.end())
 		{
 			m_iMaxAggro = iNewAggro;
-			SetVictim(CHARACTER_MANAGER::Instance().Find(itFind->first));
+			SetVictim(CHARACTER_MANAGER::instance().Find(itFind->first));
 			m_dwStateDuration = 1;
 		}
 	}
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/char_item.cpp final/server/server/home/metin2/Source/Server/game/src/char_item.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/char_item.cpp	2026-02-18 17:42:50.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/char_item.cpp	2026-02-20 18:05:02.393520670 +0000
@@ -40,38 +40,23 @@
 
 #include "safebox.h"
 #include "shop.h"
-#include "pvp.h"
 
 #include "../../common/VnumHelper.h"
 #include "DragonSoul.h"
-#ifdef ENABLE_QUEEN_NETHIS
-#include "SnakeLair.h"
-#endif
 #include "buff_on_attributes.h"
 #include "belt_inventory_helper.h"
-#if defined(__LOOT_FILTER_SYSTEM__)
-#	include "LootFilter.h"
-#endif
 
-#if defined(__MT_THUNDER_DUNGEON__)
-#	include "mt_thunder_dungeon.h"
-#endif
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-#	include "guild_dragonlair.h"
+#if defined(__GUILD_DRAGONLAIR__)
+#include "MeleyLair.h"
 #endif
 
-#ifdef __OFFLINE_SHOP__
-#include "OfflineShop.h"
+#if defined(__EXPRESSING_EMOTIONS__)
+#include <random>
 #endif
 
 #ifdef __GROWTH_PET_SYSTEM__
 #include "growth_pet.h"
 #endif
-
-#include "../../libgame/include/grid.h"
-
-#include <optional>
-
 const int ITEM_BROKEN_METIN_VNUM = 28960;
 
 // CHANGE_ITEM_ATTRIBUTES
@@ -79,7 +64,7 @@
 const char CHARACTER::msc_szLastChangeItemAttrFlag[] = "Item.LastChangeItemAttr";
 const char CHARACTER::msc_szChangeItemAttrCycleFlag[] = "change_itemattr_cycle";
 // END_OF_CHANGE_ITEM_ATTRIBUTES
-const POINT_TYPE g_aBuffOnAttrPoints[] = { POINT_ENERGY, POINT_COSTUME_ATTR_BONUS };
+const BYTE g_aBuffOnAttrPoints[] = { POINT_ENERGY, POINT_COSTUME_ATTR_BONUS };
 
 struct FFindStone
 {
@@ -99,126 +84,36 @@
 	}
 };
 
-#if defined(__MT_THUNDER_DUNGEON__)
-struct FFindMobVnum
-{
-	DWORD dwMobVnum;
-	FFindMobVnum(DWORD dwMobVnum) : dwMobVnum(dwMobVnum) {}
-
-	std::map<DWORD, LPCHARACTER> m_mapVID;
-	void operator()(LPENTITY pEnt)
-	{
-		if (pEnt && pEnt->IsType(ENTITY_CHARACTER))
-		{
-			LPCHARACTER pChar = dynamic_cast<LPCHARACTER>(pEnt);
-
-			if (pChar && pChar->GetRaceNum() == dwMobVnum)
-			{
-				m_mapVID[(DWORD)pChar->GetVID()] = pChar;
-			}
-		}
-	}
-};
-#endif
-
 // ȯ, ȯ, ȥ
-bool IS_SUMMON_ITEM(LPITEM item, int map_index)
+bool IS_SUMMON_ITEM(int vnum) //< 2020.08.08.Owsap - Check function externally.
 {
-	if (item->GetVnum() == ITEM_MARRIAGE_RING)
-		return true;
-
-	switch (item->GetType())
+	switch (vnum)
 	{
-		case ITEM_QUEST:
-		{
-			if (item->GetSubType() == QUEST_WARP)
-			{
-				// NOTE : Force allow warp ring in certain maps indexes.
-				if (item->GetSpecialGroup() == UNIQUE_GROUP_WARP_RING)
-				{
-					switch (map_index)
-					{
-						case MAP_SKIPIA_DUNGEON_01:
-							return false;
-						default:
-							return true;
-					}
-				}
-				return true;
-			}
-		}
-		break;
-		case ITEM_USE:
-		{
-			if (item->GetSubType() == USE_TALISMAN)
-				return true;
-		}
-		break;
-	}
-
-	return false;
-}
-
-bool IS_MONKEY_DUNGEON(int map_index)
-{
-	switch (map_index)
-	{
-		case MAP_MONKEY_DUNGEON_11:
-		case MAP_MONKEY_DUNGEON_12:
-		case MAP_MONKEY_DUNGEON_13:
-		case MAP_MONKEY_DUNGEON:
-		case MAP_MONKEY_DUNGEON2:
-		case MAP_MONKEY_DUNGEON3:
-			return true;
+	case 22000:
+	case 22010:
+	case 22011:
+	case 22020:
+	case ITEM_MARRIAGE_RING:
+		return true;
 	}
 
 	return false;
 }
 
-bool IS_MAZE_DUNGEON(int map_index)
+static bool IS_MONKEY_DUNGEON(int map_index)
 {
 	switch (map_index)
 	{
-		case MAP_MAZE_DUNGEON1:
-		case MAP_MAZE_DUNGEON2:
-		case MAP_MAZE_DUNGEON3:
-			return true;
-	}
-
-	return false;
-}
-
-#if defined(__SNOW_DUNGEON__)
-bool IS_SNOW_DUNGEON(int map_index)
-{
-	if (map_index >= MAP_N_SNOW_DUNGEON_01 * 10000 && map_index < (MAP_N_SNOW_DUNGEON_01 + 1) * 10000)
-		return true;
-#if defined(__LABYRINTH_DUNGEON__)
-	else if (map_index >= MAP_BOSS_CRACK_SNOW * 10000 && map_index < (MAP_BOSS_CRACK_SNOW + 1) * 10000)
-		return true;
-	else if (map_index >= MAP_BOSS_AWAKEN_SNOW * 10000 && map_index < (MAP_BOSS_AWAKEN_SNOW + 1) * 10000)
+	case 5:
+	case 25:
+	case 45:
+	case 108:
+	case 109:
 		return true;
-#endif
-
-	return false;
-}
-#endif
-
-#if defined(__ELEMENTAL_DUNGEON__)
-bool IS_ELEMENTAL_DUNGEON(int map_index)
-{
-	switch (map_index)
-	{
-		case MAP_ELEMENTAL_01:
-		case MAP_ELEMENTAL_02:
-		case MAP_ELEMENTAL_03:
-		case MAP_ELEMENTAL_04:
-			return true;
 	}
 
 	return false;
 }
-#endif
 
 bool IS_SUMMONABLE_ZONE(int map_index)
 {
@@ -226,44 +121,38 @@
 	if (IS_MONKEY_DUNGEON(map_index))
 		return false;
 
-	if (IS_MAZE_DUNGEON(map_index))
-		return false;
-
 	// 
 	if (IS_CASTLE_MAP(map_index))
 		return false;
 
 	switch (map_index)
 	{
-		case MAP_DEVILTOWER1: // Ÿ
-		case MAP_SPIDERDUNGEON_02: // Ź  2
-		case MAP_SKIPIA_DUNGEON_01: // õ 
-		case MAP_SKIPIA_DUNGEON_02: // õ  2
+	case 66: // Ÿ
+	case 71: // Ź  2
+	case 72: // õ 
+	case 73: // õ  2
+	case 193: // Ź  2-1
 #if 0
-		case 193: // Ź  2-1
-		case 184: // õ (ż)
-		case 185: // õ  2(ż)
-		case 186: // õ (õ)
-		case 187: // õ  2(õ)
-		case 188: // õ ()
-		case 189: // õ  2()
-#endif
-			//case 206: // Ʊ͵
-		case MAP_DEVILSCATACOMB: // Ʊ͵
-		case MAP_SPIDERDUNGEON_03: // Ź  3
-		case MAP_SKIPIA_DUNGEON_BOSS: // õ  ()
-		case MAP_OXEVENT: // OX Event 
-		case MAP_12ZI_STAGE: // 12ZI
-		case MAP_BATTLEFIED: // Battlefield
-			return false;
-	}
+	case 184: // õ (ż)
+	case 185: // õ  2(ż)
+	case 186: // õ (õ)
+	case 187: // õ  2(õ)
+	case 188: // õ ()
+	case 189: // õ  2()
+#endif
+	// case 206: // Ʊ͵
+	case 216: // Ʊ͵
+	case 217: // Ź  3
+	case 208: // õ  ()
 
-	if (CBattleArena::IsBattleArenaMap(map_index))
+	case 113: // OX Event 
 		return false;
+	}
+
+	if (CBattleArena::IsBattleArenaMap(map_index)) return false;
 
 	//  private   Ұ
-	if (map_index > 10000)
-		return false;
+	if (map_index > 10000) return false;
 
 	return true;
 }
@@ -274,14 +163,13 @@
 
 	switch (nMapIndex)
 	{
-		case MAP_A1:
-		case MAP_A3:
-		case MAP_B1:
-		case MAP_B3:
-		case MAP_C1:
-		case MAP_C3:
-		case MAP_PRIVATESHOP:
-			return true;
+	case 1:
+	case 3:
+	case 21:
+	case 23:
+	case 41:
+	case 43:
+		return true;
 	}
 
 	return false;
@@ -290,27 +178,6 @@
 // item socket  Ÿ԰  üũ -- by mhh
 static bool FN_check_item_socket(LPITEM item)
 {
-	switch (item->GetVnum())
-	{
-		case ITEM_AUTO_HP_RECOVERY_S:
-		case ITEM_AUTO_HP_RECOVERY_M:
-		case ITEM_AUTO_HP_RECOVERY_L:
-		case ITEM_AUTO_HP_RECOVERY_X:
-		case ITEM_AUTO_SP_RECOVERY_S:
-		case ITEM_AUTO_SP_RECOVERY_M:
-		case ITEM_AUTO_SP_RECOVERY_L:
-		case ITEM_AUTO_SP_RECOVERY_X:
-		case REWARD_BOX_ITEM_AUTO_SP_RECOVERY_XS:
-		case REWARD_BOX_ITEM_AUTO_SP_RECOVERY_S:
-		case REWARD_BOX_ITEM_AUTO_HP_RECOVERY_XS:
-		case REWARD_BOX_ITEM_AUTO_HP_RECOVERY_S:
-		{
-			if (item->GetSocket(0) == 0 && item->GetSocket(1) == 0 && item->GetSocket(2) == item->GetProto()->alValues[0])
-				return true;
-		}
-		break;
-	}
-
 	for (int i = 0; i < ITEM_SOCKET_MAX_NUM; ++i)
 	{
 		if (item->GetSocket(i) != item->GetProto()->alSockets[i])
@@ -348,13 +215,6 @@
 	return true;
 }
 
-#define VERIFY_POTION(affect, afftype) \
-	if (FindAffect(affect, afftype)) \
-	{ \
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("̹ ȿ ɷ ֽϴ.")); \
-		return false; \
-	}
-
 /////////////////////////////////////////////////////////////////////////////
 // ITEM HANDLING
 /////////////////////////////////////////////////////////////////////////////
@@ -368,72 +228,29 @@
 		return false;
 
 	if (!bSkipCheckRefine)
-	{
-		if (IsUnderRefine())
-			return false;
-
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-		if (IsUnderRefineElement())
+		if (m_bUnderRefine)
 			return false;
-#endif
-	}
-
-	if (IsWarping())
-		return false;
 
-	if (IsCubeOpen())
+	if (IsCubeOpen() || NULL != DragonSoul_RefineWindow_GetOpener())
 		return false;
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
-	if (NULL != DragonSoul_RefineWindow_GetOpener())
+	if (IsWarping())
 		return false;
-#endif
 
-#if defined(__MOVE_COSTUME_ATTR__)
-	if (IsItemComb())
+#if defined(__ACCE_COSTUME_SYSTEM__)
+	if ((m_bAcceCombination) || (m_bAcceAbsorption))
 		return false;
 #endif
 
 #if defined(__CHANGE_LOOK_SYSTEM__)
-	if (GetChangeLook())
+	if (m_bChangeLook)
 		return false;
 #endif
 
-#if defined(__MAILBOX__)
-	if (GetMailBox())
-		return false;
-#endif
-
-#if defined(__GEM_SHOP__)
-	if (GetGemShop())
-		return false;
-#endif
-
-#if defined(__ACCE_COSTUME_SYSTEM__)
-	if (IsAcceRefineWindowOpen())
-		return false;
-#endif
-
-#if defined(__AURA_COSTUME_SYSTEM__)
+#ifdef __AURA_SYSTEM__
 	if (IsAuraRefineWindowOpen() || NULL != GetAuraRefineWindowOpener())
 		return false;
 #endif
-
-#if defined(__CHANGED_ATTR__)
-	if (IsSelectAttr())
-		return false;
-#endif
-
-#if defined(__LUCKY_BOX__)
-	if (IsLuckyBoxOpen())
-		return false;
-#endif
-
-#if defined(__SUMMER_EVENT_ROULETTE__)
-	if (GetMiniGameRoulette())
-		return false;
-#endif
-
 	return true;
 }
 
@@ -442,104 +259,113 @@
 	return GetItem(TItemPos(INVENTORY, wCell));
 }
 
-LPITEM CHARACTER::GetEquipmentItem(WORD wCell) const
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+LPITEM CHARACTER::GetSkillBookInventoryItem(WORD wCell) const
 {
-	return GetItem(TItemPos(EQUIPMENT, wCell));
+	return GetItem(TItemPos(INVENTORY, wCell));
 }
 
-LPITEM CHARACTER::GetDragonSoulInventoryItem(WORD wCell) const
+LPITEM CHARACTER::GetUpgradeItemsInventoryItem(WORD wCell) const
 {
-	return GetItem(TItemPos(DRAGON_SOUL_INVENTORY, wCell));
+	return GetItem(TItemPos(INVENTORY, wCell));
 }
 
-LPITEM CHARACTER::GetBeltInventoryItem(WORD wCell) const
+LPITEM CHARACTER::GetStoneInventoryItem(WORD wCell) const
 {
-	return GetItem(TItemPos(BELT_INVENTORY, wCell));
+	return GetItem(TItemPos(INVENTORY, wCell));
+}
+
+LPITEM CHARACTER::GetGiftBoxInventoryItem(WORD wCell) const
+{
+	return GetItem(TItemPos(INVENTORY, wCell));
+}
+#endif
+
+LPITEM CHARACTER::GetDragonSoulItem(const WORD& wCell) const
+{
+	return GetItem(TItemPos(DRAGON_SOUL_INVENTORY, wCell));
 }
 
 LPITEM CHARACTER::GetItem(TItemPos Cell) const
 {
 	if (!IsValidItemPosition(Cell))
-		return nullptr;
+		return NULL;
 
 	WORD wCell = Cell.cell;
 	BYTE window_type = Cell.window_type;
 
 	switch (window_type)
 	{
-		case INVENTORY:
+	case INVENTORY:
+	case EQUIPMENT:
+		if (wCell >= INVENTORY_AND_EQUIP_SLOT_MAX)
 		{
-			if (wCell >= INVENTORY_MAX_NUM)
-			{
-				sys_err("CHARACTER::GetItem: Invalid Inventory item! Window %d Cell %d", window_type, wCell);
-				return nullptr;
-			}
-			return m_pointsInstant.pInventoryItems[wCell];
+			sys_err("CHARACTER::GetInventoryItem: invalid item cell %d", wCell);
+			return NULL;
 		}
-		break;
 
-		case EQUIPMENT:
-		{
-			if (wCell >= EQUIPMENT_MAX_NUM)
-			{
-				sys_err("CHARACTER::GetItem: Invalid Equipment item! Window %d Cell %d", window_type, wCell);
-				return nullptr;
-			}
-			return m_pointsInstant.pEquipmentItems[wCell];
-		}
-		break;
+		return m_pointsInstant.pItems[wCell];
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
-		case DRAGON_SOUL_INVENTORY:
+	case DRAGON_SOUL_INVENTORY:
+		if (wCell >= DRAGON_SOUL_INVENTORY_MAX_NUM)
 		{
-			if (wCell >= DRAGON_SOUL_INVENTORY_MAX_NUM)
-			{
-				sys_err("CHARACTER::GetItem: Invalid Dragon Soul item! window %d cell %d", window_type, wCell);
-				return nullptr;
-			}
-			return m_pointsInstant.pDragonSoulInventoryItems[wCell];
+			sys_err("CHARACTER::GetInventoryItem: invalid DS item cell %d", wCell);
+			return NULL;
 		}
-		break;
-#endif
 
-		case BELT_INVENTORY:
-		{
-			if (wCell >= BELT_INVENTORY_SLOT_COUNT)
-			{
-				sys_err("CHARACTER::GetItem: Invalid Belt item! window %d cell %d", window_type, wCell);
-				return nullptr;
-			}
-			return m_pointsInstant.pBeltInventoryItems[wCell];
-		}
-		break;
+		return m_pointsInstant.pDSItems[wCell];
 
-#if defined(__ATTR_6TH_7TH__)
-		case NPC_STORAGE:
-		{
-			if (wCell >= NPC_STORAGE_SLOT_MAX)
-			{
-				sys_err("CHARACTER::GetItem: invalid NPC_STORAGE item cell %d", wCell);
-				return nullptr;
-			}
-			return m_pointsInstant.pNPCStorageItems;
-		}
-#endif
+	default:
+		return NULL;
+	}
 
-		default:
-			return nullptr;
+	return NULL;
+}
+
+#if defined(__SWAP_ITEM_SYSTEM__)
+LPITEM CHARACTER::GetItem_NEW(TItemPos Cell) const
+{
+	LPITEM cellItem = GetItem(Cell);
+	if (cellItem)
+		return cellItem;
+
+	// There's no item in this cell, but that does not mean there is not an item which currently uses up this cell.
+	WORD bCell = Cell.cell;
+	BYTE bPage = bCell / (INVENTORY_MAX_NUM / INVENTORY_PAGE_COUNT);
+
+	int j = -2;
+	for (int j = -2; j < 0; ++j)
+	{
+		BYTE p = bCell + (5 * j);
+
+		if (p / (INVENTORY_MAX_NUM / INVENTORY_PAGE_COUNT) != bPage)
+			continue;
+
+		if (p >= INVENTORY_MAX_NUM) // Eeh just for the sake of...
+			continue;
+
+		LPITEM curCellItem = GetItem(TItemPos(INVENTORY, p));
+		if (!curCellItem)
+			continue;
+
+		if (p + (curCellItem->GetSize() - 1) * 5 < Cell.cell) // Doesn't reach Cell.cell
+			continue;
+
+		return curCellItem;
 	}
 
-	return nullptr;
+	return NULL;
 }
+#endif
 
-void CHARACTER::SetItem(TItemPos Cell, LPITEM pItem
 #if defined(__WJ_PICKUP_ITEM_EFFECT__)
-	, bool isHighLight
+void CHARACTER::SetItem(TItemPos Cell, LPITEM pItem, bool isHighLight)
+#else
+void CHARACTER::SetItem(TItemPos Cell, LPITEM pItem)
 #endif
-)
 {
-	BYTE bWindowType = Cell.window_type;
 	WORD wCell = Cell.cell;
+	BYTE window_type = Cell.window_type;
 
 	if ((unsigned long)((CItem*)pItem) == 0xff || (unsigned long)((CItem*)pItem) == 0xffffffff)
 	{
@@ -555,238 +381,123 @@
 	}
 
 	// ⺻ κ丮
-	switch (bWindowType)
+	switch (window_type)
 	{
-		case INVENTORY:
+	case INVENTORY:
+	case EQUIPMENT:
+	{
+		if (wCell >= INVENTORY_AND_EQUIP_SLOT_MAX)
 		{
-			if (wCell >= INVENTORY_MAX_NUM)
-			{
-				sys_err("CHARACTER::SetItem: Invalid Inventory item! Window %d Cell %d", bWindowType, wCell);
-				return;
-			}
+			sys_err("CHARACTER::SetItem: invalid item cell %d", wCell);
+			return;
+		}
+
+		LPITEM pOld = m_pointsInstant.pItems[wCell];
 
-			LPITEM pOldItem = m_pointsInstant.pInventoryItems[wCell];
-			if (pOldItem)
+		if (pOld)
+		{
+			if (wCell < INVENTORY_MAX_NUM)
 			{
-				if (wCell < INVENTORY_MAX_NUM)
+				for (int i = 0; i < pOld->GetSize(); ++i)
 				{
-					for (BYTE bSize = 0; bSize < pOldItem->GetSize(); ++bSize)
-					{
-						WORD wSlot = wCell + (bSize * INVENTORY_WIDTH);
-#if defined(__EXTEND_INVEN_SYSTEM__)
-						if (wSlot >= GetExtendInvenMax())
-							continue;
-#else
-						if (wSlot >= INVENTORY_MAX_NUM)
-							continue;
-#endif
-
-						if (m_pointsInstant.pInventoryItems[wSlot] && m_pointsInstant.pInventoryItems[wSlot] != pOldItem)
-							continue;
+					int p = wCell + (i * 5);
 
-						m_pointsInstant.wInventoryItemGrid[wSlot] = 0;
-					}
-				}
-				else
-					m_pointsInstant.wInventoryItemGrid[wCell] = 0;
-			}
+					if (p >= INVENTORY_MAX_NUM)
+						continue;
 
-			if (pItem)
-			{
-				if (wCell < INVENTORY_MAX_NUM)
-				{
-					for (BYTE bSize = 0; bSize < pItem->GetSize(); ++bSize)
-					{
-						WORD wSlot = wCell + (bSize * INVENTORY_WIDTH);
-#if defined(__EXTEND_INVEN_SYSTEM__)
-						if (wSlot >= GetExtendInvenMax())
-							continue;
-#else
-						if (wSlot >= INVENTORY_MAX_NUM)
-							continue;
-#endif
+					if (m_pointsInstant.pItems[p] && m_pointsInstant.pItems[p] != pOld)
+						continue;
 
-						// wCell + 1  ϴ   üũ  
-						//  óϱ 
-						m_pointsInstant.wInventoryItemGrid[wSlot] = wCell + 1;
-					}
+					m_pointsInstant.bItemGrid[p] = 0;
 				}
-				else
-					m_pointsInstant.wInventoryItemGrid[wCell] = wCell + 1;
 			}
-
-			m_pointsInstant.pInventoryItems[wCell] = pItem;
+			else
+				m_pointsInstant.bItemGrid[wCell] = 0;
 		}
-		break;
 
-		case EQUIPMENT:
+		if (pItem)
 		{
-			if (wCell >= EQUIPMENT_MAX_NUM)
+			if (wCell < INVENTORY_MAX_NUM)
 			{
-				sys_err("CHARACTER::SetItem: Invalid Equipment item! Window %d Cell %d", bWindowType, wCell);
-				return;
-			}
-
-			LPITEM pOldItem = m_pointsInstant.pEquipmentItems[wCell];
-			if (pOldItem)
-			{
-				if (wCell < EQUIPMENT_MAX_NUM)
+				for (int i = 0; i < pItem->GetSize(); ++i)
 				{
-					for (BYTE bSize = 0; bSize < pOldItem->GetSize(); ++bSize)
-					{
-						BYTE bSlot = wCell + bSize;
-						if (bSlot >= EQUIPMENT_MAX_NUM)
-							continue;
+					int p = wCell + (i * 5);
 
-						if (m_pointsInstant.pEquipmentItems[bSlot] && m_pointsInstant.pEquipmentItems[bSlot] != pOldItem)
-							continue;
+					if (p >= INVENTORY_MAX_NUM)
+						continue;
 
-						m_pointsInstant.bEquipmentItemGrid[bSlot] = 0;
-					}
+					// wCell + 1  ϴ   üũ  
+					//  óϱ 
+					m_pointsInstant.bItemGrid[p] = wCell + 1;
 				}
-				else
-					m_pointsInstant.bEquipmentItemGrid[wCell] = 0;
 			}
+			else
+				m_pointsInstant.bItemGrid[wCell] = wCell + 1;
+		}
 
-			if (pItem)
-			{
-				if (wCell < EQUIPMENT_MAX_NUM)
-				{
-					for (BYTE bSize = 0; bSize < pItem->GetSize(); ++bSize)
-					{
-						BYTE bSlot = wCell + bSize;
-						if (bSlot >= EQUIPMENT_MAX_NUM)
-							continue;
-
-						m_pointsInstant.bEquipmentItemGrid[bSlot] = wCell + 1;
-					}
-				}
-				else
-					m_pointsInstant.bEquipmentItemGrid[wCell] = wCell + 1;
-			}
+		m_pointsInstant.pItems[wCell] = pItem;
+	}
+	break;
 
-			m_pointsInstant.pEquipmentItems[wCell] = pItem;
-		}
-		break;
+	// ȥ κ丮
+	case DRAGON_SOUL_INVENTORY:
+	{
+		LPITEM pOld = m_pointsInstant.pDSItems[wCell];
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
-		case DRAGON_SOUL_INVENTORY:
+		if (pOld)
 		{
-			if (wCell >= DRAGON_SOUL_INVENTORY_MAX_NUM)
+			if (wCell < DRAGON_SOUL_INVENTORY_MAX_NUM)
 			{
-				sys_err("CHARACTER::SetItem: Invalid Dragon Soul item! Window %d Cell %d", bWindowType, wCell);
-				return;
-			}
-
-			LPITEM pOldItem = m_pointsInstant.pDragonSoulInventoryItems[wCell];
-			if (pOldItem)
-			{
-				if (wCell < DRAGON_SOUL_INVENTORY_MAX_NUM)
+				for (int i = 0; i < pOld->GetSize(); ++i)
 				{
-					for (BYTE bSize = 0; bSize < pOldItem->GetSize(); ++bSize)
-					{
-						WORD wSlot = wCell + (bSize * DRAGON_SOUL_BOX_COLUMN_NUM);
-						if (wSlot >= DRAGON_SOUL_INVENTORY_MAX_NUM)
-							continue;
+					int p = wCell + (i * DRAGON_SOUL_BOX_COLUMN_NUM);
 
-						if (m_pointsInstant.pDragonSoulInventoryItems[wSlot] && m_pointsInstant.pDragonSoulInventoryItems[wSlot] != pOldItem)
-							continue;
-
-						m_pointsInstant.wDragonSoulInventoryItemGrid[wSlot] = 0;
-					}
-				}
-				else
-					m_pointsInstant.wDragonSoulInventoryItemGrid[wCell] = 0;
-			}
+					if (p >= DRAGON_SOUL_INVENTORY_MAX_NUM)
+						continue;
 
-			if (pItem)
-			{
-				if (wCell < DRAGON_SOUL_INVENTORY_MAX_NUM)
-				{
-					for (BYTE bSize = 0; bSize < pItem->GetSize(); ++bSize)
-					{
-						WORD wSlot = wCell + (bSize * DRAGON_SOUL_BOX_COLUMN_NUM);
-						if (wSlot >= DRAGON_SOUL_INVENTORY_MAX_NUM)
-							continue;
+					if (m_pointsInstant.pDSItems[p] && m_pointsInstant.pDSItems[p] != pOld)
+						continue;
 
-						m_pointsInstant.wDragonSoulInventoryItemGrid[wSlot] = wCell + 1;
-					}
+					m_pointsInstant.wDSItemGrid[p] = 0;
 				}
-				else
-					m_pointsInstant.wDragonSoulInventoryItemGrid[wCell] = wCell + 1;
 			}
-
-			m_pointsInstant.pDragonSoulInventoryItems[wCell] = pItem;
+			else
+				m_pointsInstant.wDSItemGrid[wCell] = 0;
 		}
-		break;
-#endif
 
-		case BELT_INVENTORY:
+		if (pItem)
 		{
-			if (wCell >= BELT_INVENTORY_SLOT_COUNT)
+			if (wCell >= DRAGON_SOUL_INVENTORY_MAX_NUM)
 			{
-				sys_err("CHARACTER::SetItem: Invalid Belt item! Window %d Cell %d", bWindowType, wCell);
+				sys_err("CHARACTER::SetItem: invalid DS item cell %d", wCell);
 				return;
 			}
 
-			LPITEM pOldItem = m_pointsInstant.pBeltInventoryItems[wCell];
-			if (pOldItem)
+			if (wCell < DRAGON_SOUL_INVENTORY_MAX_NUM)
 			{
-				if (wCell < BELT_INVENTORY_SLOT_COUNT)
+				for (int i = 0; i < pItem->GetSize(); ++i)
 				{
-					for (BYTE bSize = 0; bSize < pOldItem->GetSize(); ++bSize)
-					{
-						WORD wSlot = wCell + (bSize * BELT_INVENTORY_SLOT_WIDTH);
-						if (wSlot >= BELT_INVENTORY_SLOT_COUNT)
-							continue;
+					int p = wCell + (i * DRAGON_SOUL_BOX_COLUMN_NUM);
 
-						if (m_pointsInstant.pBeltInventoryItems[wSlot] && m_pointsInstant.pBeltInventoryItems[wSlot] != pOldItem)
-							continue;
-
-						m_pointsInstant.bBeltInventoryItemGrid[wSlot] = 0;
-					}
-				}
-				else
-					m_pointsInstant.bBeltInventoryItemGrid[wCell] = 0;
-			}
-
-			if (pItem)
-			{
-				if (wCell < BELT_INVENTORY_SLOT_COUNT)
-				{
-					for (BYTE bSize = 0; bSize < pItem->GetSize(); ++bSize)
-					{
-						WORD wSlot = wCell + (bSize * BELT_INVENTORY_SLOT_WIDTH);
-						if (wSlot >= BELT_INVENTORY_SLOT_COUNT)
-							continue;
+					if (p >= DRAGON_SOUL_INVENTORY_MAX_NUM)
+						continue;
 
-						m_pointsInstant.bBeltInventoryItemGrid[wSlot] = wCell + 1;
-					}
+					// wCell + 1  ϴ   üũ  
+					//  óϱ 
+					m_pointsInstant.wDSItemGrid[p] = wCell + 1;
 				}
-				else
-					m_pointsInstant.bBeltInventoryItemGrid[wCell] = wCell + 1;
 			}
-
-			m_pointsInstant.pBeltInventoryItems[wCell] = pItem;
+			else
+				m_pointsInstant.wDSItemGrid[wCell] = wCell + 1;
 		}
-		break;
 
-#if defined(__ATTR_6TH_7TH__)
-		case NPC_STORAGE:
-		{
-			if (wCell >= NPC_STORAGE_SLOT_MAX)
-			{
-				sys_err("CHARACTER::SetItem: invalid ATTR67_ADD item cell %d", wCell);
-				return;
-			}
-			m_pointsInstant.pNPCStorageItems = pItem;
-		}
-		break;
-#endif
+		m_pointsInstant.pDSItems[wCell] = pItem;
+	}
+	break;
 
-		default:
-			sys_err("Invalid Inventory type %d", bWindowType);
-			return;
+	default:
+		sys_err("Invalid Inventory type %d", window_type);
+		return;
 	}
 
 	if (GetDesc())
@@ -795,123 +506,102 @@
 		if (pItem)
 		{
 			TPacketGCItemSet pack;
-			pack.bHeader = HEADER_GC_ITEM_SET;
+			pack.header = HEADER_GC_ITEM_SET;
 			pack.Cell = Cell;
-			pack.dwVnum = pItem->GetVnum();
-			pack.dwCount = pItem->GetCount();
-			pack.dwFlags = pItem->GetFlag();
-			pack.dwAntiFlags = pItem->GetAntiFlag();
+
+			pack.count = pItem->GetCount();
+#if defined(__SOUL_BIND_SYSTEM__)
+			pack.soulbind = pItem->GetSealedTime();
+#endif
+#if defined(__CHANGE_LOOK_SYSTEM__)
+			pack.transmutation = pItem->GetTransmutation();
+#endif
+			pack.vnum = pItem->GetVnum();
+			pack.flags = pItem->GetFlag();
+			pack.anti_flags = pItem->GetAntiFlag();
 #if defined(__WJ_PICKUP_ITEM_EFFECT__)
 			if (isHighLight)
-				pack.bHighLight = true;
+				pack.highlight = true;
 			else
-				pack.bHighLight = (Cell.window_type == DRAGON_SOUL_INVENTORY);
+				pack.highlight = (Cell.window_type == DRAGON_SOUL_INVENTORY);
 #else
-			pack.bHighLight = (Cell.window_type == DRAGON_SOUL_INVENTORY);
-#endif
-#if defined(__SOUL_BIND_SYSTEM__)
-			pack.lSealDate = pItem->GetSealDate();
+			pack.highlight = (Cell.window_type == DRAGON_SOUL_INVENTORY);
 #endif
+
 			thecore_memcpy(pack.alSockets, pItem->GetSockets(), sizeof(pack.alSockets));
 			thecore_memcpy(pack.aAttr, pItem->GetAttributes(), sizeof(pack.aAttr));
-#if defined(__CHANGE_LOOK_SYSTEM__)
-			pack.dwTransmutationVnum = pItem->GetTransmutationVnum();
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-			thecore_memcpy(&pack.RefineElement, pItem->GetRefineElement(), sizeof(pack.RefineElement));
-#endif
-#if defined(__ITEM_APPLY_RANDOM__)
-			thecore_memcpy(pack.aApplyRandom, pItem->GetRandomApplies(), sizeof(pack.aApplyRandom));
-#endif
-#if defined(__SET_ITEM__)
-			pack.bSetValue = pItem->GetItemSetValue();
-#endif
 
 			GetDesc()->Packet(&pack, sizeof(TPacketGCItemSet));
 		}
 		else
 		{
-			TPacketGCItemSetEmpty pack;
-			pack.bHeader = HEADER_GC_ITEM_DEL;
+			TPacketGCItemDelDeprecated pack;
+			pack.header = HEADER_GC_ITEM_DEL;
 			pack.Cell = Cell;
-			pack.dwVnum = 0;
-			pack.dwCount = 0;
-			memset(pack.alSockets, 0, sizeof(pack.alSockets));
-			memset(pack.aAttr, 0, sizeof(pack.aAttr));
+			pack.count = 0;
 #if defined(__CHANGE_LOOK_SYSTEM__)
-			pack.dwTransmutationVnum = 0;
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-			memset(&pack.RefineElement, 0, sizeof(pack.RefineElement));
-#endif
-#if defined(__ITEM_APPLY_RANDOM__)
-			memset(pack.aApplyRandom, 0, sizeof(pack.aApplyRandom));
-#endif
-#if defined(__SET_ITEM__)
-			pack.bSetValue = 0;
+			pack.transmutation = 0;
 #endif
+			pack.vnum = 0;
+			memset(pack.alSockets, 0, sizeof(pack.alSockets));
+			memset(pack.aAttr, 0, sizeof(pack.aAttr));
 
-			GetDesc()->Packet(&pack, sizeof(TPacketGCItemSetEmpty));
+			GetDesc()->Packet(&pack, sizeof(TPacketGCItemDelDeprecated));
 		}
 	}
 
 	if (pItem)
 	{
 		pItem->SetCell(this, wCell);
-		switch (bWindowType)
+		switch (window_type)
 		{
-			case INVENTORY:
+		case INVENTORY:
+		case EQUIPMENT:
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+			if ((wCell < INVENTORY_MAX_NUM) || (BELT_INVENTORY_SLOT_START <= wCell && BELT_INVENTORY_SLOT_END > wCell) || (SKILL_BOOK_INVENTORY_SLOT_START <= wCell && SKILL_BOOK_INVENTORY_SLOT_END > wCell) || (UPGRADE_ITEMS_INVENTORY_SLOT_START <= wCell && UPGRADE_ITEMS_INVENTORY_SLOT_END > wCell) || (STONE_INVENTORY_SLOT_START <= wCell && STONE_INVENTORY_SLOT_END > wCell) || (GIFT_BOX_INVENTORY_SLOT_START <= wCell && GIFT_BOX_INVENTORY_SLOT_END > wCell))
+#else
+			if ((wCell < INVENTORY_MAX_NUM) || (BELT_INVENTORY_SLOT_START <= wCell && BELT_INVENTORY_SLOT_END > wCell))
+#endif
 				pItem->SetWindow(INVENTORY);
-				break;
-
-			case EQUIPMENT:
+			else
 				pItem->SetWindow(EQUIPMENT);
-				break;
-
-#if defined(__DRAGON_SOUL_SYSTEM__)
-			case DRAGON_SOUL_INVENTORY:
-				pItem->SetWindow(DRAGON_SOUL_INVENTORY);
-				break;
-#endif
-
-			case BELT_INVENTORY:
-				pItem->SetWindow(BELT_INVENTORY);
-				break;
+			break;
 
-#if defined(__ATTR_6TH_7TH__)
-			case NPC_STORAGE:
-				pItem->SetWindow(NPC_STORAGE);
-				break;
-#endif
+		case DRAGON_SOUL_INVENTORY:
+			pItem->SetWindow(DRAGON_SOUL_INVENTORY);
+			break;
 
-			default:
-				sys_err("Trying to set window %d, non determined behaviour!", bWindowType);
+		default:
+			sys_err("Trying to set window %d, non determined behaviour!", window_type);
 		}
 	}
 }
 
-LPITEM CHARACTER::GetWear(WORD wCell) const
+LPITEM CHARACTER::GetWear(UINT bCell) const
 {
-	if (wCell >= EQUIPMENT_MAX_NUM)
+	// > WEAR_MAX_NUM : ȥ Ե.
+	if (bCell >= WEAR_MAX_NUM + DRAGON_SOUL_DECK_MAX_NUM * DS_SLOT_MAX)
 	{
-		sys_err("CHARACTER::GetWear: invalid wear cell %d", wCell);
-		return nullptr;
+		sys_err("CHARACTER::GetWear: invalid wear cell %d", bCell);
+		return NULL;
 	}
 
-	return m_pointsInstant.pEquipmentItems[wCell];
+	return m_pointsInstant.pItems[INVENTORY_MAX_NUM + bCell];
 }
 
-void CHARACTER::SetWear(WORD wCell, LPITEM item)
+void CHARACTER::SetWear(UINT bCell, LPITEM item)
 {
-	if (wCell >= EQUIPMENT_MAX_NUM)
+	// > WEAR_MAX_NUM : ȥ Ե.
+	if (bCell >= WEAR_MAX_NUM + DRAGON_SOUL_DECK_MAX_NUM * DS_SLOT_MAX)
 	{
-		sys_err("CHARACTER::SetItem: invalid item cell %d", wCell);
+		sys_err("CHARACTER::SetItem: invalid item cell %d", bCell);
 		return;
 	}
 
-	SetItem(TItemPos(EQUIPMENT, wCell), item);
+	SetItem(TItemPos(INVENTORY, INVENTORY_MAX_NUM + bCell), item);
 
-	if (!item && wCell == WEAR_WEAPON)
+	/*
+	if (!item && bCell == WEAR_WEAPON)
 	{
 		// Ͱ    ̶ ȿ ־ Ѵ.
 		if (IsAffectFlag(AFF_GWIGUM))
@@ -920,6 +610,7 @@
 		if (IsAffectFlag(AFF_GEOMGYEONG))
 			RemoveAffect(SKILL_GEOMKYUNG);
 	}
+	*/
 }
 
 void CHARACTER::ClearItem()
@@ -927,302 +618,490 @@
 	int i;
 	LPITEM item;
 
-	for (i = 0; i < INVENTORY_MAX_NUM; ++i)
+	for (i = 0; i < INVENTORY_AND_EQUIP_SLOT_MAX; ++i)
 	{
 		if ((item = GetInventoryItem(i)))
 		{
 			item->SetSkipSave(true);
-			ITEM_MANAGER::Instance().FlushDelayedSave(item);
+			ITEM_MANAGER::instance().FlushDelayedSave(item);
 
 			item->RemoveFromCharacter();
 			M2_DESTROY_ITEM(item);
 
-			SyncQuickslot(SLOT_TYPE_INVENTORY, i, WORD_MAX);
+			SyncQuickslot(QUICKSLOT_TYPE_ITEM, i, WORD_MAX);
 		}
 	}
 
-	for (i = 0; i < EQUIPMENT_MAX_NUM; ++i)
+	for (i = 0; i < DRAGON_SOUL_INVENTORY_MAX_NUM; ++i)
 	{
-		if ((item = GetEquipmentItem(i)))
+		if ((item = GetItem(TItemPos(DRAGON_SOUL_INVENTORY, i))))
 		{
 			item->SetSkipSave(true);
-			ITEM_MANAGER::Instance().FlushDelayedSave(item);
+			ITEM_MANAGER::instance().FlushDelayedSave(item);
 
 			item->RemoveFromCharacter();
 			M2_DESTROY_ITEM(item);
 		}
 	}
+}
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
-	for (i = 0; i < DRAGON_SOUL_INVENTORY_MAX_NUM; ++i)
+bool CHARACTER::IsEmptyItemGrid(TItemPos Cell, BYTE bSize, int iExceptionCell) const
+{
+	switch (Cell.window_type)
 	{
-		if ((item = GetDragonSoulInventoryItem(i)))
-		{
-			item->SetSkipSave(true);
-			ITEM_MANAGER::Instance().FlushDelayedSave(item);
+	case INVENTORY:
+	{
+		UINT bCell = Cell.cell;
 
-			item->RemoveFromCharacter();
-			M2_DESTROY_ITEM(item);
-		}
-	}
-#endif
+		// bItemCell 0 false Ÿ  + 1 ؼ óѴ.
+		//  iExceptionCell 1  Ѵ.
+		++iExceptionCell;
 
-	for (i = 0; i < BELT_INVENTORY_SLOT_COUNT; ++i)
-	{
-		if ((item = GetBeltInventoryItem(i)))
+		if (Cell.IsBeltInventoryPosition())
 		{
-			item->SetSkipSave(true);
-			ITEM_MANAGER::Instance().FlushDelayedSave(item);
+			LPITEM beltItem = GetWear(WEAR_BELT);
 
-			item->RemoveFromCharacter();
-			M2_DESTROY_ITEM(item);
+			if (NULL == beltItem)
+				return false;
 
-			SyncQuickslot(SLOT_TYPE_BELT_INVENTORY, i, WORD_MAX);
-		}
-	}
+			if (false == CBeltInventoryHelper::IsAvailableCell(bCell - BELT_INVENTORY_SLOT_START, beltItem->GetValue(0)))
+				return false;
 
-#if defined(__ATTR_6TH_7TH__)
-	if ((item = GetNPCStorageItem()))
-	{
-		item->SetSkipSave(true);
-		ITEM_MANAGER::Instance().FlushDelayedSave(item);
+			if (m_pointsInstant.bItemGrid[bCell])
+			{
+				if (m_pointsInstant.bItemGrid[bCell] == (UINT)iExceptionCell)
+					return true;
 
-		item->RemoveFromCharacter();
-		M2_DESTROY_ITEM(item);
-	}
-#endif
-}
+				return false;
+			}
 
-bool CHARACTER::IsEmptyItemGrid(TItemPos Cell, BYTE bSize, int iExceptionCell) const
-{
-	switch (Cell.window_type)
-	{
-		case INVENTORY:
+			if (bSize == 1)
+				return true;
+		}
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+		else if (Cell.IsSkillBookInventoryPosition())
 		{
-			const WORD wCell = Cell.cell;
-#if defined(__EXTEND_INVEN_SYSTEM__)
-			if (wCell >= GetExtendInvenMax())
-#else
-			if (wCell >= INVENTORY_MAX_NUM)
-#endif
+			if (bCell < SKILL_BOOK_INVENTORY_SLOT_START)
 				return false;
 
-			// bItemCell 0 false Ÿ  + 1 ؼ óѴ.
-			//  iExceptionCell 1  Ѵ.
-			++iExceptionCell;
+			if (bCell > SKILL_BOOK_INVENTORY_SLOT_END)
+				return false;
 
-			if (m_pointsInstant.wInventoryItemGrid[wCell])
+			if (m_pointsInstant.bItemGrid[bCell] == (UINT)iExceptionCell)
 			{
-				if (m_pointsInstant.wInventoryItemGrid[wCell] == iExceptionCell)
+				if (bSize == 1)
+					return true;
+
+				int j = 1;
+				BYTE bPage = bCell / (SPECIAL_INVENTORY_MAX_NUM / SPECIAL_INVENTORY_PAGE_COUNT);
+
+				do
 				{
-					if (bSize == 1)
-						return true;
+					UINT p = bCell + (5 * j);
 
-					int iOffset = 1;
-#if defined(__EXTEND_INVEN_SYSTEM__)
-					const WORD wPage = wCell / INVENTORY_PAGE_SIZE;
-#else
-					const WORD wPage = wCell / (INVENTORY_MAX_NUM / INVENTORY_PAGE_COUNT);
-#endif
-					do
-					{
-						const WORD wSlot = wCell + (INVENTORY_WIDTH * iOffset);
-#if defined(__EXTEND_INVEN_SYSTEM__)
-						if (wSlot >= GetExtendInvenMax())
-							return false;
+					if (p >= SPECIAL_INVENTORY_MAX_NUM)
+						return false;
 
-						if (wSlot / INVENTORY_PAGE_SIZE != wPage)
-							return false;
-#else
-						if (wSlot >= INVENTORY_MAX_NUM)
-							return false;
+					if (p / (SPECIAL_INVENTORY_MAX_NUM / SPECIAL_INVENTORY_PAGE_COUNT) != bPage)
+						return false;
 
-						if (wSlot / (INVENTORY_MAX_NUM / INVENTORY_PAGE_COUNT) != wPage)
+					if (m_pointsInstant.bItemGrid[p])
+						if (m_pointsInstant.bItemGrid[p] != iExceptionCell)
 							return false;
-#endif
+				} while (++j < bSize);
 
-						if (m_pointsInstant.wInventoryItemGrid[wSlot])
-						{
-							if (m_pointsInstant.wInventoryItemGrid[wSlot] != iExceptionCell)
-								return false;
-						}
-					} while (++iOffset < bSize);
-
-					return true;
-				}
-				else
-					return false;
+				return true;
 			}
+		}
+		else if (Cell.IsUpgradeItemsInventoryPosition())
+		{
+			if (bCell < UPGRADE_ITEMS_INVENTORY_SLOT_START)
+				return false;
 
-			// ũⰡ 1̸ ĭ ϴ ̹Ƿ ׳ 
-			if (1 == bSize)
-				return true;
-			else
+			if (bCell > UPGRADE_ITEMS_INVENTORY_SLOT_END)
+				return false;
+
+			if (m_pointsInstant.bItemGrid[bCell] == (UINT)iExceptionCell)
 			{
-				int iOffset = 1;
-#if defined(__EXTEND_INVEN_SYSTEM__)
-				const WORD wPage = wCell / INVENTORY_PAGE_SIZE;
-#else
-				const WORD wPage = wCell / (INVENTORY_MAX_NUM / INVENTORY_PAGE_COUNT);
-#endif
+				if (bSize == 1)
+					return true;
+
+				int j = 1;
+				BYTE bPage = bCell / (SPECIAL_INVENTORY_MAX_NUM / SPECIAL_INVENTORY_PAGE_COUNT);
 
 				do
 				{
-					const WORD wSlot = wCell + (INVENTORY_WIDTH * iOffset);
-#if defined(__EXTEND_INVEN_SYSTEM__)
-					if (wSlot >= GetExtendInvenMax())
+					UINT p = bCell + (5 * j);
+
+					if (p >= SPECIAL_INVENTORY_MAX_NUM)
 						return false;
 
-					if (wSlot / INVENTORY_PAGE_SIZE != wPage)
+					if (p / (SPECIAL_INVENTORY_MAX_NUM / SPECIAL_INVENTORY_PAGE_COUNT) != bPage)
 						return false;
-#else
-					if (wSlot >= INVENTORY_MAX_NUM)
+
+					if (m_pointsInstant.bItemGrid[p])
+						if (m_pointsInstant.bItemGrid[p] != iExceptionCell)
+							return false;
+				} while (++j < bSize);
+
+				return true;
+			}
+		}
+		else if (Cell.IsStoneInventoryPosition())
+		{
+			if (bCell < STONE_INVENTORY_SLOT_START)
+				return false;
+
+			if (bCell > STONE_INVENTORY_SLOT_END)
+				return false;
+
+			if (m_pointsInstant.bItemGrid[bCell] == (UINT)iExceptionCell)
+			{
+				if (bSize == 1)
+					return true;
+
+				int j = 1;
+				BYTE bPage = bCell / (SPECIAL_INVENTORY_MAX_NUM / SPECIAL_INVENTORY_PAGE_COUNT);
+
+				do
+				{
+					UINT p = bCell + (5 * j);
+
+					if (p >= SPECIAL_INVENTORY_MAX_NUM)
 						return false;
 
-					if (wSlot / (INVENTORY_MAX_NUM / INVENTORY_PAGE_COUNT) != wPage)
+					if (p / (SPECIAL_INVENTORY_MAX_NUM / SPECIAL_INVENTORY_PAGE_COUNT) != bPage)
 						return false;
-#endif
 
-					if (m_pointsInstant.wInventoryItemGrid[wSlot])
-					{
-						if (m_pointsInstant.wInventoryItemGrid[wSlot] != iExceptionCell)
+					if (m_pointsInstant.bItemGrid[p])
+						if (m_pointsInstant.bItemGrid[p] != iExceptionCell)
 							return false;
-					}
-				} while (++iOffset < bSize);
+				} while (++j < bSize);
 
 				return true;
 			}
 		}
-		break;
-
-#if defined(__DRAGON_SOUL_SYSTEM__)
-		case DRAGON_SOUL_INVENTORY:
+		else if (Cell.IsGiftBoxInventoryPosition())
 		{
-			const WORD wCell = Cell.cell;
-			if (wCell >= DRAGON_SOUL_INVENTORY_MAX_NUM)
+			if (bCell < GIFT_BOX_INVENTORY_SLOT_START)
 				return false;
 
-			++iExceptionCell;
+			if (bCell > GIFT_BOX_INVENTORY_SLOT_END)
+				return false;
 
-			if (m_pointsInstant.wDragonSoulInventoryItemGrid[wCell])
+			if (m_pointsInstant.bItemGrid[bCell] == (UINT)iExceptionCell)
 			{
-				if (m_pointsInstant.wDragonSoulInventoryItemGrid[wCell] == iExceptionCell)
+				if (bSize == 1)
+					return true;
+
+				int j = 1;
+				BYTE bPage = bCell / (SPECIAL_INVENTORY_MAX_NUM / SPECIAL_INVENTORY_PAGE_COUNT);
+
+				do
 				{
-					if (bSize == 1)
-						return true;
+					UINT p = bCell + (5 * j);
 
-					int iOffset = 1;
+					if (p >= SPECIAL_INVENTORY_MAX_NUM)
+						return false;
 
-					do
-					{
-						const WORD wSlot = wCell + (DRAGON_SOUL_BOX_COLUMN_NUM * iOffset);
-						if (wSlot >= DRAGON_SOUL_INVENTORY_MAX_NUM)
+					if (p / (SPECIAL_INVENTORY_MAX_NUM / SPECIAL_INVENTORY_PAGE_COUNT) != bPage)
+						return false;
+
+					if (m_pointsInstant.bItemGrid[p])
+						if (m_pointsInstant.bItemGrid[p] != iExceptionCell)
 							return false;
+				} while (++j < bSize);
 
-						if (m_pointsInstant.wDragonSoulInventoryItemGrid[wSlot])
-						{
-							if (m_pointsInstant.wDragonSoulInventoryItemGrid[wSlot] != iExceptionCell)
-								return false;
-						}
-					} while (++iOffset < bSize);
+				return true;
+			}
+		}
+#endif
+		else if (bCell >= INVENTORY_MAX_NUM)
+			return false;
 
+		if (m_pointsInstant.bItemGrid[bCell])
+		{
+			if (m_pointsInstant.bItemGrid[bCell] == (UINT)iExceptionCell)
+			{
+				if (bSize == 1)
 					return true;
-				}
-				else
-					return false;
-			}
 
-			if (1 == bSize)
+				int j = 1;
+				BYTE bPage = bCell / (INVENTORY_MAX_NUM / INVENTORY_PAGE_COUNT);
+
+				do
+				{
+					UINT p = bCell + (5 * j);
+
+					if (p >= INVENTORY_MAX_NUM)
+						return false;
+
+					if (p / (INVENTORY_MAX_NUM / INVENTORY_PAGE_COUNT) != bPage)
+						return false;
+
+					if (m_pointsInstant.bItemGrid[p])
+						if (m_pointsInstant.bItemGrid[p] != iExceptionCell)
+							return false;
+				} while (++j < bSize);
+
 				return true;
+			}
 			else
+				return false;
+		}
+
+		// ũⰡ 1̸ ĭ ϴ ̹Ƿ ׳ 
+		if (1 == bSize)
+			return true;
+		else
+		{
+			int j = 1;
+			BYTE bPage = bCell / (INVENTORY_MAX_NUM / INVENTORY_PAGE_COUNT);
+
+			do
+			{
+				UINT p = bCell + (5 * j);
+
+				if (p >= INVENTORY_MAX_NUM)
+					return false;
+
+				if (p / (INVENTORY_MAX_NUM / INVENTORY_PAGE_COUNT) != bPage)
+					return false;
+
+				if (m_pointsInstant.bItemGrid[p])
+					if (m_pointsInstant.bItemGrid[p] != iExceptionCell)
+						return false;
+			} while (++j < bSize);
+
+			return true;
+		}
+	}
+	break;
+
+	case DRAGON_SOUL_INVENTORY:
+	{
+		WORD wCell = Cell.cell;
+		if (wCell >= DRAGON_SOUL_INVENTORY_MAX_NUM)
+			return false;
+
+		// bItemCell 0 false Ÿ  + 1 ؼ óѴ.
+		//  iExceptionCell 1  Ѵ.
+		iExceptionCell++;
+
+		if (m_pointsInstant.wDSItemGrid[wCell])
+		{
+			if (m_pointsInstant.wDSItemGrid[wCell] == iExceptionCell)
 			{
-				int iOffset = 1;
+				if (bSize == 1)
+					return true;
+
+				int j = 1;
 
 				do
 				{
-					const WORD wSlot = wCell + (DRAGON_SOUL_BOX_COLUMN_NUM * iOffset);
-					if (wSlot >= DRAGON_SOUL_INVENTORY_MAX_NUM)
+					WORD p = wCell + (DRAGON_SOUL_BOX_COLUMN_NUM * j);
+
+					if (p >= DRAGON_SOUL_INVENTORY_MAX_NUM)
 						return false;
 
-					if (m_pointsInstant.wDragonSoulInventoryItemGrid[wSlot])
-					{
-						if (m_pointsInstant.wDragonSoulInventoryItemGrid[wSlot] != iExceptionCell)
+					if (m_pointsInstant.wDSItemGrid[p])
+						if (m_pointsInstant.wDSItemGrid[p] != iExceptionCell)
 							return false;
-					}
-				} while (++iOffset < bSize);
+				} while (++j < bSize);
 
 				return true;
 			}
+			else
+				return false;
 		}
-		break;
-#endif
 
-		case BELT_INVENTORY:
+		// ũⰡ 1̸ ĭ ϴ ̹Ƿ ׳ 
+		if (1 == bSize)
+			return true;
+		else
 		{
-			const WORD wCell = Cell.cell;
-			if (wCell >= BELT_INVENTORY_MAX_NUM)
-				return false;
+			int j = 1;
 
-			++iExceptionCell;
+			do
+			{
+				WORD p = wCell + (DRAGON_SOUL_BOX_COLUMN_NUM * j);
+
+				if (p >= DRAGON_SOUL_INVENTORY_MAX_NUM)
+					return false;
 
-			const LPITEM pBeltItem = GetWear(WEAR_BELT);
-			if (pBeltItem == nullptr)
+				if (m_pointsInstant.bItemGrid[p])
+					if (m_pointsInstant.wDSItemGrid[p] != iExceptionCell)
+						return false;
+			} while (++j < bSize);
+
+			return true;
+		}
+	}
+	break;
+
+	}
+}
+
+bool CHARACTER::IsEmptyItemGridSpecial(TItemPos Cell, BYTE bSize, int iExceptionCell, std::vector<WORD>& vec) const
+{
+	if (std::find(vec.begin(), vec.end(), Cell.cell) != vec.end())
+	{
+		return false;
+	}
+
+	switch (Cell.window_type)
+	{
+	case INVENTORY:
+	{
+		WORD bCell = (WORD)Cell.cell;
+
+		// bItemCell 0 false Ÿ  + 1 ؼ óѴ.
+		//  iExceptionCell 1  Ѵ.
+		++iExceptionCell;
+
+		if (Cell.IsBeltInventoryPosition())
+		{
+			LPITEM beltItem = GetWear(WEAR_BELT);
+
+			if (NULL == beltItem)
 				return false;
 
-			if (!CBeltInventoryHelper::IsAvailableCell(wCell - BELT_INVENTORY_SLOT_START, pBeltItem->GetValue(0)))
+			if (false == CBeltInventoryHelper::IsAvailableCell(bCell - BELT_INVENTORY_SLOT_START, beltItem->GetValue(0)))
 				return false;
 
-			if (m_pointsInstant.bBeltInventoryItemGrid[wCell])
+			if (m_pointsInstant.bItemGrid[bCell])
 			{
-				if (m_pointsInstant.bBeltInventoryItemGrid[wCell] == iExceptionCell)
-				{
-					if (bSize == 1)
-						return true;
+				if (m_pointsInstant.bItemGrid[bCell] == iExceptionCell)
+					return true;
 
-					int iOffset = 1;
+				return false;
+			}
 
-					do
-					{
-						const WORD wSlot = wCell + (BELT_INVENTORY_SLOT_WIDTH * iOffset);
-						if (wSlot >= BELT_INVENTORY_MAX_NUM)
-							return false;
+			if (bSize == 1)
+				return true;
 
-						if (m_pointsInstant.bBeltInventoryItemGrid[wSlot])
-						{
-							if (m_pointsInstant.bBeltInventoryItemGrid[wSlot] != iExceptionCell)
-								return false;
-						}
-					} while (++iOffset < bSize);
+		}
+		else if (bCell >= INVENTORY_MAX_NUM)
+			return false;
 
+		if (m_pointsInstant.bItemGrid[bCell])
+		{
+			if (m_pointsInstant.bItemGrid[bCell] == iExceptionCell)
+			{
+				if (bSize == 1)
 					return true;
-				}
-				else
-					return false;
-			}
 
-			if (1 == bSize)
+				int j = 1;
+				WORD bPage = bCell / (INVENTORY_PAGE_SIZE);
+
+				do
+				{
+					WORD p = bCell + (5 * j);
+
+					if (p >= INVENTORY_MAX_NUM)
+						return false;
+
+					if (p / (INVENTORY_PAGE_SIZE) != bPage)
+						return false;
+
+					if (m_pointsInstant.bItemGrid[p])
+						if (m_pointsInstant.bItemGrid[p] != iExceptionCell)
+							return false;
+				} while (++j < bSize);
+
 				return true;
+			}
 			else
+				return false;
+		}
+
+		// ũⰡ 1̸ ĭ ϴ ̹Ƿ ׳ 
+		if (1 == bSize)
+			return true;
+		else
+		{
+			int j = 1;
+			WORD bPage = bCell / (INVENTORY_PAGE_SIZE);
+
+			do
 			{
-				int iOffset = 1;
+				WORD p = bCell + (5 * j);
+
+				if (p >= INVENTORY_MAX_NUM)
+					return false;
+
+				if (p / (INVENTORY_PAGE_SIZE) != bPage)
+					return false;
+
+				if (m_pointsInstant.bItemGrid[p])
+					if (m_pointsInstant.bItemGrid[p] != iExceptionCell)
+						return false;
+			} while (++j < bSize);
+
+			return true;
+		}
+	}
+	break;
+
+	case DRAGON_SOUL_INVENTORY:
+	{
+		WORD wCell = Cell.cell;
+		if (wCell >= DRAGON_SOUL_INVENTORY_MAX_NUM)
+			return false;
+
+		// bItemCell 0 false Ÿ  + 1 ؼ óѴ.
+		//  iExceptionCell 1  Ѵ.
+		iExceptionCell++;
+
+		if (m_pointsInstant.wDSItemGrid[wCell])
+		{
+			if (m_pointsInstant.wDSItemGrid[wCell] == iExceptionCell)
+			{
+				if (bSize == 1)
+					return true;
+
+				int j = 1;
 
 				do
 				{
-					const WORD wSlot = wCell + (BELT_INVENTORY_SLOT_WIDTH * iOffset);
-					if (wSlot >= BELT_INVENTORY_MAX_NUM)
+					WORD p = wCell + (DRAGON_SOUL_BOX_COLUMN_NUM * j);
+
+					if (p >= DRAGON_SOUL_INVENTORY_MAX_NUM)
 						return false;
 
-					if (m_pointsInstant.bBeltInventoryItemGrid[wSlot])
-					{
-						if (m_pointsInstant.bBeltInventoryItemGrid[wSlot] != iExceptionCell)
+					if (m_pointsInstant.wDSItemGrid[p])
+						if (m_pointsInstant.wDSItemGrid[p] != iExceptionCell)
 							return false;
-					}
-				} while (++iOffset < bSize);
+				} while (++j < bSize);
 
 				return true;
 			}
+			else
+				return false;
+		}
+
+		// ũⰡ 1̸ ĭ ϴ ̹Ƿ ׳ 
+		if (1 == bSize)
+			return true;
+		else
+		{
+			int j = 1;
+
+			do
+			{
+				WORD p = wCell + (DRAGON_SOUL_BOX_COLUMN_NUM * j);
+
+				if (p >= DRAGON_SOUL_INVENTORY_MAX_NUM)
+					return false;
+
+				if (m_pointsInstant.bItemGrid[p])
+					if (m_pointsInstant.wDSItemGrid[p] != iExceptionCell)
+						return false;
+			} while (++j < bSize);
+
+			return true;
 		}
-		break;
+	}
 	}
 
 	return false;
@@ -1232,11 +1111,7 @@
 {
 	// NOTE :   Լ  , ȹ     κ丮  ĭ ã  ǰ ִµ,
 	// Ʈ κ丮 Ư κ丮̹Ƿ ˻ ʵ Ѵ. (⺻ κ丮: INVENTORY_MAX_NUM  ˻)
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	for (int i = 0; i < GetExtendInvenMax(); ++i)
-#else
 	for (int i = 0; i < INVENTORY_MAX_NUM; ++i)
-#endif
 		if (IsEmptyItemGrid(TItemPos(INVENTORY, i), size))
 			return i;
 	return -1;
@@ -1247,11 +1122,7 @@
 	// NOTE :   Լ  , ȹ     κ丮  ĭ ã  ǰ ִµ,
 	// Ʈ κ丮 Ư κ丮̹Ƿ ˻ ʵ Ѵ. (⺻ κ丮: INVENTORY_MAX_NUM  ˻)
 	int emptyCount = 0;
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	for (int i = 0; i < GetExtendInvenMax(); ++i)
-#else
 	for (int i = 0; i < INVENTORY_MAX_NUM; ++i)
-#endif
 	{
 		if (IsEmptyItemGrid(TItemPos(INVENTORY, i), size))
 			++emptyCount;
@@ -1260,15 +1131,14 @@
 	return emptyCount;
 }
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
 int CHARACTER::GetEmptyDragonSoulInventory(LPITEM pItem) const
 {
 	if (NULL == pItem || !pItem->IsDragonSoul())
 		return -1;
-
 	if (!DragonSoul_IsQualified())
+	{
 		return -1;
-
+	}
 	BYTE bSize = pItem->GetSize();
 	WORD wBaseCell = DSManager::instance().GetBasePosition(pItem);
 
@@ -1282,92 +1152,83 @@
 	return -1;
 }
 
-void CHARACTER::CopyDragonSoulItemGrid(std::vector<WORD>& vDragonSoulItemGrid) const
+int CHARACTER::GetEmptyDragonSoulInventoryWithExceptions(LPITEM pItem, std::vector<WORD>& vec /*= -1*/) const
 {
-	vDragonSoulItemGrid.resize(DRAGON_SOUL_INVENTORY_MAX_NUM);
-	std::copy(m_pointsInstant.wDragonSoulInventoryItemGrid, m_pointsInstant.wDragonSoulInventoryItemGrid + DRAGON_SOUL_INVENTORY_MAX_NUM, vDragonSoulItemGrid.begin());
+	if (NULL == pItem || !pItem->IsDragonSoul())
+		return -1;
+
+	if (!DragonSoul_IsQualified())
+	{
+		return -1;
+	}
+
+	BYTE bSize = pItem->GetSize();
+	WORD wBaseCell = DSManager::instance().GetBasePosition(pItem);
+
+	if (WORD_MAX == wBaseCell)
+		return -1;
+
+	for (int i = 0; i < DRAGON_SOUL_BOX_SIZE; ++i)
+		if (IsEmptyItemGridSpecial(TItemPos(DRAGON_SOUL_INVENTORY, i + wBaseCell), bSize, -1, vec))
+			return i + wBaseCell;
+
+	return -1;
 }
-#endif
 
-int CHARACTER::CountEmptyInventory() const
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+int CHARACTER::GetEmptySkillBookInventory(BYTE size) const
 {
-	int count = 0;
-
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	for (int i = 0; i < GetExtendInvenMax(); ++i)
-#else
-	for (int i = 0; i < INVENTORY_MAX_NUM; ++i)
-#endif
-		if (GetInventoryItem(i))
-			count += GetInventoryItem(i)->GetSize();
+	for (int i = SKILL_BOOK_INVENTORY_SLOT_START; i < SKILL_BOOK_INVENTORY_SLOT_END; ++i)
+		if (IsEmptyItemGrid(TItemPos(INVENTORY, i), size))
+			return i;
 
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	return (GetExtendInvenMax() - count);
-#else
-	return (INVENTORY_MAX_NUM - count);
-#endif
+	return -1;
 }
 
-bool CHARACTER::HasEnoughInventorySpace(std::vector<TItemData>& vItems) const
+int CHARACTER::GetEmptyUpgradeItemsInventory(BYTE size) const
 {
-	if (vItems.empty())
-		return true;
+	for (int i = UPGRADE_ITEMS_INVENTORY_SLOT_START; i < UPGRADE_ITEMS_INVENTORY_SLOT_END; ++i)
+		if (IsEmptyItemGrid(TItemPos(INVENTORY, i), size))
+			return i;
 
-	static std::array<CGrid, 4> aGrids = {
-		CGrid(5, INVENTORY_MAX_NUM / 5 / INVENTORY_PAGE_COUNT),
-		CGrid(5, INVENTORY_MAX_NUM / 5 / INVENTORY_PAGE_COUNT),
-		CGrid(5, INVENTORY_MAX_NUM / 5 / INVENTORY_PAGE_COUNT),
-		CGrid(5, INVENTORY_MAX_NUM / 5 / INVENTORY_PAGE_COUNT)
-	};
-	for (auto& kGrid : aGrids)
-		kGrid.Clear();
+	return -1;
+}
 
-	LPITEM pItem = nullptr;
-	for (int i = 0; i < INVENTORY_PAGE_SIZE * 4; ++i)
-	{
-		if ((pItem = GetInventoryItem(i)))
-		{
-			aGrids[i / INVENTORY_PAGE_SIZE].Put(i % INVENTORY_PAGE_SIZE, 1, pItem->GetSize());
-		}
-	}
+int CHARACTER::GetEmptyStoneInventory(BYTE size) const
+{
+	for (int i = STONE_INVENTORY_SLOT_START; i < STONE_INVENTORY_SLOT_END; ++i)
+		if (IsEmptyItemGrid(TItemPos(INVENTORY, i), size))
+			return i;
 
-	for (const TItemData& kItem : vItems)
-	{
-		const TItemTable* pItemTable = ITEM_MANAGER::Instance().GetTable(kItem.dwVnum);
-		if (!pItemTable)
-			return true;
+	return -1;
+}
 
-		int iPos = -1;
-		for (int j = 0; j < aGrids.size(); ++j)
-		{
-			iPos = aGrids[j].FindBlank(1, pItemTable->bSize);
-			if (iPos >= 0)
-			{
-#if defined(__EXTEND_INVEN_SYSTEM__)
-				if (j >= 2)
-				{
-					int iExtendMaxPos = (INVENTORY_WIDTH * (GetExtendInvenStage() - (j - 1))) - 1;
-					if (iPos > iExtendMaxPos)
-						return false;
+int CHARACTER::GetEmptyGiftBoxInventory(BYTE size) const
+{
+	for (int i = GIFT_BOX_INVENTORY_SLOT_START; i < GIFT_BOX_INVENTORY_SLOT_END; ++i)
+		if (IsEmptyItemGrid(TItemPos(INVENTORY, i), size))
+			return i;
 
-					if (pItemTable->bSize > 1)
-					{
-						iExtendMaxPos -= (INVENTORY_WIDTH * (pItemTable->bSize - 1));
-						if (iPos > iExtendMaxPos)
-							return false;
-					}
-				}
+	return -1;
+}
 #endif
-				aGrids[j].Put(iPos, 1, pItemTable->bSize);
-				break;
-			}
-		}
 
-		if (iPos == -1)
-			return false;
-	}
+void CHARACTER::CopyDragonSoulItemGrid(std::vector<WORD>& vDragonSoulItemGrid) const
+{
+	vDragonSoulItemGrid.resize(DRAGON_SOUL_INVENTORY_MAX_NUM);
 
-	return true;
+	std::copy(m_pointsInstant.wDSItemGrid, m_pointsInstant.wDSItemGrid + DRAGON_SOUL_INVENTORY_MAX_NUM, vDragonSoulItemGrid.begin());
+}
+
+int CHARACTER::CountEmptyInventory() const
+{
+	int count = 0;
+
+	for (int i = 0; i < INVENTORY_MAX_NUM; ++i)
+		if (GetInventoryItem(i))
+			count += GetInventoryItem(i)->GetSize();
+
+	return (INVENTORY_MAX_NUM - count);
 }
 
 void TransformRefineItem(LPITEM pkOldItem, LPITEM pkNewItem)
@@ -1375,7 +1236,7 @@
 	// ACCESSORY_REFINE
 	if (pkOldItem->IsAccessoryForSocket())
 	{
-		for (int i = 0; i < METIN_SOCKET_MAX_NUM; ++i)
+		for (int i = 0; i < ITEM_SOCKET_MAX_NUM; ++i)
 		{
 			pkNewItem->SetSocket(i, pkOldItem->GetSocket(i));
 		}
@@ -1385,7 +1246,7 @@
 	else
 	{
 		// ⼭  ڵ û 
-		for (int i = 0; i < METIN_SOCKET_MAX_NUM; ++i)
+		for (int i = 0; i < ITEM_SOCKET_MAX_NUM; ++i)
 		{
 			if (!pkOldItem->GetSocket(i))
 				break;
@@ -1396,7 +1257,7 @@
 		//  
 		int slot = 0;
 
-		for (int i = 0; i < METIN_SOCKET_MAX_NUM; ++i)
+		for (int i = 0; i < ITEM_SOCKET_MAX_NUM; ++i)
 		{
 			long socket = pkOldItem->GetSocket(i);
 
@@ -1406,13 +1267,11 @@
 
 	}
 
-#if defined(__ITEM_SOCKET6__)
-	for (int i = METIN_SOCKET_MAX_NUM; i < ITEM_SOCKET_MAX_NUM; ++i)
-		pkNewItem->SetSocket(i, pkOldItem->GetSocket(i));
-#endif
-
 	//   
 	pkOldItem->CopyAttributeTo(pkNewItem);
+#if defined(__CHANGE_LOOK_SYSTEM__)
+	pkNewItem->SetTransmutation(pkOldItem->GetTransmutation());
+#endif
 }
 
 void NotifyRefineSuccess(LPCHARACTER ch, LPITEM item, const char* way)
@@ -1435,13 +1294,13 @@
 	}
 }
 
-#if defined(__REFINE_MSG_ADD__)
-void NotifyRefineFailType(const LPCHARACTER ch, const LPITEM item, const BYTE type, const char* way, const BYTE success = 0)
+#if defined(__REFINE_FAIL_TYPE__)
+void NotifyRefineFailType(const LPCHARACTER pkChr, const LPITEM pkItem, const BYTE bType, const std::string stRefineType, const BYTE bSuccess = 0)
 {
-	if (ch && item)
+	if (pkChr && pkItem)
 	{
-		ch->ChatPacket(CHAT_TYPE_COMMAND, "RefineFailedType %d", type);
-		LogManager::instance().RefineLog(ch->GetPlayerID(), item->GetName(), item->GetID(), item->GetRefineLevel(), success, way);
+		pkChr->ChatPacket(CHAT_TYPE_COMMAND, "RefineFailedType %d", bType);
+		LogManager::instance().RefineLog(pkChr->GetPlayerID(), pkItem->GetName(), pkItem->GetID(), pkItem->GetRefineLevel(), bSuccess, stRefineType.c_str());
 	}
 }
 #endif
@@ -1466,14 +1325,6 @@
 		return false;
 	}
 
-	// HARDENING: block spoofed refine packets on fishing rods (rods use dedicated upgrade logic)
-	if (item && item->GetType() == ITEM_ROD)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("\xc0\xcc \xbe\xc6\xc0\xcc\xc5\xdb\xc0\xba \xb0\xb3\xb7\xae\xc7\xd2 \xbc\xf6 \xbe\xf8\xbd\xc0\xb4\xcf\xb4\xd9."));
-		ClearRefineMode();
-		return false;
-	}
-
 	// ð : upgrade_refine_scroll.quest   5̳ Ϲ 
 	//Ҽ 
 	if (quest::CQuestManager::instance().GetEventFlag("update_refine_time") != 0)
@@ -1484,8 +1335,17 @@
 			return false;
 		}
 	}
+	
+#ifdef __GROWTH_PET_SYSTEM__
+	if (GetActiveGrowthPet())
+	{
+		ChatPacket(CHAT_TYPE_INFO, "You cannot improve that while an evolvable pet has been summoned.");
+		return false;
+	}
+#endif
 
 	const TRefineTable* prt = CRefineManager::instance().GetRefineRecipe(item->GetRefineSet());
+
 	if (!prt)
 		return false;
 
@@ -1500,7 +1360,7 @@
 	{
 		if (!item->CheckItemUseLevel(20) || item->GetType() != ITEM_WEAPON)
 		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("  ȸ 20  ⸸ մϴ"));
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ȸ 20  ⸸ մϴ"));
 			return false;
 		}
 		cost = 0;
@@ -1510,7 +1370,7 @@
 
 	if (result_vnum == 0)
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ̻   ϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ̻   ϴ."));
 		return false;
 	}
 
@@ -1522,7 +1382,7 @@
 	if (!pProto)
 	{
 		sys_err("DoRefine NOT GET ITEM PROTO %d", item->GetRefinedVnum());
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("    ϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("    ϴ."));
 		return false;
 	}
 
@@ -1535,27 +1395,13 @@
 
 			switch (pProto->aLimits[i].bType)
 			{
-				case LIMIT_LEVEL:
-				{
-					if (GetLevel() < limit)
-					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING("    Ѻ  ϴ."));
-						return false;
-					}
-				}
-				break;
-
-#if defined(__CONQUEROR_LEVEL__)
-				case LIMIT_NEWWORLD_LEVEL:
+			case LIMIT_LEVEL:
+				if (GetLevel() < limit)
 				{
-					if (GetConquerorLevel() < limit)
-					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING("    Ѻ  ϴ."));
-						return false;
-					}
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("    Ѻ  ϴ."));
+					return false;
 				}
 				break;
-#endif
 			}
 		}
 	}
@@ -1563,22 +1409,10 @@
 	// REFINE_COST
 	if (GetGold() < (long long)cost)
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ϱ   մϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ϱ   մϴ."));
 		return false;
 	}
 
-#if defined(__REFINE_STACK_FIX__)
-	int iEmptyPos = GetEmptyInventory(item->GetSize());
-	if (item->IsStackable() && !IS_SET(item->GetAntiFlag(), ITEM_ANTIFLAG_STACK))
-	{
-		if (-1 == iEmptyPos)
-		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("ǰ   ϴ."));
-			return false;
-		}
-	}
-#endif
-
 	if (!bMoneyOnly && !RefineChance)
 	{
 		for (int i = 0; i < prt->material_count; ++i)
@@ -1590,7 +1424,7 @@
 					ChatPacket(CHAT_TYPE_INFO, "Find %d, count %d, require %d", prt->materials[i].vnum, CountSpecifyItem(prt->materials[i].vnum), prt->materials[i].count);
 				}
 
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ϱ  ᰡ մϴ."));
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ϱ  ᰡ մϴ."));
 				return false;
 			}
 		}
@@ -1614,18 +1448,6 @@
 		if (pkNewItem)
 		{
 			ITEM_MANAGER::CopyAllAttrTo(item, pkNewItem);
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-			UpdateExtBattlePassMissionProgress(BP_ITEM_REFINE, 1, item->GetVnum());
-#endif
-
-#if defined(__ITEM_APPLY_RANDOM__)
-			TPlayerItemAttribute aApplyRandom[ITEM_APPLY_MAX_NUM];
-			item->GetRandomApplyTable(aApplyRandom, CApplyRandomTable::GET_NEXT);
-			if (aApplyRandom)
-				pkNewItem->SetRandomApplies(aApplyRandom);
-#endif
-
 			LogManager::instance().ItemLog(this, pkNewItem, "REFINE SUCCESS", pkNewItem->GetName());
 
 			UINT bCell = item->GetCell();
@@ -1633,32 +1455,14 @@
 			// DETAIL_REFINE_LOG
 			NotifyRefineSuccess(this, item, IsRefineThroughGuild() ? "GUILD" : "POWER");
 			DBManager::instance().SendMoneyLog(MONEY_LOG_REFINE, item->GetVnum(), -cost);
+			ITEM_MANAGER::instance().RemoveItem(item, "REMOVE (REFINE SUCCESS)");
 			// END_OF_DETAIL_REFINE_LOG
 
-#if defined(__REFINE_STACK_FIX__)
-			if (item->IsStackable() && !IS_SET(item->GetAntiFlag(), ITEM_ANTIFLAG_STACK))
-			{
-				item->SetCount(item->GetCount() - 1);
-				AutoGiveItem(pkNewItem, true, true
-#if defined(__WJ_PICKUP_ITEM_EFFECT__)
-					, true
-#endif
-				);
-			}
-			else
-			{
-				ITEM_MANAGER::instance().RemoveItem(item, "REMOVE (REFINE SUCCESS)");
-				pkNewItem->AddToCharacter(this, TItemPos(INVENTORY, bCell));
-			}
-#else
-			ITEM_MANAGER::instance().RemoveItem(item, "REMOVE (REFINE SUCCESS)");
 			pkNewItem->AddToCharacter(this, TItemPos(INVENTORY, bCell));
-#endif
-
 			ITEM_MANAGER::instance().FlushDelayedSave(pkNewItem);
-			pkNewItem->AttrLog();
 
 			sys_log(0, "Refine Success %d", cost);
+			pkNewItem->AttrLog();
 			//PointChange(POINT_GOLD, -cost);
 			sys_log(0, "PayPee %d", cost);
 			PayRefineFee(cost);
@@ -1669,7 +1473,7 @@
 			// DETAIL_REFINE_LOG
 			//    ->  з 
 			sys_err("cannot create item %u", result_vnum);
-#if defined(__REFINE_MSG_ADD__)
+#if defined(__REFINE_FAIL_TYPE__)
 			NotifyRefineFailType(this, item, REFINE_FAIL_KEEP_GRADE, IsRefineThroughGuild() ? "GUILD" : "POWER");
 #else
 			NotifyRefineFail(this, item, IsRefineThroughGuild() ? "GUILD" : "POWER");
@@ -1681,25 +1485,13 @@
 	{
 		// !   .
 		DBManager::instance().SendMoneyLog(MONEY_LOG_REFINE, item->GetVnum(), -cost);
-#if defined(__REFINE_MSG_ADD__)
+#if defined(__REFINE_FAIL_TYPE__)
 		NotifyRefineFailType(this, item, REFINE_FAIL_DEL_ITEM, IsRefineThroughGuild() ? "GUILD" : "POWER");
 #else
 		NotifyRefineFail(this, item, IsRefineThroughGuild() ? "GUILD" : "POWER");
 #endif
 		item->AttrLog();
-
-#if defined(__REFINE_STACK_FIX__)
-		if (item->IsStackable() && !IS_SET(item->GetAntiFlag(), ITEM_ANTIFLAG_STACK))
-		{
-			item->SetCount(item->GetCount() - 1);
-		}
-		else
-		{
-			ITEM_MANAGER::instance().RemoveItem(item, "REMOVE (REFINE FAIL)");
-		}
-#else
 		ITEM_MANAGER::instance().RemoveItem(item, "REMOVE (REFINE FAIL)");
-#endif
 
 		//PointChange(POINT_GOLD, -cost);
 		PayRefineFee(cost);
@@ -1708,116 +1500,24 @@
 	return true;
 }
 
-enum ERefineScroll
+enum enum_RefineScrolls
 {
 	CHUKBOK_SCROLL = 0,
-	HYUNIRON_STONE = 1,
+	HYUNIRON_CHN = 1, // ߱ 
 	YONGSIN_SCROLL = 2,
 	MUSIN_SCROLL = 3,
 	YAGONG_SCROLL = 4,
 	MEMO_SCROLL = 5,
 	BDRAGON_SCROLL = 6,
 #if defined(__STONE_OF_BLESS__)
-	BLESSING_STONE = 7,
+	STONE_OF_BLESS = 7,
 #endif
 #if defined(__SOUL_SYSTEM__)
-	SOUL_AWAKE_SCROLL = 8,
-	SOUL_EVOLVE_SCROLL = 9,
-#endif
-#if defined(__STONE_OF_BLESS__)
-	MALL_BLESSING_STONE = 10,
+	SOUL_EVOLVE_SCROLL = 8,
+	SOUL_AWAKE_SCROLL = 9,
 #endif
 };
 
-#if defined(__SOUL_SYSTEM__)
-bool CHARACTER::DoRefineSoul(LPITEM item)
-{
-	if (!CanHandleItem(true))
-	{
-		ClearRefineMode();
-		return false;
-	}
-
-	ClearRefineMode();
-
-	const TRefineTable* prt = CRefineManager::instance().GetRefineRecipe(item->GetRefineSet());
-	if (!prt)
-		return false;
-
-	if (m_iRefineAdditionalCell < 0)
-		return false;
-
-	LPITEM item_scroll = GetInventoryItem(m_iRefineAdditionalCell);
-	if (item_scroll == nullptr)
-		return false;
-
-	if (!(item_scroll->GetType() == ITEM_USE && item_scroll->GetSubType() == USE_TUNING))
-		return false;
-
-	if (item_scroll->GetVnum() == item->GetVnum())
-		return false;
-
-	DWORD result_vnum = item->GetRefinedVnum();
-	if (result_vnum == 0)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ̻   ϴ."));
-		return false;
-	}
-
-	TItemTable* proto = ITEM_MANAGER::instance().GetTable(item->GetRefinedVnum());
-	if (!proto)
-	{
-		sys_err("DoRefineSoul NOT GET ITEM PROTO %d", item->GetRefinedVnum());
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("    ϴ."));
-		return false;
-	}
-
-	int prob = number(1, 100);
-	int success_prob = prt->prob;
-
-	switch (item_scroll->GetValue(0))
-	{
-		case SOUL_AWAKE_SCROLL:
-			success_prob = 100;
-			break;
-
-		case SOUL_EVOLVE_SCROLL:
-			success_prob = soul_refine_prob[MINMAX(0, item->GetValue(1), SOUL_GRADE_MAX)];
-			break;
-	}
-
-	item_scroll->SetCount(item_scroll->GetCount() - 1);
-
-	if (prob <= success_prob)
-	{
-		LPITEM new_item = ITEM_MANAGER::instance().CreateItem(result_vnum, 1, 0, false);
-		if (new_item)
-		{
-			WORD wCell = item->GetCell();
-
-			LogManager::instance().ItemLog(this, new_item, "SOUL REFINE FAIL", new_item->GetName());
-			ChatPacket(CHAT_TYPE_COMMAND, "RefineSoulSuceeded");
-
-			ITEM_MANAGER::instance().RemoveItem(item, "REMOVE (SOUL REFINE FAIL)");
-
-			new_item->AddToCharacter(this, TItemPos(INVENTORY, wCell));
-			ITEM_MANAGER::instance().FlushDelayedSave(new_item);
-		}
-		else
-		{
-			sys_err("cannot create item %u", result_vnum);
-			ChatPacket(CHAT_TYPE_COMMAND, "RefineSoulFailed");
-		}
-	}
-	else
-	{
-		ChatPacket(CHAT_TYPE_COMMAND, "RefineSoulFailed");
-	}
-
-	return true;
-}
-#endif
-
 bool CHARACTER::DoRefineWithScroll(LPITEM item)
 {
 	if (!CanHandleItem(true))
@@ -1838,8 +1538,25 @@
 			return false;
 		}
 	}
+	
+#ifdef __GROWTH_PET_SYSTEM__
+	if (GetActiveGrowthPet())
+	{
+		ChatPacket(CHAT_TYPE_INFO, "You cannot improve that while an evolvable pet has been summoned.");
+		return false;
+	}
+#endif
 
+#if defined(__SOUL_SYSTEM__)
+	const TRefineTable* prt;
+	if (item->GetType() == ITEM_SOUL)
+		prt = CRefineManager::instance().GetRefineRecipe(SOUL_REFINE_SET);
+	else
+		prt = CRefineManager::instance().GetRefineRecipe(item->GetRefineSet());
+#else
 	const TRefineTable* prt = CRefineManager::instance().GetRefineRecipe(item->GetRefineSet());
+#endif
+
 	if (!prt)
 		return false;
 
@@ -1865,36 +1582,85 @@
 
 	if (result_vnum == 0)
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ̻   ϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ̻   ϴ."));
 		return false;
 	}
 
-	TItemTable* pProto = ITEM_MANAGER::instance().GetTable(item->GetRefinedVnum());
-	if (!pProto)
+	// MUSIN_SCROLL
+	if (pkItemScroll->GetValue(0) == MUSIN_SCROLL)
 	{
-		sys_err("DoRefineWithScroll NOT GET ITEM PROTO %d", item->GetRefinedVnum());
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("    ϴ."));
-		return false;
+		if (item->GetRefineLevel() >= 4)
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("   ̻   ϴ."));
+			return false;
+		}
 	}
+	// END_OF_MUSIC_SCROLL
 
-	if (GetGold() < prt->cost)
+	else if (pkItemScroll->GetValue(0) == MEMO_SCROLL)
+	{
+		if (item->GetRefineLevel() != pkItemScroll->GetValue(1))
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("    ϴ."));
+			return false;
+		}
+	}
+	else if (pkItemScroll->GetValue(0) == BDRAGON_SCROLL)
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ϱ   մϴ."));
+		if (item->GetType() != ITEM_METIN || item->GetRefineLevel() != 4)
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("    ϴ."));
+			return false;
+		}
+	}
+
+	TItemTable* pProto = ITEM_MANAGER::instance().GetTable(item->GetRefinedVnum());
+
+	if (!pProto)
+	{
+		sys_err("DoRefineWithScroll NOT GET ITEM PROTO %d", item->GetRefinedVnum());
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("    ϴ."));
 		return false;
 	}
 
-#if defined(__REFINE_STACK_FIX__)
-	int iEmptyPos = GetEmptyInventory(item->GetSize());
-	if (item->IsStackable() && !IS_SET(item->GetAntiFlag(), ITEM_ANTIFLAG_STACK))
+	// Check level limit in korea only
+	if (!g_iUseLocale)
 	{
-		if (-1 == iEmptyPos)
+		for (int i = 0; i < ITEM_LIMIT_MAX_NUM; ++i)
 		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("ǰ   ϴ."));
-			return false;
+			long limit = pProto->aLimits[i].lValue;
+
+			switch (pProto->aLimits[i].bType)
+			{
+			case LIMIT_LEVEL:
+				if (GetLevel() < limit)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("    Ѻ  ϴ."));
+					return false;
+				}
+				break;
+			}
 		}
 	}
+
+#if defined(__SOUL_SYSTEM__)
+	long long llCost = 0;
+	if (pkItemScroll->GetValue(0) == SOUL_EVOLVE_SCROLL)
+		llCost = SOUL_REFINE_COST;
+	else if (pkItemScroll->GetValue(0) == SOUL_AWAKE_SCROLL)
+		llCost = SOUL_REFINE_COST;
+	else
+		llCost = prt->cost;
+#else
+	long long llCost = prt->cost;
 #endif
 
+	if (GetGold() < llCost)
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ϱ   մϴ."));
+		return false;
+	}
+
 	for (int i = 0; i < prt->material_count; ++i)
 	{
 		if (CountSpecifyItem(prt->materials[i].vnum, item->GetCell()) < prt->materials[i].count)
@@ -1904,7 +1670,7 @@
 				ChatPacket(CHAT_TYPE_INFO, "Find %d, count %d, require %d", prt->materials[i].vnum, CountSpecifyItem(prt->materials[i].vnum), prt->materials[i].count);
 			}
 
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ϱ  ᰡ մϴ."));
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ϱ  ᰡ մϴ."));
 			return false;
 		}
 	}
@@ -1913,102 +1679,137 @@
 		RemoveSpecifyItem(prt->materials[i].vnum, prt->materials[i].count, item->GetCell());
 
 	int prob = number(1, 100);
-	const SRefineScrollData& kScroll = GetScrollRefinePct(prt->prob, item->GetRefinedVnum(), pkItemScroll->GetValue(0));
+	int success_prob = prt->prob;
+	bool bDestroyWhenFail = false;
+
 	const char* szRefineType = "SCROLL";
 
-	switch (pkItemScroll->GetValue(0))
+	if (pkItemScroll->GetValue(0) == HYUNIRON_CHN ||
+		pkItemScroll->GetValue(0) == YONGSIN_SCROLL ||
+		pkItemScroll->GetValue(0) == YAGONG_SCROLL
+#if defined(__STONE_OF_BLESS__)
+		|| pkItemScroll->GetValue(0) == STONE_OF_BLESS
+#endif
+		) // ö,  ູ, ߰  ó
 	{
-		case HYUNIRON_STONE:
-			szRefineType = "HYUNIRON_STONE";
-			break;
+		const char hyuniron_prob[9] = { 100, 75, 65, 55, 45, 40, 35, 25, 20 };
+		const char hyuniron_prob_euckr[9] = { 100, 75, 65, 55, 45, 40, 35, 30, 25 };
 
-		case YONGSIN_SCROLL:
-			szRefineType = "GOD_SCROLL";
-			break;
+		const char yagong_prob[9] = { 100, 100, 90, 80, 70, 60, 50, 30, 20 };
+		const char yagong_prob_euckr[9] = { 100, 100, 90, 80, 70, 60, 50, 40, 30 };
 
-		case MUSIN_SCROLL:
-			szRefineType = "MUSIN_SCROLL";
-			break;
+#if defined(__STONE_OF_BLESS__)
+		const char stoneofbless[9] = { 100, 100, 95, 90, 85, 80, 80, 60, 40 };
+#endif
 
-		case YAGONG_SCROLL:
-			szRefineType = "YAGONG_SCROLL";
-			break;
+		if (pkItemScroll->GetValue(0) == YONGSIN_SCROLL)
+		{
+			if (LC_IsYMIR() == true || LC_IsKorea() == true)
+				success_prob = hyuniron_prob_euckr[MINMAX(0, item->GetRefineLevel(), 8)];
+			else
+				success_prob = hyuniron_prob[MINMAX(0, item->GetRefineLevel(), 8)];
+		}
+		else if (pkItemScroll->GetValue(0) == YAGONG_SCROLL)
+		{
+			if (LC_IsYMIR() == true || LC_IsKorea() == true)
+				success_prob = yagong_prob_euckr[MINMAX(0, item->GetRefineLevel(), 8)];
+			else
+				success_prob = yagong_prob[MINMAX(0, item->GetRefineLevel(), 8)];
+		}
+		else if (pkItemScroll->GetValue(0) == HYUNIRON_CHN) {}
+#if defined(__STONE_OF_BLESS__)
+		else if (pkItemScroll->GetValue(0) == STONE_OF_BLESS)
+		{
+			success_prob = stoneofbless[MINMAX(0, item->GetRefineLevel(), 8)];
+		}
+#endif
+		else
+		{
+			sys_err("REFINE : Unknown refine scroll item. Value0: %d", pkItemScroll->GetValue(0));
+		}
 
-		case MEMO_SCROLL:
-			szRefineType = "MEMO_SCROLL";
-			break;
+		if (test_server)
+			ChatPacket(CHAT_TYPE_INFO, "[Only Test] Success_Prob %d, RefineLevel %d ", success_prob, item->GetRefineLevel());
 
-		case BDRAGON_SCROLL:
-			szRefineType = "BDRAGON_SCROLL";
-			break;
+		if (pkItemScroll->GetValue(0) == HYUNIRON_CHN) // ö  μ Ѵ.
+			bDestroyWhenFail = true;
 
+		// DETAIL_REFINE_LOG
+		if (pkItemScroll->GetValue(0) == HYUNIRON_CHN)
+		{
+			szRefineType = "HYUNIRON";
+		}
+		else if (pkItemScroll->GetValue(0) == YONGSIN_SCROLL)
+		{
+			szRefineType = "GOD_SCROLL";
+		}
+		else if (pkItemScroll->GetValue(0) == YAGONG_SCROLL)
+		{
+			szRefineType = "YAGONG_SCROLL";
+		}
 #if defined(__STONE_OF_BLESS__)
-		case BLESSING_STONE:
-			szRefineType = "BLESSING_STONE";
-			break;
-
-		case MALL_BLESSING_STONE:
-			szRefineType = "MALL_BLESSING_STONE";
-			break;
+		else if (pkItemScroll->GetValue(0) == STONE_OF_BLESS)
+		{
+			szRefineType = "STONE_OF_BLESS";
+		}
 #endif
-
-		default:
-			sys_err("REFINE : Unknown refine scroll item. Value0: %d", pkItemScroll->GetValue(0));
-			break;
+		// END_OF_DETAIL_REFINE_LOG
 	}
 
-	if (test_server)
-		ChatPacket(CHAT_TYPE_INFO, "[Only Test] SuccessProb %d, RefineLevel %d ", kScroll.bSuccessProb, item->GetRefineLevel());
+	// DETAIL_REFINE_LOG
+	if (pkItemScroll->GetValue(0) == MUSIN_SCROLL) //  ູ 100%  (+4)
+	{
+		success_prob = 100;
+		szRefineType = "MUSIN_SCROLL";
+	}
+	// END_OF_DETAIL_REFINE_LOG
+	else if (pkItemScroll->GetValue(0) == MEMO_SCROLL)
+	{
+		success_prob = 100;
+		szRefineType = "MEMO_SCROLL";
+	}
+	else if (pkItemScroll->GetValue(0) == BDRAGON_SCROLL)
+	{
+		success_prob = 80;
+		szRefineType = "BDRAGON_SCROLL";
+	}
+#if defined(__SOUL_SYSTEM__)
+	else if (pkItemScroll->GetValue(0) == SOUL_EVOLVE_SCROLL)
+	{
+		success_prob = SOUL_REFINE_EVOLVE_PROB;
+		szRefineType = "SOUL_EVOLVE_SCROLL";
+	}
+	else if (pkItemScroll->GetValue(0) == SOUL_AWAKE_SCROLL)
+	{
+		success_prob = SOUL_REFINE_AWAKE_PROB;
+		szRefineType = "SOUL_AWAKE_SCROLL";
+	}
+#endif
 
 	pkItemScroll->SetCount(pkItemScroll->GetCount() - 1);
 
-	if (prob <= kScroll.bSuccessProb)
+	if (prob <= success_prob)
 	{
 		// !   ,  Ӽ ٸ  ȹ
 		LPITEM pkNewItem = ITEM_MANAGER::instance().CreateItem(result_vnum, 1, 0, false);
 
 		if (pkNewItem)
 		{
+#if defined(__SOUL_SYSTEM__)
+			if (item->GetType() != ITEM_SOUL)
+				ITEM_MANAGER::CopyAllAttrTo(item, pkNewItem);
+#else
 			ITEM_MANAGER::CopyAllAttrTo(item, pkNewItem);
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-			UpdateExtBattlePassMissionProgress(BP_ITEM_REFINE, 1, item->GetVnum());
 #endif
-
-#if defined(__ITEM_APPLY_RANDOM__)
-			TPlayerItemAttribute aApplyRandom[ITEM_APPLY_MAX_NUM];
-			item->GetRandomApplyTable(aApplyRandom, CApplyRandomTable::GET_NEXT);
-			if (aApplyRandom)
-				pkNewItem->SetRandomApplies(aApplyRandom);
-#endif
-
 			LogManager::instance().ItemLog(this, pkNewItem, "REFINE SUCCESS", pkNewItem->GetName());
 
 			UINT bCell = item->GetCell();
 
 			NotifyRefineSuccess(this, item, szRefineType);
 			DBManager::instance().SendMoneyLog(MONEY_LOG_REFINE, item->GetVnum(), -prt->cost);
-
-#if defined(__REFINE_STACK_FIX__)
-			if (item->IsStackable() && !IS_SET(item->GetAntiFlag(), ITEM_ANTIFLAG_STACK))
-			{
-				item->SetCount(item->GetCount() - 1);
-				AutoGiveItem(pkNewItem, true, true
-#if defined(__WJ_PICKUP_ITEM_EFFECT__)
-					, true
-#endif
-				);
-			}
-			else
-			{
-				ITEM_MANAGER::instance().RemoveItem(item, "REMOVE (REFINE SUCCESS)");
-				pkNewItem->AddToCharacter(this, TItemPos(INVENTORY, bCell));
-			}
-#else
 			ITEM_MANAGER::instance().RemoveItem(item, "REMOVE (REFINE SUCCESS)");
-			pkNewItem->AddToCharacter(this, TItemPos(INVENTORY, bCell));
-#endif
 
+			pkNewItem->AddToCharacter(this, TItemPos(INVENTORY, bCell));
 			ITEM_MANAGER::instance().FlushDelayedSave(pkNewItem);
 			pkNewItem->AttrLog();
 
@@ -2019,66 +1820,41 @@
 		{
 			//    ->  з 
 			sys_err("cannot create item %u", result_vnum);
-#if defined(__REFINE_MSG_ADD__)
+#if defined(__REFINE_FAIL_TYPE__)
 			NotifyRefineFailType(this, item, REFINE_FAIL_KEEP_GRADE, szRefineType);
 #else
 			NotifyRefineFail(this, item, szRefineType);
 #endif
 		}
 	}
-	else if (!kScroll.bKeepGrade && result_fail_vnum)
+	else if (!bDestroyWhenFail && result_fail_vnum)
 	{
 		// !   ,  Ӽ    ȹ
 		LPITEM pkNewItem = ITEM_MANAGER::instance().CreateItem(result_fail_vnum, 1, 0, false);
 
 		if (pkNewItem)
 		{
+#if defined(__SOUL_SYSTEM__)
+			if (item->GetType() != ITEM_SOUL)
+				ITEM_MANAGER::CopyAllAttrTo(item, pkNewItem);
+#else
 			ITEM_MANAGER::CopyAllAttrTo(item, pkNewItem);
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-			UpdateExtBattlePassMissionProgress(BP_ITEM_REFINE, 1, item->GetVnum());
-#endif
-
-#if defined(__ITEM_APPLY_RANDOM__)
-			TPlayerItemAttribute aApplyRandom[ITEM_APPLY_MAX_NUM];
-			item->GetRandomApplyTable(aApplyRandom, CApplyRandomTable::GET_PREVIOUS);
-			if (aApplyRandom)
-				pkNewItem->SetRandomApplies(aApplyRandom);
 #endif
-
 			LogManager::instance().ItemLog(this, pkNewItem, "REFINE FAIL", pkNewItem->GetName());
 
 			UINT bCell = item->GetCell();
 
 			DBManager::instance().SendMoneyLog(MONEY_LOG_REFINE, item->GetVnum(), -prt->cost);
-#if defined(__REFINE_MSG_ADD__)
+#if defined(__REFINE_FAIL_TYPE__)
 			NotifyRefineFailType(this, item, REFINE_FAIL_GRADE_DOWN, szRefineType, -1);
 #else
 			NotifyRefineFail(this, item, szRefineType, -1);
-
 #endif
-
-#if defined(__REFINE_STACK_FIX__)
-			if (item->IsStackable() && !IS_SET(item->GetAntiFlag(), ITEM_ANTIFLAG_STACK))
-			{
-				item->SetCount(item->GetCount() - 1);
-				AutoGiveItem(pkNewItem, true, true
-#if defined(__WJ_PICKUP_ITEM_EFFECT__)
-					, true
-#endif
-				);
-			}
-			else
-			{
-				ITEM_MANAGER::instance().RemoveItem(item, "REMOVE (REFINE FAIL)");
-				pkNewItem->AddToCharacter(this, TItemPos(INVENTORY, bCell));
-			}
-#else
 			ITEM_MANAGER::instance().RemoveItem(item, "REMOVE (REFINE FAIL)");
-			pkNewItem->AddToCharacter(this, TItemPos(INVENTORY, bCell));
-#endif
 
+			pkNewItem->AddToCharacter(this, TItemPos(INVENTORY, bCell));
 			ITEM_MANAGER::instance().FlushDelayedSave(pkNewItem);
+
 			pkNewItem->AttrLog();
 
 			//PointChange(POINT_GOLD, -prt->cost);
@@ -2088,7 +1864,7 @@
 		{
 			//    ->  з 
 			sys_err("cannot create item %u", result_fail_vnum);
-#if defined(__REFINE_MSG_ADD__)
+#if defined(__REFINE_FAIL_TYPE__)
 			NotifyRefineFailType(this, item, REFINE_FAIL_KEEP_GRADE, szRefineType);
 #else
 			NotifyRefineFail(this, item, szRefineType);
@@ -2097,7 +1873,7 @@
 	}
 	else
 	{
-#if defined(__REFINE_MSG_ADD__)
+#if defined(__REFINE_FAIL_TYPE__)
 		NotifyRefineFailType(this, item, REFINE_FAIL_KEEP_GRADE, szRefineType);
 #else
 		NotifyRefineFail(this, item, szRefineType); //    
@@ -2108,105 +1884,42 @@
 	return true;
 }
 
-CHARACTER::SRefineScrollData CHARACTER::GetScrollRefinePct(BYTE bProb, BYTE bRefineLevel, BYTE bScrollType)
+bool CHARACTER::RefineInformation(BYTE bCell, BYTE bType, int iAdditionalCell)
+//bool CHARACTER::RefineInformation(UINT bCell, BYTE bType, int iAdditionalCell)
 {
-	SRefineScrollData Scroll{};
-	Scroll.bSuccessProb = bProb;
-	Scroll.bKeepGrade = false;
-
-	// ö,  ູ, ߰  ó
-	switch (bScrollType)
-	{
-		case CHUKBOK_SCROLL:
-			break;
-
-		case HYUNIRON_STONE:
-			Scroll.bSuccessProb = MINMAX(1, bProb + 10, 100);
-			Scroll.bKeepGrade = true;
-			break;
-
-		case YONGSIN_SCROLL:
-			Scroll.bSuccessProb = MINMAX(1, bProb + 10, 100);
-			break;
-
-		case MUSIN_SCROLL: //  ູ 100%  (+4)
-			Scroll.bSuccessProb = 100;
-			break;
-
-		case YAGONG_SCROLL:
-			Scroll.bSuccessProb = MINMAX(1, bProb + 15, 100);
-			break;
-
-		case MEMO_SCROLL:
-			Scroll.bSuccessProb = 100;
-			break;
-
-		case BDRAGON_SCROLL:
-			Scroll.bSuccessProb = 80;
-			break;
-
-#if defined(__STONE_OF_BLESS__)
-		case BLESSING_STONE:
-			Scroll.bSuccessProb = MINMAX(1, bProb + 15, 100);
-			Scroll.bKeepGrade = true;
-			break;
-
-		case MALL_BLESSING_STONE:
-			Scroll.bSuccessProb = MINMAX(1, bProb + 20, 100);
-			Scroll.bKeepGrade = true;
-			break;
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	if (bCell > INVENTORY_MAX_NUM + SPECIAL_INVENTORY_MAX_PAGE_NUM)
+		return false;
+#else
+	if (bCell > INVENTORY_MAX_NUM)
+		return false;
 #endif
-	}
 
-	return Scroll;
-}
+	LPITEM item = GetInventoryItem(bCell);
 
-bool CHARACTER::RefineInformation(WORD wCell, BYTE bType, int iAdditionalCell)
-{
-	if (wCell > INVENTORY_MAX_NUM)
-		return false;
-
-	const LPITEM item = GetInventoryItem(wCell);
 	if (!item)
 		return false;
 
-	// HARDENING: fishing rods do not use refine_proto (avoid spoofed REFINE packets)
-	if (item->GetType() == ITEM_ROD)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("\xc0\xcc \xbe\xc6\xc0\xcc\xc5\xdb\xc0\xba \xb0\xb3\xb7\xae\xc7\xd2 \xbc\xf6 \xbe\xf8\xbd\xc0\xb4\xcf\xb4\xd9."));
-		ClearRefineMode();
-		return false;
-	}
-
 	// REFINE_COST
 	if (bType == REFINE_TYPE_MONEY_ONLY && !GetQuestFlag("deviltower_zone.can_refine"))
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING(" Ÿ Ϸ  ѹ 밡մϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" Ÿ Ϸ  ѹ 밡մϴ."));
 		return false;
 	}
 	// END_OF_REFINE_COST
 
 	TPacketGCRefineInformation p;
+
 	p.header = HEADER_GC_REFINE_INFORMATION;
-	p.pos = wCell;
+	p.pos = bCell;
 	p.src_vnum = item->GetVnum();
 	p.result_vnum = item->GetRefinedVnum();
 	p.type = bType;
 
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	thecore_memcpy(&p.RefineElement, item->GetRefineElement(), sizeof(p.RefineElement));
-#endif
-
-#if defined(__ITEM_APPLY_RANDOM__)
-	TPlayerItemAttribute aApplyRandom[ITEM_APPLY_MAX_NUM];
-	item->GetRandomApplyTable(aApplyRandom, CApplyRandomTable::GET_NEXT);
-	thecore_memcpy(&p.aApplyRandom, aApplyRandom, sizeof(p.aApplyRandom));
-#endif
-
 	if (p.result_vnum == 0)
 	{
 		sys_err("RefineInformation p.result_vnum == 0");
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("    ϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("    ϴ."));
 		return false;
 	}
 
@@ -2214,45 +1927,37 @@
 	{
 		if (bType == 0)
 		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("   δ   ϴ."));
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("   δ   ϴ."));
 			return false;
 		}
 		else
 		{
-			const LPITEM& item_scroll = GetInventoryItem(iAdditionalCell);
-			if (!item_scroll || item->GetVnum() == item_scroll->GetVnum())
+			LPITEM itemScroll = GetInventoryItem(iAdditionalCell);
+			if (!itemScroll || item->GetVnum() == itemScroll->GetVnum())
 			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("  ĥ  ϴ."));
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("ູ  ö ĥ  ֽϴ."));
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ĥ  ϴ."));
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ູ  ö ĥ  ֽϴ."));
 				return false;
 			}
 		}
 	}
 
+	CRefineManager& rm = CRefineManager::instance();
+
 #if defined(__SOUL_SYSTEM__)
+	const TRefineTable* prt;
 	if (item->GetType() == ITEM_SOUL)
-	{
-		if (bType == REFINE_TYPE_SOUL_AWAKE || bType == REFINE_TYPE_SOUL_EVOLVE)
-		{
-			p.cost = 0;
-			p.prob = bType == REFINE_TYPE_SOUL_AWAKE ? 100 : soul_refine_prob[MINMAX(0, item->GetValue(1), SOUL_GRADE_MAX)];
-			p.material_count = 0;
-			std::memset(p.materials, 0, sizeof(p.materials));
-
-			GetDesc()->Packet(&p, sizeof(TPacketGCRefineInformation));
-
-			SetRefineMode(iAdditionalCell);
-			return true;
-		}
-	}
+		prt = rm.GetRefineRecipe(SOUL_REFINE_SET);
+	else
+		prt = rm.GetRefineRecipe(item->GetRefineSet());
+#else
+	const TRefineTable* prt = rm.GetRefineRecipe(item->GetRefineSet());
 #endif
 
-	CRefineManager& rm = CRefineManager::instance();
-	const TRefineTable* prt = rm.GetRefineRecipe(item->GetRefineSet());
 	if (!prt)
 	{
 		sys_err("RefineInformation NOT GET REFINE SET %d", item->GetRefineSet());
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("    ϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("    ϴ."));
 		return false;
 	}
 
@@ -2264,7 +1969,7 @@
 		// Ϻ 
 		if (!item->CheckItemUseLevel(20) || item->GetType() != ITEM_WEAPON)
 		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("  ȸ 20  ⸸ մϴ"));
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ȸ 20  ⸸ մϴ"));
 			return false;
 		}
 		p.cost = 0;
@@ -2273,28 +1978,29 @@
 		p.cost = ComputeRefineFee(prt->cost);
 	// END_MAIN_QUEST_LV7
 
-	const LPITEM& item_scroll = GetInventoryItem(iAdditionalCell);
-	if (item_scroll)
+	p.prob = prt->prob;
+
+	if (bType == REFINE_TYPE_MONEY_ONLY)
 	{
-		const SRefineScrollData& kScroll = GetScrollRefinePct(prt->prob, item->GetRefinedVnum(), item_scroll->GetValue(0));
-		p.prob = kScroll.bSuccessProb;
+		p.material_count = 0;
+		memset(p.materials, 0, sizeof(p.materials));
 	}
-	else
+#if defined(__SOUL_SYSTEM__)
+	else if (bType == REFINE_TYPE_SOUL_EVOLVE)
 	{
-		p.prob = prt->prob;
-
-		if (IsRefineThroughGuild())
-			p.prob += 10;
+		p.cost = SOUL_REFINE_COST;
+		p.prob = SOUL_REFINE_EVOLVE_PROB;
+		p.material_count = 0;
+		memset(p.materials, 0, sizeof(p.materials));
 	}
-
-	if (p.prob > 100)
-		p.prob = 100;
-
-	if (bType == REFINE_TYPE_MONEY_ONLY)
+	else if (bType == REFINE_TYPE_SOUL_AWAKE)
 	{
+		p.cost = SOUL_REFINE_COST;
+		p.prob = SOUL_REFINE_AWAKE_PROB;
 		p.material_count = 0;
 		memset(p.materials, 0, sizeof(p.materials));
 	}
+#endif
 	else
 	{
 		p.material_count = prt->material_count;
@@ -2313,132 +2019,53 @@
 	if (!CanHandleItem())
 		return false;
 
-	// HARDENING: prevent applying refine/scroll logic to fishing rods
-	if (pkTarget && pkTarget->GetType() == ITEM_ROD)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("\xc0\xcc \xbe\xc6\xc0\xcc\xc5\xdb\xc0\xba \xb0\xb3\xb7\xae\xc7\xd2 \xbc\xf6 \xbe\xf8\xbd\xc0\xb4\xcf\xb4\xd9."));
-		return false;
-	}
-
 	if (pkItem->GetSubType() == USE_TUNING)
 	{
 		// XXX ,   ϴ...
 		// XXX ɰ ູ  Ǿ!
-
-		BYTE bRefineType = REFINE_TYPE_NORMAL;
-		switch (pkItem->GetValue(0))
+		// MUSIN_SCROLL
+		if (pkItem->GetValue(0) == MUSIN_SCROLL)
+			RefineInformation(pkTarget->GetCell(), REFINE_TYPE_MUSIN, pkItem->GetCell());
+		// END_OF_MUSIN_SCROLL
+		else if (pkItem->GetValue(0) == HYUNIRON_CHN)
+			RefineInformation(pkTarget->GetCell(), REFINE_TYPE_HYUNIRON, pkItem->GetCell());
+		else if (pkItem->GetValue(0) == BDRAGON_SCROLL)
 		{
-			case HYUNIRON_STONE:
-				bRefineType = REFINE_TYPE_HYUNIRON;
-				break;
-
-			case MUSIN_SCROLL:
-			{
-				if (pkTarget->GetRefineLevel() >= 4)
-				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("   ̻   ϴ."));
-					return false;
-				}
-
-				bRefineType = REFINE_TYPE_MUSIN;
-			}
-			break;
-
-			case MEMO_SCROLL:
-			{
-				if (pkTarget->GetRefineLevel() != pkItem->GetValue(1))
-				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("    ϴ."));
-					return false;
-				}
-
-				bRefineType = REFINE_TYPE_NOT_USED1;
-			}
-			break;
-
-			case BDRAGON_SCROLL:
-			{
-				if (pkTarget->GetType() != ITEM_METIN || pkTarget->GetRefineLevel() != 4)
-				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("    ϴ."));
-					return false;
-				}
-
-				if (pkTarget->GetRefineSet() != 702)
-					return false;
-			}
-			break;
-
+			if (pkTarget->GetRefineSet() != 702) return false;
+			RefineInformation(pkTarget->GetCell(), REFINE_TYPE_BDRAGON, pkItem->GetCell());
+		}
 #if defined(__STONE_OF_BLESS__)
-			case BLESSING_STONE:
-			{
-				if (pkTarget->GetLevelLimit() <= 80)
-					return false;
-
-				bRefineType = REFINE_TYPE_BLESSING_STONE;
-			}
-			break;
-
-			case MALL_BLESSING_STONE:
-				bRefineType = REFINE_TYPE_BLESSING_STONE;
-				break;
+		else if (pkItem->GetValue(0) == STONE_OF_BLESS)
+		{
+			if (pkTarget->GetLevelLimit() <= 80) return false;
+			RefineInformation(pkTarget->GetCell(), REFINE_TYPE_STONE_OF_BLESS, pkItem->GetCell());
+		}
 #endif
-
 #if defined(__SOUL_SYSTEM__)
-			case SOUL_AWAKE_SCROLL:
-			case SOUL_EVOLVE_SCROLL:
-			{
-				if (pkTarget->GetType() != ITEM_SOUL)
-					return false;
-
-				if (pkTarget->GetValue(0) >= SOUL_GRADE_ILUMINED)
-				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Soul System] %s is already at the highest level.", LC_ITEM(pkTarget->GetVnum())));
-					return false;
-				}
-
-				if (pkItem->GetValue(0) == SOUL_AWAKE_SCROLL)
-					bRefineType = REFINE_TYPE_SOUL_AWAKE;
-				else if (pkItem->GetValue(0) == SOUL_EVOLVE_SCROLL)
-					bRefineType = REFINE_TYPE_SOUL_EVOLVE;
-			}
-			break;
+		else if (pkItem->GetValue(0) == SOUL_EVOLVE_SCROLL)
+		{
+			if (pkTarget->GetType() != ITEM_SOUL) return false;
+			RefineInformation(pkTarget->GetCell(), REFINE_TYPE_SOUL_EVOLVE, pkItem->GetCell());
+		}
+		else if (pkItem->GetValue(0) == SOUL_AWAKE_SCROLL)
+		{
+			if (pkTarget->GetType() != ITEM_SOUL) return false;
+			RefineInformation(pkTarget->GetCell(), REFINE_TYPE_SOUL_AWAKE, pkItem->GetCell());
+		}
 #endif
-
-			default:
-			{
-				if (pkTarget->GetRefineSet() == 501)
-					return false;
-
-				if (pkTarget->GetVnum() >= 28330 && pkTarget->GetVnum() <= 28343) // +3
-				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("+3      ϴ"));
-					return false;
-				}
-
-				if (pkTarget->GetVnum() >= 28430 && pkTarget->GetVnum() <= 28443) // +4
-				{
-					if (pkItem->GetVnum() != 71056) // ûǼ
-					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING("     ϴ"));
-						return false;
-					}
-				}
-
-				bRefineType = REFINE_TYPE_SCROLL;
-			}
-			break;
+		else
+		{
+			if (pkTarget->GetRefineSet() == 501) return false;
+			RefineInformation(pkTarget->GetCell(), REFINE_TYPE_SCROLL, pkItem->GetCell());
 		}
-
-		RefineInformation(pkTarget->GetCell(), bRefineType, pkItem->GetCell());
 	}
-	else if (pkItem->GetSubType() == USE_DETACHMENT && IS_SET(pkTarget->GetFlag(), ITEM_FLAG_REFINEABLE) && pkTarget->IsRemovableSocket())
+	else if (pkItem->GetSubType() == USE_DETACHMENT && IS_SET(pkTarget->GetFlag(), ITEM_FLAG_REFINEABLE))
 	{
 		LogManager::instance().ItemLog(this, pkTarget, "USE_DETACHMENT", pkTarget->GetName());
 
 		bool bHasMetinStone = false;
 
-		for (int i = 0; i < METIN_SOCKET_MAX_NUM; i++)
+		for (int i = 0; i < ITEM_SOCKET_MAX_NUM; i++)
 		{
 			long socket = pkTarget->GetSocket(i);
 			if (socket > 2 && socket != ITEM_BROKEN_METIN_VNUM)
@@ -2450,25 +2077,11 @@
 
 		if (bHasMetinStone)
 		{
-			for (int i = 0; i < METIN_SOCKET_MAX_NUM; ++i)
+			for (int i = 0; i < ITEM_SOCKET_MAX_NUM; ++i)
 			{
 				long socket = pkTarget->GetSocket(i);
 				if (socket > 2 && socket != ITEM_BROKEN_METIN_VNUM)
 				{
-#if defined(__GLOVE_SYSTEM__)
-					if (pkTarget->IsGlove() && socket >= 1000000)
-					{
-						DWORD dwBaseIndex = 28046;
-						dwBaseIndex += (((socket / 1000) % 10) * 100);
-						dwBaseIndex += ((socket / 100) % 10) - 1;
-
-						const TItemTable* pItemData = ITEM_MANAGER::instance().GetTable(dwBaseIndex);
-						if (pItemData == nullptr)
-							continue;
-
-						socket = dwBaseIndex;
-					}
-#endif
 					AutoGiveItem(socket);
 					//TItemTable* pTable = ITEM_MANAGER::instance().GetTable(pkTarget->GetSocket(i));
 					//pkTarget->SetSocket(i, pTable->alValues[2]);
@@ -2481,7 +2094,7 @@
 		}
 		else
 		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("  ִ ƾ ϴ."));
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ִ ƾ ϴ."));
 			return false;
 		}
 	}
@@ -2525,19 +2138,15 @@
 
 	switch (idx)
 	{
-		case 66:
-		case 216:
-		case 301:
-		case 302:
-		case 303:
-		case 304:
-			iEmpireByMapIndex = -1;
-			break;
+	case 66:
+	case 216:
+		iEmpireByMapIndex = -1;
+		break;
 	}
 
 	if (iEmpireByMapIndex && GetEmpire() != iEmpireByMapIndex)
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("    ġ Դϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("    ġ Դϴ."));
 		return false;
 	}
 
@@ -2551,7 +2160,8 @@
 	else if ((pos = GetEmptyInventory(item->GetSize())) != -1) // ׷ ʴٸ ٸ κ丮  ã´.
 	{
 		LPITEM item2 = ITEM_MANAGER::instance().CreateItem(item->GetVnum(), 1);
-		if (item2 != nullptr)
+
+		if (NULL != item2)
 		{
 			item2->SetSocket(0, GetX());
 			item2->SetSocket(1, GetY());
@@ -2562,7 +2172,7 @@
 	}
 	else
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("ǰ   ϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ǰ   ϴ."));
 		return false;
 	}
 
@@ -2589,27 +2199,27 @@
 
 	switch (idx)
 	{
-		case 66:
-		case 216:
-			iEmpireByMapIndex = -1;
-			break;
-			// Ƿ決 ϶
-		case 301:
-		case 302:
-		case 303:
-		case 304:
-			if (GetLevel() < 90)
-			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("  Ѻ  ϴ."));
-				return;
-			}
-			else
-				break;
+	case 66:
+	case 216:
+		iEmpireByMapIndex = -1;
+		break;
+		// Ƿ決 ϶
+	case 301:
+	case 302:
+	case 303:
+	case 304:
+		if (GetLevel() < 90)
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  Ѻ  ϴ."));
+			return;
+		}
+		else
+			break;
 	}
 
 	if (iEmpireByMapIndex && GetEmpire() != iEmpireByMapIndex)
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ġ Ÿ  ־ ȯ  ϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ġ Ÿ  ־ ȯ  ϴ."));
 		item->SetSocket(0, 0);
 		item->SetSocket(1, 0);
 	}
@@ -2629,25 +2239,28 @@
 	case 0:
 	case 1:
 	case 2:
+#if defined(__MYSHOP_DECO__)
+		ChatPacket(CHAT_TYPE_COMMAND, "MyPrivShopOpen %d %d", 0, 1);
+#else
 		ChatPacket(CHAT_TYPE_COMMAND, "OpenPrivateShop");
+#endif
 		break;
 	default:
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("      ֽϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("      ֽϴ."));
 		break;
 	}
 }
 
 // MYSHOP_PRICE_LIST
-
-void CHARACTER::SendMyShopPriceListCmd(DWORD dwItemVnum, DWORD dwItemPrice
 #if defined(__CHEQUE_SYSTEM__)
-	, DWORD dwItemCheque
+void CHARACTER::SendMyShopPriceListCmd(DWORD dwItemVnum, DWORD dwItemPrice, DWORD dwItemPriceCheque)
+#else
+void CHARACTER::SendMyShopPriceListCmd(DWORD dwItemVnum, DWORD dwItemPrice)
 #endif
-)
 {
 	char szLine[256];
 #if defined(__CHEQUE_SYSTEM__)
-	snprintf(szLine, sizeof(szLine), "MyShopPriceList %u %u %u", dwItemVnum, dwItemPrice, dwItemCheque);
+	snprintf(szLine, sizeof(szLine), "MyShopPriceList %u %u %u", dwItemVnum, dwItemPrice, dwItemPriceCheque);
 #else
 	snprintf(szLine, sizeof(szLine), "MyShopPriceList %u %u", dwItemVnum, dwItemPrice);
 #endif
@@ -2668,7 +2281,7 @@
 	else
 	{
 		for (int idx = 0; idx < p->byCount; idx++)
-			SendMyShopPriceListCmd(pInfo[idx].dwVnum, pInfo[idx].dwPrice, pInfo[idx].dwCheque);
+			SendMyShopPriceListCmd(pInfo[idx].dwVnum, pInfo[idx].dwPrice, pInfo[idx].dwPriceCheque);
 	}
 #else
 	if (!p->byCount)
@@ -2700,8 +2313,418 @@
 		__OpenPrivateShop();
 	}
 }
+
+#if defined(__MYSHOP_DECO__)
+void CHARACTER::__OpenMyShopDeco()
+{
+	unsigned bodyPart = GetPart(PART_MAIN);
+	switch (bodyPart)
+	{
+	case 0:
+	case 1:
+	case 2:
+		ChatPacket(CHAT_TYPE_COMMAND, "OpenMyShopDecoWnd");
+		break;
+	default:
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("      ֽϴ."));
+		break;
+	}
+}
+
+void CHARACTER::UseDecoBundle(void)
+{
+	if (m_bNoOpenedShop)
+	{
+		DWORD dwPlayerID = GetPlayerID();
+		db_clientdesc->DBPacket(HEADER_GD_MYSHOP_PRICELIST_REQ, GetDesc()->GetHandle(), &dwPlayerID, sizeof(DWORD));
+		m_bNoOpenedShop = false;
+	}
+	else
+	{
+		__OpenMyShopDeco();
+	}
+}
+#endif
 // END_OF_MYSHOP_PRICE_LIST
 
+#if defined(__EXTENDED_BLEND_AFFECT__)
+bool CHARACTER::UseExtendedBlendAffect(LPITEM item, int affect_type, int apply_type, int apply_value, int apply_duration)
+{
+	apply_duration = apply_duration <= 0 ? INFINITE_AFFECT_DURATION : apply_duration;
+	bool bStatus = item->GetSocket(3);
+
+	if (FindAffect(affect_type, apply_type))
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+		return false;
+	}
+
+	if (FindAffect(AFFECT_EXP_BONUS_EURO_FREE, apply_type) || FindAffect(AFFECT_MALL, apply_type))
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+		return false;
+	}
+
+	switch (item->GetVnum())
+	{
+		// DEWS
+	case 50821:
+	case 950821:
+	{
+		if (FindAffect(AFFECT_BLEND_POTION_1))
+		{
+			if (!bStatus)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+				return false;
+			}
+			RemoveAffect(AFFECT_BLEND_POTION_1);
+			return false;
+		}
+		AddAffect(AFFECT_BLEND_POTION_1, apply_type, apply_value, 0, apply_duration, 0, true);
+	}
+	break;
+	case 50822:
+	case 950822:
+	{
+		if (FindAffect(AFFECT_BLEND_POTION_2))
+		{
+			if (!bStatus)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+				return false;
+			}
+			RemoveAffect(AFFECT_BLEND_POTION_2);
+			return false;
+		}
+		AddAffect(AFFECT_BLEND_POTION_2, apply_type, apply_value, 0, apply_duration, 0, true);
+	}
+	break;
+	case 50823:
+	case 950823:
+	{
+		if (FindAffect(AFFECT_BLEND_POTION_3))
+		{
+			if (!bStatus)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+				return false;
+			}
+			RemoveAffect(AFFECT_BLEND_POTION_3);
+			return false;
+		}
+		AddAffect(AFFECT_BLEND_POTION_3, apply_type, apply_value, 0, apply_duration, 0, true);
+	}
+	break;
+	case 50824:
+	case 950824:
+	{
+		if (FindAffect(AFFECT_BLEND_POTION_4))
+		{
+			if (!bStatus)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+				return false;
+			}
+			RemoveAffect(AFFECT_BLEND_POTION_4);
+			return false;
+		}
+		if (FindAffect(AFFECT_EXP_BONUS_EURO_FREE, POINT_RESIST_MAGIC))
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+			return false;
+		}
+
+		AddAffect(AFFECT_BLEND_POTION_4, apply_type, apply_value, 0, apply_duration, 0, true);
+	}
+	break;
+	case 50825:
+	case 950825:
+	{
+		if (FindAffect(AFFECT_BLEND_POTION_5))
+		{
+			if (!bStatus)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+				return false;
+			}
+			RemoveAffect(AFFECT_BLEND_POTION_5);
+			return false;
+		}
+		AddAffect(AFFECT_BLEND_POTION_5, apply_type, apply_value, 0, apply_duration, 0, true);
+	}
+	break;
+	case 50826:
+	case 950826:
+	{
+		if (FindAffect(AFFECT_BLEND_POTION_6))
+		{
+			if (!bStatus)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+				return false;
+			}
+			RemoveAffect(AFFECT_BLEND_POTION_6);
+			return false;
+		}
+		AddAffect(AFFECT_BLEND_POTION_6, apply_type, apply_value, 0, apply_duration, 0, true);
+	}
+	break;
+	// END_OF_DEWS
+
+	// ENERGY_CRISTAL
+	case 51002:
+	case 951002:
+	{
+		if (FindAffect(AFFECT_ENERGY))
+		{
+			if (!bStatus)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+				return false;
+			}
+			RemoveAffect(AFFECT_ENERGY);
+			return false;
+		}
+		AddAffect(AFFECT_ENERGY, apply_type, apply_value, 0, apply_duration, 0, true);
+	}
+	break;
+	// END_OF_ENERGY_CRISTAL
+
+	// DRAGON_GOD_MEDALS
+	case 939017:
+	{
+		if (FindAffect(AFFECT_DRAGON_GOD_1))
+		{
+			if (!bStatus)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+				return false;
+			}
+			RemoveAffect(AFFECT_DRAGON_GOD_1);
+			return false;
+		}
+
+		AddAffect(AFFECT_DRAGON_GOD_1, apply_type, apply_value, 0, apply_duration, 0, true);
+	}
+	break;
+	case 939018:
+	{
+		if (FindAffect(AFFECT_DRAGON_GOD_2))
+		{
+			if (!bStatus)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+				return false;
+			}
+			RemoveAffect(AFFECT_DRAGON_GOD_2);
+			return false;
+		}
+		AddAffect(AFFECT_DRAGON_GOD_2, apply_type, apply_value, 0, apply_duration, 0, true);
+	}
+	break;
+	case 939019:
+	{
+		if (FindAffect(AFFECT_DRAGON_GOD_3))
+		{
+			if (!bStatus)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+				return false;
+			}
+			RemoveAffect(AFFECT_DRAGON_GOD_3);
+			return false;
+		}
+		AddAffect(AFFECT_DRAGON_GOD_3, apply_type, apply_value, 0, apply_duration, 0, true);
+	}
+	break;
+	case 939020:
+	{
+		if (FindAffect(AFFECT_DRAGON_GOD_4))
+		{
+			if (!bStatus)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+				return false;
+			}
+			RemoveAffect(AFFECT_DRAGON_GOD_4);
+			return false;
+		}
+		AddAffect(AFFECT_DRAGON_GOD_4, apply_type, apply_value, 0, apply_duration, 0, true);
+	}
+	break;
+	// END_OF_DRAGON_GOD_MEDALS
+
+	// CRITICAL_AND_PENETRATION
+	case 939024:
+	{
+		if (FindAffect(AFFECT_CRITICAL))
+		{
+			if (!bStatus)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+				return false;
+			}
+			RemoveAffect(AFFECT_CRITICAL);
+			return false;
+		}
+		AddAffect(AFFECT_CRITICAL, apply_type, apply_value, 0, apply_duration, 0, true);
+	}
+	break;
+	case 939025:
+	{
+		if (FindAffect(AFFECT_PENETRATE))
+		{
+			if (!bStatus)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+				return false;
+			}
+			RemoveAffect(AFFECT_PENETRATE);
+			return false;
+		}
+		AddAffect(AFFECT_PENETRATE, apply_type, apply_value, 0, apply_duration, 0, true);
+	}
+	break;
+	// END_OF_CRITICAL_AND_PENETRATION
+
+	// ATTACK_AND_MOVE_SPEED
+	case 927209:
+	{
+		if (FindAffect(AFFECT_ATTACK_SPEED))
+		{
+			if (!bStatus)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+				return false;
+			}
+			RemoveAffect(AFFECT_ATTACK_SPEED);
+			return false;
+		}
+
+		if (FindAffect(AFFECT_ATT_SPEED))
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+			return false;
+		}
+
+		AddAffect(AFFECT_ATTACK_SPEED, apply_type, apply_value, 0, apply_duration, 0, true);
+	}
+	break;
+	case 927212:
+	{
+		if (FindAffect(AFFECT_MOVE_SPEED))
+		{
+			if (!bStatus)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+				return false;
+			}
+			RemoveAffect(AFFECT_MOVE_SPEED);
+			return false;
+		}
+
+		if (FindAffect(AFFECT_MOV_SPEED))
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+			return false;
+		}
+
+		AddAffect(AFFECT_MOVE_SPEED, apply_type, apply_value, 0, apply_duration, 0, true);
+	}
+	break;
+	// END_OF_ATTACK_AND_MOVE_SPEED
+	}
+
+	return true;
+}
+#endif
+
+#if defined(__BLEND_AFFECT__)
+bool CHARACTER::SetBlendAffect(LPITEM item)
+{
+	switch (item->GetVnum())
+	{
+		// DEWS
+	case 50821:
+	case 950821:
+		AddAffect(AFFECT_BLEND_POTION_1, APPLY_NONE, 0, AFF_NONE, item->GetSocket(2), 0, false, false);
+		break;
+
+	case 50822:
+	case 950822:
+		AddAffect(AFFECT_BLEND_POTION_2, APPLY_NONE, 0, AFF_NONE, item->GetSocket(2), 0, false, false);
+		break;
+
+	case 50823:
+	case 950823:
+		AddAffect(AFFECT_BLEND_POTION_3, APPLY_NONE, 0, AFF_NONE, item->GetSocket(2), 0, false, false);
+		break;
+
+	case 50824:
+	case 950824:
+		AddAffect(AFFECT_BLEND_POTION_4, APPLY_NONE, 0, AFF_NONE, item->GetSocket(2), 0, false, false);
+		break;
+
+	case 50825:
+	case 950825:
+		AddAffect(AFFECT_BLEND_POTION_3, APPLY_NONE, 0, AFF_NONE, item->GetSocket(2), 0, false, false);
+		break;
+
+	case 50826:
+	case 950826:
+		AddAffect(AFFECT_BLEND_POTION_6, APPLY_NONE, 0, AFF_NONE, item->GetSocket(2), 0, false, false);
+		break;
+		// END_OF_DEWS
+
+		// ENERGY_CRISTAL
+	case 51002:
+	case 951002:
+		AddAffect(AFFECT_ENERGY, APPLY_NONE, 0, AFF_NONE, item->GetSocket(2), 0, false, false);
+		break;
+		// END_OF_ENERGY_CRISTAL
+
+		// DRAGON_GOD_MEDALS
+	case 939017:
+		AddAffect(AFFECT_DRAGON_GOD_1, APPLY_NONE, 0, AFF_NONE, item->GetSocket(2), 0, false, false);
+		break;
+	case 939018:
+		AddAffect(AFFECT_DRAGON_GOD_2, APPLY_NONE, 0, AFF_NONE, item->GetSocket(2), 0, false, false);
+		break;
+	case 939019:
+		AddAffect(AFFECT_DRAGON_GOD_3, APPLY_NONE, 0, AFF_NONE, item->GetSocket(2), 0, false, false);
+		break;
+	case 939020:
+		AddAffect(AFFECT_DRAGON_GOD_4, APPLY_NONE, 0, AFF_NONE, item->GetSocket(2), 0, false, false);
+		break;
+		// END_OF_DRAGON_GOD_MEDALS
+
+		// CRITICAL_AND_PENETRATION
+	case 939024:
+		AddAffect(AFFECT_CRITICAL, APPLY_NONE, 0, AFF_NONE, item->GetSocket(2), 0, false, false);
+		break;
+	case 939025:
+		AddAffect(AFFECT_PENETRATE, APPLY_NONE, 0, AFF_NONE, item->GetSocket(2), 0, false, false);
+		break;
+		// END_OF_CRITICAL_AND_PENETRATION
+
+		// ATTACK_AND_MOVE_SPEED
+	case 927209:
+		AddAffect(AFFECT_ATTACK_SPEED, APPLY_NONE, 0, AFF_NONE, item->GetSocket(2), 0, false, false);
+		break;
+	case 927212:
+		AddAffect(AFFECT_MOVE_SPEED, APPLY_NONE, 0, AFF_NONE, item->GetSocket(2), 0, false, false);
+		break;
+		// END_OF_ATTACK_AND_MOVE_SPEED
+
+	default:
+		return false;
+	}
+
+	return true;
+}
+#endif
+
 int CalculateConsume(LPCHARACTER ch)
 {
 	static const int WARP_NEED_LIFE_PERCENT = 30;
@@ -2715,7 +2738,7 @@
 		const int needLife = ch->GetMaxHP() * needPercent / 100;
 		if (curLife < needLife)
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("   ڶ   ϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("   ڶ   ϴ."));
 			return -1;
 		}
 
@@ -2743,7 +2766,7 @@
 
 	if (curSP < needSP)
 	{
-		lpChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ŷ  ڶ   ϴ."));
+		lpChar->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ŷ  ڶ   ϴ."));
 		return -1;
 	}
 
@@ -2764,35 +2787,21 @@
 
 		switch (item->GetProto()->aLimits[i].bType)
 		{
-			case LIMIT_LEVEL:
+		case LIMIT_LEVEL:
+			if (GetLevel() < limitValue)
 			{
-				if (GetLevel() < limitValue)
-				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("  Ѻ  ϴ."));
-					return false;
-				}
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  Ѻ  ϴ."));
+				return false;
 			}
 			break;
 
-#if defined(__CONQUEROR_LEVEL__)
-			case LIMIT_NEWWORLD_LEVEL:
-			{
-				if (GetConquerorLevel() < limitValue)
-				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("  Ѻ  ϴ."));
-					return false;
-				}
-			}
+		case LIMIT_REAL_TIME_START_FIRST_USE:
+			iLimitRealtimeStartFirstUseFlagIndex = i;
 			break;
-#endif
 
-			case LIMIT_REAL_TIME_START_FIRST_USE:
-				iLimitRealtimeStartFirstUseFlagIndex = i;
-				break;
-
-			case LIMIT_TIMER_BASED_ON_WEAR:
-				iLimitTimerBasedOnWearFlagIndex = i;
-				break;
+		case LIMIT_TIMER_BASED_ON_WEAR:
+			iLimitTimerBasedOnWearFlagIndex = i;
+			break;
 		}
 	}
 
@@ -2801,16 +2810,35 @@
 		sys_log(0, "USE_ITEM %s, Inven %d, Cell %d, ItemType %d, SubType %d", item->GetName(), bDestInven, wDestCell, item->GetType(), item->GetSubType());
 	}
 
-	if (CArenaManager::instance().IsLimitedItem(GetMapIndex(), item->GetVnum()))
+	if (CArenaManager::instance().IsLimitedItem(GetMapIndex(), item->GetVnum()) == true)
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ߿ ̿   ǰԴϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ߿ ̿   ǰԴϴ."));
 		return false;
 	}
-
+	
 #ifdef __GROWTH_PET_SYSTEM__
 	if (item->GetType() == ITEM_PET && item->GetSubType() == PET_BAG)
 		iLimitRealtimeStartFirstUseFlagIndex = -1;
 #endif
+#if defined(__MOUNT_COSTUME_SYSTEM__)
+	if (IS_BLOCKED_MOUNT_SUMMON_MAP(GetMapIndex()))
+	{
+		if (item->IsCostumeMount() || item->IsPet())
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot summon your mount/pet right now."));
+			return false;
+		}
+	}
+
+	if (IS_BLOCKED_MOUNT_DUNGEON_MAP(GetMapIndex()))
+	{
+		if (item->IsCostumeMount() || item->IsPet())
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot summon your mount/pet right now."));
+			return false;
+		}
+	}
+#endif
 
 	//    ĺʹ  ʾƵ ð Ǵ  ó.
 	if (-1 != iLimitRealtimeStartFirstUseFlagIndex)
@@ -2832,23 +2860,6 @@
 			item->SetSocket(1, item->GetSocket(1) + 1);
 	}
 
-#if defined(__MAILBOX__)
-	if (item->GetVnum() == ITEM_MOBILE_MAILBOX)
-	{
-		CMailBox::Open(this);
-		return true;
-	}
-#endif
-
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	if (item->GetVnum() == ITEM_EXTEND_INVEN_TICKET ||
-		item->GetVnum() == ITEM_EXTEND_INVEN_TICKET_MALL)
-	{
-		ExtendInvenRequest();
-		return true;
-	}
-#endif
-
 	switch (item->GetType())
 	{
 #ifdef __GROWTH_PET_SYSTEM__
@@ -2856,31 +2867,6 @@
 			{
 				switch (item->GetSubType())
 				{
-					case PET_PAY:
-					{
-						if (GetArena() != NULL || IsObserverMode() == true)
-						{
-							if (item->GetVnum() == 50051 || item->GetVnum() == 50052 || item->GetVnum() == 50053)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ߿ ̿   ǰԴϴ."));
-								return false;
-							}
-						}
-
-						if (!IS_SET(item->GetFlag(), ITEM_FLAG_QUEST_USE | ITEM_FLAG_QUEST_USE_MULTIPLE) || item->GetSubType() == PET_PAY)
-						{
-							if (item->GetSIGVnum() == 0)
-							{
-								quest::CQuestManager::instance().UseItem(GetPlayerID(), item, false);
-							}
-							else
-							{
-								quest::CQuestManager::instance().SIGUse(GetPlayerID(), item->GetSIGVnum(), item, false);
-							}
-						}
-						break;
-					}
-					
 					case PET_UPBRINGING:
 					{
 						LPGROWTH_PET pPet = GetGrowthPet(item->GetSocket(2));
@@ -2953,7 +2939,6 @@
 									item->SetSocket(0, currentTime + item->GetLimitValue(0));
 									item->SetSocket(1, time(0));
 									item->SetSocket(2, pPet->GetPetID());
-									item->SetSocket(3, pPet->GetPetType());
 									item->StartRealTimeExpireEvent();
 
 									ITEM_MANAGER::instance().RemoveItem(item2, "REMOVE (UPBRINGING-BAG TRANSFER)");
@@ -2978,7 +2963,6 @@
 
 									item2->SetSocket(0, currentTime + item2->GetLimitValue(0));
 									item2->StartRealTimeExpireEvent();
-									item->SetSocket(3, pPet->GetPetType());
 
 									ITEM_MANAGER::instance().RemoveItem(item, "REMOVE (BAG-BAG TRANSFER)");
 								} break;
@@ -3015,7 +2999,6 @@
 							pUpBringingItem->SetSocket(0, dwPetDuration);
 							pUpBringingItem->SetSocket(1, petTable.lMaxTime);
 							pUpBringingItem->SetSocket(2, pUpBringingItem->GetID());
-							pUpBringingItem->SetSocket(3, item->GetSocket(3));
 
 							pPet->SetSummonItem(pUpBringingItem);
 							pPet->Save();
@@ -3030,4616 +3013,4260 @@
 
 			} break;
 #endif
-		case ITEM_HAIR:
-			return ItemProcess_Hair(item, wDestCell);
+	case ITEM_HAIR:
+		return ItemProcess_Hair(item, wDestCell);
 
-		case ITEM_POLYMORPH:
-			return ItemProcess_Polymorph(item);
+	case ITEM_POLYMORPH:
+		return ItemProcess_Polymorph(item);
 
-		case ITEM_QUEST:
+	case ITEM_QUEST:
+		if (GetArena() != NULL || IsObserverMode() == true)
 		{
-			if (GetArena() != NULL || IsObserverMode() == true)
+			if (item->GetVnum() == 50051 || item->GetVnum() == 50052 || item->GetVnum() == 50053)
 			{
-				if (item->GetVnum() == ITEM_VNUM_HORSE_PICTURE || item->GetVnum() == ITEM_VNUM_ARMED_HORSE_BOOK || item->GetVnum() == ITEM_VNUM_MILITARY_HORSE_BOOK)
-				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ߿ ̿   ǰԴϴ."));
-					return false;
-				}
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ߿ ̿   ǰԴϴ."));
+				return false;
 			}
+		}
 
-			if (!IS_SET(item->GetFlag(), ITEM_FLAG_QUEST_USE | ITEM_FLAG_QUEST_USE_MULTIPLE))
+		if (!IS_SET(item->GetFlag(), ITEM_FLAG_QUEST_USE | ITEM_FLAG_QUEST_USE_MULTIPLE) || item->GetSubType() == PET_PAY)
+		{
+			if (item->GetSIGVnum() == 0)
 			{
-				if (item->GetSIGVnum() == 0)
-				{
-					quest::CQuestManager::instance().UseItem(GetPlayerID(), item, false);
-				}
-				else
-				{
-					quest::CQuestManager::instance().SIGUse(GetPlayerID(), item->GetSIGVnum(), item, false);
-				}
+				quest::CQuestManager::instance().UseItem(GetPlayerID(), item, false);
+			}
+			else
+			{
+				quest::CQuestManager::instance().SIGUse(GetPlayerID(), item->GetSIGVnum(), item, false);
 			}
 		}
 		break;
 
-		case ITEM_CAMPFIRE:
-		{
-			float fx, fy;
-			GetDeltaByDegree(GetRotation(), 100.0f, &fx, &fy);
+	case ITEM_CAMPFIRE:
+	{
+		float fx, fy;
+		GetDeltaByDegree(GetRotation(), 100.0f, &fx, &fy);
 
-			LPSECTREE tree = SECTREE_MANAGER::instance().Get(GetMapIndex(), (long)(GetX() + fx), (long)(GetY() + fy));
+		LPSECTREE tree = SECTREE_MANAGER::instance().Get(GetMapIndex(), (long)(GetX() + fx), (long)(GetY() + fy));
 
-			if (!tree)
-			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("ں ǿ   Դϴ."));
-				return false;
-			}
+		if (!tree)
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ں ǿ   Դϴ."));
+			return false;
+		}
 
-			if (tree->IsAttr((long)(GetX() + fx), (long)(GetY() + fy), ATTR_WATER))
-			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ӿ ں ǿ  ϴ."));
-				return false;
-			}
+		if (tree->IsAttr((long)(GetX() + fx), (long)(GetY() + fy), ATTR_WATER))
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ӿ ں ǿ  ϴ."));
+			return false;
+		}
 
-			LPCHARACTER campfire = CHARACTER_MANAGER::instance().SpawnMob(fishing::CAMPFIRE_MOB, GetMapIndex(), (long)(GetX() + fx), (long)(GetY() + fy), 0, false, number(0, 359));
+		LPCHARACTER campfire = CHARACTER_MANAGER::instance().SpawnMob(fishing::CAMPFIRE_MOB, GetMapIndex(), (long)(GetX() + fx), (long)(GetY() + fy), 0, false, number(0, 359));
 
-			char_event_info* info = AllocEventInfo<char_event_info>();
+		char_event_info* info = AllocEventInfo<char_event_info>();
 
-			info->ch = campfire;
+		info->ch = campfire;
 
-			campfire->m_pkMiningEvent = event_create(kill_campfire_event, info, PASSES_PER_SEC(40));
+		campfire->m_pkMiningEvent = event_create(kill_campfire_event, info, PASSES_PER_SEC(40));
 
-			item->SetCount(item->GetCount() - 1);
-		}
-		break;
+		item->SetCount(item->GetCount() - 1);
+	}
+	break;
 
-		case ITEM_UNIQUE:
+	case ITEM_UNIQUE:
+	{
+		switch (item->GetSubType())
 		{
-			switch (item->GetSubType())
+		case USE_ABILITY_UP:
+		{
+			switch (item->GetValue(0))
 			{
-				case USE_ABILITY_UP:
-				{
-					if (FindAffect(AFFECT_BLEND, item->GetValue(0)))
-					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING("̹ ȿ ɷ ֽϴ."));
-						return false;
-					}
+			case APPLY_MOV_SPEED:
+				AddAffect(AFFECT_UNIQUE_ABILITY, POINT_MOV_SPEED, item->GetValue(2), AFF_MOV_SPEED_POTION, item->GetValue(1), 0, true, true);
+				break;
 
-					switch (item->GetValue(0))
-					{
-						case APPLY_MOV_SPEED:
-							AddAffect(AFFECT_UNIQUE_ABILITY, POINT_MOV_SPEED,
-								item->GetValue(2), AFF_MOV_SPEED_POTION, item->GetValue(1), 0, true, true);
-							break;
+			case APPLY_ATT_SPEED:
+				AddAffect(AFFECT_UNIQUE_ABILITY, POINT_ATT_SPEED, item->GetValue(2), AFF_ATT_SPEED_POTION, item->GetValue(1), 0, true, true);
+				break;
 
-						case APPLY_ATT_SPEED:
-							AddAffect(AFFECT_UNIQUE_ABILITY, POINT_ATT_SPEED,
-								item->GetValue(2), AFF_ATT_SPEED_POTION, item->GetValue(1), 0, true, true);
-							break;
+			case APPLY_STR:
+				AddAffect(AFFECT_UNIQUE_ABILITY, POINT_ST, item->GetValue(2), 0, item->GetValue(1), 0, true, true);
+				break;
 
-						case APPLY_STR:
-							AddAffect(AFFECT_UNIQUE_ABILITY, POINT_ST,
-								item->GetValue(2), 0, item->GetValue(1), 0, true, true);
-							break;
+			case APPLY_DEX:
+				AddAffect(AFFECT_UNIQUE_ABILITY, POINT_DX, item->GetValue(2), 0, item->GetValue(1), 0, true, true);
+				break;
 
-						case APPLY_DEX:
-							AddAffect(AFFECT_UNIQUE_ABILITY, POINT_DX,
-								item->GetValue(2), 0, item->GetValue(1), 0, true, true);
-							break;
+			case APPLY_CON:
+				AddAffect(AFFECT_UNIQUE_ABILITY, POINT_HT, item->GetValue(2), 0, item->GetValue(1), 0, true, true);
+				break;
 
-						case APPLY_CON:
-							AddAffect(AFFECT_UNIQUE_ABILITY, POINT_HT,
-								item->GetValue(2), 0, item->GetValue(1), 0, true, true);
-							break;
+			case APPLY_INT:
+				AddAffect(AFFECT_UNIQUE_ABILITY, POINT_IQ, item->GetValue(2), 0, item->GetValue(1), 0, true, true);
+				break;
 
-						case APPLY_INT:
-							AddAffect(AFFECT_UNIQUE_ABILITY, POINT_IQ,
-								item->GetValue(2), 0, item->GetValue(1), 0, true, true);
-							break;
+			case APPLY_CAST_SPEED:
+				AddAffect(AFFECT_UNIQUE_ABILITY, POINT_CASTING_SPEED, item->GetValue(2), 0, item->GetValue(1), 0, true, true);
+				break;
 
-						case APPLY_CAST_SPEED:
-							AddAffect(AFFECT_UNIQUE_ABILITY, POINT_CASTING_SPEED,
-								item->GetValue(2), 0, item->GetValue(1), 0, true, true);
-							break;
+			case APPLY_RESIST_MAGIC:
+				AddAffect(AFFECT_UNIQUE_ABILITY, POINT_RESIST_MAGIC, item->GetValue(2), 0, item->GetValue(1), 0, true, true);
+				break;
 
-						case APPLY_RESIST_MAGIC:
-							AddAffect(AFFECT_UNIQUE_ABILITY, POINT_RESIST_MAGIC,
-								item->GetValue(2), 0, item->GetValue(1), 0, true, true);
-							break;
+			case APPLY_ATT_GRADE_BONUS:
+				AddAffect(AFFECT_UNIQUE_ABILITY, POINT_ATT_GRADE_BONUS,
+					item->GetValue(2), 0, item->GetValue(1), 0, true, true);
+				break;
 
-						case APPLY_ATT_GRADE_BONUS:
-							AddAffect(AFFECT_UNIQUE_ABILITY, POINT_ATT_GRADE_BONUS,
-								item->GetValue(2), 0, item->GetValue(1), 0, true, true);
-							break;
+			case APPLY_DEF_GRADE_BONUS:
+				AddAffect(AFFECT_UNIQUE_ABILITY, POINT_DEF_GRADE_BONUS,
+					item->GetValue(2), 0, item->GetValue(1), 0, true, true);
+				break;
+			}
+		}
 
-						case APPLY_DEF_GRADE_BONUS:
-							AddAffect(AFFECT_UNIQUE_ABILITY, POINT_DEF_GRADE_BONUS,
-								item->GetValue(2), 0, item->GetValue(1), 0, true, true);
-							break;
-					}
+		if (GetDungeon())
+			GetDungeon()->UsePotion(this);
 
-					if (GetDungeon())
-						GetDungeon()->UsePotion(this);
+		if (GetWarMap())
+			GetWarMap()->UsePotion(this, item);
 
-					if (GetWarMap())
-						GetWarMap()->UsePotion(this, item);
+		item->SetCount(item->GetCount() - 1);
+		break;
 
-					item->SetCount(item->GetCount() - 1);
-				}
-				break;
+		default:
+		{
+			if (item->GetSubType() == USE_SPECIAL)
+			{
+				sys_log(0, "ITEM_UNIQUE: USE_SPECIAL %u", item->GetVnum());
 
-				case UNIQUE_BUNDLE:
+				switch (item->GetVnum())
 				{
-					if (IsRiding())
-					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot use this bundle whilst riding."));
-						return false;
-					}
-
-					if (GetWear(ARMOR_BODY))
-					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING("      ֽϴ."));
-						return false;
-					}
+#if defined(__MYSHOP_DECO__)
+				case KASHMIR_BUNDLE:
+				{
+					if (IS_BOTARYABLE_ZONE(GetMapIndex()) == true)
+						__OpenMyShopDeco();
+					else
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("     Դϴ"));
+				}
+				break;
+#endif
 
-					switch (item->GetVnum())
+				case 71049: // ܺ
+					if (LC_IsYMIR() == true || LC_IsKorea() == true)
 					{
-						case 71049: // ܺ
+						if (IS_BOTARYABLE_ZONE(GetMapIndex()) == true)
 						{
-							if (LC_IsYMIR() == true || LC_IsKorea() == true)
-							{
-								if (IS_BOTARYABLE_ZONE(GetMapIndex()) == true)
-								{
-									UseSilkBotary();
-								}
-								else
-								{
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING("     Դϴ"));
-								}
-							}
-							else
-							{
-								UseSilkBotary();
-							}
+							UseSilkBotary();
+						}
+						else
+						{
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("     Դϴ"));
 						}
-						break;
-
-#if defined(__MYSHOP_DECO__)
-						case ITEM_KASHMIR_BUNDLE:
-							ChatPacket(CHAT_TYPE_COMMAND, "OpenMyShopDecoWnd");
-							break;
-#endif
 					}
-				}
-				break;
-
-				default:
-				{
-					if (!item->IsEquipped())
-						EquipItem(item);
 					else
-						UnequipItem(item);
+					{
+						UseSilkBotary();
+					}
+					break;
 				}
-				break;
 			}
-		}
-		break;
-
-		case ITEM_COSTUME:
-		case ITEM_WEAPON:
-		case ITEM_ARMOR:
-		case ITEM_ROD:
-		case ITEM_RING: // ű  
-		case ITEM_BELT: // ű Ʈ 
-		case ITEM_PICK: // MINING
-		{
-			if (!item->IsEquipped())
-				EquipItem(item);
 			else
-				UnequipItem(item);
+			{
+				if (!item->IsEquipped())
+					EquipItem(item);
+				else
+					UnequipItem(item);
+			}
 		}
 		break;
+		}
+	}
+	break;
 
+	case ITEM_COSTUME:
+#if defined(__MOUNT_COSTUME_SYSTEM__)
+		if (!item->IsEquipped())
+			EquipItem(item);
+		else
+			UnequipItem(item, true);
+		break;
+#endif
+	case ITEM_WEAPON:
+	case ITEM_ARMOR:
+	case ITEM_ROD:
+	case ITEM_RING: // ű  
+	case ITEM_BELT: // ű Ʈ 
+		// MINING
+	case ITEM_PICK:
+		// END_OF_MINING
+		if (!item->IsEquipped())
+			EquipItem(item);
+		else
+			UnequipItem(item);
+		break;
 		//   ȥ   .
 		//  Ŭ, ȥ Ͽ item use Ŷ   .
 		// ȥ  item move Ŷ Ѵ.
 		//  ȥ Ѵ.
-#if defined(__DRAGON_SOUL_SYSTEM__)
-		case ITEM_DS:
-		{
-			if (!item->IsEquipped())
-				return false;
-
-			return DSManager::instance().PullOut(this, NPOS, item);
-		}
-
-		case ITEM_SPECIAL_DS:
-		{
-			if (!item->IsEquipped())
-				EquipItem(item);
-			else
-				UnequipItem(item);
-		}
+	case ITEM_DS:
+	{
+		if (!item->IsEquipped())
+			return false;
+		return DSManager::instance().PullOut(this, NPOS, item);
 		break;
-#endif
-
-		case ITEM_FISH:
-		{
-			if (CArenaManager::instance().IsArenaMap(GetMapIndex()))
-			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ߿ ̿   ǰԴϴ."));
-				return false;
-			}
-
-			if (item->GetSubType() == FISH_ALIVE)
-				fishing::UseFish(this, item);
-		}
+	}
+	case ITEM_SPECIAL_DS:
+		if (!item->IsEquipped())
+			EquipItem(item);
+		else
+			UnequipItem(item);
 		break;
 
-		case ITEM_TREASURE_BOX:
+	case ITEM_FISH:
+	{
+		if (CArenaManager::instance().IsArenaMap(GetMapIndex()) == true)
 		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ߿ ̿   ǰԴϴ."));
 			return false;
-			//ChatPacket(CHAT_TYPE_TALKING, LC_STRING("  ־  ʴ° . 踦 غ."));
 		}
-		break;
 
-		case ITEM_TREASURE_KEY:
-		{
-			LPITEM item2;
+		if (item->GetSubType() == FISH_ALIVE)
+			fishing::UseFish(this, item);
+	}
+	break;
 
-			if (!GetItem(DestCell) || !(item2 = GetItem(DestCell)))
-				return false;
+	case ITEM_TREASURE_BOX:
+	{
+		return false;
+		//ChatPacket(CHAT_TYPE_TALKING, LC_TEXT("  ־  ʴ° . 踦 غ."));
+	}
+	break;
 
-			if (item2->IsExchanging())
-				return false;
+	case ITEM_TREASURE_KEY:
+	{
+		LPITEM item2;
 
-			if (item2->GetType() != ITEM_TREASURE_BOX)
-			{
-				ChatPacket(CHAT_TYPE_TALKING, LC_STRING("   ƴѰ ."));
-				return false;
-			}
+		if (!GetItem(DestCell) || !(item2 = GetItem(DestCell)))
+			return false;
 
-			if (item->GetValue(0) == item2->GetValue(0))
-			{
-				//ChatPacket(CHAT_TYPE_TALKING, LC_STRING("   ִ κ  ȵǾϴ."));
+		if (item2->IsExchanging())
+			return false;
 
-				if (GiveItemFromSpecialItemGroup(item2->GetVnum()))
-				{
-					item->SetCount(item->GetCount() - 1);
-					item2->SetCount(item2->GetCount() - 1);
-				}
-				else
-				{
-					ChatPacket(CHAT_TYPE_TALKING, LC_STRING("谡  ʴ  ."));
-					return false;
-				}
-			}
-			else
-			{
-				ChatPacket(CHAT_TYPE_TALKING, LC_STRING("谡  ʴ  ."));
-				return false;
-			}
+		if (item2->GetType() != ITEM_TREASURE_BOX)
+		{
+			ChatPacket(CHAT_TYPE_TALKING, LC_TEXT("   ƴѰ ."));
+			return false;
 		}
-		break;
 
-		case ITEM_GIFTBOX:
+		if (item->GetValue(0) == item2->GetValue(0))
 		{
-			DWORD dwBoxVnum = item->GetVnum();
+			//ChatPacket(CHAT_TYPE_TALKING, LC_TEXT("   ִ κ  ȵǾϴ."));
+			DWORD dwBoxVnum = item2->GetVnum();
+			std::vector <DWORD> dwVnums;
+			std::vector <DWORD> dwCounts;
+			std::vector <LPITEM> item_gets(0);
+			int count = 0;
 
-			if (dwBoxVnum == 50033 && LC_IsYMIR()) // ˼ 
+			if (GiveItemFromSpecialItemGroup(dwBoxVnum, dwVnums, dwCounts, item_gets, count))
 			{
-				if (GetLevel() < 15)
-				{
-					ChatPacket(CHAT_TYPE_INFO, "15 Ͽ   ϴ.");
-					return false;
-				}
-			}
+				ITEM_MANAGER::instance().RemoveItem(item);
+				ITEM_MANAGER::instance().RemoveItem(item2);
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
-			if ((dwBoxVnum > 51500 && dwBoxVnum < 52000) || (dwBoxVnum >= 50255 && dwBoxVnum <= 50260)) // ȥ
-			{
-				if (!(this->DragonSoul_IsQualified()))
+				for (int i = 0; i < count; i++)
 				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȥ Ʈ Ϸϼž մϴ."));
-					return false;
+					switch (dwVnums[i])
+					{
+					case CSpecialItemGroup::GOLD:
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" %d  ȹ߽ϴ."), dwCounts[i]);
+						break;
+					case CSpecialItemGroup::EXP:
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ  ź  ɴϴ."));
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%d ġ ȹ߽ϴ."), dwCounts[i]);
+						break;
+					case CSpecialItemGroup::MOB:
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ Ͱ Ÿϴ!"));
+						break;
+					case CSpecialItemGroup::SLOW:
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ   ⸦ ̸ ̴ ӵ ϴ!"));
+						break;
+					case CSpecialItemGroup::DRAIN_HP:
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڰ ڱ Ͽϴ!  ߽ϴ."));
+						break;
+					case CSpecialItemGroup::POISON:
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ   ⸦ ̸  ¸ ϴ!"));
+						break;
+					case CSpecialItemGroup::BLEEDING:
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ   ⸦ ̸  ¸ ϴ!"));
+						break;
+					case CSpecialItemGroup::MOB_GROUP:
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ Ͱ Ÿϴ!"));
+						break;
+					default:
+						if (item_gets[i])
+						{
+							if (dwCounts[i] > 1)
+								ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ %s  %d  Խϴ."), item_gets[i]->GetLocaleName(), dwCounts[i]);
+							else
+								ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ %s  Խϴ."), item_gets[i]->GetLocaleName());
+						}
+					}
 				}
 			}
-#endif
-
-			if (!GiveItemFromSpecialItemGroup(dwBoxVnum))
+			else
 			{
-				ChatPacket(CHAT_TYPE_TALKING, LC_STRING("ƹ͵   ϴ."));
+				ChatPacket(CHAT_TYPE_TALKING, LC_TEXT("谡  ʴ  ."));
 				return false;
 			}
-
-			item->SetCount(item->GetCount() - 1);
 		}
-		break;
-
-		case ITEM_SKILLFORGET:
+		else
 		{
-			if (!item->GetSocket(0))
-			{
-				ITEM_MANAGER::instance().RemoveItem(item);
-				return false;
-			}
-
-			DWORD dwVnum = item->GetSocket(0);
-
-			if (SkillLevelDown(dwVnum))
-			{
-				ITEM_MANAGER::instance().RemoveItem(item);
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("ų  µ Ͽϴ."));
-			}
-			else
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("ų    ϴ."));
+			ChatPacket(CHAT_TYPE_TALKING, LC_TEXT("谡  ʴ  ."));
+			return false;
 		}
-		break;
+	}
+	break;
 
-		case ITEM_SKILLBOOK:
+	case ITEM_GIFTBOX:
+	{
+		DWORD dwBoxVnum = item->GetVnum();
+		std::vector <DWORD> dwVnums;
+		std::vector <DWORD> dwCounts;
+		std::vector <LPITEM> item_gets(0);
+		int count = 0;
+
+		if (dwBoxVnum == 50033 && LC_IsYMIR()) // ˼ 
 		{
-			if (IsPolymorphed())
+			if (GetLevel() < 15)
 			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("߿ å  ϴ."));
+				ChatPacket(CHAT_TYPE_INFO, "15 Ͽ   ϴ.");
 				return false;
 			}
+		}
 
-			DWORD dwVnum = 0;
-
-			if (item->GetVnum() == ITEM_SKILLBOOK_VNUM)
-			{
-				dwVnum = item->GetSocket(0);
-			}
-			else
-			{
-				// ο ü value 0  ų ȣ Ƿ װ .
-				dwVnum = item->GetValue(0);
-			}
-
-			if (0 == dwVnum)
+		if ((dwBoxVnum > 51500 && dwBoxVnum < 52000) || (dwBoxVnum >= 50255 && dwBoxVnum <= 50260))	// ȥ
+		{
+			if (!(this->DragonSoul_IsQualified()))
 			{
-				ITEM_MANAGER::instance().RemoveItem(item);
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ȥ Ʈ Ϸϼž մϴ."));
 				return false;
 			}
-
-			if (true == LearnSkillByBook(dwVnum))
-			{
-				item->SetCount(item->GetCount() - 1);
-
-				int iReadDelay = number(SKILLBOOK_DELAY_MIN, SKILLBOOK_DELAY_MAX);
-
-				if (distribution_test_server)
-					iReadDelay /= 3;
-
-				// ѱ  쿡 ð 24ð 
-				if (LC_IsKorea())
-					iReadDelay = 86400;
-
-				SetSkillNextReadTime(dwVnum, get_global_time() + iReadDelay);
-			}
 		}
-		break;
 
-		case ITEM_USE:
+		if (GiveItemFromSpecialItemGroup(dwBoxVnum, dwVnums, dwCounts, item_gets, count))
 		{
-			if (item->GetVnum() > 50800 && item->GetVnum() <= 50820)
-			{
-				if (test_server)
-					sys_log(0, "ADD addtional effect : vnum(%d) subtype(%d)", item->GetOriginalVnum(), item->GetSubType());
-
-				int affect_type = AFFECT_EXP_BONUS_EURO_FREE;
-				int apply_type = aApplyInfo[item->GetValue(0)].wPointType;
-				int apply_value = item->GetValue(2);
-				int apply_duration = item->GetValue(1);
+			item->SetCount(item->GetCount() - 1);
 
-				switch (item->GetSubType())
+			for (int i = 0; i < count; i++)
+			{
+				switch (dwVnums[i])
 				{
-					case USE_ABILITY_UP:
-					{
-						if (FindAffect(affect_type, apply_type))
-						{
-							ChatPacket(CHAT_TYPE_INFO, LC_STRING("̹ ȿ ɷ ֽϴ."));
-							return false;
-						}
-
-						if (FindAffect(AFFECT_BLEND, item->GetValue(0)))
-						{
-							ChatPacket(CHAT_TYPE_INFO, LC_STRING("̹ ȿ ɷ ֽϴ."));
-							return false;
-						}
-
-						switch (item->GetValue(0))
-						{
-							case APPLY_MOV_SPEED:
-							{
-								AddAffect(affect_type, apply_type, apply_value, AFF_MOV_SPEED_POTION, apply_duration, 0, true, true);
-								break;
-							}
-
-							case APPLY_ATT_SPEED:
-							{
-								AddAffect(affect_type, apply_type, apply_value, AFF_ATT_SPEED_POTION, apply_duration, 0, true, true);
-								break;
-							}
-
-							case APPLY_STR:
-							case APPLY_DEX:
-							case APPLY_CON:
-							case APPLY_INT:
-							case APPLY_CAST_SPEED:
-							case APPLY_CRITICAL_PCT:
-							case APPLY_PENETRATE_PCT:
-							case APPLY_RESIST_MAGIC:
-							case APPLY_ATT_GRADE_BONUS:
-							case APPLY_DEF_GRADE_BONUS:
-#if defined(__CONQUEROR_LEVEL__)
-							case APPLY_SUNGMA_STR:
-							case APPLY_SUNGMA_HP:
-							case APPLY_SUNGMA_MOVE:
-							case APPLY_SUNGMA_IMMUNE:
-#endif
-							{
-								AddAffect(affect_type, apply_type, apply_value, 0, apply_duration, 0, true, true);
-								break;
-							}
-
-						}
-
-						if (GetDungeon())
-							GetDungeon()->UsePotion(this);
-
-						if (GetWarMap())
-							GetWarMap()->UsePotion(this, item);
-
-						item->SetCount(item->GetCount() - 1);
-					}
+				case CSpecialItemGroup::GOLD:
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" %d  ȹ߽ϴ."), dwCounts[i]);
 					break;
-
-					case USE_AFFECT:
+				case CSpecialItemGroup::EXP:
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ  ź  ɴϴ."));
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%d ġ ȹ߽ϴ."), dwCounts[i]);
+					break;
+				case CSpecialItemGroup::MOB:
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ Ͱ Ÿϴ!"));
+					break;
+				case CSpecialItemGroup::SLOW:
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ   ⸦ ̸ ̴ ӵ ϴ!"));
+					break;
+				case CSpecialItemGroup::DRAIN_HP:
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڰ ڱ Ͽϴ!  ߽ϴ."));
+					break;
+				case CSpecialItemGroup::POISON:
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ   ⸦ ̸  ¸ ϴ!"));
+					break;
+				case CSpecialItemGroup::BLEEDING:
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ   ⸦ ̸  ¸ ϴ!"));
+					break;
+				case CSpecialItemGroup::MOB_GROUP:
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ Ͱ Ÿϴ!"));
+					break;
+				default:
+					if (item_gets[i])
 					{
-						if (FindAffect(AFFECT_EXP_BONUS_EURO_FREE, aApplyInfo[item->GetValue(1)].wPointType))
-						{
-							ChatPacket(CHAT_TYPE_INFO, LC_STRING("̹ ȿ ɷ ֽϴ."));
-						}
+						if (dwCounts[i] > 1)
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ %s  %d  Խϴ."), item_gets[i]->GetLocaleName(), dwCounts[i]);
 						else
-						{
-							AddAffect(AFFECT_EXP_BONUS_EURO_FREE, aApplyInfo[item->GetValue(1)].wPointType, item->GetValue(2), 0, item->GetValue(3), 0, false, true);
-							item->SetCount(item->GetCount() - 1);
-						}
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ %s  Խϴ."), item_gets[i]->GetLocaleName());
 					}
-					break;
+				}
+			}
+		}
+		else
+		{
+			ChatPacket(CHAT_TYPE_TALKING, LC_TEXT("ƹ͵   ϴ."));
+			return false;
+		}
+	}
+	break;
 
-					case USE_POTION_NODELAY:
-					{
-						if (CArenaManager::instance().IsArenaMap(GetMapIndex()))
-						{
-							if (quest::CQuestManager::instance().GetEventFlag("arena_potion_limit") > 0)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("忡 Ͻ  ϴ."));
-								return false;
-							}
+	case ITEM_SKILLFORGET:
+	{
+		if (!item->GetSocket(0))
+		{
+			ITEM_MANAGER::instance().RemoveItem(item);
+			return false;
+		}
 
-							switch (item->GetVnum())
-							{
-								case 70020: // Peach Flower Wine
-								case 71018: // Blessing of Life
-								case 71019: // Blessing of Magic
-								case 71020: // Blessing of the Dragon
-								{
-									if (quest::CQuestManager::instance().GetEventFlag("arena_potion_limit_count") < 10000)
-									{
-										if (m_nPotionLimit <= 0)
-										{
-											ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ѷ ʰϿϴ."));
-											return false;
-										}
-									}
-								}
-								break;
+		DWORD dwVnum = item->GetSocket(0);
 
-								default:
-								{
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING("忡 Ͻ  ϴ."));
-									return false;
-								}
-							}
-						}
+		if (SkillLevelDown(dwVnum))
+		{
+			ITEM_MANAGER::instance().RemoveItem(item);
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ų  µ Ͽϴ."));
+		}
+		else
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ų    ϴ."));
+	}
+	break;
 
-						bool bUsed = false;
+	case ITEM_SKILLBOOK:
+	{
+		if (IsPolymorphed())
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("߿ å  ϴ."));
+			return false;
+		}
 
-						if (item->GetValue(0) != 0) // HP 밪 ȸ
-						{
-							if (GetHP() < GetMaxHP())
-							{
-								PointChange(POINT_HP, item->GetValue(0) * (100 + GetPoint(POINT_POTION_BONUS)) / 100);
-								EffectPacket(SE_HPUP_RED);
-								bUsed = true;
-							}
-						}
+		DWORD dwVnum = 0;
 
-						if (item->GetValue(1) != 0) // SP 밪 ȸ
-						{
-							if (GetSP() < GetMaxSP())
-							{
-								PointChange(POINT_SP, item->GetValue(1) * (100 + GetPoint(POINT_POTION_BONUS)) / 100);
-								EffectPacket(SE_SPUP_BLUE);
-								bUsed = true;
-							}
-						}
+		if (item->GetVnum() == 50300)
+		{
+			dwVnum = item->GetSocket(0);
+		}
+		else
+		{
+			// ο ü value 0  ų ȣ Ƿ װ .
+			dwVnum = item->GetValue(0);
+		}
 
-						if (item->GetValue(3) != 0) // HP % ȸ
-						{
-							if (GetHP() < GetMaxHP())
-							{
-								PointChange(POINT_HP, item->GetValue(3) * GetMaxHP() / 100);
-								EffectPacket(SE_HPUP_RED);
-								bUsed = true;
-							}
-						}
+		if (0 == dwVnum)
+		{
+			ITEM_MANAGER::instance().RemoveItem(item);
+			return false;
+		}
 
-						if (item->GetValue(4) != 0) // SP % ȸ
-						{
-							if (GetSP() < GetMaxSP())
-							{
-								PointChange(POINT_SP, item->GetValue(4) * GetMaxSP() / 100);
-								EffectPacket(SE_SPUP_BLUE);
-								bUsed = true;
-							}
-						}
+		if (true == LearnSkillByBook(dwVnum))
+		{
+			item->SetCount(item->GetCount() - 1);
 
-						if (bUsed)
-						{
-							if (item->GetVnum() == 50085 || item->GetVnum() == 50086)
-							{
-								if (test_server)
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING(" Ǵ   Ͽϴ"));
+			int iReadDelay = number(SKILLBOOK_DELAY_MIN, SKILLBOOK_DELAY_MAX);
 
-								SetUseSeedOrMoonBottleTime();
-							}
+			if (distribution_test_server)
+				iReadDelay /= 3;
 
-							if (GetDungeon())
-								GetDungeon()->UsePotion(this);
+			// ѱ  쿡 ð 24ð 
+			if (LC_IsKorea())
+				iReadDelay = 86400;
 
-							if (GetWarMap())
-								GetWarMap()->UsePotion(this, item);
+			SetSkillNextReadTime(dwVnum, get_global_time() + iReadDelay);
+		}
+	}
+	break;
 
-							m_nPotionLimit--;
+	case ITEM_USE:
+	{
+#if defined(__SOUL_BIND_SYSTEM__)
+		if (item->IsSealed())
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot use a soulbound item."));
+			return false;
+		}
+#endif
 
-							// RESTRICT_USE_SEED_OR_MOONBOTTLE
-							item->SetCount(item->GetCount() - 1);
-							// END_RESTRICT_USE_SEED_OR_MOONBOTTLE
-						}
-					}
-					break;
-				}
+#if defined(__ACCE_COSTUME_SYSTEM__)
+		if (item->IsAcceReverseScroll())
+		{
+			LPITEM item2 = GetItem(DestCell);
+			if (item2)
+			{
+				if (item2->IsExchanging())
+					return false;
 
-				return true;
+				if (item2->IsEquipped())
+					return false;
+
+				//< 2020.12.25.Owsap
+				// NOTE : Acce Reverse Scroll
+				// Return here while the scroll (pointer) exists.
+				if (CleanAcceAttr(item, item2))
+					return true;
+				//>
 			}
+		}
+#endif
 
-			if (item->GetVnum() >= 27863 && item->GetVnum() <= 27883)
+#if defined(__CHANGE_LOOK_SYSTEM__)
+		if (item->IsChangeLookReverseScroll())
+		{
+			LPITEM item2 = GetItem(DestCell);
+			if (item2)
 			{
-				if (CArenaManager::instance().IsArenaMap(GetMapIndex()))
-				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ߿ ̿   ǰԴϴ."));
+				if (item2->IsExchanging())
 					return false;
-				}
+
+				if (item2->IsEquipped())
+					return false;
+
+				//< 2020.12.25.Owsap
+				/*
+				* Note : Change Look Reverse Scroll
+				* Return here while the scroll (pointer) exists.
+				*/
+				if (CleanTransmutation(item, item2))
+					return true;
+				//>
 			}
+		}
+#endif
 
+		if (item->GetVnum() > 50800 && item->GetVnum() <= 50820)
+		{
 			if (test_server)
-			{
-				sys_log(0, "USE_ITEM %s Type %d SubType %d vnum %d", item->GetName(), item->GetType(), item->GetSubType(), item->GetOriginalVnum());
-			}
+				sys_log(0, "ADD addtional effect : vnum(%d) subtype(%d)", item->GetOriginalVnum(), item->GetSubType());
+
+			int affect_type = AFFECT_EXP_BONUS_EURO_FREE;
+			int apply_type = aApplyInfo[item->GetValue(0)].bPointType;
+			int apply_value = item->GetValue(2);
+			int apply_duration = item->GetValue(1);
 
 			switch (item->GetSubType())
 			{
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-				case USE_ELEMENT_UPGRADE:
-				case USE_ELEMENT_DOWNGRADE:
-				case USE_ELEMENT_CHANGE:
-					RefineElementInformation(item, DestCell);
-					break;
-#endif
-
-#if defined(__EXPRESSING_EMOTIONS__)
-				case USE_EMOTION_PACK:
+			case USE_ABILITY_UP:
+				if (FindAffect(affect_type, apply_type))
 				{
-					AddEmote();
-					item->SetCount(item->GetCount() - 1);
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+					return false;
 				}
-				break;
-#endif
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
-				case USE_TIME_CHARGE_PER:
 				{
-					LPITEM pDestItem = GetItem(DestCell);
-					if (NULL == pDestItem)
-						return false;
-
-					// 켱 ȥ ؼ ϵ Ѵ.
-					if (pDestItem->IsDragonSoul())
+					switch (item->GetValue(0))
 					{
-						int ret;
-						char buf[128];
-						if (item->GetVnum() == ITEM_DRAGON_HEART_VNUM)
-						{
-							ret = pDestItem->GiveMoreTime_Per((float)item->GetSocket(ITEM_SOCKET_CHARGING_AMOUNT_IDX));
-						}
-						else
-						{
-							ret = pDestItem->GiveMoreTime_Per((float)item->GetValue(ITEM_VALUE_CHARGING_AMOUNT_IDX));
-						}
-
-						if (ret > 0)
-						{
-#if defined(__DS_SET__)
-							DragonSoul_SetBonus();
-#endif
-
-							if (item->GetVnum() == ITEM_DRAGON_HEART_VNUM)
-							{
-								sprintf(buf, "Inc %ds by item{VN:%d SOC%d:%d}", ret, item->GetVnum(), ITEM_SOCKET_CHARGING_AMOUNT_IDX, item->GetSocket(ITEM_SOCKET_CHARGING_AMOUNT_IDX));
-							}
-							else
-							{
-								sprintf(buf, "Inc %ds by item{VN:%d VAL%d:%d}", ret, item->GetVnum(), ITEM_VALUE_CHARGING_AMOUNT_IDX, item->GetValue(ITEM_VALUE_CHARGING_AMOUNT_IDX));
-							}
-
-							ChatPacket(CHAT_TYPE_INFO, LC_STRING("%d ŭ Ǿϴ.", ret));
-							item->SetCount(item->GetCount() - 1);
-							LogManager::instance().ItemLog(this, item, "DS_CHARGING_SUCCESS", buf);
-
-							return true;
-						}
-						else
+					case APPLY_MOV_SPEED:
+					{
+#if defined(__EXTENDED_BLEND_AFFECT__)
+						if (FindAffect(AFFECT_MOVE_SPEED))
 						{
-							if (item->GetVnum() == ITEM_DRAGON_HEART_VNUM)
-							{
-								sprintf(buf, "No change by item{VN:%d SOC%d:%d}", item->GetVnum(), ITEM_SOCKET_CHARGING_AMOUNT_IDX, item->GetSocket(ITEM_SOCKET_CHARGING_AMOUNT_IDX));
-							}
-							else
-							{
-								sprintf(buf, "No change by item{VN:%d VAL%d:%d}", item->GetVnum(), ITEM_VALUE_CHARGING_AMOUNT_IDX, item->GetValue(ITEM_VALUE_CHARGING_AMOUNT_IDX));
-							}
-
-							ChatPacket(CHAT_TYPE_INFO, LC_STRING("  ϴ."));
-							LogManager::instance().ItemLog(this, item, "DS_CHARGING_FAILED", buf);
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
 							return false;
 						}
+#endif
+						AddAffect(affect_type, apply_type, apply_value, AFF_MOV_SPEED_POTION, apply_duration, 0, true, true);
+						break;
 					}
-					else
-						return false;
-				}
-				break;
-
-				case USE_TIME_CHARGE_FIX:
-				{
-					LPITEM pDestItem = GetItem(DestCell);
-					if (NULL == pDestItem)
-						return false;
 
-					// 켱 ȥ ؼ ϵ Ѵ.
-					if (pDestItem->IsDragonSoul())
+					case APPLY_ATT_SPEED:
 					{
-						int ret = pDestItem->GiveMoreTime_Fix(item->GetValue(ITEM_VALUE_CHARGING_AMOUNT_IDX));
-						char buf[128];
-						if (ret)
+#if defined(__EXTENDED_BLEND_AFFECT__)
+						if (FindAffect(AFFECT_BLEND_POTION_3))
 						{
-#if defined(__DS_SET__)
-							DragonSoul_SetBonus();
-#endif
-
-							ChatPacket(CHAT_TYPE_INFO, LC_STRING("%d ŭ Ǿϴ.", ret));
-
-							sprintf(buf, "Increase %ds by item{VN:%d VAL%d:%d}", ret, item->GetVnum(), ITEM_VALUE_CHARGING_AMOUNT_IDX, item->GetValue(ITEM_VALUE_CHARGING_AMOUNT_IDX));
-							LogManager::instance().ItemLog(this, item, "DS_CHARGING_SUCCESS", buf);
-							item->SetCount(item->GetCount() - 1);
-
-							return true;
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+							return false;
 						}
-						else
+
+						if (FindAffect(AFFECT_ATTACK_SPEED))
 						{
-							ChatPacket(CHAT_TYPE_INFO, LC_STRING("  ϴ."));
-							sprintf(buf, "No change by item{VN:%d VAL%d:%d}", item->GetVnum(), ITEM_VALUE_CHARGING_AMOUNT_IDX, item->GetValue(ITEM_VALUE_CHARGING_AMOUNT_IDX));
-							LogManager::instance().ItemLog(this, item, "DS_CHARGING_FAILED", buf);
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
 							return false;
 						}
-					}
-					else
-						return false;
-				}
-				break;
 #endif
+						AddAffect(affect_type, apply_type, apply_value, AFF_ATT_SPEED_POTION, apply_duration, 0, true, true);
+						break;
+					}
 
-				case USE_SPECIAL:
-				{
-					switch (item->GetVnum())
+					case APPLY_STR:
+					case APPLY_DEX:
+					case APPLY_CON:
+					case APPLY_INT:
+					case APPLY_CAST_SPEED:
 					{
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-						case ITEM_GUILD_DRAGONLAIR_POTION:
-						{
-							if (GetGuildDragonLair() == NULL)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot use that here."));
-								return false;
-							}
-
-							if (FindAffect(AFFECT_RED_DRAGONLAIR_BUFF))
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("̹ ȿ ɷ ֽϴ."));
-								return false;
-							}
-							else
-							{
-								const long duration = item->GetValue(1);
-
-								AddAffect(AFFECT_RED_DRAGONLAIR_BUFF, POINT_SKILL_DEFEND_BONUS, 15, AFF_NONE, duration, 0, true, true);
-								AddAffect(AFFECT_RED_DRAGONLAIR_BUFF, POINT_NORMAL_HIT_DEFEND_BONUS, 15, AFF_NONE, duration, 0, true, true);
-
-								item->SetCount(item->GetCount() - 1);
-							}
-						}
+						AddAffect(affect_type, apply_type, apply_value, 0, apply_duration, 0, true, true);
 						break;
-#endif
+					}
 
-#if defined(__ELEMENTAL_DUNGEON__)
-						case ITEM_PRIMAL_FORCE_MEDAL:
+					case APPLY_CRITICAL_PCT:
+					{
+#if defined(__EXTENDED_BLEND_AFFECT__)
+						if (FindAffect(AFFECT_BLEND_POTION_1))
 						{
-							if (IS_ELEMENTAL_DUNGEON(GetMapIndex()) == false)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot use that here."));
-								return false;
-							}
-
-							CAffect* pAffect = FindAffect(AFFECT_PROTECTION_OF_ELEMENTAL);
-							if (pAffect)
-							{
-								// NOTE : Check if adding another 600 seconds (10 minutes) would exceed 3600 seconds (60 minutes).
-								const long lDuration = pAffect->lDuration;
-								if (lDuration + 600 > 3600)
-								{
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot use that any more."));
-									return false;
-								}
-
-								AddAffect(AFFECT_PROTECTION_OF_ELEMENTAL, APPLY_NONE, 0, AFF_NONE, lDuration + 600, 0, true);
-							}
-							else
-								AddAffect(AFFECT_PROTECTION_OF_ELEMENTAL, APPLY_NONE, 0, AFF_NONE, 600, 0, true);
-
-							item->SetCount(item->GetCount() - 1);
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+							return false;
 						}
-						break;
 
-						case ITEM_ELEMENTAL_DEFENSE_POTION:
+						if (FindAffect(AFFECT_CRITICAL))
 						{
-							if (IS_ELEMENTAL_DUNGEON(GetMapIndex()) == false)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot use that here."));
-								return false;
-							}
-
-							const long duration = item->GetValue(1);
-							static const std::unordered_map<POINT_TYPE, POINT_VALUE> map_affect = {
-								{ APPLY_MELEE_MAGIC_ATTBONUS_PER, 5 },
-								{ APPLY_RESIST_FIRE, 10 },
-								{ APPLY_RESIST_ELEC, 10 },
-								{ APPLY_RESIST_ICE, 10 },
-								{ APPLY_RESIST_EARTH, 10 },
-								{ APPLY_RESIST_DARK, 10 },
-							};
-							for (const auto& it : map_affect)
-								AddAffect(AFFECT_POTION_OF_ELEMENTAL, it.first, it.second, AFF_NONE, duration, 0, true, true);
-
-							item->SetCount(item->GetCount() - 1);
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+							return false;
 						}
+#endif
+						AddAffect(affect_type, apply_type, apply_value, 0, apply_duration, 0, true, true);
 						break;
+					}
 
-						case ITEM_PRIMAL_FORCE_RING:
-						case ITEM_PRIMAL_FORCE_RING_MALL:
+					case APPLY_PENETRATE_PCT:
+					{
+#if defined(__EXTENDED_BLEND_AFFECT__)
+						if (FindAffect(AFFECT_BLEND_POTION_2))
 						{
-							if (IS_ELEMENTAL_DUNGEON(GetMapIndex()) == false)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot use that here."));
-								return false;
-							}
-
-							if (number(0, 100) < item->GetValue(0))
-							{
-								PIXEL_POSITION WarpPos;
-								if (SECTREE_MANAGER::instance().GetRecallPositionByEmpire(MAP_ELEMENTAL_04, GetEmpire(), WarpPos))
-									WarpSet(WarpPos.x, WarpPos.y);
-								else
-									sys_err("CHARACTER::UseItem : cannot find spawn position (name %s, %d x %d)", GetName(), GetX(), GetY());
-							}
-							else
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("Teleportation to the Plateau of Primal Forces has failed."));
-							
-							item->SetCount(item->GetCount() - 1);
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+							return false;
 						}
-						break;
-#endif
 
-#if defined(__MINI_GAME_RUMI__) && defined(__OKEY_EVENT_FLAG_RENEWAL__)
-						case ITEM_VNUM_RUMI_CARD_PIECE:
+						if (FindAffect(AFFECT_PENETRATE))
 						{
-							if (CMiniGameRumi::UpdateQuestFlag(this))
-								item->SetCount(item->GetCount() - 1);
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+							return false;
 						}
+#endif
+						AddAffect(affect_type, apply_type, apply_value, 0, apply_duration, 0, true, true);
 						break;
+					}
 
-						case ITEM_VNUM_RUMI_CARD_PACK:
+					case APPLY_RESIST_MAGIC:
+					{
+#if defined(__EXTENDED_BLEND_AFFECT__)
+						if (FindAffect(AFFECT_BLEND_POTION_4))
 						{
-							const WORD wCardCount = GetQuestFlag("minigame_rumi.card_count");
-							if (wCardCount < CMiniGameRumi::RUMI_CARD_COUNT_MAX)
-							{
-								SetQuestFlag("minigame_rumi.card_count", wCardCount + 1);
-								CMiniGameRumi::RequestQuestFlag(this, RUMI_GC_SUBHEADER_SET_CARD_FLAG);
-
-								item->SetCount(item->GetCount() - 1);
-							}
-							else
-							{
-								CMiniGameRumi::RequestQuestFlag(this, RUMI_GC_SUBHEADER_NO_MORE_GAIN);
-							}
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+							return false;
 						}
-						break;
 #endif
-
-#if defined(__MINI_GAME_YUTNORI__) && defined(__YUTNORI_EVENT_FLAG_RENEWAL__)
-						case ITEM_VNUM_YUT_PIECE:
-						{
-							if (CMiniGameYutnori::UpdateQuestFlag(this))
-								item->SetCount(item->GetCount() - 1);
-						}
+						AddAffect(affect_type, apply_type, apply_value, 0, apply_duration, 0, true, true);
 						break;
+					}
 
-						case ITEM_VNUM_YUT_BOARD:
+					case APPLY_ATT_GRADE_BONUS:
+					{
+#if defined(__EXTENDED_BLEND_AFFECT__)
+						if (FindAffect(AFFECT_BLEND_POTION_5))
 						{
-							const WORD wYutBoardCount = GetQuestFlag("minigame_yutnori.board_count");
-							if (wYutBoardCount < CMiniGameYutnori::YUTNORI_BOARD_COUNT_MAX)
-							{
-								SetQuestFlag("minigame_yutnori.board_count", wYutBoardCount + 1);
-								CMiniGameYutnori::RequestQuestFlag(this, YUTNORI_GC_SUBHEADER_SET_YUT_BOARD_FLAG);
-
-								item->SetCount(item->GetCount() - 1);
-							}
-							else
-							{
-								CMiniGameYutnori::RequestQuestFlag(this, YUTNORI_GC_SUBHEADER_NO_MORE_GAIN);
-							}
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+							return false;
 						}
-						break;
 #endif
-
-#if defined(__MINI_GAME_CATCH_KING__) && defined(__CATCH_KING_EVENT_FLAG_RENEWAL__)
-						case ITEM_VNUM_CATCH_KING_PIECE:
-						{
-							if (CMiniGameCatchKing::UpdateQuestFlag(this))
-								item->SetCount(item->GetCount() - 1);
-						}
+						AddAffect(affect_type, apply_type, apply_value, 0, apply_duration, 0, true, true);
 						break;
+					}
 
-						case ITEM_VNUM_CATCH_KING_PACK:
+					case APPLY_DEF_GRADE_BONUS:
+					{
+#if defined(__EXTENDED_BLEND_AFFECT__)
+						if (FindAffect(AFFECT_BLEND_POTION_6))
 						{
-							const WORD wPackCount = GetQuestFlag("minigame_catchking.pack_count");
-							if (wPackCount < CMiniGameCatchKing::CATCH_KING_PACK_COUNT_MAX)
-							{
-								SetQuestFlag("minigame_catchking.pack_count", wPackCount + 1);
-								CMiniGameCatchKing::RequestQuestFlag(this, CATCHKING_GC_SET_CARD_FLAG);
-
-								item->SetCount(item->GetCount() - 1);
-							}
-							else
-							{
-								CMiniGameCatchKing::RequestQuestFlag(this, CATCHKING_GC_NO_MORE_GAIN);
-							}
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+							return false;
 						}
-						break;
 #endif
-
-#if defined(__EASTER_EVENT__)
-						case ITEM_MAGIC_EASTER_EGG:
-						{
-							int nMaxUse = 3;
-							int nNextUseTime = 1800;
-
-							int nUseTime = get_global_time() - item->GetSocket(1);
-							int nUseCount = item->GetSocket(0);
-
-							if (nUseTime >= nNextUseTime)
-							{
-								if (GiveItemFromSpecialItemGroup(ITEM_MAGIC_EASTER_EGG))
-								{
-									item->SetSocket(1, get_global_time());
-									if (nUseCount >= (nMaxUse - 1))
-										item->SetCount(item->GetCount() - 1);
-									else
-										item->SetSocket(0, nUseCount + 1);
-
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING("Total %d: You can still unpack %d.", nMaxUse, (nMaxUse - 1) - nUseCount));
-								}
-								else
-									ChatPacket(CHAT_TYPE_TALKING, LC_STRING("ƹ͵   ϴ."));
-							}
-							else
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("Unpack the next gift in %d minutes.", 31 - nUseTime / 60));
-							}
-						}
+						AddAffect(affect_type, apply_type, apply_value, 0, apply_duration, 0, true, true);
 						break;
-#endif
-
-#if defined(__GEM_CONVERTER__)
-						case ITEM_VNUM_GEM_CONVERTER:
-						{
-							LPITEM pTargetItem;
-							if (!IsValidItemPosition(DestCell) || !(pTargetItem = GetItem(DestCell)))
-								return false;
-
-							if (pTargetItem->GetVnum() != ITEM_VNUM_GEM_STONE)
-								return false;
+					}
 
-							if (item->IsExchanging() || pTargetItem->IsExchanging())
-								return false;
+					}
+				}
 
-							if (item->isLocked() || pTargetItem->isLocked())
-								return false;
+				if (GetDungeon())
+					GetDungeon()->UsePotion(this);
 
-							int iNeedGemStoneCount = item->GetCount() * item->GetValue(0);
-							int iConvertToGem = iNeedGemStoneCount / item->GetValue(0);
-							int iConvertCost = item->GetCount() * item->GetValue(1);
+				if (GetWarMap())
+					GetWarMap()->UsePotion(this, item);
 
-							if (pTargetItem->GetCount() < iNeedGemStoneCount)
-								return false;
+				item->SetCount(item->GetCount() - 1);
+				break;
 
-							if (GetGold() < iConvertCost)
-								return false;
+			case USE_AFFECT:
+			{
+#if defined(__EXTENDED_BLEND_AFFECT__)
+				for (int i = AFFECT_DRAGON_GOD_1; i <= AFFECT_DRAGON_GOD_4; ++i)
+				{
+					if (FindAffect(i, aApplyInfo[item->GetValue(1)].bPointType))
+					{
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+						return false;
+					}
+				}
+#endif
 
-							if (GetGem() + iConvertToGem >= GEM_MAX)
-								return false;
+				if (FindAffect(AFFECT_EXP_BONUS_EURO_FREE, aApplyInfo[item->GetValue(1)].bPointType))
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+				}
+				else
+				{
+					// PC_BANG_ITEM_ADD
+					if (item->IsPCBangItem() == true)
+					{
+						// PC üũؼ ó
+						if (CPCBangManager::instance().IsPCBangIP(GetDesc()->GetHostName()) == false)
+						{
+							// PC ƴ!
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  PC濡   ֽϴ."));
+							return false;
+						}
+					}
+					// END_PC_BANG_ITEM_ADD
 
-							item->SetCount(item->GetCount() - 1);
-							pTargetItem->SetCount(pTargetItem->GetCount() - iNeedGemStoneCount);
+					AddAffect(AFFECT_EXP_BONUS_EURO_FREE, aApplyInfo[item->GetValue(1)].bPointType, item->GetValue(2), 0, item->GetValue(3), 0, false, true);
+					item->SetCount(item->GetCount() - 1);
+				}
+			}
+			break;
 
-							PointChange(POINT_GOLD, -iConvertCost);
-							PointChange(POINT_GEM, iConvertToGem);
-						}
-						break;
-#endif
+			case USE_POTION_NODELAY:
+			{
+				if (CArenaManager::instance().IsArenaMap(GetMapIndex()) == true)
+				{
+					if (quest::CQuestManager::instance().GetEventFlag("arena_potion_limit") > 0)
+					{
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("忡 Ͻ  ϴ."));
+						return false;
+					}
 
-#if defined(__SNOWFLAKE_STICK_EVENT__)
-						case ITEM_VNUM_SNOWFLAKE_STICK:
+					switch (item->GetVnum())
+					{
+					case 70020:
+					case 71018:
+					case 71019:
+					case 71020:
+						if (quest::CQuestManager::instance().GetEventFlag("arena_potion_limit_count") < 10000)
 						{
-							if (CSnowflakeStickEvent::UseStick(this))
+							if (m_nPotionLimit <= 0)
 							{
-								EffectPacket(SE_USE_SNOWFLAKE_STICK);
-								item->SetCount(item->GetCount() - 1);
+								ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ѷ ʰϿϴ."));
+								return false;
 							}
 						}
 						break;
-#endif
 
-#if defined(__ACCE_COSTUME_SYSTEM__)
-						case ITEM_ACCE_REVERSAL:
-						case ITEM_ACCE_REVERSAL_MALL:
-						{
-							LPITEM lpTargetItem;
-							if (!IsValidItemPosition(DestCell) || !(lpTargetItem = GetItem(DestCell)))
-								return false;
+					default:
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("忡 Ͻ  ϴ."));
+						return false;
+						break;
+					}
+				}
 
-							if (lpTargetItem->IsExchanging())
-								return false;
+				bool used = false;
 
-							if (lpTargetItem->isLocked())
-								return false;
+				if (item->GetValue(0) != 0) // HP 밪 ȸ
+				{
+					if (GetHP() < GetMaxHP())
+					{
+						PointChange(POINT_HP, item->GetValue(0) * (100 + GetPoint(POINT_POTION_BONUS)) / 100);
+						EffectPacket(SE_HPUP_RED);
+						used = TRUE;
+					}
+				}
 
-#if defined(__SOUL_BIND_SYSTEM__)
-							if (lpTargetItem->IsSealed())
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot use this item on soulbound items."));
-								return false;
-							}
-#endif
+				if (item->GetValue(1) != 0) // SP 밪 ȸ
+				{
+					if (GetSP() < GetMaxSP())
+					{
+						PointChange(POINT_SP, item->GetValue(1) * (100 + GetPoint(POINT_POTION_BONUS)) / 100);
+						EffectPacket(SE_SPUP_BLUE);
+						used = TRUE;
+					}
+				}
 
-							if (IsAcceRefineWindowOpen())
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot use this item while the windows for absorption and combination are open."));
-								return false;
-							}
+				if (item->GetValue(3) != 0) // HP % ȸ
+				{
+					if (GetHP() < GetMaxHP())
+					{
+						PointChange(POINT_HP, item->GetValue(3) * GetMaxHP() / 100);
+						EffectPacket(SE_HPUP_RED);
+						used = TRUE;
+					}
+				}
 
-							lpTargetItem->SetSocket(ITEM_SOCKET_ACCE_DRAIN_ITEM_VNUM, 0);
-							lpTargetItem->ClearAllAttribute();
-							lpTargetItem->UpdatePacket();
+				if (item->GetValue(4) != 0) // SP % ȸ
+				{
+					if (GetSP() < GetMaxSP())
+					{
+						PointChange(POINT_SP, item->GetValue(4) * GetMaxSP() / 100);
+						EffectPacket(SE_SPUP_BLUE);
+						used = TRUE;
+					}
+				}
 
-							item->SetCount(item->GetCount() - 1);
-						}
-						break;
-#endif
+				if (used)
+				{
+					if (item->GetVnum() == 50085 || item->GetVnum() == 50086)
+					{
+						if (test_server)
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" Ǵ   Ͽϴ"));
+						SetUseSeedOrMoonBottleTime();
+					}
+					if (GetDungeon())
+						GetDungeon()->UsePotion(this);
 
-#if defined(__CHANGE_LOOK_SYSTEM__)
-						case ITEM_CHANGE_LOOK_REVERSAL:
-						case ITEM_CHANGE_LOOK_MOUNT_REVERSAL:
-						{
-							LPITEM item2;
-							if (!IsValidItemPosition(DestCell) || !(item2 = GetItem(DestCell)))
-								return false;
+					if (GetWarMap())
+						GetWarMap()->UsePotion(this, item);
 
-							if (item2->IsExchanging())
-								return false;
+					m_nPotionLimit--;
 
-							if (item2->isLocked())
-								return false;
+					// RESTRICT_USE_SEED_OR_MOONBOTTLE
+					item->SetCount(item->GetCount() - 1);
+					// END_RESTRICT_USE_SEED_OR_MOONBOTTLE
+				}
+			}
+			break;
+			}
 
-							if (item2->GetTransmutationVnum() == 0)
-								return false;
+			return true;
+		}
 
-							if (item->GetVnum() == ITEM_CHANGE_LOOK_MOUNT_REVERSAL && !item2->IsCostumeMount())
-								return false;
+		if (item->GetVnum() >= 27863 && item->GetVnum() <= 27883)
+		{
+			if (CArenaManager::instance().IsArenaMap(GetMapIndex()) == true)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ߿ ̿   ǰԴϴ."));
+				return false;
+			}
+		}
 
-#if defined(__SOUL_BIND_SYSTEM__)
-							if (item2->IsSealed())
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot use this item on soulbound items."));
-								return false;
-							}
-#endif
+		if (test_server)
+		{
+			sys_log(0, "USE_ITEM %s Type %d SubType %d vnum %d", item->GetName(), item->GetType(), item->GetSubType(), item->GetOriginalVnum());
+		}
 
-							item2->SetTransmutationVnum(0);
-							item2->UpdatePacket();
+		switch (item->GetSubType())
+		{
+#if defined(__EXPRESSING_EMOTIONS__)
+		case USE_EMOTION_PACK:
+		{
+			std::random_device rd;
+			std::mt19937 gen(rd());
+			std::uniform_real_distribution<> dis(60, 77);
+			int iSpecialActionID = dis(gen);
 
-							item->SetCount(item->GetCount() - 1);
-						}
-						break;
-#endif
+			DWORD dwExpireTime = 60 * 60 * 12; // 12h
+			DWORD dwDuration = get_global_time() + dwExpireTime;
 
-#if defined(__AURA_COSTUME_SYSTEM__)
-						case ITEM_VNUM_AURA_CLEAR:
-						{
-							LPITEM lpTargetItem;
-							if (!IsValidItemPosition(DestCell) || !(lpTargetItem = GetItem(DestCell)))
-								return false;
+			char szQuestFlag[20] = "0";
+			snprintf(szQuestFlag, sizeof(szQuestFlag), "emotions.expire_%d", iSpecialActionID);
 
-							if (lpTargetItem->IsExchanging())
-								return false;
+			DWORD dwActionTime = GetQuestFlag(szQuestFlag);
+			if (dwActionTime != 0)
+				dwDuration = dwActionTime + dwExpireTime;
 
-							if (lpTargetItem->isLocked())
-								return false;
+			SetQuestFlag(szQuestFlag, dwDuration);
 
-#if defined(__SOUL_BIND_SYSTEM__)
-							if (lpTargetItem->IsSealed())
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot use this item on soulbound items."));
-								return false;
-							}
+			ChatPacket(CHAT_TYPE_COMMAND, "RegisterSpecialEmotion %d %d 1", iSpecialActionID, dwDuration);
+			item->SetCount(item->GetCount() - 1);
+		}
+		break;
 #endif
 
-							if (IsAuraRefineWindowOpen())
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot use this item while the windows for absorption and combination are open."));
-								return false;
-							}
-
-							lpTargetItem->SetSocket(ITEM_SOCKET_AURA_DRAIN_ITEM_VNUM, 0);
-							lpTargetItem->ClearAllAttribute();
-							lpTargetItem->UpdatePacket();
+		case USE_TIME_CHARGE_PER:
+		{
+			LPITEM pDestItem = GetItem(DestCell);
+			if (NULL == pDestItem)
+				return false;
 
-							item->SetCount(item->GetCount() - 1);
-						}
-						break;
-#endif
+			// 켱 ȥ ؼ ϵ Ѵ.
+			if (pDestItem->IsDragonSoul())
+			{
+				int ret;
+				char buf[128];
+				if (item->GetVnum() == DRAGON_HEART_VNUM)
+				{
+					ret = pDestItem->GiveMoreTime_Per((float)item->GetSocket(ITEM_SOCKET_CHARGING_AMOUNT_IDX));
+				}
+				else
+				{
+					ret = pDestItem->GiveMoreTime_Per((float)item->GetValue(ITEM_VALUE_CHARGING_AMOUNT_IDX));
+				}
+				if (ret > 0)
+				{
+					if (item->GetVnum() == DRAGON_HEART_VNUM)
+					{
+						sprintf(buf, "Inc %ds by item{VN:%d SOC%d:%d}", ret, item->GetVnum(), ITEM_SOCKET_CHARGING_AMOUNT_IDX, item->GetSocket(ITEM_SOCKET_CHARGING_AMOUNT_IDX));
+					}
+					else
+					{
+						sprintf(buf, "Inc %ds by item{VN:%d VAL%d:%d}", ret, item->GetVnum(), ITEM_VALUE_CHARGING_AMOUNT_IDX, item->GetValue(ITEM_VALUE_CHARGING_AMOUNT_IDX));
+					}
 
-#if defined(__SET_ITEM__)
-						case ITEM_SET_CLEAR_SCROLL:
-						{
-							LPITEM item2;
-							if (!IsValidItemPosition(DestCell) || !(item2 = GetItem(DestCell)))
-								return false;
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%d ŭ Ǿϴ."), ret);
+					item->SetCount(item->GetCount() - 1);
+					LogManager::instance().ItemLog(this, item, "DS_CHARGING_SUCCESS", buf);
+					return true;
+				}
+				else
+				{
+					if (item->GetVnum() == DRAGON_HEART_VNUM)
+					{
+						sprintf(buf, "No change by item{VN:%d SOC%d:%d}", item->GetVnum(), ITEM_SOCKET_CHARGING_AMOUNT_IDX, item->GetSocket(ITEM_SOCKET_CHARGING_AMOUNT_IDX));
+					}
+					else
+					{
+						sprintf(buf, "No change by item{VN:%d VAL%d:%d}", item->GetVnum(), ITEM_VALUE_CHARGING_AMOUNT_IDX, item->GetValue(ITEM_VALUE_CHARGING_AMOUNT_IDX));
+					}
 
-							if (item->IsExchanging() || item2->IsExchanging() || item2->IsEquipped())
-								return false;
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ϴ."));
+					LogManager::instance().ItemLog(this, item, "DS_CHARGING_FAILED", buf);
+					return false;
+				}
+			}
+			else
+				return false;
+		}
+		break;
 
-							if (item->isLocked() || item2->isLocked())
-								return false;
+		case USE_TIME_CHARGE_FIX:
+		{
+			LPITEM pDestItem = GetItem(DestCell);
+			if (NULL == pDestItem)
+				return false;
 
-#if defined(__SOUL_BIND_SYSTEM__)
-							if (item2->IsSealed())
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot use this item on soulbound items."));
-								return false;
-							}
+			// 켱 ȥ ؼ ϵ Ѵ.
+			if (pDestItem->IsDragonSoul())
+			{
+#if defined(__EXTENDED_DSS_RECHARGE__)
+				int ret = pDestItem->GiveMoreTime_Extend(item->GetValue(ITEM_VALUE_CHARGING_AMOUNT_IDX));
+				char buf[128];
+				if (ret)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%d days have been added."), (ret / 86400));
+					sprintf(buf, "Increase %ds by item{VN:%d VAL%d:%d}", ret, item->GetVnum(), ITEM_VALUE_CHARGING_AMOUNT_IDX, item->GetValue(ITEM_VALUE_CHARGING_AMOUNT_IDX));
+					LogManager::instance().ItemLog(this, item, "DS_CHARGING_SUCCESS", buf);
+					item->SetCount(item->GetCount() - 1);
+					return true;
+				}
+				else
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ϴ."));
+					sprintf(buf, "No change by item{VN:%d VAL%d:%d}", item->GetVnum(), ITEM_VALUE_CHARGING_AMOUNT_IDX, item->GetValue(ITEM_VALUE_CHARGING_AMOUNT_IDX));
+					LogManager::instance().ItemLog(this, item, "DS_CHARGING_FAILED", buf);
+					return false;
+				}
+#else
+				int ret = pDestItem->GiveMoreTime_Fix(item->GetValue(ITEM_VALUE_CHARGING_AMOUNT_IDX));
+				char buf[128];
+				if (ret)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%d ŭ Ǿϴ."), ret);
+					sprintf(buf, "Increase %ds by item{VN:%d VAL%d:%d}", ret, item->GetVnum(), ITEM_VALUE_CHARGING_AMOUNT_IDX, item->GetValue(ITEM_VALUE_CHARGING_AMOUNT_IDX));
+					LogManager::instance().ItemLog(this, item, "DS_CHARGING_SUCCESS", buf);
+					item->SetCount(item->GetCount() - 1);
+					return true;
+				}
+				else
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ϴ."));
+					sprintf(buf, "No change by item{VN:%d VAL%d:%d}", item->GetVnum(), ITEM_VALUE_CHARGING_AMOUNT_IDX, item->GetValue(ITEM_VALUE_CHARGING_AMOUNT_IDX));
+					LogManager::instance().ItemLog(this, item, "DS_CHARGING_FAILED", buf);
+					return false;
+				}
 #endif
+			}
+#if defined(__EXTENDED_COSTUME_RECHARGE__)
+			else if (pDestItem->IsCostume() && !pDestItem->IsCostumeAcce())
+			{
+				LPITEM pDestItem = GetItem(DestCell);
+				if (!pDestItem)
+					return false;
 
-							item2->SetItemSetValue(0);
-							item2->UpdatePacket();
-							item->SetCount(item->GetCount() - 1);
-						}
-						break;
+				if (pDestItem->GiveInfiniteTime())
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s is now with infinite time."), pDestItem->GetLocaleName());
+					item->SetCount(item->GetCount() - 1);
+					return true;
+				}
+				else
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s already has infinite time."), pDestItem->GetLocaleName());
+					return false;
+				}
+			}
 #endif
+			else
+				return false;
+		}
+		break;
 
-						// RESEARCHER_ELIXIR
-						case ITEM_RESEARCHERS_ELIXIR:
-						case ITEM_RESEARCHERS_ELIXIR_GIFT:
-						case ITEM_RESEARCHERS_ELIXIR_MALL:
-						{
-							if (FindAffect(AFFECT_RESEARCHER_ELIXIR))
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("̹ ȿ ɷ ֽϴ."));
-							}
-							else
-							{
-								AddAffect(AFFECT_RESEARCHER_ELIXIR, APPLY_NONE, 1, AFF_NONE, INFINITE_AFFECT_DURATION, 0, true);
-								item->SetCount(item->GetCount() - 1);
-							}
-						}
-						break;
-						// END_RESEARCHER_ELIXIR
+		case USE_SPECIAL:
+			switch (item->GetVnum())
+			{
+				// RESEARCHER_ELIXIR
+			case 71035:
+			{
+				if (FindAffect(AFFECT_RESEARCHER_ELIXIR))
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+				}
+				else
+				{
+					AddAffect(AFFECT_RESEARCHER_ELIXIR, APPLY_NONE, 1, AFF_NONE, INFINITE_AFFECT_DURATION, 0, true);
+					item->SetCount(item->GetCount() - 1);
+				}
+			}
+			break;
+			// END_RESEARCHER_ELIXIR
 
 #if defined(__SOUL_BIND_SYSTEM__)
-						case ITEM_SCROLL_BINDING:
-						{
-							if (!g_bSoulBind)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot soulbind items on this server."));
-								return false;
-							}
-
-							LPITEM item2;
-							if (!IsValidItemPosition(DestCell) || !(item2 = GetItem(DestCell)))
-								return false;
-
-							if (item2->IsExchanging())
-								return false;
-
-							if (!item2->CanSealItem())
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot bind this item to your soul."));
-								return false;
-							}
-
-							if (item2->IsSealed())
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("This item is already soulbound."));
-								return false;
-							}
+			case 50263:
+			{
+				if (!g_bSoulBind)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot soulbind items on this server."));
+					return false;
+				}
 
-							item2->SealItem();
+				LPITEM item2;
+				if (!IsValidItemPosition(DestCell) || !(item2 = GetItem(DestCell)))
+					return false;
 
-							char buf[256 + 1];
-							snprintf(buf, sizeof(buf), "%s(%u) %s(%u)",
-								item->GetName(), item->GetID(), item2->GetName(), item2->GetID());
-							LogManager::instance().ItemLog(this, item, "SEAL_SCROLL_USE_SUCCESS", buf);
+				if (item2->IsEquipped() || item2->IsExchanging())
+					return false;
 
-							item->SetCount(item->GetCount() - 1);
-						}
-						break;
+				if (item2->IsSealed())
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("This item is already soulbound."));
+					return false;
+				}
 
-						case ITEM_SCROLL_UNBINDING:
-#if defined(__UN_SEAL_SCROLL_PLUS__)
-						case ITEM_SCROLL_UNBINDING_MALL:
-#endif
-						{
-							LPITEM item2;
-							if (!IsValidItemPosition(DestCell) || !(item2 = GetItem(DestCell)))
-								return false;
+				if (item2->GetType() != ITEM_WEAPON &&
+					item2->GetType() != ITEM_ARMOR &&
+					item2->GetType() != ITEM_COSTUME &&
+					item2->GetType() != ITEM_RING &&
+					item2->GetType() != ITEM_BELT &&
+					item2->GetType() != ITEM_DS)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot bind this item to your soul."));
+					return false;
+				}
 
-							if (item2->isLocked() || item2->IsExchanging())
-								return false;
+				item2->SetSoulBind();
+				//ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Item binded."));
+				{
+					char buf[21];
+					snprintf(buf, sizeof(buf), "%u", item2->GetID());
+					LogManager::instance().ItemLog(this, item, "ITEM_BIND_SUCCESS", buf);
+				}
+				item->SetCount(item->GetCount() - 1);
+			}
+			break;
 
-							if (!item2->IsSealed())
-								return false;
+			case 50264:
+			{
+				LPITEM item2;
+				if (!IsValidItemPosition(DestCell) || !(item2 = GetItem(DestCell)))
+					return false;
 
-							if (item2->GetSealDate() > E_SEAL_DATE_DEFAULT_TIMESTAMP)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("The soulbind on this item is already in the process of being removed."));
-								return false;
-							}
+				if (item2->isLocked() || item2->IsEquipped())
+					return false;
 
-#if defined(__UN_SEAL_SCROLL_PLUS__)
-							if (item->GetVnum() == ITEM_SCROLL_UNBINDING_MALL)
-							{
-								item2->SealItem(E_SEAL_DATE_DEFAULT_TIMESTAMP);
+				if (item2->GetSealedTime() >= 0)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("The soulbind on this item is already in the process of being removed."));
+					return false;
+				}
 
-								char buf[256 + 1];
-								snprintf(buf, sizeof(buf), "%s(%u) %s(%u)",
-									item->GetName(), item->GetID(), item2->GetName(), item2->GetID());
-								LogManager::instance().ItemLog(this, item, "UN_SEAL_SCROLL_PLUS_USE_SUCCESS", buf);
-							}
-							else
+				long duration = 72 * 60 * 60;
+				item2->SetSoulBind(time(0) + duration);
+				item2->StartUnbindTimerExpireEvent();
+				//ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Item unbinded."));
+				{
+					char buf[21];
+					snprintf(buf, sizeof(buf), "%u", item2->GetID());
+					LogManager::instance().ItemLog(this, item, "ITEM_UNBIND_SUCCESS", buf);
+				}
+				item->SetCount(item->GetCount() - 1);
+			}
+			break;
 #endif
-							{
-								long lSealDate = time(0);
-
-								if (test_server)
-									lSealDate += 60;
-								else
-									lSealDate += (60 * 60 * SEAL_DATE_MAX);
-
-								item2->SealItem(lSealDate);
-								item2->StartSealDateExpireTimerEvent();
 
-								char buf[256 + 1];
-								snprintf(buf, sizeof(buf), "%s(%u) %s(%u)",
-									item->GetName(), item->GetID(), item2->GetName(), item2->GetID());
-								LogManager::instance().ItemLog(this, item, "UN_SEAL_SCROLL_USE_SUCCESS", buf);
-							}
+			// ũ 
+			case ITEM_NOG_POCKET:
+			{
+				/*
+				ִɷġ : item_proto value ǹ
+					̵ӵ value 1
+					ݷ value 2
+					ġ value 3
+					ӽð value 0 ( )
+				*/
+				if (FindAffect(AFFECT_NOG_ABILITY))
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+					return false;
+				}
+				long time = item->GetValue(0);
+				long moveSpeedPer = item->GetValue(1);
+				long attPer = item->GetValue(2);
+				long expPer = item->GetValue(3);
+				AddAffect(AFFECT_NOG_ABILITY, POINT_MOV_SPEED, moveSpeedPer, AFF_MOV_SPEED_POTION, time, 0, true, true);
+				AddAffect(AFFECT_NOG_ABILITY, POINT_MALL_ATTBONUS, attPer, AFF_NONE, time, 0, true, true);
+				AddAffect(AFFECT_NOG_ABILITY, POINT_MALL_EXPBONUS, expPer, AFF_NONE, time, 0, true, true);
+				item->SetCount(item->GetCount() - 1);
+			}
+			break;
 
-							item->SetCount(item->GetCount() - 1);
-						}
-						break;
-#endif
+			// 󸶴ܿ 
+			case ITEM_RAMADAN_CANDY:
+			{
+				/*
+				ɷġ : item_proto value ǹ
+					̵ӵ value 1
+					ݷ value 2
+					ġ value 3
+					ӽð value 0 ( )
+				*/
+				long time = item->GetValue(0);
+				long moveSpeedPer = item->GetValue(1);
+				long attPer = item->GetValue(2);
+				long expPer = item->GetValue(3);
+				AddAffect(AFFECT_RAMADAN_ABILITY, POINT_MOV_SPEED, moveSpeedPer, AFF_MOV_SPEED_POTION, time, 0, true, true);
+				AddAffect(AFFECT_RAMADAN_ABILITY, POINT_MALL_ATTBONUS, attPer, AFF_NONE, time, 0, true, true);
+				AddAffect(AFFECT_RAMADAN_ABILITY, POINT_MALL_EXPBONUS, expPer, AFF_NONE, time, 0, true, true);
+				item->SetCount(item->GetCount() - 1);
+			}
+			break;
 
-						// ũ 
-						case ITEM_NOG_POCKET:
+			case ITEM_MARRIAGE_RING:
+			{
+				marriage::TMarriage* pMarriage = marriage::CManager::instance().Get(GetPlayerID());
+				if (pMarriage)
+				{
+					if (pMarriage->ch1 != NULL)
+					{
+						if (CArenaManager::instance().IsArenaMap(pMarriage->ch1->GetMapIndex()) == true)
 						{
-							/*
-							ִɷġ : item_proto value ǹ
-								̵ӵ value 1
-								ݷ value 2
-								ġ value 3
-								ӽð value 0 ( )
-							*/
-							if (FindAffect(AFFECT_NOG_ABILITY))
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("̹ ȿ ɷ ֽϴ."));
-								return false;
-							}
-							long time = item->GetValue(0);
-							long moveSpeedPer = item->GetValue(1);
-							long attPer = item->GetValue(2);
-							long expPer = item->GetValue(3);
-							AddAffect(AFFECT_NOG_ABILITY, POINT_MOV_SPEED, moveSpeedPer, AFF_MOV_SPEED_POTION, time, 0, true, true);
-							AddAffect(AFFECT_NOG_ABILITY, POINT_MALL_ATTBONUS, attPer, AFF_NONE, time, 0, true, true);
-							AddAffect(AFFECT_NOG_ABILITY, POINT_MALL_EXPBONUS, expPer, AFF_NONE, time, 0, true, true);
-							item->SetCount(item->GetCount() - 1);
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ߿ ̿   ǰԴϴ."));
+							break;
 						}
-						break;
+					}
 
-						// 󸶴ܿ 
-						case ITEM_RAMADAN_CANDY:
+					if (pMarriage->ch2 != NULL)
+					{
+						if (CArenaManager::instance().IsArenaMap(pMarriage->ch2->GetMapIndex()) == true)
 						{
-							/*
-							ɷġ : item_proto value ǹ
-								̵ӵ value 1
-								ݷ value 2
-								ġ value 3
-								ӽð value 0 ( )
-							*/
-							if (FindAffect(AFFECT_RAMADAN_ABILITY))
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("̹ ȿ ɷ ֽϴ."));
-								return false;
-							}
-
-							long time = item->GetValue(0);
-							long moveSpeedPer = item->GetValue(1);
-							long attPer = item->GetValue(2);
-							long expPer = item->GetValue(3);
-							AddAffect(AFFECT_RAMADAN_ABILITY, POINT_MOV_SPEED, moveSpeedPer, AFF_MOV_SPEED_POTION, time, 0, true, true);
-							AddAffect(AFFECT_RAMADAN_ABILITY, POINT_MALL_ATTBONUS, attPer, AFF_NONE, time, 0, true, true);
-							AddAffect(AFFECT_RAMADAN_ABILITY, POINT_MALL_EXPBONUS, expPer, AFF_NONE, time, 0, true, true);
-							item->SetCount(item->GetCount() - 1);
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ߿ ̿   ǰԴϴ."));
+							break;
 						}
-						break;
-
-						case ITEM_MARRIAGE_RING:
-						{
-							marriage::TMarriage* pMarriage = marriage::CManager::instance().Get(GetPlayerID());
-							if (pMarriage)
-							{
-								if (pMarriage->ch1 != NULL)
-								{
-									if (CArenaManager::instance().IsArenaMap(pMarriage->ch1->GetMapIndex()))
-									{
-										ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ߿ ̿   ǰԴϴ."));
-										break;
-									}
-								}
-
-								if (pMarriage->ch2 != NULL)
-								{
-									if (CArenaManager::instance().IsArenaMap(pMarriage->ch2->GetMapIndex()))
-									{
-										ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ߿ ̿   ǰԴϴ."));
-										break;
-									}
-								}
+					}
 
-								int consumeSP = CalculateConsumeSP(this);
+					int consumeSP = CalculateConsumeSP(this);
 
-								if (consumeSP < 0)
-									return false;
+					if (consumeSP < 0)
+						return false;
 
-								PointChange(POINT_SP, -consumeSP, false);
+					PointChange(POINT_SP, -consumeSP, false);
 
-								WarpToPID(pMarriage->GetOther(GetPlayerID()));
-							}
-							else
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("ȥ ° ƴϸ ȥ   ϴ."));
-						}
-						break;
+					WarpToPID(pMarriage->GetOther(GetPlayerID()));
+				}
+				else
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ȥ ° ƴϸ ȥ   ϴ."));
+			}
+			break;
 
-						case ITEM_WHITE_FLAG:
-							ForgetMyAttacker();
-							item->SetCount(item->GetCount() - 1);
-							break;
+			//   
+			case UNIQUE_ITEM_CAPE_OF_COURAGE:
+				// 󸶴   
+			case 70057:
+			case REWARD_BOX_UNIQUE_ITEM_CAPE_OF_COURAGE:
+				AggregateMonster();
+				if (!g_bUnlimitedCapeOfCourage)
+					item->SetCount(item->GetCount() - 1);
+				break;
 
-						case 30093:
-						case 30094:
-						case 30095:
-						case 30096:
-							// ָӴ
-						{
-							const int MAX_BAG_INFO = 26;
-							static struct LuckyBagInfo
-							{
-								DWORD count;
-								int prob;
-								DWORD vnum;
-							} b1[MAX_BAG_INFO] =
-							{
-								{ 1000, 302, 1 },
-								{ 10, 150, 27002 },
-								{ 10, 75, 27003 },
-								{ 10, 100, 27005 },
-								{ 10, 50, 27006 },
-								{ 10, 80, 27001 },
-								{ 10, 50, 27002 },
-								{ 10, 80, 27004 },
-								{ 10, 50, 27005 },
-								{ 1, 10, ITEM_SKILLBOOK_VNUM },
-								{ 1, 6, 92 },
-								{ 1, 2, 132 },
-								{ 1, 6, 1052 },
-								{ 1, 2, 1092 },
-								{ 1, 6, 2082 },
-								{ 1, 2, 2122 },
-								{ 1, 6, 3082 },
-								{ 1, 2, 3122 },
-								{ 1, 6, 5052 },
-								{ 1, 2, 5082 },
-								{ 1, 6, 7082 },
-								{ 1, 2, 7122 },
-								{ 1, 1, 11282 },
-								{ 1, 1, 11482 },
-								{ 1, 1, 11682 },
-								{ 1, 1, 11882 },
-							};
+			case UNIQUE_ITEM_WHITE_FLAG:
+				ForgetMyAttacker();
+				item->SetCount(item->GetCount() - 1);
+				break;
 
-							struct LuckyBagInfo b2[MAX_BAG_INFO] =
-							{
-								{ 1000, 302, 1 },
-								{ 10, 150, 27002 },
-								{ 10, 75, 27002 },
-								{ 10, 100, 27005 },
-								{ 10, 50, 27005 },
-								{ 10, 80, 27001 },
-								{ 10, 50, 27002 },
-								{ 10, 80, 27004 },
-								{ 10, 50, 27005 },
-								{ 1, 10, ITEM_SKILLBOOK_VNUM },
-								{ 1, 6, 92 },
-								{ 1, 2, 132 },
-								{ 1, 6, 1052 },
-								{ 1, 2, 1092 },
-								{ 1, 6, 2082 },
-								{ 1, 2, 2122 },
-								{ 1, 6, 3082 },
-								{ 1, 2, 3122 },
-								{ 1, 6, 5052 },
-								{ 1, 2, 5082 },
-								{ 1, 6, 7082 },
-								{ 1, 2, 7122 },
-								{ 1, 1, 11282 },
-								{ 1, 1, 11482 },
-								{ 1, 1, 11682 },
-								{ 1, 1, 11882 },
-							};
-
-							LuckyBagInfo* bi = NULL;
-							if (LC_IsHongKong())
-								bi = b2;
-							else
-								bi = b1;
+			case UNIQUE_ITEM_TREASURE_BOX:
+				break;
 
-							int pct = number(1, 1000);
+			case 30093:
+			case 30094:
+			case 30095:
+			case 30096:
+				// ָӴ
+			{
+				const int MAX_BAG_INFO = 26;
+				static struct LuckyBagInfo
+				{
+					DWORD count;
+					int prob;
+					DWORD vnum;
+				} b1[MAX_BAG_INFO] =
+				{
+					{ 1000, 302, 1 },
+					{ 10, 150, 27002 },
+					{ 10, 75, 27003 },
+					{ 10, 100, 27005 },
+					{ 10, 50, 27006 },
+					{ 10, 80, 27001 },
+					{ 10, 50, 27002 },
+					{ 10, 80, 27004 },
+					{ 10, 50, 27005 },
+					{ 1, 10, 50300 },
+					{ 1, 6, 92 },
+					{ 1, 2, 132 },
+					{ 1, 6, 1052 },
+					{ 1, 2, 1092 },
+					{ 1, 6, 2082 },
+					{ 1, 2, 2122 },
+					{ 1, 6, 3082 },
+					{ 1, 2, 3122 },
+					{ 1, 6, 5052 },
+					{ 1, 2, 5082 },
+					{ 1, 6, 7082 },
+					{ 1, 2, 7122 },
+					{ 1, 1, 11282 },
+					{ 1, 1, 11482 },
+					{ 1, 1, 11682 },
+					{ 1, 1, 11882 },
+				};
+
+				struct LuckyBagInfo b2[MAX_BAG_INFO] =
+				{
+					{ 1000, 302, 1 },
+					{ 10, 150, 27002 },
+					{ 10, 75, 27002 },
+					{ 10, 100, 27005 },
+					{ 10, 50, 27005 },
+					{ 10, 80, 27001 },
+					{ 10, 50, 27002 },
+					{ 10, 80, 27004 },
+					{ 10, 50, 27005 },
+					{ 1, 10, 50300 },
+					{ 1, 6, 92 },
+					{ 1, 2, 132 },
+					{ 1, 6, 1052 },
+					{ 1, 2, 1092 },
+					{ 1, 6, 2082 },
+					{ 1, 2, 2122 },
+					{ 1, 6, 3082 },
+					{ 1, 2, 3122 },
+					{ 1, 6, 5052 },
+					{ 1, 2, 5082 },
+					{ 1, 6, 7082 },
+					{ 1, 2, 7122 },
+					{ 1, 1, 11282 },
+					{ 1, 1, 11482 },
+					{ 1, 1, 11682 },
+					{ 1, 1, 11882 },
+				};
+
+				LuckyBagInfo* bi = NULL;
+				if (LC_IsHongKong())
+					bi = b2;
+				else
+					bi = b1;
 
-							int i;
-							for (i = 0; i < MAX_BAG_INFO; i++)
-							{
-								if (pct <= bi[i].prob)
-									break;
-								pct -= bi[i].prob;
-							}
-							if (i >= MAX_BAG_INFO)
-								return false;
+				int pct = number(1, 1000);
 
-							if (bi[i].vnum == ITEM_SKILLBOOK_VNUM)
-							{
-								// ųü Ưϰ ش.
-								GiveRandomSkillBook();
-							}
-							else if (bi[i].vnum == 1)
-							{
-								PointChange(POINT_GOLD, 1000, true);
-							}
-							else
-							{
-								AutoGiveItem(bi[i].vnum, bi[i].count);
-							}
-							ITEM_MANAGER::instance().RemoveItem(item);
-						}
+				int i;
+				for (i = 0; i < MAX_BAG_INFO; i++)
+				{
+					if (pct <= bi[i].prob)
 						break;
+					pct -= bi[i].prob;
+				}
+				if (i >= MAX_BAG_INFO)
+					return false;
 
-						case 50004: // ̺Ʈ 
-						{
-							if (item->GetSocket(0))
-							{
-								item->SetSocket(0, item->GetSocket(0) + 1);
-							}
-							else
-							{
-								// ó 
-								int iMapIndex = GetMapIndex();
-
-								PIXEL_POSITION pos;
-
-								if (SECTREE_MANAGER::instance().GetRandomLocation(iMapIndex, pos, 700))
-								{
-									item->SetSocket(0, 1);
-									item->SetSocket(1, pos.x);
-									item->SetSocket(2, pos.y);
-								}
-								else
-								{
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING("  ̺Ʈ Ⱑ  ʴ° ϴ."));
-									return false;
-								}
-							}
-
-							int dist = 0;
-							float distance = (DISTANCE_SQRT(GetX() - item->GetSocket(1), GetY() - item->GetSocket(2)));
-
-							if (distance < 1000.0f)
-							{
-								// ߰!
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("̺Ʈ Ⱑ źο   ϴ."));
-
-								// Ƚ  ִ  ٸ Ѵ.
-								struct TEventStoneInfo
-								{
-									DWORD dwVnum;
-									int count;
-									int prob;
-								};
-								const int EVENT_STONE_MAX_INFO = 15;
-								TEventStoneInfo info_10[EVENT_STONE_MAX_INFO] =
-								{
-									{ 27001, 10, 8 },
-									{ 27004, 10, 6 },
-									{ 27002, 10, 12 },
-									{ 27005, 10, 12 },
-									{ 27100, 1, 9 },
-									{ 27103, 1, 9 },
-									{ 27101, 1, 10 },
-									{ 27104, 1, 10 },
-									{ 27999, 1, 12 },
-
-									{ 25040, 1, 4 },
-
-									{ 27410, 1, 0 },
-									{ 27600, 1, 0 },
-									{ 25100, 1, 0 },
-
-									{ 50001, 1, 0 },
-									{ 50003, 1, 1 },
-								};
-								TEventStoneInfo info_7[EVENT_STONE_MAX_INFO] =
-								{
-									{ 27001, 10, 1 },
-									{ 27004, 10, 1 },
-									{ 27004, 10, 9 },
-									{ 27005, 10, 9 },
-									{ 27100, 1, 5 },
-									{ 27103, 1, 5 },
-									{ 27101, 1, 10 },
-									{ 27104, 1, 10 },
-									{ 27999, 1, 14 },
-
-									{ 25040, 1, 5 },
-
-									{ 27410, 1, 5 },
-									{ 27600, 1, 5 },
-									{ 25100, 1, 5 },
-
-									{ 50001, 1, 0 },
-									{ 50003, 1, 5 },
-
-								};
-								TEventStoneInfo info_4[EVENT_STONE_MAX_INFO] =
-								{
-									{ 27001, 10, 0 },
-									{ 27004, 10, 0 },
-									{ 27002, 10, 0 },
-									{ 27005, 10, 0 },
-									{ 27100, 1, 0 },
-									{ 27103, 1, 0 },
-									{ 27101, 1, 0 },
-									{ 27104, 1, 0 },
-									{ 27999, 1, 25 },
-
-									{ 25040, 1, 0 },
-
-									{ 27410, 1, 0 },
-									{ 27600, 1, 0 },
-									{ 25100, 1, 15 },
+				if (bi[i].vnum == 50300)
+				{
+					// ųü Ưϰ ش.
+					GiveRandomSkillBook();
+				}
+				else if (bi[i].vnum == 1)
+				{
+					PointChange(POINT_GOLD, 1000, true);
+				}
+				else
+				{
+					AutoGiveItem(bi[i].vnum, bi[i].count);
+				}
+				ITEM_MANAGER::instance().RemoveItem(item);
+			}
+			break;
 
-									{ 50001, 1, 10 },
-									{ 50003, 1, 50 },
+			case 50004: // ̺Ʈ 
+			{
+				if (item->GetSocket(0))
+				{
+					item->SetSocket(0, item->GetSocket(0) + 1);
+				}
+				else
+				{
+					// ó 
+					int iMapIndex = GetMapIndex();
 
-								};
+					PIXEL_POSITION pos;
 
-								{
-									TEventStoneInfo* info;
-									if (item->GetSocket(0) <= 4)
-										info = info_4;
-									else if (item->GetSocket(0) <= 7)
-										info = info_7;
-									else
-										info = info_10;
-
-									int prob = number(1, 100);
-
-									for (int i = 0; i < EVENT_STONE_MAX_INFO; ++i)
-									{
-										if (!info[i].prob)
-											continue;
-
-										if (prob <= info[i].prob)
-										{
-											if (info[i].dwVnum == 50001)
-											{
-												DWORD* pdw = M2_NEW DWORD[2];
-
-												pdw[0] = info[i].dwVnum;
-												pdw[1] = info[i].count;
-
-												// ÷  Ѵ
-												DBManager::instance().ReturnQuery(QID_LOTTO, GetPlayerID(), pdw,
-													"INSERT INTO lotto_list VALUES(0, 'server%s', %u, NOW())",
-													get_table_postfix(), GetPlayerID());
-											}
-											else
-												AutoGiveItem(info[i].dwVnum, info[i].count);
-
-											break;
-										}
-										prob -= info[i].prob;
-									}
-								}
+					if (SECTREE_MANAGER::instance().GetRandomLocation(iMapIndex, pos, 700))
+					{
+						item->SetSocket(0, 1);
+						item->SetSocket(1, pos.x);
+						item->SetSocket(2, pos.y);
+					}
+					else
+					{
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ̺Ʈ Ⱑ  ʴ° ϴ."));
+						return false;
+					}
+				}
 
-								char chatbuf[CHAT_MAX_LEN + 1];
-								int len = snprintf(chatbuf, sizeof(chatbuf), "StoneDetect %u 0 0", (DWORD)GetVID());
+				int dist = 0;
+				float distance = (DISTANCE_SQRT(GetX() - item->GetSocket(1), GetY() - item->GetSocket(2)));
 
-								if (len < 0 || len >= (int)sizeof(chatbuf))
-									len = sizeof(chatbuf) - 1;
+				if (distance < 1000.0f)
+				{
+					// ߰!
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̺Ʈ Ⱑ źο   ϴ."));
 
-								++len; // \0 ڱ 
+					// Ƚ  ִ  ٸ Ѵ.
+					struct TEventStoneInfo
+					{
+						DWORD dwVnum;
+						int count;
+						int prob;
+					};
+					const int EVENT_STONE_MAX_INFO = 15;
+					TEventStoneInfo info_10[EVENT_STONE_MAX_INFO] =
+					{
+						{ 27001, 10, 8 },
+						{ 27004, 10, 6 },
+						{ 27002, 10, 12 },
+						{ 27005, 10, 12 },
+						{ 27100, 1, 9 },
+						{ 27103, 1, 9 },
+						{ 27101, 1, 10 },
+						{ 27104, 1, 10 },
+						{ 27999, 1, 12 },
+
+						{ 25040, 1, 4 },
+
+						{ 27410, 1, 0 },
+						{ 27600, 1, 0 },
+						{ 25100, 1, 0 },
 
-								TPacketGCChat pack_chat;
-								pack_chat.header = HEADER_GC_CHAT;
-								pack_chat.size = sizeof(TPacketGCChat) + len;
-								pack_chat.type = CHAT_TYPE_COMMAND;
-								pack_chat.id = 0;
-								pack_chat.bEmpire = GetDesc()->GetEmpire();
-								//pack_chat.id = vid;
+						{ 50001, 1, 0 },
+						{ 50003, 1, 1 },
+					};
+					TEventStoneInfo info_7[EVENT_STONE_MAX_INFO] =
+					{
+						{ 27001, 10, 1 },
+						{ 27004, 10, 1 },
+						{ 27004, 10, 9 },
+						{ 27005, 10, 9 },
+						{ 27100, 1, 5 },
+						{ 27103, 1, 5 },
+						{ 27101, 1, 10 },
+						{ 27104, 1, 10 },
+						{ 27999, 1, 14 },
+
+						{ 25040, 1, 5 },
+
+						{ 27410, 1, 5 },
+						{ 27600, 1, 5 },
+						{ 25100, 1, 5 },
 
-								TEMP_BUFFER buf;
-								buf.write(&pack_chat, sizeof(TPacketGCChat));
-								buf.write(chatbuf, len);
+						{ 50001, 1, 0 },
+						{ 50003, 1, 5 },
 
-								PacketAround(buf.read_peek(), buf.size());
+					};
+					TEventStoneInfo info_4[EVENT_STONE_MAX_INFO] =
+					{
+						{ 27001, 10, 0 },
+						{ 27004, 10, 0 },
+						{ 27002, 10, 0 },
+						{ 27005, 10, 0 },
+						{ 27100, 1, 0 },
+						{ 27103, 1, 0 },
+						{ 27101, 1, 0 },
+						{ 27104, 1, 0 },
+						{ 27999, 1, 25 },
+
+						{ 25040, 1, 0 },
+
+						{ 27410, 1, 0 },
+						{ 27600, 1, 0 },
+						{ 25100, 1, 15 },
 
-								ITEM_MANAGER::instance().RemoveItem(item, "REMOVE (DETECT_EVENT_STONE) 1");
-								return true;
-							}
-							else if (distance < 20000)
-								dist = 1;
-							else if (distance < 70000)
-								dist = 2;
-							else
-								dist = 3;
+						{ 50001, 1, 10 },
+						{ 50003, 1, 50 },
 
-							//   .
-							const int STONE_DETECT_MAX_TRY = 10;
-							if (item->GetSocket(0) >= STONE_DETECT_MAX_TRY)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("̺Ʈ Ⱑ   ϴ."));
-								ITEM_MANAGER::instance().RemoveItem(item, "REMOVE (DETECT_EVENT_STONE) 0");
-								AutoGiveItem(27002);
-								return true;
-							}
+					};
 
-							if (dist)
-							{
-								char chatbuf[CHAT_MAX_LEN + 1];
-								int len = snprintf(chatbuf, sizeof(chatbuf),
-									"StoneDetect %u %d %d",
-									(DWORD)GetVID(), dist, (int)GetDegreeFromPositionXY(GetX(), item->GetSocket(2), item->GetSocket(1), GetY()));
-
-								if (len < 0 || len >= (int)sizeof(chatbuf))
-									len = sizeof(chatbuf) - 1;
-
-								++len; // \0 ڱ 
-
-								TPacketGCChat pack_chat;
-								pack_chat.header = HEADER_GC_CHAT;
-								pack_chat.size = sizeof(TPacketGCChat) + len;
-								pack_chat.type = CHAT_TYPE_COMMAND;
-								pack_chat.id = 0;
-								pack_chat.bEmpire = GetDesc()->GetEmpire();
-								//pack_chat.id = vid;
-
-								TEMP_BUFFER buf;
-								buf.write(&pack_chat, sizeof(TPacketGCChat));
-								buf.write(chatbuf, len);
+					{
+						TEventStoneInfo* info;
+						if (item->GetSocket(0) <= 4)
+							info = info_4;
+						else if (item->GetSocket(0) <= 7)
+							info = info_7;
+						else
+							info = info_10;
 
-								PacketAround(buf.read_peek(), buf.size());
-							}
-						}
-						break;
+						int prob = number(1, 100);
 
-						case 27989: // 
-						case 76006: //  
+						for (int i = 0; i < EVENT_STONE_MAX_INFO; ++i)
 						{
-							LPSECTREE_MAP pMap = SECTREE_MANAGER::instance().GetMap(GetMapIndex());
+							if (!info[i].prob)
+								continue;
 
-							if (pMap != NULL)
+							if (prob <= info[i].prob)
 							{
-								item->SetSocket(0, item->GetSocket(0) + 1);
-
-								FFindStone f;
-
-								// <Factor> SECTREE::for_each -> SECTREE::for_each_entity
-								pMap->for_each(f);
-
-								if (f.m_mapStone.size() > 0)
+								if (info[i].dwVnum == 50001)
 								{
-									std::map<DWORD, LPCHARACTER>::iterator stone = f.m_mapStone.begin();
+									DWORD* pdw = M2_NEW DWORD[2];
 
-									DWORD max = UINT_MAX;
-									LPCHARACTER pTarget = stone->second;
+									pdw[0] = info[i].dwVnum;
+									pdw[1] = info[i].count;
 
-									while (stone != f.m_mapStone.end())
-									{
-										DWORD dist = (DWORD)DISTANCE_SQRT(GetX() - stone->second->GetX(), GetY() - stone->second->GetY());
-
-										if (dist != 0 && max > dist)
-										{
-											max = dist;
-											pTarget = stone->second;
-										}
-										stone++;
-									}
-
-									if (pTarget != NULL)
-									{
-										int val = 3;
-
-										if (max < 10000) val = 2;
-										else if (max < 70000) val = 1;
-
-										ChatPacket(CHAT_TYPE_COMMAND, "StoneDetect %u %d %d", (DWORD)GetVID(), val,
-											(int)GetDegreeFromPositionXY(GetX(), pTarget->GetY(), pTarget->GetX(), GetY()));
-									}
-									else
-									{
-										ChatPacket(CHAT_TYPE_INFO, LC_STRING("⸦ ۿϿ Ǵ  ϴ."));
-									}
+									// ÷  Ѵ
+									DBManager::instance().ReturnQuery(QID_LOTTO, GetPlayerID(), pdw,
+										"INSERT INTO lotto_list VALUES(0, 'server%s', %u, NOW())",
+										get_table_postfix(), GetPlayerID());
 								}
 								else
-								{
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING("⸦ ۿϿ Ǵ  ϴ."));
-								}
+									AutoGiveItem(info[i].dwVnum, info[i].count);
 
-								if (item->GetSocket(0) >= 6)
-								{
-									ChatPacket(CHAT_TYPE_COMMAND, "StoneDetect %u 0 0", (DWORD)GetVID());
-									ITEM_MANAGER::instance().RemoveItem(item);
-								}
+								break;
 							}
-							break;
+							prob -= info[i].prob;
 						}
-						break;
+					}
 
-#if defined(__MT_THUNDER_DUNGEON__)
-						case 79602:
-						{
-							if (GetMapIndex() != CMTThunderDungeon::MAP_INDEX)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("This action is not possible on this map."));
-								return false;
-							}
+					char chatbuf[CHAT_MAX_LEN + 1];
+					int len = snprintf(chatbuf, sizeof(chatbuf), "StoneDetect %u 0 0", (DWORD)GetVID());
 
-							LPSECTREE_MAP pMap = SECTREE_MANAGER::instance().GetMap(GetMapIndex());
+					if (len < 0 || len >= (int)sizeof(chatbuf))
+						len = sizeof(chatbuf) - 1;
 
-							if (pMap != NULL)
-							{
-								item->SetSocket(0, item->GetSocket(0) + 1);
+					++len; // \0 ڱ 
 
-								FFindMobVnum f(6405);
+					TPacketGCChat pack_chat;
+					pack_chat.header = HEADER_GC_CHAT;
+					pack_chat.size = sizeof(TPacketGCChat) + len;
+					pack_chat.type = CHAT_TYPE_COMMAND;
+					pack_chat.id = 0;
+					pack_chat.bEmpire = GetDesc()->GetEmpire();
+					//pack_chat.id = vid;
 
-								// <Factor> SECTREE::for_each -> SECTREE::for_each_entity
-								pMap->for_each(f);
+					TEMP_BUFFER buf;
+					buf.write(&pack_chat, sizeof(TPacketGCChat));
+					buf.write(chatbuf, len);
 
-								if (f.m_mapVID.size() > 0)
-								{
-									std::map<DWORD, LPCHARACTER>::iterator it = f.m_mapVID.begin();
+					PacketAround(buf.read_peek(), buf.size());
 
-									DWORD max = UINT_MAX;
-									LPCHARACTER pTarget = it->second;
+					ITEM_MANAGER::instance().RemoveItem(item, "REMOVE (DETECT_EVENT_STONE) 1");
+					return true;
+				}
+				else if (distance < 20000)
+					dist = 1;
+				else if (distance < 70000)
+					dist = 2;
+				else
+					dist = 3;
 
-									while (it != f.m_mapVID.end())
-									{
-										DWORD dist = (DWORD)DISTANCE_SQRT(GetX() - it->second->GetX(), GetY() - it->second->GetY());
-
-										if (dist != 0 && max > dist)
-										{
-											max = dist;
-											pTarget = it->second;
-										}
-										it++;
-									}
-
-									if (pTarget != NULL)
-									{
-										int val = 3;
-
-										if (max < 10000) val = 2;
-										else if (max < 70000) val = 1;
-
-										ChatPacket(CHAT_TYPE_COMMAND, "StoneDetect %u %d %d", (DWORD)GetVID(), val,
-											(int)GetDegreeFromPositionXY(GetX(), pTarget->GetY(), pTarget->GetX(), GetY()));
-									}
-									else
-									{
-										ChatPacket(CHAT_TYPE_INFO, LC_STRING("The Compass was used, but the Guard wasnt found."));
-									}
-								}
-								else
-								{
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING("The Compass was used, but the Guard wasnt found."));
-								}
+				//   .
+				const int STONE_DETECT_MAX_TRY = 10;
+				if (item->GetSocket(0) >= STONE_DETECT_MAX_TRY)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̺Ʈ Ⱑ   ϴ."));
+					ITEM_MANAGER::instance().RemoveItem(item, "REMOVE (DETECT_EVENT_STONE) 0");
+					AutoGiveItem(27002);
+					return true;
+				}
 
-								if (item->GetSocket(0) >= 6)
-								{
-									ChatPacket(CHAT_TYPE_COMMAND, "StoneDetect %u 0 0", (DWORD)GetVID());
-									ITEM_MANAGER::instance().RemoveItem(item);
-								}
-							}
-						}
-						break;
-#endif
+				if (dist)
+				{
+					char chatbuf[CHAT_MAX_LEN + 1];
+					int len = snprintf(chatbuf, sizeof(chatbuf),
+						"StoneDetect %u %d %d",
+						(DWORD)GetVID(), dist, (int)GetDegreeFromPositionXY(GetX(), item->GetSocket(2), item->GetSocket(1), GetY()));
 
-						case 27996: // 
-							item->SetCount(item->GetCount() - 1);
-							/*
-							if (GetSkillLevel(SKILL_CREATE_POISON))
-								AddAffect(AFFECT_ATT_GRADE, POINT_ATT_GRADE, 3, AFF_DRINK_POISON, 15 * 60, 0, true);
-							else
-							{
-								// ٷⰡ  50%  50% ݷ +2
-								if (number(0, 1))
-								{
-									if (GetHP() > 100)
-										PointChange(POINT_HP, -(GetHP() - 1));
-									else
-										Dead();
-								}
-								else
-									AddAffect(AFFECT_ATT_GRADE, POINT_ATT_GRADE, 2, AFF_DRINK_POISON, 15 * 60, 0, true);
-							}
-							*/
-							break;
+					if (len < 0 || len >= (int)sizeof(chatbuf))
+						len = sizeof(chatbuf) - 1;
 
-						case fishing::SHELLFISH_VNUM: // 
-							// 50  47990
-							// 30 
-							// 10  47992
-							// 7 û 47993
-							// 3  47994
-						{
-							item->SetCount(item->GetCount() - 1);
+					++len; // \0 ڱ 
 
-							int r = number(1, 100);
+					TPacketGCChat pack_chat;
+					pack_chat.header = HEADER_GC_CHAT;
+					pack_chat.size = sizeof(TPacketGCChat) + len;
+					pack_chat.type = CHAT_TYPE_COMMAND;
+					pack_chat.id = 0;
+					pack_chat.bEmpire = GetDesc()->GetEmpire();
+					//pack_chat.id = vid;
 
-							if (r <= 50)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("  Խϴ."));
-								AutoGiveItem(fishing::STONEPIECE_VNUM);
-							}
-							else
-							{
-								const int prob_table_euckr[] =
-								{
-									80, 90, 97
-								};
+					TEMP_BUFFER buf;
+					buf.write(&pack_chat, sizeof(TPacketGCChat));
+					buf.write(chatbuf, len);
 
-								const int prob_table_gb2312[] =
-								{
-									95, 97, 99
-								};
+					PacketAround(buf.read_peek(), buf.size());
+				}
+			}
+			break;
 
-								const int* prob_table = !g_iUseLocale ? prob_table_euckr : prob_table_gb2312;
+			case 27989: // 
+			case 76006: //  
+			{
+				LPSECTREE_MAP pMap = SECTREE_MANAGER::instance().GetMap(GetMapIndex());
 
-								if (r <= prob_table[0])
-								{
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING("   ϴ."));
-								}
-								else if (r <= prob_table[1])
-								{
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ְ Խϴ."));
-									AutoGiveItem(fishing::WHITE_PEARL_VNUM);
-								}
-								else if (r <= prob_table[2])
-								{
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ûְ Խϴ."));
-									AutoGiveItem(fishing::BLUE_PEARL_VNUM);
-								}
-								else
-								{
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ְ Խϴ."));
-									AutoGiveItem(fishing::RED_PEARL_VNUM);
-								}
-							}
-						}
-						break;
+				if (pMap != NULL)
+				{
+					item->SetSocket(0, item->GetSocket(0) + 1);
 
-						case 71013: // 
-							CreateFly(number(FLY_FIREWORK1, FLY_FIREWORK6), this);
-							item->SetCount(item->GetCount() - 1);
-							break;
+					FFindStone f;
 
-						case 50100: // 
-						case 50101:
-						case 50102:
-						case 50103:
-						case 50104:
-						case 50105:
-						case 50106:
-							CreateFly(item->GetVnum() - 50100 + FLY_FIREWORK1, this);
-							item->SetCount(item->GetCount() - 1);
-							break;
+					// <Factor> SECTREE::for_each -> SECTREE::for_each_entity
+					pMap->for_each(f);
 
-						case 50200: // 
-						{
-							if (LC_IsYMIR() == true || LC_IsKorea() == true)
-							{
-								if (IS_BOTARYABLE_ZONE(GetMapIndex()) == true)
-								{
-									__OpenPrivateShop();
-								}
-								else
-								{
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING("     Դϴ"));
-								}
-							}
-							else
-							{
-								__OpenPrivateShop();
-							}
-						}
-						break;
+					if (f.m_mapStone.size() > 0)
+					{
+						std::map<DWORD, LPCHARACTER>::iterator stone = f.m_mapStone.begin();
 
-						case fishing::FISH_MIND_PILL_VNUM:
-							AddAffect(AFFECT_FISH_MIND_PILL, POINT_NONE, 0, AFF_FISH_MIND, 20 * 60, 0, true);
-							item->SetCount(item->GetCount() - 1);
-							break;
+						DWORD max = UINT_MAX;
+						LPCHARACTER pTarget = stone->second;
 
-						case 50301: // ַ ü
-						case 50302:
-						case 50303:
+						while (stone != f.m_mapStone.end())
 						{
-							if (IsPolymorphed() == true)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("а ߿ ɷ ø  ϴ."));
-								return false;
-							}
+							DWORD dist = (DWORD)DISTANCE_SQRT(GetX() - stone->second->GetX(), GetY() - stone->second->GetY());
 
-							int lv = GetSkillLevel(SKILL_LEADERSHIP);
-
-							if (lv < item->GetValue(0))
+							if (dist != 0 && max > dist)
 							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" å ʹ  ϱⰡ ϴ."));
-								return false;
-							}
-
-							if (lv >= item->GetValue(1))
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" å ƹ      ʽϴ."));
-								return false;
+								max = dist;
+								pTarget = stone->second;
 							}
+							stone++;
+						}
 
-							if (LearnSkillByBook(SKILL_LEADERSHIP))
-							{
-								item->SetCount(item->GetCount() - 1);
+						if (pTarget != NULL)
+						{
+							int val = 3;
 
-								int iReadDelay = number(SKILLBOOK_DELAY_MIN, SKILLBOOK_DELAY_MAX);
-								if (distribution_test_server) iReadDelay /= 3;
+							if (max < 10000) val = 2;
+							else if (max < 70000) val = 1;
 
-								SetSkillNextReadTime(SKILL_LEADERSHIP, get_global_time() + iReadDelay);
-							}
+							ChatPacket(CHAT_TYPE_COMMAND, "StoneDetect %u %d %d", (DWORD)GetVID(), val,
+								(int)GetDegreeFromPositionXY(GetX(), pTarget->GetY(), pTarget->GetX(), GetY()));
 						}
-						break;
-
-						case 50304: //  ü
-						case 50305:
-						case 50306:
+						else
 						{
-							if (IsPolymorphed())
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("߿ å  ϴ."));
-								return false;
-							}
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("⸦ ۿϿ Ǵ  ϴ."));
+						}
+					}
+					else
+					{
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("⸦ ۿϿ Ǵ  ϴ."));
+					}
 
-							if (GetSkillLevel(SKILL_COMBO) == 0 && GetLevel() < 30)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" 30 Ǳ       ʽϴ."));
-								return false;
-							}
+					if (item->GetSocket(0) >= 6)
+					{
+						ChatPacket(CHAT_TYPE_COMMAND, "StoneDetect %u 0 0", (DWORD)GetVID());
+						ITEM_MANAGER::instance().RemoveItem(item);
+					}
+				}
+				break;
+			}
+			break;
 
-							if (GetSkillLevel(SKILL_COMBO) == 1 && GetLevel() < 50)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" 50 Ǳ       ʽϴ."));
-								return false;
-							}
+			case 27996: // 
+				item->SetCount(item->GetCount() - 1);
+				/*
+				if (GetSkillLevel(SKILL_CREATE_POISON))
+					AddAffect(AFFECT_ATT_GRADE, POINT_ATT_GRADE, 3, AFF_DRINK_POISON, 15 * 60, 0, true);
+				else
+				{
+					// ٷⰡ  50%  50% ݷ +2
+					if (number(0, 1))
+					{
+						if (GetHP() > 100)
+							PointChange(POINT_HP, -(GetHP() - 1));
+						else
+							Dead();
+					}
+					else
+						AddAffect(AFFECT_ATT_GRADE, POINT_ATT_GRADE, 2, AFF_DRINK_POISON, 15 * 60, 0, true);
+				}
+				*/
+				break;
 
-							if (GetSkillLevel(SKILL_COMBO) >= 2)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ̻   ϴ."));
-								return false;
-							}
+#if defined(__PRIVATE_SHOP_SEARCH_SYSTEM__)
+			case 60004:
+				ChatPacket(CHAT_TYPE_COMMAND, "OpenShopSearch 0");
+				break;
 
-							int iPct = item->GetValue(0);
+			case 60005:
+				ChatPacket(CHAT_TYPE_COMMAND, "OpenShopSearch 1");
+				break;
+#endif
 
-							if (LearnSkillByBook(SKILL_COMBO, iPct))
-							{
-								item->SetCount(item->GetCount() - 1);
+			case 27987: // 
+				// 50  47990
+				// 30 
+				// 10  47992
+				// 7 û 47993
+				// 3  47994
+			{
+				item->SetCount(item->GetCount() - 1);
 
-								int iReadDelay = number(SKILLBOOK_DELAY_MIN, SKILLBOOK_DELAY_MAX);
-								if (distribution_test_server) iReadDelay /= 3;
+				int r = number(1, 100);
 
-								SetSkillNextReadTime(SKILL_COMBO, get_global_time() + iReadDelay);
-							}
-						}
-						break;
+				if (r <= 50)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  Խϴ."));
+					AutoGiveItem(27990);
+				}
+				else
+				{
+					const int prob_table_euckr[] =
+					{
+						80, 90, 97
+					};
 
-						case 50311: //  ü
-						case 50312:
-						case 50313:
-						{
-							if (IsPolymorphed())
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("߿ å  ϴ."));
-								return false;
-							}
+					const int prob_table_gb2312[] =
+					{
+						95, 97, 99
+					};
 
-							DWORD dwSkillVnum = item->GetValue(0);
-							int iPct = MINMAX(0, item->GetValue(1), 100);
-							if (GetSkillLevel(dwSkillVnum) >= 20 || dwSkillVnum - SKILL_LANGUAGE1 + 1 == GetEmpire())
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("̹ Ϻϰ ˾Ƶ  ִ ̴."));
-								return false;
-							}
+					const int* prob_table = !g_iUseLocale ? prob_table_euckr : prob_table_gb2312;
 
-							if (LearnSkillByBook(dwSkillVnum, iPct))
-							{
-								item->SetCount(item->GetCount() - 1);
+					if (r <= prob_table[0])
+					{
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("   ϴ."));
+					}
+					else if (r <= prob_table[1])
+					{
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ְ Խϴ."));
+						AutoGiveItem(27992);
+					}
+					else if (r <= prob_table[2])
+					{
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ûְ Խϴ."));
+						AutoGiveItem(27993);
+					}
+					else
+					{
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ְ Խϴ."));
+						AutoGiveItem(27994);
+					}
+				}
+			}
+			break;
 
-								int iReadDelay = number(SKILLBOOK_DELAY_MIN, SKILLBOOK_DELAY_MAX);
-								if (distribution_test_server) iReadDelay /= 3;
+			case 71013: // 
+				CreateFly(number(FLY_FIREWORK1, FLY_FIREWORK6), this);
+				item->SetCount(item->GetCount() - 1);
+				break;
 
-								SetSkillNextReadTime(dwSkillVnum, get_global_time() + iReadDelay);
-							}
-						}
-						break;
+			case 50100: // 
+			case 50101:
+			case 50102:
+			case 50103:
+			case 50104:
+			case 50105:
+			case 50106:
+				CreateFly(item->GetVnum() - 50100 + FLY_FIREWORK1, this);
+				item->SetCount(item->GetCount() - 1);
+				break;
 
-						case 50061: // Ϻ  ȯ ų ü
-						{
-							if (IsPolymorphed())
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("߿ å  ϴ."));
-								return false;
-							}
+			case 50200: // 
+				if (LC_IsYMIR() == true || LC_IsKorea() == true)
+				{
+					if (IS_BOTARYABLE_ZONE(GetMapIndex()) == true)
+					{
+						__OpenPrivateShop();
+					}
+					else
+					{
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("     Դϴ"));
+					}
+				}
+				else
+				{
+					__OpenPrivateShop();
+				}
+				break;
 
-							DWORD dwSkillVnum = item->GetValue(0);
-							int iPct = MINMAX(0, item->GetValue(1), 100);
+			case fishing::FISH_MIND_PILL_VNUM:
+				AddAffect(AFFECT_FISH_MIND_PILL, POINT_NONE, 0, AFF_FISH_MIND, 20 * 60, 0, true);
+				item->SetCount(item->GetCount() - 1);
+				break;
 
-							if (GetSkillLevel(dwSkillVnum) >= 10)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ̻   ϴ."));
-								return false;
-							}
+			case 50301: // ַ ü
+			case 50302:
+			case 50303:
+			{
+				if (IsPolymorphed() == true)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("а ߿ ɷ ø  ϴ."));
+					return false;
+				}
 
-							if (LearnSkillByBook(dwSkillVnum, iPct))
-							{
-								item->SetCount(item->GetCount() - 1);
+				int lv = GetSkillLevel(SKILL_LEADERSHIP);
 
-								int iReadDelay = number(SKILLBOOK_DELAY_MIN, SKILLBOOK_DELAY_MAX);
-								if (distribution_test_server) iReadDelay /= 3;
+				if (lv < item->GetValue(0))
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" å ʹ  ϱⰡ ϴ."));
+					return false;
+				}
 
-								SetSkillNextReadTime(dwSkillVnum, get_global_time() + iReadDelay);
-							}
-						}
-						break;
+				if (lv >= item->GetValue(1))
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" å ƹ      ʽϴ."));
+					return false;
+				}
 
-						// LEARNABLE_SKILL_BOOKS_BY_LEVEL
-						case 50314: case 50315: case 50316: //  ü
-						case 50325: // Book of Precision
-						{
-							if (IsPolymorphed() == true)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("а ߿ ɷ ø  ϴ."));
-								return false;
-							}
+				if (LearnSkillByBook(SKILL_LEADERSHIP))
+				{
+					item->SetCount(item->GetCount() - 1);
 
-							int iSkillLevelLowLimit = item->GetValue(0);
-							int iSkillLevelHighLimit = item->GetValue(1);
-							int iPct = MINMAX(0, item->GetValue(2), 100);
-							int iLevelLimit = item->GetValue(3);
-							DWORD dwSkillVnum = 0;
+					int iReadDelay = number(SKILLBOOK_DELAY_MIN, SKILLBOOK_DELAY_MAX);
+					if (distribution_test_server) iReadDelay /= 3;
 
-							switch (item->GetVnum())
-							{
-								case 50314: case 50315: case 50316:
-									dwSkillVnum = SKILL_POLYMORPH;
-									break;
+					SetSkillNextReadTime(SKILL_LEADERSHIP, get_global_time() + iReadDelay);
+				}
+			}
+			break;
 
-#if defined(__CONQUEROR_LEVEL__)
-								case 50325: // Book of Precision
-									dwSkillVnum = SKILL_HIT;
-									break;
-#endif
+			case 50304: //  ü
+			case 50305:
+			case 50306:
+			{
+				if (IsPolymorphed())
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("߿ å  ϴ."));
+					return false;
+				}
 
-								default:
-									return false;
-							}
+				if (GetSkillLevel(SKILL_COMBO) == 0 && GetLevel() < 30)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" 30 Ǳ       ʽϴ."));
+					return false;
+				}
 
-							if (0 == dwSkillVnum)
-								return false;
+				if (GetSkillLevel(SKILL_COMBO) == 1 && GetLevel() < 50)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" 50 Ǳ       ʽϴ."));
+					return false;
+				}
 
-#if defined(__CONQUEROR_LEVEL__)
-							if (dwSkillVnum == SKILL_HIT && GetConquerorLevel() < iSkillLevelLowLimit)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" å    ÷ մϴ."));
-								return false;
-							}
-							else
-#endif
-							{
-								if (GetLevel() < iLevelLimit)
-								{
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING(" å    ÷ մϴ."));
-									return false;
-								}
-							}
+				if (GetSkillLevel(SKILL_COMBO) >= 2)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ̻   ϴ."));
+					return false;
+				}
 
-							if (GetSkillLevel(dwSkillVnum) >= 40)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ̻   ϴ."));
-								return false;
-							}
+				int iPct = item->GetValue(0);
 
-							if (GetSkillLevel(dwSkillVnum) < iSkillLevelLowLimit
-#if defined(__CONQUEROR_LEVEL__)
-								&& dwSkillVnum != SKILL_HIT
-#endif
-								)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" å ʹ  ϱⰡ ϴ."));
-								return false;
-							}
+				if (LearnSkillByBook(SKILL_COMBO, iPct))
+				{
+					item->SetCount(item->GetCount() - 1);
 
-							if (GetSkillLevel(dwSkillVnum) >= iSkillLevelHighLimit)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" åδ  ̻   ϴ."));
-								return false;
-							}
+					int iReadDelay = number(SKILLBOOK_DELAY_MIN, SKILLBOOK_DELAY_MAX);
+					if (distribution_test_server) iReadDelay /= 3;
 
-							if (LearnSkillByBook(dwSkillVnum, iPct))
-							{
-								item->SetCount(item->GetCount() - 1);
+					SetSkillNextReadTime(SKILL_COMBO, get_global_time() + iReadDelay);
+				}
+			}
+			break;
+			case 50311: //  ü
+			case 50312:
+			case 50313:
+			{
+				if (IsPolymorphed())
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("߿ å  ϴ."));
+					return false;
+				}
 
-								int iReadDelay = number(SKILLBOOK_DELAY_MIN, SKILLBOOK_DELAY_MAX);
-								if (distribution_test_server) iReadDelay /= 3;
+				DWORD dwSkillVnum = item->GetValue(0);
+				int iPct = MINMAX(0, item->GetValue(1), 100);
+				if (GetSkillLevel(dwSkillVnum) >= 20 || dwSkillVnum - SKILL_LANGUAGE1 + 1 == GetEmpire())
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ Ϻϰ ˾Ƶ  ִ ̴."));
+					return false;
+				}
 
-								SetSkillNextReadTime(dwSkillVnum, get_global_time() + iReadDelay);
-							}
-						}
-						break;
-						// END_LEARNABLE_SKILL_BOOKS_BY_LEVEL
+				if (LearnSkillByBook(dwSkillVnum, iPct))
+				{
+					item->SetCount(item->GetCount() - 1);
 
-						// LEARNABLE_SKILL_BOOKS_BY_EXP
-#if defined(__PARTY_PROFICY__)
-						case 50338:	// Charisma of a Rookie
-						case 50339:	// Charisma of an Adept
-						case 50340:	// Charisma of an Expert
-#endif
-#if defined(__PARTY_INSIGHT__)
-						case 50341:	// Inspiration of a Rookie
-						case 50342:	// Inspiration of an Adept
-						case 50343:	// Inspiration of an Expert
-#endif
-						{
-							if (IsPolymorphed())
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("а ߿ ɷ ø  ϴ."));
-								return false;
-							}
+					int iReadDelay = number(SKILLBOOK_DELAY_MIN, SKILLBOOK_DELAY_MAX);
+					if (distribution_test_server) iReadDelay /= 3;
 
-							int iSkillLevelLowLimit = item->GetValue(0);
-							int iSkillLevelHighLimit = item->GetValue(1);
-							int iPct = MINMAX(0, item->GetValue(2), 100);
-							int iNeedExp = item->GetValue(3);
-							DWORD dwSkillVnum = 0;
+					SetSkillNextReadTime(dwSkillVnum, get_global_time() + iReadDelay);
+				}
+			}
+			break;
 
-							switch (item->GetVnum())
-							{
-#if defined(__PARTY_PROFICY__)
-								case 50338:	// Charisma of a Rookie
-								case 50339:	// Charisma of an Adept
-								case 50340:	// Charisma of an Expert
-									dwSkillVnum = SKILL_ROLE_PROFICIENCY;
-									break;
-#endif
+			case 50061: // Ϻ  ȯ ų ü
+			{
+				if (IsPolymorphed())
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("߿ å  ϴ."));
+					return false;
+				}
 
-#if defined(__PARTY_INSIGHT__)
-								case 50341:	// Inspiration of a Rookie
-								case 50342:	// Inspiration of an Adept
-								case 50343:	// Inspiration of an Expert
-									dwSkillVnum = SKILL_INSIGHT;
-									break;
-#endif
+				DWORD dwSkillVnum = item->GetValue(0);
+				int iPct = MINMAX(0, item->GetValue(1), 100);
 
-								default:
-									return false;
-							}
+				if (GetSkillLevel(dwSkillVnum) >= 10)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ̻   ϴ."));
+					return false;
+				}
 
-							if (0 == dwSkillVnum)
-								return false;
+				if (LearnSkillByBook(dwSkillVnum, iPct))
+				{
+					item->SetCount(item->GetCount() - 1);
 
-							if (GetExp() < static_cast<DWORD>(iNeedExp))
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("ġ Ͽ å   ϴ."));
-								return false;
-							}
+					int iReadDelay = number(SKILLBOOK_DELAY_MIN, SKILLBOOK_DELAY_MAX);
+					if (distribution_test_server) iReadDelay /= 3;
 
-							if (GetSkillLevel(dwSkillVnum) >= 40)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("   ųԴϴ."));
-								return false;
-							}
+					SetSkillNextReadTime(dwSkillVnum, get_global_time() + iReadDelay);
+				}
+			}
+			break;
 
-							if (GetSkillLevel(dwSkillVnum) < iSkillLevelLowLimit)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" å ʹ  ϱⰡ ϴ."));
-								return false;
-							}
+			case 50314: case 50315: case 50316: //  ü
+			case 50323: case 50324: //  ü
+			case 50325: case 50326: // ö ü
+			{
+				if (IsPolymorphed() == true)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("а ߿ ɷ ø  ϴ."));
+					return false;
+				}
 
-							if (GetSkillLevel(dwSkillVnum) >= iSkillLevelHighLimit)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" åδ  ̻   ϴ."));
-								return false;
-							}
+				int iSkillLevelLowLimit = item->GetValue(0);
+				int iSkillLevelHighLimit = item->GetValue(1);
+				int iPct = MINMAX(0, item->GetValue(2), 100);
+				int iLevelLimit = item->GetValue(3);
+				DWORD dwSkillVnum = 0;
 
-							if (LearnSkillByBook(dwSkillVnum, iPct))
-							{
-								item->SetCount(item->GetCount() - 1);
+				switch (item->GetVnum())
+				{
+				case 50314: case 50315: case 50316:
+					dwSkillVnum = SKILL_POLYMORPH;
+					break;
 
-								if (dwSkillVnum != SKILL_HIT)
-									PointChange(POINT_EXP, -iNeedExp);
+				case 50323: case 50324:
+					dwSkillVnum = SKILL_ADD_HP;
+					break;
 
-								int iReadDelay = number(SKILLBOOK_DELAY_MIN, SKILLBOOK_DELAY_MAX);
-								if (distribution_test_server)
-									iReadDelay /= 3;
+				case 50325: case 50326:
+					dwSkillVnum = SKILL_RESIST_PENETRATE;
+					break;
 
-								SetSkillNextReadTime(dwSkillVnum, get_global_time() + iReadDelay);
-							}
-						}
-						break;
-						// END_LEARNABLE_SKILL_BOOKS_BY_EXP
+				default:
+					return false;
+				}
 
-						case 50902:
-						case 50903:
-						case 50904:
-						{
-							if (IsPolymorphed())
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("߿ å  ϴ."));
-								return false;
-							}
+				if (0 == dwSkillVnum)
+					return false;
 
-							DWORD dwSkillVnum = SKILL_CREATE;
-							int iPct = MINMAX(0, item->GetValue(1), 100);
+				if (GetLevel() < iLevelLimit)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" å    ÷ մϴ."));
+					return false;
+				}
 
-							if (GetSkillLevel(dwSkillVnum) >= 40)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ̻   ϴ."));
-								return false;
-							}
+				if (GetSkillLevel(dwSkillVnum) >= 40)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ̻   ϴ."));
+					return false;
+				}
 
-							if (LearnSkillByBook(dwSkillVnum, iPct))
-							{
-								item->SetCount(item->GetCount() - 1);
+				if (GetSkillLevel(dwSkillVnum) < iSkillLevelLowLimit)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" å ʹ  ϱⰡ ϴ."));
+					return false;
+				}
 
-								int iReadDelay = number(SKILLBOOK_DELAY_MIN, SKILLBOOK_DELAY_MAX);
-								if (distribution_test_server) iReadDelay /= 3;
+				if (GetSkillLevel(dwSkillVnum) >= iSkillLevelHighLimit)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" åδ  ̻   ϴ."));
+					return false;
+				}
 
-								SetSkillNextReadTime(dwSkillVnum, get_global_time() + iReadDelay);
+				if (LearnSkillByBook(dwSkillVnum, iPct))
+				{
+					item->SetCount(item->GetCount() - 1);
 
-								if (test_server)
-								{
-									ChatPacket(CHAT_TYPE_INFO, "[TEST_SERVER] Success to learn skill ");
-								}
-							}
-							else
-							{
-								if (test_server)
-								{
-									ChatPacket(CHAT_TYPE_INFO, "[TEST_SERVER] Failed to learn skill ");
-								}
-							}
-						}
-						break;
+					int iReadDelay = number(SKILLBOOK_DELAY_MIN, SKILLBOOK_DELAY_MAX);
+					if (distribution_test_server) iReadDelay /= 3;
 
-						// MINING
-						case ITEM_MINING_SKILL_TRAIN_BOOK:
-						{
-							if (IsPolymorphed())
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("߿ å  ϴ."));
-								return false;
-							}
+					SetSkillNextReadTime(dwSkillVnum, get_global_time() + iReadDelay);
+				}
+			}
+			break;
 
-							DWORD dwSkillVnum = SKILL_MINING;
-							int iPct = MINMAX(0, item->GetValue(1), 100);
+			case 50902:
+			case 50903:
+			case 50904:
+			{
+				if (IsPolymorphed())
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("߿ å  ϴ."));
+					return false;
+				}
 
-							if (GetSkillLevel(dwSkillVnum) >= 40)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ̻   ϴ."));
-								return false;
-							}
+				DWORD dwSkillVnum = SKILL_CREATE;
+				int iPct = MINMAX(0, item->GetValue(1), 100);
 
-							if (LearnSkillByBook(dwSkillVnum, iPct))
-							{
-								item->SetCount(item->GetCount() - 1);
+				if (GetSkillLevel(dwSkillVnum) >= 40)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ̻   ϴ."));
+					return false;
+				}
 
-								int iReadDelay = number(SKILLBOOK_DELAY_MIN, SKILLBOOK_DELAY_MAX);
-								if (distribution_test_server) iReadDelay /= 3;
+				if (LearnSkillByBook(dwSkillVnum, iPct))
+				{
+					item->SetCount(item->GetCount() - 1);
 
-								SetSkillNextReadTime(dwSkillVnum, get_global_time() + iReadDelay);
-							}
-						}
-						break;
-						// END_OF_MINING
+					int iReadDelay = number(SKILLBOOK_DELAY_MIN, SKILLBOOK_DELAY_MAX);
+					if (distribution_test_server) iReadDelay /= 3;
 
-						case ITEM_HORSE_SKILL_TRAIN_BOOK:
-						{
-							if (IsPolymorphed())
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("߿ å  ϴ."));
-								return false;
-							}
+					SetSkillNextReadTime(dwSkillVnum, get_global_time() + iReadDelay);
 
-							DWORD dwSkillVnum = SKILL_HORSE;
-							int iPct = MINMAX(0, item->GetValue(1), 100);
+					if (test_server)
+					{
+						ChatPacket(CHAT_TYPE_INFO, "[TEST_SERVER] Success to learn skill ");
+					}
+				}
+				else
+				{
+					if (test_server)
+					{
+						ChatPacket(CHAT_TYPE_INFO, "[TEST_SERVER] Failed to learn skill ");
+					}
+				}
+			}
+			break;
 
-							if (GetLevel() < 50)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ¸ ų   ִ  ƴմϴ."));
-								return false;
-							}
+			// MINING
+			case ITEM_MINING_SKILL_TRAIN_BOOK:
+			{
+				if (IsPolymorphed())
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("߿ å  ϴ."));
+					return false;
+				}
 
-							if (!test_server && get_global_time() < GetSkillNextReadTime(dwSkillVnum))
-							{
-								if (FindAffect(AFFECT_SKILL_NO_BOOK_DELAY))
-								{
-									// ־ȼ ߿ ð  
-									RemoveAffect(AFFECT_SKILL_NO_BOOK_DELAY);
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING("־ȼ  ȭԸ Խϴ."));
-								}
-								else
-								{
-									SkillLearnWaitMoreTimeMessage(GetSkillNextReadTime(dwSkillVnum) - get_global_time());
-									return false;
-								}
-							}
+				DWORD dwSkillVnum = SKILL_MINING;
+				int iPct = MINMAX(0, item->GetValue(1), 100);
 
-							if (GetPoint(POINT_HORSE_SKILL) >= 20 ||
-								GetSkillLevel(SKILL_HORSE_WILDATTACK) + GetSkillLevel(SKILL_HORSE_CHARGE) + GetSkillLevel(SKILL_HORSE_ESCAPE) >= 60 ||
-								GetSkillLevel(SKILL_HORSE_WILDATTACK_RANGE) + GetSkillLevel(SKILL_HORSE_CHARGE) + GetSkillLevel(SKILL_HORSE_ESCAPE) >= 60)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ̻ ¸ ü   ϴ."));
-								return false;
-							}
+				if (GetSkillLevel(dwSkillVnum) >= 40)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ̻   ϴ."));
+					return false;
+				}
 
-							if (number(1, 100) <= iPct)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("¸ ü о ¸ ų Ʈ ϴ."));
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" Ʈδ ¸ ų  ø  ֽϴ."));
-								PointChange(POINT_HORSE_SKILL, 1);
+				if (LearnSkillByBook(dwSkillVnum, iPct))
+				{
+					item->SetCount(item->GetCount() - 1);
 
-								int iReadDelay = number(SKILLBOOK_DELAY_MIN, SKILLBOOK_DELAY_MAX);
-								if (distribution_test_server) iReadDelay /= 3;
+					int iReadDelay = number(SKILLBOOK_DELAY_MIN, SKILLBOOK_DELAY_MAX);
+					if (distribution_test_server) iReadDelay /= 3;
 
-								if (!test_server)
-									SetSkillNextReadTime(dwSkillVnum, get_global_time() + iReadDelay);
-							}
-							else
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("¸ ü ؿ Ͽϴ."));
-							}
+					SetSkillNextReadTime(dwSkillVnum, get_global_time() + iReadDelay);
+				}
+			}
+			break;
+			// END_OF_MINING
 
-							ITEM_MANAGER::instance().RemoveItem(item);
-						}
-						break;
+			case ITEM_HORSE_SKILL_TRAIN_BOOK:
+			{
+				if (IsPolymorphed())
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("߿ å  ϴ."));
+					return false;
+				}
 
-						case 70102: // 
-						case 70103: // 
-						{
-							if (GetAlignment() >= 0)
-								return false;
+				DWORD dwSkillVnum = SKILL_HORSE;
+				int iPct = MINMAX(0, item->GetValue(1), 100);
 
-							int delta = MIN(-GetAlignment(), item->GetValue(0));
+				if (GetLevel() < 50)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ¸ ų   ִ  ƴմϴ."));
+					return false;
+				}
 
-							sys_log(0, "%s ALIGNMENT ITEM %d", GetName(), delta);
+				if (!test_server && get_global_time() < GetSkillNextReadTime(dwSkillVnum))
+				{
+					if (FindAffect(AFFECT_SKILL_NO_BOOK_DELAY))
+					{
+						// ־ȼ ߿ ð  
+						RemoveAffect(AFFECT_SKILL_NO_BOOK_DELAY);
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("־ȼ  ȭԸ Խϴ."));
+					}
+					else
+					{
+						SkillLearnWaitMoreTimeMessage(GetSkillNextReadTime(dwSkillVnum) - get_global_time());
+						return false;
+					}
+				}
 
-							UpdateAlignment(delta);
-							item->SetCount(item->GetCount() - 1);
+				if (GetPoint(POINT_HORSE_SKILL) >= 20 ||
+					GetSkillLevel(SKILL_HORSE_WILDATTACK) + GetSkillLevel(SKILL_HORSE_CHARGE) + GetSkillLevel(SKILL_HORSE_ESCAPE) >= 60 ||
+					GetSkillLevel(SKILL_HORSE_WILDATTACK_RANGE) + GetSkillLevel(SKILL_HORSE_CHARGE) + GetSkillLevel(SKILL_HORSE_ESCAPE) >= 60)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ̻ ¸ ü   ϴ."));
+					return false;
+				}
 
-							if (delta / 10 > 0)
-							{
-								ChatPacket(CHAT_TYPE_TALKING, LC_STRING(" ±.   𰡰   ̾."));
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("ġ %d Ͽϴ.", delta / 10));
-							}
-						}
-						break;
+				if (number(1, 100) <= iPct)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("¸ ü о ¸ ų Ʈ ϴ."));
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" Ʈδ ¸ ų  ø  ֽϴ."));
+					PointChange(POINT_HORSE_SKILL, 1);
 
-						case 71107: // õ
-						case 39032:
-						{
-							quest::CQuestManager& q = quest::CQuestManager::Instance();
-							quest::PC* pPC = q.GetPC(GetPlayerID());
-							if (pPC)
-							{
-								int val = item->GetValue(0);
-								int interval = item->GetValue(1);
-								int last_use_time = pPC->GetFlag("mythical_peach.last_use_time");
-								if (get_global_time() - last_use_time < interval * 60 * 60)
-								{
-									if (test_server == false)
-									{
-										ChatPacket(CHAT_TYPE_INFO, LC_STRING("   ϴ."));
-										return false;
-									}
-									else
-									{
-										ChatPacket(CHAT_TYPE_INFO, LC_STRING("׽Ʈ  ð "));
-									}
-								}
+					int iReadDelay = number(SKILLBOOK_DELAY_MIN, SKILLBOOK_DELAY_MAX);
+					if (distribution_test_server) iReadDelay /= 3;
 
-								if (GetAlignment() == 200000)
-								{
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING("ġ  ̻ ø  ϴ."));
-									return false;
-								}
+					if (!test_server)
+						SetSkillNextReadTime(dwSkillVnum, get_global_time() + iReadDelay);
+				}
+				else
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("¸ ü ؿ Ͽϴ."));
+				}
 
-								if (200000 - GetAlignment() < val * 10)
-								{
-									val = (200000 - GetAlignment()) / 10;
-								}
+				ITEM_MANAGER::instance().RemoveItem(item);
+			}
+			break;
 
-								int old_alignment = GetAlignment() / 10;
+			case 70102: // 
+			case 70103: // 
+			{
+				if (GetAlignment() >= 0)
+					return false;
 
-								UpdateAlignment(val * 10);
+				int delta = MIN(-GetAlignment(), item->GetValue(0));
 
-								item->SetCount(item->GetCount() - 1);
-								pPC->SetFlag("mythical_peach.last_use_time", get_global_time());
+				sys_log(0, "%s ALIGNMENT ITEM %d", GetName(), delta);
 
-								ChatPacket(CHAT_TYPE_TALKING, LC_STRING(" ±.   𰡰   ̾."));
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("ġ %d Ͽϴ.", val));
+				UpdateAlignment(delta);
+				item->SetCount(item->GetCount() - 1);
 
-								char buf[256 + 1];
-								snprintf(buf, sizeof(buf), "%d %d", old_alignment, GetAlignment() / 10);
-								LogManager::instance().CharLog(this, val, "MYTHICAL_PEACH", buf);
-							}
-						}
-						break;
+				if (delta / 10 > 0)
+				{
+					ChatPacket(CHAT_TYPE_TALKING, LC_TEXT(" ±.   𰡰   ̾."));
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ġ %d Ͽϴ."), delta / 10);
+				}
+			}
+			break;
 
-						case 71109: // Ż
-						case 39033:
-						{
-							LPITEM item2;
+			case 71107: // õ
+			{
+				int val = item->GetValue(0);
+				int interval = item->GetValue(1);
+				quest::PC* pPC = quest::CQuestManager::instance().GetPC(GetPlayerID());
+				int last_use_time = pPC->GetFlag("mythical_peach.last_use_time");
 
-							if (!IsValidItemPosition(DestCell) || !(item2 = GetItem(DestCell)))
-								return false;
+				if (get_global_time() - last_use_time < interval * 60 * 60)
+				{
+					if (test_server == false)
+					{
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("   ϴ."));
+						return false;
+					}
+					else
+					{
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("׽Ʈ  ð "));
+					}
+				}
 
-							if (item2->IsExchanging() || item2->IsEquipped())
-								return false;
+				if (GetAlignment() == 200000)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ġ  ̻ ø  ϴ."));
+					return false;
+				}
 
-							if (item2->GetSocketCount() == 0)
-								return false;
+				if (200000 - GetAlignment() < val * 10)
+				{
+					val = (200000 - GetAlignment()) / 10;
+				}
 
-							switch (item2->GetType())
-							{
-								case ITEM_WEAPON:
-									break;
+				int old_alignment = GetAlignment() / 10;
 
-								case ITEM_ARMOR:
-									switch (item2->GetSubType())
-									{
-										case ARMOR_EAR:
-										case ARMOR_WRIST:
-										case ARMOR_NECK:
-											ChatPacket(CHAT_TYPE_INFO, LC_STRING("  ϴ"));
-											return false;
-									}
-									break;
+				UpdateAlignment(val * 10);
 
-								default:
-									return false;
-							}
+				item->SetCount(item->GetCount() - 1);
+				pPC->SetFlag("mythical_peach.last_use_time", get_global_time());
 
-							std::stack<long> socket;
+				ChatPacket(CHAT_TYPE_TALKING, LC_TEXT(" ±.   𰡰   ̾."));
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ġ %d Ͽϴ."), val);
 
-							for (int i = 0; i < METIN_SOCKET_MAX_NUM; ++i)
-							{
-#if defined(__GLOVE_SYSTEM__)
-								DWORD dwSocketData = item2->GetSocket(i);
-								if (item2->IsGlove() && dwSocketData >= 1000000 && dwSocketData != ITEM_BROKEN_METIN_VNUM)
-								{
-									DWORD dwBaseIndex = 28046;
-									dwBaseIndex += (((dwSocketData / 1000) % 10) * 100);
-									dwBaseIndex += ((dwSocketData / 100) % 10) - 1;
-
-									const TItemTable* pItemData = ITEM_MANAGER::instance().GetTable(dwBaseIndex);
-									if (pItemData == nullptr)
-										continue;
+				char buf[256 + 1];
+				snprintf(buf, sizeof(buf), "%d %d", old_alignment, GetAlignment() / 10);
+				LogManager::instance().CharLog(this, val, "MYTHICAL_PEACH", buf);
+			}
+			break;
 
-									dwSocketData = dwBaseIndex;
-								}
-								socket.push(dwSocketData);
-#else
-								socket.push(item2->GetSocket(i));
-#endif
-							}
+			case 71109: // Ż
+			case 72719:
+			{
+				LPITEM item2;
 
-							int idx = METIN_SOCKET_MAX_NUM - 1;
+				if (!IsValidItemPosition(DestCell) || !(item2 = GetItem(DestCell)))
+					return false;
 
-							while (socket.size() > 0)
-							{
-								if (socket.top() > 2 && socket.top() != ITEM_BROKEN_METIN_VNUM)
-									break;
+				if (item2->IsExchanging() == true)
+					return false;
 
-								idx--;
-								socket.pop();
-							}
+				if (item2->GetSocketCount() == 0)
+					return false;
 
-							if (socket.size() == 0)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("  ϴ"));
-								return false;
-							}
+				if (item2->IsEquipped())
+					return false;
 
-							LPITEM pItemReward = AutoGiveItem(socket.top());
-							if (pItemReward != NULL)
-							{
-								item2->SetSocket(idx, 1);
+				switch (item2->GetType())
+				{
+				case ITEM_WEAPON:
+					break;
+				case ITEM_ARMOR:
+					switch (item2->GetSubType())
+					{
+					case ARMOR_EAR:
+					case ARMOR_WRIST:
+					case ARMOR_NECK:
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ϴ"));
+						return false;
+					}
+					break;
 
-								char buf[256 + 1];
-								snprintf(buf, sizeof(buf), "%s(%u) %s(%u)",
-									item2->GetName(), item2->GetID(), pItemReward->GetName(), pItemReward->GetID());
-								LogManager::instance().ItemLog(this, item, "USE_DETACHMENT_ONE", buf);
+				default:
+					return false;
+				}
 
-								item->SetCount(item->GetCount() - 1);
-							}
-						}
-						break;
+				std::stack<long> socket;
 
-						case 70201: // Ż
-						case 70202: // ()
-						case 70203: // (ݻ)
-						case 70204: // ()
-						case 70205: // ()
-						case 70206: // ()
-						{
-							// NEW_HAIR_STYLE_ADD
-							if (GetPart(PART_HAIR) >= 1001)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ŸϿ  Ż Ұմϴ."));
-							}
-							// END_NEW_HAIR_STYLE_ADD
-							else
-							{
-								quest::CQuestManager& q = quest::CQuestManager::instance();
-								quest::PC* pPC = q.GetPC(GetPlayerID());
-								if (pPC)
-								{
-									int last_dye_level = pPC->GetFlag("dyeing_hair.last_dye_level");
+				for (int i = 0; i < ITEM_SOCKET_MAX_NUM; ++i)
+					socket.push(item2->GetSocket(i));
 
-									if (last_dye_level == 0 ||
-										last_dye_level + 3 <= GetLevel() ||
-										item->GetVnum() == 70201)
-									{
-										SetPart(PART_HAIR, item->GetVnum() - 70201);
-
-										if (item->GetVnum() == 70201)
-											pPC->SetFlag("dyeing_hair.last_dye_level", 0);
-										else
-											pPC->SetFlag("dyeing_hair.last_dye_level", GetLevel());
-
-										item->SetCount(item->GetCount() - 1);
-										UpdatePacket();
-									}
-									else
-									{
-										ChatPacket(CHAT_TYPE_INFO, LC_STRING("%d  Ǿ ٽ Ͻ  ֽϴ.", last_dye_level + 3));
-									}
-								}
-							}
-						}
-						break;
+				int idx = ITEM_SOCKET_MAX_NUM - 1;
 
-						case ITEM_NEW_YEAR_GREETING_VNUM:
-						{
-							if (GiveItemFromSpecialItemGroup(ITEM_NEW_YEAR_GREETING_VNUM))
-								item->SetCount(item->GetCount() - 1);
-						}
+				while (socket.size() > 0)
+				{
+					if (socket.top() > 2 && socket.top() != ITEM_BROKEN_METIN_VNUM)
 						break;
 
-						case ITEM_VALENTINE_ROSE:
-						case ITEM_VALENTINE_CHOCOLATE:
-						{
-							if (item->GetVnum() == ITEM_VALENTINE_ROSE && SEX_MALE == GET_SEX(this) ||
-								item->GetVnum() == ITEM_VALENTINE_CHOCOLATE && SEX_FEMALE == GET_SEX(this))
-							{
-								//  ʾ   .
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ʾ     ϴ."));
-								return false;
-							}
+					idx--;
+					socket.pop();
+				}
 
-							if (GiveItemFromSpecialItemGroup(item->GetVnum()))
-								item->SetCount(item->GetCount() - 1);
-						}
-						break;
+				if (socket.size() == 0)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ϴ"));
+					return false;
+				}
 
-						case ITEM_WHITEDAY_CANDY:
-						case ITEM_WHITEDAY_ROSE:
-						{
-							if (item->GetVnum() == ITEM_WHITEDAY_CANDY && SEX_MALE == GET_SEX(this) ||
-								item->GetVnum() == ITEM_WHITEDAY_ROSE && SEX_FEMALE == GET_SEX(this))
-							{
-								//  ʾ   .
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ʾ     ϴ."));
-								return false;
-							}
+				LPITEM pItemReward = AutoGiveItem(socket.top());
 
-							if (GiveItemFromSpecialItemGroup(item->GetVnum()))
-								item->SetCount(item->GetCount() - 1);
-						}
-						break;
+				if (pItemReward != NULL)
+				{
+					item2->SetSocket(idx, 1);
 
-						case 50011: // 
+					char buf[256 + 1];
+					snprintf(buf, sizeof(buf), "%s(%u) %s(%u)",
+						item2->GetName(), item2->GetID(), pItemReward->GetName(), pItemReward->GetID());
+					LogManager::instance().ItemLog(this, item, "USE_DETACHMENT_ONE", buf);
+
+					item->SetCount(item->GetCount() - 1);
+				}
+			}
+			break;
+
+			case 70201: // Ż
+			case 70202: // ()
+			case 70203: // (ݻ)
+			case 70204: // ()
+			case 70205: // ()
+			case 70206: // ()
+			{
+				// NEW_HAIR_STYLE_ADD
+				if (GetPart(PART_HAIR) >= 1001)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ŸϿ  Ż Ұմϴ."));
+				}
+				// END_NEW_HAIR_STYLE_ADD
+				else
+				{
+					quest::CQuestManager& q = quest::CQuestManager::instance();
+					quest::PC* pPC = q.GetPC(GetPlayerID());
+
+					if (pPC)
+					{
+						int last_dye_level = pPC->GetFlag("dyeing_hair.last_dye_level");
+
+						if (last_dye_level == 0 ||
+							last_dye_level + 3 <= GetLevel() ||
+							item->GetVnum() == 70201)
 						{
-							if (!GiveItemFromSpecialItemGroup(50011))
-							{
-								ChatPacket(CHAT_TYPE_TALKING, LC_STRING("ƹ͵   ϴ."));
-								return false;
-							}
+							SetPart(PART_HAIR, item->GetVnum() - 70201);
+
+							if (item->GetVnum() == 70201)
+								pPC->SetFlag("dyeing_hair.last_dye_level", 0);
+							else
+								pPC->SetFlag("dyeing_hair.last_dye_level", GetLevel());
 
 							item->SetCount(item->GetCount() - 1);
+							UpdatePacket();
 						}
-						break;
-
-						case ITEM_GIVE_STAT_RESET_COUNT_VNUM:
+						else
 						{
-							//PointChange(POINT_GOLD, -iCost);
-							PointChange(POINT_STAT_RESET_COUNT, 1);
-							item->SetCount(item->GetCount() - 1);
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%d  Ǿ ٽ Ͻ  ֽϴ."), last_dye_level + 3);
 						}
-						break;
+					}
+				}
+			}
+			break;
 
-						case 50107:
-						{
-							if (CArenaManager::instance().IsArenaMap(GetMapIndex()))
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ߿ ̿   ǰԴϴ."));
-								return false;
-							}
+			case ITEM_NEW_YEAR_GREETING_VNUM:
+			{
+				DWORD dwBoxVnum = ITEM_NEW_YEAR_GREETING_VNUM;
+				std::vector <DWORD> dwVnums;
+				std::vector <DWORD> dwCounts;
+				std::vector <LPITEM> item_gets;
+				int count = 0;
 
-							EffectPacket(SE_CHINA_FIREWORK);
-							//   ÷ش
-							AddAffect(AFFECT_CHINA_FIREWORK, POINT_STUN_PCT, 30, AFF_CHINA_FIREWORK, 5 * 60, 0, true);
-							item->SetCount(item->GetCount() - 1);
-						}
-						break;
+				if (GiveItemFromSpecialItemGroup(dwBoxVnum, dwVnums, dwCounts, item_gets, count))
+				{
+					for (int i = 0; i < count; i++)
+					{
+						if (dwVnums[i] == CSpecialItemGroup::GOLD)
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" %d  ȹ߽ϴ."), dwCounts[i]);
+					}
 
-						case 50108:
-						{
-							if (CArenaManager::instance().IsArenaMap(GetMapIndex()))
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ߿ ̿   ǰԴϴ."));
-								return false;
-							}
+					item->SetCount(item->GetCount() - 1);
+				}
+			}
+			break;
 
-							EffectPacket(SE_SPIN_TOP);
-							//   ÷ش
-							AddAffect(AFFECT_CHINA_FIREWORK, POINT_STUN_PCT, 30, AFF_CHINA_FIREWORK, 5 * 60, 0, true);
-							item->SetCount(item->GetCount() - 1);
-						}
-						break;
+			case ITEM_VALENTINE_ROSE:
+			case ITEM_VALENTINE_CHOCOLATE:
+			{
+				DWORD dwBoxVnum = item->GetVnum();
+				std::vector <DWORD> dwVnums;
+				std::vector <DWORD> dwCounts;
+				std::vector <LPITEM> item_gets(0);
+				int count = 0;
 
-						case ITEM_WONSO_BEAN_VNUM:
-							PointChange(POINT_HP, GetMaxHP() - GetHP());
-							item->SetCount(item->GetCount() - 1);
-							break;
+				if (item->GetVnum() == ITEM_VALENTINE_ROSE && SEX_MALE == GET_SEX(this) ||
+					item->GetVnum() == ITEM_VALENTINE_CHOCOLATE && SEX_FEMALE == GET_SEX(this))
+				{
+					//  ʾ   .
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ʾ     ϴ."));
+					return false;
+				}
 
-						case ITEM_WONSO_SUGAR_VNUM:
-							PointChange(POINT_SP, GetMaxSP() - GetSP());
-							item->SetCount(item->GetCount() - 1);
-							break;
+				if (GiveItemFromSpecialItemGroup(dwBoxVnum, dwVnums, dwCounts, item_gets, count))
+					item->SetCount(item->GetCount() - 1);
+			}
+			break;
 
-						case ITEM_WONSO_FRUIT_VNUM:
-							PointChange(POINT_STAMINA, GetMaxStamina() - GetStamina());
-							item->SetCount(item->GetCount() - 1);
-							break;
+			case ITEM_WHITEDAY_CANDY:
+			case ITEM_WHITEDAY_ROSE:
+			{
+				DWORD dwBoxVnum = item->GetVnum();
+				std::vector <DWORD> dwVnums;
+				std::vector <DWORD> dwCounts;
+				std::vector <LPITEM> item_gets(0);
+				int count = 0;
 
-						case ITEM_ELK_VNUM: // ٷ
-						{
-							int iGold = item->GetSocket(0);
-							ITEM_MANAGER::instance().RemoveItem(item);
-							PointChange(POINT_GOLD, iGold);
-						}
-						break;
+				if (item->GetVnum() == ITEM_WHITEDAY_CANDY && SEX_MALE == GET_SEX(this) ||
+					item->GetVnum() == ITEM_WHITEDAY_ROSE && SEX_FEMALE == GET_SEX(this))
+				{
+					//  ʾ   .
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ʾ     ϴ."));
+					return false;
+				}
 
-						//  ǥ
-						case 70021:
-						{
-							int HealPrice = quest::CQuestManager::instance().GetEventFlag("MonarchHealGold");
-							if (HealPrice == 0)
-								HealPrice = 2000000;
 
-							if (CMonarch::instance().HealMyEmpire(this, HealPrice))
-							{
-								char szNotice[256];
-								snprintf(szNotice, sizeof(szNotice), LC_STRING(" ູ  %s  HP,SP  äϴ.", EMPIRE_NAME(GetEmpire())));
-								SendNoticeMap(szNotice, GetMapIndex(), false);
+				if (GiveItemFromSpecialItemGroup(dwBoxVnum, dwVnums, dwCounts, item_gets, count))
+					item->SetCount(item->GetCount() - 1);
+			}
+			break;
 
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ູ Ͽϴ."));
-							}
-						}
-						break;
+			case 50011: // 
+			{
+				DWORD dwBoxVnum = 50011;
+				std::vector <DWORD> dwVnums;
+				std::vector <DWORD> dwCounts;
+				std::vector <LPITEM> item_gets(0);
+				int count = 0;
 
-						case 27995:
-						{
-						}
-						break;
+				if (GiveItemFromSpecialItemGroup(dwBoxVnum, dwVnums, dwCounts, item_gets, count))
+				{
+					for (int i = 0; i < count; i++)
+					{
+						char buf[50 + 1];
+						snprintf(buf, sizeof(buf), "%u %u", dwVnums[i], dwCounts[i]);
+						LogManager::instance().ItemLog(this, item, "MOONLIGHT_GET", buf);
 
-						case 71092: //  ü ӽ
-						{
-							if (m_pkChrTarget != NULL)
-							{
-								if (m_pkChrTarget->IsPolymorphed())
-								{
-									m_pkChrTarget->SetPolymorph(0);
-									m_pkChrTarget->RemoveAffect(AFFECT_POLYMORPH);
-								}
-							}
-							else
-							{
-								if (IsPolymorphed())
-								{
-									SetPolymorph(0);
-									RemoveAffect(AFFECT_POLYMORPH);
-								}
-							}
-						}
-						break;
+						//ITEM_MANAGER::instance().RemoveItem(item);
+						item->SetCount(item->GetCount() - 1);
 
-						case 71051: // 簡
+						switch (dwVnums[i])
 						{
-							LPITEM item2;
-
-							if (!IsValidItemPosition(DestCell) || !(item2 = GetInventoryItem(wDestCell)))
-								return false;
+						case CSpecialItemGroup::GOLD:
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" %d  ȹ߽ϴ."), dwCounts[i]);
+							break;
 
-							if (item2->IsExchanging())
-								return false;
+						case CSpecialItemGroup::EXP:
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ  ź  ɴϴ."));
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%d ġ ȹ߽ϴ."), dwCounts[i]);
+							break;
 
-							if (item2->IsEquipped())
-								return false;
+						case CSpecialItemGroup::MOB:
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ Ͱ Ÿϴ!"));
+							break;
 
-							if (item2->GetType() == ITEM_COSTUME)
-								return false;
+						case CSpecialItemGroup::SLOW:
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ   ⸦ ̸ ̴ ӵ ϴ!"));
+							break;
 
-							//if (item2->GetAttributeCount() < 5)
-							//	return false;
+						case CSpecialItemGroup::DRAIN_HP:
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڰ ڱ Ͽϴ!  ߽ϴ."));
+							break;
 
-							if (item2->GetAttributeSetIndex() == -1)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ӽ    Դϴ."));
-								return false;
-							}
+						case CSpecialItemGroup::POISON:
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ   ⸦ ̸  ¸ ϴ!"));
+							break;
 
-							if (item2->AddRareAttribute() == true)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ӽ ߰ Ͽϴ."));
+						case CSpecialItemGroup::BLEEDING:
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ   ⸦ ̸  ¸ ϴ!"));
+							break;
 
-								int iAddedIdx = item2->GetRareAttrCount() + 4;
-								char buf[21];
-								snprintf(buf, sizeof(buf), "%u", item2->GetID());
-
-								LogManager::instance().ItemLog(
-									GetPlayerID(),
-									item2->GetAttributeType(iAddedIdx),
-									item2->GetAttributeValue(iAddedIdx),
-									item->GetID(),
-									"ADD_RARE_ATTR",
-									buf,
-									GetDesc()->GetHostName(),
-									item->GetOriginalVnum());
+						case CSpecialItemGroup::MOB_GROUP:
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ Ͱ Ÿϴ!"));
+							break;
 
-								if (!g_bUnlimitedAddRareAttributes)
-									item->SetCount(item->GetCount() - 1);
-							}
-							else
+						default:
+							if (item_gets[i])
 							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ӽ ߰ Ͽϴ."));
+								if (dwCounts[i] > 1)
+									ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ %s  %d  Խϴ."), item_gets[i]->GetLocaleName(), dwCounts[i]);
+								else
+									ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ %s  Խϴ."), item_gets[i]->GetLocaleName());
 							}
+							break;
 						}
-						break;
-
-						case 71052: // 
-						{
-							LPITEM item2;
-
-							if (!IsValidItemPosition(DestCell) || !(item2 = GetItem(DestCell)))
-								return false;
+					}
+				}
+				else
+				{
+					ChatPacket(CHAT_TYPE_TALKING, LC_TEXT("ƹ͵   ϴ."));
+					return false;
+				}
+			}
+			break;
 
-							if (item2->IsEquipped())
-								return false;
+			case ITEM_GIVE_STAT_RESET_COUNT_VNUM:
+			{
+				//PointChange(POINT_GOLD, -iCost);
+				PointChange(POINT_STAT_RESET_COUNT, 1);
+				item->SetCount(item->GetCount() - 1);
+			}
+			break;
 
-							if (item2->GetType() == ITEM_COSTUME)
-								return false;
+			case 50107:
+			{
+				EffectPacket(SE_CHINA_FIREWORK);
+				//   ÷ش
+				AddAffect(AFFECT_CHINA_FIREWORK, POINT_STUN_PCT, 30, AFF_CHINA_FIREWORK, 5 * 60, 0, true);
+				item->SetCount(item->GetCount() - 1);
+			}
+			break;
 
-							if (item2->IsExchanging() == true)
-								return false;
+			case 50108:
+			{
+				if (CArenaManager::instance().IsArenaMap(GetMapIndex()) == true)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ߿ ̿   ǰԴϴ."));
+					return false;
+				}
 
-							if (item2->GetAttributeSetIndex() == -1)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ӽ    Դϴ."));
-								return false;
-							}
+				EffectPacket(SE_SPIN_TOP);
+				//   ÷ش
+				AddAffect(AFFECT_CHINA_FIREWORK, POINT_STUN_PCT, 30, AFF_CHINA_FIREWORK, 5 * 60, 0, true);
+				item->SetCount(item->GetCount() - 1);
+			}
+			break;
 
-							if (item2->ChangeRareAttribute() == true)
-							{
-								char buf[21];
-								snprintf(buf, sizeof(buf), "%u", item2->GetID());
-								LogManager::instance().ItemLog(this, item, "CHANGE_RARE_ATTR", buf);
+			case ITEM_WONSO_BEAN_VNUM:
+				PointChange(POINT_HP, GetMaxHP() - GetHP());
+				item->SetCount(item->GetCount() - 1);
+				break;
 
-								if (!g_bUnlimitedChangeRareAttributes)
-									item->SetCount(item->GetCount() - 1);
-							}
-							else
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ӽ Ͽϴ."));
-							}
-						}
-						break;
+			case ITEM_WONSO_SUGAR_VNUM:
+				PointChange(POINT_SP, GetMaxSP() - GetSP());
+				item->SetCount(item->GetCount() - 1);
+				break;
 
-						case ITEM_AUTO_HP_RECOVERY_S:
-						case ITEM_AUTO_HP_RECOVERY_M:
-						case ITEM_AUTO_HP_RECOVERY_L:
-						case ITEM_AUTO_HP_RECOVERY_X:
-						case ITEM_AUTO_SP_RECOVERY_S:
-						case ITEM_AUTO_SP_RECOVERY_M:
-						case ITEM_AUTO_SP_RECOVERY_L:
-						case ITEM_AUTO_SP_RECOVERY_X:
-							// ù  ϴ  ġ ...
-							// ׷ ׳ ϵ ڵ.  ڿ ڵ ۵.
-						case REWARD_BOX_ITEM_AUTO_SP_RECOVERY_XS:
-						case REWARD_BOX_ITEM_AUTO_SP_RECOVERY_S:
-						case REWARD_BOX_ITEM_AUTO_HP_RECOVERY_XS:
-						case REWARD_BOX_ITEM_AUTO_HP_RECOVERY_S:
-						{
-							if (CArenaManager::instance().IsArenaMap(GetMapIndex()))
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("忡 Ͻ  ϴ."));
-								return false;
-							}
+			case ITEM_WONSO_FRUIT_VNUM:
+				PointChange(POINT_STAMINA, GetMaxStamina() - GetStamina());
+				item->SetCount(item->GetCount() - 1);
+				break;
 
-							EAffectTypes type = AFFECT_NONE;
-							bool isSpecialPotion = false;
+			case ITEM_ELK_VNUM: // ٷ
+			{
+				int iGold = item->GetSocket(0);
+				ITEM_MANAGER::instance().RemoveItem(item);
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" %d  ȹ߽ϴ."), iGold);
+				PointChange(POINT_GOLD, iGold);
+			}
+			break;
 
-							switch (item->GetVnum())
-							{
-								case ITEM_AUTO_HP_RECOVERY_X:
-									isSpecialPotion = true;
+			//  ǥ
+			case 70021:
+			{
+				int HealPrice = quest::CQuestManager::instance().GetEventFlag("MonarchHealGold");
+				if (HealPrice == 0)
+					HealPrice = 2000000;
 
-								case ITEM_AUTO_HP_RECOVERY_S:
-								case ITEM_AUTO_HP_RECOVERY_M:
-								case ITEM_AUTO_HP_RECOVERY_L:
-								case REWARD_BOX_ITEM_AUTO_HP_RECOVERY_XS:
-								case REWARD_BOX_ITEM_AUTO_HP_RECOVERY_S:
-									type = AFFECT_AUTO_HP_RECOVERY;
-									break;
+				if (CMonarch::instance().HealMyEmpire(this, HealPrice))
+				{
+					char szNotice[256];
+					snprintf(szNotice, sizeof(szNotice), LC_TEXT(" ູ  %s  HP,SP  äϴ."), EMPIRE_NAME(GetEmpire()));
+					SendNoticeMap(szNotice, GetMapIndex(), false);
 
-								case ITEM_AUTO_SP_RECOVERY_X:
-									isSpecialPotion = true;
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ູ Ͽϴ."));
+				}
+			}
+			break;
 
-								case ITEM_AUTO_SP_RECOVERY_S:
-								case ITEM_AUTO_SP_RECOVERY_M:
-								case ITEM_AUTO_SP_RECOVERY_L:
-								case REWARD_BOX_ITEM_AUTO_SP_RECOVERY_XS:
-								case REWARD_BOX_ITEM_AUTO_SP_RECOVERY_S:
-									type = AFFECT_AUTO_SP_RECOVERY;
-									break;
-							}
+			case 27995:
+			{
+			}
+			break;
 
-							if (AFFECT_NONE == type)
-								break;
+			case 71092: //  ü ӽ
+			{
+				if (m_pkChrTarget != NULL)
+				{
+					if (m_pkChrTarget->IsPolymorphed())
+					{
+						m_pkChrTarget->SetPolymorph(0);
+						m_pkChrTarget->RemoveAffect(AFFECT_POLYMORPH);
+					}
+				}
+				else
+				{
+					if (IsPolymorphed())
+					{
+						SetPolymorph(0);
+						RemoveAffect(AFFECT_POLYMORPH);
+					}
+				}
+			}
+			break;
 
-							if (item->GetCount() > 1)
-							{
-								int pos = GetEmptyInventory(item->GetSize());
+			case 71051: // 簡
+			{
+				LPITEM item2;
 
-								if (-1 == pos)
-								{
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING("ǰ   ϴ."));
-									break;
-								}
+				if (!IsValidItemPosition(DestCell) || !(item2 = GetInventoryItem(wDestCell)))
+					return false;
 
-								item->SetCount(item->GetCount() - 1);
+				if (item2->IsExchanging() == true)
+					return false;
 
-								LPITEM item2 = ITEM_MANAGER::instance().CreateItem(item->GetVnum(), 1);
-								item2->AddToCharacter(this, TItemPos(INVENTORY, pos));
+				if (item2->IsEquipped())
+					return false;
 
-								if (item->GetSocket(1) != 0)
-								{
-									item2->SetSocket(1, item->GetSocket(1));
-								}
+				if (item2->GetType() == ITEM_COSTUME)
+					return false;
 
-								item = item2;
-							}
+				//if (item2->GetAttributeCount() < 5)
+				//	return false;
 
-							CAffect* pAffect = FindAffect(type);
+				if (item2->GetAttributeSetIndex() == -1)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ӽ    Դϴ."));
+					return false;
+				}
 
-							if (NULL == pAffect)
-							{
-								EPointTypes bonus = POINT_NONE;
+				if (item2->AddRareAttribute() == true)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ӽ ߰ Ͽϴ."));
 
-								if (true == isSpecialPotion)
-								{
-									if (type == AFFECT_AUTO_HP_RECOVERY)
-									{
-										bonus = POINT_MAX_HP_PCT;
-									}
-									else if (type == AFFECT_AUTO_SP_RECOVERY)
-									{
-										bonus = POINT_MAX_SP_PCT;
-									}
-								}
+					int iAddedIdx = item2->GetRareAttrCount() + 4;
+					char buf[21];
+					snprintf(buf, sizeof(buf), "%u", item2->GetID());
 
-								AddAffect(type, bonus, 4, item->GetID(), INFINITE_AFFECT_DURATION, 0, true, false);
+					LogManager::instance().ItemLog(
+						GetPlayerID(),
+						item2->GetAttributeType(iAddedIdx),
+						item2->GetAttributeValue(iAddedIdx),
+						item->GetID(),
+						"ADD_RARE_ATTR",
+						buf,
+						GetDesc()->GetHostName(),
+						item->GetOriginalVnum());
 
-								item->Lock(true);
-								item->SetSocket(0, true);
+					if (!g_bUnlimitedAddRareAttributes)
+						item->SetCount(item->GetCount() - 1);
+				}
+				else
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ӽ ߰ Ͽϴ."));
+				}
+			}
+			break;
 
-								AutoRecoveryItemProcess(type);
-							}
-							else
-							{
-								if (item->GetID() == pAffect->dwFlag)
-								{
-									RemoveAffect(pAffect);
+			case 71052: // 
+			{
+				LPITEM item2;
 
-									item->Lock(false);
-									item->SetSocket(0, false);
-								}
-								else
-								{
-									LPITEM old = FindItemByID(pAffect->dwFlag);
+				if (!IsValidItemPosition(DestCell) || !(item2 = GetItem(DestCell)))
+					return false;
 
-									if (NULL != old)
-									{
-										old->Lock(false);
-										old->SetSocket(0, false);
-									}
-
-									RemoveAffect(pAffect);
-
-									EPointTypes bonus = POINT_NONE;
-
-									if (true == isSpecialPotion)
-									{
-										if (type == AFFECT_AUTO_HP_RECOVERY)
-										{
-											bonus = POINT_MAX_HP_PCT;
-										}
-										else if (type == AFFECT_AUTO_SP_RECOVERY)
-										{
-											bonus = POINT_MAX_SP_PCT;
-										}
-									}
+				if (item2->IsEquipped())
+					return false;
 
-									AddAffect(type, bonus, 4, item->GetID(), INFINITE_AFFECT_DURATION, 0, true, false);
+				if (item2->GetType() == ITEM_COSTUME)
+					return false;
 
-									item->Lock(true);
-									item->SetSocket(0, true);
+				if (item2->IsExchanging() == true)
+					return false;
 
-									AutoRecoveryItemProcess(type);
-								}
-							}
-						}
-						break;
-					}
+				if (item2->GetAttributeSetIndex() == -1)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ӽ    Դϴ."));
+					return false;
 				}
-				break;
 
-				case USE_CLEAR:
+				if (item2->ChangeRareAttribute() == true)
 				{
-					switch (item->GetVnum())
-					{
-						case 27124: // Bandage
-							RemoveBleeding();
-							break;
+					char buf[21];
+					snprintf(buf, sizeof(buf), "%u", item2->GetID());
+					LogManager::instance().ItemLog(this, item, "CHANGE_RARE_ATTR", buf);
 
-						case 27874: // Grilled Perch
-							RemoveBadAffect();
-							break;
-					}
-					item->SetCount(item->GetCount() - 1);
+					if (!g_bUnlimitedChangeRareAttributes)
+						item->SetCount(item->GetCount() - 1);
 				}
-				break;
+				else
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ӽ Ͽϴ."));
+				}
+			}
+			break;
 
-				case USE_INVISIBILITY:
+			case ITEM_AUTO_HP_RECOVERY_S:
+			case ITEM_AUTO_HP_RECOVERY_M:
+			case ITEM_AUTO_HP_RECOVERY_L:
+			case ITEM_AUTO_HP_RECOVERY_X:
+			case ITEM_AUTO_SP_RECOVERY_S:
+			case ITEM_AUTO_SP_RECOVERY_M:
+			case ITEM_AUTO_SP_RECOVERY_L:
+			case ITEM_AUTO_SP_RECOVERY_X:
+				// ù  ϴ  ġ ...
+				// ׷ ׳ ϵ ڵ.  ڿ ڵ ۵.
+			case REWARD_BOX_ITEM_AUTO_SP_RECOVERY_XS:
+			case REWARD_BOX_ITEM_AUTO_SP_RECOVERY_S:
+			case REWARD_BOX_ITEM_AUTO_HP_RECOVERY_XS:
+			case REWARD_BOX_ITEM_AUTO_HP_RECOVERY_S:
+			case FUCKING_BRAZIL_ITEM_AUTO_SP_RECOVERY_S:
+			case FUCKING_BRAZIL_ITEM_AUTO_HP_RECOVERY_S:
+			{
+				if (CArenaManager::instance().IsArenaMap(GetMapIndex()) == true)
 				{
-					if (item->GetVnum() == 70026)
-					{
-						quest::CQuestManager& q = quest::CQuestManager::instance();
-						quest::PC* pPC = q.GetPC(GetPlayerID());
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("忡 Ͻ  ϴ."));
+					return false;
+				}
 
-						if (pPC != NULL)
-						{
-							int last_use_time = pPC->GetFlag("mirror_of_disapper.last_use_time");
+				EAffectTypes type = AFFECT_NONE;
+				bool isSpecialPotion = false;
 
-							if (get_global_time() - last_use_time < 10 * 60)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("   ϴ."));
-								return false;
-							}
+				switch (item->GetVnum())
+				{
+				case ITEM_AUTO_HP_RECOVERY_X:
+					isSpecialPotion = true;
 
-							pPC->SetFlag("mirror_of_disapper.last_use_time", get_global_time());
-						}
-					}
+				case ITEM_AUTO_HP_RECOVERY_S:
+				case ITEM_AUTO_HP_RECOVERY_M:
+				case ITEM_AUTO_HP_RECOVERY_L:
+				case REWARD_BOX_ITEM_AUTO_HP_RECOVERY_XS:
+				case REWARD_BOX_ITEM_AUTO_HP_RECOVERY_S:
+				case FUCKING_BRAZIL_ITEM_AUTO_HP_RECOVERY_S:
+					type = AFFECT_AUTO_HP_RECOVERY;
+					break;
 
-					AddAffect(AFFECT_INVISIBILITY, POINT_NONE, 0, AFF_INVISIBILITY, 300, 0, true);
-					item->SetCount(item->GetCount() - 1);
+				case ITEM_AUTO_SP_RECOVERY_X:
+					isSpecialPotion = true;
+
+				case ITEM_AUTO_SP_RECOVERY_S:
+				case ITEM_AUTO_SP_RECOVERY_M:
+				case ITEM_AUTO_SP_RECOVERY_L:
+				case REWARD_BOX_ITEM_AUTO_SP_RECOVERY_XS:
+				case REWARD_BOX_ITEM_AUTO_SP_RECOVERY_S:
+				case FUCKING_BRAZIL_ITEM_AUTO_SP_RECOVERY_S:
+					type = AFFECT_AUTO_SP_RECOVERY;
+					break;
 				}
-				break;
 
-				case USE_POTION_NODELAY:
-				{
-					if (CArenaManager::instance().IsArenaMap(GetMapIndex()))
-					{
-						if (quest::CQuestManager::instance().GetEventFlag("arena_potion_limit") > 0)
-						{
-							ChatPacket(CHAT_TYPE_INFO, LC_STRING("忡 Ͻ  ϴ."));
-							return false;
-						}
+				if (AFFECT_NONE == type)
+					break;
 
-						switch (item->GetVnum())
-						{
-							case 70020:
-							case 71018:
-							case 71019:
-							case 71020:
-							{
-								if (quest::CQuestManager::instance().GetEventFlag("arena_potion_limit_count") < 10000)
-								{
-									if (m_nPotionLimit <= 0)
-									{
-										ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ѷ ʰϿϴ."));
-										return false;
-									}
-								}
-							}
-							break;
+				if (item->GetCount() > 1)
+				{
+					int pos = GetEmptyInventory(item->GetSize());
 
-							default:
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("忡 Ͻ  ϴ."));
-								return false;
-						}
+					if (-1 == pos)
+					{
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ǰ   ϴ."));
+						break;
 					}
 
-					bool bUsed = false;
+					item->SetCount(item->GetCount() - 1);
 
-					if (item->GetValue(0) != 0) // HP 밪 ȸ
-					{
-						if (GetHP() < GetMaxHP())
-						{
-							PointChange(POINT_HP, item->GetValue(0) * (100 + GetPoint(POINT_POTION_BONUS)) / 100);
-							EffectPacket(SE_HPUP_RED);
-							bUsed = true;
-						}
-					}
+					LPITEM item2 = ITEM_MANAGER::instance().CreateItem(item->GetVnum(), 1);
+					item2->AddToCharacter(this, TItemPos(INVENTORY, pos));
 
-					if (item->GetValue(1) != 0) // SP 밪 ȸ
+					if (item->GetSocket(1) != 0)
 					{
-						if (GetSP() < GetMaxSP())
-						{
-							PointChange(POINT_SP, item->GetValue(1) * (100 + GetPoint(POINT_POTION_BONUS)) / 100);
-							EffectPacket(SE_SPUP_BLUE);
-							bUsed = true;
-						}
+						item2->SetSocket(1, item->GetSocket(1));
 					}
 
-					if (item->GetValue(3) != 0) // HP % ȸ
-					{
-						if (GetHP() < GetMaxHP())
-						{
-							PointChange(POINT_HP, item->GetValue(3) * GetMaxHP() / 100);
-							EffectPacket(SE_HPUP_RED);
-							bUsed = true;
-						}
-					}
+					item = item2;
+				}
+
+				CAffect* pAffect = FindAffect(type);
 
-					if (item->GetValue(4) != 0) // SP % ȸ
+				if (NULL == pAffect)
+				{
+					EPointTypes bonus = POINT_NONE;
+
+					if (true == isSpecialPotion)
 					{
-						if (GetSP() < GetMaxSP())
+						if (type == AFFECT_AUTO_HP_RECOVERY)
 						{
-							PointChange(POINT_SP, item->GetValue(4) * GetMaxSP() / 100);
-							EffectPacket(SE_SPUP_BLUE);
-							bUsed = true;
+							bonus = POINT_MAX_HP_PCT;
 						}
-					}
-
-					if (bUsed)
-					{
-						if (item->GetVnum() == 50085 || item->GetVnum() == 50086)
+						else if (type == AFFECT_AUTO_SP_RECOVERY)
 						{
-							if (test_server)
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" Ǵ   Ͽϴ"));
-
-							SetUseSeedOrMoonBottleTime();
+							bonus = POINT_MAX_SP_PCT;
 						}
+					}
 
-						if (GetDungeon())
-							GetDungeon()->UsePotion(this);
-
-						if (GetWarMap())
-							GetWarMap()->UsePotion(this, item);
+					AddAffect(type, bonus, 4, item->GetID(), INFINITE_AFFECT_DURATION, 0, true, false);
 
-						m_nPotionLimit--;
+					item->Lock(true);
+					item->SetSocket(0, true);
 
-						// RESTRICT_USE_SEED_OR_MOONBOTTLE
-						item->SetCount(item->GetCount() - 1);
-						// END_RESTRICT_USE_SEED_OR_MOONBOTTLE
-					}
+					AutoRecoveryItemProcess(type);
 				}
-				break;
-
-				case USE_POTION:
+				else
 				{
-					if (CArenaManager::instance().IsArenaMap(GetMapIndex()) == true)
+					if (item->GetID() == pAffect->dwFlag)
 					{
-						if (quest::CQuestManager::instance().GetEventFlag("arena_potion_limit") > 0)
+						RemoveAffect(pAffect);
+
+						item->Lock(false);
+						item->SetSocket(0, false);
+					}
+					else
+					{
+						LPITEM old = FindItemByID(pAffect->dwFlag);
+
+						if (NULL != old)
 						{
-							ChatPacket(CHAT_TYPE_INFO, LC_STRING("忡 Ͻ  ϴ."));
-							return false;
+							old->Lock(false);
+							old->SetSocket(0, false);
 						}
 
-						switch (item->GetVnum())
+						RemoveAffect(pAffect);
+
+						EPointTypes bonus = POINT_NONE;
+
+						if (true == isSpecialPotion)
 						{
-							case 27001: // Red Potion (S)
-							case 27002: // Red Potion (M)
-							case 27003: // Red Potion (L)
-							case 27007: // Red Potion (XXL)
-							case 27004: // Blue Potion (S)
-							case 27005: // Blue Potion (M)
-							case 27006: // Blue Potion (L)
-							case 27008: // Red Potion (XXL)
+							if (type == AFFECT_AUTO_HP_RECOVERY)
 							{
-								if (quest::CQuestManager::instance().GetEventFlag("arena_potion_limit_count") < 10000)
-								{
-									if (m_nPotionLimit <= 0)
-									{
-										ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ѷ ʰϿϴ."));
-										return false;
-									}
-								}
+								bonus = POINT_MAX_HP_PCT;
+							}
+							else if (type == AFFECT_AUTO_SP_RECOVERY)
+							{
+								bonus = POINT_MAX_SP_PCT;
 							}
-							break;
-
-							default:
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("忡 Ͻ  ϴ."));
-								return false;
 						}
-					}
 
-					if (item->GetValue(1) != 0)
-					{
-						if (GetPoint(POINT_SP_RECOVERY) + GetSP() >= GetMaxSP())
-							return false;
+						AddAffect(type, bonus, 4, item->GetID(), INFINITE_AFFECT_DURATION, 0, true, false);
 
-						PointChange(POINT_SP_RECOVERY, item->GetValue(1) * MIN(200, (100 + GetPoint(POINT_POTION_BONUS))) / 100);
-						StartAffectEvent();
-						EffectPacket(SE_SPUP_BLUE);
-					}
+						item->Lock(true);
+						item->SetSocket(0, true);
 
-					if (item->GetValue(0) != 0)
-					{
-						if (GetPoint(POINT_HP_RECOVERY) + GetHP() >= GetMaxHP())
-							return false;
-
-						PointChange(POINT_HP_RECOVERY, item->GetValue(0) * MIN(200, (100 + GetPoint(POINT_POTION_BONUS))) / 100);
-						StartAffectEvent();
-						EffectPacket(SE_HPUP_RED);
+						AutoRecoveryItemProcess(type);
 					}
+				}
+			}
+			break;
+#ifdef __AURA_SYSTEM__
+			case ITEM_AURA_BOOST_ITEM_VNUM_BASE + ITEM_AURA_BOOST_ERASER:
+			{
+				LPITEM item2;
+				if (!IsValidItemPosition(DestCell) || !(item2 = GetItem(DestCell)))
+					return false;
 
-					if (GetDungeon())
-						GetDungeon()->UsePotion(this);
-
-					if (GetWarMap())
-						GetWarMap()->UsePotion(this, item);
+				if (item2->IsExchanging() || item2->IsEquipped())
+					return false;
 
-					item->SetCount(item->GetCount() - 1);
-					m_nPotionLimit--;
+#ifdef __SOUL_BIND_SYSTEM__
+				if (item2->IsSealed())
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  ȥ  ֱ   ƿ ǻ󿡼 νƮ   ϴ."));
+					return false;
 				}
-				break;
+#endif
 
-				case USE_POTION_CONTINUE:
+				if (item2->GetSocket(ITEM_SOCKET_AURA_BOOST) == 0)
 				{
-					if (item->GetValue(0) != 0)
-						AddAffect(AFFECT_HP_RECOVER_CONTINUE, POINT_HP_RECOVER_CONTINUE, item->GetValue(0), 0, item->GetValue(2), 0, true);
-					else if (item->GetValue(1) != 0)
-						AddAffect(AFFECT_SP_RECOVER_CONTINUE, POINT_SP_RECOVER_CONTINUE, item->GetValue(1), 0, item->GetValue(2), 0, true);
-					else
-						return false;
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  ǻ󿡴 νƮ ϴ."));
+					return false;
+				}
 
-					if (GetDungeon())
-						GetDungeon()->UsePotion(this);
+				if (IS_SET(item->GetFlag(), ITEM_FLAG_STACKABLE) && !IS_SET(item->GetAntiFlag(), ITEM_ANTIFLAG_STACK) && item->GetCount() > 1)
+					item->SetCount(item->GetCount() - 1);
+				else
+					ITEM_MANAGER::instance().RemoveItem(item);
 
-					if (GetWarMap())
-						GetWarMap()->UsePotion(this, item);
+				item2->SetSocket(ITEM_SOCKET_AURA_BOOST, 0);
+			}
+			break;
+#endif
+			}
+			break;
 
-					item->SetCount(item->GetCount() - 1);
-				}
+		case USE_CLEAR:
+		{
+			switch (item->GetVnum())
+			{
+			case 27124: // Bandage
+				RemoveBleeding();
+				break;
+			case 27874: // Grilled Perch
+			default:
+				RemoveBadAffect();
 				break;
+			}
+			item->SetCount(item->GetCount() - 1);
+		}
+		break;
+
+		case USE_INVISIBILITY:
+		{
+			if (item->GetVnum() == 70026)
+			{
+				quest::CQuestManager& q = quest::CQuestManager::instance();
+				quest::PC* pPC = q.GetPC(GetPlayerID());
 
-				case USE_ABILITY_UP:
+				if (pPC != NULL)
 				{
-					if (FindAffect(AFFECT_BLEND, item->GetValue(0)))
+					int last_use_time = pPC->GetFlag("mirror_of_disapper.last_use_time");
+
+					if (get_global_time() - last_use_time < 10 * 60)
 					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING("̹ ȿ ɷ ֽϴ."));
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("   ϴ."));
 						return false;
 					}
 
-					switch (item->GetValue(0))
+					pPC->SetFlag("mirror_of_disapper.last_use_time", get_global_time());
+				}
+			}
+
+			AddAffect(AFFECT_INVISIBILITY, POINT_NONE, 0, AFF_INVISIBILITY, 300, 0, true);
+			item->SetCount(item->GetCount() - 1);
+		}
+		break;
+
+		case USE_POTION_NODELAY:
+		{
+			if (CArenaManager::instance().IsArenaMap(GetMapIndex()) == true)
+			{
+				if (quest::CQuestManager::instance().GetEventFlag("arena_potion_limit") > 0)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("忡 Ͻ  ϴ."));
+					return false;
+				}
+
+				switch (item->GetVnum())
+				{
+				case 70020:
+				case 71018:
+				case 71019:
+				case 71020:
+					if (quest::CQuestManager::instance().GetEventFlag("arena_potion_limit_count") < 10000)
 					{
-						case APPLY_MOV_SPEED:
+						if (m_nPotionLimit <= 0)
 						{
-							VERIFY_POTION(AFFECT_MOV_SPEED, aApplyInfo[item->GetValue(0)].wPointType);
-							AddAffect(AFFECT_MOV_SPEED, POINT_MOV_SPEED, item->GetValue(2), AFF_MOV_SPEED_POTION, item->GetValue(1), 0, true);
-							EffectPacket(SE_DXUP_PURPLE);
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ѷ ʰϿϴ."));
+							return false;
 						}
-						break;
+					}
+					break;
 
-						case APPLY_ATT_SPEED:
-						{
-							VERIFY_POTION(AFFECT_ATT_SPEED, aApplyInfo[item->GetValue(0)].wPointType);
-							AddAffect(AFFECT_ATT_SPEED, POINT_ATT_SPEED, item->GetValue(2), AFF_ATT_SPEED_POTION, item->GetValue(1), 0, true);
-							EffectPacket(SE_SPEEDUP_GREEN);
-						}
-						break;
+				default:
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("忡 Ͻ  ϴ."));
+					return false;
+				}
+			}
 
-						case APPLY_STR:
-						{
-							VERIFY_POTION(AFFECT_STR, aApplyInfo[item->GetValue(0)].wPointType);
-							AddAffect(AFFECT_STR, POINT_ST, item->GetValue(2), 0, item->GetValue(1), 0, true);
-						}
-						break;
+			bool used = false;
 
-						case APPLY_DEX:
-						{
-							VERIFY_POTION(AFFECT_DEX, aApplyInfo[item->GetValue(0)].wPointType);
-							AddAffect(AFFECT_DEX, POINT_DX, item->GetValue(2), 0, item->GetValue(1), 0, true);
-						}
-						break;
+			if (item->GetValue(0) != 0) // HP 밪 ȸ
+			{
+				if (GetHP() < GetMaxHP())
+				{
+					PointChange(POINT_HP, item->GetValue(0) * (100 + GetPoint(POINT_POTION_BONUS)) / 100);
+					EffectPacket(SE_HPUP_RED);
+					used = TRUE;
+				}
+			}
 
-						case APPLY_CON:
-						{
-							VERIFY_POTION(AFFECT_CON, aApplyInfo[item->GetValue(0)].wPointType);
-							AddAffect(AFFECT_CON, POINT_HT, item->GetValue(2), 0, item->GetValue(1), 0, true);
-						}
-						break;
+			if (item->GetValue(1) != 0) // SP 밪 ȸ
+			{
+				if (GetSP() < GetMaxSP())
+				{
+					PointChange(POINT_SP, item->GetValue(1) * (100 + GetPoint(POINT_POTION_BONUS)) / 100);
+					EffectPacket(SE_SPUP_BLUE);
+					used = TRUE;
+				}
+			}
 
-						case APPLY_INT:
-						{
-							VERIFY_POTION(AFFECT_INT, aApplyInfo[item->GetValue(0)].wPointType);
-							AddAffect(AFFECT_INT, POINT_IQ, item->GetValue(2), 0, item->GetValue(1), 0, true);
-						}
-						break;
+			if (item->GetValue(3) != 0) // HP % ȸ
+			{
+				if (GetHP() < GetMaxHP())
+				{
+					PointChange(POINT_HP, item->GetValue(3) * GetMaxHP() / 100);
+					EffectPacket(SE_HPUP_RED);
+					used = TRUE;
+				}
+			}
 
-						case APPLY_CAST_SPEED:
-						{
-							VERIFY_POTION(AFFECT_CAST_SPEED, aApplyInfo[item->GetValue(0)].wPointType);
-							AddAffect(AFFECT_CAST_SPEED, POINT_CASTING_SPEED, item->GetValue(2), 0, item->GetValue(1), 0, true);
-						}
-						break;
+			if (item->GetValue(4) != 0) // SP % ȸ
+			{
+				if (GetSP() < GetMaxSP())
+				{
+					PointChange(POINT_SP, item->GetValue(4) * GetMaxSP() / 100);
+					EffectPacket(SE_SPUP_BLUE);
+					used = TRUE;
+				}
+			}
 
-						case APPLY_ATT_GRADE_BONUS:
-						{
-							VERIFY_POTION(AFFECT_ATT_GRADE, aApplyInfo[item->GetValue(0)].wPointType);
-							AddAffect(AFFECT_ATT_GRADE, POINT_ATT_GRADE_BONUS, item->GetValue(2), 0, item->GetValue(1), 0, true);
-						}
-						break;
+			if (used)
+			{
+				if (item->GetVnum() == 50085 || item->GetVnum() == 50086)
+				{
+					if (test_server)
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" Ǵ   Ͽϴ"));
+					SetUseSeedOrMoonBottleTime();
+				}
+				if (GetDungeon())
+					GetDungeon()->UsePotion(this);
 
-						case APPLY_DEF_GRADE_BONUS:
-						{
-							VERIFY_POTION(AFFECT_DEF_GRADE, aApplyInfo[item->GetValue(0)].wPointType);
-							AddAffect(AFFECT_DEF_GRADE, POINT_DEF_GRADE_BONUS, item->GetValue(2), 0, item->GetValue(1), 0, true);
-						}
-						break;
+				if (GetWarMap())
+					GetWarMap()->UsePotion(this, item);
 
-						case APPLY_RESIST_MAGIC:
-						{
-							VERIFY_POTION(AFFECT_UNIQUE_ABILITY, aApplyInfo[item->GetValue(0)].wPointType);
-							AddAffect(AFFECT_UNIQUE_ABILITY, POINT_RESIST_MAGIC, item->GetValue(2), 0, item->GetValue(1), 0, true, true);
-						}
-						break;
+				m_nPotionLimit--;
 
-#if defined(__CONQUEROR_LEVEL__)
-						case APPLY_SUNGMA_STR:
-						{
-							VERIFY_POTION(AFFECT_SUNGMA_STR, aApplyInfo[item->GetValue(0)].wPointType);
-							AddAffect(AFFECT_SUNGMA_STR, POINT_SUNGMA_STR, item->GetValue(2), 0, item->GetValue(1), 0, true);
-						}
-						break;
+				// RESTRICT_USE_SEED_OR_MOONBOTTLE
+				item->SetCount(item->GetCount() - 1);
+				// END_RESTRICT_USE_SEED_OR_MOONBOTTLE
+			}
+		}
+		break;
 
-						case APPLY_SUNGMA_HP:
-						{
-							VERIFY_POTION(AFFECT_SUNGMA_HP, aApplyInfo[item->GetValue(0)].wPointType);
-							AddAffect(AFFECT_SUNGMA_HP, POINT_SUNGMA_HP, item->GetValue(2), 0, item->GetValue(1), 0, true);
-						}
-						break;
+		case USE_POTION:
+		{
+			if (CArenaManager::instance().IsArenaMap(GetMapIndex()) == true)
+			{
+				if (quest::CQuestManager::instance().GetEventFlag("arena_potion_limit") > 0)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("忡 Ͻ  ϴ."));
+					return false;
+				}
 
-						case APPLY_SUNGMA_MOVE:
+				switch (item->GetVnum())
+				{
+				case 27001:
+				case 27002:
+				case 27003:
+				case 27004:
+				case 27005:
+				case 27006:
+					if (quest::CQuestManager::instance().GetEventFlag("arena_potion_limit_count") < 10000)
+					{
+						if (m_nPotionLimit <= 0)
 						{
-							VERIFY_POTION(AFFECT_SUNGMA_MOVE, aApplyInfo[item->GetValue(0)].wPointType);
-							AddAffect(AFFECT_SUNGMA_MOVE, POINT_SUNGMA_MOVE, item->GetValue(2), 0, item->GetValue(1), 0, true);
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ѷ ʰϿϴ."));
+							return false;
 						}
-						break;
+					}
+					break;
 
-						case APPLY_SUNGMA_IMMUNE:
-						{
-							VERIFY_POTION(AFFECT_SUNGMA_IMMUNE, aApplyInfo[item->GetValue(0)].wPointType);
-							AddAffect(AFFECT_SUNGMA_IMMUNE, POINT_SUNGMA_IMMUNE, item->GetValue(2), 0, item->GetValue(1), 0, true);
-						}
-						break;
-#endif
+				default:
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("忡 Ͻ  ϴ."));
+					return false;
+				}
+			}
 
-						case APPLY_ATTBONUS_MONSTER:
-						{
-							VERIFY_POTION(AFFECT_UNIQUE_ABILITY, aApplyInfo[item->GetValue(0)].wPointType);
-							AddAffect(AFFECT_UNIQUE_ABILITY, POINT_ATTBONUS_MONSTER, item->GetValue(2), 0, item->GetValue(1), 0, true, true);
-						}
-						break;
+			if (item->GetValue(1) != 0)
+			{
+				if (GetPoint(POINT_SP_RECOVERY) + GetSP() < GetMaxSP())
+				{
+					PointChange(POINT_SP_RECOVERY, item->GetValue(1) * MIN(200, (100 + GetPoint(POINT_POTION_BONUS))) / 100);
+					StartAffectEvent();
+					EffectPacket(SE_SPUP_BLUE);
+				}
+			}
 
-						case APPLY_MALL_EXPBONUS:
-						{
-							VERIFY_POTION(AFFECT_UNIQUE_ABILITY, aApplyInfo[item->GetValue(0)].wPointType);
-							AddAffect(AFFECT_UNIQUE_ABILITY, POINT_MALL_EXPBONUS, item->GetValue(2), 0, item->GetValue(1), 0, true, true);
-						}
-						break;
+			if (item->GetValue(0) != 0)
+			{
+				if (GetPoint(POINT_HP_RECOVERY) + GetHP() < GetMaxHP())
+				{
+					PointChange(POINT_HP_RECOVERY, item->GetValue(0) * MIN(200, (100 + GetPoint(POINT_POTION_BONUS))) / 100);
+					StartAffectEvent();
+					EffectPacket(SE_HPUP_RED);
+				}
+			}
 
-						case APPLY_MELEE_MAGIC_ATTBONUS_PER:
-						{
-							VERIFY_POTION(AFFECT_UNIQUE_ABILITY, aApplyInfo[item->GetValue(0)].wPointType);
-							AddAffect(AFFECT_UNIQUE_ABILITY, POINT_MELEE_MAGIC_ATT_BONUS_PER, item->GetValue(2), 0, item->GetValue(1), 0, true, true);
-						}
-						break;
+			if ((GetPoint(POINT_SP_RECOVERY) + GetSP() < GetMaxSP()) || (GetPoint(POINT_HP_RECOVERY) + GetHP() < GetMaxHP()))
+			{
+				if (GetDungeon())
+					GetDungeon()->UsePotion(this);
 
-						case APPLY_RESIST_ICE:
-						{
-							VERIFY_POTION(AFFECT_UNIQUE_ABILITY, aApplyInfo[item->GetValue(0)].wPointType);
-							AddAffect(AFFECT_UNIQUE_ABILITY, POINT_RESIST_ICE, item->GetValue(2), 0, item->GetValue(1), 0, true, true);
-						}
-						break;
+				if (GetWarMap())
+					GetWarMap()->UsePotion(this, item);
 
-						case APPLY_RESIST_EARTH:
-						{
-							VERIFY_POTION(AFFECT_UNIQUE_ABILITY, aApplyInfo[item->GetValue(0)].wPointType);
-							AddAffect(AFFECT_UNIQUE_ABILITY, POINT_RESIST_EARTH, item->GetValue(2), 0, item->GetValue(1), 0, true, true);
-						}
-						break;
+				item->SetCount(item->GetCount() - 1);
+				m_nPotionLimit--;
+			}
+		}
+		break;
 
-						case APPLY_RESIST_DARK:
-						{
-							VERIFY_POTION(AFFECT_UNIQUE_ABILITY, aApplyInfo[item->GetValue(0)].wPointType);
-							AddAffect(AFFECT_UNIQUE_ABILITY, POINT_RESIST_DARK, item->GetValue(2), 0, item->GetValue(1), 0, true, true);
-						}
-						break;
-					}
+		case USE_POTION_CONTINUE:
+		{
+			if (item->GetValue(0) != 0)
+			{
+				AddAffect(AFFECT_HP_RECOVER_CONTINUE, POINT_HP_RECOVER_CONTINUE, item->GetValue(0), 0, item->GetValue(2), 0, true);
+			}
+			else if (item->GetValue(1) != 0)
+			{
+				AddAffect(AFFECT_SP_RECOVER_CONTINUE, POINT_SP_RECOVER_CONTINUE, item->GetValue(1), 0, item->GetValue(2), 0, true);
+			}
+			else
+				return false;
+		}
 
-					if (GetDungeon())
-						GetDungeon()->UsePotion(this);
+		if (GetDungeon())
+			GetDungeon()->UsePotion(this);
 
-					if (GetWarMap())
-						GetWarMap()->UsePotion(this, item);
+		if (GetWarMap())
+			GetWarMap()->UsePotion(this, item);
 
-					item->SetCount(item->GetCount() - 1);
-				}
-				break;
+		item->SetCount(item->GetCount() - 1);
+		break;
 
-				case USE_TALISMAN:
+		case USE_ABILITY_UP:
+		{
+			switch (item->GetValue(0))
+			{
+			case APPLY_MOV_SPEED:
+#if defined(__EXTENDED_BLEND_AFFECT__)
+				if (FindAffect(AFFECT_MOVE_SPEED))
 				{
-					const int TOWN_PORTAL = 1;
-					const int MEMORY_PORTAL = 2;
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+					return false;
+				}
+#endif
 
-					// gm_guild_build, oxevent ʿ ȯ ȯ  ϰ 
-					if (GetMapIndex() == 200 || GetMapIndex() == 113)
-					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ġ   ϴ."));
-						return false;
-					}
+				if (FindAffect(AFFECT_MOV_SPEED))
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+					return false;
+				}
 
-					if (CArenaManager::instance().IsArenaMap(GetMapIndex()))
-					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ߿ ̿   ǰԴϴ."));
-						return false;
-					}
+				EffectPacket(SE_DXUP_PURPLE);
+				AddAffect(AFFECT_MOV_SPEED, POINT_MOV_SPEED, item->GetValue(2), AFF_MOV_SPEED_POTION, item->GetValue(1), 0, true);
+				break;
 
-					if (m_pkWarpEvent)
-					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING("̵ غ Ǿ ȯθ Ҽ ϴ"));
-						return false;
-					}
+			case APPLY_ATT_SPEED:
+#if defined(__EXTENDED_BLEND_AFFECT__)
+				if (FindAffect(AFFECT_ATTACK_SPEED))
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+					return false;
+				}
+#endif
 
-					// CONSUME_LIFE_WHEN_USE_WARP_ITEM
-					int consumeLife = CalculateConsume(this);
+				if (FindAffect(AFFECT_ATT_SPEED))
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+					return false;
+				}
 
-					if (consumeLife < 0)
-						return false;
-					// END_OF_CONSUME_LIFE_WHEN_USE_WARP_ITEM
+				EffectPacket(SE_SPEEDUP_GREEN);
+				AddAffect(AFFECT_ATT_SPEED, POINT_ATT_SPEED, item->GetValue(2), AFF_ATT_SPEED_POTION, item->GetValue(1), 0, true);
+				break;
 
-					if (item->GetValue(0) == TOWN_PORTAL) // ȯ
-					{
-						if (item->GetSocket(0) == 0)
-						{
-							if (!GetDungeon())
-								if (!GiveRecallItem(item))
-									return false;
+			case APPLY_STR:
+				AddAffect(AFFECT_STR, POINT_ST, item->GetValue(2), 0, item->GetValue(1), 0, true);
+				break;
 
-							PIXEL_POSITION posWarp;
+			case APPLY_DEX:
+				AddAffect(AFFECT_DEX, POINT_DX, item->GetValue(2), 0, item->GetValue(1), 0, true);
+				break;
 
-							if (SECTREE_MANAGER::instance().GetRecallPositionByEmpire(GetMapIndex(), GetEmpire(), posWarp))
-							{
-								// CONSUME_LIFE_WHEN_USE_WARP_ITEM
-								PointChange(POINT_HP, -consumeLife, false);
-								// END_OF_CONSUME_LIFE_WHEN_USE_WARP_ITEM
+			case APPLY_CON:
+				AddAffect(AFFECT_CON, POINT_HT, item->GetValue(2), 0, item->GetValue(1), 0, true);
+				break;
 
-								WarpSet(posWarp.x, posWarp.y);
-							}
-							else
-							{
-								sys_err("CHARACTER::UseItem : cannot find spawn position (name %s, %d x %d)", GetName(), GetX(), GetY());
-							}
-						}
-						else
-						{
-							if (test_server)
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ġ "));
+			case APPLY_INT:
+				AddAffect(AFFECT_INT, POINT_IQ, item->GetValue(2), 0, item->GetValue(1), 0, true);
+				break;
 
-							ProcessRecallItem(item);
-						}
-					}
-					else if (item->GetValue(0) == MEMORY_PORTAL) // ȯ
-					{
-						if (item->GetSocket(0) == 0)
-						{
-							if (GetDungeon())
-							{
-								const char* c_szConv = (g_iUseLocale ? "" : (under_han(item->GetName()) ? LC_STRING("") : LC_STRING("")));
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȿ %s%s   ϴ.", LC_ITEM(item->GetVnum()), c_szConv));
-								return false;
-							}
+			case APPLY_CAST_SPEED:
+				AddAffect(AFFECT_CAST_SPEED, POINT_CASTING_SPEED, item->GetValue(2), 0, item->GetValue(1), 0, true);
+				break;
 
-							if (!GiveRecallItem(item))
-								return false;
-						}
-						else
-						{
-							// CONSUME_LIFE_WHEN_USE_WARP_ITEM
-							PointChange(POINT_HP, -consumeLife, false);
-							// END_OF_CONSUME_LIFE_WHEN_USE_WARP_ITEM
+			case APPLY_ATT_GRADE_BONUS:
+				AddAffect(AFFECT_ATT_GRADE, POINT_ATT_GRADE_BONUS,
+					item->GetValue(2), 0, item->GetValue(1), 0, true);
+				break;
 
-							ProcessRecallItem(item);
-						}
-					}
-				}
+			case APPLY_DEF_GRADE_BONUS:
+				AddAffect(AFFECT_DEF_GRADE, POINT_DEF_GRADE_BONUS,
+					item->GetValue(2), 0, item->GetValue(1), 0, true);
 				break;
+			}
+		}
 
-				case USE_TUNING:
-				case USE_DETACHMENT:
-				{
-					LPITEM item2;
+		if (GetDungeon())
+			GetDungeon()->UsePotion(this);
 
-					if (!IsValidItemPosition(DestCell) || !(item2 = GetItem(DestCell)))
-						return false;
+		if (GetWarMap())
+			GetWarMap()->UsePotion(this, item);
 
-					if (item2->IsEquipped())
-						return false;
+		item->SetCount(item->GetCount() - 1);
+		break;
 
-					if (item2->IsExchanging())
-						return false;
+		case USE_TALISMAN:
+		{
+			const int TOWN_PORTAL = 1;
+			const int MEMORY_PORTAL = 2;
 
-#if defined(__SOUL_BIND_SYSTEM__)
-					if (item2->IsSealed())
-					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot improve a soulbound item."));
-						return false;
-					}
-#endif
+			// gm_guild_build, oxevent ʿ ȯ ȯ  ϰ 
+			if (GetMapIndex() == 200 || GetMapIndex() == 113)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ġ   ϴ."));
+				return false;
+			}
 
-					if (PreventTradeWindow(WND_ALL))
-					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING("â,ŷâ  ¿  Ҽ ϴ"));
-						return false;
-					}
+			if (CArenaManager::instance().IsArenaMap(GetMapIndex()) == true)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ߿ ̿   ǰԴϴ."));
+				return false;
+			}
 
-					RefineItem(item, item2);
-				}
-				break;
+			if (m_pkWarpEvent)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̵ غ Ǿ ȯθ Ҽ ϴ"));
+				return false;
+			}
 
-				// ACCESSORY_REFINE & ADD/CHANGE_ATTRIBUTES
-				case USE_PUT_INTO_BELT_SOCKET:
-				case USE_PUT_INTO_RING_SOCKET:
-				case USE_PUT_INTO_ACCESSORY_SOCKET:
-				case USE_ADD_ACCESSORY_SOCKET:
-				case USE_CLEAN_SOCKET:
-				case USE_CHANGE_ATTRIBUTE:
-#if defined(__ATTR_6TH_7TH__)
-				case USE_CHANGE_ATTRIBUTE2:
-#endif
-				case USE_ADD_ATTRIBUTE:
-				case USE_ADD_ATTRIBUTE2:
-#if defined(__MOVE_COSTUME_ATTR__)
-				case USE_RESET_COSTUME_ATTR:
-				case USE_CHANGE_COSTUME_ATTR:
-#endif
-#if defined(__CHANGED_ATTR__)
-				case USE_SELECT_ATTRIBUTE:
-#endif
+			// CONSUME_LIFE_WHEN_USE_WARP_ITEM
+			int consumeLife = CalculateConsume(this);
+
+			if (consumeLife < 0)
+				return false;
+			// END_OF_CONSUME_LIFE_WHEN_USE_WARP_ITEM
+
+			if (item->GetValue(0) == TOWN_PORTAL) // ȯ
+			{
+				if (item->GetSocket(0) == 0)
 				{
-					LPITEM item2;
-					if (!IsValidItemPosition(DestCell) || !(item2 = GetItem(DestCell)))
-						return false;
+					if (!GetDungeon())
+						if (!GiveRecallItem(item))
+							return false;
 
-					if (item2->IsEquipped())
+					PIXEL_POSITION posWarp;
+
+					if (SECTREE_MANAGER::instance().GetRecallPositionByEmpire(GetMapIndex(), GetEmpire(), posWarp))
 					{
-						BuffOnAttr_RemoveBuffsFromItem(item2);
-					}
+						// CONSUME_LIFE_WHEN_USE_WARP_ITEM
+						PointChange(POINT_HP, -consumeLife, false);
+						// END_OF_CONSUME_LIFE_WHEN_USE_WARP_ITEM
 
-					// [NOTE] ڽƬ ۿ     Ӽ οϵ, 簡  ƴ޶ û ־.
-					//  ANTI_CHANGE_ATTRIBUTE   Flag ߰Ͽ ȹ  ϰ Ʈ   ֵ  ̾
-					// ׵ ʿ ġ  ش޷ ׳ ⼭ ... -_-
-					/*
-					if (IS_SET(item2->GetAntiFlag(), ITEM_ANTIFLAG_CHANGE_ATTRIBUTE) && !item->IsSocketModifyingItem())
+						WarpSet(posWarp.x, posWarp.y);
+					}
+					else
 					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot change the upgrade of this item."));
-						return false;
+						sys_err("CHARACTER::UseItem : cannot find spawn position (name %s, %d x %d)", GetName(), GetX(), GetY());
 					}
-					*/
+				}
+				else
+				{
+					if (test_server)
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ġ "));
 
-					if (ITEM_COSTUME == item2->GetType()
-#if defined(__MOVE_COSTUME_ATTR__)	
-						&& item->GetSubType() != USE_RESET_COSTUME_ATTR && item->GetSubType() != USE_CHANGE_COSTUME_ATTR
-#endif
-#if defined(__CHANGED_ATTR__)
-						&& item->GetSubType() != USE_SELECT_ATTRIBUTE
-#endif
-						)
+					ProcessRecallItem(item);
+				}
+			}
+			else if (item->GetValue(0) == MEMORY_PORTAL) // ȯ
+			{
+				if (item->GetSocket(0) == 0)
+				{
+					if (GetDungeon())
 					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ӽ    Դϴ."));
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ȿ %s%s   ϴ."), item->GetLocaleName(),
+							g_iUseLocale ? "" : (under_han(item->GetName()) ? LC_TEXT("") : LC_TEXT("")));
 						return false;
 					}
 
-					if (item2->IsExchanging() || item2->IsEquipped())
+					if (!GiveRecallItem(item))
 						return false;
+				}
+				else
+				{
+					// CONSUME_LIFE_WHEN_USE_WARP_ITEM
+					PointChange(POINT_HP, -consumeLife, false);
+					// END_OF_CONSUME_LIFE_WHEN_USE_WARP_ITEM
 
-					switch (item->GetSubType())
-					{
-						case USE_CLEAN_SOCKET:
-						{
-							int i;
-							for (i = 0; i < METIN_SOCKET_MAX_NUM; ++i)
-							{
-								if (item2->GetSocket(i) == ITEM_BROKEN_METIN_VNUM)
-									break;
-							}
-
-							if (i == METIN_SOCKET_MAX_NUM)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("û   ʽϴ."));
-								return false;
-							}
+					ProcessRecallItem(item);
+				}
+			}
+		}
+		break;
 
-							int j = 0;
+		case USE_TUNING:
+		case USE_DETACHMENT:
+		{
+			LPITEM item2;
 
-							for (i = 0; i < METIN_SOCKET_MAX_NUM; ++i)
-							{
-								if (item2->GetSocket(i) != ITEM_BROKEN_METIN_VNUM && item2->GetSocket(i) != 0)
-									item2->SetSocket(j++, item2->GetSocket(i));
-							}
+			if (!IsValidItemPosition(DestCell) || !(item2 = GetItem(DestCell)))
+				return false;
 
-							for (; j < METIN_SOCKET_MAX_NUM; ++j)
-							{
-								if (item2->GetSocket(j) > 0)
-									item2->SetSocket(j, 1);
-							}
+			if (item2->IsEquipped())
+				return false;
 
-							{
-								char buf[21];
-								snprintf(buf, sizeof(buf), "%u", item2->GetID());
-								LogManager::instance().ItemLog(this, item, "CLEAN_SOCKET", buf);
-							}
+			if (item2->IsExchanging())
+				return false;
 
-							if (!g_bUnlimitedCleanSocket)
-								item->SetCount(item->GetCount() - 1);
-						}
-						break;
+#if defined(__STONE_OF_BLESS__)
+			if (item->GetValue(0) == STONE_OF_BLESS)
+			{
+				if (item2->GetLevelLimit() <= 80)
+					return false;
+			}
+#endif
 
-						case USE_CHANGE_ATTRIBUTE:
-						{
-#if defined(__SOUL_BIND_SYSTEM__)
-							if (item2->IsSealed())
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot change the attributes of a soulbound item."));
-								return false;
-							}
+#if defined(__SOUL_SYSTEM__)
+			if (item->GetValue(0) == SOUL_EVOLVE_SCROLL || item->GetValue(0) == SOUL_AWAKE_SCROLL)
+			{
+				if (item2->GetType() != ITEM_SOUL)
+					return false;
+			}
 #endif
 
-							if (IS_SET(item2->GetAntiFlag(), ITEM_ANTIFLAG_ENCHANT))
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("Enchant Item cannot be used on this item."));
-								return false;
-							}
+			if (item2->GetVnum() >= 28330 && item2->GetVnum() <= 28343) // +3
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("+3      ϴ"));
+				return false;
+			}
 
-							if (item2->GetAttributeSetIndex() == -1)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ӽ    Դϴ."));
-								return false;
-							}
+			if (item2->GetVnum() >= 28430 && item2->GetVnum() <= 28443) // +4
+			{
+				if (item->GetVnum() == 71056) // ûǼ
+				{
+					RefineItem(item, item2);
+				}
+				else
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("     ϴ"));
+				}
+			}
+			else
+			{
+				RefineItem(item, item2);
+			}
+		}
+		break;
 
-							if (item2->GetAttributeCount() == 0)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" Ӽ ϴ."));
-								return false;
-							}
+		// ACCESSORY_REFINE & ADD/CHANGE_ATTRIBUTES
+		case USE_PUT_INTO_BELT_SOCKET:
+		case USE_PUT_INTO_RING_SOCKET:
+		case USE_PUT_INTO_ACCESSORY_SOCKET:
+		case USE_ADD_ACCESSORY_SOCKET:
+		case USE_CLEAN_SOCKET:
+		case USE_CHANGE_ATTRIBUTE:
+		case USE_CHANGE_ATTRIBUTE2:
+		case USE_ADD_ATTRIBUTE:
+		case USE_ADD_ATTRIBUTE2:
+#ifdef __AURA_SYSTEM__
+		case USE_PUT_INTO_AURA_SOCKET:
+#endif
+		{
+			LPITEM item2;
+			if (!IsValidItemPosition(DestCell) || !(item2 = GetItem(DestCell)))
+				return false;
 
-							if (g_bChangeItemAttrCycle)
-							{
-								if (GM_PLAYER == GetGMLevel() && false == test_server)
-								{
-									//
-									// Event Flag     Ӽ   ð   ð 귶 ˻ϰ
-									// ð  귶ٸ  Ӽ濡  ð  ش.
-									//
-
-									DWORD dwChangeItemAttrCycle = quest::CQuestManager::instance().GetEventFlag(msc_szChangeItemAttrCycleFlag);
-									if (dwChangeItemAttrCycle < msc_dwDefaultChangeItemAttrCycle)
-										dwChangeItemAttrCycle = msc_dwDefaultChangeItemAttrCycle;
-
-									quest::PC* pPC = quest::CQuestManager::instance().GetPC(GetPlayerID());
-
-									if (pPC)
-									{
-										DWORD dwNowMin = get_global_time() / 60;
-
-										DWORD dwLastChangeItemAttrMin = pPC->GetFlag(msc_szLastChangeItemAttrFlag);
-
-										if (dwLastChangeItemAttrMin + dwChangeItemAttrCycle > dwNowMin)
-										{
-											ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ӽ ٲ %d ̳ ٽ   ϴ.(%d  )",
-												dwChangeItemAttrCycle, dwChangeItemAttrCycle - (dwNowMin - dwLastChangeItemAttrMin)));
-											return false;
-										}
+			if (item2->IsEquipped())
+			{
+				// BuffOnAttr_RemoveBuffsFromItem(item2);
+				return false;
+			}
 
-										pPC->SetFlag(msc_szLastChangeItemAttrFlag, dwNowMin);
-									}
-								}
-							}
+			// [NOTE] ڽƬ ۿ     Ӽ οϵ, 簡  ƴ޶ û ־.
+			//  ANTI_CHANGE_ATTRIBUTE   Flag ߰Ͽ ȹ  ϰ Ʈ   ֵ  ̾
+			// ׵ ʿ ġ  ش޷ ׳ ⼭ ... -_-
+			/*
+			if (IS_SET(item2->GetAntiFlag(), ITEM_ANTIFLAG_CHANGE_ATTRIBUTE) && !item->IsSocketModifyingItem())
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot change the upgrade of this item."));
+				return false;
+			}
+			*/
 
-							if (item->GetVnum() == 76014)
-							{
-								int aiChangeProb[ITEM_ATTRIBUTE_MAX_LEVEL] =
-								{
-									0, 10, 50, 39, 1
-								};
+			if (ITEM_COSTUME == item2->GetType())
+#ifdef __AURA_SYSTEM__
+			if (item->GetSubType() != USE_PUT_INTO_AURA_SOCKET)
+#endif
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ӽ    Դϴ."));
+				return false;
+			}
 
-								item2->ChangeAttribute(aiChangeProb);
-							}
-							else
-							{
-								//  Ưó
-								//  簡 ߰ ȵɰŶ Ͽ ϵ ڵ.
-								if (item->GetVnum() == 71151 || item->GetVnum() == 76023)
-								{
-									if ((item2->GetType() == ITEM_WEAPON) || (item2->GetType() == ITEM_ARMOR && item2->GetSubType() == ARMOR_BODY))
-									{
-										bool bCanUse = true;
-										for (int i = 0; i < ITEM_LIMIT_MAX_NUM; ++i)
-										{
-											if (item2->GetLimitType(i) == LIMIT_LEVEL && item2->GetLimitValue(i) > 40)
-											{
-												bCanUse = false;
-												break;
-											}
-										}
-										if (false == bCanUse)
-										{
-											ChatPacket(CHAT_TYPE_INFO, LC_STRING("    Ұմϴ."));
-											break;
-										}
-									}
-									else
-									{
-										ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ʿ  մϴ."));
-										break;
-									}
-								}
-								item2->ChangeAttribute();
-							}
+			if (item2->IsOldHair() && item->IsCostumeModifyItem())
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot change the upgrade of this item."));
+				return false;
+			}
 
-							ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ӽ Ͽϴ."));
-							{
-								char buf[21];
-								snprintf(buf, sizeof(buf), "%u", item2->GetID());
-								LogManager::instance().ItemLog(this, item, "CHANGE_ATTRIBUTE", buf);
-							}
+#if defined(__SOUL_BIND_SYSTEM__)
+			if (item2->IsSealed())
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot change the attributes of a soulbound item."));
+				return false;
+			}
+#endif
 
-							if (!g_bUnlimitedChangeAttributes)
-								item->SetCount(item->GetCount() - 1);
-						}
+			if (item2->IsExchanging())
+				return false;
+
+			switch (item->GetSubType())
+			{
+			case USE_CLEAN_SOCKET:
+			{
+				int i;
+				for (i = 0; i < ITEM_SOCKET_MAX_NUM; ++i)
+				{
+					if (item2->GetSocket(i) == ITEM_BROKEN_METIN_VNUM)
 						break;
+				}
 
-						case USE_ADD_ATTRIBUTE:
-						{
-							if (IS_SET(item2->GetAntiFlag(), ITEM_ANTIFLAG_REINFORCE))
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("Reinforce Item cannot be used on this item."));
-								return false;
-							}
+				if (i == ITEM_SOCKET_MAX_NUM)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("û   ʽϴ."));
+					return false;
+				}
 
-							if (item2->GetAttributeSetIndex() == -1)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ӽ    Դϴ."));
-								return false;
-							}
+				int j = 0;
 
-							if (item2->GetAttributeCount() < 4)
-							{
-								// 簡 Ưó
-								//  簡 ߰ ȵɰŶ Ͽ ϵ ڵ.
-								if (item->GetVnum() == 71152 || item->GetVnum() == 76024)
-								{
-									if ((item2->GetType() == ITEM_WEAPON) || (item2->GetType() == ITEM_ARMOR && item2->GetSubType() == ARMOR_BODY))
-									{
-										bool bCanUse = true;
-										for (int i = 0; i < ITEM_LIMIT_MAX_NUM; ++i)
-										{
-											if (item2->GetLimitType(i) == LIMIT_LEVEL && item2->GetLimitValue(i) > 40)
-											{
-												bCanUse = false;
-												break;
-											}
-										}
-										if (false == bCanUse)
-										{
-											ChatPacket(CHAT_TYPE_INFO, LC_STRING("    Ұմϴ."));
-											break;
-										}
-									}
-									else
-									{
-										ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ʿ  մϴ."));
-										break;
-									}
-								}
+				for (i = 0; i < ITEM_SOCKET_MAX_NUM; ++i)
+				{
+					if (item2->GetSocket(i) != ITEM_BROKEN_METIN_VNUM && item2->GetSocket(i) != 0)
+						item2->SetSocket(j++, item2->GetSocket(i));
+				}
 
-								char buf[21];
-								snprintf(buf, sizeof(buf), "%u", item2->GetID());
+				for (; j < ITEM_SOCKET_MAX_NUM; ++j)
+				{
+					if (item2->GetSocket(j) > 0)
+						item2->SetSocket(j, 1);
+				}
 
-								if (number(1, 100) <= aiItemAttributeAddPercent[item2->GetAttributeCount()] || g_bNeverFailAddAttributes == true)
-								{
-									item2->AddAttribute();
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ӽ ߰ Ͽϴ."));
+				{
+					char buf[21];
+					snprintf(buf, sizeof(buf), "%u", item2->GetID());
+					LogManager::instance().ItemLog(this, item, "CLEAN_SOCKET", buf);
+				}
 
-									int iAddedIdx = item2->GetAttributeCount() - 1;
-									LogManager::instance().ItemLog(
-										GetPlayerID(),
-										item2->GetAttributeType(iAddedIdx),
-										item2->GetAttributeValue(iAddedIdx),
-										item->GetID(),
-										"ADD_ATTRIBUTE_SUCCESS",
-										buf,
-										GetDesc()->GetHostName(),
-										item->GetOriginalVnum()
-									);
-								}
-								else
-								{
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ӽ ߰ Ͽϴ."));
-									LogManager::instance().ItemLog(this, item, "ADD_ATTRIBUTE_FAIL", buf);
-								}
+				if (!g_bUnlimitedCleanSocket)
+					item->SetCount(item->GetCount() - 1);
+			}
+			break;
 
-								if (!g_bUnlimitedAddAttributes)
-									item->SetCount(item->GetCount() - 1);
-							}
-							else
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("̻   ̿Ͽ Ӽ ߰  ϴ."));
-							}
-						}
-						break;
+			case USE_CHANGE_ATTRIBUTE:
+			case USE_CHANGE_ATTRIBUTE2:
+			{
+#if defined(__SOUL_BIND_SYSTEM__)
+				if (item2->IsSealed())
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot change the attributes of a soulbound item."));
+					return false;
+				}
+#endif
 
-						case USE_ADD_ATTRIBUTE2:
-						{
-							if (IS_SET(item2->GetAntiFlag(), ITEM_ANTIFLAG_REINFORCE))
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("Reinforce Item cannot be used on this item."));
-								return false;
-							}
+				//< 2020.08.07.Owsap - Block item attribute enchant.
+				if (IS_SET(item2->GetAntiFlag(), ITEM_ANTIFLAG_ENCHANT))
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Enchant Item cannot be used on this item."));
+					return false;
+				}
+				//>
 
-							// ູ 
-							// 簡񼭸  Ӽ 4 ߰ Ų ۿ ؼ ϳ Ӽ  ٿش.
-							if (item2->GetAttributeSetIndex() == -1)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ӽ    Դϴ."));
-								return false;
-							}
+				if (item2->GetAttributeSetIndex() == -1)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ӽ    Դϴ."));
+					return false;
+				}
 
-							// Ӽ ̹ 4 ߰ Ǿ  Ӽ ߰ ϴ.
-							if (item2->GetAttributeCount() == 4)
-							{
-								char buf[21];
-								snprintf(buf, sizeof(buf), "%u", item2->GetID());
+				if (item2->GetAttributeCount() == 0)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" Ӽ ϴ."));
+					return false;
+				}
 
-								if (number(1, 100) <= aiItemAttributeAddPercent[item2->GetAttributeCount()] || g_bNeverFailAddAttributes == true)
-								{
-									item2->AddAttribute();
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ӽ ߰ Ͽϴ."));
+				if (g_bChangeItemAttrCycle)
+				{
+					if (GM_PLAYER == GetGMLevel() && false == test_server)
+					{
+						//
+						// Event Flag     Ӽ   ð   ð 귶 ˻ϰ
+						// ð  귶ٸ  Ӽ濡  ð  ش.
+						//
 
-									int iAddedIdx = item2->GetAttributeCount() - 1;
-									LogManager::instance().ItemLog(
-										GetPlayerID(),
-										item2->GetAttributeType(iAddedIdx),
-										item2->GetAttributeValue(iAddedIdx),
-										item->GetID(),
-										"ADD_ATTRIBUTE2_SUCCESS",
-										buf,
-										GetDesc()->GetHostName(),
-										item->GetOriginalVnum()
-									);
-								}
-								else
-								{
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ӽ ߰ Ͽϴ."));
-									LogManager::instance().ItemLog(this, item, "ADD_ATTRIBUTE2_FAIL", buf);
-								}
+						DWORD dwChangeItemAttrCycle = quest::CQuestManager::instance().GetEventFlag(msc_szChangeItemAttrCycleFlag);
+						if (dwChangeItemAttrCycle < msc_dwDefaultChangeItemAttrCycle)
+							dwChangeItemAttrCycle = msc_dwDefaultChangeItemAttrCycle;
 
-								if (!g_bUnlimitedAddAttributes)
-									item->SetCount(item->GetCount() - 1);
-							}
-							else if (item2->GetAttributeCount() == 5)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ̻   ̿Ͽ Ӽ ߰  ϴ."));
-							}
-							else if (item2->GetAttributeCount() < 4)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" 簡񼭸 ̿Ͽ Ӽ ߰ ּ."));
-							}
-							else
-							{
-								// wtf ?!
-								sys_err("ADD_ATTRIBUTE2 : Item has wrong AttributeCount(%d)", item2->GetAttributeCount());
-							}
-						}
-						break;
+						quest::PC* pPC = quest::CQuestManager::instance().GetPC(GetPlayerID());
 
-#if defined(__ATTR_6TH_7TH__)
-						case USE_CHANGE_ATTRIBUTE2:
+						if (pPC)
 						{
-#if defined(__SOUL_BIND_SYSTEM__)
-							if (item2->IsSealed())
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot change the attributes of a soulbound item."));
-								return false;
-							}
-#endif
+							DWORD dwNowMin = get_global_time() / 60;
 
-							if (IS_SET(item2->GetAntiFlag(), ITEM_ANTIFLAG_ENCHANT))
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("Enchant Item cannot be used on this item."));
-								return false;
-							}
-
-							if (item2->GetAttributeSetIndex() == -1)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ӽ    Դϴ."));
-								return false;
-							}
+							DWORD dwLastChangeItemAttrMin = pPC->GetFlag(msc_szLastChangeItemAttrFlag);
 
-							if (item2->GetRareAttrCount() == 0)
+							if (dwLastChangeItemAttrMin + dwChangeItemAttrCycle > dwNowMin)
 							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" Ӽ ϴ."));
+								ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ӽ ٲ %d ̳ ٽ   ϴ.(%d  )"),
+									dwChangeItemAttrCycle, dwChangeItemAttrCycle - (dwNowMin - dwLastChangeItemAttrMin));
 								return false;
 							}
 
-							if (number(1, 100) <= item->GetValue(0))
-							{
-								if (item2->ChangeRareAttribute())
-								{
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ӽ Ͽϴ."));
-									{
-										char szBuff[21];
-										snprintf(szBuff, sizeof(szBuff), "%u", item2->GetID());
-										LogManager::instance().ItemLog(this, item, "CHANGE_ATTRIBUTE2", szBuff);
-									}
-								}
-							}
-							else
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("Upgrade change failed."));
-							}
-
-							item->SetCount(item->GetCount() - 1);
+							pPC->SetFlag(msc_szLastChangeItemAttrFlag, dwNowMin);
 						}
-						break;
-#endif
-
-						case USE_ADD_ACCESSORY_SOCKET:
-						{
-							char buf[21];
-							snprintf(buf, sizeof(buf), "%u", item2->GetID());
+					}
+				}
 
-							if (item2->IsAccessoryForSocket())
-							{
-								if (item2->GetAccessorySocketMaxGrade() < ITEM_ACCESSORY_SOCKET_MAX_NUM)
-								{
-									if (number(1, 100) <= 50 || g_bNeverFailAccessorySocket == true)
-									{
-										item2->SetAccessorySocketMaxGrade(item2->GetAccessorySocketMaxGrade() + 1);
-										ChatPacket(CHAT_TYPE_INFO, LC_STRING("  ߰Ǿϴ."));
-										LogManager::instance().ItemLog(this, item, "ADD_SOCKET_SUCCESS", buf);
-									}
-									else
-									{
-										ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ߰ Ͽϴ."));
-										LogManager::instance().ItemLog(this, item, "ADD_SOCKET_FAIL", buf);
-									}
+				if (item->GetSubType() == USE_CHANGE_ATTRIBUTE2)
+				{
+					int aiChangeProb[ITEM_ATTRIBUTE_MAX_LEVEL] =
+					{
+						0, 0, 30, 40, 3
+					};
 
-									if (!g_bUnlimitedAddAccessorySocket)
-										item->SetCount(item->GetCount() - 1);
-								}
-								else
-								{
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ׼ ̻  ߰  ϴ."));
-								}
-							}
-							else
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("   ߰   Դϴ."));
-							}
-						}
-						break;
+					item2->ChangeAttribute(aiChangeProb);
+				}
+				else if (item->GetVnum() == 76014)
+				{
+					int aiChangeProb[ITEM_ATTRIBUTE_MAX_LEVEL] =
+					{
+						0, 10, 50, 39, 1
+					};
 
-						case USE_PUT_INTO_BELT_SOCKET:
-						case USE_PUT_INTO_ACCESSORY_SOCKET:
+					item2->ChangeAttribute(aiChangeProb);
+				}
+				else
+				{
+					//  Ưó
+					//  簡 ߰ ȵɰŶ Ͽ ϵ ڵ.
+					if (item->GetVnum() == 71151 || item->GetVnum() == 76023)
+					{
+						if ((item2->GetType() == ITEM_WEAPON) || (item2->GetType() == ITEM_ARMOR && item2->GetSubType() == ARMOR_BODY))
 						{
-							if (item2->IsAccessoryForSocket() && item->CanPutInto(item2))
+							bool bCanUse = true;
+							for (int i = 0; i < ITEM_LIMIT_MAX_NUM; ++i)
 							{
-								char buf[21];
-								snprintf(buf, sizeof(buf), "%u", item2->GetID());
-
-								if (item2->GetAccessorySocketGrade() < item2->GetAccessorySocketMaxGrade())
+								if (item2->GetLimitType(i) == LIMIT_LEVEL && item2->GetLimitValue(i) > 40)
 								{
-									if (number(1, 100) <= aiAccessorySocketPutPct[item2->GetAccessorySocketGrade()] || g_bNeverFailAccessory == true)
-									{
-										item2->SetAccessorySocketGrade(item2->GetAccessorySocketGrade() + 1);
-										ChatPacket(CHAT_TYPE_INFO, LC_STRING(" Ͽϴ."));
-										LogManager::instance().ItemLog(this, item, "PUT_SOCKET_SUCCESS", buf);
-									}
-									else
-									{
-										ChatPacket(CHAT_TYPE_INFO, LC_STRING(" Ͽϴ."));
-										LogManager::instance().ItemLog(this, item, "PUT_SOCKET_FAIL", buf);
-									}
-
-									if (!g_bUnlimitedAddAccessory)
-										item->SetCount(item->GetCount() - 1);
-								}
-								else
-								{
-									if (item2->GetAccessorySocketMaxGrade() == 0)
-										ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ̾Ƹ Ǽ  ߰ؾմϴ."));
-									else if (item2->GetAccessorySocketMaxGrade() < ITEM_ACCESSORY_SOCKET_MAX_NUM)
-									{
-										ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ׼ ̻   ϴ."));
-										ChatPacket(CHAT_TYPE_INFO, LC_STRING("̾Ƹ  ߰ؾմϴ."));
-									}
-									else
-										ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ׼ ̻    ϴ."));
+									bCanUse = false;
+									break;
 								}
 							}
-							else
+							if (false == bCanUse)
 							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("    ϴ."));
+								ChatPacket(CHAT_TYPE_INFO, LC_TEXT("    Ұմϴ."));
+								break;
 							}
 						}
-						break;
-
-#if defined(__MOVE_COSTUME_ATTR__)
-						case USE_RESET_COSTUME_ATTR:
-						case USE_CHANGE_COSTUME_ATTR:
+						else
 						{
-#if defined(__SOUL_BIND_SYSTEM__)
-							if (item2->IsSealed())
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot change the attributes of a soulbound item."));
-								return false;
-							}
-#endif
-
-							if (!item2->CanChangeCostumeAttr())
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ӽ    Դϴ."));
-								return false;
-							}
-
-							// NOTE: Prevent changing costumes without bonus.
-							if (item2->GetAttributeCount() == 0)
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ӽ    Դϴ."));
-								return false;
-							}
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ʿ  մϴ."));
+							break;
+						}
+					}
+					item2->ChangeAttribute();
+				}
 
-							switch (item->GetSubType())
-							{
-								case USE_RESET_COSTUME_ATTR:
-								{
-									item2->ClearAttribute();
-									item2->AlterToMagicItem();
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ӽ Ͽϴ."));
+				{
+					char buf[21];
+					snprintf(buf, sizeof(buf), "%u", item2->GetID());
+					LogManager::instance().ItemLog(this, item, "CHANGE_ATTRIBUTE", buf);
+				}
 
-									char buf[21];
-									snprintf(buf, sizeof(buf), "%u", item2->GetID());
-									LogManager::instance().ItemLog(this, item, "RESET_COSTUME_ATTR", buf);
+				if (!g_bUnlimitedChangeAttributes)
+					item->SetCount(item->GetCount() - 1);
+			}
+			break;
 
-									if (!g_bUnlimitedResetCostumeAttributes)
-										item->SetCount(item->GetCount() - 1);
+			case USE_ADD_ATTRIBUTE:
+			{
+				//< 2020.08.07.Owsap - Block item attribute reinforce.
+				if (IS_SET(item2->GetAntiFlag(), ITEM_ANTIFLAG_REINFORCE))
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Reinforce Item cannot be used on this item."));
+					return false;
+				}
+				//>
 
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ӽ Ͽϴ."));
-								}
-								break;
+				if (item2->GetAttributeSetIndex() == -1)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ӽ    Դϴ."));
+					return false;
+				}
 
-								case USE_CHANGE_COSTUME_ATTR:
+				if (item2->GetAttributeCount() < 4)
+				{
+					// 簡 Ưó
+					//  簡 ߰ ȵɰŶ Ͽ ϵ ڵ.
+					if (item->GetVnum() == 71152 || item->GetVnum() == 76024)
+					{
+						if ((item2->GetType() == ITEM_WEAPON) || (item2->GetType() == ITEM_ARMOR && item2->GetSubType() == ARMOR_BODY))
+						{
+							bool bCanUse = true;
+							for (int i = 0; i < ITEM_LIMIT_MAX_NUM; ++i)
+							{
+								if (item2->GetLimitType(i) == LIMIT_LEVEL && item2->GetLimitValue(i) > 40)
 								{
-									item2->ChangeAttribute();
-
-									char buf[21];
-									snprintf(buf, sizeof(buf), "%u", item2->GetID());
-									LogManager::instance().ItemLog(this, item, "CHANGE_COSTUME_ATTR", buf);
-
-									if (!g_bUnlimitedChangeCostumeAttributes)
-										item->SetCount(item->GetCount() - 1);
-
-									ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ӽ Ͽϴ."));
+									bCanUse = false;
+									break;
 								}
+							}
+							if (false == bCanUse)
+							{
+								ChatPacket(CHAT_TYPE_INFO, LC_TEXT("    Ұմϴ."));
 								break;
 							}
 						}
-						break;
-#endif
-
-#if defined(__CHANGED_ATTR__)
-						case USE_SELECT_ATTRIBUTE:
+						else
 						{
-#if defined(__SOUL_BIND_SYSTEM__)
-							if (item2->IsSealed())
-							{
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot change the attributes of a soulbound item."));
-								return false;
-							}
-#endif
-							SelectAttr(item, item2);
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ʿ  մϴ."));
+							break;
 						}
-						break;
-#endif
-					}
-
-					if (item2->IsEquipped())
-					{
-						BuffOnAttr_AddBuffsFromItem(item2);
 					}
-				}
-				break;
-				// END_OF_ACCESSORY_REFINE & END_OF_ADD_ATTRIBUTES & END_OF_CHANGE_ATTRIBUTES
 
-				case USE_CALL:
-					AggregateMonster();
-					if (!g_bUnlimitedCapeOfCourage)
-						item->SetCount(item->GetCount() - 1);
-					break;
+					char buf[21];
+					snprintf(buf, sizeof(buf), "%u", item2->GetID());
 
-				case USE_BAIT:
-				{
-					if (m_pkFishingEvent)
+					if (number(1, 100) <= aiItemAttributeAddPercent[item2->GetAttributeCount()] || g_bNeverFailAddAttributes == true)
 					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ߿ ̳ Ƴ  ϴ."));
-						return false;
-					}
-
-					LPITEM weapon = GetWear(WEAR_WEAPON);
-
-					if (!weapon || weapon->GetType() != ITEM_ROD)
-						return false;
+						item2->AddAttribute();
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ӽ ߰ Ͽϴ."));
 
-					if (weapon->GetSocket(2))
-					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING("̹ ִ ̳  %s ϴ.", LC_ITEM(item->GetVnum())));
+						int iAddedIdx = item2->GetAttributeCount() - 1;
+						LogManager::instance().ItemLog(
+							GetPlayerID(),
+							item2->GetAttributeType(iAddedIdx),
+							item2->GetAttributeValue(iAddedIdx),
+							item->GetID(),
+							"ADD_ATTRIBUTE_SUCCESS",
+							buf,
+							GetDesc()->GetHostName(),
+							item->GetOriginalVnum()
+						);
 					}
 					else
 					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING("ô뿡 %s ̳ ϴ.", LC_ITEM(item->GetVnum())));
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ӽ ߰ Ͽϴ."));
+						LogManager::instance().ItemLog(this, item, "ADD_ATTRIBUTE_FAIL", buf);
 					}
 
-					weapon->SetSocket(2, item->GetValue(0));
-					item->SetCount(item->GetCount() - 1);
+					if (!g_bUnlimitedAddAttributes)
+						item->SetCount(item->GetCount() - 1);
 				}
-				break;
+				else
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̻   ̿Ͽ Ӽ ߰  ϴ."));
+				}
+			}
+			break;
 
-				case USE_MOVE:
-				case USE_TREASURE_BOX:
-				case USE_MONEYBAG:
-					break;
+			case USE_ADD_ATTRIBUTE2:
+			{
+				//< 2020.08.07.Owsap - Block item attribute reinforce.
+				if (IS_SET(item2->GetAntiFlag(), ITEM_ANTIFLAG_REINFORCE))
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Reinforce Item cannot be used on this item."));
+					return false;
+				}
+				//>
 
-				case USE_AFFECT:
+				// ູ 
+				// 簡񼭸  Ӽ 4 ߰ Ų ۿ ؼ ϳ Ӽ  ٿش.
+				if (item2->GetAttributeSetIndex() == -1)
 				{
-#if defined(__FLOWER_EVENT__)
-					if (item->GetValue(0) == AFFECT_FLOWER_EVENT)
-						return CFlowerEvent::UseFlower(this, item);
-#endif
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ӽ    Դϴ."));
+					return false;
+				}
+
+				// Ӽ ̹ 4 ߰ Ǿ  Ӽ ߰ ϴ.
+				if (item2->GetAttributeCount() == 4)
+				{
+					char buf[21];
+					snprintf(buf, sizeof(buf), "%u", item2->GetID());
 
-#if defined(__SUMMER_EVENT_ROULETTE__)
-					if (item->GetValue(0) == AFFECT_LATE_SUMMER_EVENT_BUFF)
+					if (number(1, 100) <= aiItemAttributeAddPercent[item2->GetAttributeCount()] || g_bNeverFailAddAttributes == true)
 					{
-						if (FindAffect(item->GetValue(0)) || FindAffect(AFFECT_LATE_SUMMER_EVENT_PRIMIUM_BUFF))
-						{
-							ChatPacket(CHAT_TYPE_INFO, LC_STRING("This effect is already activated."));
-							return false;
-						}
+						item2->AddAttribute();
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ӽ ߰ Ͽϴ."));
 
-						AddAffect(item->GetValue(0), POINT_NONE, 0, AFF_NONE, INFINITE_AFFECT_DURATION, 0, true);
-						item->SetCount(item->GetCount() - 1);
-						return true;
+						int iAddedIdx = item2->GetAttributeCount() - 1;
+						LogManager::instance().ItemLog(
+							GetPlayerID(),
+							item2->GetAttributeType(iAddedIdx),
+							item2->GetAttributeValue(iAddedIdx),
+							item->GetID(),
+							"ADD_ATTRIBUTE2_SUCCESS",
+							buf,
+							GetDesc()->GetHostName(),
+							item->GetOriginalVnum()
+						);
 					}
-					else if (item->GetValue(0) == AFFECT_LATE_SUMMER_EVENT_PRIMIUM_BUFF)
+					else
 					{
-						if (FindAffect(item->GetValue(0)) || FindAffect(AFFECT_LATE_SUMMER_EVENT_BUFF))
-						{
-							ChatPacket(CHAT_TYPE_INFO, LC_STRING("This effect is already activated."));
-							return false;
-						}
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ӽ ߰ Ͽϴ."));
+						LogManager::instance().ItemLog(this, item, "ADD_ATTRIBUTE2_FAIL", buf);
+					}
 
-						AddAffect(item->GetValue(0), POINT_NONE, 0, AFF_NONE, INFINITE_AFFECT_DURATION, 0, true);
+					if (!g_bUnlimitedAddAttributes)
 						item->SetCount(item->GetCount() - 1);
-						return true;
-					}
-#endif
+				}
+				else if (item2->GetAttributeCount() == 5)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ̻   ̿Ͽ Ӽ ߰  ϴ."));
+				}
+				else if (item2->GetAttributeCount() < 4)
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" 簡񼭸 ̿Ͽ Ӽ ߰ ּ."));
+				}
+				else
+				{
+					// wtf ?!
+					sys_err("ADD_ATTRIBUTE2 : Item has wrong AttributeCount(%d)", item2->GetAttributeCount());
+				}
+			}
+			break;
 
-#if defined(__LOOT_FILTER_SYSTEM__) && defined(__PREMIUM_LOOT_FILTER__)
-					if (item->GetValue(0) == AFFECT_LOOTING_SYSTEM)
-					{
-						CAffect* pAffect = FindAffect(AFFECT_LOOTING_SYSTEM);
-						long lDuration = item->GetValue(3);
+			case USE_ADD_ACCESSORY_SOCKET:
+			{
+				char buf[21];
+				snprintf(buf, sizeof(buf), "%u", item2->GetID());
 
-						if (pAffect)
+				if (item2->IsAccessoryForSocket())
+				{
+					if (item2->GetAccessorySocketMaxGrade() < ITEM_ACCESSORY_SOCKET_MAX_NUM)
+					{
+						if (number(1, 100) <= 50 || g_bNeverFailAccessorySocket == true)
 						{
-							if (lDuration > 0)
-							{
-								if (pAffect->lDuration > LONG_MAX - lDuration)
-								{
-									sys_err("LOOT_FILTER_SYSTEM: Duration overflow, affect duration (%ld), item value3 (%ld)",
-										pAffect->lDuration, lDuration);
-									return false;
-								}
-							}
-							else
-							{
-								sys_err("LOOT_FILTER_SYSTEM: Item duration value3 (%ld) is not positive.", lDuration);
-								return false;
-							}
-
-							pAffect->bUpdate = true;
-							pAffect->lApplyValue += lDuration;
-
-							ChatPacket(CHAT_TYPE_NOTICE, LC_STRING("Loot filter duration extended."));
+							item2->SetAccessorySocketMaxGrade(item2->GetAccessorySocketMaxGrade() + 1);
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ߰Ǿϴ."));
+							LogManager::instance().ItemLog(this, item, "ADD_SOCKET_SUCCESS", buf);
 						}
 						else
 						{
-#if defined(__AFFECT_RENEWAL__)
-							AddRealTimeAffect(AFFECT_LOOTING_SYSTEM, POINT_NONE, 0, AFF_NONE, lDuration, 0, false, false);
-#else
-							AddAffect(AFFECT_LOOTING_SYSTEM, POINT_NONE, 0, AFF_NONE, lDuration, 0, false, false);
-#endif
-							ChatPacket(CHAT_TYPE_NOTICE, LC_STRING("Loot filter activated."));
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ߰ Ͽϴ."));
+							LogManager::instance().ItemLog(this, item, "ADD_SOCKET_FAIL", buf);
 						}
 
-						item->SetCount(item->GetCount() - 1);
-						return true;
-					}
-#endif
-
-					if (FindAffect(item->GetValue(0), aApplyInfo[item->GetValue(1)].wPointType))
-					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING("̹ ȿ ɷ ֽϴ."));
+						if (!g_bUnlimitedAddAccessorySocket)
+							item->SetCount(item->GetCount() - 1);
 					}
 					else
 					{
-						AddAffect(item->GetValue(0), aApplyInfo[item->GetValue(1)].wPointType, item->GetValue(2), 0, item->GetValue(3), 0, false);
-						item->SetCount(item->GetCount() - 1);
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ׼ ̻  ߰  ϴ."));
 					}
 				}
-				break;
-
-				case USE_CREATE_STONE:
+				else
 				{
-					AutoGiveItem(number(28000, 28012));
-					item->SetCount(item->GetCount() - 1);
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("   ߰   Դϴ."));
 				}
-				break;
+			}
+			break;
 
-				//   ų  ó
-				case USE_RECIPE:
+			case USE_PUT_INTO_BELT_SOCKET:
+			case USE_PUT_INTO_ACCESSORY_SOCKET:
+			{
+				if (item2->IsAccessoryForSocket() && item->CanPutInto(item2))
 				{
-					LPITEM pSource1 = FindSpecifyItem(item->GetValue(1));
-					DWORD dwSourceCount1 = item->GetValue(2);
-
-					LPITEM pSource2 = FindSpecifyItem(item->GetValue(3));
-					DWORD dwSourceCount2 = item->GetValue(4);
+					char buf[21];
+					snprintf(buf, sizeof(buf), "%u", item2->GetID());
 
-					if (dwSourceCount1 != 0)
+					if (item2->GetAccessorySocketGrade() < item2->GetAccessorySocketMaxGrade())
 					{
-						if (pSource1 == NULL)
+						if (number(1, 100) <= aiAccessorySocketPutPct[item2->GetAccessorySocketGrade()] || g_bNeverFailAccessory == true)
 						{
-							ChatPacket(CHAT_TYPE_INFO, LC_STRING("   ᰡ մϴ."));
-							return false;
-						}
-					}
-
-					if (dwSourceCount2 != 0)
-					{
-						if (pSource2 == NULL)
-						{
-							ChatPacket(CHAT_TYPE_INFO, LC_STRING("   ᰡ մϴ."));
-							return false;
+							item2->SetAccessorySocketGrade(item2->GetAccessorySocketGrade() + 1);
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" Ͽϴ."));
+							LogManager::instance().ItemLog(this, item, "PUT_SOCKET_SUCCESS", buf);
 						}
-					}
-
-					if (pSource1 != NULL)
-					{
-						if (pSource1->GetCount() < dwSourceCount1)
+						else
 						{
-							ChatPacket(CHAT_TYPE_INFO, LC_STRING("(%s) մϴ.", LC_ITEM(pSource1->GetVnum())));
-							return false;
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" Ͽϴ."));
+							LogManager::instance().ItemLog(this, item, "PUT_SOCKET_FAIL", buf);
 						}
 
-						pSource1->SetCount(pSource1->GetCount() - dwSourceCount1);
+						if (!g_bUnlimitedAddAccessory)
+							item->SetCount(item->GetCount() - 1);
 					}
-
-					if (pSource2 != NULL)
+					else
 					{
-						if (pSource2->GetCount() < dwSourceCount2)
+						if (item2->GetAccessorySocketMaxGrade() == 0)
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ̾Ƹ Ǽ  ߰ؾմϴ."));
+						else if (item2->GetAccessorySocketMaxGrade() < ITEM_ACCESSORY_SOCKET_MAX_NUM)
 						{
-							ChatPacket(CHAT_TYPE_INFO, LC_STRING("(%s) մϴ.", LC_ITEM(pSource2->GetVnum())));
-							return false;
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ׼ ̻   ϴ."));
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̾Ƹ  ߰ؾմϴ."));
 						}
-
-						pSource2->SetCount(pSource2->GetCount() - dwSourceCount2);
+						else
+							ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ׼ ̻    ϴ."));
 					}
+				}
+				else
+				{
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("    ϴ."));
+				}
+			}
+			break;
+#ifdef __AURA_SYSTEM__
+			case USE_PUT_INTO_AURA_SOCKET:
+			{
+				if (item2->IsAuraBoosterForSocket() && item->CanPutInto(item2))
+				{
+					char buf[21];
+					snprintf(buf, sizeof(buf), "%lu", item2->GetID());
 
-					LPITEM pBottle = FindSpecifyItem(50901);
-
-					if (!pBottle || pBottle->GetCount() < 1)
-					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING("  ڸϴ."));
-						return false;
-					}
+					const BYTE c_bAuraBoostIndex = item->GetOriginalVnum() - ITEM_AURA_BOOST_ITEM_VNUM_BASE;
+					item2->SetSocket(ITEM_SOCKET_AURA_BOOST, c_bAuraBoostIndex * 100000000 + item->GetValue(ITEM_AURA_BOOST_TIME_VALUE));
 
-					pBottle->SetCount(pBottle->GetCount() - 1);
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  νͰ  Ǿϴ."));
 
-					if (number(1, 100) > item->GetValue(5))
-					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING("  ߽ϴ."));
-						return false;
-					}
+					LogManager::instance().ItemLog(this, item, "PUT_AURA_SOCKET", buf);
 
-					AutoGiveItem(item->GetValue(0));
+					if (IS_SET(item->GetFlag(), ITEM_FLAG_STACKABLE) && !IS_SET(item->GetAntiFlag(), ITEM_ANTIFLAG_STACK) && item->GetCount() > 1)
+						item->SetCount(item->GetCount() - 1);
+					else
+						ITEM_MANAGER::instance().RemoveItem(item, "PUT_AURA_SOCKET_REMOVE");
 				}
-				break;
+				else
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  ۿ  νƮ ߰   ϴ."));
+			}
+			break;
+#endif
+			}
+
+			if (item2->IsEquipped())
+			{
+				BuffOnAttr_AddBuffsFromItem(item2);
 			}
 		}
 		break;
 
-		case ITEM_METIN:
+#if defined(__COSTUME_ATTR_SYSTEM__)
+		case USE_CHANGE_COSTUME_ATTR:
+		case USE_RESET_COSTUME_ATTR:
 		{
 			LPITEM item2;
-
 			if (!IsValidItemPosition(DestCell) || !(item2 = GetItem(DestCell)))
 				return false;
 
+			if (item2->IsEquipped())
+			{
+				BuffOnAttr_RemoveBuffsFromItem(item2);
+			}
+
+			if (ITEM_COSTUME != item2->GetType())
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ӽ    Դϴ."));
+				return false;
+			}
+
 			if (item2->IsExchanging())
 				return false;
 
-			if (item2->IsEquipped())
+			if (item2->GetAttributeSetIndex() == -1)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ӽ    Դϴ."));
 				return false;
+			}
 
-			if (IS_SET(item2->GetAntiFlag(), ITEM_ANTIFLAG_APPLY))
+			if (item2->GetAttributeCount() == 0)
 			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("This Spirit Stone cannot be attached to this type of item."));
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" Ӽ ϴ."));
 				return false;
 			}
 
-			if (item2->GetType() == ITEM_PICK)
+			switch (item->GetSubType())
+			{
+			case USE_CHANGE_COSTUME_ATTR:
+			{
+				item2->ChangeAttribute();
+				{
+					char buf[21];
+					snprintf(buf, sizeof(buf), "%u", item2->GetID());
+					LogManager::instance().ItemLog(this, item, "CHANGE_COSTUME_ATTR", buf);
+				}
+
+				if (!g_bUnlimitedChangeCostumeAttributes)
+					item->SetCount(item->GetCount() - 1);
+			}
+			break;
+			case USE_RESET_COSTUME_ATTR:
+			{
+				item2->ClearAttribute();
+				item2->AlterToMagicItem();
+				//item2->AlterToMagicItem(number(40, 50), number(10, 15));
+				{
+					char buf[21];
+					snprintf(buf, sizeof(buf), "%u", item2->GetID());
+					LogManager::instance().ItemLog(this, item, "RESET_COSTUME_ATTR", buf);
+				}
+
+				if (!g_bUnlimitedResetCostumeAttributes)
+					item->SetCount(item->GetCount() - 1);
+			}
+			break;
+			}
+
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ӽ Ͽϴ."));
+		}
+		break;
+#endif
+		// END_OF_ACCESSORY_REFINE & END_OF_ADD_ATTRIBUTES & END_OF_CHANGE_ATTRIBUTES
+
+		case USE_BAIT:
+		{
+			if (m_pkFishingEvent)
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ߿ ̳ Ƴ  ϴ."));
 				return false;
+			}
+
+			LPITEM weapon = GetWear(WEAR_WEAPON);
 
-			if (item2->GetType() == ITEM_ROD)
+			if (!weapon || weapon->GetType() != ITEM_ROD)
 				return false;
 
-			int i;
+			if (weapon->GetSocket(2))
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ִ ̳  %s ϴ."), item->GetLocaleName());
+			}
+			else
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ô뿡 %s ̳ ϴ."), item->GetLocaleName());
+			}
 
-			for (i = 0; i < METIN_SOCKET_MAX_NUM; ++i)
+			weapon->SetSocket(2, item->GetValue(0));
+			item->SetCount(item->GetCount() - 1);
+		}
+		break;
+
+		case USE_MOVE:
+		case USE_TREASURE_BOX:
+		case USE_MONEYBAG:
+			break;
+
+		case USE_AFFECT:
+		{
+#if defined(__ANTI_EXP_RING__)
+			if (g_bAntiExpRing)
 			{
-				DWORD dwVnum;
+				if (item->GetVnum() == ITEM_ANTI_EXP_RING)
+				{
+					if (!HasFrozenEXP())
+					{
+						FreezeEXP();
+						item->Lock(true);
+						item->SetSocket(1, true);
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You have frozen your experience."));
+					}
+					else
+					{
+						UnfreezeEXP();
+						item->Lock(false);
+						item->SetSocket(1, false);
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You have unfrozen your experience."));
+					}
+					break;
+				}
+			}
+#endif
 
-				if ((dwVnum = item2->GetSocket(i)) <= 2)
-					continue;
+			if (FindAffect(item->GetValue(0), aApplyInfo[item->GetValue(1)].bPointType))
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+			}
+			else
+			{
+				// PC_BANG_ITEM_ADD
+				if (item->IsPCBangItem() == true)
+				{
+					// PC  üũؼ ó
+					if (CPCBangManager::instance().IsPCBangIP(GetDesc()->GetHostName()) == false)
+					{
+						// PC  ƴ!
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  PC濡   ֽϴ."));
+						return false;
+					}
+				}
+				// END_PC_BANG_ITEM_ADD
 
-				const TItemTable* p = ITEM_MANAGER::instance().GetTable(dwVnum);
+				AddAffect(item->GetValue(0), aApplyInfo[item->GetValue(1)].bPointType, item->GetValue(2), 0, item->GetValue(3), 0, false);
+				item->SetCount(item->GetCount() - 1);
+			}
+		}
+		break;
+
+		case USE_CREATE_STONE:
+		{
+			AutoGiveItem(number(28000, 28012));
+			item->SetCount(item->GetCount() - 1);
+		}
+		break;
+
+		//   ų  ó
+		case USE_RECIPE:
+		{
+			LPITEM pSource1 = FindSpecifyItem(item->GetValue(1));
+			DWORD dwSourceCount1 = item->GetValue(2);
 
-				if (!p)
-					continue;
+			LPITEM pSource2 = FindSpecifyItem(item->GetValue(3));
+			DWORD dwSourceCount2 = item->GetValue(4);
 
-				if (item->GetValue(5) == p->alValues[5]
-#if defined(__GLOVE_SYSTEM__)
-					&& item->GetSubType() != METIN_SUNGMA
-#endif
-					)
+			if (dwSourceCount1 != 0)
+			{
+				if (pSource1 == NULL)
 				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("  ƾ    ϴ."));
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("   ᰡ մϴ."));
 					return false;
 				}
 			}
 
-			if (item2->GetType() == ITEM_ARMOR && item2->GetSubType() == ARMOR_BODY)
+			if (dwSourceCount2 != 0)
 			{
-				if (!IS_SET(item->GetWearFlag(), WEARABLE_BODY) || !IS_SET(item2->GetWearFlag(), WEARABLE_BODY))
+				if (pSource2 == NULL)
 				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ƾ    ϴ."));
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("   ᰡ մϴ."));
 					return false;
 				}
 			}
-#if defined(__GLOVE_SYSTEM__)
-			else if (item2->GetType() == ITEM_ARMOR && item2->GetSubType() == ARMOR_GLOVE)
+
+			if (pSource1 != NULL)
 			{
-				if (!IS_SET(item->GetWearFlag(), WEARABLE_GLOVE) || !IS_SET(item2->GetWearFlag(), WEARABLE_GLOVE))
+				if (pSource1->GetCount() < dwSourceCount1)
 				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ƾ    ϴ."));
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("(%s) մϴ."), pSource1->GetLocaleName());
 					return false;
 				}
+
+				pSource1->SetCount(pSource1->GetCount() - dwSourceCount1);
 			}
-#endif
-			else if (item2->GetType() == ITEM_WEAPON)
+
+			if (pSource2 != NULL)
 			{
-				if (!IS_SET(item->GetWearFlag(), WEARABLE_WEAPON))
+				if (pSource2->GetCount() < dwSourceCount2)
 				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ƾ ⿡   ϴ."));
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("(%s) մϴ."), pSource2->GetLocaleName());
 					return false;
 				}
+
+				pSource2->SetCount(pSource2->GetCount() - dwSourceCount2);
 			}
-			else
+
+			LPITEM pBottle = FindSpecifyItem(50901);
+
+			if (!pBottle || pBottle->GetCount() < 1)
 			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("  ִ  ϴ."));
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ڸϴ."));
 				return false;
 			}
 
-			for (i = 0; i < METIN_SOCKET_MAX_NUM; ++i)
-			{
-				if (item2->GetSocket(i) >= 1 && item2->GetSocket(i) <= 2 && item2->GetSocket(i) >= item->GetValue(2))
-				{
-					//  Ȯ
-					if (number(1, 100) <= 30 || g_bNeverFailMetin == true)
-					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING("ƾ  Ͽϴ."));
-
-#if defined(__GLOVE_SYSTEM__)
-						DWORD dwValue = item->GetVnum();
-						if (item->GetSubType() == METIN_SUNGMA)
-						{
-							bool bMultiplier = false;
-							if (item->GetValue(5) == 2 && number(1, 100) <= 30)
-							{
-								bMultiplier = true;
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING("Perfect! You have attached the Spirit Stone successfully and you even receive a double stat bonus."));
-							}
-							dwValue = item2->GetRandomSungMaSocketValue(item->GetValue(5), item->GetRefineLevel(), bMultiplier);
-						}
-						item2->SetSocket(i, dwValue);
-#else
-						item2->SetSocket(i, item->GetVnum());
-#endif
-					}
-					else
-					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING("ƾ  Ͽϴ."));
-						item2->SetSocket(i, ITEM_BROKEN_METIN_VNUM);
-					}
+			pBottle->SetCount(pBottle->GetCount() - 1);
 
-					LogManager::instance().ItemLog(this, item2, "SOCKET", item->GetName());
-					item->SetCount(item->GetCount() - 1);
-					break;
-				}
+			if (number(1, 100) > item->GetValue(5))
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ߽ϴ."));
+				return false;
 			}
 
-			if (i == METIN_SOCKET_MAX_NUM)
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("  ִ  ϴ."));
+			AutoGiveItem(item->GetValue(0));
 		}
 		break;
+		}
+	}
+	break;
 
-		case ITEM_AUTOUSE:
-		case ITEM_MATERIAL:
-		case ITEM_SPECIAL:
-		case ITEM_TOOL:
-		case ITEM_LOTTERY:
-			break;
+	case ITEM_METIN:
+	{
+		LPITEM item2;
+
+		if (!IsValidItemPosition(DestCell) || !(item2 = GetItem(DestCell)))
+			return false;
+
+		if (item2->IsExchanging())
+			return false;
+
+		if (item2->IsEquipped())
+			return false;
 
-		case ITEM_TOTEM:
+		//< 2020.08.07.Owsap - Block item add metin sock.
+		if (IS_SET(item2->GetAntiFlag(), ITEM_ANTIFLAG_APPLY))
 		{
-			if (!item->IsEquipped())
-				EquipItem(item);
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("This Spirit Stone cannot be attached to this type of item."));
+			return false;
 		}
-		break;
+		//>
+
+		if (item2->GetType() == ITEM_PICK) return false;
+		if (item2->GetType() == ITEM_ROD) return false;
+
+		int i;
 
-		case ITEM_BLEND:
+		for (i = 0; i < ITEM_SOCKET_MAX_NUM; ++i)
 		{
-			// ο ʵ
-			sys_log(0, "ITEM_BLEND!!");
+			DWORD dwVnum;
 
-			if (Blend_Item_find(item->GetVnum()))
+			if ((dwVnum = item2->GetSocket(i)) <= 2)
+				continue;
+
+			TItemTable* p = ITEM_MANAGER::instance().GetTable(dwVnum);
+
+			if (!p)
+				continue;
+
+			if (item->GetValue(5) == p->alValues[5])
 			{
-				int affect_type = AFFECT_BLEND;
-				int apply_type = aApplyInfo[item->GetSocket(0)].wPointType;
-				int apply_value = item->GetSocket(1);
-				int apply_duration = item->GetSocket(2);
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ƾ    ϴ."));
+				return false;
+			}
+		}
 
-				if (FindAffect(affect_type, apply_type))
+		if (item2->GetType() == ITEM_ARMOR)
+		{
+			if (!IS_SET(item->GetWearFlag(), WEARABLE_BODY) || !IS_SET(item2->GetWearFlag(), WEARABLE_BODY))
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ƾ    ϴ."));
+				return false;
+			}
+		}
+		else if (item2->GetType() == ITEM_WEAPON)
+		{
+			if (!IS_SET(item->GetWearFlag(), WEARABLE_WEAPON))
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ƾ ⿡   ϴ."));
+				return false;
+			}
+		}
+		else
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ִ  ϴ."));
+			return false;
+		}
+
+		for (i = 0; i < ITEM_SOCKET_MAX_NUM; ++i)
+			if (item2->GetSocket(i) >= 1 && item2->GetSocket(i) <= 2 && item2->GetSocket(i) >= item->GetValue(2))
+			{
+				//  Ȯ
+				if (number(1, 100) <= 30 || g_bNeverFailMetin == true)
 				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("̹ ȿ ɷ ֽϴ."));
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ƾ  Ͽϴ."));
+					item2->SetSocket(i, item->GetVnum());
 				}
 				else
 				{
-					if (FindAffect(AFFECT_EXP_BONUS_EURO_FREE, POINT_RESIST_MAGIC))
-					{
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING("̹ ȿ ɷ ֽϴ."));
-					}
-					else
-					{
-						AddAffect(affect_type, apply_type, apply_value, 0, apply_duration, 0, false);
-						item->SetCount(item->GetCount() - 1);
-					}
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ƾ  Ͽϴ."));
+					item2->SetSocket(i, ITEM_BROKEN_METIN_VNUM);
 				}
+
+				LogManager::instance().ItemLog(this, item2, "SOCKET", item->GetName());
+				ITEM_MANAGER::instance().RemoveItem(item, "REMOVE (METIN)");
+				break;
 			}
-		}
+
+		if (i == ITEM_SOCKET_MAX_NUM)
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ִ  ϴ."));
+	}
+	break;
+
+	case ITEM_AUTOUSE:
+	case ITEM_MATERIAL:
+	case ITEM_SPECIAL:
+	case ITEM_TOOL:
+	case ITEM_LOTTERY:
 		break;
 
-		case ITEM_EXTRACT:
+	case ITEM_TOTEM:
+	{
+		if (!item->IsEquipped())
+			EquipItem(item);
+	}
+	break;
+
+	case ITEM_BLEND:
+	{
+		// ο ʵ
+		sys_log(0, "ITEM_BLEND!!");
+
+		if (Blend_Item_find(item->GetVnum()))
 		{
-			LPITEM pDestItem = GetItem(DestCell);
-			if (NULL == pDestItem)
-				return false;
+			int affect_type = AFFECT_BLEND;
+			int apply_type = aApplyInfo[item->GetSocket(0)].bPointType;
+			int apply_value = item->GetSocket(1);
+			int apply_duration = item->GetSocket(2);
 
-#if defined(__SOUL_BIND_SYSTEM__)
-			if (item->IsSealed())
+#if defined(__EXTENDED_BLEND_AFFECT__) && defined(__ITEM_SOCKET5__)
+			if ((apply_duration != 0) && UseExtendedBlendAffect(item, affect_type, apply_type, apply_value, apply_duration))
 			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot use this item on soulbound items."));
-				return false;
+				item->Lock(true);
+				item->SetSocket(3, true);
+				item->StartBlendExpireEvent();
+			}
+			else
+			{
+				item->Lock(false);
+				item->SetSocket(3, false);
+				item->StopBlendExpireEvent();
 			}
+			break;
 #endif
 
-			switch (item->GetSubType())
+			if (FindAffect(affect_type, apply_type))
+			{
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
+			}
+			else
 			{
-#if defined(__DRAGON_SOUL_SYSTEM__)
-				case EXTRACT_DRAGON_SOUL:
+				if (FindAffect(AFFECT_EXP_BONUS_EURO_FREE, POINT_RESIST_MAGIC))
 				{
-					if (pDestItem->IsDragonSoul())
-						return DSManager::instance().PullOut(this, NPOS, pDestItem, item);
-					return false;
+					ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ ȿ ɷ ֽϴ."));
 				}
-				case EXTRACT_DRAGON_HEART:
+				else
 				{
-					if (pDestItem->IsDragonSoul())
-						return DSManager::instance().ExtractDragonHeart(this, pDestItem, item);
-					return false;
-				}
+#if defined(__BLEND_AFFECT__)
+					if (SetBlendAffect(item))
+					{
+						AddAffect(affect_type, apply_type, apply_value, 0, apply_duration, 0, false);
+						item->SetCount(item->GetCount() - 1);
+					}
+#else
+					AddAffect(affect_type, apply_type, apply_value, 0, apply_duration, 0, false);
+					item->SetCount(item->GetCount() - 1);
 #endif
-				default:
-					return false;
+				}
 			}
 		}
-		break;
+	}
+	break;
 
-#if defined(__GACHA_SYSTEM__)
-		case ITEM_GACHA:
+	case ITEM_EXTRACT:
+	{
+		LPITEM pDestItem = GetItem(DestCell);
+		if (NULL == pDestItem)
+			return false;
+
+		switch (item->GetSubType())
 		{
-			switch (item->GetSubType())
-			{
-				case USE_GACHA:
-				{
-					if (GiveItemFromSpecialItemGroup(item->GetVnum()))
-					{
-						if (item->GetSocket(0) > 1)
-							item->SetSocket(0, item->GetSocket(0) - 1);
-						else
-							ITEM_MANAGER::instance().RemoveItem(item, "REMOVE (ITEM_GACHA)");
-					}
-				}
-				break;
+		case EXTRACT_DRAGON_SOUL:
+		{
+			if (pDestItem->IsDragonSoul())
+				return DSManager::instance().PullOut(this, NPOS, pDestItem, item);
+			return false;
+		}
+		case EXTRACT_DRAGON_HEART:
+		{
+			if (pDestItem->IsDragonSoul())
+				return DSManager::instance().ExtractDragonHeart(this, pDestItem, item);
+			return false;
+		}
+		default:
+			return false;
+		}
+	}
+	break;
 
-#if defined(__LUCKY_BOX__)
-				case GEM_LUCKY_BOX_GACHA:
-				case SPECIAL_LUCKY_BOX_GACHA:
-					SetLuckyBoxSrcItem(item);
-					break;
-#endif
-			}
+#if defined(__GACHA_SYSTEM__)
+	case ITEM_GACHA:
+	{
+		DWORD dwBoxVnum = item->GetVnum();
+		std::vector <DWORD> dwVnums;
+		std::vector <DWORD> dwCounts;
+		std::vector <LPITEM> item_gets(0);
+		int count = 0;
+
+		if (GiveItemFromSpecialItemGroup(dwBoxVnum, dwVnums, dwCounts, item_gets, count))
+		{
+			if (item->GetSocket(0) > 1)
+				item->SetSocket(0, item->GetSocket(0) - 1);
+			else
+				ITEM_MANAGER::instance().RemoveItem(item, "REMOVE (ITEM_GACHA)");
 		}
-		break;
+	}
+	break;
 #endif
 
 #if defined(__SOUL_SYSTEM__)
-		case ITEM_SOUL:
+	case ITEM_SOUL:
+	{
+		BYTE bSoulGrade = static_cast<BYTE>(item->GetValue(1));
+		DWORD dwPlayTimeBonus = 0;
+		int iSoulAttacks = item->GetValue(2);
+		DWORD dwBonusDuration = item->GetSocket(0);
+
+		DWORD dwPlayTime = item->GetSocket(3);
+
+		if (bSoulGrade == BASIC_SOUL)
 		{
-			struct SoulData
-			{
-				WORD point_type;
-				DWORD affect_flag;
-			};
-			std::unordered_map<BYTE, SoulData> soul_map
-			{
-				{ RED_SOUL, { AFF_SOUL_RED, AFF_SOUL_RED }, },
-				{ BLUE_SOUL, { AFF_SOUL_BLUE, AFF_SOUL_BLUE }, },
-			};
+			if (dwPlayTime >= 60)
+				dwPlayTimeBonus = item->GetValue(3);
+		}
+		else if (bSoulGrade == GLEAMING_SOUL)
+		{
+			if (dwPlayTime >= 60)
+				dwPlayTimeBonus = item->GetValue(3);
+		}
+		else if (bSoulGrade == LUSTROUS_SOUL)
+		{
+			if (dwPlayTime >= 60 && dwPlayTime < 120)
+				dwPlayTimeBonus = item->GetValue(3);
+			else if (dwPlayTime >= 120)
+				dwPlayTimeBonus = item->GetValue(4);
+		}
+		else if (bSoulGrade == PRISMATIC_SOUL)
+		{
+			if (dwPlayTime >= 60 && dwPlayTime < 120)
+				dwPlayTimeBonus = item->GetValue(3);
+			else if (dwPlayTime >= 120 && dwPlayTime < 180)
+				dwPlayTimeBonus = item->GetValue(4);
+			else if (dwPlayTime >= 180)
+				dwPlayTimeBonus = item->GetValue(5);
+		}
+		else if (bSoulGrade == ILUMINED_SOUL)
+		{
+			if (dwPlayTime >= 60 && dwPlayTime < 120)
+				dwPlayTimeBonus = item->GetValue(3);
+			else if (dwPlayTime >= 120 && dwPlayTime < 180)
+				dwPlayTimeBonus = item->GetValue(4);
+			else if (dwPlayTime >= 180)
+				dwPlayTimeBonus = item->GetValue(5);
+		}
+		else
+		{
+			break;
+		}
 
-			const auto& it = soul_map.find(item->GetSubType());
-			if (it == soul_map.end())
-			{
-				sys_err("ITEM_SOUL: Unknown SubType");
-				return false;
-			}
+		EAffectTypes type = AFFECT_NONE;
+		EAffectBits flag = AFF_NONE;
 
-			const auto& soul = it->second;
+		switch (item->GetSubType())
+		{
+		case RED_SOUL:
+			type = AFFECT_SOUL_RED;
+			flag = AFF_SOUL_RED;
+			break;
 
-			CAffect* affect = nullptr;
-			for (auto const& it : GetAffectContainer())
-			{
-				if (it != nullptr && it->dwType == AFFECT_SOUL)
-				{
-					if (it->wApplyOn == soul.point_type)
-					{
-						if (item->GetSocket(1) != TRUE)
-						{
-							ChatPacket(CHAT_TYPE_INFO, "The soul color is already beeing used.");
-							return false;
-						}
-					}
+		case BLUE_SOUL:
+			type = AFFECT_SOUL_BLUE;
+			flag = AFF_SOUL_BLUE;
+			break;
+		}
 
-					affect = it;
-					continue;
-				}
-			}
+		if (AFFECT_NONE == type)
+			break;
 
-			if (item->GetSocket(1) != TRUE)
-			{
-				AddAffect(AFFECT_SOUL, soul.point_type, item->GetID(), affect ? AFF_NONE : soul.affect_flag, item->GetSocket(0), 0, false/*override*/);
+		CAffect* pAffect = FindAffect(type);
+		CAffect* pAffectMixed = FindAffect(AFFECT_SOUL_MIX);
 
-				if (affect)
-				{
-					std::vector<CAffect> tmp_affects;
-					std::vector<CAffect*> to_remove;
-					for (const auto& [k, v] : soul_map)
-					{
-						CAffect* affect = FindAffect(AFFECT_SOUL, v.point_type);
-						if (affect)
-						{
-							tmp_affects.emplace_back(*affect);
-							to_remove.emplace_back(affect);
-						}
-					}
+		if (pAffect == NULL || pAffectMixed == NULL)
+		{
+			EPointTypes bonus = POINT_NONE;
 
-					if (!to_remove.empty())
-					{
-						for (const auto& it : to_remove)
-							RemoveAffect(it);
-					}
+			if (type == AFFECT_SOUL_RED)
+			{
+				bonus = POINT_NORMAL_HIT_DAMAGE_BONUS;
+			}
+			else if (type == AFFECT_SOUL_BLUE)
+			{
+				bonus = POINT_SKILL_DAMAGE_BONUS;
+			}
 
-					if (!tmp_affects.empty())
-					{
-						for (const auto& it : tmp_affects)
-							AddAffect(it.dwType, it.wApplyOn, it.lApplyValue, AFF_NONE, it.lDuration, 0, false/*override*/);
-					}
+			AddAffect(type, bonus, dwPlayTimeBonus, item->GetID(), dwBonusDuration, 0, true, false);
+			if (FindAffect(AFFECT_SOUL_RED) && FindAffect(AFFECT_SOUL_BLUE))
+				AddAffect(AFFECT_SOUL_MIX, POINT_NONE, 0, AFF_SOUL_MIX, INFINITE_AFFECT_DURATION, 0, true, false);
+			else
+				AddAffect(AFFECT_SOUL_MIX, POINT_NONE, 0, flag, INFINITE_AFFECT_DURATION, 0, true, false);
 
-					AddAffect(AFFECT_SOUL, AFF_SOUL_MIX, 0, AFF_SOUL_MIX, item->GetSocket(0), 0, false/*override*/);
-				}
+			item->Lock(true);
+			item->SetSocket(1, true);
+		}
+		else
+		{
+			if (item->GetID() == pAffect->dwFlag && flag == pAffectMixed->dwFlag)
+			{
+				RemoveAffect(pAffect);
+				RemoveAffect(pAffectMixed);
 
-				item->SetSocket(1, TRUE);
-				item->Lock(true);
+				item->Lock(false);
+				item->SetSocket(1, false);
 			}
 			else
 			{
-				RemoveAffect(AFFECT_SOUL, soul.point_type);
-				RemoveAffect(AFFECT_SOUL, AFF_SOUL_MIX); // AFF_SOUL_MIX
+				LPITEM old = FindItemByID(pAffect->dwFlag);
 
-				std::vector<CAffect> tmp_affects;
-				std::vector<CAffect*> to_remove;
-				for (const auto& affect : GetAffectContainer())
+				if (NULL != old)
 				{
-					if (affect != nullptr && affect->dwType == AFFECT_SOUL)
-					{
-						tmp_affects.emplace_back(*affect);
-						to_remove.emplace_back(affect);
-					}
+					old->Lock(false);
+					old->SetSocket(1, false);
 				}
 
-				for (const auto& affect : to_remove)
-					RemoveAffect(affect);
-
-				if (!tmp_affects.empty())
-				{
-					for (const auto& affect : tmp_affects)
-					{
-						auto it = std::find_if(soul_map.begin(), soul_map.end(), [&](const auto& kv_pair) {
-							return kv_pair.second.point_type == affect.wApplyOn;
-							});
+				RemoveAffect(pAffect);
 
-						if (it != soul_map.end())
-							AddAffect(affect.dwType, affect.wApplyOn, affect.lApplyValue, it->second.affect_flag, affect.lDuration, 0, false/*override*/);
-					}
-				}
+				if (FindAffect(AFFECT_SOUL_RED))
+					AddAffect(AFFECT_SOUL_MIX, POINT_NONE, 0, AFF_SOUL_RED, INFINITE_AFFECT_DURATION, 0, true, false);
+				else if (FindAffect(AFFECT_SOUL_BLUE))
+					AddAffect(AFFECT_SOUL_MIX, POINT_NONE, 0, AFF_SOUL_BLUE, INFINITE_AFFECT_DURATION, 0, true, false);
+				else
+					RemoveAffect(pAffectMixed);
 
-				item->SetSocket(1, FALSE);
 				item->Lock(false);
+				item->SetSocket(1, false);
 			}
 		}
-		break;
+	}
+	break;
 #endif
 
-		case ITEM_NONE:
-			sys_err("Item type NONE %s", item->GetName());
-			break;
+	case ITEM_NONE:
+		sys_err("Item type NONE %s", item->GetName());
+		break;
 
-		default:
-			sys_log(0, "UseItemEx: Unknown type %s %d", item->GetName(), item->GetType());
-			return false;
+	default:
+		sys_log(0, "UseItemEx: Unknown type %s %d", item->GetName(), item->GetType());
+		return false;
 	}
 
 	return true;
@@ -7675,10 +7302,17 @@
 
 	if (item->IsExchanging())
 		return false;
+#ifdef __GROWTH_PET_SYSTEM__
+	if (GetPetWindowType() == PET_WINDOW_ATTR_CHANGE || GetPetWindowType() == PET_WINDOW_PRIMIUM_FEEDSTUFF)
+	{
+		ChatPacket(CHAT_TYPE_INFO, "You cannot use items while modifying your pet's stats.");
+		return false;
+	}
+#endif
 
 	if (!item->CanUsedBy(this))
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ʾ     ϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ʾ     ϴ."));
 		return false;
 	}
 
@@ -7687,50 +7321,43 @@
 
 	if (false == FN_check_item_sex(this, item))
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ʾ     ϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ʾ     ϴ."));
 		return false;
 	}
 
-#ifdef __GROWTH_PET_SYSTEM__
-	if (GetPetWindowType() == PET_WINDOW_ATTR_CHANGE || GetPetWindowType() == PET_WINDOW_PRIMIUM_FEEDSTUFF)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot use items while modifying your pet's stats."));
-		return false;
-	}
-#endif
-
 #if defined(__CHANGE_LOOK_SYSTEM__)
-	DWORD dwTransmutationVnum = item->GetTransmutationVnum();
-	if (dwTransmutationVnum != 0)
+	if (EChangeLookInfo::CHANGE_LOOK_CAN_EQUIP_MULTI_GENDER != TRUE)
 	{
-		TItemTable* pItemTable = ITEM_MANAGER::instance().GetTable(dwTransmutationVnum);
-
-		if (!pItemTable->CanUseByJob(GetJob()))
-		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Transmutation] You cannot equip the transmuted item as it does not match your class."));
-			return false;
-		}
-
-#	if defined(__COSTUME_SYSTEM__)
-		if (pItemTable && pItemTable->IsCostume())
+		if (item->GetTransmutation() != 0)
 		{
-			if ((IS_SET(pItemTable->GetAntiFlags(), ITEM_ANTIFLAG_MALE) && SEX_MALE == GET_SEX(this)) ||
-				(IS_SET(pItemTable->GetAntiFlags(), ITEM_ANTIFLAG_FEMALE) && SEX_FEMALE == GET_SEX(this)))
+			TItemTable* pItemTable = ITEM_MANAGER::instance().GetTable(item->GetTransmutation());
+			if (pItemTable && pItemTable->IsCostume())
 			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Transmutation] You cannot equip the transmuted item as it does not match your gender."));
-				return false;
+				bool bSexMatch = false;
+				if (IS_SET(pItemTable->GetAntiFlags(), ITEM_ANTIFLAG_MALE) && IsFemale())
+					bSexMatch = true;
+				else if (IS_SET(pItemTable->GetAntiFlags(), ITEM_ANTIFLAG_FEMALE) && IsMale())
+					bSexMatch = true;
+
+				if (pItemTable->IsCostumeBody() || pItemTable->IsCostumeHair())
+				{
+					if (!bSexMatch)
+					{
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("[Transmutation] You cannot equip the transmuted item as it does not match your gender."));
+						return false;
+					}
+				}
 			}
 		}
 	}
-#	endif
 #endif
 
 	// PREVENT_TRADE_WINDOW
-	if (IS_SUMMON_ITEM(item, GetMapIndex()))
+	if (IS_SUMMON_ITEM(item->GetVnum()))
 	{
 		if (false == IS_SUMMONABLE_ZONE(GetMapIndex()))
 		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot use this item here."));
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ҽ ϴ."));
 			return false;
 		}
 
@@ -7739,7 +7366,7 @@
 		// Ÿ  ʿ ȯθ ƹ.
 		if (CThreeWayWar::instance().IsThreeWayWarMapIndex(GetMapIndex()))
 		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ÿ  ߿ ȯ,ȯθ Ҽ ϴ."));
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ÿ  ߿ ȯ,ȯθ Ҽ ϴ."));
 			return false;
 		}
 
@@ -7748,7 +7375,7 @@
 		// â  üũ
 		if (iPulse - GetSafeboxLoadTime() < PASSES_PER_SEC(g_nPortalLimitTime))
 		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("â  %d ̳ ȯ,ȯθ   ϴ.", g_nPortalLimitTime));
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("â  %d ̳ ȯ,ȯθ   ϴ."), g_nPortalLimitTime);
 
 			if (test_server)
 				ChatPacket(CHAT_TYPE_INFO, "[TestOnly]Pulse %d LoadTime %d PASS %d", iPulse, GetSafeboxLoadTime(), PASSES_PER_SEC(g_nPortalLimitTime));
@@ -7756,9 +7383,13 @@
 		}
 
 		// ŷ â üũ
-		if (PreventTradeWindow(WND_ALL))
+		if (GetExchange() || GetMyShop() || GetShopOwner() || IsOpenSafebox() || IsCubeOpen()
+#ifdef __AURA_SYSTEM__
+		|| IsAuraRefineWindowOpen()
+#endif
+		)
 		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("ŷâ,â   ¿ ȯ,ȯ  Ҽ ϴ."));
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ŷâ,â   ¿ ȯ,ȯ  Ҽ ϴ."));
 			return false;
 		}
 
@@ -7767,7 +7398,7 @@
 		{
 			if (iPulse - GetRefineTime() < PASSES_PER_SEC(g_nPortalLimitTime))
 			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("  %d ̳ ȯ,ȯθ   ϴ.", g_nPortalLimitTime));
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  %d ̳ ȯ,ȯθ   ϴ."), g_nPortalLimitTime);
 				return false;
 			}
 		}
@@ -7777,22 +7408,14 @@
 		{
 			if (iPulse - GetMyShopTime() < PASSES_PER_SEC(g_nPortalLimitTime))
 			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("λ  %d ̳ ȯ,ȯθ   ϴ.", g_nPortalLimitTime));
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("λ  %d ̳ ȯ,ȯθ   ϴ."), g_nPortalLimitTime);
 				return false;
 			}
-
-#if defined(__MAILBOX__)
-			if (iPulse - GetMyMailBoxTime() < PASSES_PER_SEC(g_nPortalLimitTime))
-			{
-				ChatPacket(CHAT_TYPE_INFO, "You cannot use a Return Scroll %d seconds after opening a mailbox.", g_nPortalLimitTime);
-				return false;
-			}
-#endif
 		}
 		// END_PREVENT_ITEM_COPY
 
 		// ȯ Ÿüũ
-		if (item->GetType() == ITEM_USE && item->GetSubType() == USE_TALISMAN)
+		if (item->GetVnum() != 70302)
 		{
 			PIXEL_POSITION posWarp;
 
@@ -7829,7 +7452,7 @@
 
 			if (nDistant > nDist)
 			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("̵ Ǿ ġ ʹ  ȯθ Ҽ ϴ."));
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̵ Ǿ ġ ʹ  ȯθ Ҽ ϴ."));
 				if (test_server)
 					ChatPacket(CHAT_TYPE_INFO, "PossibleDistant %f nNowDist %f", nDistant, nDist);
 				return false;
@@ -7840,7 +7463,7 @@
 		// ȯ  ðüũ
 		if (iPulse - GetExchangeTime() < PASSES_PER_SEC(g_nPortalLimitTime))
 		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("ŷ  %d ̳ ȯ,ȯε   ϴ.", g_nPortalLimitTime));
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ŷ  %d ̳ ȯ,ȯε   ϴ."), g_nPortalLimitTime);
 			return false;
 		}
 		// END_PREVENT_PORTAL_AFTER_EXCHANGE
@@ -7849,15 +7472,20 @@
 	//    ŷâ  üũ
 	if ((item->GetVnum() == 50200) || (item->GetVnum() == 71049))
 	{
-		if (PreventTradeWindow(WND_ALL))
+		if (GetExchange() || GetMyShop() || GetShopOwner() || IsOpenSafebox() || IsCubeOpen()
+#ifdef __AURA_SYSTEM__
+		|| IsAuraRefineWindowOpen()
+#endif
+		)
 		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("ŷâ,â   ¿ ,ܺ Ҽ ϴ."));
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ŷâ,â   ¿ ,ܺ Ҽ ϴ."));
 			return false;
 		}
 	}
 	// END_PREVENT_TRADE_WINDOW
 
-	if (IsRunningQuest())
+	//< 2020.08.08.Owsap - Prevent item usage while running quest.
+	if (quest::CQuestManager::instance().GetPCForce(GetPlayerID())->IsRunning() == true)
 		return false;
 
 	if (IS_SET(item->GetFlag(), ITEM_FLAG_LOG)) //  α׸   ó
@@ -7874,11 +7502,6 @@
 
 		bool ret = UseItemEx(item, DestCell);
 
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-		if (ret and item->GetType() == ITEM_USE or ret and item->GetType() == ITEM_SKILLBOOK or ret and item->GetType() == ITEM_GIFTBOX)
-			UpdateExtBattlePassMissionProgress(BP_ITEM_USE, 1, item->GetVnum());
-#endif
-
 		if (NULL == ITEM_MANAGER::instance().FindByVID(vid)) // UseItemEx   Ǿ.  α׸ 
 		{
 			LogManager::instance().ItemLog(this, vid, vnum, "REMOVE", hint);
@@ -7891,18 +7514,7 @@
 		return (ret);
 	}
 	else
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	{
-		bool ret = UseItemEx(item, DestCell);
-
-		if (ret and item->GetType() == ITEM_USE or ret and item->GetType() == ITEM_SKILLBOOK or ret and item->GetType() == ITEM_GIFTBOX)
-			UpdateExtBattlePassMissionProgress(BP_ITEM_USE, 1, item->GetVnum());
-		
-		return (ret);
-	}
-#else
 		return UseItemEx(item, DestCell);
-#endif
 }
 
 bool CHARACTER::DropItem(TItemPos Cell, WORD wCount)
@@ -7911,10 +7523,8 @@
 
 	if (!CanHandleItem())
 	{
-#if defined(__DRAGON_SOUL_SYSTEM__)
 		if (NULL != DragonSoul_RefineWindow_GetOpener())
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("ȭâ  ¿  ű  ϴ."));
-#endif
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ȭâ  ¿  ű  ϴ."));
 		return false;
 	}
 
@@ -7933,36 +7543,32 @@
 #if defined(__SOUL_BIND_SYSTEM__)
 	if (item->IsSealed())
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot drop a soulbound item."));
-		return false;
-	}
-#endif
-
-#ifdef __GROWTH_PET_SYSTEM__
-	if (GetPetWindowType() == PET_WINDOW_ATTR_CHANGE || GetPetWindowType() == PET_WINDOW_PRIMIUM_FEEDSTUFF)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot drop items while modifying your pet's stats."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot drop a soulbound item."));
 		return false;
 	}
 #endif
 
-	if (IsRunningQuest())
+	if (quest::CQuestManager::instance().GetPCForce(GetPlayerID())->IsRunning() == true)
 		return false;
 
 	if (IS_SET(item->GetAntiFlag(), ITEM_ANTIFLAG_DROP | ITEM_ANTIFLAG_GIVE))
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("   Դϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("   Դϴ."));
 		return false;
 	}
+	
+#ifdef __GROWTH_PET_SYSTEM__
+	if (GetPetWindowType() == PET_WINDOW_ATTR_CHANGE || GetPetWindowType() == PET_WINDOW_PRIMIUM_FEEDSTUFF)
+	{
+		ChatPacket(CHAT_TYPE_INFO, "You cannot drop items while modifying your pet's stats.");
+		return false;
+	}
+#endif
 
 	if (wCount == 0 || wCount > item->GetCount())
 		wCount = item->GetCount();
 
-	// Quickslot  
-	if (INVENTORY == Cell.window_type)
-		SyncQuickslot(SLOT_TYPE_INVENTORY, Cell.cell, WORD_MAX);
-	else if (BELT_INVENTORY == Cell.window_type)
-		SyncQuickslot(SLOT_TYPE_BELT_INVENTORY, Cell.cell, WORD_MAX);
+	SyncQuickslot(QUICKSLOT_TYPE_ITEM, Cell.cell, WORD_MAX); // Quickslot  
 
 	LPITEM pkItemToDrop;
 
@@ -8002,7 +7608,7 @@
 		if (LC_IsYMIR())
 			item->AttrLog();
 
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("  3  ϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  3  ϴ."));
 		pkItemToDrop->StartDestroyEvent();
 
 		ITEM_MANAGER::instance().FlushDelayedSave(pkItemToDrop);
@@ -8023,10 +7629,9 @@
 
 	if (!CanHandleItem())
 	{
-#if defined(__DRAGON_SOUL_SYSTEM__)
 		if (NULL != DragonSoul_RefineWindow_GetOpener())
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("ȭâ  ¿  ű  ϴ."));
-#endif
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ȭâ  ¿  ű  ϴ."));
+
 		return false;
 	}
 
@@ -8036,53 +7641,44 @@
 	if (!IsValidItemPosition(Cell) || !(item = GetItem(Cell)))
 		return false;
 
-	if (IS_SET(item->GetAntiFlag(), ITEM_ANTIFLAG_DESTROY))
-		return false;
-
 	if (item->IsExchanging())
 		return false;
 
 	if (true == item->isLocked())
 		return false;
 
-	if (IsRunningQuest())
-		return false;
-
-	if (item->GetCount() <= 0)
-		return false;
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	UpdateExtBattlePassMissionProgress(BP_ITEM_DESTROY, 1, item->GetVnum());
-#endif
-
 #if defined(__SOUL_BIND_SYSTEM__)
 	if (item->IsSealed())
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot destroy a soulbound item."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot destroy a soulbound item."));
 		return false;
 	}
 #endif
 
 #ifdef __GROWTH_PET_SYSTEM__
-	if (item->IsPet())
-		return false;
+	if (item->GetType() == ITEM_PET)
+	{
+		if ((item->GetSubType() == PET_UPBRINGING) || (item->GetSubType() == PET_BAG))
+			return false;
+	}
 #endif
+	if (quest::CQuestManager::instance().GetPCForce(GetPlayerID())->IsRunning() == true)
+		return false;
 
-	if (INVENTORY == Cell.window_type)
-		SyncQuickslot(SLOT_TYPE_INVENTORY, Cell.cell, WORD_MAX);
-	else if (BELT_INVENTORY == Cell.window_type)
-		SyncQuickslot(SLOT_TYPE_BELT_INVENTORY, Cell.cell, WORD_MAX);
+	if (item->GetCount() <= 0)
+		return false;
 
-	ChatPacket(CHAT_TYPE_INFO, LC_STRING("You have deleted %s.", LC_ITEM(item->GetVnum())));
-	ITEM_MANAGER::instance().RemoveItem(item, "DESTROYED BY PLAYER");
+	SyncQuickslot(QUICKSLOT_TYPE_ITEM, Cell.cell, WORD_MAX);
+	ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You have deleted %s."), item->GetLocaleName());
+	ITEM_MANAGER::instance().RemoveItem(item);
 
 	return true;
 }
 #endif
 
-bool CHARACTER::DropGold(int iAmount)
+bool CHARACTER::DropGold(int gold)
 {
-	if (iAmount <= 0 || iAmount > GetGold())
+	if (gold <= 0 || (long long)gold > GetGold())
 		return false;
 
 	if (!CanHandleItem())
@@ -8092,14 +7688,14 @@
 	{
 		if (get_dword_time() < m_dwLastGoldDropTime + g_GoldDropTimeLimitValue)
 		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING(" 带   ϴ."));
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" 带   ϴ."));
 			return false;
 		}
 	}
 
 	m_dwLastGoldDropTime = get_dword_time();
 
-	LPITEM item = ITEM_MANAGER::instance().CreateItem(1, iAmount);
+	LPITEM item = ITEM_MANAGER::instance().CreateItem(1, gold);
 
 	if (item)
 	{
@@ -8108,7 +7704,7 @@
 		if (item->AddToGround(GetMapIndex(), pos))
 		{
 			//Motion(MOTION_PICKUP);
-			PointChange(POINT_GOLD, -iAmount, true);
+			PointChange(POINT_GOLD, -gold, true);
 
 			//   ٴ װ ִµ,
 			//  ó ߿ ϳ,
@@ -8117,24 +7713,24 @@
 			//  ׷ 츦    ġ 忡 ؼ α׸ .
 			if (LC_IsBrazil() == true)
 			{
-				if (iAmount >= 213)
-					LogManager::instance().CharLog(this, iAmount, "DROP_GOLD", "");
+				if (gold >= 213)
+					LogManager::instance().CharLog(this, gold, "DROP_GOLD", "");
 			}
 			else
 			{
-				if (iAmount > 1000) // õ ̻ Ѵ.
-					LogManager::instance().CharLog(this, iAmount, "DROP_GOLD", "");
+				if (gold > 1000) // õ ̻ Ѵ.
+					LogManager::instance().CharLog(this, gold, "DROP_GOLD", "");
 			}
 
 			if (false == LC_IsBrazil())
 			{
 				item->StartDestroyEvent(150);
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("  %d  ϴ.", 150 / 60));
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  %d  ϴ."), 150 / 60);
 			}
 			else
 			{
 				item->StartDestroyEvent(60);
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("  %d  ϴ.", 1));
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  %d  ϴ."), 1);
 			}
 		}
 
@@ -8158,7 +7754,7 @@
 	{
 		if (get_dword_time() < m_dwLastChequeDropTime + g_ChequeDropTimeLimitValue)
 		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING(" 带   ϴ."));
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" 带   ϴ."));
 			return false;
 		}
 	}
@@ -8181,12 +7777,12 @@
 			if (false == LC_IsBrazil())
 			{
 				item->StartDestroyEvent(150);
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("  %d  ϴ.", 150 / 60));
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  %d  ϴ."), 150 / 60);
 			}
 			else
 			{
 				item->StartDestroyEvent(60);
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("  %d  ϴ.", 1));
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  %d  ϴ."), 1);
 			}
 		}
 
@@ -8200,10 +7796,7 @@
 
 bool CHARACTER::MoveItem(TItemPos Cell, TItemPos DestCell, WORD count)
 {
-	LPITEM item = nullptr;
-
-	if (Cell.IsSameItemPosition(DestCell))
-		return false;
+	LPITEM item = NULL;
 
 	if (!IsValidItemPosition(Cell))
 		return false;
@@ -8217,47 +7810,127 @@
 	if (item->GetCount() < count)
 		return false;
 
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	if (INVENTORY == Cell.window_type && Cell.cell >= GetExtendInvenMax() && IS_SET(item->GetFlag(), ITEM_FLAG_IRREMOVABLE))
-		return false;
-#else
 	if (INVENTORY == Cell.window_type && Cell.cell >= INVENTORY_MAX_NUM && IS_SET(item->GetFlag(), ITEM_FLAG_IRREMOVABLE))
 		return false;
-#endif
 
 	if (true == item->isLocked())
 		return false;
 
 	if (!IsValidItemPosition(DestCell))
 		return false;
+	
+#ifdef __GROWTH_PET_SYSTEM__
+	if (GetPetWindowType() == PET_WINDOW_ATTR_CHANGE || GetPetWindowType() == PET_WINDOW_PRIMIUM_FEEDSTUFF)
+	{
+		ChatPacket(CHAT_TYPE_INFO, "You cannot move items while modifying your pet's stats.");
+		return false;
+	}
+#endif
 
 	if (!CanHandleItem())
 	{
-#if defined(__DRAGON_SOUL_SYSTEM__)
-		if (DragonSoul_RefineWindow_GetOpener())
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("ȭâ  ¿  ű  ϴ."));
+		if (NULL != DragonSoul_RefineWindow_GetOpener())
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ȭâ  ¿  ű  ϴ."));
+#ifdef __AURA_SYSTEM__
+		if (IsAuraRefineWindowOpen())
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<ƿ>  â   ׸ ̵  ϴ."));
 #endif
 		return false;
 	}
 
-#ifdef __GROWTH_PET_SYSTEM__
-	if (GetPetWindowType() == PET_WINDOW_ATTR_CHANGE || GetPetWindowType() == PET_WINDOW_PRIMIUM_FEEDSTUFF)
+	// ȹ û Ʈ κ丮 Ư Ÿ ۸   ִ.
+	if (DestCell.window_type != DRAGON_SOUL_INVENTORY && DestCell.IsBeltInventoryPosition() && !CBeltInventoryHelper::CanMoveIntoBeltInventory(item))
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot move items while modifying your pet's stats."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  Ʈ κ丮 ű  ϴ."));
+		return false;
+	}
+
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	if (DestCell.IsSkillBookInventoryPosition() && (item->IsEquipped() || Cell.IsBeltInventoryPosition()))
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You can't move this item into this inventory."));
+		return false;
+	}
+
+	if (DestCell.IsUpgradeItemsInventoryPosition() && (item->IsEquipped() || Cell.IsBeltInventoryPosition()))
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You can't move this item into this inventory."));
+		return false;
+	}
+
+	if (DestCell.IsStoneInventoryPosition() && (item->IsEquipped() || Cell.IsBeltInventoryPosition()))
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You can't move this item into this inventory."));
+		return false;
+	}
+
+	if (DestCell.IsGiftBoxInventoryPosition() && (item->IsEquipped() || Cell.IsBeltInventoryPosition()))
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You can't move this item into this inventory."));
+		return false;
+	}
+
+	if ((Cell.IsSkillBookInventoryPosition() && !DestCell.IsSkillBookInventoryPosition() && !DestCell.IsDefaultInventoryPosition()))
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You can't move this item into this inventory."));
+		return false;
+	}
+
+	if (Cell.IsUpgradeItemsInventoryPosition() && !DestCell.IsUpgradeItemsInventoryPosition() && !DestCell.IsDefaultInventoryPosition())
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You can't move this item into this inventory."));
+		return false;
+	}
+
+	if (Cell.IsStoneInventoryPosition() && !DestCell.IsStoneInventoryPosition() && !DestCell.IsDefaultInventoryPosition())
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You can't move this item into this inventory."));
 		return false;
 	}
-#endif
 
-	if (DestCell.IsBeltInventoryPosition())
+	if (Cell.IsGiftBoxInventoryPosition() && !DestCell.IsGiftBoxInventoryPosition() && !DestCell.IsDefaultInventoryPosition())
 	{
-		// At the request of the planner, only certain types of items can be placed in the belt inventory.
-		if (!CBeltInventoryHelper::CanMoveIntoBeltInventory(item))
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You can't move this item into this inventory."));
+		return false;
+	}
+
+	if (Cell.IsDefaultInventoryPosition() && DestCell.IsSkillBookInventoryPosition())
+	{
+		if (!item->IsSkillBook())
 		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("  Ʈ κ丮 ű  ϴ."));
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You can only move skill books into this inventory."));
 			return false;
 		}
 	}
 
+	if (Cell.IsDefaultInventoryPosition() && DestCell.IsUpgradeItemsInventoryPosition())
+	{
+		if (!item->IsUpgradeItem())
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You can only move upgrade items into this inventory."));
+			return false;
+		}
+	}
+
+	if (Cell.IsDefaultInventoryPosition() && DestCell.IsStoneInventoryPosition())
+	{
+		if (!item->IsStone())
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You can only move stones into this inventory."));
+			return false;
+		}
+	}
+
+	if (Cell.IsDefaultInventoryPosition() && DestCell.IsGiftBoxInventoryPosition())
+	{
+		if (!item->IsGiftBox())
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You can only move chests into this inventory."));
+			return false;
+		}
+	}
+#endif
+
 	// ̹   ٸ  ű , 'å '   Ȯϰ ű
 	if (Cell.IsEquipPosition())
 	{
@@ -8265,36 +7938,45 @@
 			return false;
 
 #if defined(__WEAPON_COSTUME_SYSTEM__)
-		const int iWearCell = item->FindEquipCell(this);
+		int iWearCell = item->FindEquipCell(this);
 		if (iWearCell == WEAR_WEAPON)
 		{
 			LPITEM pkCostumeWeapon = GetWear(WEAR_COSTUME_WEAPON);
 			if (pkCostumeWeapon)
 			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("If you want to change weapons, you must remove the weapon skin first."));
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("If you want to change weapons, you must remove the weapon skin first."));
 				return false;
 			}
 		}
 #endif
 	}
 
+	if (item->IsBelt() && item->IsEquipped() && CBeltInventoryHelper::IsExistItemInBeltInventory(this))
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You can only discard the belt when there are no longer any items in its inventory."));
+		return false;
+
+		/*
+		if (item->IsEquipped())
+			UnequipItem(item);
+
+		if (!CBeltInventoryHelper::ClearBelt(this))
+			return false;
+		*/
+	}
+
 	if (DestCell.IsEquipPosition())
 	{
-		if (GetItem(DestCell)
-#if defined(__DRAGON_SOUL_SYSTEM__)
-			&& DestCell.IsDragonSoulEquipPosition()
-#endif
-			) //     ˻ص ȴ.
+		if (GetItem(DestCell)) //     ˻ص ȴ.
 		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("̹  ϰ ֽϴ."));
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹  ϰ ֽϴ."));
 			return false;
 		}
 
-		EquipItem(item, DestCell.cell);
+		EquipItem(item, DestCell.cell - INVENTORY_MAX_NUM);
 	}
 	else
 	{
-#if defined(__DRAGON_SOUL_SYSTEM__)
 		if (item->IsDragonSoul())
 		{
 			if (item->IsEquipped())
@@ -8315,7 +7997,6 @@
 		// ȥ ƴ  ȥ κ   .
 		else if (DRAGON_SOUL_INVENTORY == DestCell.window_type)
 			return false;
-#endif
 
 		LPITEM item2;
 
@@ -8323,6 +8004,24 @@
 			!IS_SET(item2->GetAntiFlag(), ITEM_ANTIFLAG_STACK) &&
 			item2->GetVnum() == item->GetVnum() && !item2->IsExchanging()) // ĥ  ִ  
 		{
+#if defined(__EXTENDED_BLEND_AFFECT__)
+			if (item->IsBlendItem() && item2->IsBlendItem())
+			{
+				if (count == 0)
+					count = item->GetCount();
+
+				for (int i = 0; i < 2; ++i)
+					// 0 - apply_type
+					// 1 - apply_value
+					if (item2->GetSocket(i) != item->GetSocket(i))
+						return false;
+
+				item2->SetSocket(2, item2->GetSocket(2) + item->GetSocket(2));
+				item->SetCount(item->GetCount() - count);
+				return true;
+			}
+#endif
+
 			for (int i = 0; i < ITEM_SOCKET_MAX_NUM; ++i)
 				if (item2->GetSocket(i) != item->GetSocket(i))
 					return false;
@@ -8333,17 +8032,101 @@
 			sys_log(0, "%s: ITEM_STACK %s (window: %d, cell : %d) -> (window:%d, cell %d) count %d", GetName(), item->GetName(), Cell.window_type, Cell.cell,
 				DestCell.window_type, DestCell.cell, count);
 
-			count = MIN(ITEM_MAX_COUNT - item2->GetCount(), count);
+			count = MIN(gMaxItemCount - item2->GetCount(), count);
 
 			item->SetCount(item->GetCount() - count);
 			item2->SetCount(item2->GetCount() + count);
-
 			return true;
 		}
 
 		if (!IsEmptyItemGrid(DestCell, item->GetSize(), Cell.cell))
 		{
+#if defined(__SWAP_ITEM_SYSTEM__)
+			if (count != 0 && count != item->GetCount())
+				return false;
+
+			if (!DestCell.IsDefaultInventoryPosition() || !Cell.IsDefaultInventoryPosition())
+				return false;
+
+			LPITEM targetItem = GetItem_NEW(DestCell);
+			if (targetItem && targetItem->GetVID() == item->GetVID())
+				return false;
+
+			if (targetItem)
+			{
+				DestCell = TItemPos(INVENTORY, targetItem->GetCell());
+			}
+
+			if (item->IsExchanging() || (targetItem && targetItem->IsExchanging()))
+				return false;
+
+			BYTE basePage = DestCell.cell / (INVENTORY_MAX_NUM / INVENTORY_PAGE_COUNT);
+			std::map<WORD, LPITEM> moveItemMap;
+			BYTE sizeLeft = item->GetSize();
+
+			for (WORD i = 0; i < item->GetSize(); ++i)
+			{
+				WORD cellNumber = DestCell.cell + i * 5;
+
+				BYTE cPage = cellNumber / (INVENTORY_MAX_NUM / INVENTORY_PAGE_COUNT);
+				if (basePage != cPage)
+					return false;
+
+				LPITEM mvItem = GetItem(TItemPos(INVENTORY, cellNumber));
+				if (mvItem)
+				{
+					if (mvItem->GetSize() > item->GetSize())
+						return false;
+
+					if (mvItem->IsExchanging())
+						return false;
+
+					moveItemMap.insert({ Cell.cell + i * 5, mvItem });
+					sizeLeft -= mvItem->GetSize();
+
+					if (mvItem->GetSize() > 1)
+						i += mvItem->GetSize() - 1;
+				}
+				else
+				{
+					sizeLeft -= 1;
+				}
+			}
+
+			if (sizeLeft != 0)
+				return false;
+
+			std::map<WORD, WORD> syncCells;
+
+			syncCells.insert({ GetQuickslotPosition(QUICKSLOT_TYPE_ITEM, item->GetCell()), DestCell.cell });
+			item->RemoveFromCharacter();
+
+			for (auto it = moveItemMap.begin(); it != moveItemMap.end(); ++it)
+			{
+				WORD toCellNumber = it->first;
+				LPITEM mvItem = it->second;
+
+				syncCells.insert({ GetQuickslotPosition(QUICKSLOT_TYPE_ITEM, mvItem->GetCell()), toCellNumber });
+				mvItem->RemoveFromCharacter();
+
+				SetItem(TItemPos(INVENTORY, toCellNumber), mvItem);
+			}
+
+			SetItem(DestCell, item);
+
+			for (auto& sCell : syncCells)
+			{
+				TQuickslot qs;
+				qs.type = QUICKSLOT_TYPE_ITEM;
+				qs.pos = sCell.second;
+
+				SetQuickslot(sCell.first, qs);
+			}
+
+			return true;
+#else
 			return false;
+#endif
 		}
 
 		if (count == 0 || count >= item->GetCount() || !item->IsStackable() || IS_SET(item->GetAntiFlag(), ITEM_ANTIFLAG_STACK))
@@ -8355,14 +8138,7 @@
 			SetItem(DestCell, item);
 
 			if (INVENTORY == Cell.window_type && INVENTORY == DestCell.window_type)
-				SyncQuickslot(SLOT_TYPE_INVENTORY, Cell.cell, DestCell.cell);
-			else if (BELT_INVENTORY == Cell.window_type && BELT_INVENTORY == DestCell.window_type)
-				SyncQuickslot(SLOT_TYPE_BELT_INVENTORY, Cell.cell, DestCell.cell);
-
-			else if (INVENTORY == Cell.window_type && BELT_INVENTORY == DestCell.window_type)
-				MoveQuickSlotItem(SLOT_TYPE_INVENTORY, Cell.cell, SLOT_TYPE_BELT_INVENTORY, DestCell.cell);
-			else if (BELT_INVENTORY == Cell.window_type && INVENTORY == DestCell.window_type)
-				MoveQuickSlotItem(SLOT_TYPE_BELT_INVENTORY, Cell.cell, SLOT_TYPE_INVENTORY, DestCell.cell);
+				SyncQuickslot(QUICKSLOT_TYPE_ITEM, Cell.cell, DestCell.cell);
 		}
 		else if (count < item->GetCount())
 		{
@@ -8426,10 +8202,10 @@
 		int total;
 		LPCHARACTER c;
 		int x, y;
-		int iMoney;
+		long long llMoney;
 
-		FMoneyDistributor(LPCHARACTER center, int iMoney)
-			: total(0), c(center), x(center->GetX()), y(center->GetY()), iMoney(iMoney)
+		FMoneyDistributor(LPCHARACTER center, long long llMoney)
+			: total(0), c(center), x(center->GetX()), y(center->GetY()), llMoney(llMoney)
 		{
 		}
 
@@ -8438,10 +8214,10 @@
 			if (ch != c)
 				if (DISTANCE_APPROX(ch->GetX() - x, ch->GetY() - y) <= PARTY_DEFAULT_RANGE)
 				{
-					ch->PointChange(POINT_GOLD, iMoney, true);
+					ch->PointChange(POINT_GOLD, llMoney, true);
 
-					if (iMoney > 1000) // õ ̻ Ѵ.
-						LogManager::instance().CharLog(ch, iMoney, "GET_GOLD", "");
+					if (llMoney > 1000) // õ ̻ Ѵ.
+						LogManager::instance().CharLog(ch, llMoney, "GET_GOLD", "");
 				}
 		}
 	};
@@ -8501,49 +8277,42 @@
 #endif
 }
 
-void CHARACTER::GiveGold(int iAmount)
+void CHARACTER::GiveGold(long long llAmount)
 {
-	if (iAmount <= 0)
+	if (llAmount <= 0)
 		return;
 
-	sys_log(0, "GIVE_GOLD: %s %d", GetName(), iAmount);
+	sys_log(0, "GIVE_GOLD: %s %lld", GetName(), llAmount);
 
 	if (GetParty())
 	{
 		LPPARTY pParty = GetParty();
 
 		// Ƽ ִ   .
-		DWORD dwTotal = iAmount;
-		DWORD dwMyAmount = dwTotal;
+		long long llTotal = llAmount;
+		long long llMyAmount = llTotal;
 
 		NPartyPickupDistribute::FCountNearMember funcCountNearMember(this);
-		pParty->ForEachOnMapMember(funcCountNearMember, GetMapIndex());
+		pParty->ForEachOnlineMember(funcCountNearMember);
 
 		if (funcCountNearMember.total > 1)
 		{
-			DWORD dwShare = dwTotal / funcCountNearMember.total;
-			dwMyAmount -= dwShare * (funcCountNearMember.total - 1);
+			long long llShare = llTotal / funcCountNearMember.total;
+			llMyAmount -= llShare * (funcCountNearMember.total - 1);
 
-			NPartyPickupDistribute::FMoneyDistributor funcMoneyDist(this, dwShare);
-			pParty->ForEachOnMapMember(funcMoneyDist, GetMapIndex());
-		}
+			NPartyPickupDistribute::FMoneyDistributor funcMoneyDist(this, llShare);
 
-		PointChange(POINT_GOLD, dwMyAmount, true);
+			pParty->ForEachOnlineMember(funcMoneyDist);
+		}
 
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-		UpdateExtBattlePassMissionProgress(YANG_COLLECT, dwMyAmount, GetMapIndex());
-#endif
+		PointChange(POINT_GOLD, llMyAmount, true);
 
-		if (dwMyAmount > 1000) // õ ̻ Ѵ.
-			LogManager::instance().CharLog(this, dwMyAmount, "GET_GOLD", "");
+		if (llMyAmount > 1000) // õ ̻ Ѵ.
+			LogManager::instance().CharLog(this, llMyAmount, "GET_GOLD", "");
 	}
 	else
 	{
-		PointChange(POINT_GOLD, iAmount, true);
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-		UpdateExtBattlePassMissionProgress(YANG_COLLECT, iAmount, GetMapIndex());
-#endif
+		PointChange(POINT_GOLD, llAmount, true);
 
 		//   ٴ װ ִµ,
 		//  ó ߿ ϳ,
@@ -8552,13 +8321,13 @@
 		//  ׷ 츦    ġ 忡 ؼ α׸ .
 		if (LC_IsBrazil() == true)
 		{
-			if (iAmount >= 213)
-				LogManager::instance().CharLog(this, iAmount, "GET_GOLD", "");
+			if (llAmount >= 213)
+				LogManager::instance().CharLog(this, llAmount, "GET_GOLD", "");
 		}
 		else
 		{
-			if (iAmount > 1000) // õ ̻ Ѵ.
-				LogManager::instance().CharLog(this, iAmount, "GET_GOLD", "");
+			if (llAmount > 1000) // õ ̻ Ѵ.
+				LogManager::instance().CharLog(this, llAmount, "GET_GOLD", "");
 		}
 	}
 }
@@ -8579,15 +8348,16 @@
 		DWORD dwMyAmount = dwTotal;
 
 		NPartyPickupDistribute::FCountNearMember funcCountNearMember(this);
-		pParty->ForEachOnMapMember(funcCountNearMember, GetMapIndex());
+		pParty->ForEachOnlineMember(funcCountNearMember);
 
 		if (funcCountNearMember.total > 1)
 		{
 			DWORD dwShare = dwTotal / funcCountNearMember.total;
 			dwMyAmount -= dwShare * (funcCountNearMember.total - 1);
 
-			NPartyPickupDistribute::FChequeDistributor funcMoneyDist(this, dwShare);
-			pParty->ForEachOnMapMember(funcMoneyDist, GetMapIndex());
+			NPartyPickupDistribute::FChequeDistributor funcChequeDist(this, dwShare);
+
+			pParty->ForEachOnlineMember(funcChequeDist);
 		}
 
 		PointChange(POINT_CHEQUE, dwMyAmount, true);
@@ -8629,15 +8399,16 @@
 		DWORD dwMyAmount = dwTotal;
 
 		NPartyPickupDistribute::FCountNearMember funcCountNearMember(this);
-		pParty->ForEachOnMapMember(funcCountNearMember, GetMapIndex());
+		pParty->ForEachOnlineMember(funcCountNearMember);
 
 		if (funcCountNearMember.total > 1)
 		{
 			DWORD dwShare = dwTotal / funcCountNearMember.total;
 			dwMyAmount -= dwShare * (funcCountNearMember.total - 1);
 
-			NPartyPickupDistribute::FGemDistributor funcMoneyDist(this, dwShare);
-			pParty->ForEachOnMapMember(funcMoneyDist, GetMapIndex());
+			NPartyPickupDistribute::FGemDistributor funcGemDist(this, dwShare);
+
+			pParty->ForEachOnlineMember(funcGemDist);
 		}
 
 		PointChange(POINT_GEM, dwMyAmount, true);
@@ -8663,15 +8434,8 @@
 }
 #endif
 
-bool CHARACTER::PickupItem(DWORD dwVID
-#if defined(__PET_LOOT_AI__)
-	, bool bPetLoot
-#endif
-)
+bool CHARACTER::PickupItem(DWORD dwVID)
 {
-	if (IsDead())
-		return false;
-
 	LPITEM item = ITEM_MANAGER::instance().FindByVID(dwVID);
 
 	if (IsObserverMode())
@@ -8680,57 +8444,74 @@
 	if (!item || !item->GetSectree())
 		return false;
 
-	if (item->DistanceValid(this)
-#if defined(__PET_LOOT_AI__)
-		|| bPetLoot
-#endif
-		)
+	if (item->DistanceValid(this))
 	{
-		if (item->GetType() == ITEM_QUEST || IS_SET(item->GetFlag(), ITEM_FLAG_QUEST_USE | ITEM_FLAG_QUEST_USE_MULTIPLE)
-			|| (item->GetType() == ITEM_PET && item->GetSubType() == PET_PAY))
-		{
-			if (IsRunningQuest())
-				return false;
-		}
-
 		if (item->IsOwnership(this))
 		{
-#if defined(__LOOT_FILTER_SYSTEM__)
-			if (GetLootFilter() && !GetLootFilter()->CanPickUpItem(item))
+			//   ϴ  ũ
+			if (item->GetType() == ITEM_ELK)
 			{
-				if (!GetLootFilter()->IsLootFilteredItem(dwVID))
-				{
-					GetLootFilter()->InsertLootFilteredItem(dwVID);
+				GiveGold(item->GetCount());
+				item->RemoveFromGround();
 
-					if (GetDesc())
-					{
-						TPacketGCLootFilter p;
-						p.header = HEADER_GC_LOOT_FILTER;
-						p.enable = false;
-						p.vid = dwVID;
-						GetDesc()->Packet(&p, sizeof(p));
-					}
-				}
+				M2_DESTROY_ITEM(item);
 
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("No loot will be collected as the loot filter is deactivated."));
-				return false;
+				Save();
 			}
-#endif
-
-			//   ϴ  ũ
-			if (item->GetType() == ITEM_ELK)
+#if defined(__CHEQUE_SYSTEM__)
+			else if (item->GetType() == ITEM_CHEQUE)
 			{
-				GiveGold(item->GetCount());
+				GiveCheque(item->GetCount());
 				item->RemoveFromGround();
 
 				M2_DESTROY_ITEM(item);
 
 				Save();
 			}
+#endif
 			//  ̶
 			else
 			{
+#if defined(__EXTENDED_BLEND_AFFECT__)
+				if (item->IsBlendItem() && !item->IsExtendedBlend(item->GetVnum()))
+				{
+					WORD wCount = item->GetCount();
+
+					for (int i = 0; i < INVENTORY_MAX_NUM; ++i)
+					{
+						LPITEM item2 = GetInventoryItem(i);
+
+						if (!item2)
+							continue;
+
+						if (item2->IsBlendItem() && item->IsBlendItem())
+						{
+							bool bSameBlend = true;
+							for (int j = 0; j < 2; ++j)
+							{
+								if (item2->GetSocket(j) != item->GetSocket(j))
+								{
+									bSameBlend = false;
+									break;
+								}
+							}
+
+							if (bSameBlend)
+							{
+								item2->SetSocket(2, item2->GetSocket(2) + item->GetSocket(2));
+								item->SetCount(item->GetCount() - wCount);
+								item->RemoveFromGround();
+
+								M2_DESTROY_ITEM(item);
+								return true;
+							}
+						}
+					}
+				}
+				else if (item->IsStackable() && !IS_SET(item->GetAntiFlag(), ITEM_ANTIFLAG_STACK))
+#else
 				if (item->IsStackable() && !IS_SET(item->GetAntiFlag(), ITEM_ANTIFLAG_STACK))
+#endif
 				{
 					WORD wCount = item->GetCount();
 
@@ -8754,32 +8535,61 @@
 							if (j != ITEM_SOCKET_MAX_NUM)
 								continue;
 
-							WORD wCount2 = MIN(ITEM_MAX_COUNT - item2->GetCount(), wCount);
-
+							WORD wCount2 = MIN(gMaxItemCount - item2->GetCount(), wCount);
 							wCount -= wCount2;
 
 							item2->SetCount(item2->GetCount() + wCount2);
 
 							if (wCount == 0)
 							{
-#if defined(__CHATTING_WINDOW_RENEWAL__)
-#if defined(__SET_ITEM__)
-								ChatPacket(CHAT_TYPE_ITEM_INFO, LC_STRING(" ȹ: %s", LC_PRE_ITEM(item2->GetItemSetValue(), item2->GetVnum())));
-#else
-								ChatPacket(CHAT_TYPE_ITEM_INFO, LC_STRING(" ȹ: %s", LC_ITEM(item2->GetVnum())));
-#endif
-#else
-#if defined(__SET_ITEM__)
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȹ: %s", LC_PRE_ITEM(item2->GetItemSetValue(), item2->GetVnum())));
-#else
-								ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȹ: %s", LC_ITEM(item2->GetVnum())));
-#endif
-#endif
+								ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ȹ: %s"), item2->GetLocaleName());
 								M2_DESTROY_ITEM(item);
 
-								if (item2->GetType() == ITEM_QUEST)
-									quest::CQuestManager::instance().PickupItem(GetPlayerID(), item2);
+								//if (item2->GetType() == ITEM_QUEST)
+								quest::CQuestManager::instance().PickupItem(GetPlayerID(), item2);
+								return true;
+							}
+						}
+					}
+
+					item->SetCount(wCount);
+				}
+
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+				if ((item->IsSkillBook() || item->IsUpgradeItem() || item->IsStone() || item->IsGiftBox()) && item->IsStackable() && !IS_SET(item->GetAntiFlag(), ITEM_ANTIFLAG_STACK))
+				{
+					WORD wCount = item->GetCount();
+
+					for (int i = SKILL_BOOK_INVENTORY_SLOT_START; i < GIFT_BOX_INVENTORY_SLOT_END; ++i)
+					{
+						LPITEM item2 = GetInventoryItem(i);
+
+						if (!item2)
+							continue;
+
+						if (item2->GetVnum() == item->GetVnum())
+						{
+							int j;
+
+							for (j = 0; j < ITEM_SOCKET_MAX_NUM; ++j)
+								if (item2->GetSocket(j) != item->GetSocket(j))
+									break;
+
+							if (j != ITEM_SOCKET_MAX_NUM)
+								continue;
 
+							WORD wCount2 = MIN(gMaxItemCount - item2->GetCount(), wCount);
+							wCount -= wCount2;
+
+							item2->SetCount(item2->GetCount() + wCount2);
+
+							if (wCount == 0)
+							{
+								ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ȹ: %s"), item2->GetLocaleName());
+								M2_DESTROY_ITEM(item);
+
+								//if (item2->GetType() == ITEM_QUEST)
+								quest::CQuestManager::instance().PickupItem(GetPlayerID(), item2);
 								return true;
 							}
 						}
@@ -8787,78 +8597,145 @@
 
 					item->SetCount(wCount);
 				}
+#endif
 
 				int iEmptyCell;
-#if defined(__DRAGON_SOUL_SYSTEM__)
 				if (item->IsDragonSoul())
 				{
 					if ((iEmptyCell = GetEmptyDragonSoulInventory(item)) == -1)
 					{
 						sys_log(0, "No empty ds inventory pid %u size %ud itemid %u", GetPlayerID(), item->GetSize(), item->GetID());
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING("ϰ ִ  ʹ ϴ."));
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ϰ ִ  ʹ ϴ."));
+						return false;
+					}
+				}
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+				else if (item->IsSkillBook())
+				{
+					if ((iEmptyCell = GetEmptySkillBookInventory(item->GetSize())) == -1)
+					{
+						sys_log(0, "No empty skill book inventory pid %u size %ud itemid %u", GetPlayerID(), item->GetSize(), item->GetID());
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ϰ ִ  ʹ ϴ."));
+						return false;
+					}
+				}
+				else if (item->IsUpgradeItem())
+				{
+					if ((iEmptyCell = GetEmptyUpgradeItemsInventory(item->GetSize())) == -1)
+					{
+						sys_log(0, "No empty refine inventory pid %u size %ud itemid %u", GetPlayerID(), item->GetSize(), item->GetID());
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ϰ ִ  ʹ ϴ."));
+						return false;
+					}
+				}
+				else if (item->IsStone())
+				{
+					if ((iEmptyCell = GetEmptyStoneInventory(item->GetSize())) == -1)
+					{
+						sys_log(0, "No empty stone inventory pid %u size %ud itemid %u", GetPlayerID(), item->GetSize(), item->GetID());
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ϰ ִ  ʹ ϴ."));
+						return false;
+					}
+				}
+				else if (item->IsGiftBox())
+				{
+					if ((iEmptyCell = GetEmptyGiftBoxInventory(item->GetSize())) == -1)
+					{
+						sys_log(0, "No empty gift box inventory pid %u size %ud itemid %u", GetPlayerID(), item->GetSize(), item->GetID());
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ϰ ִ  ʹ ϴ."));
 						return false;
 					}
 				}
-				else
 #endif
+				else
 				{
 					if ((iEmptyCell = GetEmptyInventory(item->GetSize())) == -1)
 					{
 						sys_log(0, "No empty inventory pid %u size %ud itemid %u", GetPlayerID(), item->GetSize(), item->GetID());
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING("ϰ ִ  ʹ ϴ."));
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ϰ ִ  ʹ ϴ."));
 						return false;
 					}
 				}
 
 				item->RemoveFromGround();
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
 				if (item->IsDragonSoul())
 					item->AddToCharacter(this, TItemPos(DRAGON_SOUL_INVENTORY, iEmptyCell));
-				else
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+				else if (item->IsSkillBook())
+				{
+					int iOpenCount = GetQuestFlag("special_inventory.open_count");
+					if (iOpenCount < 3)
+					{
+						ChatPacket(CHAT_TYPE_NOTICE, LC_TEXT("%s was added to your special inventory."), item->GetLocaleName());
+						ChatPacket(CHAT_TYPE_COMMAND, "OpenSpecialInventoryWindow 0");
+						SetQuestFlag("special_inventory.open_count", iOpenCount + 1);
+					}
+					item->AddToCharacter(this, TItemPos(INVENTORY, iEmptyCell));
+				}
+				else if (item->IsUpgradeItem())
+				{
+					int iOpenCount = GetQuestFlag("special_inventory.open_count");
+					if (iOpenCount < 3)
+					{
+						ChatPacket(CHAT_TYPE_NOTICE, LC_TEXT("%s was added to your special inventory."), item->GetLocaleName());
+						ChatPacket(CHAT_TYPE_COMMAND, "OpenSpecialInventoryWindow 1");
+						SetQuestFlag("special_inventory.open_count", iOpenCount + 1);
+					}
+					item->AddToCharacter(this, TItemPos(INVENTORY, iEmptyCell));
+				}
+				else if (item->IsStone())
+				{
+					int iOpenCount = GetQuestFlag("special_inventory.open_count");
+					if (iOpenCount < 3)
+					{
+						ChatPacket(CHAT_TYPE_NOTICE, LC_TEXT("%s was added to your special inventory."), item->GetLocaleName());
+						ChatPacket(CHAT_TYPE_COMMAND, "OpenSpecialInventoryWindow 2");
+						SetQuestFlag("special_inventory.open_count", iOpenCount + 1);
+					}
+					item->AddToCharacter(this, TItemPos(INVENTORY, iEmptyCell));
+				}
+				else if (item->IsGiftBox())
+				{
+					int iOpenCount = GetQuestFlag("special_inventory.open_count");
+					if (iOpenCount < 3)
+					{
+						ChatPacket(CHAT_TYPE_NOTICE, LC_TEXT("%s was added to your special inventory."), item->GetLocaleName());
+						ChatPacket(CHAT_TYPE_COMMAND, "OpenSpecialInventoryWindow 3");
+						SetQuestFlag("special_inventory.open_count", iOpenCount + 1);
+					}
+					item->AddToCharacter(this, TItemPos(INVENTORY, iEmptyCell));
+				}
 #endif
+				else
 					item->AddToCharacter(this, TItemPos(INVENTORY, iEmptyCell));
 
 				char szHint[32 + 1];
 				snprintf(szHint, sizeof(szHint), "%s %u %u", item->GetName(), item->GetCount(), item->GetOriginalVnum());
 				LogManager::instance().ItemLog(this, item, "GET", szHint);
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ȹ: %s"), item->GetLocaleName());
 
-#if defined(__CHATTING_WINDOW_RENEWAL__)
-#if defined(__SET_ITEM__)
-				ChatPacket(CHAT_TYPE_ITEM_INFO, LC_STRING(" ȹ: %s", LC_PRE_ITEM(item->GetItemSetValue(), item->GetVnum())));
-#else
-				ChatPacket(CHAT_TYPE_ITEM_INFO, LC_STRING(" ȹ: %s", LC_ITEM(item->GetVnum())));
-#endif
-#else
-#if defined(__SET_ITEM__)
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȹ: %s", LC_PRE_ITEM(item->GetItemSetValue(), item->GetVnum())));
-#else
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȹ: %s", LC_ITEM(item->GetVnum())));
-#endif
-#endif
-
-				if (item->GetType() == ITEM_QUEST || IS_SET(item->GetFlag(), ITEM_FLAG_QUEST_USE | ITEM_FLAG_QUEST_USE_MULTIPLE)
-					|| (item->GetType() == ITEM_PET && item->GetSubType() == PET_PAY))
-				{
-					quest::CQuestManager::instance().PickupItem(GetPlayerID(), item);
-				}
+				//if (item->GetType() == ITEM_QUEST)
+				quest::CQuestManager::instance().PickupItem(GetPlayerID(), item);
 			}
 
 			//Motion(MOTION_PICKUP);
 			return true;
 		}
-		else if (!IS_SET(item->GetAntiFlag(), ITEM_ANTIFLAG_GIVE | ITEM_ANTIFLAG_DROP) && GetParty())
+		//< 2020.06.26.Owsap - Suppressed the inability to pickup items from the party that are within the anti flags.
+		else if (/*!IS_SET(item->GetAntiFlag(), ITEM_ANTIFLAG_GIVE | ITEM_ANTIFLAG_DROP) &&*/ GetParty()) //< 2020.06.26.Owsap - />
 		{
 			// ٸ Ƽ    Ѵٸ
 			NPartyPickupDistribute::FFindOwnership funcFindOwnership(item);
-			GetParty()->ForEachOnMapMember(funcFindOwnership, GetMapIndex());
+
+			GetParty()->ForEachOnlineMember(funcFindOwnership);
 
 			LPCHARACTER owner = funcFindOwnership.owner;
 			if (!owner)
 				return false;
 
 			int iEmptyCell;
-#if defined(__DRAGON_SOUL_SYSTEM__)
+
 			if (item->IsDragonSoul())
 			{
 				if (!(owner && (iEmptyCell = owner->GetEmptyDragonSoulInventory(item)) != -1))
@@ -8867,121 +8744,94 @@
 
 					if ((iEmptyCell = GetEmptyDragonSoulInventory(item)) == -1)
 					{
-						owner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ϰ ִ  ʹ ϴ."));
+						owner->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ϰ ִ  ʹ ϴ."));
 						return false;
 					}
 				}
 			}
-			else
-#endif
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+			else if (item->IsSkillBook())
 			{
-				if (!(owner && (iEmptyCell = owner->GetEmptyInventory(item->GetSize())) != -1))
+				if (!(owner && (iEmptyCell = owner->GetEmptySkillBookInventory(item->GetSize())) != -1))
 				{
 					owner = this;
 
-					if ((iEmptyCell = GetEmptyInventory(item->GetSize())) == -1)
+					if ((iEmptyCell = GetEmptySkillBookInventory(item->GetSize())) == -1)
 					{
-						owner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ϰ ִ  ʹ ϴ."));
+						owner->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ϰ ִ  ʹ ϴ."));
 						return false;
 					}
 				}
 			}
-
-			if (item->IsStackable() && !IS_SET(item->GetAntiFlag(), ITEM_ANTIFLAG_STACK))
+			else if (item->IsUpgradeItem())
 			{
-				WORD wCount = item->GetCount();
-
-				for (int i = 0; i < INVENTORY_MAX_NUM; ++i)
+				if (!(owner && (iEmptyCell = owner->GetEmptyUpgradeItemsInventory(item->GetSize())) != -1))
 				{
-					LPITEM item2 = owner->GetInventoryItem(i);
-
-					if (!item2)
-						continue;
+					owner = this;
 
-					if (item2->GetVnum() == item->GetVnum())
+					if ((iEmptyCell = GetEmptyUpgradeItemsInventory(item->GetSize())) == -1)
 					{
-						int j;
-
-						for (j = 0; j < ITEM_SOCKET_MAX_NUM; ++j)
-						{
-							if (item2->GetSocket(j) != item->GetSocket(j))
-								break;
-						}
-
-						if (j != ITEM_SOCKET_MAX_NUM)
-							continue;
-
-						WORD wCount2 = MIN(ITEM_MAX_COUNT - item2->GetCount(), wCount);
-
-						wCount -= wCount2;
-
-						item2->SetCount(item2->GetCount() + wCount2);
-
-						if (wCount == 0)
-						{
-#if defined(__CHATTING_WINDOW_RENEWAL__)
-#if defined(__SET_ITEM__)
-							owner->ChatPacket(CHAT_TYPE_ITEM_INFO, LC_STRING(" ȹ: %s", LC_PRE_ITEM(item2->GetItemSetValue(), item2->GetVnum())));
-#else
-							owner->ChatPacket(CHAT_TYPE_ITEM_INFO, LC_STRING(" ȹ: %s", LC_ITEM(item2->GetVnum())));
-#endif
-#else
-#if defined(__SET_ITEM__)
-							owner->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȹ: %s", LC_PRE_ITEM(item2->GetItemSetValue(), item2->GetVnum())));
-#else
-							owner->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȹ: %s", LC_ITEM(item2->GetVnum())));
-#endif
-#endif
-							M2_DESTROY_ITEM(item);
-
-							if (item2->GetType() == ITEM_QUEST)
-								quest::CQuestManager::instance().PickupItem(owner->GetPlayerID(), item2);
-
-							return true;
-						}
+						owner->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ϰ ִ  ʹ ϴ."));
+						return false;
 					}
 				}
-
-				item->SetCount(wCount);
 			}
-
-#if defined(__LOOT_FILTER_SYSTEM__)
-			if (owner->GetLootFilter() && !owner->GetLootFilter()->CanPickUpItem(item))
+			else if (item->IsStone())
 			{
-				if (owner == this)
+				if (!(owner && (iEmptyCell = owner->GetEmptyStoneInventory(item->GetSize())) != -1))
 				{
-					if (!owner->GetLootFilter()->IsLootFilteredItem(dwVID))
-					{
-						owner->GetLootFilter()->InsertLootFilteredItem(dwVID);
+					owner = this;
 
-						if (owner->GetDesc())
-						{
-							TPacketGCLootFilter p;
-							p.header = HEADER_GC_LOOT_FILTER;
-							p.enable = false;
-							p.vid = dwVID;
-							owner->GetDesc()->Packet(&p, sizeof(p));
-						}
+					if ((iEmptyCell = GetEmptyStoneInventory(item->GetSize())) == -1)
+					{
+						owner->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ϰ ִ  ʹ ϴ."));
+						return false;
 					}
-
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("No loot will be collected as the loot filter is deactivated."));
 				}
-				else
+			}
+			else if (item->IsGiftBox())
+			{
+				if (!(owner && (iEmptyCell = owner->GetEmptyGiftBoxInventory(item->GetSize())) != -1))
 				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("No loot will be collected as a party member's loot filter is deactivated."));
-				}
+					owner = this;
 
-				return false;
+					if ((iEmptyCell = GetEmptyGiftBoxInventory(item->GetSize())) == -1)
+					{
+						owner->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ϰ ִ  ʹ ϴ."));
+						return false;
+					}
+				}
 			}
 #endif
+			else
+			{
+				if (!(owner && (iEmptyCell = owner->GetEmptyInventory(item->GetSize())) != -1))
+				{
+					owner = this;
+
+					if ((iEmptyCell = GetEmptyInventory(item->GetSize())) == -1)
+					{
+						owner->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ϰ ִ  ʹ ϴ."));
+						return false;
+					}
+				}
+			}
 
 			item->RemoveFromGround();
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
 			if (item->IsDragonSoul())
 				item->AddToCharacter(owner, TItemPos(DRAGON_SOUL_INVENTORY, iEmptyCell));
-			else
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+			else if (item->IsSkillBook())
+				item->AddToCharacter(owner, TItemPos(INVENTORY, iEmptyCell));
+			else if (item->IsUpgradeItem())
+				item->AddToCharacter(owner, TItemPos(INVENTORY, iEmptyCell));
+			else if (item->IsStone())
+				item->AddToCharacter(owner, TItemPos(INVENTORY, iEmptyCell));
+			else if (item->IsGiftBox())
+				item->AddToCharacter(owner, TItemPos(INVENTORY, iEmptyCell));
 #endif
+			else
 				item->AddToCharacter(owner, TItemPos(INVENTORY, iEmptyCell));
 
 			char szHint[32 + 1];
@@ -8989,47 +8839,15 @@
 			LogManager::instance().ItemLog(owner, item, "GET", szHint);
 
 			if (owner == this)
-			{
-#if defined(__CHATTING_WINDOW_RENEWAL__)
-#if defined(__SET_ITEM__)
-				ChatPacket(CHAT_TYPE_ITEM_INFO, LC_STRING(" ȹ: %s", LC_PRE_ITEM(item->GetItemSetValue(), item->GetVnum())));
-#else
-				ChatPacket(CHAT_TYPE_ITEM_INFO, LC_STRING(" ȹ: %s", LC_ITEM(item->GetVnum())));
-#endif
-#else
-#if defined(__SET_ITEM__)
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȹ: %s", LC_PRE_ITEM(item->GetItemSetValue(), item->GetVnum())));
-#else
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȹ: %s", LC_ITEM(item->GetVnum())));
-#endif
-#endif
-			}
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ȹ: %s"), item->GetLocaleName());
 			else
 			{
-#if defined(__CHATTING_WINDOW_RENEWAL__)
-#if defined(__SET_ITEM__)
-				owner->ChatPacket(CHAT_TYPE_ITEM_INFO, LC_STRING(" ȹ: %s κ %s", GetName(), LC_PRE_ITEM(item->GetItemSetValue(), item->GetVnum())));
-				ChatPacket(CHAT_TYPE_ITEM_INFO, LC_STRING(" : %s Կ %s", owner->GetName(), LC_PRE_ITEM(item->GetItemSetValue(), item->GetVnum())));
-#else
-				owner->ChatPacket(CHAT_TYPE_ITEM_INFO, LC_STRING(" ȹ: %s κ %s", GetName(), LC_ITEM(item->GetVnum())));
-				ChatPacket(CHAT_TYPE_ITEM_INFO, LC_STRING(" : %s Կ %s", owner->GetName(), LC_ITEM(item->GetVnum())));
-#endif
-#else
-#if defined(__SET_ITEM__)
-				owner->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȹ: %s κ %s", GetName(), LC_PRE_ITEM(item->GetItemSetValue(), item->GetVnum())));
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING(" : %s Կ %s", owner->GetName(), LC_PRE_ITEM(item->GetItemSetValue(), item->GetVnum())));
-#else
-				owner->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȹ: %s κ %s", GetName(), LC_ITEM(item->GetVnum())));
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING(" : %s Կ %s", owner->GetName(), LC_ITEM(item->GetVnum())));
-#endif
-#endif
+				owner->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ȹ: %s κ %s"), GetName(), item->GetLocaleName());
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" : %s Կ %s"), owner->GetName(), item->GetLocaleName());
 			}
 
-			if (item->GetType() == ITEM_QUEST || IS_SET(item->GetFlag(), ITEM_FLAG_QUEST_USE | ITEM_FLAG_QUEST_USE_MULTIPLE)
-				|| (item->GetType() == ITEM_PET && item->GetSubType() == PET_PAY))
-			{
-				quest::CQuestManager::instance().PickupItem(owner->GetPlayerID(), item);
-			}
+			//if (item->GetType() == ITEM_QUEST)
+			quest::CQuestManager::instance().PickupItem(owner->GetPlayerID(), item);
 
 			return true;
 		}
@@ -9042,49 +8860,57 @@
 #define VERIFY_MSG(exp, msg) \
 	if (true == (exp)) \
 	{ \
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING(msg)); \
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT(msg)); \
 		return false; \
 	}
 
-bool CHARACTER::SwapItem(WORD wCell, WORD wDestCell)
+bool CHARACTER::SwapItem(UINT bCell, UINT bDestCell)
 {
 	if (!CanHandleItem())
 		return false;
 
-	const TItemPos srcCell(INVENTORY, wCell), destCell(EQUIPMENT, wDestCell);
+	TItemPos srcCell(INVENTORY, bCell), destCell(INVENTORY, bDestCell);
 
 	// ùٸ Cell  ˻
 	// ȥ Swap  Ƿ, ⼭ ɸ.
 	//if (bCell >= INVENTORY_MAX_NUM + WEAR_MAX_NUM || bDestCell >= INVENTORY_MAX_NUM + WEAR_MAX_NUM)
-#if defined(__DRAGON_SOUL_SYSTEM__)
 	if (srcCell.IsDragonSoulEquipPosition() || destCell.IsDragonSoulEquipPosition())
 		return false;
-#endif
+
+	//  CELL  ˻
+	if (bCell == bDestCell)
+		return false;
 
 	//   â ġ Swap   .
 	if (srcCell.IsEquipPosition() && destCell.IsEquipPosition())
 		return false;
 
-	LPITEM item1 = nullptr, item2 = nullptr;
+	LPITEM item1, item2;
 
 	// item2 â ִ  ǵ.
 	if (srcCell.IsEquipPosition())
 	{
-		item1 = GetEquipmentItem(wDestCell);
-		item2 = GetInventoryItem(wCell);
+		item1 = GetInventoryItem(bDestCell);
+		item2 = GetInventoryItem(bCell);
 	}
 	else
 	{
-		item1 = GetInventoryItem(wCell);
-		item2 = GetEquipmentItem(wDestCell);
+		item1 = GetInventoryItem(bCell);
+		item2 = GetInventoryItem(bDestCell);
 	}
 
 	if (!item1 || !item2)
 		return false;
 
+	if (ITEM_BELT == item1->GetType() || ITEM_BELT == item2->GetType())
+	{
+		if (!CBeltInventoryHelper::ClearBelt(this))
+			return false;
+	}
+
 	if (item1 == item2)
 	{
-		sys_log(0, "[WARNING][WARNING][HACK USER!] : %s %d %d", m_stName.c_str(), wCell, wDestCell);
+		sys_log(0, "[WARNING][WARNING][HACK USER!] : %s %d %d", m_stName.c_str(), bCell, bDestCell);
 		return false;
 	}
 
@@ -9095,57 +8921,73 @@
 	// ٲ  â 
 	if (TItemPos(EQUIPMENT, item2->GetCell()).IsEquipPosition())
 	{
-		const WORD wEquipCell = item2->GetCell();
-		const WORD wInvenCell = item1->GetCell();
+		int bEquipCell = item2->GetCell() - INVENTORY_MAX_NUM;
+		UINT bInvenCell = item1->GetCell();
 
-		// The item currently being worn can be removed, and the item planned to be worn
-		// must be in a wearable state in order to proceed.
-		if (!CanUnequipNow(item2, TItemPos(INVENTORY, wEquipCell)) || !CanEquipNow(item1))
+		//     ְ,      ¿߸ 
+		if (!CanUnequipNow(item2, TItemPos(INVENTORY, bInvenCell)) || !CanEquipNow(item1))
 			return false;
 
-		if (wEquipCell != item1->FindEquipCell(this)) // When in the same location, it is only allowed
+		if (item2->GetType() == ITEM_BELT && item2->IsEquipped() && CBeltInventoryHelper::IsExistItemInBeltInventory(this))
+		{
+			if (!CBeltInventoryHelper::ClearBelt(this))
+				return false;
+		}
+
+		if (item1->GetType() == ITEM_BELT && item1->IsEquipped() && CBeltInventoryHelper::IsExistItemInBeltInventory(this))
+		{
+			if (!CBeltInventoryHelper::ClearBelt(this))
+				return false;
+		}
+
+		if (bEquipCell != item1->FindEquipCell(this)) //  ġ϶ 
 			return false;
 
 		item2->RemoveFromCharacter();
 
-		if (item1->EquipTo(this, wEquipCell))
+		if (item1->EquipTo(this, bEquipCell))
 #if defined(__WJ_PICKUP_ITEM_EFFECT__)
-			item2->AddToCharacter(this, TItemPos(INVENTORY, wInvenCell), false);
+			item2->AddToCharacter(this, TItemPos(INVENTORY, bInvenCell), false);
 #else
-			item2->AddToCharacter(this, TItemPos(INVENTORY, wInvenCell));
+			item2->AddToCharacter(this, TItemPos(INVENTORY, bInvenCell));
 #endif
 		else
 			sys_err("SwapItem cannot equip %s! item1 %s", item2->GetName(), item1->GetName());
 	}
 	else
 	{
-		const WORD wCell1 = item1->GetCell();
-		const WORD wCell2 = item2->GetCell();
+		UINT bCell1 = item1->GetCell();
+		UINT bCell2 = item2->GetCell();
 
 		item1->RemoveFromCharacter();
 		item2->RemoveFromCharacter();
 
 #if defined(__WJ_PICKUP_ITEM_EFFECT__)
-		item1->AddToCharacter(this, TItemPos(EQUIPMENT, wCell2), false);
-		item2->AddToCharacter(this, TItemPos(INVENTORY, wCell1), false);
+		item1->AddToCharacter(this, TItemPos(INVENTORY, bCell2), false);
+		item2->AddToCharacter(this, TItemPos(INVENTORY, bCell1), false);
 #else
-		item1->AddToCharacter(this, TItemPos(INVENTORY, wCell2));
-		item2->AddToCharacter(this, TItemPos(INVENTORY, wCell1));
+		item1->AddToCharacter(this, TItemPos(INVENTORY, bCell2));
+		item2->AddToCharacter(this, TItemPos(INVENTORY, bCell1));
 #endif
 	}
 
 	return true;
 }
 
+#if defined(__MOUNT_COSTUME_SYSTEM__)
+bool CHARACTER::UnequipItem(LPITEM item, bool bUnequip /*= false*/)
+#else
 bool CHARACTER::UnequipItem(LPITEM item)
+#endif
 {
 #if defined(__WEAPON_COSTUME_SYSTEM__)
-	if (item->FindEquipCell(this) == WEAR_WEAPON)
+	int iWearCell = item->FindEquipCell(this);
+	if (iWearCell == WEAR_WEAPON)
 	{
-		LPITEM pCostumeWeapon = GetWear(WEAR_COSTUME_WEAPON);
-		if (pCostumeWeapon)
+		LPITEM pkCostumeWeapon = GetWear(WEAR_COSTUME_WEAPON);
+		if (pkCostumeWeapon)
 		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("If you want to change weapons, you must remove the weapon skin first."));
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("If you want to change weapons, you must remove the weapon skin first."));
 			return false;
 		}
 	}
@@ -9154,33 +8996,74 @@
 	if (false == CanUnequipNow(item))
 		return false;
 
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-	if (item->IsCostumeMount() && item->IsEquipped())
-		UnMount();
-#endif
+	if (item->GetType() == ITEM_BELT && item->IsEquipped() && CBeltInventoryHelper::IsExistItemInBeltInventory(this))
+	{
+		if (!CBeltInventoryHelper::ClearBelt(this))
+			return false;
+	}
 
 	int pos;
-#if defined(__DRAGON_SOUL_SYSTEM__)
 	if (item->IsDragonSoul())
 		pos = GetEmptyDragonSoulInventory(item);
-	else
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	else if (item->IsSkillBook())
+		pos = GetEmptySkillBookInventory(item->GetSize());
+	else if (item->IsUpgradeItem())
+		pos = GetEmptyUpgradeItemsInventory(item->GetSize());
+	else if (item->IsStone())
+		pos = GetEmptyStoneInventory(item->GetSize());
+	else if (item->IsGiftBox())
+		pos = GetEmptyGiftBoxInventory(item->GetSize());
 #endif
+	else
 		pos = GetEmptyInventory(item->GetSize());
 
 	// HARD CODING
 	if (item->GetVnum() == UNIQUE_ITEM_HIDE_ALIGNMENT_TITLE)
 		ShowAlignment(true);
 
+#if defined(__MOUNT_COSTUME_SYSTEM__)
+	if (bUnequip)
+	{
+		if (item->IsCostumeMount())
+			WasRidingBeforeDeath(false);
+	}
+#endif
+
 	item->RemoveFromCharacter();
-#if defined(__DRAGON_SOUL_SYSTEM__)
 	if (item->IsDragonSoul())
 #if defined(__WJ_PICKUP_ITEM_EFFECT__)
 		item->AddToCharacter(this, TItemPos(DRAGON_SOUL_INVENTORY, pos), false);
 #else
 		item->AddToCharacter(this, TItemPos(DRAGON_SOUL_INVENTORY, pos));
 #endif
-	else
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	else if (item->IsSkillBook())
+#if defined(__WJ_PICKUP_ITEM_EFFECT__)
+		item->AddToCharacter(this, TItemPos(INVENTORY, pos), false);
+#else
+		item->AddToCharacter(this, TItemPos(INVENTORY, pos));
+#endif
+	else if (item->IsUpgradeItem())
+#if defined(__WJ_PICKUP_ITEM_EFFECT__)
+		item->AddToCharacter(this, TItemPos(INVENTORY, pos), false);
+#else
+		item->AddToCharacter(this, TItemPos(INVENTORY, pos));
+#endif
+	else if (item->IsStone())
+#if defined(__WJ_PICKUP_ITEM_EFFECT__)
+		item->AddToCharacter(this, TItemPos(INVENTORY, pos), false);
+#else
+		item->AddToCharacter(this, TItemPos(INVENTORY, pos));
+#endif
+	else if (item->IsGiftBox())
+#if defined(__WJ_PICKUP_ITEM_EFFECT__)
+		item->AddToCharacter(this, TItemPos(INVENTORY, pos), false);
+#else
+		item->AddToCharacter(this, TItemPos(INVENTORY, pos));
 #endif
+#endif
+	else
 #if defined(__WJ_PICKUP_ITEM_EFFECT__)
 		item->AddToCharacter(this, TItemPos(INVENTORY, pos), false);
 #else
@@ -9214,46 +9097,47 @@
 	// 𰡸 ź ¿ νõ Ա 
 	if (iWearCell == WEAR_BODY && IsRiding() && (item->GetVnum() >= 11901 && item->GetVnum() <= 11904))
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ź ¿    ϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ź ¿    ϴ."));
 		return false;
 	}
 
 	if (iWearCell != WEAR_ARROW && IsPolymorphed())
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("а ߿     ϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("а ߿     ϴ."));
 		return false;
 	}
 
 	if (FN_check_item_sex(this, item) == false)
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ʾ     ϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ʾ     ϴ."));
 		return false;
 	}
 
 #if defined(__CHANGE_LOOK_SYSTEM__)
-	DWORD dwTransmutationVnum = item->GetTransmutationVnum();
-	if (dwTransmutationVnum != 0)
+	if (EChangeLookInfo::CHANGE_LOOK_CAN_EQUIP_MULTI_GENDER != TRUE)
 	{
-		TItemTable* pItemTable = ITEM_MANAGER::instance().GetTable(dwTransmutationVnum);
-
-		if (!pItemTable->CanUseByJob(GetJob()))
-		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Transmutation] You cannot equip the transmuted item as it does not match your class."));
-			return false;
-		}
-
-#	if defined(__COSTUME_SYSTEM__)
-		if (pItemTable && pItemTable->IsCostume())
+		if (item->GetTransmutation() != 0)
 		{
-			if ((IS_SET(pItemTable->GetAntiFlags(), ITEM_ANTIFLAG_MALE) && SEX_MALE == GET_SEX(this)) ||
-				(IS_SET(pItemTable->GetAntiFlags(), ITEM_ANTIFLAG_FEMALE) && SEX_FEMALE == GET_SEX(this)))
+			TItemTable* pItemTable = ITEM_MANAGER::instance().GetTable(item->GetTransmutation());
+			if (pItemTable && pItemTable->IsCostume())
 			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Transmutation] You cannot equip the transmuted item as it does not match your gender."));
-				return false;
+				bool bSexMatch = false;
+				if (IS_SET(pItemTable->GetAntiFlags(), ITEM_ANTIFLAG_MALE) && IsFemale())
+					bSexMatch = true;
+				else if (IS_SET(pItemTable->GetAntiFlags(), ITEM_ANTIFLAG_FEMALE) && IsMale())
+					bSexMatch = true;
+
+				if (pItemTable->IsCostumeBody() || pItemTable->IsCostumeHair())
+				{
+					if (!bSexMatch)
+					{
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT("[Transmutation] You cannot equip the transmuted item as it does not match your gender."));
+						return false;
+					}
+				}
 			}
 		}
 	}
-#	endif
 #endif
 
 	// ű Ż    뿩 üũ
@@ -9261,24 +9145,15 @@
 	{
 		if (IsRiding())
 		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("̹ Ż ̿Դϴ."));
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ Ż ̿Դϴ."));
 			return false;
 		}
 
 		if (IsPolymorphed())
 		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ¿  Ż  ϴ."));
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ¿  Ż  ϴ."));
 			return false;
 		}
-
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-		if (item->IsRideItem())
-		{
-			DWORD dwMountVnum = item->GetMountVnum();
-			if (dwMountVnum > 0 && FindAffect(AFFECT_MOUNT_FALL) == NULL)
-				MountVnum(dwMountVnum);
-		}
-#endif
 	}
 
 	// ȭ ̿ܿ   ð Ǵ ų  1.5 Ŀ  ü 
@@ -9292,7 +9167,7 @@
 		&& (dwCurTime - GetLastAttackTime() <= 1500 || dwCurTime - m_dwLastSkillTime <= 1500))
 #endif
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("     ֽϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("     ֽϴ."));
 		return false;
 	}
 
@@ -9304,7 +9179,7 @@
 			LPITEM pkCostumeWeapon = GetWear(WEAR_COSTUME_WEAPON);
 			if (pkCostumeWeapon && pkCostumeWeapon->GetValue(3) != item->GetSubType())
 			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("If you want to change weapons, you must remove the weapon skin first."));
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("If you want to change weapons, you must remove the weapon skin first."));
 				return false;
 			}
 		}
@@ -9313,7 +9188,7 @@
 			LPITEM pkCostumeWeapon = GetWear(WEAR_COSTUME_WEAPON);
 			if (pkCostumeWeapon)
 			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("If you want to change weapons, you must remove the weapon skin first."));
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("If you want to change weapons, you must remove the weapon skin first."));
 				return false;
 			}
 		}
@@ -9325,25 +9200,24 @@
 			LPITEM pkWeapon = GetWear(WEAR_WEAPON);
 			if (!pkWeapon)
 			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("You need to equip a weapon first."));
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You need to equip a weapon first."));
 				return false;
 			}
 			else if (pkWeapon->GetType() != ITEM_WEAPON || item->GetValue(3) != pkWeapon->GetSubType())
 			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot use this costume for this weapon."));
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot use this costume for this weapon."));
 				return false;
 			}
 		}
 	}
 #endif
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
 	// ȥ Ư ó
 	if (item->IsDragonSoul())
 	{
 		//  Ÿ ȥ ̹  ִٸ   .
 		// ȥ swap ϸ ȵ.
-		if (GetEquipmentItem(iWearCell))
+		if (GetInventoryItem(INVENTORY_MAX_NUM + iWearCell))
 		{
 			ChatPacket(CHAT_TYPE_INFO, "̹   ȥ ϰ ֽϴ.");
 			return false;
@@ -9356,24 +9230,34 @@
 	}
 	// ȥ ƴ.
 	else
-#endif
 	{
 		//    ִٸ,
 		if (GetWear(iWearCell) && !IS_SET(GetWear(iWearCell)->GetFlag(), ITEM_FLAG_IRREMOVABLE))
 		{
 			//   ѹ   Ұ. swap   Ұ
-			//if (item->GetWearFlag() == WEARABLE_ABILITY)
-			//	return false;
+			if (item->GetWearFlag() == WEARABLE_ABILITY)
+				return false;
+
+			/*
+			#if defined(__PENDANT_SYSTEM__)
+						if (item->GetWearFlag() == WEARABLE_PENDANT)
+							return false;
+			#endif
+			*/
 
-			if (!SwapItem(item->GetCell(), iWearCell))
+			if (!SwapItem((WORD)item->GetCell(), (WORD)(INVENTORY_MAX_NUM + iWearCell)))
+			{
 				return false;
+			}
 		}
 		else
 		{
 			BYTE bOldCell = item->GetCell();
 
 			if (item->EquipTo(this, iWearCell))
-				SyncQuickslot(SLOT_TYPE_INVENTORY, bOldCell, iWearCell);
+			{
+				SyncQuickslot(QUICKSLOT_TYPE_ITEM, bOldCell, iWearCell);
+			}
 		}
 	}
 
@@ -9401,13 +9285,13 @@
 		if (item->GetVnum() == UNIQUE_ITEM_HIDE_ALIGNMENT_TITLE)
 			ShowAlignment(false);
 
-		if (item->IsRing() || item->IsCostume()
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-			&& !item->IsCostumeMount()
-#endif
-			)
+#ifdef __AURA_COSTUME_SYSTEM__
+		if (item->IsRing() || item->IsCostume() && !item->IsCostumeMount())
 			ChatPacket(CHAT_TYPE_COMMAND, "OpenCostumeWindow");
-
+#else
+		if (item->IsRing() || item->IsCostumeWeapon() || item->IsCostumeBody() || item->IsCostumeHair() || item->IsCostumeAcce() && !item->IsCostumeMount())
+			ChatPacket(CHAT_TYPE_COMMAND, "OpenCostumeWindow");
+#endif
 		const DWORD& dwVnum = item->GetVnum();
 
 		// 󸶴 ̺Ʈ ʽ´ (71135)  Ʈ ߵ
@@ -9430,6 +9314,36 @@
 		{
 			this->EffectPacket(SE_EQUIP_LOVE_PENDANT);
 		}
+		// Magic Ring ( 71148 | 71149 )
+		else if (true == CItemVnumHelper::IsMagicRing(dwVnum))
+		{
+			this->EffectPacket(SE_EQUIP_MAGIC_RING);
+		}
+		// Easter Candy (71188)
+		else if (true == CItemVnumHelper::IsEasterCandy(dwVnum))
+		{
+			this->EffectPacket(SE_EQUIP_EASTER_CANDY);
+		}
+		// Chocolate Pendant (71199)
+		else if (true == CItemVnumHelper::IsChocolatePendant(dwVnum))
+		{
+			this->EffectPacket(SE_EQUIP_CHOCOLATE_PENDANT);
+		}
+		// Nazar Pendant (71202)
+		else if (true == CItemVnumHelper::IsNazarPendant(dwVnum))
+		{
+			this->EffectPacket(SE_EQUIP_NAZAR_PENDANT);
+		}
+		// Guardian Pendant (72054)
+		else if (true == CItemVnumHelper::IsGuardianPendant(dwVnum))
+		{
+			this->EffectPacket(SE_EQUIP_GUARDIAN_PENDANT);
+		}
+		// Gem Pendant (#) UNUSED
+		else if (true == CItemVnumHelper::IsGemCandy(dwVnum))
+		{
+			this->EffectPacket(SE_EQUIP_GEM_PENDANT);
+		}
 		// ITEM_UNIQUE , SpecialItemGroup ǵǾ ְ, (item->GetSIGVnum() != NULL)
 		//
 		else if ((ITEM_UNIQUE == item->GetType() || ITEM_RING == item->GetType()) && 0 != item->GetSIGVnum())
@@ -9445,28 +9359,22 @@
 				}
 			}
 		}
-
 #if defined(__ACCE_COSTUME_SYSTEM__)
-		if ((item->GetType() == ITEM_COSTUME) && (item->GetSubType() == COSTUME_ACCE
-#if defined(__AURA_COSTUME_SYSTEM__)
-			|| item->GetSubType() == COSTUME_AURA
-#endif
-			))
-		{
-			if (item->GetSocket(ITEM_SOCKET_ACCE_DRAIN_VALUE) > 18)
-				this->EffectPacket(SE_ACCE_BACK);
-			this->EffectPacket(SE_ACCE_EQUIP);
-		}
+		else if ((item->GetType() == ITEM_COSTUME) && (item->GetSubType() == COSTUME_ACCE))
+			this->EffectPacket(SE_EQUIP_ACCE);
 #endif
 
-		if ((ITEM_UNIQUE == item->GetType() && UNIQUE_SPECIAL_RIDE == item->GetSubType() && IS_SET(item->GetFlag(), ITEM_FLAG_QUEST_USE))
 #if defined(__MOUNT_COSTUME_SYSTEM__)
-			|| (ITEM_COSTUME == item->GetType() && COSTUME_MOUNT == item->GetSubType())
-#endif
-			)
+		if (COSTUME_MOUNT == item->GetSubType() && item->GetType() == ITEM_COSTUME)
 		{
 			quest::CQuestManager::instance().UseItem(GetPlayerID(), item, false);
 		}
+#else
+		if (UNIQUE_SPECIAL_RIDE == item->GetSubType() && IS_SET(item->GetFlag(), ITEM_FLAG_QUEST_USE))
+		{
+			quest::CQuestManager::instance().UseItem(GetPlayerID(), item, false);
+		}
+#endif
 	}
 
 	return true;
@@ -9498,7 +9406,7 @@
 
 void CHARACTER::BuffOnAttr_ClearAll()
 {
-	for (TMapBuffOnAttrs::iterator it = m_map_buff_on_attrs.begin(); it != m_map_buff_on_attrs.end(); ++it)
+	for (TMapBuffOnAttrs::iterator it = m_map_buff_on_attrs.begin(); it != m_map_buff_on_attrs.end(); it++)
 	{
 		CBuffOnAttributes* pBuff = it->second;
 		if (pBuff)
@@ -9508,211 +9416,170 @@
 	}
 }
 
-void CHARACTER::BuffOnAttr_ValueChange(POINT_TYPE wPointType, POINT_VALUE llOldValue, POINT_VALUE lNewValue)
+void CHARACTER::BuffOnAttr_ValueChange(BYTE bType, BYTE bOldValue, BYTE bNewValue)
 {
-	TMapBuffOnAttrs::iterator it = m_map_buff_on_attrs.find(wPointType);
+	TMapBuffOnAttrs::iterator it = m_map_buff_on_attrs.find(bType);
 
-	if (0 == lNewValue)
+	if (0 == bNewValue)
 	{
 		if (m_map_buff_on_attrs.end() == it)
 			return;
 		else
 			it->second->Off();
 	}
-	else if (0 == llOldValue)
+	else if (0 == bOldValue)
 	{
 		CBuffOnAttributes* pBuff;
 		if (m_map_buff_on_attrs.end() == it)
 		{
-			switch (wPointType)
+			switch (bType)
 			{
-				case POINT_ENERGY:
-				{
-					static BYTE s_abSlot[] = {
-						WEAR_BODY,
-						WEAR_HEAD,
-						WEAR_FOOTS,
-						WEAR_WRIST,
-						WEAR_WEAPON,
-						WEAR_NECK,
-						WEAR_EAR,
-						WEAR_SHIELD,
+			case POINT_ENERGY:
+			{
+				static BYTE abSlot[] = {
+					WEAR_BODY,
+					WEAR_HEAD,
+					WEAR_FOOTS,
+					WEAR_WRIST,
+					WEAR_WEAPON,
+					WEAR_NECK,
+					WEAR_EAR,
+					WEAR_SHIELD
 #if defined(__PENDANT_SYSTEM__)
-						WEAR_PENDANT,
+					, WEAR_PENDANT
 #endif
 #if defined(__GLOVE_SYSTEM__)
-						WEAR_GLOVE,
+					, WEAR_GLOVE
 #endif
-					};
-					static std::vector<POINT_TYPE> s_vSlots(s_abSlot, s_abSlot + _countof(s_abSlot));
-					pBuff = M2_NEW CBuffOnAttributes(this, wPointType, &s_vSlots);
-				}
-				break;
+				};
+				static std::vector <BYTE> vec_slots(abSlot, abSlot + _countof(abSlot));
+				pBuff = M2_NEW CBuffOnAttributes(this, bType, &vec_slots);
+			}
+			break;
 
-				case POINT_COSTUME_ATTR_BONUS:
-				{
-					static BYTE s_abSlot[] = {
-						WEAR_COSTUME_BODY,
-						WEAR_COSTUME_HAIR,
+			case POINT_COSTUME_ATTR_BONUS:
+			{
+				static BYTE abSlot[] = {
+					WEAR_COSTUME_BODY,
+					WEAR_COSTUME_HAIR,
 #if defined(__WEAPON_COSTUME_SYSTEM__)
-						WEAR_COSTUME_WEAPON,
+					WEAR_COSTUME_WEAPON,
 #endif
-					};
-					static std::vector<POINT_TYPE> s_vSlots(s_abSlot, s_abSlot + _countof(s_abSlot));
-					pBuff = M2_NEW CBuffOnAttributes(this, wPointType, &s_vSlots);
-				}
-				break;
+				};
+				static std::vector <BYTE> vec_slots(abSlot, abSlot + _countof(abSlot));
+				pBuff = M2_NEW CBuffOnAttributes(this, bType, &vec_slots);
+			}
+			break;
 
-				default:
-					break;
+			default:
+				break;
 
 			}
-			m_map_buff_on_attrs.insert(TMapBuffOnAttrs::value_type(wPointType, pBuff));
+			m_map_buff_on_attrs.insert(TMapBuffOnAttrs::value_type(bType, pBuff));
 
 		}
 		else
 			pBuff = it->second;
 
-		pBuff->On(lNewValue);
+		pBuff->On(bNewValue);
 	}
 	else
 	{
 		if (m_map_buff_on_attrs.end() == it)
 			return;
 		else
-			it->second->ChangeBuffValue(lNewValue);
+			it->second->ChangeBuffValue(bNewValue);
 	}
 }
 
-LPITEM CHARACTER::FindSpecifyItem(DWORD dwVnum
-#if defined(__SOUL_BIND_SYSTEM__)
-	, bool bIgnoreSoulBound
-#endif
-#if defined(__SET_ITEM__)
-	, bool bIgnoreSetValue
-#endif
-) const
+LPITEM CHARACTER::FindSpecifyItem(DWORD vnum) const
 {
 	for (int i = 0; i < INVENTORY_MAX_NUM; ++i)
-	{
-		if (GetInventoryItem(i) && GetInventoryItem(i)->GetVnum() == dwVnum)
-		{
-#if defined(__SOUL_BIND_SYSTEM__)
-			if (bIgnoreSoulBound && GetInventoryItem(i)->IsSealed())
-				continue;
-#endif
-
-#if defined(__SET_ITEM__)
-			if (bIgnoreSetValue && GetInventoryItem(i)->GetItemSetValue())
-				continue;
-#endif
+		if (GetInventoryItem(i) && GetInventoryItem(i)->GetVnum() == vnum)
 			return GetInventoryItem(i);
-		}
-	}
+
 	return NULL;
 }
 
 LPITEM CHARACTER::FindItemByID(DWORD id) const
 {
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	for (WORD wCell = 0; wCell < GetExtendInvenMax(); ++wCell)
-#else
-	for (WORD wCell = 0; wCell < INVENTORY_MAX_NUM; ++wCell)
-#endif
-		if (GetInventoryItem(wCell) && GetInventoryItem(wCell)->GetID() == id)
-			return GetInventoryItem(wCell);
-
-#if defined(__DRAGON_SOUL_SYSTEM__)
-	for (WORD wCell = 0; wCell < DRAGON_SOUL_INVENTORY_MAX_NUM; ++wCell)
-		if (GetDragonSoulInventoryItem(wCell) && GetDragonSoulInventoryItem(wCell)->GetID() == id)
-			return GetDragonSoulInventoryItem(wCell);
-#endif
+	for (int i = 0; i < INVENTORY_MAX_NUM; ++i)
+	{
+		if (NULL != GetInventoryItem(i) && GetInventoryItem(i)->GetID() == id)
+			return GetInventoryItem(i);
+	}
 
-	for (WORD wCell = 0; wCell < BELT_INVENTORY_MAX_NUM; ++wCell)
-		if (GetBeltInventoryItem(wCell) && GetBeltInventoryItem(wCell)->GetID() == id)
-			return GetBeltInventoryItem(wCell);
+	for (int i = BELT_INVENTORY_SLOT_START; i < BELT_INVENTORY_SLOT_END; ++i)
+	{
+		if (NULL != GetInventoryItem(i) && GetInventoryItem(i)->GetID() == id)
+			return GetInventoryItem(i);
+	}
 
 	return NULL;
 }
 
-int CHARACTER::CountSpecifyItem(DWORD vnum, int iExceptionCell
-#if defined(__SOUL_BIND_SYSTEM__)
-	, bool bIgnoreSealedItem
-#endif
-#if defined(__SET_ITEM__)
-	, bool bIgnoreSetValue
-#endif
-) const
+int CHARACTER::CountSpecifyItem(DWORD vnum, int iExceptionCell) const
 {
-	int iCount = 0;
-	LPITEM pItem = nullptr;
+	int count = 0;
+	LPITEM item;
 
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	for (WORD wCell = 0; wCell < GetExtendInvenMax(); ++wCell)
-#else
-	for (WORD wCell = 0; wCell < INVENTORY_MAX_NUM; ++wCell)
-#endif
+	for (int i = 0; i < INVENTORY_MAX_NUM; ++i)
 	{
-		if (wCell == iExceptionCell)
+		if (i == iExceptionCell)
 			continue;
 
-		pItem = GetInventoryItem(wCell);
-		if (pItem && pItem->GetVnum() == vnum)
+		item = GetInventoryItem(i);
+		if (NULL != item && item->GetVnum() == vnum)
 		{
 			//   ϵ ̸ Ѿ.
-			if (m_pkMyShop && m_pkMyShop->IsSellingItem(pItem->GetID()))
-				continue;
-
-#if defined(__SOUL_BIND_SYSTEM__)
-			if (bIgnoreSealedItem && pItem->IsSealed())
-				continue;
-#endif
-
-#if defined(__SET_ITEM__)
-			if (bIgnoreSetValue && pItem->GetItemSetValue())
+			if (m_pkMyShop && m_pkMyShop->IsSellingItem(item->GetID()))
+			{
 				continue;
-#endif
+			}
+			else
+			{
+				count += item->GetCount();
+			}
+		}
+	}
 
-			iCount += pItem->GetCount();
+	for (int i = 0; i < DRAGON_SOUL_INVENTORY_MAX_NUM; ++i)
+	{
+		item = GetDragonSoulItem(i);
+		if (item && item->GetVnum() == vnum)
+		{
+			count += item->GetCount();
 		}
 	}
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
-	for (WORD wCell = 0; wCell < DRAGON_SOUL_INVENTORY_MAX_NUM; ++wCell)
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	for (int i = SKILL_BOOK_INVENTORY_SLOT_START; i < GIFT_BOX_INVENTORY_SLOT_END; ++i)
 	{
-		pItem = GetDragonSoulInventoryItem(wCell);
-		if (pItem && pItem->GetVnum() == vnum)
+		item = GetInventoryItem(i);
+		if (NULL != item && item->GetVnum() == vnum)
 		{
-#if defined(__SOUL_BIND_SYSTEM__)
-			if (bIgnoreSealedItem && pItem->IsSealed())
+			//   ϵ ̸ Ѿ.
+			if (m_pkMyShop && m_pkMyShop->IsSellingItem(item->GetID()))
+			{
 				continue;
-#endif
-
-			iCount += pItem->GetCount();
+			}
+			else
+			{
+				count += item->GetCount();
+			}
 		}
 	}
 #endif
 
-	return iCount;
+	return count;
 }
 
-void CHARACTER::RemoveSpecifyItem(DWORD vnum, DWORD count, int iExceptionCell
-#if defined(__SOUL_BIND_SYSTEM__)
-	, bool bIgnoreSealedItem
-#endif
-#if defined(__SET_ITEM__)
-	, bool bIgnoreSetValue
-#endif
-)
+void CHARACTER::RemoveSpecifyItem(DWORD vnum, DWORD count, int iExceptionCell)
 {
 	if (0 == count)
 		return;
 
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	for (UINT i = 0; i < GetExtendInvenMax(); ++i)
-#else
 	for (UINT i = 0; i < INVENTORY_MAX_NUM; ++i)
-#endif
 	{
 		if (i == iExceptionCell)
 			continue;
@@ -9723,16 +9590,6 @@
 		if (GetInventoryItem(i)->GetVnum() != vnum)
 			continue;
 
-#if defined(__SOUL_BIND_SYSTEM__)
-		if (bIgnoreSealedItem && GetInventoryItem(i)->IsSealed())
-			continue;
-#endif
-
-#if defined(__SET_ITEM__)
-		if (bIgnoreSetValue && GetInventoryItem(i)->GetItemSetValue())
-			continue;
-#endif
-
 		//  ϵ ̸ Ѿ. (  Ǹŵɶ  κ   !)
 		if (m_pkMyShop)
 		{
@@ -9759,36 +9616,60 @@
 		}
 	}
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
 	for (UINT i = 0; i < DRAGON_SOUL_INVENTORY_MAX_NUM; ++i)
 	{
-		if (NULL == GetDragonSoulInventoryItem(i))
+		if (NULL == GetDragonSoulItem(i))
 			continue;
 
-		if (GetDragonSoulInventoryItem(i)->GetVnum() != vnum)
+		if (GetDragonSoulItem(i)->GetVnum() != vnum)
 			continue;
 
-#if defined(__SOUL_BIND_SYSTEM__)
-		if (bIgnoreSealedItem && GetDragonSoulInventoryItem(i)->IsSealed())
+		if (count >= GetDragonSoulItem(i)->GetCount())
+		{
+			count -= GetDragonSoulItem(i)->GetCount();
+			GetDragonSoulItem(i)->SetCount(0);
+
+			if (0 == count)
+				return;
+		}
+		else
+		{
+			GetDragonSoulItem(i)->SetCount(GetInventoryItem(i)->GetCount() - count);
+			return;
+		}
+	}
+
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	for (UINT i = SKILL_BOOK_INVENTORY_SLOT_START; i < GIFT_BOX_INVENTORY_SLOT_END; ++i)
+	{
+		if (NULL == GetInventoryItem(i))
 			continue;
-#endif
 
-#if defined(__SET_ITEM__)
-		if (bIgnoreSetValue && GetDragonSoulInventoryItem(i)->GetItemSetValue())
+		if (GetInventoryItem(i)->GetVnum() != vnum)
 			continue;
-#endif
 
-		if (count >= GetDragonSoulInventoryItem(i)->GetCount())
+		//  ϵ ̸ Ѿ. (  Ǹŵɶ  κ   !)
+		if (m_pkMyShop)
 		{
-			count -= GetDragonSoulInventoryItem(i)->GetCount();
-			GetDragonSoulInventoryItem(i)->SetCount(0);
+			bool isItemSelling = m_pkMyShop->IsSellingItem(GetInventoryItem(i)->GetID());
+			if (isItemSelling)
+				continue;
+		}
+
+		if (vnum >= 80003 && vnum <= 80007)
+			LogManager::instance().GoldBarLog(GetPlayerID(), GetInventoryItem(i)->GetID(), QUEST, "RemoveSpecifyItem");
+
+		if (count >= GetInventoryItem(i)->GetCount())
+		{
+			count -= GetInventoryItem(i)->GetCount();
+			GetInventoryItem(i)->SetCount(0);
 
 			if (0 == count)
 				return;
 		}
 		else
 		{
-			GetDragonSoulInventoryItem(i)->SetCount(GetInventoryItem(i)->GetCount() - count);
+			GetInventoryItem(i)->SetCount(GetInventoryItem(i)->GetCount() - count);
 			return;
 		}
 	}
@@ -9803,11 +9684,7 @@
 {
 	int count = 0;
 
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	for (int i = 0; i < GetExtendInvenMax(); ++i)
-#else
 	for (int i = 0; i < INVENTORY_MAX_NUM; ++i)
-#endif
 	{
 		LPITEM pItem = GetInventoryItem(i);
 		if (pItem != NULL && pItem->GetType() == type)
@@ -9824,11 +9701,7 @@
 	if (0 == count)
 		return;
 
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	for (UINT i = 0; i < GetExtendInvenMax(); ++i)
-#else
 	for (UINT i = 0; i < INVENTORY_MAX_NUM; ++i)
-#endif
 	{
 		if (NULL == GetInventoryItem(i))
 			continue;
@@ -9859,33 +9732,175 @@
 		}
 	}
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
 	for (UINT i = 0; i < DRAGON_SOUL_INVENTORY_MAX_NUM; ++i)
 	{
-		if (NULL == GetDragonSoulInventoryItem(i))
+		if (NULL == GetDragonSoulItem(i))
 			continue;
 
-		if (GetDragonSoulInventoryItem(i)->GetType() != type)
+		if (GetDragonSoulItem(i)->GetType() != type)
 			continue;
 
-		if (count >= GetDragonSoulInventoryItem(i)->GetCount())
+		if (count >= GetDragonSoulItem(i)->GetCount())
+		{
+			count -= GetDragonSoulItem(i)->GetCount();
+			GetDragonSoulItem(i)->SetCount(0);
+
+			if (0 == count)
+				return;
+		}
+		else
+		{
+			GetDragonSoulItem(i)->SetCount(GetInventoryItem(i)->GetCount() - count);
+			return;
+		}
+	}
+
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	for (UINT i = SKILL_BOOK_INVENTORY_SLOT_START; i < GIFT_BOX_INVENTORY_SLOT_END; ++i)
+	{
+		if (NULL == GetInventoryItem(i))
+			continue;
+
+		if (GetInventoryItem(i)->GetType() != type)
+			continue;
+
+		//   ϵ ̸ Ѿ. (  Ǹŵɶ  κ   !)
+		if (m_pkMyShop)
+		{
+			bool isItemSelling = m_pkMyShop->IsSellingItem(GetInventoryItem(i)->GetID());
+			if (isItemSelling)
+				continue;
+		}
+
+		if (count >= GetInventoryItem(i)->GetCount())
 		{
-			count -= GetDragonSoulInventoryItem(i)->GetCount();
-			GetDragonSoulInventoryItem(i)->SetCount(0);
+			count -= GetInventoryItem(i)->GetCount();
+			GetInventoryItem(i)->SetCount(0);
 
 			if (0 == count)
 				return;
 		}
 		else
 		{
-			GetDragonSoulInventoryItem(i)->SetCount(GetInventoryItem(i)->GetCount() - count);
+			GetInventoryItem(i)->SetCount(GetInventoryItem(i)->GetCount() - count);
 			return;
 		}
 	}
 #endif
 }
 
-// 20200808.Owsap : Fix book stacking while sorting.
+#if defined(__WJ_PICKUP_ITEM_EFFECT__)
+void CHARACTER::AutoGiveItem(LPITEM item, bool longOwnerShip, bool isHighLight)
+#else
+void CHARACTER::AutoGiveItem(LPITEM item, bool longOwnerShip)
+#endif
+{
+	if (NULL == item)
+	{
+		sys_err("NULL point.");
+		return;
+	}
+
+	if (item->GetOwner())
+	{
+		sys_err("item %d 's owner exists!", item->GetID());
+		return;
+	}
+
+	int cell;
+	if (item->IsDragonSoul())
+	{
+		cell = GetEmptyDragonSoulInventory(item);
+	}
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	else if (item->IsSkillBook())
+	{
+		cell = GetEmptySkillBookInventory(item->GetSize());
+	}
+	else if (item->IsUpgradeItem())
+	{
+		cell = GetEmptyUpgradeItemsInventory(item->GetSize());
+	}
+	else if (item->IsStone())
+	{
+		cell = GetEmptyStoneInventory(item->GetSize());
+	}
+	else if (item->IsGiftBox())
+	{
+		cell = GetEmptyGiftBoxInventory(item->GetSize());
+	}
+#endif
+	else
+	{
+		cell = GetEmptyInventory(item->GetSize());
+	}
+
+	if (cell != -1)
+	{
+		if (item->IsDragonSoul())
+			item->AddToCharacter(this, TItemPos(DRAGON_SOUL_INVENTORY, cell));
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+		else if (item->IsSkillBook())
+#if defined(__WJ_PICKUP_ITEM_EFFECT__)
+			item->AddToCharacter(this, TItemPos(INVENTORY, cell), isHighLight);
+#else
+			item->AddToCharacter(this, TItemPos(INVENTORY, cell));
+#endif
+		else if (item->IsUpgradeItem())
+#if defined(__WJ_PICKUP_ITEM_EFFECT__)
+			item->AddToCharacter(this, TItemPos(INVENTORY, cell), isHighLight);
+#else
+			item->AddToCharacter(this, TItemPos(INVENTORY, cell));
+#endif
+		else if (item->IsStone())
+#if defined(__WJ_PICKUP_ITEM_EFFECT__)
+			item->AddToCharacter(this, TItemPos(INVENTORY, cell), isHighLight);
+#else
+			item->AddToCharacter(this, TItemPos(INVENTORY, cell));
+#endif
+		else if (item->IsGiftBox())
+#if defined(__WJ_PICKUP_ITEM_EFFECT__)
+			item->AddToCharacter(this, TItemPos(INVENTORY, cell), isHighLight);
+#else
+			item->AddToCharacter(this, TItemPos(INVENTORY, cell));
+#endif
+#endif
+		else
+#if defined(__WJ_PICKUP_ITEM_EFFECT__)
+			item->AddToCharacter(this, TItemPos(INVENTORY, cell), isHighLight);
+#else
+			item->AddToCharacter(this, TItemPos(INVENTORY, cell));
+#endif
+
+		LogManager::instance().ItemLog(this, item, "SYSTEM", item->GetName());
+
+		if (item->GetType() == ITEM_USE && item->GetSubType() == USE_POTION)
+		{
+			TQuickslot* pSlot;
+
+			if (GetQuickslot(0, &pSlot) && pSlot->type == QUICKSLOT_TYPE_NONE)
+			{
+				TQuickslot slot;
+				slot.type = QUICKSLOT_TYPE_ITEM;
+				slot.pos = cell;
+				SetQuickslot(0, slot);
+			}
+		}
+	}
+	else
+	{
+		item->AddToGround(GetMapIndex(), GetXYZ());
+		item->StartDestroyEvent();
+
+		if (longOwnerShip)
+			item->SetOwnership(this, 300);
+		else
+			item->SetOwnership(this, 60);
+		LogManager::instance().ItemLog(this, item, "SYSTEM_DROP", item->GetName());
+	}
+}
+
+//< 2020.08.08.Owsap - Fix book stacking while sorting.
 void CHARACTER::GiveSkillBook(DWORD dwSkillVnum, WORD wCount)
 {
 	for (int i = 0; i < INVENTORY_MAX_NUM; ++i)
@@ -9897,7 +9912,7 @@
 
 		if ((pkItem->GetType() == ITEM_SKILLBOOK || pkItem->GetType() == ITEM_SKILLFORGET) && pkItem->GetSocket(0) == dwSkillVnum)
 		{
-			WORD wCount2 = MIN(ITEM_MAX_COUNT - pkItem->GetCount(), wCount);
+			WORD wCount2 = MIN(gMaxItemCount - pkItem->GetCount(), wCount);
 			wCount -= wCount2;
 
 			pkItem->SetCount(pkItem->GetCount() + wCount2);
@@ -9906,22 +9921,40 @@
 		}
 	}
 
-	LPITEM pkBookItem = AutoGiveItem(ITEM_SKILLBOOK_VNUM, wCount, false, false);
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	for (int i = SKILL_BOOK_INVENTORY_SLOT_START; i < SKILL_BOOK_INVENTORY_SLOT_END; ++i)
+	{
+		LPITEM pkItem = GetSkillBookInventoryItem(i);
+
+		if (!pkItem)
+			continue;
+
+		if ((pkItem->GetType() == ITEM_SKILLBOOK || pkItem->GetType() == ITEM_SKILLFORGET) && pkItem->GetSocket(0) == dwSkillVnum)
+		{
+			WORD wCount2 = MIN(gMaxItemCount - pkItem->GetCount(), wCount);
+			wCount -= wCount2;
+
+			pkItem->SetCount(pkItem->GetCount() + wCount2);
+			if (wCount == 0)
+				return;
+		}
+	}
+#endif
+
+	LPITEM pkBookItem = AutoGiveItem(50300, wCount, false, false);
 	if (NULL != pkBookItem)
 		pkBookItem->SetSocket(0, dwSkillVnum);
 }
 //>
 
-LPITEM CHARACTER::AutoGiveItem(DWORD dwItemVnum, WORD wCount, int iRarePct, bool bMsg
 #if defined(__WJ_PICKUP_ITEM_EFFECT__)
-	, bool isHighLight
-#endif
-#if defined(__NEW_USER_CARE__)
-	, bool bSystemDrop
+LPITEM CHARACTER::AutoGiveItem(DWORD dwItemVnum, WORD wCount, int iRarePct, bool bMsg, bool isHighLight)
+#else
+LPITEM CHARACTER::AutoGiveItem(DWORD dwItemVnum, WORD bCount, int iRarePct, bool bMsg)
 #endif
-)
 {
 	TItemTable* p = ITEM_MANAGER::instance().GetTable(dwItemVnum);
+
 	if (!p)
 		return NULL;
 
@@ -9944,7 +9977,7 @@
 						wCount = p->alValues[1];
 				}
 
-				WORD wCount2 = MIN(ITEM_MAX_COUNT - item->GetCount(), wCount);
+				WORD wCount2 = MIN(gMaxItemCount - item->GetCount(), wCount);
 				wCount -= wCount2;
 
 				item->SetCount(item->GetCount() + wCount2);
@@ -9952,26 +9985,134 @@
 				if (wCount == 0)
 				{
 					if (bMsg)
-					{
-#if defined(__CHATTING_WINDOW_RENEWAL__)
-#	if defined(__SET_ITEM__)
-						ChatPacket(CHAT_TYPE_ITEM_INFO, LC_STRING(" ȹ: %s", LC_PRE_ITEM(item->GetItemSetValue(), item->GetVnum())));
-#	else
-						ChatPacket(CHAT_TYPE_ITEM_INFO, LC_STRING(" ȹ: %s", LC_ITEM(item->GetVnum())));
-#	endif
-#else
-#	if defined(__SET_ITEM__)
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȹ: %s", LC_PRE_ITEM(item->GetItemSetValue(), item->GetVnum())));
-#	else
-						ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȹ: %s", LC_ITEM(item->GetVnum())));
-#	endif
-#endif
-					}
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ȹ: %s"), item->GetLocaleName());
+
+					return item;
+				}
+			}
+		}
+
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+		for (int i = SKILL_BOOK_INVENTORY_SLOT_START; i < SKILL_BOOK_INVENTORY_SLOT_END; ++i)
+		{
+			LPITEM item = GetSkillBookInventoryItem(i);
+
+			if (!item)
+				continue;
+
+			if (item->GetVnum() == dwItemVnum && FN_check_item_socket(item))
+			{
+				if (IS_SET(p->dwFlags, ITEM_FLAG_MAKECOUNT))
+				{
+					if (wCount < p->alValues[1])
+						wCount = p->alValues[1];
+				}
+
+				WORD wCount2 = MIN(gMaxItemCount - item->GetCount(), wCount);
+				wCount -= wCount2;
+
+				item->SetCount(item->GetCount() + wCount2);
+
+				if (wCount == 0)
+				{
+					if (bMsg)
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ȹ: %s"), item->GetLocaleName());
+
+					return item;
+				}
+			}
+		}
+
+		for (int i = UPGRADE_ITEMS_INVENTORY_SLOT_START; i < UPGRADE_ITEMS_INVENTORY_SLOT_END; ++i)
+		{
+			LPITEM item = GetUpgradeItemsInventoryItem(i);
+
+			if (!item)
+				continue;
+
+			if (item->GetVnum() == dwItemVnum && FN_check_item_socket(item))
+			{
+				if (IS_SET(p->dwFlags, ITEM_FLAG_MAKECOUNT))
+				{
+					if (wCount < p->alValues[1])
+						wCount = p->alValues[1];
+				}
+
+				WORD wCount2 = MIN(gMaxItemCount - item->GetCount(), wCount);
+				wCount -= wCount2;
+
+				item->SetCount(item->GetCount() + wCount2);
+
+				if (wCount == 0)
+				{
+					if (bMsg)
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ȹ: %s"), item->GetLocaleName());
+
+					return item;
+				}
+			}
+		}
+
+		for (int i = STONE_INVENTORY_SLOT_START; i < STONE_INVENTORY_SLOT_END; ++i)
+		{
+			LPITEM item = GetStoneInventoryItem(i);
+
+			if (!item)
+				continue;
+
+			if (item->GetVnum() == dwItemVnum && FN_check_item_socket(item))
+			{
+				if (IS_SET(p->dwFlags, ITEM_FLAG_MAKECOUNT))
+				{
+					if (wCount < p->alValues[1])
+						wCount = p->alValues[1];
+				}
+
+				WORD wCount2 = MIN(gMaxItemCount - item->GetCount(), wCount);
+				wCount -= wCount2;
+
+				item->SetCount(item->GetCount() + wCount2);
+
+				if (wCount == 0)
+				{
+					if (bMsg)
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ȹ: %s"), item->GetLocaleName());
+
+					return item;
+				}
+			}
+		}
+
+		for (int i = GIFT_BOX_INVENTORY_SLOT_START; i < GIFT_BOX_INVENTORY_SLOT_END; ++i)
+		{
+			LPITEM item = GetGiftBoxInventoryItem(i);
+
+			if (!item)
+				continue;
+
+			if (item->GetVnum() == dwItemVnum && FN_check_item_socket(item))
+			{
+				if (IS_SET(p->dwFlags, ITEM_FLAG_MAKECOUNT))
+				{
+					if (wCount < p->alValues[1])
+						wCount = p->alValues[1];
+				}
+
+				WORD wCount2 = MIN(gMaxItemCount - item->GetCount(), wCount);
+				wCount -= wCount2;
+
+				item->SetCount(item->GetCount() + wCount2);
+
+				if (wCount == 0)
+				{
+					if (bMsg)
+						ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ȹ: %s"), item->GetLocaleName());
 
 					return item;
 				}
 			}
 		}
+#endif
 	}
 
 	LPITEM item = ITEM_MANAGER::instance().CreateItem(dwItemVnum, wCount, 0, true);
@@ -9988,19 +10129,28 @@
 		{
 			LPITEM inv_item = GetInventoryItem(i);
 
-			if (inv_item == NULL)
-				continue;
+			if (inv_item == NULL) continue;
 
+#if defined(__EXTENDED_BLEND_AFFECT__)
+			if (inv_item->GetType() == ITEM_BLEND && !inv_item->IsExtendedBlend(inv_item->GetVnum()))
+#else
 			if (inv_item->GetType() == ITEM_BLEND)
+#endif
 			{
 				if (inv_item->GetVnum() == item->GetVnum())
 				{
 					if (inv_item->GetSocket(0) == item->GetSocket(0) &&
 						inv_item->GetSocket(1) == item->GetSocket(1) &&
+#if !defined(__EXTENDED_BLEND_AFFECT__)
 						inv_item->GetSocket(2) == item->GetSocket(2) &&
-						inv_item->GetCount() + item->GetCount() <= ITEM_MAX_COUNT)
+#endif
+						inv_item->GetCount() < gMaxItemCount)
 					{
+#if defined(__EXTENDED_BLEND_AFFECT__)
+						inv_item->SetSocket(2, inv_item->GetSocket(2) + item->GetSocket(2));
+#else
 						inv_item->SetCount(inv_item->GetCount() + item->GetCount());
+#endif
 						M2_DESTROY_ITEM(item);
 						return inv_item;
 					}
@@ -10010,204 +10160,60 @@
 	}
 
 	int iEmptyCell;
-#if defined(__DRAGON_SOUL_SYSTEM__)
 	if (item->IsDragonSoul())
 		iEmptyCell = GetEmptyDragonSoulInventory(item);
-	else
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	else if (item->IsSkillBook())
+		iEmptyCell = GetEmptySkillBookInventory(item->GetSize());
+	else if (item->IsUpgradeItem())
+		iEmptyCell = GetEmptyUpgradeItemsInventory(item->GetSize());
+	else if (item->IsStone())
+		iEmptyCell = GetEmptyStoneInventory(item->GetSize());
+	else if (item->IsGiftBox())
+		iEmptyCell = GetEmptyGiftBoxInventory(item->GetSize());
 #endif
+	else
 		iEmptyCell = GetEmptyInventory(item->GetSize());
 
 	if (iEmptyCell != -1)
 	{
-#if defined(__DRAGON_SOUL_SYSTEM__)
 		if (item->IsDragonSoul())
 			item->AddToCharacter(this, TItemPos(DRAGON_SOUL_INVENTORY, iEmptyCell));
-		else
-#endif
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+		else if (item->IsSkillBook())
 #if defined(__WJ_PICKUP_ITEM_EFFECT__)
 			item->AddToCharacter(this, TItemPos(INVENTORY, iEmptyCell), isHighLight);
 #else
 			item->AddToCharacter(this, TItemPos(INVENTORY, iEmptyCell));
 #endif
-
-		if (bMsg)
-#if defined(__CHATTING_WINDOW_RENEWAL__)
-#if defined(__SET_ITEM__)
-			ChatPacket(CHAT_TYPE_ITEM_INFO, LC_STRING(" ȹ: %s", LC_PRE_ITEM(item->GetItemSetValue(), item->GetVnum())));
-#else
-			ChatPacket(CHAT_TYPE_ITEM_INFO, LC_STRING(" ȹ: %s", LC_ITEM(item->GetVnum())));
-#endif
-#else
-#if defined(__SET_ITEM__)
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȹ: %s", LC_PRE_ITEM(item->GetItemSetValue(), item->GetVnum())));
+		else if (item->IsUpgradeItem())
+#if defined(__WJ_PICKUP_ITEM_EFFECT__)
+			item->AddToCharacter(this, TItemPos(INVENTORY, iEmptyCell), isHighLight);
 #else
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȹ: %s", LC_ITEM(item->GetVnum())));
-#endif
-#endif
-
-		LogManager::instance().ItemLog(this, item, "SYSTEM", item->GetName());
-
-		if (item->GetType() == ITEM_USE && item->GetSubType() == USE_POTION)
-		{
-			TQuickslot* pSlot;
-
-			if (GetQuickslot(0, &pSlot) && pSlot->type == SLOT_TYPE_NONE)
-			{
-				TQuickslot slot;
-				slot.type = SLOT_TYPE_INVENTORY;
-				slot.pos = iEmptyCell;
-				SetQuickslot(0, slot);
-			}
-		}
-	}
-	else
-	{
-#if defined(__NEW_USER_CARE__)
-		if (!bSystemDrop)
-		{
-			sys_log(0, "AutoGiveItem: No inventory space, SystemDrop disabled!");
-
-			M2_DESTROY_ITEM(item);
-			return NULL;
-		}
+			item->AddToCharacter(this, TItemPos(INVENTORY, iEmptyCell));
 #endif
-
-		item->AddToGround(GetMapIndex(), GetXYZ());
-		item->StartDestroyEvent();
-		// Ƽ  flag ɷִ  ,
-		// κ    ¿   Ʈ Ǹ,
-		// ownership   (300) Ѵ.
-		if (IS_SET(item->GetAntiFlag(), ITEM_ANTIFLAG_DROP))
-			item->SetOwnership(this, 300);
-		else
-			item->SetOwnership(this, 60);
-
-		LogManager::instance().ItemLog(this, item, "SYSTEM_DROP", item->GetName());
-	}
-
-	sys_log(0, "7: %d %d", dwItemVnum, wCount);
-	return item;
-}
-
-#define __AUTO_GIVE_ITEM_STACK__
-void CHARACTER::AutoGiveItem(LPITEM item, bool longOwnerShip, bool bMsg
+		else if (item->IsStone())
 #if defined(__WJ_PICKUP_ITEM_EFFECT__)
-	, bool isHighLight
-#endif
-)
-{
-	if (NULL == item)
-	{
-		sys_err("NULL point.");
-		return;
-	}
-
-	if (item->GetOwner())
-	{
-		sys_err("item %d 's owner exists!", item->GetID());
-		return;
-	}
-
-#if defined(__AUTO_GIVE_ITEM_STACK__)
-	if (item->IsStackable() && !IS_SET(item->GetAntiFlag(), ITEM_ANTIFLAG_STACK))
-	{
-		for (WORD i = 0; i < INVENTORY_MAX_NUM; ++i)
-		{
-			LPITEM item2 = GetInventoryItem(i);
-			if (!item2)
-				continue;
-
-			if (item2->GetVnum() != item->GetVnum())
-				continue;
-
-			BYTE j = 0;
-			for (; j < ITEM_SOCKET_MAX_NUM; ++j)
-				if (item2->GetSocket(j) != item->GetSocket(j))
-					break;
-
-			if (j != ITEM_SOCKET_MAX_NUM)
-				continue;
-
-			if (item2->GetCount() >= ITEM_MAX_COUNT)
-				continue;
-
-			WORD wCount = item->GetCount();
-			if (IS_SET(item->GetFlag(), ITEM_FLAG_MAKECOUNT))
-			{
-				if (wCount < item->GetValue(1))
-					wCount = item->GetValue(1);
-			}
-
-			WORD wCount2 = MIN(ITEM_MAX_COUNT - item2->GetCount(), wCount);
-			wCount -= wCount2;
-			item2->SetCount(item2->GetCount() + wCount2);
-
-			if (wCount == 0)
-			{
-				if (bMsg)
-#if defined(__CHATTING_WINDOW_RENEWAL__)
-#if defined(__SET_ITEM__)
-					ChatPacket(CHAT_TYPE_ITEM_INFO, LC_STRING(" ȹ: %s", LC_PRE_ITEM(item->GetItemSetValue(), item->GetVnum())));
+			item->AddToCharacter(this, TItemPos(INVENTORY, iEmptyCell), isHighLight);
 #else
-					ChatPacket(CHAT_TYPE_ITEM_INFO, LC_STRING(" ȹ: %s", LC_ITEM(item->GetVnum())));
+			item->AddToCharacter(this, TItemPos(INVENTORY, iEmptyCell));
 #endif
+		else if (item->IsGiftBox())
+#if defined(__WJ_PICKUP_ITEM_EFFECT__)
+			item->AddToCharacter(this, TItemPos(INVENTORY, iEmptyCell), isHighLight);
 #else
-#if defined(__SET_ITEM__)
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȹ: %s", LC_PRE_ITEM(item->GetItemSetValue(), item->GetVnum())));
-#else
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȹ: %s", LC_ITEM(item->GetVnum())));
-#endif
-#endif
-
-				M2_DESTROY_ITEM(item);
-
-				return;
-			}
-
-			item->SetCount(wCount);
-		}
-	}
+			item->AddToCharacter(this, TItemPos(INVENTORY, iEmptyCell));
 #endif
-
-	int cell;
-#if defined(__DRAGON_SOUL_SYSTEM__)
-	if (item->IsDragonSoul())
-	{
-		cell = GetEmptyDragonSoulInventory(item);
-	}
-	else
 #endif
-	{
-		cell = GetEmptyInventory(item->GetSize());
-	}
-
-	if (cell != -1)
-	{
-#if defined(__DRAGON_SOUL_SYSTEM__)
-		if (item->IsDragonSoul())
-			item->AddToCharacter(this, TItemPos(DRAGON_SOUL_INVENTORY, cell));
 		else
-#endif
 #if defined(__WJ_PICKUP_ITEM_EFFECT__)
-			item->AddToCharacter(this, TItemPos(INVENTORY, cell), isHighLight);
+			item->AddToCharacter(this, TItemPos(INVENTORY, iEmptyCell), isHighLight);
 #else
-			item->AddToCharacter(this, TItemPos(INVENTORY, cell));
+			item->AddToCharacter(this, TItemPos(INVENTORY, iEmptyCell));
 #endif
 
 		if (bMsg)
-#if defined(__CHATTING_WINDOW_RENEWAL__)
-#if defined(__SET_ITEM__)
-			ChatPacket(CHAT_TYPE_ITEM_INFO, LC_STRING(" ȹ: %s", LC_PRE_ITEM(item->GetItemSetValue(), item->GetVnum())));
-#else
-			ChatPacket(CHAT_TYPE_ITEM_INFO, LC_STRING(" ȹ: %s", LC_ITEM(item->GetVnum())));
-#endif
-#else
-#if defined(__SET_ITEM__)
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȹ: %s", LC_PRE_ITEM(item->GetItemSetValue(), item->GetVnum())));
-#else
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȹ: %s", LC_ITEM(item->GetVnum())));
-#endif
-#endif
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ȹ: %s"), item->GetLocaleName());
 
 		LogManager::instance().ItemLog(this, item, "SYSTEM", item->GetName());
 
@@ -10215,11 +10221,11 @@
 		{
 			TQuickslot* pSlot;
 
-			if (GetQuickslot(0, &pSlot) && pSlot->type == SLOT_TYPE_NONE)
+			if (GetQuickslot(0, &pSlot) && pSlot->type == QUICKSLOT_TYPE_NONE)
 			{
 				TQuickslot slot;
-				slot.type = SLOT_TYPE_INVENTORY;
-				slot.pos = cell;
+				slot.type = QUICKSLOT_TYPE_ITEM;
+				slot.pos = iEmptyCell;
 				SetQuickslot(0, slot);
 			}
 		}
@@ -10228,14 +10234,18 @@
 	{
 		item->AddToGround(GetMapIndex(), GetXYZ());
 		item->StartDestroyEvent();
-
-		if (longOwnerShip)
+		// Ƽ  flag ɷִ  ,
+		// κ    ¿   Ʈ Ǹ,
+		// ownership   (300) Ѵ.
+		if (IS_SET(item->GetAntiFlag(), ITEM_ANTIFLAG_DROP))
 			item->SetOwnership(this, 300);
 		else
 			item->SetOwnership(this, 60);
-
 		LogManager::instance().ItemLog(this, item, "SYSTEM_DROP", item->GetName());
 	}
+
+	sys_log(0, "7: %d %d", dwItemVnum, wCount);
+	return item;
 }
 
 bool CHARACTER::GiveItem(LPCHARACTER victim, TItemPos Cell)
@@ -10243,10 +10253,8 @@
 	if (!CanHandleItem())
 		return false;
 
-	if (IsRunningQuest())
-		return false;
-
 	LPITEM item = GetItem(Cell);
+
 	if (item && !item->IsExchanging())
 	{
 		if (victim->CanReceiveItem(this, item))
@@ -10272,182 +10280,161 @@
 #if defined(__SOUL_BIND_SYSTEM__)
 	if (item->IsSealed())
 	{
-		from->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot improve a soulbound item."));
+		from->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot improve a soulbound item."));
 		return false;
 	}
 #endif
 
 	switch (GetRaceNum())
 	{
-		case fishing::CAMPFIRE_MOB:
-		{
-			if (item->GetType() == ITEM_FISH &&
-				(item->GetSubType() == FISH_ALIVE || item->GetSubType() == FISH_DEAD))
-				return true;
-		}
+	case fishing::CAMPFIRE_MOB:
+		if (item->GetType() == ITEM_FISH &&
+			(item->GetSubType() == FISH_ALIVE || item->GetSubType() == FISH_DEAD))
+			return true;
 		break;
 
-		case fishing::FISHER_MOB:
-		{
-			if (item->GetType() == ITEM_ROD)
-				return true;
-		}
+	case fishing::FISHER_MOB:
+		if (item->GetType() == ITEM_ROD)
+			return true;
 		break;
 
 		// BUILDING_NPC
-		case BLACKSMITH_WEAPON_MOB:
-		case DEVILTOWER_BLACKSMITH_WEAPON_MOB:
-		{
-			if (item->GetType() == ITEM_WEAPON &&
-				item->GetRefinedVnum())
-				return true;
-			else
-				return false;
-		}
+	case BLACKSMITH_WEAPON_MOB:
+	case DEVILTOWER_BLACKSMITH_WEAPON_MOB:
+		if (item->GetType() == ITEM_WEAPON &&
+			item->GetRefinedVnum())
+			return true;
+		else
+			return false;
 		break;
 
-		case BLACKSMITH_ARMOR_MOB:
-		case DEVILTOWER_BLACKSMITH_ARMOR_MOB:
-		{
-			if (item->GetType() == ITEM_ARMOR &&
-				(item->GetSubType() == ARMOR_BODY || item->GetSubType() == ARMOR_SHIELD || item->GetSubType() == ARMOR_HEAD) &&
-				item->GetRefinedVnum())
-				return true;
-			else
-				return false;
-		}
+	case BLACKSMITH_ARMOR_MOB:
+	case DEVILTOWER_BLACKSMITH_ARMOR_MOB:
+		if (item->GetType() == ITEM_ARMOR &&
+			(item->GetSubType() == ARMOR_BODY || item->GetSubType() == ARMOR_SHIELD || item->GetSubType() == ARMOR_HEAD) &&
+			item->GetRefinedVnum())
+			return true;
+		else
+			return false;
 		break;
 
-		case BLACKSMITH_ACCESSORY_MOB:
-		case DEVILTOWER_BLACKSMITH_ACCESSORY_MOB:
-		{
-			if (item->GetType() == ITEM_ARMOR &&
-				!(item->GetSubType() == ARMOR_BODY || item->GetSubType() == ARMOR_SHIELD || item->GetSubType() == ARMOR_HEAD) &&
-				item->GetRefinedVnum())
-				return true;
-			else
-				return false;
-		}
+	case BLACKSMITH_ACCESSORY_MOB:
+	case DEVILTOWER_BLACKSMITH_ACCESSORY_MOB:
+		if (item->GetType() == ITEM_ARMOR &&
+			!(item->GetSubType() == ARMOR_BODY || item->GetSubType() == ARMOR_SHIELD || item->GetSubType() == ARMOR_HEAD) &&
+			item->GetRefinedVnum())
+			return true;
+		else
+			return false;
 		break;
 		// END_OF_BUILDING_NPC
 
-		case BLACKSMITH_MOB:
+	case BLACKSMITH_MOB:
+		if (item->GetRefinedVnum() && item->GetRefineSet() < 500)
 		{
-			if (item->GetRefinedVnum() && item->GetRefineSet() < 500)
-				return true;
-			else
-				return false;
+			return true;
 		}
-		break;
-
-		case BLACKSMITH2_MOB:
+		else
 		{
-			if (item->GetRefineSet() >= 500)
-				return true;
-			else
-				return false;
+			return false;
 		}
-		break;
 
-		case ALCHEMIST_MOB:
+	case BLACKSMITH2_MOB:
+		if (item->GetRefineSet() >= 500)
 		{
-			if (item->GetRefinedVnum())
-				return true;
+			return true;
 		}
+		else
+		{
+			return false;
+		}
+
+	case ALCHEMIST_MOB:
+		if (item->GetRefinedVnum())
+			return true;
 		break;
 
-		case 20101:
-		case 20102:
-		case 20103:
+	case 20101:
+	case 20102:
+	case 20103:
+		// ʱ 
+		if (item->GetVnum() == ITEM_REVIVE_HORSE_1)
 		{
-			// ʱ 
-			if (item->GetVnum() == ITEM_REVIVE_HORSE_1)
+			if (!IsDead())
 			{
-				if (!IsDead())
-				{
-					from->ChatPacket(CHAT_TYPE_INFO, LC_STRING("   ʸ   ϴ."));
-					return false;
-				}
-				return true;
-			}
-			else if (item->GetVnum() == ITEM_HORSE_FOOD_1)
-			{
-				if (IsDead())
-				{
-					from->ChatPacket(CHAT_TYPE_INFO, LC_STRING("  Ḧ   ϴ."));
-					return false;
-				}
-				return true;
+				from->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("   ʸ   ϴ."));
+				return false;
 			}
-			else if (item->GetVnum() == ITEM_HORSE_FOOD_2 || item->GetVnum() == ITEM_HORSE_FOOD_3)
+			return true;
+		}
+		else if (item->GetVnum() == ITEM_HORSE_FOOD_1)
+		{
+			if (IsDead())
 			{
+				from->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  Ḧ   ϴ."));
 				return false;
 			}
+			return true;
+		}
+		else if (item->GetVnum() == ITEM_HORSE_FOOD_2 || item->GetVnum() == ITEM_HORSE_FOOD_3)
+		{
+			return false;
 		}
 		break;
-
-		case 20104:
-		case 20105:
-		case 20106:
+	case 20104:
+	case 20105:
+	case 20106:
+		// ߱ 
+		if (item->GetVnum() == ITEM_REVIVE_HORSE_2)
 		{
-			// ߱ 
-			if (item->GetVnum() == ITEM_REVIVE_HORSE_2)
-			{
-				if (!IsDead())
-				{
-					from->ChatPacket(CHAT_TYPE_INFO, LC_STRING("   ʸ   ϴ."));
-					return false;
-				}
-				return true;
-			}
-			else if (item->GetVnum() == ITEM_HORSE_FOOD_2)
+			if (!IsDead())
 			{
-				if (IsDead())
-				{
-					from->ChatPacket(CHAT_TYPE_INFO, LC_STRING("  Ḧ   ϴ."));
-					return false;
-				}
-				return true;
+				from->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("   ʸ   ϴ."));
+				return false;
 			}
-			else if (item->GetVnum() == ITEM_HORSE_FOOD_1 || item->GetVnum() == ITEM_HORSE_FOOD_3)
+			return true;
+		}
+		else if (item->GetVnum() == ITEM_HORSE_FOOD_2)
+		{
+			if (IsDead())
 			{
+				from->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  Ḧ   ϴ."));
 				return false;
 			}
+			return true;
+		}
+		else if (item->GetVnum() == ITEM_HORSE_FOOD_1 || item->GetVnum() == ITEM_HORSE_FOOD_3)
+		{
+			return false;
 		}
 		break;
-
-		case 20107:
-		case 20108:
-		case 20109:
+	case 20107:
+	case 20108:
+	case 20109:
+		//  
+		if (item->GetVnum() == ITEM_REVIVE_HORSE_3)
 		{
-			//  
-			if (item->GetVnum() == ITEM_REVIVE_HORSE_3)
+			if (!IsDead())
 			{
-				if (!IsDead())
-				{
-					from->ChatPacket(CHAT_TYPE_INFO, LC_STRING("   ʸ   ϴ."));
-					return false;
-				}
-				return true;
-			}
-			else if (item->GetVnum() == ITEM_HORSE_FOOD_3)
-			{
-				if (IsDead())
-				{
-					from->ChatPacket(CHAT_TYPE_INFO, LC_STRING("  Ḧ   ϴ."));
-					return false;
-				}
-				return true;
+				from->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("   ʸ   ϴ."));
+				return false;
 			}
-			else if (item->GetVnum() == ITEM_HORSE_FOOD_1 || item->GetVnum() == ITEM_HORSE_FOOD_2)
+			return true;
+		}
+		else if (item->GetVnum() == ITEM_HORSE_FOOD_3)
+		{
+			if (IsDead())
 			{
+				from->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  Ḧ   ϴ."));
 				return false;
 			}
+			return true;
+		}
+		else if (item->GetVnum() == ITEM_HORSE_FOOD_1 || item->GetVnum() == ITEM_HORSE_FOOD_2)
+		{
+			return false;
 		}
 		break;
-
-		default:
-			break;
 	}
 
 	//if (IS_SET(item->GetFlag(), ITEM_FLAG_QUEST_GIVE))
@@ -10465,142 +10452,101 @@
 
 	switch (GetRaceNum())
 	{
-		case fishing::CAMPFIRE_MOB:
+	case fishing::CAMPFIRE_MOB:
+		if (item->GetType() == ITEM_FISH && (item->GetSubType() == FISH_ALIVE || item->GetSubType() == FISH_DEAD))
+			fishing::Grill(from, item);
+		else
 		{
-			if (item->GetType() == ITEM_FISH && (item->GetSubType() == FISH_ALIVE || item->GetSubType() == FISH_DEAD))
-				fishing::Grill(from, item);
-			else
-			{
-				// TAKE_ITEM_BUG_FIX
-				from->SetQuestNPCID(GetVID());
-				// END_OF_TAKE_ITEM_BUG_FIX
-				quest::CQuestManager::instance().TakeItem(from->GetPlayerID(), GetRaceNum(), item);
-			}
+			// TAKE_ITEM_BUG_FIX
+			from->SetQuestNPCID(GetVID());
+			// END_OF_TAKE_ITEM_BUG_FIX
+			quest::CQuestManager::instance().TakeItem(from->GetPlayerID(), GetRaceNum(), item);
 		}
 		break;
 
-#ifdef ENABLE_QUEEN_NETHIS
-		case SnakeLair::PILAR_STEP_4:
-			{
-				if(from->IsPC())
-				{
-					if (SnakeLair::CSnk::instance().IsSnakeMap(from->GetMapIndex()))
-						SnakeLair::CSnk::instance().OnKillPilar(item, from, this);
-				}
-			}
-			break;
-		case SnakeLair::BLACKSMITH_5:
-			{
-				if(from->IsPC())
-				{
-					if (SnakeLair::CSnk::instance().IsSnakeMap(from->GetMapIndex()))
-						SnakeLair::CSnk::instance().OnKillBlackSmith(item, from, this);
-				}
-			}
-			break;
-
-		case SnakeLair::SNAKE_STATUE1:
-		case SnakeLair::SNAKE_STATUE2:
-		case SnakeLair::SNAKE_STATUE3:
-		case SnakeLair::SNAKE_STATUE4:
-			{
-				if(from->IsPC())
-				{
-					if (SnakeLair::CSnk::instance().IsSnakeMap(from->GetMapIndex()))
-						SnakeLair::CSnk::instance().OnStatueSetRotation(item, from, this);
-				}
-			}
-			break;
+#if defined(__GUILD_DRAGONLAIR__)
+	case MeleyLair::STATUE_VNUM:
+	{
+		if (MeleyLair::CMgr::instance().IsMeleyMap(from->GetMapIndex()))
+			MeleyLair::CMgr::instance().OnKillStatue(item, from, this, from->GetGuild());
+	}
+	break;
 #endif
 
-		// DEVILTOWER_NPC
-		case DEVILTOWER_BLACKSMITH_WEAPON_MOB:
-		case DEVILTOWER_BLACKSMITH_ARMOR_MOB:
-		case DEVILTOWER_BLACKSMITH_ACCESSORY_MOB:
+	// DEVILTOWER_NPC
+	case DEVILTOWER_BLACKSMITH_WEAPON_MOB:
+	case DEVILTOWER_BLACKSMITH_ARMOR_MOB:
+	case DEVILTOWER_BLACKSMITH_ACCESSORY_MOB:
+		if (item->GetRefinedVnum() != 0 && item->GetRefineSet() != 0 && item->GetRefineSet() < 500)
 		{
-			if (item->GetRefinedVnum() != 0 && item->GetRefineSet() != 0 && item->GetRefineSet() < 500)
-			{
-				from->SetRefineNPC(this);
-				from->RefineInformation(item->GetCell(), REFINE_TYPE_MONEY_ONLY);
-			}
-			else
-			{
-				from->ChatPacket(CHAT_TYPE_INFO, LC_STRING("    ϴ."));
-			}
+#if defined(__SOUL_SYSTEM__)
+			if (item->GetType() == ITEM_SOUL)
+				return;
+#endif
+			from->SetRefineNPC(this);
+			from->RefineInformation(item->GetCell(), REFINE_TYPE_MONEY_ONLY);
+		}
+		else
+		{
+			from->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("    ϴ."));
 		}
 		break;
 		// END_OF_DEVILTOWER_NPC
 
-		case BLACKSMITH_MOB:
-		case BLACKSMITH2_MOB:
-		case BLACKSMITH_WEAPON_MOB:
-		case BLACKSMITH_ARMOR_MOB:
-		case BLACKSMITH_ACCESSORY_MOB:
+	case BLACKSMITH_MOB:
+	case BLACKSMITH2_MOB:
+	case BLACKSMITH_WEAPON_MOB:
+	case BLACKSMITH_ARMOR_MOB:
+	case BLACKSMITH_ACCESSORY_MOB:
+		if (item->GetRefinedVnum())
 		{
-			if (item->GetRefinedVnum())
-			{
-				from->SetRefineNPC(this);
-				from->RefineInformation(item->GetCell(), REFINE_TYPE_NORMAL);
-			}
-			else
-			{
-				from->ChatPacket(CHAT_TYPE_INFO, LC_STRING("    ϴ."));
-			}
+#if defined(__SOUL_SYSTEM__)
+			if (item->GetType() == ITEM_SOUL)
+				return;
+#endif
+			from->SetRefineNPC(this);
+			from->RefineInformation(item->GetCell(), REFINE_TYPE_NORMAL);
 		}
-		break;
-
-		case 20101:
-		case 20102:
-		case 20103:
-		case 20104:
-		case 20105:
-		case 20106:
-		case 20107:
-		case 20108:
-		case 20109:
+		else
 		{
-			if (item->GetVnum() == ITEM_REVIVE_HORSE_1 ||
-				item->GetVnum() == ITEM_REVIVE_HORSE_2 ||
-				item->GetVnum() == ITEM_REVIVE_HORSE_3)
-			{
-				from->ReviveHorse();
-				item->SetCount(item->GetCount() - 1);
-				from->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ʸ ־ϴ."));
-			}
-			else if (item->GetVnum() == ITEM_HORSE_FOOD_1 ||
-				item->GetVnum() == ITEM_HORSE_FOOD_2 ||
-				item->GetVnum() == ITEM_HORSE_FOOD_3)
-			{
-				from->FeedHorse();
-				from->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" Ḧ ־ϴ."));
-				item->SetCount(item->GetCount() - 1);
-				EffectPacket(SE_HPUP_RED);
-			}
+			from->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("    ϴ."));
 		}
 		break;
 
-		default:
+	case 20101:
+	case 20102:
+	case 20103:
+	case 20104:
+	case 20105:
+	case 20106:
+	case 20107:
+	case 20108:
+	case 20109:
+		if (item->GetVnum() == ITEM_REVIVE_HORSE_1 ||
+			item->GetVnum() == ITEM_REVIVE_HORSE_2 ||
+			item->GetVnum() == ITEM_REVIVE_HORSE_3)
 		{
-			sys_log(0, "TakeItem %s %d %s", from->GetName(), GetRaceNum(), item->GetName());
-			from->SetQuestNPCID(GetVID());
-			quest::CQuestManager::instance().TakeItem(from->GetPlayerID(), GetRaceNum(), item);
+			from->ReviveHorse();
+			item->SetCount(item->GetCount() - 1);
+			from->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ʸ ־ϴ."));
 		}
-		break;
-	}
-
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-	if (CGuildDragonLairManager::Instance().IsRedDragonLair(from->GetMapIndex())
-		&& CGuildDragonLairManager::Instance().IsStone(GetRaceNum()))
-	{
-		if (item->GetVnum() == ITEM_GUILD_DRAGONLAIR_RING)
+		else if (item->GetVnum() == ITEM_HORSE_FOOD_1 ||
+			item->GetVnum() == ITEM_HORSE_FOOD_2 ||
+			item->GetVnum() == ITEM_HORSE_FOOD_3)
 		{
-			sys_log(0, "GuildDragonLair TakeItem %s %d %s", from->GetName(), GetRaceNum(), item->GetName());
-
-			if (from->GetGuildDragonLair())
-				from->GetGuildDragonLair()->TakeItem(from, this, item);
+			from->FeedHorse();
+			from->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" Ḧ ־ϴ."));
+			item->SetCount(item->GetCount() - 1);
+			EffectPacket(SE_HPUP_RED);
 		}
+		break;
+
+	default:
+		sys_log(0, "TakeItem %s %d %s", from->GetName(), GetRaceNum(), item->GetName());
+		from->SetQuestNPCID(GetVID());
+		quest::CQuestManager::instance().TakeItem(from->GetPlayerID(), GetRaceNum(), item);
+		break;
 	}
-#endif
 }
 
 bool CHARACTER::IsEquipUniqueItem(DWORD dwItemVnum) const
@@ -10619,6 +10565,10 @@
 			return true;
 	}
 
+	//   (ߺ)  üũѴ.
+	if (dwItemVnum == UNIQUE_ITEM_RING_OF_LANGUAGE)
+		return IsEquipUniqueItem(UNIQUE_ITEM_RING_OF_LANGUAGE_SAMPLE);
+
 	return false;
 }
 
@@ -10646,18 +10596,17 @@
 void CHARACTER::SetRefineMode(int iAdditionalCell)
 {
 	m_iRefineAdditionalCell = iAdditionalCell;
-	SetUnderRefine(true);
+	m_bUnderRefine = true;
 }
 
 void CHARACTER::ClearRefineMode()
 {
-	SetUnderRefine(false);
+	m_bUnderRefine = false;
 	SetRefineNPC(NULL);
 }
 
-//bool CHARACTER::GiveItemFromSpecialItemGroup(DWORD dwGroupNum, std::vector<DWORD>& dwItemVnums,
-//	std::vector<DWORD>& dwItemCounts, std::vector <LPITEM>& item_gets, int& count)
-bool CHARACTER::GiveItemFromSpecialItemGroup(DWORD dwGroupNum)
+bool CHARACTER::GiveItemFromSpecialItemGroup(DWORD dwGroupNum, std::vector<DWORD>& dwItemVnums,
+	std::vector<DWORD>& dwItemCounts, std::vector <LPITEM>& item_gets, int& count)
 {
 	const CSpecialItemGroup* pGroup = ITEM_MANAGER::instance().GetSpecialItemGroup(dwGroupNum);
 
@@ -10667,7 +10616,7 @@
 		return false;
 	}
 
-	std::vector<int> idxes;
+	std::vector <int> idxes;
 	int n = pGroup->GetMultiIndex(idxes);
 
 	bool bSuccess = false;
@@ -10682,111 +10631,110 @@
 		LPITEM item_get = NULL;
 		switch (dwVnum)
 		{
-			case CSpecialItemGroup::GOLD:
-			{
-				PointChange(POINT_GOLD, dwCount, true);
-				LogManager::instance().CharLog(this, dwCount, "TREASURE_GOLD", "");
-				bSuccess = true;
-			}
-			break;
+		case CSpecialItemGroup::GOLD:
+		{
+			PointChange(POINT_GOLD, dwCount);
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" %d  ȹ߽ϴ."), dwCount);
+			LogManager::instance().CharLog(this, dwCount, "TREASURE_GOLD", "");
+			bSuccess = true;
+		}
+		break;
 
-			case CSpecialItemGroup::EXP:
-			{
-				PointChange(POINT_EXP, dwCount);
-				LogManager::instance().CharLog(this, dwCount, "TREASURE_EXP", "");
-				bSuccess = true;
-			}
-			break;
+		case CSpecialItemGroup::EXP:
+		{
+			PointChange(POINT_EXP, dwCount);
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%d ġ ȹ߽ϴ."), dwCount);
+			LogManager::instance().CharLog(this, dwCount, "TREASURE_EXP", "");
+			bSuccess = true;
+		}
+		break;
 
-			case CSpecialItemGroup::MOB:
-			{
-				sys_log(0, "CSpecialItemGroup::MOB %d", dwCount);
-				int x = GetX() + number(-500, 500);
-				int y = GetY() + number(-500, 500);
+		case CSpecialItemGroup::MOB:
+		{
+			sys_log(0, "CSpecialItemGroup::MOB %d", dwCount);
+			int x = GetX() + number(-500, 500);
+			int y = GetY() + number(-500, 500);
 
-				LPCHARACTER ch = CHARACTER_MANAGER::instance().SpawnMob(dwCount, GetMapIndex(), x, y, 0, true, -1);
-				if (ch)
-					ch->SetAggressive();
-				else
-				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("This doesn't seem to work here."));
-					return false;
-				}
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("ڿ Ͱ Ÿϴ!"));
-				bSuccess = true;
-			}
-			break;
+			LPCHARACTER ch = CHARACTER_MANAGER::instance().SpawnMob(dwCount, GetMapIndex(), x, y, 0, true, -1);
+			if (ch)
+				ch->SetAggressive();
 
-			case CSpecialItemGroup::SLOW:
-			{
-				sys_log(0, "CSpecialItemGroup::SLOW %d", -(int)dwCount);
-				AddAffect(AFFECT_SLOW, POINT_MOV_SPEED, -(int)dwCount, AFF_SLOW, 300, 0, true);
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("ڿ   ⸦ ̸ ̴ ӵ ϴ!"));
-				bSuccess = true;
-			}
-			break;
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ Ͱ Ÿϴ!"));
+			bSuccess = true;
+		}
+		break;
 
-			case CSpecialItemGroup::DRAIN_HP:
-			{
-				int iDropHP = GetMaxHP() * dwCount / 100;
-				sys_log(0, "CSpecialItemGroup::DRAIN_HP %d", -iDropHP);
-				iDropHP = MIN(iDropHP, GetHP() - 1);
-				sys_log(0, "CSpecialItemGroup::DRAIN_HP %d", -iDropHP);
-				PointChange(POINT_HP, -iDropHP);
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("ڰ ڱ Ͽϴ!  ߽ϴ."));
-				bSuccess = true;
-			}
-			break;
+		case CSpecialItemGroup::SLOW:
+		{
+			sys_log(0, "CSpecialItemGroup::SLOW %d", -(int)dwCount);
+			AddAffect(AFFECT_SLOW, POINT_MOV_SPEED, -(int)dwCount, AFF_SLOW, 300, 0, true);
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ   ⸦ ̸ ̴ ӵ ϴ!"));
+			bSuccess = true;
+		}
+		break;
 
-			case CSpecialItemGroup::POISON:
-			{
-				AttackedByPoison(NULL);
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("ڿ   ⸦ ̸  ¸ ϴ!"));
-				bSuccess = true;
-			}
-			break;
+		case CSpecialItemGroup::DRAIN_HP:
+		{
+			int iDropHP = GetMaxHP() * dwCount / 100;
+			sys_log(0, "CSpecialItemGroup::DRAIN_HP %d", -iDropHP);
+			iDropHP = MIN(iDropHP, GetHP() - 1);
+			sys_log(0, "CSpecialItemGroup::DRAIN_HP %d", -iDropHP);
+			PointChange(POINT_HP, -iDropHP);
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڰ ڱ Ͽϴ!  ߽ϴ."));
+			bSuccess = true;
+		}
+		break;
 
-			case CSpecialItemGroup::BLEEDING:
-			{
-				AttackedByBleeding(NULL);
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("ڿ   ⸦ ̸ ̴ ӵ ϴ!"));
-				bSuccess = true;
-			}
-			break;
+		case CSpecialItemGroup::POISON:
+		{
+			AttackedByPoison(NULL);
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ   ⸦ ̸  ¸ ϴ!"));
+			bSuccess = true;
+		}
+		break;
 
-			case CSpecialItemGroup::MOB_GROUP:
-			{
-				int sx = GetX() - number(300, 500);
-				int sy = GetY() - number(300, 500);
-				int ex = GetX() + number(300, 500);
-				int ey = GetY() + number(300, 500);
-				LPCHARACTER ch = CHARACTER_MANAGER::instance().SpawnGroup(dwCount, GetMapIndex(), sx, sy, ex, ey, NULL, true);
-				if (!ch)
-				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("This doesn't seem to work here."));
-					return false;
-				}
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("ڿ Ͱ Ÿϴ!"));
-				bSuccess = true;
-			}
-			break;
+		case CSpecialItemGroup::BLEEDING:
+		{
+			AttackedByBleeding(NULL);
+			bSuccess = true;
+		}
+		break;
 
-			default:
-			{
+		case CSpecialItemGroup::MOB_GROUP:
+		{
+			int sx = GetX() - number(300, 500);
+			int sy = GetY() - number(300, 500);
+			int ex = GetX() + number(300, 500);
+			int ey = GetY() + number(300, 500);
+			CHARACTER_MANAGER::instance().SpawnGroup(dwCount, GetMapIndex(), sx, sy, ex, ey, NULL, true);
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڿ Ͱ Ÿϴ!"));
+			bSuccess = true;
+		}
+		break;
+
+		default:
+		{
 #if defined(__WJ_PICKUP_ITEM_EFFECT__)
-				item_get = AutoGiveItem(dwVnum, dwCount, iRarePct, true, true);
+			item_get = AutoGiveItem(dwVnum, dwCount, iRarePct, true, true);
 #else
-				item_get = AutoGiveItem(dwVnum, dwCount, iRarePct);
+			item_get = AutoGiveItem(dwVnum, dwCount, iRarePct);
 #endif
-				if (item_get)
-					bSuccess = true;
-			}
-			break;
+			if (item_get)
+				bSuccess = true;
+		}
+		break;
 		}
 
-		if (!bSuccess)
+		if (bSuccess)
+		{
+			dwItemVnums.push_back(dwVnum);
+			dwItemCounts.push_back(dwCount);
+			item_gets.push_back(item_get);
+			count++;
+		}
+		else
 		{
-			ChatPacket(CHAT_TYPE_TALKING, LC_STRING("ƹ͵   ϴ."));
+			ChatPacket(CHAT_TYPE_TALKING, LC_TEXT("ƹ͵   ϴ."));
 			return false;
 		}
 	}
@@ -10799,7 +10747,7 @@
 	if (item->CheckItemUseLevel(GetLevel()) == false)
 	{
 		//  ѿ ɸ
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("  Ӹ    Դϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  Ӹ    Դϴ."));
 		return false;
 	}
 
@@ -10807,33 +10755,33 @@
 
 	switch (GetJob())
 	{
-		case JOB_WARRIOR:
-			hair -= 72000; // 73001 - 72000 = 1001   ȣ 
-			break;
+	case JOB_WARRIOR:
+		hair -= 72000; // 73001 - 72000 = 1001   ȣ 
+		break;
 
-		case JOB_ASSASSIN:
-			hair -= 71250;
-			break;
+	case JOB_ASSASSIN:
+		hair -= 71250;
+		break;
 
-		case JOB_SURA:
-			hair -= 70500;
-			break;
+	case JOB_SURA:
+		hair -= 70500;
+		break;
 
-		case JOB_SHAMAN:
-			hair -= 69750;
-			break;
+	case JOB_SHAMAN:
+		hair -= 69750;
+		break;
 
-		case JOB_WOLFMAN:
-			break;
+	case JOB_WOLFMAN:
+		break;
 
-		default:
-			return false;
-			break;
+	default:
+		return false;
+		break;
 	}
 
 	if (hair == GetPart(PART_HAIR))
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING(" Ӹ ŸϷδ ü  ϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" Ӹ ŸϷδ ü  ϴ."));
 		return true;
 	}
 
@@ -10850,13 +10798,13 @@
 {
 	if (IsPolymorphed())
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("̹ а Դϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ а Դϴ."));
 		return false;
 	}
 
 	if (true == IsRiding())
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("а   Դϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("а   Դϴ."));
 		return false;
 	}
 
@@ -10864,7 +10812,7 @@
 
 	if (dwVnum == 0)
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("߸ а Դϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("߸ а Դϴ."));
 		item->SetCount(item->GetCount() - 1);
 		return false;
 	}
@@ -10873,73 +10821,73 @@
 
 	if (pMob == NULL)
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("߸ а Դϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("߸ а Դϴ."));
 		item->SetCount(item->GetCount() - 1);
 		return false;
 	}
 
 	switch (item->GetVnum())
 	{
-		case 70104: // Polymorph Marble
-		case 70105: // Polymorph Marble
-		case 70106: // Polymorph Marble
-		case 70107: // Polymorph Marble
-		case 71093: // Polymorph Marble
-		{
-			// а ó
-			sys_log(0, "USE_POLYMORPH_BALL PID(%d) vnum(%d)", GetPlayerID(), dwVnum);
+	case 70104:
+	case 70105:
+	case 70106:
+	case 70107:
+	case 71093:
+	{
+		// а ó
+		sys_log(0, "USE_POLYMORPH_BALL PID(%d) vnum(%d)", GetPlayerID(), dwVnum);
 
-			//   üũ
-			int iPolymorphLevelLimit = MAX(0, 20 - GetLevel() * 3 / 10);
-			if (pMob->m_table.bLevel >= GetLevel() + iPolymorphLevelLimit)
-			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ʹ   ͷδ    ϴ."));
-				return false;
-			}
+		//   üũ
+		int iPolymorphLevelLimit = MAX(0, 20 - GetLevel() * 3 / 10);
+		if (pMob->m_table.bLevel >= GetLevel() + iPolymorphLevelLimit)
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ʹ   ͷδ    ϴ."));
+			return false;
+		}
 
-			int iDuration = GetSkillLevel(POLYMORPH_SKILL_ID) == 0 ? 5 : (5 + (5 + GetSkillLevel(POLYMORPH_SKILL_ID) / 40 * 25));
-			iDuration *= 60;
+		int iDuration = GetSkillLevel(POLYMORPH_SKILL_ID) == 0 ? 5 : (5 + (5 + GetSkillLevel(POLYMORPH_SKILL_ID) / 40 * 25));
+		iDuration *= 60;
 
-			DWORD dwBonus = 0;
+		DWORD dwBonus = 0;
 
-			if (true == LC_IsYMIR() || true == LC_IsKorea())
-			{
-				dwBonus = GetSkillLevel(POLYMORPH_SKILL_ID) + 60;
-			}
-			else
-			{
-				dwBonus = (2 + GetSkillLevel(POLYMORPH_SKILL_ID) / 40) * 100;
-			}
+		if (true == LC_IsYMIR() || true == LC_IsKorea())
+		{
+			dwBonus = GetSkillLevel(POLYMORPH_SKILL_ID) + 60;
+		}
+		else
+		{
+			dwBonus = (2 + GetSkillLevel(POLYMORPH_SKILL_ID) / 40) * 100;
+		}
 
-			AddAffect(AFFECT_POLYMORPH, POINT_POLYMORPH, dwVnum, AFF_POLYMORPH, iDuration, 0, true);
-			AddAffect(AFFECT_POLYMORPH, POINT_ATT_BONUS, dwBonus, AFF_POLYMORPH, iDuration, 0, false);
+		AddAffect(AFFECT_POLYMORPH, POINT_POLYMORPH, dwVnum, AFF_POLYMORPH, iDuration, 0, true);
+		AddAffect(AFFECT_POLYMORPH, POINT_ATT_BONUS, dwBonus, AFF_POLYMORPH, iDuration, 0, false);
 
-			item->SetCount(item->GetCount() - 1);
-		}
-		break;
+		item->SetCount(item->GetCount() - 1);
+	}
+	break;
 
-		case 50322: // Transformation Role
-		{
-			// 
+	case 50322:
+	{
+		// 
 
-			// а ó
-			// 0 1 2
-			// а  ȣ  а 
-			sys_log(0, "USE_POLYMORPH_BOOK: %s(%u) vnum(%u)", GetName(), GetPlayerID(), dwVnum);
+		// а ó
+		// 0 1 2
+		// а  ȣ  а 
+		sys_log(0, "USE_POLYMORPH_BOOK: %s(%u) vnum(%u)", GetName(), GetPlayerID(), dwVnum);
 
-			if (CPolymorphUtils::instance().PolymorphCharacter(this, item, pMob) == true)
-			{
-				CPolymorphUtils::instance().UpdateBookPracticeGrade(this, item);
-			}
-			else
-			{
-			}
+		if (CPolymorphUtils::instance().PolymorphCharacter(this, item, pMob) == true)
+		{
+			CPolymorphUtils::instance().UpdateBookPracticeGrade(this, item);
 		}
-		break;
+		else
+		{
+		}
+	}
+	break;
 
-		default:
-			sys_err("POLYMORPH invalid item passed PID(%d) vnum(%d)", GetPlayerID(), item->GetOriginalVnum());
-			return false;
+	default:
+		sys_err("POLYMORPH invalid item passed PID(%d) vnum(%d)", GetPlayerID(), item->GetOriginalVnum());
+		return false;
 	}
 
 	return true;
@@ -10950,28 +10898,34 @@
 	if (m_bIsObserver) return false;
 	if (GetShop()) return false;
 	if (GetMyShop()) return false;
-	if (IsUnderRefine()) return false;
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	if (IsUnderRefineElement()) return false;
-#endif
+	if (m_bUnderRefine) return false;
 	if (IsWarping()) return false;
-#if defined(__ACCE_COSTUME_SYSTEM__)
-	if (IsAcceRefineWindowOpen()) return false;
-#endif
-#if defined(__AURA_COSTUME_SYSTEM__)
+#ifdef __AURA_SYSTEM__
 	if (IsAuraRefineWindowOpen()) return false;
 #endif
 
 	return true;
 }
 
+#if defined(__MOUNT_COSTUME_SYSTEM__)
+bool CHARACTER::UnEquipSpecialRideUniqueItem(bool bIsOnDeath)
+#else
 bool CHARACTER::UnEquipSpecialRideUniqueItem()
+#endif
 {
+#if defined(__MOUNT_COSTUME_SYSTEM__)
+	LPITEM pCostumeMount = GetWear(WEAR_COSTUME_MOUNT);
+
+	if (NULL != pCostumeMount)
+	{
+		if (pCostumeMount->IsCostumeMount())
+		{
+			return UnequipItem(pCostumeMount);
+		}
+	}
+#else
 	LPITEM Unique1 = GetWear(WEAR_UNIQUE1);
 	LPITEM Unique2 = GetWear(WEAR_UNIQUE2);
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-	LPITEM MountCostume = GetWear(WEAR_COSTUME_MOUNT);
-#endif
 
 	if (NULL != Unique1)
 	{
@@ -10988,10 +10942,6 @@
 			return UnequipItem(Unique2);
 		}
 	}
-
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-	if (MountCostume)
-		return UnequipItem(MountCostume);
 #endif
 
 	return true;
@@ -11031,7 +10981,7 @@
 	{
 		LPITEM pItem = FindItemByID(pAffect->dwFlag);
 
-		if ((NULL != pItem) && (pItem->GetSocket(0) > 0))
+		if (NULL != pItem && true == pItem->GetSocket(0))
 		{
 			if (false == CArenaManager::instance().IsArenaMap(GetMapIndex()))
 			{
@@ -11069,21 +11019,6 @@
 					{
 						amount = avail;
 
-#if defined(__USE_NEXT_AUTO_POTION__)
-						for (WORD wCell = 0; wCell < INVENTORY_MAX_NUM; ++wCell)
-						{
-							LPITEM pkNextItem = GetInventoryItem(wCell);
-							if (NULL == pkNextItem)
-								continue;
-
-							if (pItem->GetWindow() == pkNextItem->GetWindow() && pItem->GetCell() != pkNextItem->GetCell())
-							{
-								UseItemEx(pkNextItem, TItemPos(INVENTORY, wCell));
-								break;
-							}
-						}
-#endif
-
 						ITEM_MANAGER::instance().RemoveItem(pItem);
 					}
 
@@ -11120,81 +11055,86 @@
 
 	switch (window_type)
 	{
-		case INVENTORY:
-			return cell < INVENTORY_MAX_NUM;
-
-		case EQUIPMENT:
-			return cell < EQUIPMENT_MAX_NUM;
-
-#if defined(__DRAGON_SOUL_SYSTEM__)
-		case DRAGON_SOUL_INVENTORY:
-			return cell < DRAGON_SOUL_INVENTORY_MAX_NUM;
-#endif
+	case RESERVED_WINDOW:
+		return false;
 
-		case BELT_INVENTORY:
-			return cell < BELT_INVENTORY_MAX_NUM;
+	case INVENTORY:
+	case EQUIPMENT:
+		return cell < (INVENTORY_AND_EQUIP_SLOT_MAX);
 
-		case SAFEBOX:
-			if (NULL != m_pkSafebox)
-				return m_pkSafebox->IsValidPosition(cell);
-			else
-				return false;
+	case DRAGON_SOUL_INVENTORY:
+		return cell < (DRAGON_SOUL_INVENTORY_MAX_NUM);
 
-		case MALL:
-			if (NULL != m_pkMall)
-				return m_pkMall->IsValidPosition(cell);
-			else
-				return false;
-
-#if defined(__ATTR_6TH_7TH__)
-		case NPC_STORAGE:
-			return cell < NPC_STORAGE_SLOT_MAX;
-#endif
+	case SAFEBOX:
+		if (NULL != m_pkSafebox)
+			return m_pkSafebox->IsValidPosition(cell);
+		else
+			return false;
 
-		default:
+	case MALL:
+		if (NULL != m_pkMall)
+			return m_pkMall->IsValidPosition(cell);
+		else
 			return false;
+
+	default:
+		return false;
 	}
 }
 
 ///  ĳ ¸  ־ item   ִ  Ȯϰ, Ұ ϴٸ ĳͿ  ˷ִ Լ
 bool CHARACTER::CanEquipNow(const LPITEM item, const TItemPos& srcCell, const TItemPos& destCell) /*const*/
 {
-	if (IsFishing())
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot carry out this action while fishing."));
-		return false;
-	}
-
 	const TItemTable* itemTable = item->GetProto();
 	//BYTE itemType = item->GetType();
 	//BYTE itemSubType = item->GetSubType();
 
+#if defined(__MOUNT_COSTUME_SYSTEM__)
+	if (IS_BLOCKED_MOUNT_SUMMON_MAP(GetMapIndex()))
+	{
+		if (item->IsCostumeMount() || item->IsPet())
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot summon your mount/pet right now."));
+			return false;
+		}
+	}
+
+	if (IS_BLOCKED_MOUNT_DUNGEON_MAP(GetMapIndex()))
+	{
+		if (item->IsCostumeMount() || item->IsPet())
+		{
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot summon your mount/pet right now."));
+			return false;
+		}
+	}
+#endif
+
 	switch (GetJob())
 	{
-		case JOB_WARRIOR:
-			if (item->GetAntiFlag() & ITEM_ANTIFLAG_WARRIOR)
-				return false;
-			break;
+	case JOB_WARRIOR:
+		if (item->GetAntiFlag() & ITEM_ANTIFLAG_WARRIOR)
+			return false;
+		break;
 
-		case JOB_ASSASSIN:
-			if (item->GetAntiFlag() & ITEM_ANTIFLAG_ASSASSIN)
-				return false;
-			break;
+	case JOB_ASSASSIN:
+		if (item->GetAntiFlag() & ITEM_ANTIFLAG_ASSASSIN)
+			return false;
+		break;
 
-		case JOB_SHAMAN:
-			if (item->GetAntiFlag() & ITEM_ANTIFLAG_SHAMAN)
-				return false;
-			break;
+	case JOB_SHAMAN:
+		if (item->GetAntiFlag() & ITEM_ANTIFLAG_SHAMAN)
+			return false;
+		break;
 
-		case JOB_SURA:
-			if (item->GetAntiFlag() & ITEM_ANTIFLAG_SURA)
-				return false;
-			break;
+	case JOB_SURA:
+		if (item->GetAntiFlag() & ITEM_ANTIFLAG_SURA)
+			return false;
+		break;
 
-		case JOB_WOLFMAN:
-			if (item->GetAntiFlag() & ITEM_ANTIFLAG_WOLFMAN)
-				return false;
-			break;
+	case JOB_WOLFMAN:
+		if (item->GetAntiFlag() & ITEM_ANTIFLAG_WOLFMAN)
+			return false;
+		break;
 
 	}
 
@@ -11203,65 +11143,43 @@
 		long limit = itemTable->aLimits[i].lValue;
 		switch (itemTable->aLimits[i].bType)
 		{
-			case LIMIT_LEVEL:
-			{
-				if (GetLevel() < limit)
-				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("    ϴ."));
-					return false;
-				}
-			}
-			break;
-
-#if defined(__CONQUEROR_LEVEL__)
-			case LIMIT_NEWWORLD_LEVEL:
+		case LIMIT_LEVEL:
+			if (GetLevel() < limit)
 			{
-				if (GetConquerorLevel() < limit)
-				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("    ϴ."));
-					return false;
-				}
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("    ϴ."));
+				return false;
 			}
 			break;
-#endif
 
-			case LIMIT_STR:
+		case LIMIT_STR:
+			if (GetPoint(POINT_ST) < limit)
 			{
-				if (GetPoint(POINT_ST) < limit)
-				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("ٷ    ϴ."));
-					return false;
-				}
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ٷ    ϴ."));
+				return false;
 			}
 			break;
 
-			case LIMIT_INT:
+		case LIMIT_INT:
+			if (GetPoint(POINT_IQ) < limit)
 			{
-				if (GetPoint(POINT_IQ) < limit)
-				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("    ϴ."));
-					return false;
-				}
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("    ϴ."));
+				return false;
 			}
 			break;
 
-			case LIMIT_DEX:
+		case LIMIT_DEX:
+			if (GetPoint(POINT_DX) < limit)
 			{
-				if (GetPoint(POINT_DX) < limit)
-				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("ø    ϴ."));
-					return false;
-				}
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ø    ϴ."));
+				return false;
 			}
 			break;
 
-			case LIMIT_CON:
+		case LIMIT_CON:
+			if (GetPoint(POINT_HT) < limit)
 			{
-				if (GetPoint(POINT_HT) < limit)
-				{
-					ChatPacket(CHAT_TYPE_INFO, LC_STRING("ü    ϴ."));
-					return false;
-				}
+				ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ü    ϴ."));
+				return false;
 			}
 			break;
 		}
@@ -11272,33 +11190,18 @@
 		if ((GetWear(WEAR_UNIQUE1) && GetWear(WEAR_UNIQUE1)->IsSameSpecialGroup(item)) ||
 			(GetWear(WEAR_UNIQUE2) && GetWear(WEAR_UNIQUE2)->IsSameSpecialGroup(item)))
 		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("  ũ    ÿ   ϴ."));
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ũ    ÿ   ϴ."));
 			return false;
 		}
 
 		if (marriage::CManager::instance().IsMarriageUniqueItem(item->GetVnum()) &&
 			!marriage::CManager::instance().IsMarried(GetPlayerID()))
 		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("ȥ  ¿    ϴ."));
+			ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ȥ  ¿    ϴ."));
 			return false;
 		}
-	}
-
-#if defined(__PET_SYSTEM__)
-	if (item->IsPet() && SECTREE_MANAGER::Instance().IsBlockFilterMapIndex(SECTREE_MANAGER::PET_BLOCK_MAP_INDEX, GetMapIndex()))
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot summon your mount/pet right now."));
-		return false;
-	}
-#endif
 
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-	if (item->IsCostumeMount() && SECTREE_MANAGER::Instance().IsBlockFilterMapIndex(SECTREE_MANAGER::MOUNT_BLOCK_MAP_INDEX, GetMapIndex()))
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot summon your mount/pet right now."));
-		return false;
 	}
-#endif
 
 	return true;
 }
@@ -11307,1006 +11210,139 @@
 bool CHARACTER::CanUnequipNow(const LPITEM item, const TItemPos& srcCell, const TItemPos& destCell) /*const*/
 //bool CHARACTER::CanUnequipNow(const LPITEM item, const TItemPos& swapCell) /*const*/
 {
-	if (item->IsBelt())
-	{
-		if (CBeltInventoryHelper::IsExistItemInBeltInventory(this))
-		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("You can only discard the belt when there are no longer any items in its inventory."));
-			return false;
-		}
-	}
-
+#ifdef __AURA_SYSTEM__
+	if (IsAuraRefineWindowOpen())
+		return false;
+#endif
 	//     
 	if (IS_SET(item->GetFlag(), ITEM_FLAG_IRREMOVABLE))
 		return false;
 
-	if (IsFishing())
+	//< 2019.05.09.Owsap Remove SKILL_GWIGEOM & SKILL_GEOMKYUNG if not using weapon
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot carry out this action while fishing."));
-		return false;
+		if (item->GetType() == ITEM_WEAPON)
+		{
+			if (IsAffectFlag(AFF_GWIGUM))
+				RemoveAffect(SKILL_GWIGEOM);
+
+			if (IsAffectFlag(AFF_GEOMGYEONG))
+				RemoveAffect(SKILL_GEOMKYUNG);
+		}
 	}
+	//>
 
 	//  unequip κ丮 ű   ڸ ִ  Ȯ
 	{
 		int pos = -1;
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
 		if (item->IsDragonSoul())
 			pos = GetEmptyDragonSoulInventory(item);
-		else
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+		else if (item->IsSkillBook())
+			pos = GetEmptySkillBookInventory(item->GetSize());
+		else if (item->IsUpgradeItem())
+			pos = GetEmptyUpgradeItemsInventory(item->GetSize());
+		else if (item->IsStone())
+			pos = GetEmptyStoneInventory(item->GetSize());
+		else if (item->IsGiftBox())
+			pos = GetEmptyGiftBoxInventory(item->GetSize());
 #endif
+		else
 			pos = GetEmptyInventory(item->GetSize());
 
-		if (-1 == pos)
-		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("ǰ   ϴ."));
-			return false;
-		}
+		VERIFY_MSG(-1 == pos, "ǰ   ϴ.");
 	}
 
 	return true;
 }
 
-#ifdef __OFFLINE_SHOP__
-bool CHARACTER::UseItemOpenOfflineShop(CItem* item)
-{
-	if (!item) {
-		return false;
-	}
-
-	if (IsOpeningOfflineShop()) {
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("ZATEN_PAZAR_ACIYORSUN"));
-		return false;
-	}
-
-	item->Lock(true);
-	SetOpeningOfflineShopState(true);
-	SetOfflineShopOpeningItem(item);
-
-	ChatPacket(CHAT_TYPE_COMMAND, "StartOpeningOfflineShop %d %lld",
-		item->GetValue(COfflineShop::ITEM_TIME_IDX), item->GetValue(COfflineShop::ITEM_GOLD_IDX));
-
-	return true;
-}
-#endif
-
-#if defined(__MOVE_COSTUME_ATTR__)
-void CHARACTER::OpenItemComb()
-{
-	if (PreventTradeWindow(WND_ALL))
-	{
-		ChatPacket(CHAT_TYPE_INFO, "You have to close other windows.");
-		return;
-	}
-
-	const LPCHARACTER npc = GetQuestNPC();
-	if (npc == NULL)
-	{
-		sys_err("Item Combination NPC is NULL (ch: %s)", GetName());
-		return;
-	}
-
-	SetItemCombNpc(npc);
-	ChatPacket(CHAT_TYPE_COMMAND, "ShowItemCombinationDialog");
-}
-
-void CHARACTER::ItemCombination(const short MediumIndex, const short BaseIndex, const short MaterialIndex)
-{
-	if (IsItemComb() == false)
-		return;
-
-	const LPITEM MediumItem = GetItem(TItemPos(INVENTORY, MediumIndex));
-	const LPITEM BaseItem = GetItem(TItemPos(INVENTORY, BaseIndex));
-	const LPITEM MaterialItem = GetItem(TItemPos(INVENTORY, MaterialIndex));
-
-	if (MediumItem == NULL || BaseItem == NULL || MaterialItem == NULL)
-		return;
-
-	if (BaseItem->GetCount() > 1 || MaterialItem->GetCount() > 1)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("Split the items first. You cannot use stacked items here."));
-		return;
-	}
-
-	if (MediumItem->GetType() != ITEM_MEDIUM)
-		return;
-
-	if (BaseItem->GetType() != MaterialItem->GetType())
-		return;
-
-	if (BaseItem->GetSubType() != MaterialItem->GetSubType())
-		return;
-
-	if (BaseItem->GetType() != EItemTypes::ITEM_COSTUME || MaterialItem->GetType() != EItemTypes::ITEM_COSTUME)
-		return;
-
-	if (BaseItem->IsEquipped() || MaterialItem->IsEquipped())
-		return;
-
-#if defined(__SOUL_BIND_SYSTEM__)
-	if (BaseItem->IsSealed() || MaterialItem->IsSealed())
-		return;
-#endif
-
-	if (MediumItem->GetSubType() == MEDIUM_MOVE_COSTUME_ATTR)
-	{
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-		if (BaseItem->GetSubType() == COSTUME_MOUNT || MaterialItem->GetSubType() == COSTUME_MOUNT)
-			return;
-#endif
-
-#if defined(__ACCE_COSTUME_SYSTEM__)
-		if (BaseItem->GetSubType() == COSTUME_ACCE || MaterialItem->GetSubType() == COSTUME_ACCE)
-			return;
-#endif
-
-#if defined(__AURA_COSTUME_SYSTEM__)
-		if (BaseItem->GetSubType() == COSTUME_AURA || MaterialItem->GetSubType() == COSTUME_AURA)
-			return;
-#endif
-
-		BaseItem->SetAttributes(MaterialItem->GetAttributes());
-		BaseItem->UpdatePacket();
-
-		ITEM_MANAGER::instance().RemoveItem(MaterialItem, "REMOVE (Item Combination)");
-		MediumItem->SetCount(MediumItem->GetCount() - 1);
-	}
-#if defined(__ACCE_COSTUME_SYSTEM__)
-	else if (MediumItem->GetSubType() == MEDIUM_MOVE_ACCE_ATTR)
-	{
-		if (MaterialItem->GetSocket(ITEM_SOCKET_ACCE_DRAIN_ITEM_VNUM) == 0)
-		{
-			if (MaterialItem->GetAttributeCount() == 0)
-			{
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot use a sash without a bonus as the source."));
-				return;
-			}
-		}
-
-		if (BaseItem->GetAttributeCount() > 0)
-		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot use a sash with a bonus for the target."));
-			return;
-		}
-
-		if (BaseItem->GetSocket(ITEM_SOCKET_ACCE_DRAIN_VALUE) != MaterialItem->GetSocket(ITEM_SOCKET_ACCE_DRAIN_VALUE))
-		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot transfer the bonus as the sashes have different absorption rates."));
-			return;
-		}
-
-		if (BaseItem->FindApplyValue(APPLY_ACCEDRAIN_RATE) != MaterialItem->FindApplyValue(APPLY_ACCEDRAIN_RATE))
-		{
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot transfer the bonus as the sashes have different grades."));
-			return;
-		}
-
-		int iRandom = number(0, EMediumMoveAcceResult::MEDIUM_MOVE_ACCE_MAX - 1);
-		switch (iRandom)
-		{
-			case EMediumMoveAcceResult::MEDIUM_MOVE_ACCE_FAIL:
-			{
-				MaterialItem->SetSocket(ITEM_SOCKET_ACCE_DRAIN_VALUE, MAX(MaterialItem->GetSocket(ITEM_SOCKET_ACCE_DRAIN_VALUE) - 1, 11));
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("Failure! The absorption rate was reduced by 1%."));
-			}
-			break;
-
-			case EMediumMoveAcceResult::MEDIUM_MOVE_ACCE_PARTIAL:
-			{
-				BaseItem->SetSockets(MaterialItem->GetSockets());
-				BaseItem->SetSocket(ITEM_SOCKET_ACCE_DRAIN_VALUE, MAX(MaterialItem->GetSocket(ITEM_SOCKET_ACCE_DRAIN_VALUE) - 1, 11));
-				BaseItem->SetAttributes(MaterialItem->GetAttributes());
-#if defined(__ITEM_APPLY_RANDOM__)
-				MaterialItem->CopyRandomAppliesTo(BaseItem);
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-				MaterialItem->CopyElementTo(BaseItem);
-#endif
-				BaseItem->UpdatePacket();
-
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("Partial success! The absorption rate was reduced by 1%."));
-				ITEM_MANAGER::instance().RemoveItem(MaterialItem, "REMOVE (Item Combination)");
-			}
-			break;
-
-			case EMediumMoveAcceResult::MEDIUM_MOVE_ACCE_SUCCESS:
-			{
-				BaseItem->SetSockets(MaterialItem->GetSockets());
-				BaseItem->SetAttributes(MaterialItem->GetAttributes());
-#if defined(__ITEM_APPLY_RANDOM__)
-				MaterialItem->CopyRandomAppliesTo(BaseItem);
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-				MaterialItem->CopyElementTo(BaseItem);
-#endif
-				BaseItem->UpdatePacket();
-
-				ChatPacket(CHAT_TYPE_INFO, LC_STRING("Success! The bonus was transferred successfully."));
-				ITEM_MANAGER::instance().RemoveItem(MaterialItem, "REMOVE (Item Combination)");
-			}
-			break;
-		}
-
-		MediumItem->SetCount(MediumItem->GetCount() - 1);
-	}
-#endif
-}
-#endif
-
-#if defined(__CHANGED_ATTR__)
-void CHARACTER::SelectAttr(LPITEM material, LPITEM item)
-{
-	const LPDESC d = GetDesc();
-	if (d == nullptr)
-		return;
-
-	if (PreventTradeWindow(WND_ALL))
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot upgrade anything while another window is open."));
-		return;
-	}
-
-	if (item->GetAttributeSetIndex() == -1)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ӽ    Դϴ."));
-		return;
-	}
-
-	if (item->GetAttributeCount() < 1)
-		return;
-
-	const TItemPos pos(item->GetWindow(), item->GetCell());
-	if (pos.IsInventoryPosition() == false)
-		return;
-
-	m_ItemSelectAttr.dwItemID = item->GetID();
-	item->GetSelectAttr(m_ItemSelectAttr.Attr);
-
-	TPacketGCItemSelectAttr p;
-	p.bHeader = HEADER_GC_ITEM_SELECT_ATTR;
-	p.pItemPos = pos;
-	std::copy(std::begin(m_ItemSelectAttr.Attr), std::end(m_ItemSelectAttr.Attr), std::begin(p.aAttr));
-	d->Packet(&p, sizeof p);
-
-	material->SetCount(material->GetCount() - 1);
-}
-
-void CHARACTER::SelectAttrResult(const bool bNew, const TItemPos& pos)
-{
-	if (IsSelectAttr() == false)
-		return;
-
-	if (bNew)
-	{
-		const LPITEM item = GetItem(pos);
-		if (item && item->GetID() == m_ItemSelectAttr.dwItemID)
-		{
-			item->SetAttributes(m_ItemSelectAttr.Attr);
-			item->UpdatePacket();
-			ChatPacket(CHAT_TYPE_INFO, LC_STRING("You have changed the upgrade."));
-		}
-	}
-
-	memset(&m_ItemSelectAttr, 0, sizeof m_ItemSelectAttr);
-}
-
-bool CHARACTER::IsSelectAttr() const
-{
-	return m_ItemSelectAttr.dwItemID != 0;
-}
-#endif
-
-#if defined(__LUCKY_BOX__)
-void CHARACTER::SetLuckyBoxSrcItem(const LPITEM c_lpItem)
-{
-	if (c_lpItem == nullptr)
-		return;
-
-	if (PreventTradeWindow(WND_ALL))
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("You have to close other windows."));
-		return;
-	}
-
-	ResetLuckyBoxData();
-
-	m_sLuckyBox.dwSrcItemVNum = c_lpItem->GetVnum();
-	m_sLuckyBox.dwSrcItemID = c_lpItem->GetID();
-	m_sLuckyBox.wSrcSlotIndex = c_lpItem->GetCell();
-
-	SendLuckyBoxInfo();
-}
-
-void CHARACTER::SendLuckyBoxInfo()
+#if defined(__SOUL_SYSTEM__)
+void CHARACTER::UseSoulAttack(BYTE bSoulType)
 {
-	if (!IsLuckyBoxOpen())
-		return;
-
-	if (!GetDesc())
-		return;
+	EAffectTypes type = AFFECT_NONE;
+	EAffectBits flag = AFF_NONE;
 
-	CLuckyBoxGroup* pLuckyBox = ITEM_MANAGER::Instance().GetLuckyBoxGroup();
-	if (!pLuckyBox)
-		return;
-
-	if (!pLuckyBox->ContainsItems(m_sLuckyBox.dwSrcItemVNum))
-	{
-		ResetLuckyBoxData();
-		return;
-	}
-
-	m_sLuckyBox.bTryCount++;
-
-	while (true)
+	switch (bSoulType)
 	{
-		const CLuckyBoxGroup::SLuckyBoxItemInfo& item = pLuckyBox->GetRandomItem(m_sLuckyBox.dwSrcItemVNum);
-		if (pLuckyBox->GetItemCount(m_sLuckyBox.dwSrcItemVNum) > 1 && item.dwVNum == m_sLuckyBox.dwItemVNum)
-			continue;
-
-		m_sLuckyBox.dwItemVNum = item.dwVNum;
-		m_sLuckyBox.bItemCount = item.bCount;
+	case RED_SOUL:
+		type = AFFECT_SOUL_RED;
+		flag = AFF_SOUL_RED;
 		break;
-	}
-
-	TPacketGCLuckyBox Packet;
-	Packet.bHeader = HEADER_GC_LUCKY_BOX;
-	Packet.dwVNum = m_sLuckyBox.dwItemVNum;
-	Packet.bCount = m_sLuckyBox.bItemCount;
-	Packet.iNeedMoney = GetLuckyBoxPrice();
-	Packet.wSlotIndex = m_sLuckyBox.wSrcSlotIndex;
-	GetDesc()->Packet(&Packet, sizeof(Packet));
-}
-
-void CHARACTER::LuckyBoxRetry()
-{
-	if (!IsLuckyBoxOpen())
-		return;
-
-	CLuckyBoxGroup* pLuckyBox = ITEM_MANAGER::Instance().GetLuckyBoxGroup();
-	if (!pLuckyBox)
-		return;
-
-	if (m_sLuckyBox.bTryCount >= pLuckyBox->GetMaxTryCount())
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("You can't do this anymore."));
-		return;
-	}
-
-	const int c_iPrice = GetLuckyBoxPrice();
-	if (c_iPrice > GetGold())
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("You don't have enough money."));
-		return;
-	}
 
-	PointChange(POINT_GOLD, -c_iPrice);
-	ChatPacket(CHAT_TYPE_INFO, LC_STRING("%d Yang has been deducted.", c_iPrice));
-	SendLuckyBoxInfo();
-}
-
-void CHARACTER::LuckyBoxReceive()
-{
-	if (!IsLuckyBoxOpen())
-		return;
-
-	const LPITEM c_lpSrcItem = ITEM_MANAGER::Instance().Find(m_sLuckyBox.dwSrcItemID);
-	if (c_lpSrcItem)
-	{
-		ITEM_MANAGER::Instance().RemoveItem(c_lpSrcItem);
-		AutoGiveItem(m_sLuckyBox.dwItemVNum, m_sLuckyBox.bItemCount);
-	}
-
-	ResetLuckyBoxData();
-}
-
-int CHARACTER::GetLuckyBoxPrice() const
-{
-	CLuckyBoxGroup* pLuckyBox = ITEM_MANAGER::Instance().GetLuckyBoxGroup();
-	if (!pLuckyBox)
-		return 0;
-
-	int iRet = pLuckyBox->GetPrice();
-	for (int i = 1; i < m_sLuckyBox.bTryCount; i++)
-		iRet *= 2;
-
-	return iRet;
-}
-
-bool CHARACTER::IsLuckyBoxOpen() const
-{
-	return m_sLuckyBox.dwSrcItemID != 0;
-}
-
-void CHARACTER::ResetLuckyBoxData()
-{
-	memset(&m_sLuckyBox, 0, sizeof(m_sLuckyBox));
-}
-#endif
-
-#if defined(__ATTR_6TH_7TH__)
-LPITEM CHARACTER::GetNPCStorageItem(BYTE bCell) const
-{
-	return GetItem(TItemPos(NPC_STORAGE, bCell));
-}
-
-bool CHARACTER::Attr67Add(const TAttr67AddData kAttr67AddData)
-{
-	if (!IsPC())
-		return false;
-
-	if (PreventTradeWindow(WND_ATTR67ADD, true/*except*/))
-		return false;
-
-	if (GetNPCStorageItem())
-		return false;
-
-	const LPITEM pkRegistItem = GetInventoryItem(kAttr67AddData.wRegistItemPos);
-	if (pkRegistItem == nullptr)
-		return false;
-
-#if defined(__SOUL_BIND_SYSTEM__)
-	if (pkRegistItem->IsSealed())
-		return false;
-#endif
-
-	if (pkRegistItem->isLocked())
-		return false;
-
-	if (pkRegistItem->IsEquipped())
-		return false;
-
-	if (pkRegistItem->GetType() != ITEM_ARMOR && pkRegistItem->GetType() != ITEM_WEAPON)
-		return false;
-
-	pkRegistItem->Lock(true);
-
-	if (pkRegistItem->GetAttributeCount() < ITEM_MANAGER::MAX_NORM_ATTR_NUM)
-	{
-		pkRegistItem->Lock(false);
-		return false;
-	}
-
-	DWORD dwItemMaterialVnum = pkRegistItem->Get67AttrMaterial();
-	if (CountSpecifyItem(dwItemMaterialVnum) < kAttr67AddData.byMaterialCount)
-		return false;
-
-	RemoveSpecifyItem(dwItemMaterialVnum, kAttr67AddData.byMaterialCount);
-
-	long lSupportIncreasePct = 0;
-	LPITEM pSupportItem = nullptr;
-	{
-		pSupportItem = GetInventoryItem(kAttr67AddData.wSupportItemPos);
-		if (pSupportItem)
-			lSupportIncreasePct = pSupportItem->GetValue(1);
-	}
-
-	// Total success percent.
-	float fMaterialPct = kAttr67AddData.byMaterialCount * ATTR67_SUCCESS_PER_MATERIAL;
-	float fSupportPct = 0.0f;
-	if (kAttr67AddData.bySupportItemCount != 0)
-	{
-		fSupportPct = static_cast<float>(lSupportIncreasePct) / (ATTR67_MATERIAL_MAX_COUNT * ATTR67_SUPPORT_MAX_COUNT);
-		fSupportPct *= kAttr67AddData.bySupportItemCount * kAttr67AddData.byMaterialCount;
-
-	}
-	float fTotalSuccessPct = fMaterialPct + fSupportPct;
-
-	if (test_server)
-	{
-		ChatPacket(CHAT_TYPE_INFO, "<Add67> Success Percentage: %.2f", fTotalSuccessPct);
-	}
-
-	if (pSupportItem)
-	{
-		if (CountSpecifyItem(pSupportItem->GetVnum()) < kAttr67AddData.bySupportItemCount)
-		{
-			pkRegistItem->Lock(false);
-			return false;
-		}
-
-		RemoveSpecifyItem(pSupportItem->GetVnum(), kAttr67AddData.bySupportItemCount);
-	}
-
-	pkRegistItem->RemoveFromCharacter();
-	SetItem(TItemPos(NPC_STORAGE, 0), pkRegistItem);
-	{
-		const LPITEM pkAttr67Add = GetNPCStorageItem();
-		if (!pkAttr67Add)
-		{
-			// TODO: Make a backup of the item in case something goes bad.
-			pkRegistItem->Lock(false);
-			sys_err("CHARACTER::Attr67Add: failed to get regist item from ATTR67_ADD (window).");
-			return false;
-		}
-
-		SetQuestFlag("add_attr67.success", (number(1, 100) <= fTotalSuccessPct ? 1 : 0));
-		SetQuestFlag("add_attr67.wait_time", get_global_time() + ATTR67_ADD_WAIT_TIME);
-		SetQuestFlag("add_attr67.add", 0);
-		// @ attr67add_collect (handling)
-	}
-
-	return true;
-}
-#endif
-
-#if defined(__SOUL_SYSTEM__)
-void CHARACTER::SoulItemProcess(ESoulSubTypes eSubType)
-{
-	LPITEM item = nullptr;
-	for (const auto& it : GetAffectContainer())
-	{
-		if (it == nullptr || it->dwType != AFFECT_SOUL)
-			continue;
-
-		switch (eSubType)
-		{
-			case ESoulSubTypes::RED_SOUL:
-			{
-				if (it->wApplyOn == AFF_SOUL_RED)
-					item = FindItemByID(it->lApplyValue);
-			}
-			break;
-
-			case ESoulSubTypes::BLUE_SOUL:
-			{
-				if (it->wApplyOn == AFF_SOUL_BLUE)
-					item = FindItemByID(it->lApplyValue);
-			}
-			break;
-		}
+	case BLUE_SOUL:
+		type = AFFECT_SOUL_BLUE;
+		flag = AFF_SOUL_BLUE;
+		break;
 	}
 
-	if (item == nullptr)
-		return;
-
-	if (!item->isLocked() || item->GetSocket(1) != TRUE)
+	if (AFFECT_NONE == type)
 		return;
 
-	long data = item->GetSocket(2);
-	long keep_time = data / 10000;
-	//auto max_time = item->GetLimitValue(1);
-	long min_time = 60;
-
-	// Minimum use time.
-	if (keep_time < min_time)
-		return;
-
-	/*
-	* Since the `remain_count` is added after the `keep_time`
-	* we can decrease `data` directly because the count
-	* stays at the end of `data`.
-	*/
-	//if (test_server)
-	//	data -= 5;
-	//else
-	--data; /* remain_count */;
-
-	/*
-	* If the remaining count is equal or below to zero
-	* then set decrease the socket data.
-	*/
-	long new_data = ((keep_time - min_time) * 10000) + item->GetValue(2);
-	long remain_count = data % 10000;
-	if (remain_count <= 0)
-	{
-		item->SetSocket(2, new_data);
-		item->ResetSoulTimerUseEvent();
-		return;
-	}
-
-	// Update the item with the new data (decreased count)
-	item->SetSocket(2, data, false /* log */);
-}
-
-int CHARACTER::GetSoulDamage(ESoulSubTypes eSubType) const
-{
-	LPITEM item = nullptr;
-	for (const auto& it : GetAffectContainer())
-	{
-		if (it == nullptr || it->dwType != AFFECT_SOUL)
-			continue;
-
-		switch (eSubType)
-		{
-			case ESoulSubTypes::RED_SOUL:
-			{
-				if (it->wApplyOn == AFF_SOUL_RED)
-					item = FindItemByID(it->lApplyValue);
-			}
-			break;
-
-			case ESoulSubTypes::BLUE_SOUL:
-			{
-				if (it->wApplyOn == AFF_SOUL_BLUE)
-					item = FindItemByID(it->lApplyValue);
-			}
-			break;
-		}
-	}
-
-	if (item == nullptr)
-		return 0;
-
-	if (item->GetSocket(1) != TRUE)
-		return 0;
-
-	int value = 0;
-	long data = item->GetSocket(2);
-	long keep_time = data / 10000;
-
-	long max_time = item->GetLimitValue(1);
-	long min_time = 60;
-
-	// Minimum use time.
-	if (keep_time < min_time)
-		return 0;
-
-	if (keep_time >= max_time)
-		return item->GetValue(5);
-
-	// Damage values in value field (3, 4, 5)
-	int value_field = 3 + std::floor(keep_time / (max_time - min_time));
-	if (value_field < ITEM_VALUES_MAX_NUM)
-		value = item->GetValue(value_field);
-
-	return value;
-}
-#endif
-
-#if defined(__SET_ITEM__)
-void CHARACTER::RefreshItemSetBonus()
-{
-	RemoveAffect(AFFECT_SET_ITEM);
+	const CAffect* pAffect = FindAffect(type);
 
-	bool bSetBonus = false;
-	for (const auto& [bSetValue, vItems] : ITEM_MANAGER::Instance().GetItemSetItemMap())
+	if (NULL != pAffect)
 	{
-		BYTE bWearCount = 0;
-
-		const auto& rkItemSetValueMap = ITEM_MANAGER::Instance().GetItemSetValueMap();
-		if (rkItemSetValueMap.empty())
-			break;
+		DWORD vnum[][5] = {
+			{ 70500, 70501, 70502, 70503, 70504 },
+			{ 70505, 70506, 70507, 70508, 70509 },
+		};
 
-		const auto& ItemSetValueMap = rkItemSetValueMap.find(bSetValue);
-		if (ItemSetValueMap == rkItemSetValueMap.end())
-			continue;
-
-		for (const auto& [bSetType, kItemTuple] : vItems)
+		for (int i = 0; i < 5; ++i)
 		{
-			LPITEM pItem = nullptr;
-			LPITEM pUnique1 = nullptr;
-			LPITEM pUnique2 = nullptr;
-			CPetSystem* pPetSystem = nullptr;
+			LPITEM item = FindSpecifyItem(vnum[bSoulType][i]);
 
-			switch (bSetType)
+			if (NULL != item)
 			{
-				case SET_ITEM_COSTUME_BODY:
-					pItem = GetWear(WEAR_COSTUME_BODY);
-					break;
-
-				case SET_ITEM_COSTUME_HAIR:
-					pItem = GetWear(WEAR_COSTUME_HAIR);
-					break;
-
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-				case SET_ITEM_COSTUME_MOUNT:
-					pItem = GetWear(WEAR_COSTUME_MOUNT);
-					break;
-#endif
-
-#if defined(__ACCE_COSTUME_SYSTEM__)
-				case SET_ITEM_COSTUME_ACCE:
-					pItem = GetWear(WEAR_COSTUME_ACCE);
-					break;
-#endif
-
-#if defined(__WEAPON_COSTUME_SYSTEM__)
-				case SET_ITEM_COSTUME_WEAPON:
-					pItem = GetWear(WEAR_COSTUME_WEAPON);
-					break;
-#endif
-
-				case SET_ITEM_UNIQUE:
-					pUnique1 = GetWear(WEAR_UNIQUE1);
-					pUnique2 = GetWear(WEAR_UNIQUE2);
-					break;
-
-#if defined(__PET_SYSTEM__)
-				case SET_ITEM_PET:
-					pPetSystem = GetPetSystem();
-					break;
-#endif
-			}
-
-			const auto& [dwMinVnum, dwMaxVnum, bRange] = kItemTuple;
-
-#if defined(__PET_SYSTEM__)
-			if (pPetSystem && CHECK_VNUM_RANGE(pPetSystem->GetSummonItemVnum(), dwMinVnum, dwMaxVnum, bRange))
-				++bWearCount;
-#endif
-
-			if (pUnique1 && CHECK_VNUM_RANGE(pUnique1->GetVnum(), dwMinVnum, dwMaxVnum, bRange))
-				++bWearCount;
-
-			if (pUnique2 && CHECK_VNUM_RANGE(pUnique2->GetVnum(), dwMinVnum, dwMaxVnum, bRange))
-				++bWearCount;
-
-			if (pItem && CHECK_VNUM_RANGE(pItem->GetVnum(), dwMinVnum, dwMaxVnum, bRange))
-				++bWearCount;
-
-			for (const auto& [bCount, vSetBonus] : ItemSetValueMap->second)
-			{
-				if (bWearCount != bCount)
+				if (item->GetSocket(3) >= item->GetLimitValue(1) && item->isLocked())
 				{
-					bSetBonus = false;
-					continue;
-				}
+					if (item->GetSocket(2) <= (item->GetLimitValue(1) * 10000))
+					{
+						RemoveAffect(type);
+						if (FindAffect(AFFECT_SOUL_MIX))
+							RemoveAffect(AFFECT_SOUL_MIX);
 
-				for (const auto& [wApplyType, lApplyValue] : vSetBonus)
-				{
-					AddAffect(AFFECT_SET_ITEM, aApplyInfo[wApplyType].wPointType, lApplyValue, 0, INFINITE_AFFECT_DURATION, 0, true, true);
-					bSetBonus = true;
+						item->SetSocket(1, false);
+						item->SetSocket(2, item->GetValue(2));
+						item->SetSocket(3, 0);
+						item->StartSoulTimeUseEvent();
+					}
+					else
+						item->SetSocket(2, item->GetSocket(2) - 1);
 				}
 			}
 		}
-
-		if (bSetBonus)
-			break;
 	}
 }
 
-CHARACTER::SetItemCountMap CHARACTER::GetItemSetCountMap() const
+bool CHARACTER::CheckSoulItem()
 {
-	std::vector<LPITEM> vItems = { GetWear(WEAR_BODY), GetWear(WEAR_HEAD), GetWear(WEAR_WEAPON) };
-	std::map<BYTE, BYTE> mSetCount = {
-		{ SET_ITEM_SET_VALUE_1, 0 },
-		{ SET_ITEM_SET_VALUE_2, 0 },
-		{ SET_ITEM_SET_VALUE_3, 0 },
-		{ SET_ITEM_SET_VALUE_4, 0 },
-		{ SET_ITEM_SET_VALUE_5, 0 },
+	DWORD vnum[2][5] = {
+		{ 70500, 70501, 70502, 70503, 70504 },
+		{ 70505, 70506, 70507, 70508, 70509 },
 	};
 
-	for (const LPITEM& pkItem : vItems)
-	{
-		if (pkItem == nullptr)
-			continue;
-
-		const BYTE bSetValue = pkItem->GetItemSetValue();
-		if (bSetValue != SET_ITEM_SET_VALUE_NONE)
-			++mSetCount[bSetValue];
-	}
-
-	return mSetCount;
-}
+	bool hasSoulItem = false;
 
-void CHARACTER::RefreshItemSetBonusByValue()
-{
-	for (DWORD dwType = AFFECT_SET_ITEM_SET_VALUE_1; dwType <= AFFECT_SET_ITEM_SET_VALUE_5; ++dwType)
-		RemoveAffect(dwType);
-
-	const auto& rkItemSetValueMap = ITEM_MANAGER::Instance().GetItemSetValueMap();
-	if (rkItemSetValueMap.empty())
-		return;
-
-	for (const auto& rkItemSetPair : GetItemSetCountMap())
+	for (int i = 0; i < 2; ++i)
 	{
-		BYTE bSetValue = rkItemSetPair.first;
-		BYTE bWearCount = rkItemSetPair.second;
-
-		const auto& rkSetItemMap = rkItemSetValueMap.find(bSetValue);
-		if (rkSetItemMap == rkItemSetValueMap.end())
-			continue;
-
-		for (const auto& kSetItem : rkSetItemMap->second)
+		for (int j = 0; j < 5; ++j)
 		{
-			const auto& vSetBonus = kSetItem.second;
-			if (bWearCount != kSetItem.first)
-				continue;
-
-			for (const auto& kSetBonus : vSetBonus)
-				AddAffect((AFFECT_SET_ITEM_SET_VALUE_1 - 1) + bSetValue, aApplyInfo[kSetBonus.first].wPointType, kSetBonus.second, 0, INFINITE_AFFECT_DURATION, 0, true, true);
-		}
-	}
-}
-#endif
-
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-void CHARACTER::RefineElementInformation(const LPITEM& rSrcItem, const TItemPos& kItemDestCell)
-{
-	if (!CanHandleItem())
-		return;
-
-	LPITEM pDestItem;
-	if (!IsValidItemPosition(kItemDestCell) || !(pDestItem = GetItem(kItemDestCell)))
-		return;
-
-	if (rSrcItem->IsEquipped() || pDestItem->IsEquipped())
-		return;
-
-	if (rSrcItem->IsExchanging() || pDestItem->IsExchanging())
-		return;
-
-	if (rSrcItem->isLocked() || pDestItem->isLocked())
-		return;
-
-#if defined(__SOUL_BIND_SYSTEM__)
-	if (pDestItem->IsSealed())
-		return;
-#endif
-
-	if (pDestItem->GetType() != ITEM_WEAPON)
-		return;
-
-	if (pDestItem->GetRefineLevel() < REFINE_ELEMENT_MIN_REFINE_LEVEL)
-		return;
-
-	TPacketGCRefineElement kPacket;
-	kPacket.bHeader = HEADER_GC_REFINE_ELEMENT;
-	kPacket.bSubHeader = REFINE_ELEMENT_GC_OPEN;
-	switch (rSrcItem->GetSubType())
-	{
-		case USE_ELEMENT_UPGRADE:
-			kPacket.bRefineType = REFINE_ELEMENT_UPGRADE;
-			break;
-		case USE_ELEMENT_DOWNGRADE:
-			kPacket.bRefineType = REFINE_ELEMENT_DOWNGRADE;
-			break;
-		case USE_ELEMENT_CHANGE:
-			kPacket.bRefineType = REFINE_ELEMENT_CHANGE;
-			break;
-		default:
-		{
-			sys_err("CHARACTER::RefineElementInformation: %s cannot receive information with unsupported material sub type.", GetName());
-			return;
-		}
-	}
-	kPacket.bResult = false;
-	kPacket.SrcPos = TItemPos(rSrcItem->GetWindow(), rSrcItem->GetCell());
-	kPacket.DestPos = kItemDestCell;
-	GetDesc()->Packet(&kPacket, sizeof(kPacket));
-
-	SetUnderRefineElement(true, kPacket.bRefineType, kPacket.SrcPos, kPacket.DestPos);
-}
-
-void CHARACTER::SetUnderRefineElement(bool bState, BYTE bRefineType, const TItemPos& rkSrcPos, const TItemPos& rkDestPos)
-{
-	m_kRefineElementItemPos.RefineType = bRefineType;
-	m_kRefineElementItemPos.SrcPos = rkSrcPos;
-	m_kRefineElementItemPos.DestPos = rkDestPos;
-	m_bUnderRefineElement = bState;
-}
-
-void CHARACTER::RefineElement(WORD wChangeElement)
-{
-	if (!IsUnderRefineElement())
-		return;
-
-	LPITEM pSrcItem;
-	if (!IsValidItemPosition(m_kRefineElementItemPos.SrcPos) || !(pSrcItem = GetItem(m_kRefineElementItemPos.SrcPos)))
-		return;
-
-	LPITEM pDestItem;
-	if (!IsValidItemPosition(m_kRefineElementItemPos.DestPos) || !(pDestItem = GetItem(m_kRefineElementItemPos.DestPos)))
-		return;
-
-#if defined(__SOUL_BIND_SYSTEM__)
-	if (pDestItem->IsSealed())
-		return;
-#endif
-
-	if (pDestItem->GetType() != ITEM_WEAPON)
-		return;
-
-	if (pDestItem->GetRefineLevel() < REFINE_ELEMENT_MIN_REFINE_LEVEL)
-		return;
-
-	TPacketGCRefineElement kPacket;
-	kPacket.bHeader = HEADER_GC_REFINE_ELEMENT;
-	kPacket.bSubHeader = REFINE_ELEMENT_GC_RESULT;
-	kPacket.bRefineType = m_kRefineElementItemPos.RefineType;
-	switch (kPacket.bRefineType)
-	{
-		case REFINE_ELEMENT_UPGRADE:
-		{
-			if (GetGold() < REFINE_ELEMENT_UPGRADE_YANG)
-				return;
-
-			//const TRefineTable* pRefineTable = CRefineManager::instance().GetRefineRecipe(11);
-			//if (number(1, 100) <= (pRefineTable ? pRefineTable->prob : 30))
-			if (number(1, 100) <= (test_server ? 80 : 30))
+			LPITEM item = FindSpecifyItem(vnum[i][j]);
+			if (item)
 			{
-				const WORD wMaterialApplyType = static_cast<WORD>(pSrcItem->GetValue(0));
-				const WORD wRefineElementApplyType = pDestItem->GetRefineElementApplyType();
-				if ((wRefineElementApplyType != 0) && (wRefineElementApplyType != wMaterialApplyType))
+				if (item->isLocked() || item->GetSocket(1) == true)
 				{
-					sys_err("CHARACTER::RefineElement: %s cannot upgrade with wrong material.", GetName());
-					return;
-				}
-
-				const BYTE bRandomValue = number_even(REFINE_ELEMENT_RANDOM_VALUE_MIN, REFINE_ELEMENT_RANDOM_VALUE_MAX);
-				const BYTE bRandomBonusValue = number_even(REFINE_ELEMENT_RANDOM_BONUS_VALUE_MIN, REFINE_ELEMENT_RANDOM_BONUS_VALUE_MAX);
-
-				pDestItem->UpgradeRefineElement(wMaterialApplyType, bRandomValue, bRandomBonusValue);
-
-				kPacket.bResult = true;
-			}
-			else
-			{
-				kPacket.bResult = false;
-			}
-
-			PointChange(POINT_GOLD, -REFINE_ELEMENT_UPGRADE_YANG);
-		}
-		break;
-
-		case REFINE_ELEMENT_DOWNGRADE:
-		{
-			if (GetGold() < REFINE_ELEMENT_DOWNGRADE_YANG)
-				return;
-
-			pDestItem->DowngradeRefineElement();
-			kPacket.bResult = true;
-
-			PointChange(POINT_GOLD, -REFINE_ELEMENT_DOWNGRADE_YANG);
-		}
-		break;
-
-		case REFINE_ELEMENT_CHANGE:
-		{
-			if (GetGold() < REFINE_ELEMENT_CHANGE_YANG)
-				return;
-
-			switch (wChangeElement)
-			{
-				case APPLY_ENCHANT_ELECT:
-				case APPLY_ENCHANT_FIRE:
-				case APPLY_ENCHANT_ICE:
-				case APPLY_ENCHANT_WIND:
-				case APPLY_ENCHANT_EARTH:
-				case APPLY_ENCHANT_DARK:
+					item->Lock(true);
+					hasSoulItem = true;
 					break;
-
-				default:
-				{
-					sys_err("CHARACTER::RefineElement: %s cannot change element with unsupported apply type.", GetName());
-					return;
 				}
 			}
-
-			const WORD wRefineElementApplyType = pDestItem->GetRefineElementApplyType();
-			if (wRefineElementApplyType == wChangeElement)
-			{
-				sys_err("CHARACTER::RefineElement: %s cannot change element with the current apply type.", GetName());
-				return;
-			}
-
-			pDestItem->ChangeRefineElement(wChangeElement);
-			kPacket.bResult = true;
-
-			PointChange(POINT_GOLD, -REFINE_ELEMENT_CHANGE_YANG);
-		}
-		break;
-
-		default:
-		{
-			sys_err("CHARACTER::RefineElement: %s cannot refine with unknown type.", GetName());
-			return;
 		}
 	}
-	kPacket.SrcPos = NPOS;
-	kPacket.DestPos = NPOS;
-	GetDesc()->Packet(&kPacket, sizeof(kPacket));
 
-	pSrcItem->SetCount(pSrcItem->GetCount() - 1);
-
-	SetUnderRefineElement(false);
-}
+	if (!hasSoulItem)
+		return false;
 
-WORD CHARACTER::GetRefineElementEffect() const
-{
-	const LPITEM pItemWeapon = GetWear(WEAR_WEAPON);
-	if ((pItemWeapon) && (pItemWeapon->GetRefineElementGrade() >= REFINE_ELEMENT_MAX))
-		return pItemWeapon->GetRefineElementApplyType();
-	return 0;
+	return true;
 }
 #endif
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/char_manager.cpp final/server/server/home/metin2/Source/Server/game/src/char_manager.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/char_manager.cpp	2025-06-28 20:29:36.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/char_manager.cpp	2021-06-22 10:47:58.000000000 +0000
@@ -16,21 +16,22 @@
 #include "questlua.h"
 #include "locale_service.h"
 #include "../common/VnumHelper.h"
+#if defined(__EREBUS_DUNGEON__)
+#	include "unique_mob.h"
+#endif
+
+//#ifndef __GNUC__
+#include <boost/bind.hpp>
+//#endif
 
 CHARACTER_MANAGER::CHARACTER_MANAGER() :
 	m_iVIDCount(0),
 	m_pkChrSelectedStone(NULL),
 	m_bUsePendingDestroy(false)
 {
-#if defined(__XMAS_EVENT_2008__)
 	RegisterRaceNum(xmas::MOB_XMAS_FIRWORK_SELLER_VNUM);
-	RegisterRaceNum(xmas::MOB_XMAS_SANTA_VNUM);
+	RegisterRaceNum(xmas::MOB_SANTA_VNUM);
 	RegisterRaceNum(xmas::MOB_XMAS_TREE_VNUM);
-#endif
-#if defined(__XMAS_EVENT_2012__)
-	RegisterRaceNum(xmas::MOB_NEW_XMAS_SANTA_VNUM);
-	RegisterRaceNum(xmas::MOB_NEW_XMAS_TREE_VNUM);
-#endif
 
 	m_iMobItemRate = 100;
 	m_iMobDamageRate = 100;
@@ -54,7 +55,7 @@
 
 void CHARACTER_MANAGER::Destroy()
 {
-	auto it = m_map_pkChrByVID.begin();
+	itertype(m_map_pkChrByVID) it = m_map_pkChrByVID.begin();
 	while (it != m_map_pkChrByVID.end())
 	{
 		LPCHARACTER ch = it->second;
@@ -79,31 +80,27 @@
 
 LPCHARACTER CHARACTER_MANAGER::CreateCharacter(const char* name, DWORD dwPID)
 {
-	try
-	{
-		DWORD dwVID = AllocVID();
-
-		LPCHARACTER ch = M2_NEW CHARACTER;
-		ch->Create(name, dwVID, dwPID ? true : false);
+	DWORD dwVID = AllocVID();
 
-		m_map_pkChrByVID.insert(std::make_pair(dwVID, ch));
-
-		if (dwPID)
-		{
-			char szName[CHARACTER_NAME_MAX_LEN + 1];
-			str_lower(name, szName, sizeof(szName));
+#ifdef M2_USE_POOL
+	LPCHARACTER ch = pool_.Construct();
+#else
+	LPCHARACTER ch = M2_NEW CHARACTER;
+#endif
+	ch->Create(name, dwVID, dwPID ? true : false);
 
-			m_map_pkPCChr.insert(NAME_MAP::value_type(szName, ch));
-			m_map_pkChrByPID.insert(std::make_pair(dwPID, ch));
-		}
+	m_map_pkChrByVID.insert(std::make_pair(dwVID, ch));
 
-		return (ch);
-	}
-	catch (const std::exception& e)
+	if (dwPID)
 	{
-		sys_err("[CHARACTER_MANAGER::CreateCharacter] %s", e.what());
-		return nullptr;
+		char szName[CHARACTER_NAME_MAX_LEN + 1];
+		str_lower(name, szName, sizeof(szName));
+
+		m_map_pkPCChr.insert(NAME_MAP::value_type(szName, ch));
+		m_map_pkChrByPID.insert(std::make_pair(dwPID, ch));
 	}
+
+	return (ch);
 }
 
 #ifndef DEBUG_ALLOC
@@ -116,7 +113,7 @@
 		return;
 
 	// <Factor> Check whether it has been already deleted or not.
-	auto it = m_map_pkChrByVID.find(ch->GetVID());
+	itertype(m_map_pkChrByVID) it = m_map_pkChrByVID.find(ch->GetVID());
 	if (it == m_map_pkChrByVID.end())
 	{
 		sys_err("[CHARACTER_MANAGER::DestroyCharacter] <Factor> %d not found", (long)(ch->GetVID()));
@@ -124,22 +121,12 @@
 	}
 
 	//  Ҽӵ ʹ  ϵ.
-	if (ch->IsNPC() && ch->GetRider() == NULL
-#if defined(__PET_SYSTEM__)
-		&& !ch->IsPet()
-#endif
-#if defined(__GROWTH_PET_SYSTEM__)
-		&& !ch->IsGrowthPet()
-#endif
-		)
+	if (ch->IsNPC() && !ch->IsPet() && !ch->IsGrowthPet() && ch->GetRider() == NULL)
 	{
 		if (ch->GetDungeon())
+		{
 			ch->GetDungeon()->DeadCharacter(ch);
-
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-		if (ch->GetGuildDragonLair())
-			ch->GetGuildDragonLair()->DeadCharacter(ch);
-#endif
+		}
 	}
 
 	if (m_bUsePendingDestroy)
@@ -164,21 +151,32 @@
 
 	if (0 != ch->GetPlayerID())
 	{
-		auto it = m_map_pkChrByPID.find(ch->GetPlayerID());
+		itertype(m_map_pkChrByPID) it = m_map_pkChrByPID.find(ch->GetPlayerID());
+
 		if (m_map_pkChrByPID.end() != it)
+		{
 			m_map_pkChrByPID.erase(it);
+		}
 	}
 
 	UnregisterRaceNumMap(ch);
 
 	RemoveFromStateList(ch);
 
+#ifdef M2_USE_POOL
+	pool_.Destroy(ch);
+#else
+#ifndef DEBUG_ALLOC
 	M2_DELETE(ch);
+#else
+	M2_DELETE_EX(ch, file, line);
+#endif
+#endif
 }
 
 LPCHARACTER CHARACTER_MANAGER::Find(DWORD dwVID)
 {
-	auto it = m_map_pkChrByVID.find(dwVID);
+	itertype(m_map_pkChrByVID) it = m_map_pkChrByVID.find(dwVID);
 
 	if (m_map_pkChrByVID.end() == it)
 		return NULL;
@@ -205,7 +203,8 @@
 
 LPCHARACTER CHARACTER_MANAGER::FindByPID(DWORD dwPID)
 {
-	auto it = m_map_pkChrByPID.find(dwPID);
+	itertype(m_map_pkChrByPID) it = m_map_pkChrByPID.find(dwPID);
+
 	if (m_map_pkChrByPID.end() == it)
 		return NULL;
 
@@ -287,7 +286,6 @@
 
 	int i;
 	long x, y;
-
 	for (i = 0; i < 2000; i++)
 	{
 		x = number(1, (pkSectreeMap->m_setting.iWidth / 100) - 1) * 100 + pkSectreeMap->m_setting.iBaseX;
@@ -334,7 +332,7 @@
 	ch->SetProto(pkMob);
 
 	// if mob is npc with no empire assigned, assign to empire of map
-	if (pkMob->m_table.bType == CHAR_TYPE_NPC)
+	if (CMobVnumHelper::IsNPCType(pkMob->m_table.bType))
 	{
 		if (ch->GetEmpire() == 0)
 			ch->SetEmpire(SECTREE_MANAGER::instance().GetEmpireFromMapIndex(lMapIndex));
@@ -352,12 +350,7 @@
 	char buf[512 + 1];
 	long local_x = x - pkSectreeMap->m_setting.iBaseX;
 	long local_y = y - pkSectreeMap->m_setting.iBaseY;
-
-#if defined(__LOCALE_CLIENT__)
-	snprintf(buf, sizeof(buf), "spawn %s [%d] random position at %ld %ld %ld %ld (time: %d)", LC_MOB(ch->GetRaceNum()), dwVnum, x, y, local_x, local_y, get_global_time());
-#else
-	snprintf(buf, sizeof(buf), "spawn %s [%d] random position at %ld %ld %ld %ld (time: %d)", ch->GetName(), dwVnum, x, y, local_x, local_y, get_global_time());
-#endif
+	snprintf(buf, sizeof(buf), "spawn %s[%d] random position at %ld %ld %ld %ld (time: %d)", ch->GetName(), dwVnum, x, y, local_x, local_y, get_global_time());
 
 	if (test_server)
 		SendNotice(buf);
@@ -366,25 +359,20 @@
 	return (ch);
 }
 
-LPCHARACTER CHARACTER_MANAGER::SpawnMob(DWORD dwVnum, long lMapIndex, long x, long y, long z, bool bSpawnMotion, int iRot, bool bShow
 #if defined(__WJ_SHOW_MOB_INFO__)
-	, bool bAggressive
+LPCHARACTER CHARACTER_MANAGER::SpawnMob(DWORD dwVnum, long lMapIndex, long x, long y, long z, bool bSpawnMotion, int iRot, bool bShow, bool bAggressive)
+#else
+LPCHARACTER CHARACTER_MANAGER::SpawnMob(DWORD dwVnum, long lMapIndex, long x, long y, long z, bool bSpawnMotion, int iRot, bool bShow)
 #endif
-)
 {
 	const CMob* pkMob = CMobManager::instance().Get(dwVnum);
 	if (!pkMob)
 	{
-#if defined(__OFFLINE_SHOP__)
-		if (dwVnum != 31100)
-			sys_err("SpawnMob: no mob data for vnum %u", dwVnum);
-#else
 		sys_err("SpawnMob: no mob data for vnum %u", dwVnum);
-#endif
 		return NULL;
 	}
 
-	if (!(CMob::IsNPC(pkMob->m_table.bType)) || mining::IsVeinOfOre(dwVnum))
+	if (!(CMobVnumHelper::IsNPCType(pkMob->m_table.bType) || pkMob->m_table.bType == CHAR_TYPE_WARP || pkMob->m_table.bType == CHAR_TYPE_GOTO || pkMob->m_table.bType == CHAR_TYPE_PET_PAY || pkMob->m_table.bType == CHAR_TYPE_PET) || mining::IsVeinOfOre(dwVnum))
 	{
 		LPSECTREE tree = SECTREE_MANAGER::instance().Get(lMapIndex, x, y);
 
@@ -452,13 +440,17 @@
 	ch->SetProto(pkMob);
 
 	// if npc with no empire is assigned, assign to empire of map
-	if (pkMob->m_table.bType == CHAR_TYPE_NPC)
+	if (CMobVnumHelper::IsNPCType(pkMob->m_table.bType))
 	{
 		if (ch->GetEmpire() == 0)
 			ch->SetEmpire(SECTREE_MANAGER::instance().GetEmpireFromMapIndex(lMapIndex));
 	}
 
 	ch->SetRotation(iRot);
+#if defined(__EREBUS_DUNGEON__)
+	if (ch->GetRaceNum() == THUNDER_BOSS)
+		ch->SetMaxStamina(vErebusHealers.at(0).iStaminaPCT);
+#endif
 
 #if defined(__WJ_SHOW_MOB_INFO__)
 	if (bShow && !ch->Show(lMapIndex, x, y, z, bSpawnMotion, bAggressive))
@@ -635,11 +627,6 @@
 
 		if (m_pkChrSelectedStone->GetDungeon())
 			bAggressive = true;
-
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-		if (m_pkChrSelectedStone->GetGuildDragonLair() && CGuildDragonLairManager::Instance().IsStone(m_pkChrSelectedStone->GetRaceNum()))
-			return NULL;
-#endif
 	}
 
 	LPCHARACTER chLeader = NULL;
@@ -692,12 +679,9 @@
 {
 	void operator () (LPCHARACTER ch)
 	{
-		if (ch)
-		{
-			ch->ResetChatCounter();
-			ch->ResetWhisperCounter();
-			ch->CFSM::Update();
-		}
+		ch->ResetChatCounter();
+		ch->ResetWhisperCounter();
+		ch->CFSM::Update();
 	}
 };
 
@@ -714,7 +698,7 @@
 			// ̳ 
 			CHARACTER_VECTOR v;
 			v.reserve(m_map_pkPCChr.size());
-			std::transform(m_map_pkPCChr.begin(), m_map_pkPCChr.end(), std::back_inserter(v), [](NAME_MAP::value_type map) { return map.second; });
+			transform(m_map_pkPCChr.begin(), m_map_pkPCChr.end(), back_inserter(v), boost::bind(&NAME_MAP::value_type::second, _1));
 			if (0 == (iPulse % PASSES_PER_SEC(5)))
 			{
 				FuncUpdateAndResetChatCounter f;
@@ -722,8 +706,7 @@
 			}
 			else
 			{
-				std::for_each(v.begin(), v.end(), [iPulse](LPCHARACTER ch) {
-					if (ch != nullptr) ch->UpdateCharacter(iPulse); });
+				for_each(v.begin(), v.end(), std::bind(&CHARACTER::UpdateCharacter, std::placeholders::_1, iPulse));
 			}
 		}
 	}
@@ -735,30 +718,35 @@
 			CHARACTER_VECTOR v;
 			v.reserve(m_set_pkChrState.size());
 			v.insert(v.end(), m_set_pkChrState.begin(), m_set_pkChrState.end());
-			std::for_each(v.begin(), v.end(), [iPulse](LPCHARACTER ch) {
-				if (ch != nullptr) ch->UpdateStateMachine(iPulse); });
+			for_each(v.begin(), v.end(), std::bind(&CHARACTER::UpdateStateMachine, std::placeholders::_1, iPulse));
 		}
 	}
 
-#if defined(__XMAS_EVENT_2008__)
 	// Ÿ  Ʈ
 	{
-		CharacterVectorInteractor vec;
-		if (CHARACTER_MANAGER::instance().GetCharactersByRaceNum(xmas::MOB_XMAS_SANTA_VNUM, vec))
+		CharacterVectorInteractor i;
+
+		if (CHARACTER_MANAGER::instance().GetCharactersByRaceNum(xmas::MOB_SANTA_VNUM, i))
 		{
-			//for_each(vec.begin(), vec.end(), std::bind(&CHARACTER::UpdateStateMachine, std::placeholders::_1, iPulse));
-			std::for_each(vec.begin(), vec.end(), [iPulse](LPCHARACTER ch) {
-				if (ch != nullptr) ch->UpdateStateMachine(iPulse); });
+			for_each(i.begin(), i.end(), std::bind(&CHARACTER::UpdateStateMachine, std::placeholders::_1, iPulse));
 		}
 	}
-#endif
 
 	// 1ð ѹ     
 	if (0 == (iPulse % PASSES_PER_SEC(3600)))
 	{
-		for (auto it = m_map_dwMobKillCount.begin(); it != m_map_dwMobKillCount.end(); ++it)
+		for (itertype(m_map_dwMobKillCount) it = m_map_dwMobKillCount.begin(); it != m_map_dwMobKillCount.end(); ++it)
 			DBManager::instance().SendMoneyLog(MONEY_LOG_MONSTER_KILL, it->first, it->second);
 
+#ifdef _USE_SERVER_KEY_
+		extern bool Metin2Server_IsInvalid();
+		extern bool g_bShutdown;
+		if (Metin2Server_IsInvalid())
+		{
+			g_bShutdown = true;
+		}
+#endif
+
 		m_map_dwMobKillCount.clear();
 	}
 
@@ -838,8 +826,9 @@
 
 void CHARACTER_MANAGER::PacketMonsterLog(LPCHARACTER ch, const void* buf, int size)
 {
-	auto it = m_set_pkChrMonsterLog.begin();
-	for (; it != m_set_pkChrMonsterLog.end(); ++it)
+	itertype(m_set_pkChrMonsterLog) it;
+
+	for (it = m_set_pkChrMonsterLog.begin(); it != m_set_pkChrMonsterLog.end(); ++it)
 	{
 		LPCHARACTER c = *it;
 
@@ -901,7 +890,7 @@
 
 bool CHARACTER_MANAGER::GetCharactersByRaceNum(DWORD dwRaceNum, CharacterVectorInteractor& i)
 {
-	pkCharRaceSet::iterator it = m_map_pkChrByRaceNum.find(dwRaceNum);
+	std::map<DWORD, CHARACTER_SET>::iterator it = m_map_pkChrByRaceNum.find(dwRaceNum);
 
 	if (it == m_map_pkChrByRaceNum.end())
 		return false;
@@ -938,10 +927,10 @@
 LPCHARACTER CHARACTER_MANAGER::FindSpecifyPC(unsigned int uiJobFlag, long lMapIndex, LPCHARACTER except, int iMinLevel, int iMaxLevel)
 {
 	LPCHARACTER chFind = NULL;
-
+	itertype(m_map_pkChrByPID) it;
 	int n = 0;
-	auto it = m_map_pkChrByPID.begin();
-	for (; it != m_map_pkChrByPID.end(); ++it)
+
+	for (it = m_map_pkChrByPID.begin(); it != m_map_pkChrByPID.end(); ++it)
 	{
 		LPCHARACTER ch = it->second;
 
@@ -1068,10 +1057,8 @@
 			return 0;
 		}
 	}
-
 	if (ch && ch->GetPremiumRemainSeconds(PREMIUM_EXP) > 0)
 		return m_iMobExpRatePremium;
-
 	return m_iMobExpRate;
 }
 
@@ -1141,6 +1128,8 @@
 
 CharacterVectorInteractor::CharacterVectorInteractor(const CHARACTER_SET& r)
 {
+	using namespace std;
+
 	reserve(r.size());
 	insert(end(), r.begin(), r.end());
 
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/char_state.cpp final/server/server/home/metin2/Source/Server/game/src/char_state.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/char_state.cpp	2025-06-28 20:26:14.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/char_state.cpp	2022-04-27 12:17:10.000000000 +0000
@@ -21,13 +21,12 @@
 #include "war_map.h"
 #include "locale_service.h"
 #include "BlueDragon.h"
-#if defined(__DAWNMIST_DUNGEON__)
-#	include "dawnmist_dungeon.h"
+#if defined(__GUILD_DRAGONLAIR__)
+#include "MeleyLair.h"
 #endif
-#if defined(__DEFENSE_WAVE__)
-#	include "defense_wave.h"
+#if defined(__TEMPLE_OCHAO__)
+#include "TempleOchao.h"
 #endif
-
 #include "unique_mob.h"
 
 #include "../../common/VnumHelper.h"
@@ -163,7 +162,7 @@
 							//pkChr->RemoveAffect(AFFECT_WAR_FLAG);
 
 							char buf[256];
-							snprintf(buf, sizeof(buf), LC_STRING("%s 尡 %s   Ѿҽϴ!", pMap->GetGuild(idx)->GetName(), pMap->GetGuild(idx_opp)->GetName()));
+							snprintf(buf, sizeof(buf), LC_TEXT("%s 尡 %s   Ѿҽϴ!"), pMap->GetGuild(idx)->GetName(), pMap->GetGuild(idx_opp)->GetName());
 							pMap->Notice(buf);
 						}
 					}
@@ -237,6 +236,7 @@
 
 		LPCHARACTER m_pkChrVictim;
 	};
+
 }
 
 bool CHARACTER::IsAggressive() const
@@ -244,12 +244,9 @@
 	return IS_SET(m_pointsInstant.dwAIFlag, AIFLAG_AGGRESSIVE);
 }
 
-void CHARACTER::SetAggressive(bool bSet)
+void CHARACTER::SetAggressive()
 {
-	if (bSet)
-		SET_BIT(m_pointsInstant.dwAIFlag, AIFLAG_AGGRESSIVE);
-	else
-		REMOVE_BIT(m_pointsInstant.dwAIFlag, AIFLAG_AGGRESSIVE);
+	SET_BIT(m_pointsInstant.dwAIFlag, AIFLAG_AGGRESSIVE);
 }
 
 bool CHARACTER::IsCoward() const
@@ -292,11 +289,6 @@
 	return IS_SET(m_pointsInstant.dwAIFlag, AIFLAG_HEALER);
 }
 
-bool CHARACTER::IsFaller() const
-{
-	return IS_SET(m_pointsInstant.dwAIFlag, AIFLAG_FALL);
-}
-
 void CHARACTER::CowardEscape()
 {
 	int iDist[4] = { 500, 1000, 3000, 5000 };
@@ -376,16 +368,6 @@
 	return IS_SET(m_pointsInstant.dwAIFlag, AIFLAG_ATTACKMOB);
 }
 
-void CHARACTER::SetNoMove()
-{
-	SET_BIT(m_pointsInstant.dwAIFlag, AIFLAG_NOMOVE);
-}
-
-bool CHARACTER::IsNoMove() const
-{
-	return IS_SET(m_pointsInstant.dwAIFlag, AIFLAG_NOMOVE);
-}
-
 // STATE_IDLE_REFACTORING
 void CHARACTER::StateIdle()
 {
@@ -422,9 +404,7 @@
 	if (GetMaxHP() >= 0)
 		iPercent = (GetHP() * 100) / GetMaxHP();
 
-	const DWORD dwVnum = number(MIN(GetMobTable().sAttackSpeed, GetMobTable().sMovingSpeed), MAX(GetMobTable().sAttackSpeed, GetMobTable().sMovingSpeed));
-	if (dwVnum == 0)
-		return;
+	DWORD dwVnum = number(MIN(GetMobTable().sAttackSpeed, GetMobTable().sMovingSpeed), MAX(GetMobTable().sAttackSpeed, GetMobTable().sMovingSpeed));
 
 	if (iPercent <= 10 && GetMaxSP() < 10)
 	{
@@ -540,18 +520,11 @@
 	MonsterChat(MONSTER_CHAT_WAIT);
 	m_dwStateDuration = PASSES_PER_SEC(5);
 
-#if defined(__PET_SYSTEM__)
 	//  ý Idle ó     ĳ͵ ؼ ϴ ¸ӽ ƴ CPetActor::Update ó.
-	if (IsPet())
-		return;
-#endif
-
-#if defined(__GROWTH_PET_SYSTEM__)
-	if (IsGrowthPet())
+	if (IsPet() || IsGrowthPet())
 		return;
-#endif
 
-	if (IsGuardNPC())
+	else if (IsGuardNPC())
 	{
 		if (!quest::CQuestManager::instance().GetEventFlag("noguard"))
 		{
@@ -573,8 +546,7 @@
 	}
 	else
 	{
-#if defined(__XMAS_EVENT_2008__)
-		if (GetRaceNum() == xmas::MOB_XMAS_SANTA_VNUM) // Ÿ
+		if (GetRaceNum() == xmas::MOB_SANTA_VNUM) // Ÿ
 		{
 			if (get_dword_time() > m_dwPlayStartTime)
 			{
@@ -590,15 +562,15 @@
 				*/
 				// ż ؿ
 				const int WARP_MAP_INDEX_NUM = 7;
-				static const long c_lWarpMapIndexs[WARP_MAP_INDEX_NUM] = { MAP_N_SNOWM_01, MAP_N_FLAME_01, MAP_N_DESERT_01, MAP_N_THREEWAY, MAP_A3, MAP_B3, MAP_C3 };
-				long lNextMapIndex = c_lWarpMapIndexs[number(1, WARP_MAP_INDEX_NUM) - 1];
+				static const long c_lWarpMapIndexs[WARP_MAP_INDEX_NUM] = { 61, 62, 63, 64, 3, 23, 43 };
+				long lNextMapIndex;
+				lNextMapIndex = c_lWarpMapIndexs[number(1, WARP_MAP_INDEX_NUM) - 1];
 
 				if (map_allow_find(lNextMapIndex))
 				{
 					// ̰Դϴ.
 					M2_DESTROY_CHARACTER(this);
-
-					int iNextSpawnDelay = 1;
+					int iNextSpawnDelay = 0;
 					if (LC_IsYMIR())
 						iNextSpawnDelay = 20 * 60;
 					else
@@ -618,9 +590,8 @@
 				return;
 			}
 		}
-#endif
 
-		if (!IsNoMove())
+		if (!IS_SET(m_pointsInstant.dwAIFlag, AIFLAG_NOMOVE))
 		{
 			//
 			//     ̵Ѵ.
@@ -702,18 +673,16 @@
 		{
 			victim = m_pkChrStone->GetNearestVictim(m_pkChrStone);
 		}
+		//   ó
 		else if (!no_wander && IsAggressive())
 		{
-#if defined(__XMAS_EVENT_2008__)
-			if (GetMapIndex() == MAP_N_SNOWM_01 && quest::CQuestManager::instance().GetEventFlag("xmas_tree"));
+			if (GetMapIndex() == 61 && quest::CQuestManager::instance().GetEventFlag("xmas_tree"));
 			// ѻ꿡   ʴ´.
 			else
-#endif
 			{
 				victim = FindVictim(this, m_pkMobData->m_table.wAggressiveSight);
-
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-				if (CGuildDragonLairManager::Instance().IsKing(GetRaceNum()))
+#if defined(__GUILD_DRAGONLAIR__)
+				if ((!victim) && (GetRaceNum() == (WORD)(MeleyLair::BOSS_VNUM)))
 					victim = FindVictim(this, 40000);
 #endif
 			}
@@ -751,7 +720,7 @@
 	//
 	// ׳ Դٸ ٸ Ѵ.
 	//
-	if (!no_wander && !IsNoMove())
+	if (!no_wander && !IS_SET(m_pointsInstant.dwAIFlag, AIFLAG_NOMOVE))
 	{
 		if (!number(0, 6))
 		{
@@ -767,20 +736,14 @@
 				&& SECTREE_MANAGER::instance().IsMovablePosition(GetMapIndex(), GetX() + (int)fx / 2, GetY() + (int)fy / 2)))
 				return;
 
-			// NOTE: When a monster wanders around in IDLE state, it currently runs unconditionally. (Never walk)
-			// The graphics team wants to see the monsters walking, so they temporarily walk or run with a certain probability.
+			// NOTE: Ͱ IDLE ¿ ֺ Ÿ ,   پ Ǿ . (  )
+			// ׷  Ͱ ȴ  ʹٰ ؼ ӽ÷ ƯȮ Ȱų ٰ . (   Ʋ  ϴ ׽Ʈ 忡 ۵)
+			if (g_test_server)
 			{
-				// Aggressive monsters will always run.
-				if (IsAggressive())
+				if (number(0, 100) < 60)
 					SetNowWalking(false);
 				else
-				{
-					// Given the probability, monsters will walk or run depending on their fight state.
-					if ((number(0, 100) < 60) || CanFight())
-						SetNowWalking(false);
-					else
-						SetNowWalking(true);
-				}
+					SetNowWalking(true);
 			}
 
 			if (Goto(GetX() + (int)fx, GetY() + (int)fy))
@@ -796,22 +759,22 @@
 
 bool __CHARACTER_GotoNearTarget(LPCHARACTER self, LPCHARACTER victim)
 {
-	if (self->IsNoMove())
+	if (IS_SET(self->GetAIFlag(), AIFLAG_NOMOVE))
 		return false;
 
 	switch (self->GetMobBattleType())
 	{
-		case BATTLE_TYPE_RANGE:
-		case BATTLE_TYPE_MAGIC:
-			// 糪 ü  Ÿ 80%   Ѵ.
-			if (self->Follow(victim, self->GetMobAttackRange() * 8 / 10))
-				return true;
-			break;
-
-		default:
-			//  90%?
-			if (self->Follow(victim, self->GetMobAttackRange() * 9 / 10))
-				return true;
+	case BATTLE_TYPE_RANGE:
+	case BATTLE_TYPE_MAGIC:
+		// 糪 ü  Ÿ 80%   Ѵ.
+		if (self->Follow(victim, self->GetMobAttackRange() * 8 / 10))
+			return true;
+		break;
+
+	default:
+		//  90%?
+		if (self->Follow(victim, self->GetMobAttackRange() * 9 / 10))
+			return true;
 	}
 
 	return false;
@@ -819,17 +782,14 @@
 
 void CHARACTER::StateMove()
 {
-	float fRate = 1.0f;
-	
-	const DWORD dwElapsedTime = get_dword_time() - m_dwMoveStartTime;
-	if (dwElapsedTime != 0 && m_dwMoveStartTime != 0)
-		fRate = static_cast<float>(dwElapsedTime) / static_cast<float>(m_dwMoveDuration);
+	DWORD dwElapsedTime = get_dword_time() - m_dwMoveStartTime;
+	float fRate = (float)dwElapsedTime / (float)m_dwMoveDuration;
 
 	if (fRate > 1.0f)
 		fRate = 1.0f;
 
-	const int x = static_cast<int>(static_cast<float>(m_posDest.x - m_posStart.x) * fRate + m_posStart.x);
-	const int y = static_cast<int>(static_cast<float>(m_posDest.y - m_posStart.y) * fRate + m_posStart.y);
+	int x = (int)((float)(m_posDest.x - m_posStart.x) * fRate + m_posStart.x);
+	int y = (int)((float)(m_posDest.y - m_posStart.y) * fRate + m_posStart.y);
 
 	Move(x, y);
 
@@ -839,8 +799,8 @@
 
 		if (GetExchange())
 		{
-			const LPCHARACTER& victim = GetExchange()->GetCompany()->GetOwner();
-			const int iDist = DISTANCE_APPROX(GetX() - victim->GetX(), GetY() - victim->GetY());
+			LPCHARACTER victim = GetExchange()->GetCompany()->GetOwner();
+			int iDist = DISTANCE_APPROX(GetX() - victim->GetX(), GetY() - victim->GetY());
 
 			// Ÿ üũ
 			if (iDist >= EXCHANGE_MAX_DISTANCE)
@@ -862,7 +822,6 @@
 
 		//  ̸鼭 ٴ ̸
 		if (!IsWalking() && !IsRiding())
-		{
 			if ((get_dword_time() - GetLastAttackTime()) < 20000)
 			{
 				StartAffectEvent();
@@ -883,7 +842,6 @@
 			{
 				StopStaminaConsume();
 			}
-		}
 	}
 	else
 	{
@@ -913,16 +871,13 @@
 				GetDeltaByDegree(victim->GetRotation(), 400, &fx, &fy);
 				long new_x = victim->GetX() + (long)fx;
 				long new_y = victim->GetY() + (long)fy;
-				if (!IsInSafezone())
-				{
-					SetRotation(GetDegreeFromPositionXY(new_x, new_y, victim->GetX(), victim->GetY()));
-					Show(victim->GetMapIndex(), new_x, new_y, 0, true);
-					GotoState(m_stateBattle);
-					m_dwStateDuration = 1;
-					ResetMobSkillCooltime();
-					m_pkMobInst->m_dwLastWarpTime = get_dword_time();
-					return;
-				}
+				SetRotation(GetDegreeFromPositionXY(new_x, new_y, victim->GetX(), victim->GetY()));
+				Show(victim->GetMapIndex(), new_x, new_y, 0, true);
+				GotoState(m_stateBattle);
+				m_dwStateDuration = 1;
+				ResetMobSkillCooltime();
+				m_pkMobInst->m_dwLastWarpTime = get_dword_time();
+				return;
 			}
 
 			// TODO ȯ ؼ  ٺ !
@@ -1011,8 +966,8 @@
 		{
 			LPCHARACTER new_victim = FindVictim(this, m_pkMobData->m_table.wAggressiveSight);
 
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-			if (CGuildDragonLairManager::Instance().IsKing(GetRaceNum()))
+#if defined(__GUILD_DRAGONLAIR__)
+			if ((!new_victim) && (GetRaceNum() == (WORD)(MeleyLair::BOSS_VNUM)))
 				new_victim = FindVictim(this, 40000);
 #endif
 
@@ -1021,44 +976,39 @@
 
 			if (!new_victim)
 			{
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-				if (CGuildDragonLairManager::Instance().IsKing(GetRaceNum()))
-					return;
-#endif
-
 				switch (GetMobBattleType())
 				{
-					case BATTLE_TYPE_MELEE:
-					case BATTLE_TYPE_SUPER_POWER:
-					case BATTLE_TYPE_SUPER_TANKER:
-					case BATTLE_TYPE_POWER:
-					case BATTLE_TYPE_TANKER:
-					{
-						float fx, fy;
-						float fDist = number(400, 1500);
+				case BATTLE_TYPE_MELEE:
+				case BATTLE_TYPE_SUPER_POWER:
+				case BATTLE_TYPE_SUPER_TANKER:
+				case BATTLE_TYPE_POWER:
+				case BATTLE_TYPE_TANKER:
+				{
+					float fx, fy;
+					float fDist = number(400, 1500);
 
-						GetDeltaByDegree(number(0, 359), fDist, &fx, &fy);
+					GetDeltaByDegree(number(0, 359), fDist, &fx, &fy);
 
-						if (SECTREE_MANAGER::instance().IsMovablePosition(victim->GetMapIndex(),
-							victim->GetX() + (int)fx,
-							victim->GetY() + (int)fy) &&
-							SECTREE_MANAGER::instance().IsMovablePosition(victim->GetMapIndex(),
-								victim->GetX() + (int)fx / 2,
-								victim->GetY() + (int)fy / 2))
-						{
-							float dx = victim->GetX() + fx;
-							float dy = victim->GetY() + fy;
+					if (SECTREE_MANAGER::instance().IsMovablePosition(victim->GetMapIndex(),
+						victim->GetX() + (int)fx,
+						victim->GetY() + (int)fy) &&
+						SECTREE_MANAGER::instance().IsMovablePosition(victim->GetMapIndex(),
+							victim->GetX() + (int)fx / 2,
+							victim->GetY() + (int)fy / 2))
+					{
+						float dx = victim->GetX() + fx;
+						float dy = victim->GetY() + fy;
 
-							SetRotation(GetDegreeFromPosition(dx, dy));
+						SetRotation(GetDegreeFromPosition(dx, dy));
 
-							if (Goto((long)dx, (long)dy))
-							{
-								sys_log(0, "KILL_AND_GO: %s distance %.1f", GetName(), fDist);
-								SendMovePacket(FUNC_WAIT, 0, 0, 0, 0);
-							}
+						if (Goto((long)dx, (long)dy))
+						{
+							sys_log(0, "KILL_AND_GO: %s distance %.1f", GetName(), fDist);
+							SendMovePacket(FUNC_WAIT, 0, 0, 0, 0);
 						}
 					}
 				}
+				}
 			}
 			return;
 		}
@@ -1105,36 +1055,89 @@
 			else
 				MarkSummonedMonster();
 		}
-	}
 
-#if defined(__DAWNMIST_DUNGEON__)
-	if (CDawnMistDungeon::Instance().IsBoss(this))
-		if (!IsDead() && CDawnMistDungeon::Instance().CanSpawnHealerGroup(this))
-			CDawnMistDungeon::Instance().SpawnHealerGroup(this);
+#if defined(__EREBUS_DUNGEON__)
+		if (GetRaceNum() == THUNDER_BOSS)
+		{
+			if (pParty->CountMemberByVnum(THUNDER_HEALER) < SUMMON_HEALER_COUNT)
+			{
+				// ڶ ༮ ҷ äô.
+				int iPercent = GetMaxHP() >= 0 ? (GetHP() * 100) / GetMaxHP() : 0;
+
+				BYTE bRespawnCount = SUMMON_HEALER_COUNT - pParty->CountMemberByVnum(THUNDER_HEALER);
+				if (bRespawnCount > 0 && bRespawnCount <= SUMMON_HEALER_COUNT)
+				{
+					bool bSpawn = false;
+
+					for (const SErebusHealers& it : vErebusHealers)
+					{
+						if (iPercent < it.iHealthPCT && GetMaxStamina() == it.iStaminaPCT)
+						{
+							SetMaxStamina(GetMaxStamina() - 1);
+							bSpawn = true;
+							break;
+						}
+					}
+
+					if (bSpawn && (iPercent > 0 && iPercent < vErebusHealers.at(0).iHealthPCT))
+					{
+						for (BYTE bPos = 0; bPos < bRespawnCount; ++bPos)
+						{
+							LPCHARACTER pkHealer = CHARACTER_MANAGER::instance().SpawnMobRange(THUNDER_HEALER, GetMapIndex(),
+								dwHealerPos[bPos][0], dwHealerPos[bPos][1],
+								dwHealerPos[bPos][0], dwHealerPos[bPos][1],
+								true, true
+							);
+					
+							if (pkHealer)
+							{
+								pParty->Join(pkHealer->GetVID());
+								pParty->Link(pkHealer);
+							}
+						}
+					}
+
+					m_iLastHealerSummonDelay = bSpawn ? thecore_pulse() + PASSES_PER_SEC(3) : 0;
+				}
+			}
+		}
 #endif
+	}
 
 	LPCHARACTER pkChrProtege = GetProtege();
 
 	float fDist = DISTANCE_APPROX(GetX() - victim->GetX(), GetY() - victim->GetY());
+
 	if (fDist >= 4000.0f) // 40 ̻ ־ 
 	{
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-		if (CGuildDragonLairManager::Instance().IsKing(GetRaceNum()) && fDist < 16000.0f) { /* continue */ }
-		else
-#else
+#if defined(__GUILD_DRAGONLAIR__)
+		bool bPass = true;
+		if (GetRaceNum() == (WORD)(MeleyLair::BOSS_VNUM) && (fDist < 16000))
+			bPass = false;
+
 		if (bPass)
-#endif
 		{
 			MonsterLog("Ÿ ־ ");
 			SetVictim(NULL);
 
 			// ȣ (, Ƽ) ֺ .
-			if (pkChrProtege && !pkChrProtege->IsInSafezone())
+			if (pkChrProtege)
 				if (DISTANCE_APPROX(GetX() - pkChrProtege->GetX(), GetY() - pkChrProtege->GetY()) > 1000)
-					Follow(pkChrProtege, (float)number(150, 400));
+					Follow(pkChrProtege, number(150, 400));
 
 			return;
 		}
+#else
+		MonsterLog("Ÿ ־ ");
+		SetVictim(NULL);
+
+		// ȣ (, Ƽ) ֺ .
+		if (pkChrProtege && !pkChrProtege->IsInSafezone())
+			if (DISTANCE_APPROX(GetX() - pkChrProtege->GetX(), GetY() - pkChrProtege->GetY()) > 1000)
+				Follow(pkChrProtege, (float)number(150, 400));
+
+		return;
+#endif
 	}
 
 	if (fDist >= (GetMobAttackRange() * 1.15) && !victim->IsInSafezone())
@@ -1146,11 +1149,7 @@
 	if (m_pkParty)
 		m_pkParty->SendMessage(this, PM_ATTACKED_BY, 0, 0);
 
-#if defined(__BLUE_DRAGON_RENEWAL__)
-	if (BlueDragon_IsBoss(m_pkMobData->m_table.dwVnum))
-#else
-	if (BlueDragon::BossVnum == m_pkMobData->m_table.dwVnum)
-#endif
+	if (2493 == m_pkMobData->m_table.dwVnum)
 	{
 		// (2493) Ư ó
 		m_dwStateDuration = BlueDragon_StateBattle(this);
@@ -1187,13 +1186,15 @@
 			{
 				if (CanUseMobSkill(iSkillIdx))
 				{
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-					if (CGuildDragonLairManager::Instance().IsKing(GetRaceNum()) && GetGuildDragonLair())
-						SetRotationToXY(GetGuildDragonLair()->GetCenterX(), GetGuildDragonLair()->GetCenterY());
-					else
-						SetRotationToXY(victim->GetX(), victim->GetY());
-#else
 					SetRotationToXY(victim->GetX(), victim->GetY());
+
+#if defined(__GUILD_DRAGONLAIR__)
+					if ((GetRaceNum() == (WORD)(MeleyLair::BOSS_VNUM)) && (MeleyLair::CMgr::instance().IsMeleyMap(victim->GetMapIndex())))
+					{
+						PIXEL_POSITION pos = MeleyLair::CMgr::instance().GetXYZ();
+						if (pos.x)
+							SetRotationToXY(pos.x, pos.y);
+					}
 #endif
 
 					if (UseMobSkill(iSkillIdx))
@@ -1259,7 +1260,7 @@
 
 	pMap->RemoveFlag(idx);
 
-	snprintf(buf, sizeof(buf), LC_STRING("%s   %s  ȹϿϴ.", pMap->GetGuild(idx)->GetName(), f.m_pkChrFind->GetName()));
+	snprintf(buf, sizeof(buf), LC_TEXT("%s   %s  ȹϿϴ."), pMap->GetGuild(idx)->GetName(), f.m_pkChrFind->GetName());
 	pMap->Notice(buf);
 }
 
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/cmd.cpp final/server/server/home/metin2/Source/Server/game/src/cmd.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/cmd.cpp	2025-06-28 20:31:06.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/cmd.cpp	2022-04-27 12:17:27.000000000 +0000
@@ -20,7 +20,6 @@
 
 ACMD(do_poison);
 ACMD(do_bleeding);
-ACMD(do_fire);
 
 ACMD(do_warp);
 ACMD(do_goto);
@@ -42,9 +41,7 @@
 ACMD(do_disconnect);
 ACMD(do_kill);
 ACMD(do_emotion_allow);
-ACMD(do_emotion_play);
-ACMD(do_emoticon);
-//ACMD(do_emotion);
+ACMD(do_emotion);
 ACMD(do_transfer);
 ACMD(do_set);
 ACMD(do_cmd);
@@ -88,10 +85,6 @@
 ACMD(do_invisibility);
 ACMD(do_event_flag);
 ACMD(do_get_event_flag);
-#if defined(__GUILD_EVENT_FLAG__) //&& defined(__GUILD_RENEWAL__)
-ACMD(do_guild_event_flag);
-ACMD(do_get_guild_event_flag);
-#endif
 ACMD(do_private);
 ACMD(do_qf);
 ACMD(do_clear_quest);
@@ -173,7 +166,6 @@
 
 ACMD(do_save_attribute_to_image);
 ACMD(do_affect_remove);
-ACMD(do_affect_add);
 
 ACMD(do_change_attr);
 ACMD(do_add_attr);
@@ -181,7 +173,7 @@
 
 ACMD(do_inputall)
 {
-	ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ɾ  Էϼ."));
+	ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ɾ  Էϼ."));
 }
 
 ACMD(do_show_arena_list);
@@ -220,8 +212,12 @@
 ACMD(do_gift);
 // ť
 ACMD(do_inventory);
-#if !defined(__CUBE_RENEWAL__)
 ACMD(do_cube);
+#if defined(__MINI_GAME_OKEY__)
+ACMD(do_cards);
+#endif
+#if defined(__GEM_MARKET_SYSTEM__)
+ACMD(do_gem);
 #endif
 // 
 ACMD(do_siege);
@@ -236,9 +232,7 @@
 ACMD(do_eclipse);
 ACMD(do_weeklyevent);
 
-#if defined(__XMAS_EVENT_2008__)
 ACMD(do_event_helper);
-#endif
 
 ACMD(do_in_game_mall);
 
@@ -252,7 +246,6 @@
 ACMD(do_ride);
 ACMD(do_get_item_id_list);
 ACMD(do_set_socket);
-ACMD(do_get_socket);
 
 // ڽ º  
 ACMD(do_costume);
@@ -270,91 +263,49 @@
 ACMD(do_all_skill_master);
 //  . icon  Ŭ󿡼 Ȯ       .
 ACMD(do_use_item);
-#if defined(__DRAGON_SOUL_SYSTEM__)
 ACMD(do_dragon_soul);
 ACMD(do_ds_list);
-ACMD(do_ds_qualify);
-#endif
 ACMD(do_clear_affect);
 
 ACMD(do_kill_all);
 ACMD(do_drop_item);
 
-#if defined(__MOVE_CHANNEL__)
-ACMD(do_move_channel);
-#endif
-
-ACMD(do_transfer_force);
-ACMD(do_warp_force);
-ACMD(do_online);
-
-#if defined(__INGAME_EVENT_MANAGER__) && defined(__EVENT_BANNER_FLAG__)
-ACMD(do_banner);
-#endif
-
-#if defined(__POPUP_NOTICE__)
-ACMD(do_popup_notice_check);
-#endif
-
-#if defined(__MINI_GAME_RUMI__)
-ACMD(do_mini_game_okey);
-#endif
-#if defined(__MINI_GAME_YUTNORI__)
-ACMD(do_mini_game_yutnori);
-#endif
-#if defined(__FLOWER_EVENT__)
-ACMD(do_flower_event);
-#endif
-#if defined(__MINI_GAME_CATCH_KING__)
-ACMD(do_mini_game_catchking);
-#endif
-#if defined(__SUMMER_EVENT_ROULETTE__)
-ACMD(do_mini_game_roulette);
-#endif
-#if defined(__SNOWFLAKE_STICK_EVENT__)
-ACMD(do_snowflake_stick_event);
-#endif
-
-#if defined(__GAME_OPTION_ESCAPE__)
-ACMD(do_escape);
+#if defined(__SORT_INVENTORY_ITEMS__)
+ACMD(do_sort_inventory)
+{
+	ch->SortInventoryItems();
+}
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+ACMD(do_sort_special_inventory);
 #endif
-
-#if defined(__CHECK_PORT_STATUS__)
-ACMD(do_portstatus);
 #endif
 
 #if defined(__HIDE_COSTUME_SYSTEM__)
-ACMD(do_hide_costume_part);
+ACMD(do_hide_costume);
 #endif
 
-ACMD(do_loglevel);
-ACMD(do_clear_ground);
-ACMD(do_whisper_notice);
-
-#if defined(__DEFENSE_WAVE__)
-ACMD(do_dw_create);
+#if defined(__MOVE_CHANNEL__)
+ACMD(do_move_channel);
 #endif
 
-#if defined(__OFFLINE_SHOP__)
-ACMD(do_create_offline_shop);
-ACMD(do_cancel_opening_offline_shop);
-ACMD(do_open_offline_shop);
-ACMD(do_close_offline_shop);
-// ACMD(do_close_offline_shop_force);
-ACMD(do_sell_history);
-ACMD(do_deleteshop);
+#if defined(__MINI_GAME_CATCH_KING__)
+ACMD(do_catch_king_event);
 #endif
 
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-ACMD(do_battlepass_get_info);
-ACMD(do_battlepass_set_mission);
-ACMD(do_battlepass_premium_activate);
+ACMD(do_transfer_force);
+ACMD(do_warp_force);
+ACMD(do_online);
+
+#if defined(__EVENT_BANNER_FLAG__)
+ACMD(do_banner);
 #endif
 
 #ifdef __GROWTH_PET_SYSTEM__
-ACMD(do_pet_set);
+ACMD (do_pet_set);
 #endif
 
+ACMD(do_hwid_ban);
+
 struct command_info cmd_info[] =
 {
 	{ "!RESERVED!", NULL, 0, POS_DEAD, GM_IMPLEMENTOR }, /* ݵ   ó̾ Ѵ. */
@@ -376,11 +327,6 @@
 	{ "eventflag", do_event_flag, 0, POS_DEAD, GM_HIGH_WIZARD },
 	{ "geteventflag", do_get_event_flag, 0, POS_DEAD, GM_LOW_WIZARD },
 
-#if defined(__GUILD_EVENT_FLAG__) //&& defined(__GUILD_RENEWAL__)
-	{ "guild_event_flag", do_guild_event_flag, 0, POS_DEAD, GM_HIGH_WIZARD },
-	{ "get_guild_event_flag", do_get_guild_event_flag, 0, POS_DEAD, GM_LOW_WIZARD },
-#endif
-
 	{ "item", do_item, 0, POS_DEAD, GM_GOD },
 
 	{ "mob", do_mob, 0, POS_DEAD, GM_HIGH_WIZARD },
@@ -427,17 +373,12 @@
 	{ "mount", do_mount, 0, POS_MOUNTING, GM_PLAYER },
 	{ "restart_here", do_restart, SCMD_RESTART_HERE, POS_DEAD, GM_PLAYER },
 	{ "restart_town", do_restart, SCMD_RESTART_TOWN, POS_DEAD, GM_PLAYER },
-	{ "restart_immediately", do_restart, SCMD_RESTART_IMMEDIATE, POS_DEAD, GM_PLAYER },
-	{ "restart_giveup", do_restart, SCMD_RESTART_GIVEUP, POS_DEAD, GM_PLAYER },
 	{ "phase_selec", do_inputall, 0, POS_DEAD, GM_PLAYER },
 	{ "phase_select", do_cmd, SCMD_PHASE_SELECT, POS_DEAD, GM_PLAYER },
 	{ "qui", do_inputall, 0, POS_DEAD, GM_PLAYER },
 	{ "quit", do_cmd, SCMD_QUIT, POS_DEAD, GM_PLAYER },
 	{ "logou", do_inputall, 0, POS_DEAD, GM_PLAYER },
 	{ "logout", do_cmd, SCMD_LOGOUT, POS_DEAD, GM_PLAYER },
-#if defined(__LOCALE_CLIENT__)
-	{ "language_change", do_cmd, SCMD_LANGUAGE_CHANGE, POS_DEAD, GM_PLAYER },
-#endif
 	{ "skillup", do_skillup, 0, POS_DEAD, GM_PLAYER },
 	{ "gskillup", do_guildskillup, 0, POS_DEAD, GM_PLAYER },
 	{ "pvp", do_pvp, 0, POS_DEAD, GM_PLAYER },
@@ -520,7 +461,7 @@
 	{ "xmas_boom", do_xmas, SCMD_XMAS_BOOM, POS_DEAD, GM_HIGH_WIZARD },
 	{ "xmas_snow", do_xmas, SCMD_XMAS_SNOW, POS_DEAD, GM_HIGH_WIZARD },
 	{ "xmas_santa", do_xmas, SCMD_XMAS_SANTA, POS_DEAD, GM_HIGH_WIZARD },
-	{ "view_equip", do_view_equip, 0, POS_DEAD, GM_HIGH_WIZARD },
+	{ "view_equip", do_view_equip, 0, POS_DEAD, GM_PLAYER },
 	{ "jy", do_block_chat, 0, POS_DEAD, GM_HIGH_WIZARD },
 
 	// BLOCK_CHAT
@@ -533,7 +474,6 @@
 	{ "clear_land", do_clear_land, 0, POS_DEAD, GM_HIGH_WIZARD },
 
 	{ "affect_remove", do_affect_remove, 0, POS_DEAD, GM_LOW_WIZARD },
-	{ "affect_add", do_affect_add, 0, POS_DEAD, GM_LOW_WIZARD },
 
 	{ "horse_state", do_horse_state, 0, POS_DEAD, GM_HIGH_WIZARD },
 	{ "horse_level", do_horse_level, 0, POS_DEAD, GM_HIGH_WIZARD },
@@ -546,8 +486,39 @@
 	{ "pcbang_check", do_pcbang_check, 0, POS_DEAD, GM_LOW_WIZARD },
 
 	{ "emotion_allow", do_emotion_allow, 0, POS_FIGHTING, GM_PLAYER },
-	{ "emotion_play", do_emotion_play, 0, POS_FIGHTING, GM_PLAYER },
-	{ "emoticon", do_emoticon, 0, POS_FIGHTING, GM_PLAYER },
+	{ "kiss", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+	{ "slap", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+	{ "french_kiss", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+	{ "clap", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+	{ "cheer1", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+	{ "cheer2", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+
+	// DANCE
+	{ "dance1", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+	{ "dance2", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+	{ "dance3", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+	{ "dance4", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+	{ "dance5", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+	{ "dance6", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+	// END_OF_DANCE
+
+	{ "congratulation", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+	{ "forgive", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+	{ "angry", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+	{ "attractive", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+	{ "sad", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+	{ "shy", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+	{ "cheerup", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+	{ "banter", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+	{ "joy", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+
+#if defined(__EXPRESSING_EMOTIONS__)
+	{ "dance7", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+	{ "doze", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+	{ "exercise", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+	{ "pushup", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+	{ "selfie", do_emotion, 0, POS_FIGHTING, GM_PLAYER },
+#endif
 
 	{ "change_attr", do_change_attr, 0, POS_DEAD, GM_IMPLEMENTOR },
 	{ "add_attr", do_add_attr, 0, POS_DEAD, GM_IMPLEMENTOR },
@@ -588,8 +559,12 @@
 	{ "rmmonarch", do_rmmonarch, 0, POS_DEAD, GM_LOW_WIZARD},
 	{ "hair", do_hair, 0, POS_DEAD, GM_PLAYER },
 	{ "inventory", do_inventory, 0, POS_DEAD, GM_LOW_WIZARD },
-#if !defined(__CUBE_RENEWAL__)
 	{ "cube", do_cube, 0, POS_DEAD, GM_PLAYER },
+#if defined(__MINI_GAME_OKEY__)
+	{ "cards", do_cards, 0, POS_DEAD, GM_PLAYER },
+#endif
+#if defined(__GEM_MARKET_SYSTEM__)
+	{ "gem", do_gem, 0, POS_DEAD, GM_PLAYER },
 #endif
 	{ "siege", do_siege, 0, POS_DEAD, GM_LOW_WIZARD },
 	{ "temp", do_temp, 0, POS_DEAD, GM_IMPLEMENTOR },
@@ -605,9 +580,7 @@
 
 	{ "weeklyevent", do_weeklyevent, 0, POS_DEAD, GM_LOW_WIZARD },
 
-#if defined(__XMAS_EVENT_2008__)
 	{ "eventhelper", do_event_helper, 0, POS_DEAD, GM_HIGH_WIZARD },
-#endif
 
 	{ "in_game_mall", do_in_game_mall, 0, POS_DEAD, GM_PLAYER },
 
@@ -623,7 +596,6 @@
 
 	{ "item_id_list", do_get_item_id_list, 0, POS_DEAD, GM_LOW_WIZARD },
 	{ "set_socket", do_set_socket, 0, POS_DEAD, GM_LOW_WIZARD },
-	{ "get_socket", do_get_socket, 0, POS_DEAD, GM_LOW_WIZARD },
 
 	{ "costume", do_costume, 0, POS_DEAD, GM_PLAYER },
 
@@ -641,11 +613,8 @@
 	{ "all_skill_master", do_all_skill_master, 0, POS_DEAD, GM_LOW_WIZARD},
 	{ "use_item", do_use_item, 0, POS_DEAD, GM_LOW_WIZARD},
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
 	{ "dragon_soul", do_dragon_soul, 0, POS_DEAD, GM_PLAYER },
 	{ "ds_list", do_ds_list, 0, POS_DEAD, GM_PLAYER },
-	{ "ds_qualify", do_ds_qualify, 0, POS_DEAD, GM_HIGH_WIZARD },
-#endif
 	{ "do_clear_affect", do_clear_affect, 0, POS_DEAD, GM_LOW_WIZARD},
 
 	{ "kill_all", do_kill_all, 0, POS_DEAD, GM_HIGH_WIZARD },
@@ -653,87 +622,40 @@
 
 	{ "poison", do_poison, 0, POS_DEAD, GM_IMPLEMENTOR },
 	{ "bleeding", do_bleeding, 0, POS_DEAD, GM_IMPLEMENTOR },
-	{ "fire", do_fire, 0, POS_DEAD, GM_IMPLEMENTOR },
-
-#if defined(__MOVE_CHANNEL__)
-	{ "move_channel", do_move_channel, 0, POS_DEAD, GM_PLAYER },
-#endif
-
-	{ "warp_force", do_warp_force, 0, POS_DEAD, GM_LOW_WIZARD },
-	{ "transfer_force", do_transfer_force, 0, POS_DEAD, GM_LOW_WIZARD },
-	{ "online", do_online, 0, POS_DEAD, GM_LOW_WIZARD },
-
-#if defined(__INGAME_EVENT_MANAGER__) && defined(__EVENT_BANNER_FLAG__)
-	{ "banner", do_banner, 0, POS_DEAD, GM_IMPLEMENTOR },
-#endif
 
-#if defined(__POPUP_NOTICE__)
-	{ "popup_notice_check", do_popup_notice_check, 0, POS_DEAD, GM_PLAYER },
+#if defined(__SORT_INVENTORY_ITEMS__)
+	{ "sort_inventory", do_sort_inventory, 0, POS_DEAD, GM_PLAYER },
+	#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	{ "sort_special_inventory", do_sort_special_inventory, 0, POS_DEAD, GM_PLAYER },
+	#endif
 #endif
 
-#if defined(__MINI_GAME_RUMI__)
-	{ "mini_game_okey", do_mini_game_okey, 0, POS_DEAD, GM_IMPLEMENTOR },
-#endif
-	
-#if defined(__MINI_GAME_YUTNORI__)
-	{ "mini_game_yutnori", do_mini_game_yutnori, 0, POS_DEAD, GM_IMPLEMENTOR },
+#if defined(__HIDE_COSTUME_SYSTEM__)
+	{ "hide_costume", do_hide_costume, 0, POS_DEAD, GM_PLAYER },
 #endif
 
-#if defined(__FLOWER_EVENT__)
-	{ "flower_event", do_flower_event, 0, POS_DEAD, GM_IMPLEMENTOR },
+#if defined(__MOVE_CHANNEL__)
+	{ "move_channel", do_move_channel, 0, POS_DEAD, GM_PLAYER },
 #endif
 
 #if defined(__MINI_GAME_CATCH_KING__)
-	{ "mini_game_catchking", do_mini_game_catchking, 0, POS_DEAD, GM_IMPLEMENTOR },
+	{ "catch_king_event", do_catch_king_event, 0, POS_DEAD, GM_IMPLEMENTOR },
 #endif
 
-#if defined(__SUMMER_EVENT_ROULETTE__)
-	{ "mini_game_roulette", do_mini_game_roulette, 0, POS_DEAD, GM_IMPLEMENTOR },
-#endif
-
-#if defined(__SNOWFLAKE_STICK_EVENT__)
-	{ "snowflake_stick_event", do_snowflake_stick_event, 0, POS_DEAD, GM_IMPLEMENTOR },
-#endif
-
-#if defined(__GAME_OPTION_ESCAPE__)
-	{ "escape", do_escape, 0, POS_DEAD, GM_PLAYER },
-#endif
-
-#if defined(__CHECK_PORT_STATUS__)
-	{ "portstatus", do_portstatus, 0, POS_DEAD, GM_IMPLEMENTOR },
-#endif
-
-#if defined(__HIDE_COSTUME_SYSTEM__)
-	{ "hide_costume_part", do_hide_costume_part, 0, POS_DEAD, GM_PLAYER },
-#endif
-
-	{ "loglevel", do_loglevel, 0, POS_DEAD, GM_IMPLEMENTOR },
-	{ "clear_ground", do_clear_ground, 0, POS_DEAD, GM_IMPLEMENTOR },
-	{ "whisper_notice", do_whisper_notice, 0, POS_DEAD, GM_IMPLEMENTOR },
-
-#if defined(__DEFENSE_WAVE__)
-	{ "dw_create", do_dw_create, 0, POS_DEAD, GM_IMPLEMENTOR },
-#endif
-
-#if defined(__OFFLINE_SHOP__)
-	{ "create_offline_shop", do_create_offline_shop, 0, POS_DEAD, GM_PLAYER },
-	{ "cancel_opening_offline_shop", do_cancel_opening_offline_shop, 0, POS_DEAD, GM_PLAYER },
-	{ "open_offline_shop", do_open_offline_shop, 0, POS_DEAD, GM_PLAYER },
-	{ "close_offline_shop", do_close_offline_shop, 0, POS_DEAD, GM_PLAYER },
-	{ "sell_history",		do_sell_history,	0,	POS_DEAD,	GM_PLAYER	},
-	{ "delete_shop",			do_deleteshop,		0,		POS_DEAD,	GM_LOW_WIZARD },
-#endif
+	{ "warp_force", do_warp_force, 0, POS_DEAD, GM_LOW_WIZARD },
+	{ "transfer_force", do_transfer_force, 0, POS_DEAD, GM_LOW_WIZARD },
+	{ "online", do_online, 0, POS_DEAD, GM_LOW_WIZARD },
 
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	{ "battlepass_get_info",	do_battlepass_get_info,	0,	POS_DEAD,	RESTRICT_COMMAND_GET_INFO },
-	{ "battlepass_set_mission",	do_battlepass_set_mission,	0,	POS_DEAD,	RESTRICT_COMMAND_SET_MISSION },
-	{ "battlepass_premium_activate",	do_battlepass_premium_activate,	0,	POS_DEAD,	RESTRICT_COMMAND_PREMIUM_ACTIVATE },
+#if defined(__EVENT_BANNER_FLAG__)
+	{ "banner", do_banner, 0, POS_DEAD, GM_IMPLEMENTOR },
 #endif
 
 #ifdef __GROWTH_PET_SYSTEM__
-	{ "pet_set",			do_pet_set, 		0, POS_DEAD,		GM_IMPLEMENTOR },
+	{ "pet_set", do_pet_set, 0, POS_DEAD, GM_IMPLEMENTOR },
 #endif
 
+	{ "hwid_ban", do_hwid_ban, 0, POS_DEAD, GM_IMPLEMENTOR },
+
 	{ "\n", NULL, 0, POS_DEAD, GM_IMPLEMENTOR } /* ݵ   ̾ Ѵ. */
 };
 
@@ -788,7 +710,7 @@
 {
 	if (NULL == ch)
 	{
-		sys_err("NULL CHARACTER");
+		sys_err("NULL CHRACTER");
 		return;
 	}
 
@@ -821,24 +743,24 @@
 		switch (ch->GetPosition())
 		{
 		case POS_MOUNTING:
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ź ¿   ϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ź ¿   ϴ."));
 			break;
 
 		case POS_DEAD:
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ¿   ϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ¿   ϴ."));
 			break;
 
 		case POS_SLEEPING:
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("޼ӿ Կ?"));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("޼ӿ Կ?"));
 			break;
 
 		case POS_RESTING:
 		case POS_SITTING:
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" Ͼ ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" Ͼ ."));
 			break;
 			/*
 			case POS_FIGHTING:
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ɰ   Դϴ.  ϼ."));
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ɰ   Դϴ.  ϼ."));
 				break;
 			*/
 		default:
@@ -851,13 +773,13 @@
 
 	if (*cmd_info[icmd].command == '\n')
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("׷ ɾ ϴ"));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("׷ ɾ ϴ"));
 		return;
 	}
 
 	if (cmd_info[icmd].gm_level && cmd_info[icmd].gm_level > ch->GetGMLevel())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("׷ ɾ ϴ"));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("׷ ɾ ϴ"));
 		return;
 	}
 
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/cmd_general.cpp final/server/server/home/metin2/Source/Server/game/src/cmd_general.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/cmd_general.cpp	2025-06-27 01:16:34.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/cmd_general.cpp	2022-04-27 12:18:41.000000000 +0000
@@ -34,12 +34,6 @@
 #include "threeway_war.h"
 #include "log.h"
 #include "../../common/VnumHelper.h"
-#if defined(__OFFLINE_SHOP__)
-#include "OfflineShop.h"
-#endif
-#ifdef ENABLE_QUEEN_NETHIS
-#include "SnakeLair.h"
-#endif
 
 extern int g_server_id;
 
@@ -58,13 +52,13 @@
 		//  ƴ ٸŻ Ÿִ.
 		if (ch->GetMountVnum())
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("̹ Ż ̿Դϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ Ż ̿Դϴ."));
 			return;
 		}
 
 		if (ch->GetHorse() == NULL)
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("  ȯּ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ȯּ."));
 			return;
 		}
 
@@ -81,15 +75,15 @@
 	if (ch->GetHorse() != NULL)
 	{
 		ch->HorseSummon(false);
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ½ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ½ϴ."));
 	}
 	else if (ch->IsHorseRiding() == true)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("   մϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("   մϴ."));
 	}
 	else
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("  ȯּ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ȯּ."));
 	}
 }
 
@@ -102,26 +96,26 @@
 	if (!ch->GetHorse())
 	{
 		if (ch->IsHorseRiding() == false)
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("  ȯּ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ȯּ."));
 		else
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ź ¿ ̸   ϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ź ¿ ̸   ϴ."));
 		return;
 	}
 
 	DWORD dwFood = ch->GetHorseGrade() + 50054 - 1;
+	BYTE bLocale = ch->GetLanguage();
 
 	if (ch->CountSpecifyItem(dwFood) > 0)
 	{
 		ch->RemoveSpecifyItem(dwFood, 1);
 		ch->FeedHorse();
-
-		const char* c_szConv = under_han(ITEM_MANAGER::instance().GetTable(dwFood)->szLocaleName) ? LC_STRING("") : LC_STRING("");
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" %s%s ־ϴ.",
-			LC_ITEM(ITEM_MANAGER::instance().GetTable(dwFood)->dwVnum), c_szConv));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" %s%s ־ϴ."),
+			LC_LOCALE_ITEM_TEXT(dwFood, bLocale),
+			g_iUseLocale ? "" : under_han(LC_LOCALE_ITEM_TEXT(dwFood, bLocale)) ? LC_TEXT("") : LC_TEXT(""));
 	}
 	else
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s  ʿմϴ", LC_ITEM(ITEM_MANAGER::instance().GetTable(dwFood)->dwVnum)));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s  ʿմϴ"), LC_LOCALE_ITEM_TEXT(dwFood, bLocale));
 	}
 }
 
@@ -198,7 +192,7 @@
 	{
 		sys_log(0, "shutdown_event sec %d", *pSec);
 
-		if (--*pSec == -10)
+		if (-- * pSec == -10)
 		{
 			const DESC_MANAGER::DESC_SET& c_set_desc = DESC_MANAGER::instance().GetClientSet();
 			std::for_each(c_set_desc.begin(), c_set_desc.end(), DisconnectFunc());
@@ -214,16 +208,14 @@
 		const DESC_MANAGER::DESC_SET& c_set_desc = DESC_MANAGER::instance().GetClientSet();
 		std::for_each(c_set_desc.begin(), c_set_desc.end(), SendDisconnectFunc());
 		g_bNoMoreClient = true;
-		--*pSec;
+		--* pSec;
 		return passes_per_sec;
 	}
 	else
 	{
-		char buf[64];
-		snprintf(buf, sizeof(buf), LC_STRING("˴ٿ %d ҽϴ.", *pSec));
-		SendNotice(buf);
+		SendNotice(LC_TEXT("˴ٿ %d ҽϴ."), *pSec);
 
-		--*pSec;
+		--* pSec;
 		return passes_per_sec;
 	}
 }
@@ -238,10 +230,7 @@
 
 	CWarMapManager::instance().OnShutdown();
 
-	char buf[64];
-	snprintf(buf, sizeof(buf), LC_STRING("%d   ˴ٿ ˴ϴ.", iSec));
-
-	SendNotice(buf);
+	SendNotice(LC_TEXT("%d   ˴ٿ ˴ϴ."), iSec);
 
 	shutdown_event_data* info = AllocEventInfo<shutdown_event_data>();
 	info->seconds = iSec;
@@ -251,6 +240,10 @@
 
 ACMD(do_shutdown)
 {
+	if (NULL == ch)
+	{
+		sys_err("Accept shutdown command from %s.", ch->GetName());
+	}
 	TPacketGGShutdown p;
 	p.bHeader = HEADER_GG_SHUTDOWN;
 	P2P_MANAGER::instance().Send(&p, sizeof(TPacketGGShutdown));
@@ -283,64 +276,50 @@
 		{
 			switch (info->subcmd)
 			{
-				case SCMD_LOGOUT:
-				case SCMD_QUIT:
-				case SCMD_PHASE_SELECT:
-#if defined(__LOCALE_CLIENT__)
-				case SCMD_LANGUAGE_CHANGE:
-#endif
-				{
-					TPacketNeedLoginLogInfo acc_info;
-					acc_info.dwPlayerID = ch->GetDesc()->GetAccountTable().id;
-					db_clientdesc->DBPacket(HEADER_GD_VALID_LOGOUT, 0, &acc_info, sizeof(acc_info));
+			case SCMD_LOGOUT:
+			case SCMD_QUIT:
+			case SCMD_PHASE_SELECT:
+			{
+				TPacketNeedLoginLogInfo acc_info;
+				acc_info.dwPlayerID = ch->GetDesc()->GetAccountTable().id;
+				acc_info.bLanguage = ch->GetDesc()->GetAccountTable().bLanguage;
 
-					LogManager::instance().DetailLoginLog(false, ch);
-				}
-				break;
+				db_clientdesc->DBPacket(HEADER_GD_VALID_LOGOUT, 0, &acc_info, sizeof(acc_info));
+
+				LogManager::instance().DetailLoginLog(false, ch);
+			}
+			break;
 			}
 		}
 
 		switch (info->subcmd)
 		{
-			case SCMD_LOGOUT:
-				if (d)
-					d->SetPhase(PHASE_CLOSE);
-				break;
-
-			case SCMD_QUIT:
-				ch->ChatPacket(CHAT_TYPE_COMMAND, "quit");
-				break;
-
-			case SCMD_PHASE_SELECT:
-			{
-				ch->Disconnect("timed_event - SCMD_PHASE_SELECT");
+		case SCMD_LOGOUT:
+			if (d)
+				d->SetPhase(PHASE_CLOSE);
+			break;
 
-				if (d)
-				{
-					d->SetPhase(PHASE_SELECT);
-				}
-			}
+		case SCMD_QUIT:
+			ch->ChatPacket(CHAT_TYPE_COMMAND, "quit");
 			break;
 
-#if defined(__LOCALE_CLIENT__)
-			case SCMD_LANGUAGE_CHANGE:
-			{
-				ch->ChatPacket(CHAT_TYPE_COMMAND, "language_change");
-				ch->Disconnect("timed_event - SCMD_LANGUAGE_CHANGE");
+		case SCMD_PHASE_SELECT:
+		{
+			ch->Disconnect("timed_event - SCMD_PHASE_SELECT");
 
-				if (d)
-					d->SetPhase(PHASE_SELECT);
+			if (d)
+			{
+				d->SetPhase(PHASE_SELECT);
 			}
-
-			break;
-#endif
+		}
+		break;
 		}
 
 		return 0;
 	}
 	else
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%d ҽϴ.", info->left_second));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%d ҽϴ."), info->left_second);
 		--info->left_second;
 	}
 
@@ -353,7 +332,7 @@
 	/*
 	if (ch->m_pkRecallEvent != NULL)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" Ǿϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" Ǿϴ."));
 		event_cancel(&ch->m_pkRecallEvent);
 		return;
 	}
@@ -362,27 +341,24 @@
 
 	if (ch->m_pkTimedEvent)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" Ǿϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" Ǿϴ."));
 		event_cancel(&ch->m_pkTimedEvent);
 		return;
 	}
 
 	switch (subcmd)
 	{
-		case SCMD_LOGOUT:
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("α ȭ  ϴ. ø ٸ."));
-			break;
+	case SCMD_LOGOUT:
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("α ȭ  ϴ. ø ٸ."));
+		break;
 
-		case SCMD_QUIT:
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("  մϴ. ø ٸ."));
-			break;
+	case SCMD_QUIT:
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  մϴ. ø ٸ."));
+		break;
 
-		case SCMD_PHASE_SELECT:
-#if defined(__LOCALE_CLIENT__)
-		case SCMD_LANGUAGE_CHANGE:
-#endif
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ĳ͸ ȯ մϴ. ø ٸ."));
-			break;
+	case SCMD_PHASE_SELECT:
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ĳ͸ ȯ մϴ. ø ٸ."));
+		break;
 	}
 
 	int nExitLimitTime = 10;
@@ -396,29 +372,26 @@
 
 	switch (subcmd)
 	{
-		case SCMD_LOGOUT:
-		case SCMD_QUIT:
-		case SCMD_PHASE_SELECT:
-#if defined(__LOCALE_CLIENT__)
-		case SCMD_LANGUAGE_CHANGE:
-#endif
-		{
-			TimedEventInfo* info = AllocEventInfo<TimedEventInfo>();
+	case SCMD_LOGOUT:
+	case SCMD_QUIT:
+	case SCMD_PHASE_SELECT:
+	{
+		TimedEventInfo* info = AllocEventInfo<TimedEventInfo>();
 
-			{
-				if (ch->IsPosition(POS_FIGHTING))
-					info->left_second = 10;
-				else
-					info->left_second = 3;
-			}
+		{
+			if (ch->IsPosition(POS_FIGHTING))
+				info->left_second = 10;
+			else
+				info->left_second = 3;
+		}
 
-			info->ch = ch;
-			info->subcmd = subcmd;
-			strlcpy(info->szReason, argument, sizeof(info->szReason));
+		info->ch = ch;
+		info->subcmd = subcmd;
+		strlcpy(info->szReason, argument, sizeof(info->szReason));
 
-			ch->m_pkTimedEvent = event_create(timed_event, info, 1);
-		}
-		break;
+		ch->m_pkTimedEvent = event_create(timed_event, info, 1);
+	}
+	break;
 	}
 }
 
@@ -446,7 +419,7 @@
 
 		if (distance > 600.0f)
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("    ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("    ."));
 			return;
 		}
 
@@ -463,7 +436,7 @@
 
 	if (!tch->IsNPC() || !tch->IsMountable())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ű⿡ Ż  ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ű⿡ Ż  ."));
 		return;
 	}
 
@@ -471,7 +444,7 @@
 
 	if (distance > 600.0f)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("    Ÿ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("    Ÿ."));
 		return;
 	}
 
@@ -501,7 +474,181 @@
 
 ACMD(do_restart)
 {
-	ch->Restart(subcmd);
+	if (false == ch->IsDead())
+	{
+		ch->ChatPacket(CHAT_TYPE_COMMAND, "CloseRestartWindow");
+		ch->StartRecoveryEvent();
+		return;
+	}
+
+	if (NULL == ch->m_pkDeadEvent)
+		return;
+
+	int iTimeToDead = (event_time(ch->m_pkDeadEvent) / passes_per_sec);
+
+	if (subcmd != SCMD_RESTART_TOWN && (!ch->GetWarMap() || ch->GetWarMap()->GetType() == GUILD_WAR_TYPE_FLAG))
+	{
+		if (!test_server)
+		{
+			if (ch->IsHack())
+			{
+				//  ϰ쿡 üũ  ʴ´.
+				if (false == CThreeWayWar::instance().IsSungZiMapIndex(ch->GetMapIndex()))
+				{
+					ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("    ϴ. (%d )"), iTimeToDead - (180 - g_nPortalLimitTime));
+					return;
+				}
+			}
+
+			if (iTimeToDead > 170)
+			{
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("    ϴ. (%d )"), iTimeToDead - 170);
+				return;
+			}
+		}
+	}
+
+	// PREVENT_HACK
+	// DESC : â, ȯ â  Ż ϴ ׿ ̿ɼ ־
+	// Ÿ ߰
+	if (subcmd == SCMD_RESTART_TOWN)
+	{
+		if (ch->IsHack())
+		{
+			// , ʿ üũ  ʴ´.
+			if ((!ch->GetWarMap() || ch->GetWarMap()->GetType() == GUILD_WAR_TYPE_FLAG) ||
+				false == CThreeWayWar::instance().IsSungZiMapIndex(ch->GetMapIndex()))
+			{
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("    ϴ. (%d )"), iTimeToDead - (180 - g_nPortalLimitTime));
+				return;
+			}
+		}
+
+		if (iTimeToDead > 173)
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("     ϴ. (%d  )"), iTimeToDead - 173);
+			return;
+		}
+	}
+	//END_PREVENT_HACK
+
+	ch->ChatPacket(CHAT_TYPE_COMMAND, "CloseRestartWindow");
+
+	ch->GetDesc()->SetPhase(PHASE_GAME);
+	ch->SetPosition(POS_STANDING);
+	ch->StartRecoveryEvent();
+
+	// FORKED_LOAD
+	// DESC: Ÿ  Ȱ Ұ  Ա ƴ Ÿ   ̵ϰ ȴ.
+	if (1 == quest::CQuestManager::instance().GetEventFlag("threeway_war"))
+	{
+		if (subcmd == SCMD_RESTART_TOWN || subcmd == SCMD_RESTART_HERE)
+		{
+			if (true == CThreeWayWar::instance().IsThreeWayWarMapIndex(ch->GetMapIndex()) &&
+				false == CThreeWayWar::instance().IsSungZiMapIndex(ch->GetMapIndex()))
+			{
+				ch->WarpSet(EMPIRE_START_X(ch->GetEmpire()), EMPIRE_START_Y(ch->GetEmpire()));
+
+				ch->ReviveInvisible(5);
+				ch->PointChange(POINT_HP, ch->GetMaxHP() - ch->GetHP());
+				ch->PointChange(POINT_SP, ch->GetMaxSP() - ch->GetSP());
+
+				return;
+			}
+
+			// 
+			if (true == CThreeWayWar::instance().IsSungZiMapIndex(ch->GetMapIndex()))
+			{
+				if (CThreeWayWar::instance().GetReviveTokenForPlayer(ch->GetPlayerID()) <= 0)
+				{
+					ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" Ȱ ȸ  Ҿϴ!  ̵մϴ!"));
+					ch->WarpSet(EMPIRE_START_X(ch->GetEmpire()), EMPIRE_START_Y(ch->GetEmpire()));
+				}
+				else
+				{
+					ch->Show(ch->GetMapIndex(), GetSungziStartX(ch->GetEmpire()), GetSungziStartY(ch->GetEmpire()));
+				}
+
+				ch->PointChange(POINT_HP, ch->GetMaxHP() - ch->GetHP());
+				ch->PointChange(POINT_SP, ch->GetMaxSP() - ch->GetSP());
+				ch->ReviveInvisible(5);
+
+				return;
+			}
+		}
+	}
+	// END_FORKED_LOAD
+
+	if (IS_MAZE_DUNGEON(ch->GetMapIndex()))
+	{
+		if (ch->WarpSet(1147800, 532600))
+			return;
+	}
+
+	if (ch->GetDungeon())
+		ch->GetDungeon()->UseRevive(ch);
+
+	if (ch->GetWarMap() && !ch->IsObserverMode())
+	{
+		CWarMap* pMap = ch->GetWarMap();
+		DWORD dwGuildOpponent = pMap ? pMap->GetGuildOpponent(ch) : 0;
+
+		if (dwGuildOpponent)
+		{
+			switch (subcmd)
+			{
+			case SCMD_RESTART_TOWN:
+				sys_log(0, "do_restart: restart town");
+				PIXEL_POSITION pos;
+
+				if (CWarMapManager::instance().GetStartPosition(ch->GetMapIndex(), ch->GetGuild()->GetID() < dwGuildOpponent ? 0 : 1, pos))
+					ch->Show(ch->GetMapIndex(), pos.x, pos.y);
+				else
+					ch->ExitToSavedLocation();
+
+				ch->PointChange(POINT_HP, ch->GetMaxHP() - ch->GetHP());
+				ch->PointChange(POINT_SP, ch->GetMaxSP() - ch->GetSP());
+				ch->ReviveInvisible(5);
+				break;
+
+			case SCMD_RESTART_HERE:
+				sys_log(0, "do_restart: restart here");
+				ch->RestartAtSamePos();
+				//ch->Show(ch->GetMapIndex(), ch->GetX(), ch->GetY());
+				ch->PointChange(POINT_HP, ch->GetMaxHP() - ch->GetHP());
+				ch->PointChange(POINT_SP, ch->GetMaxSP() - ch->GetSP());
+				ch->ReviveInvisible(5);
+				break;
+			}
+
+			return;
+		}
+	}
+
+	switch (subcmd)
+	{
+	case SCMD_RESTART_TOWN:
+		sys_log(0, "do_restart: restart town");
+		PIXEL_POSITION pos;
+
+		if (SECTREE_MANAGER::instance().GetRecallPositionByEmpire(ch->GetMapIndex(), ch->GetEmpire(), pos))
+			ch->WarpSet(pos.x, pos.y);
+		else
+			ch->WarpSet(EMPIRE_START_X(ch->GetEmpire()), EMPIRE_START_Y(ch->GetEmpire()));
+
+		ch->PointChange(POINT_HP, 50 - ch->GetHP());
+		ch->DeathPenalty(1);
+		break;
+
+	case SCMD_RESTART_HERE:
+		sys_log(0, "do_restart: restart here");
+		ch->RestartAtSamePos();
+		//ch->Show(ch->GetMapIndex(), ch->GetX(), ch->GetY());
+		ch->PointChange(POINT_HP, 50 - ch->GetHP());
+		ch->DeathPenalty(0);
+		ch->ReviveInvisible(5);
+		break;
+	}
 }
 
 ACMD(do_stat_reset)
@@ -519,7 +666,7 @@
 
 	if (ch->IsPolymorphed())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("а ߿ ɷ ø  ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("а ߿ ɷ ø  ϴ."));
 		return;
 	}
 
@@ -586,14 +733,14 @@
 
 	if (ch->IsPolymorphed())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("а ߿ ɷ ø  ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("а ߿ ɷ ø  ϴ."));
 		return;
 	}
 
 	if (ch->GetPoint(POINT_STAT) <= 0)
 		return;
 
-	POINT_TYPE idx = 0;
+	BYTE idx = 0;
 
 	if (!strcmp(arg1, "st"))
 		idx = POINT_ST;
@@ -638,14 +785,14 @@
 
 	if (ch->IsPolymorphed())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("а ߿ ɷ ø  ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("а ߿ ɷ ø  ϴ."));
 		return;
 	}
 
 	if (ch->GetPoint(POINT_CONQUEROR_POINT) <= 0)
 		return;
 
-	POINT_VALUE idx = 0;
+	BYTE idx = 0;
 	if (!strcmp(arg1, "sstr"))
 		idx = POINT_SUNGMA_STR;
 	else if (!strcmp(arg1, "shp"))
@@ -676,7 +823,7 @@
 {
 	if (ch->GetArena() != NULL || CArenaManager::instance().IsArenaMap(ch->GetMapIndex()) == true)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("忡 Ͻ  ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("忡 Ͻ  ϴ."));
 		return;
 	}
 
@@ -695,21 +842,21 @@
 		return;
 
 #if defined(__MESSENGER_BLOCK_SYSTEM__)
-	if (CMessengerManager::instance().IsBlocked(ch->GetName(), pkVictim->GetName()))
+	if (MessengerManager::instance().IsBlocked(ch->GetName(), pkVictim->GetName()))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Unblock %s to continue.", pkVictim->GetName()));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Unblock %s to continue."), pkVictim->GetName());
 		return;
 	}
-	else if (CMessengerManager::instance().IsBlocked(pkVictim->GetName(), ch->GetName()))
+	else if (MessengerManager::instance().IsBlocked(pkVictim->GetName(), ch->GetName()))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s has blocked you.", pkVictim->GetName()));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s has blocked you."), pkVictim->GetName());
 		return;
 	}
 #endif
 
 	if (pkVictim->GetArena() != NULL)
 	{
-		pkVictim->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" Դϴ."));
+		pkVictim->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" Դϴ."));
 		return;
 	}
 
@@ -726,7 +873,7 @@
 
 	if (!ch->GetGuild())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> 忡  ʽϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> 忡  ʽϴ."));
 		return;
 	}
 
@@ -740,7 +887,7 @@
 	}
 	else
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>  ų    ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>  ų    ϴ."));
 	}
 }
 
@@ -763,46 +910,45 @@
 	{
 		switch (vnum)
 		{
-			case SKILL_HORSE_WILDATTACK:
-			case SKILL_HORSE_CHARGE:
-			case SKILL_HORSE_ESCAPE:
-			case SKILL_HORSE_WILDATTACK_RANGE:
-
-			case SKILL_7_A_ANTI_TANHWAN:
-			case SKILL_7_B_ANTI_AMSEOP:
-			case SKILL_7_C_ANTI_SWAERYUNG:
-			case SKILL_7_D_ANTI_YONGBI:
-
-			case SKILL_8_A_ANTI_GIGONGCHAM:
-			case SKILL_8_B_ANTI_YEONSA:
-			case SKILL_8_C_ANTI_MAHWAN:
-			case SKILL_8_D_ANTI_BYEURAK:
-
-			case SKILL_ADD_HP:
-			case SKILL_RESIST_PENETRATE:
+		case SKILL_HORSE_WILDATTACK:
+		case SKILL_HORSE_CHARGE:
+		case SKILL_HORSE_ESCAPE:
+		case SKILL_HORSE_WILDATTACK_RANGE:
+
+		case SKILL_7_A_ANTI_TANHWAN:
+		case SKILL_7_B_ANTI_AMSEOP:
+		case SKILL_7_C_ANTI_SWAERYUNG:
+		case SKILL_7_D_ANTI_YONGBI:
+
+		case SKILL_8_A_ANTI_GIGONGCHAM:
+		case SKILL_8_B_ANTI_YEONSA:
+		case SKILL_8_C_ANTI_MAHWAN:
+		case SKILL_8_D_ANTI_BYEURAK:
 
+		case SKILL_ADD_HP:
+		case SKILL_RESIST_PENETRATE:
 #if defined(__7AND8TH_SKILLS__)
-			case SKILL_ANTI_PALBANG:
-			case SKILL_ANTI_AMSEOP:
-			case SKILL_ANTI_SWAERYUNG:
-			case SKILL_ANTI_YONGBI:
-			case SKILL_ANTI_GIGONGCHAM:
-			case SKILL_ANTI_HWAJO:
-			case SKILL_ANTI_MARYUNG:
-			case SKILL_ANTI_BYEURAK:
-			case SKILL_ANTI_SALPOONG:
-			case SKILL_HELP_PALBANG:
-			case SKILL_HELP_AMSEOP:
-			case SKILL_HELP_SWAERYUNG:
-			case SKILL_HELP_YONGBI:
-			case SKILL_HELP_GIGONGCHAM:
-			case SKILL_HELP_HWAJO:
-			case SKILL_HELP_MARYUNG:
-			case SKILL_HELP_BYEURAK:
-			case SKILL_HELP_SALPOONG:
+		case SKILL_ANTI_PALBANG:
+		case SKILL_ANTI_AMSEOP:
+		case SKILL_ANTI_SWAERYUNG:
+		case SKILL_ANTI_YONGBI:
+		case SKILL_ANTI_GIGONGCHAM:
+		case SKILL_ANTI_HWAJO:
+		case SKILL_ANTI_MARYUNG:
+		case SKILL_ANTI_BYEURAK:
+		case SKILL_ANTI_SALPOONG:
+		case SKILL_HELP_PALBANG:
+		case SKILL_HELP_AMSEOP:
+		case SKILL_HELP_SWAERYUNG:
+		case SKILL_HELP_YONGBI:
+		case SKILL_HELP_GIGONGCHAM:
+		case SKILL_HELP_HWAJO:
+		case SKILL_HELP_MARYUNG:
+		case SKILL_HELP_BYEURAK:
+		case SKILL_HELP_SALPOONG:
 #endif
-				ch->SkillLevelUp(vnum);
-				break;
+			ch->SkillLevelUp(vnum);
+			break;
 		}
 	}
 }
@@ -834,13 +980,13 @@
 
 	if (!*arg1 || strlen(arg1) > 6)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<â> ߸ ȣ Էϼ̽ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<â> ߸ ȣ Էϼ̽ϴ."));
 		return;
 	}
 
 	if (!*arg2 || strlen(arg2) > 6)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<â> ߸ ȣ Էϼ̽ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<â> ߸ ȣ Էϼ̽ϴ."));
 		return;
 	}
 
@@ -853,7 +999,7 @@
 
 			if (isalpha(arg2[i]) == false)
 			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<â> йȣ ڸ մϴ."));
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<â> йȣ ڸ մϴ."));
 				return;
 			}
 		}
@@ -875,7 +1021,7 @@
 
 	if (!*arg1 || strlen(arg1) > 6)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<â> ߸ ȣ Էϼ̽ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<â> ߸ ȣ Էϼ̽ϴ."));
 		return;
 	}
 
@@ -883,13 +1029,13 @@
 
 	if (ch->GetMall())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<â> â ̹ ֽϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<â> â ̹ ֽϴ."));
 		return;
 	}
 
 	if (iPulse - ch->GetMallLoadTime() < passes_per_sec * 10) // 10ʿ ѹ û 
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<â> â  10 ȿ   ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<â> â  10 ȿ   ϴ."));
 		return;
 	}
 
@@ -920,30 +1066,15 @@
 
 	if (!CPartyManager::instance().IsEnablePCParty())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>   Ƽ  ó   ϴ."));
-		return;
-	}
-
-	if (ch->GetDungeon()
-#if defined(__GUILD_DRAGONLAIR_PARTY_SYSTEM__)
-		|| ch->GetGuildDragonLair()
-#endif
-#if defined(__DEFENSE_WAVE__)
-		|| ch->GetDefenseWave()
-#endif
-		)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>  ȿ Ƽ   ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ>   Ƽ  ó   ϴ."));
 		return;
 	}
 
-#ifdef ENABLE_QUEEN_NETHIS
-	if (SnakeLair::CSnk::instance().IsSnakeMap(ch->GetMapIndex()))
+	if (ch->GetDungeon())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>  ȿ Ƽ   ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ>  ȿ Ƽ   ϴ."));
 		return;
 	}
-#endif
 
 	LPPARTY pParty = ch->GetParty();
 
@@ -954,7 +1085,7 @@
 	}
 	else
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> Ƽ ̽ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> Ƽ ̽ϴ."));
 		//pParty->SendPartyRemoveOneToAll(ch);
 		pParty->Quit(ch->GetPlayerID());
 		//pParty->SendPartyRemoveAllToOne(ch);
@@ -993,7 +1124,7 @@
 	//  üũѹ!
 	if (g->UnderAnyWar())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> ̹ ٸ ￡   Դϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> ̹ ٸ ￡   Դϴ."));
 		return;
 	}
 
@@ -1009,7 +1140,7 @@
 	{
 		str_to_number(type, arg2);
 
-		if (type < 0 || type >= GUILD_WAR_TYPE_MAX_NUM)
+		if (type >= GUILD_WAR_TYPE_MAX_NUM)
 			type = GUILD_WAR_TYPE_FIELD;
 	}
 
@@ -1019,7 +1150,7 @@
 	//  üũ( 常 )
 	if (gm_pid != ch->GetPlayerID())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>    ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>    ϴ."));
 		return;
 	}
 
@@ -1028,69 +1159,69 @@
 
 	if (!opp_g)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> ׷ 尡 ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> ׷ 尡 ϴ."));
 		return;
 	}
 
 	//   üũ
 	switch (g->GetGuildWarState(opp_g->GetID()))
 	{
-		case GUILD_WAR_NONE:
+	case GUILD_WAR_NONE:
+	{
+		if (opp_g->UnderAnyWar())
 		{
-			if (opp_g->UnderAnyWar())
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>  尡 ̹   Դϴ."));
-				return;
-			}
-
-			int iWarPrice = KOR_aGuildWarInfo[type].iWarPrice;
-
-			if (g->GetGuildMoney() < iWarPrice)
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>  Ͽ    ϴ."));
-				return;
-			}
-
-			if (opp_g->GetGuildMoney() < iWarPrice)
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>    Ͽ    ϴ."));
-				return;
-			}
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>  尡 ̹   Դϴ."));
+			return;
 		}
-		break;
 
-		case GUILD_WAR_SEND_DECLARE:
+		int iWarPrice = KOR_aGuildWarInfo[type].iWarPrice;
+
+		if (g->GetGuildMoney() < iWarPrice)
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("̹   Դϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>  Ͽ    ϴ."));
 			return;
 		}
-		break;
 
-		case GUILD_WAR_RECV_DECLARE:
+		if (opp_g->GetGuildMoney() < iWarPrice)
 		{
-			if (opp_g->UnderAnyWar())
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>  尡 ̹   Դϴ."));
-				g->RequestRefuseWar(opp_g->GetID());
-				return;
-			}
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>    Ͽ    ϴ."));
+			return;
 		}
-		break;
+	}
+	break;
+
+	case GUILD_WAR_SEND_DECLARE:
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹   Դϴ."));
+		return;
+	}
+	break;
 
-		case GUILD_WAR_RESERVE:
+	case GUILD_WAR_RECV_DECLARE:
+	{
+		if (opp_g->UnderAnyWar())
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> ̹    Դϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>  尡 ̹   Դϴ."));
+			g->RequestRefuseWar(opp_g->GetID());
 			return;
 		}
-		break;
+	}
+	break;
 
-		case GUILD_WAR_END:
-			return;
+	case GUILD_WAR_RESERVE:
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> ̹    Դϴ."));
+		return;
+	}
+	break;
 
-		default:
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> ̹   Դϴ."));
-			g->RequestRefuseWar(opp_g->GetID());
-			return;
+	case GUILD_WAR_END:
+		return;
+
+	default:
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> ̹   Դϴ."));
+		g->RequestRefuseWar(opp_g->GetID());
+		return;
 	}
 
 	if (!g->CanStartWar(type))
@@ -1098,12 +1229,12 @@
 		//    ִ  ʴ´.
 		if (g->GetLadderPoint() == 0)
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>   ڶ    ϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>   ڶ    ϴ."));
 			sys_log(0, "GuildWar.StartError.NEED_LADDER_POINT");
 		}
 		else if (g->GetMemberCount() < GUILD_WAR_MIN_MEMBER_COUNT)
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>  ϱ ؼ ּ %d ־ մϴ.", GUILD_WAR_MIN_MEMBER_COUNT));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>  ϱ ؼ ּ %d ־ մϴ."), GUILD_WAR_MIN_MEMBER_COUNT);
 			sys_log(0, "GuildWar.StartError.NEED_MINIMUM_MEMBER[%d]", GUILD_WAR_MIN_MEMBER_COUNT);
 		}
 		else
@@ -1117,9 +1248,9 @@
 	if (!opp_g->CanStartWar(GUILD_WAR_TYPE_FIELD))
 	{
 		if (opp_g->GetLadderPoint() == 0)
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>     ڶ    ϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>     ڶ    ϴ."));
 		else if (opp_g->GetMemberCount() < GUILD_WAR_MIN_MEMBER_COUNT)
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>     Ͽ    ϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>     Ͽ    ϴ."));
 		return;
 	}
 
@@ -1133,7 +1264,7 @@
 		if (pCCI != NULL)
 			break;
 
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>     ƴմϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>     ƴմϴ."));
 		g->RequestRefuseWar(opp_g->GetID());
 		return;
 
@@ -1149,7 +1280,7 @@
 		if (pCCI != NULL)
 			break;
 
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>     ƴմϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>     ƴմϴ."));
 		g->RequestRefuseWar(opp_g->GetID());
 		return;
 
@@ -1174,7 +1305,7 @@
 
 	if (gm_pid != ch->GetPlayerID())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>    ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>    ϴ."));
 		return;
 	}
 
@@ -1182,7 +1313,7 @@
 
 	if (!opp_g)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> ׷ 尡 ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> ׷ 尡 ϴ."));
 		return;
 	}
 
@@ -1223,7 +1354,7 @@
 {
 	if (ch->GetArena())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("忡 Ͻ  ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("忡 Ͻ  ϴ."));
 		return;
 	}
 
@@ -1240,10 +1371,10 @@
 		LPCHARACTER tch = CHARACTER_MANAGER::instance().FindPC(arg2);
 
 		if (tch)
-			tch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s   ģ  ź ߽ϴ.", ch->GetName()));
+			tch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s   ģ  ź ߽ϴ."), ch->GetName());
 	}
 
-	CMessengerManager::instance().AuthToAdd(ch->GetName(), arg2, answer == 'y' ? false : true); // DENY
+	MessengerManager::instance().AuthToAdd(ch->GetName(), arg2, answer == 'y' ? false : true); // DENY
 }
 
 ACMD(do_setblockmode)
@@ -1292,47 +1423,66 @@
 		}
 		ch->SetObserverMode(false);
 	}
-#ifdef ENABLE_QUEEN_NETHIS
-	if (ch->IsSnakeMap())
+}
+
+ACMD(do_view_equip)
+{
+	if (ch->GetGMLevel() <= GM_PLAYER)
+		return;
+
+	char arg1[256];
+	one_argument(argument, arg1, sizeof(arg1));
+
+	if (*arg1)
 	{
-		switch (subcmd)
-		{
-			case SCMD_RESTART_TOWN:
-				sys_log(0, "do_restart: restart town");
-				PIXEL_POSITION pos;
+		DWORD vid = 0;
+		str_to_number(vid, arg1);
+		LPCHARACTER tch = CHARACTER_MANAGER::instance().Find(vid);
 
-				ch->RestartAtSamePos();
+		if (!tch)
+			return;
 
-				ch->PointChange(POINT_HP, ch->GetMaxHP() - ch->GetHP());
-				ch->PointChange(POINT_SP, ch->GetMaxSP() - ch->GetSP());
-				ch->ReviveInvisible(3);
-				break;
+		if (!tch->IsPC())
+			return;
 
-			case SCMD_RESTART_HERE:
-				sys_log(0, "do_restart: restart here");
-				ch->RestartAtSamePos();
-				ch->PointChange(POINT_HP, ch->GetMaxHP() - ch->GetHP());
-				ch->PointChange(POINT_SP, ch->GetMaxSP() - ch->GetSP());
-				ch->ReviveInvisible(3);
-				break;
+#if defined(__MESSENGER_BLOCK_SYSTEM__)
+		if (MessengerManager::instance().IsBlocked(ch->GetName(), tch->GetName()))
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Unblock %s to continue."), tch->GetName());
+			return;
 		}
+		else if (MessengerManager::instance().IsBlocked(tch->GetName(), ch->GetName()))
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s has blocked you."), tch->GetName());
+			return;
+		}
+#endif
 
-		return;
+		/*
+		int iSPCost = ch->GetMaxSP() / 3;
+
+		if (ch->GetSP() < iSPCost)
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ŷ Ͽ ٸ     ϴ."));
+			return;
+		}
+		ch->PointChange(POINT_SP, -iSPCost);
+		*/
+		tch->SendEquipment(ch);
 	}
-#endif
 }
 
 ACMD(do_party_request)
 {
 	if (ch->GetArena())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("忡 Ͻ  ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("忡 Ͻ  ϴ."));
 		return;
 	}
 
 	if (ch->GetParty())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("̹ Ƽ  Ƿ Խû   ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ Ƽ  Ƿ Խû   ϴ."));
 		return;
 	}
 
@@ -1390,14 +1540,14 @@
 
 	if (!CMonarch::instance().IsMonarch(ch->GetPlayerID(), ch->GetEmpire()))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ָ   Դϴ"));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ָ   Դϴ"));
 		return;
 	}
 
 	// Ÿ ˻
 	if (!ch->IsMCOK(CHARACTER::MI_WARP))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%d ʰ Ÿ Դϴ.", ch->GetMCLTime(CHARACTER::MI_WARP)));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%d ʰ Ÿ Դϴ."), ch->GetMCLTime(CHARACTER::MI_WARP));
 		return;
 	}
 
@@ -1408,7 +1558,7 @@
 	if (!CMonarch::instance().IsMoneyOk(WarpPrice, ch->GetEmpire()))
 	{
 		int NationMoney = CMonarch::instance().GetMoney(ch->GetEmpire());
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("  մϴ.  : %u ʿݾ : %u", NationMoney, WarpPrice));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  մϴ.  : %u ʿݾ : %u"), NationMoney, WarpPrice);
 		return;
 	}
 
@@ -1419,7 +1569,7 @@
 
 	if (!*arg1)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(": warpto <character name>"));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(": warpto <character name>"));
 		return;
 	}
 
@@ -1433,18 +1583,18 @@
 		{
 			if (pkCCI->bEmpire != ch->GetEmpire())
 			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ÿ Դ ̵Ҽ ϴ"));
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ÿ Դ ̵Ҽ ϴ"));
 				return;
 			}
 
 			if (pkCCI->bChannel != g_bChannel)
 			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ش  %d äο ֽϴ. ( ä %d)", pkCCI->bChannel, g_bChannel));
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ش  %d äο ֽϴ. ( ä %d)"), pkCCI->bChannel, g_bChannel);
 				return;
 			}
 			if (!IsMonarchWarpZone(pkCCI->lMapIndex))
 			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ش  ̵  ϴ."));
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ش  ̵  ϴ."));
 				return;
 			}
 
@@ -1455,7 +1605,7 @@
 			else
 			{
 				//ch->ChatPacket(CHAT_TYPE_INFO, "You warp to (%d, %d)", pos.x, pos.y);
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s Է ̵մϴ", arg1));
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s Է ̵մϴ"), arg1);
 				ch->WarpSet(pos.x, pos.y);
 
 				//  谨
@@ -1476,19 +1626,19 @@
 	{
 		if (tch->GetEmpire() != ch->GetEmpire())
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ÿ Դ ̵Ҽ ϴ"));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ÿ Դ ̵Ҽ ϴ"));
 			return;
 		}
 		if (!IsMonarchWarpZone(tch->GetMapIndex()))
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ش  ̵  ϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ش  ̵  ϴ."));
 			return;
 		}
 		x = tch->GetX();
 		y = tch->GetY();
 	}
 
-	ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s Է ̵մϴ", arg1));
+	ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s Է ̵մϴ"), arg1);
 	ch->WarpSet(x, y);
 	ch->Stop();
 
@@ -1509,20 +1659,20 @@
 
 	if (!*arg1)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(": transfer <name>"));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(": transfer <name>"));
 		return;
 	}
 
 	if (!CMonarch::instance().IsMonarch(ch->GetPlayerID(), ch->GetEmpire()))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ָ   Դϴ"));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ָ   Դϴ"));
 		return;
 	}
 
 	// Ÿ ˻
 	if (!ch->IsMCOK(CHARACTER::MI_TRANSFER))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%d ʰ Ÿ Դϴ.", ch->GetMCLTime(CHARACTER::MI_TRANSFER)));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%d ʰ Ÿ Դϴ."), ch->GetMCLTime(CHARACTER::MI_TRANSFER));
 		return;
 	}
 
@@ -1533,7 +1683,7 @@
 	if (!CMonarch::instance().IsMoneyOk(WarpPrice, ch->GetEmpire()))
 	{
 		int NationMoney = CMonarch::instance().GetMoney(ch->GetEmpire());
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("  մϴ.  : %u ʿݾ : %u", NationMoney, WarpPrice));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  մϴ.  : %u ʿݾ : %u"), NationMoney, WarpPrice);
 		return;
 	}
 
@@ -1547,22 +1697,22 @@
 		{
 			if (pkCCI->bEmpire != ch->GetEmpire())
 			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ٸ   ȯ  ϴ."));
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ٸ   ȯ  ϴ."));
 				return;
 			}
 			if (pkCCI->bChannel != g_bChannel)
 			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s  %d äο   Դϴ. ( ä: %d)", arg1, pkCCI->bChannel, g_bChannel));
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s  %d äο   Դϴ. ( ä: %d)"), arg1, pkCCI->bChannel, g_bChannel);
 				return;
 			}
 			if (!IsMonarchWarpZone(pkCCI->lMapIndex))
 			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ش  ̵  ϴ."));
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ش  ̵  ϴ."));
 				return;
 			}
 			if (!IsMonarchWarpZone(ch->GetMapIndex()))
 			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ش  ȯ  ϴ."));
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ش  ȯ  ϴ."));
 				return;
 			}
 
@@ -1574,7 +1724,7 @@
 			pgg.lY = ch->GetY();
 
 			P2P_MANAGER::instance().Send(&pgg, sizeof(TPacketGGTransfer));
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s  ȯϿϴ.", arg1));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s  ȯϿϴ."), arg1);
 
 			//  谨
 			CMonarch::instance().SendtoDBDecMoney(WarpPrice, ch->GetEmpire(), ch);
@@ -1583,7 +1733,7 @@
 		}
 		else
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ԷϽ ̸  ڰ ϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ԷϽ ̸  ڰ ϴ."));
 		}
 
 		return;
@@ -1591,23 +1741,23 @@
 
 	if (ch == tch)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ڽ ȯ  ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڽ ȯ  ϴ."));
 		return;
 	}
 
 	if (tch->GetEmpire() != ch->GetEmpire())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ٸ   ȯ  ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ٸ   ȯ  ϴ."));
 		return;
 	}
 	if (!IsMonarchWarpZone(tch->GetMapIndex()))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ش  ̵  ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ش  ̵  ϴ."));
 		return;
 	}
 	if (!IsMonarchWarpZone(ch->GetMapIndex()))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ش  ȯ  ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ش  ȯ  ϴ."));
 		return;
 	}
 
@@ -1624,24 +1774,24 @@
 {
 	if (CMonarch::instance().IsMonarch(ch->GetPlayerID(), ch->GetEmpire()))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("  "));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  "));
 		TMonarchInfo* p = CMonarch::instance().GetMonarch();
 		for (int n = 1; n < 4; ++n)
 		{
 			if (n == ch->GetEmpire())
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("[%s] : %s  ݾ %lld ", EMPIRE_NAME(n), p->name[n], p->money[n]));
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("[%s] : %s  ݾ %lld "), EMPIRE_NAME(n), p->name[n], p->money[n]);
 			else
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("[%s] : %s  ", EMPIRE_NAME(n), p->name[n]));
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("[%s] : %s  "), EMPIRE_NAME(n), p->name[n]);
 
 		}
 	}
 	else
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" "));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" "));
 		TMonarchInfo* p = CMonarch::instance().GetMonarch();
 		for (int n = 1; n < 4; ++n)
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("[%s] : %s  ", EMPIRE_NAME(n), p->name[n]));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("[%s] : %s  "), EMPIRE_NAME(n), p->name[n]);
 
 		}
 	}
@@ -1693,7 +1843,7 @@
 	}
 };
 
-extern void BroadcastNotice(const char* c_pszBuf, const bool c_bBigFont);
+extern void BroadcastNotice(const char* c_pszBuf, bool bLocale);
 
 ACMD(do_monarch_tax)
 {
@@ -1709,7 +1859,7 @@
 	//  ˻
 	if (!ch->IsMonarch())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ָ Ҽ ִ Դϴ"));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ָ Ҽ ִ Դϴ"));
 		return;
 	}
 
@@ -1718,12 +1868,12 @@
 	str_to_number(tax, arg1);
 
 	if (tax < 1 || tax > 50)
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("1-50  ġ ּ"));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("1-50  ġ ּ"));
 
 	quest::CQuestManager::instance().SetEventFlag("trade_tax", tax);
 
 	// ֿ ޼ ϳ
-	ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" %d % Ǿϴ"));
+	ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" %d % Ǿϴ"));
 
 	//  
 	char szMsg[1024];
@@ -1772,7 +1922,7 @@
 
 	if (!ch->IsMonarch())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ָ Ҽ ִ Դϴ"));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ָ Ҽ ִ Դϴ"));
 		return;
 	}
 
@@ -1789,7 +1939,7 @@
 	{
 		if (mapEmpire != pcEmpire && mapEmpire != 0)
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ڱ 信   ִ Դϴ"));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڱ 信   ִ Դϴ"));
 			return;
 		}
 	}
@@ -1800,7 +1950,7 @@
 	//  Ÿ ˻
 	if (!ch->IsMCOK(CHARACTER::MI_SUMMON))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%d ʰ Ÿ Դϴ.", ch->GetMCLTime(CHARACTER::MI_SUMMON)));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%d ʰ Ÿ Դϴ."), ch->GetMCLTime(CHARACTER::MI_SUMMON));
 		return;
 	}
 
@@ -1808,11 +1958,11 @@
 	if (!CMonarch::instance().IsMoneyOk(SummonPrice, ch->GetEmpire()))
 	{
 		int NationMoney = CMonarch::instance().GetMoney(ch->GetEmpire());
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("  մϴ.  : %u ʿݾ : %u", NationMoney, SummonPrice));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  մϴ.  : %u ʿݾ : %u"), NationMoney, SummonPrice);
 		return;
 	}
 
-	const CMob* pkMob = nullptr;
+	const CMob* pkMob;
 	DWORD vnum = 0;
 
 	if (isdigit(*arg1))
@@ -1830,9 +1980,6 @@
 			vnum = pkMob->m_table.dwVnum;
 	}
 
-	if (pkMob == nullptr)
-		return;
-
 	DWORD count;
 
 	// ȯ   ˻
@@ -1842,7 +1989,7 @@
 
 	if (0 == cs_dwMonarchMobVnums[count])
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ȯҼ   Դϴ. ȯ ʹ Ȩ ϼ"));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ȯҼ   Դϴ. ȯ ʹ Ȩ ϼ"));
 		return;
 	}
 
@@ -1866,118 +2013,123 @@
 	}
 }
 
-static const char* FN_point_string(DWORD dwApplyType)
+static const char* FN_point_string(int apply_number)
 {
-	switch (dwApplyType)
+	switch (apply_number)
 	{
-		case POINT_MAX_HP: return LC_STRING("ִ  +%d");
-		case POINT_MAX_SP: return LC_STRING("ִ ŷ +%d");
-		case POINT_HT: return LC_STRING("ü +%d");
-		case POINT_IQ: return LC_STRING(" +%d");
-		case POINT_ST: return LC_STRING("ٷ +%d");
-		case POINT_DX: return LC_STRING("ø +%d");
-		case POINT_ATT_SPEED: return LC_STRING("ݼӵ +%d");
-		case POINT_MOV_SPEED: return LC_STRING("̵ӵ %d");
-		case POINT_CASTING_SPEED: return LC_STRING("Ÿ -%d");
-		case POINT_HP_REGEN: return LC_STRING(" ȸ +%d");
-		case POINT_SP_REGEN: return LC_STRING("ŷ ȸ +%d");
-		case POINT_POISON_PCT: return LC_STRING(" %d");
-		case POINT_BLEEDING_PCT: return LC_STRING(" %d");
-		case POINT_STUN_PCT: return LC_STRING(" +%d");
-		case POINT_SLOW_PCT: return LC_STRING("ο +%d");
-		case POINT_CRITICAL_PCT: return LC_STRING("%d%% Ȯ ġŸ ");
-		case POINT_RESIST_CRITICAL: return LC_STRING(" ġŸ Ȯ %d%% ");
-		case POINT_PENETRATE_PCT: return LC_STRING("%d%% Ȯ  ");
-		case POINT_RESIST_PENETRATE: return LC_STRING("   Ȯ %d%% ");
-		case POINT_ATTBONUS_HUMAN: return LC_STRING("ΰ  Ÿġ +%d%%");
-		case POINT_ATTBONUS_ANIMAL: return LC_STRING("  Ÿġ +%d%%");
-		case POINT_ATTBONUS_ORC: return LC_STRING(" Ÿġ +%d%%");
-		case POINT_ATTBONUS_MILGYO: return LC_STRING("б Ÿġ +%d%%");
-		case POINT_ATTBONUS_UNDEAD: return LC_STRING("ü Ÿġ +%d%%");
-		case POINT_ATTBONUS_DEVIL: return LC_STRING("Ǹ Ÿġ +%d%%");
-		case POINT_STEAL_HP: return LC_STRING("Ÿġ %d%%   ");
-		case POINT_STEAL_SP: return LC_STRING("Ÿġ %d%%  ŷ ");
-		case POINT_MANA_BURN_PCT: return LC_STRING("%d%% Ȯ Ÿݽ  ŷ Ҹ");
-		case POINT_DAMAGE_SP_RECOVER: return LC_STRING("%d%% Ȯ ؽ ŷ ȸ");
-		case POINT_BLOCK: return LC_STRING("Ÿݽ  Ȯ %d%%");
-		case POINT_DODGE: return LC_STRING("Ȱ  ȸ Ȯ %d%%");
-		case POINT_RESIST_SWORD: return LC_STRING("Ѽհ  %d%%");
-		case POINT_RESIST_TWOHAND: return LC_STRING("հ  %d%%");
-		case POINT_RESIST_DAGGER: return LC_STRING("μհ  %d%%");
-		case POINT_RESIST_BELL: return LC_STRING("  %d%%");
-		case POINT_RESIST_FAN: return LC_STRING("ä  %d%%");
-		case POINT_RESIST_BOW: return LC_STRING("Ȱ  %d%%");
-		case POINT_RESIST_CLAW: return LC_STRING("μհ  %d%%");
-		case POINT_RESIST_FIRE: return LC_STRING("ȭ  %d%%");
-		case POINT_RESIST_ELEC: return LC_STRING("  %d%%");
-		case POINT_RESIST_MAGIC: return LC_STRING("  %d%%");
+	case POINT_MAX_HP: return LC_TEXT("ִ  +%d");
+	case POINT_MAX_SP: return LC_TEXT("ִ ŷ +%d");
+	case POINT_HT: return LC_TEXT("ü +%d");
+	case POINT_IQ: return LC_TEXT(" +%d");
+	case POINT_ST: return LC_TEXT("ٷ +%d");
+	case POINT_DX: return LC_TEXT("ø +%d");
+	case POINT_ATT_SPEED: return LC_TEXT("ݼӵ +%d");
+	case POINT_MOV_SPEED: return LC_TEXT("̵ӵ %d");
+	case POINT_CASTING_SPEED: return LC_TEXT("Ÿ -%d");
+	case POINT_HP_REGEN: return LC_TEXT(" ȸ +%d");
+	case POINT_SP_REGEN: return LC_TEXT("ŷ ȸ +%d");
+	case POINT_POISON_PCT: return LC_TEXT(" %d");
+	case POINT_BLEEDING_PCT: return LC_TEXT(" %d");
+	case POINT_STUN_PCT: return LC_TEXT(" +%d");
+	case POINT_SLOW_PCT: return LC_TEXT("ο +%d");
+	case POINT_CRITICAL_PCT: return LC_TEXT("%d%% Ȯ ġŸ ");
+	case POINT_RESIST_CRITICAL: return LC_TEXT(" ġŸ Ȯ %d%% ");
+	case POINT_PENETRATE_PCT: return LC_TEXT("%d%% Ȯ  ");
+	case POINT_RESIST_PENETRATE: return LC_TEXT("   Ȯ %d%% ");
+	case POINT_ATTBONUS_HUMAN: return LC_TEXT("ΰ  Ÿġ +%d%%");
+	case POINT_ATTBONUS_ANIMAL: return LC_TEXT("  Ÿġ +%d%%");
+	case POINT_ATTBONUS_ORC: return LC_TEXT(" Ÿġ +%d%%");
+	case POINT_ATTBONUS_MILGYO: return LC_TEXT("б Ÿġ +%d%%");
+	case POINT_ATTBONUS_UNDEAD: return LC_TEXT("ü Ÿġ +%d%%");
+	case POINT_ATTBONUS_DEVIL: return LC_TEXT("Ǹ Ÿġ +%d%%");
+	case POINT_STEAL_HP: return LC_TEXT("Ÿġ %d%%   ");
+	case POINT_STEAL_SP: return LC_TEXT("Ÿġ %d%%  ŷ ");
+	case POINT_MANA_BURN_PCT: return LC_TEXT("%d%% Ȯ Ÿݽ  ŷ Ҹ");
+	case POINT_DAMAGE_SP_RECOVER: return LC_TEXT("%d%% Ȯ ؽ ŷ ȸ");
+	case POINT_BLOCK: return LC_TEXT("Ÿݽ  Ȯ %d%%");
+	case POINT_DODGE: return LC_TEXT("Ȱ  ȸ Ȯ %d%%");
+	case POINT_RESIST_SWORD: return LC_TEXT("Ѽհ  %d%%");
+	case POINT_RESIST_TWOHAND: return LC_TEXT("հ  %d%%");
+	case POINT_RESIST_DAGGER: return LC_TEXT("μհ  %d%%");
+	case POINT_RESIST_BELL: return LC_TEXT("  %d%%");
+	case POINT_RESIST_FAN: return LC_TEXT("ä  %d%%");
+	case POINT_RESIST_BOW: return LC_TEXT("Ȱ  %d%%");
+	case POINT_RESIST_CLAW: return LC_TEXT("μհ  %d%%");
+	case POINT_RESIST_FIRE: return LC_TEXT("ȭ  %d%%");
+	case POINT_RESIST_ELEC: return LC_TEXT("  %d%%");
+	case POINT_RESIST_MAGIC: return LC_TEXT("  %d%%");
 #if defined(__MAGIC_REDUCTION__)
-		case POINT_RESIST_MAGIC_REDUCTION:	return LC_STRING("  %d%%");
+	case POINT_RESIST_MAGIC_REDUCTION:	return LC_TEXT("  %d%%");
 #endif
-		case POINT_RESIST_WIND: return LC_STRING("ٶ  %d%%");
-		case POINT_RESIST_ICE: return LC_STRING("ñ  %d%%");
-		case POINT_RESIST_EARTH: return LC_STRING("  %d%%");
-		case POINT_RESIST_DARK: return LC_STRING("  %d%%");
-		case POINT_REFLECT_MELEE: return LC_STRING(" Ÿġ ݻ Ȯ : %d%%");
-		case POINT_REFLECT_CURSE: return LC_STRING(" ǵ Ȯ %d%%");
-		case POINT_POISON_REDUCE: return LC_STRING("  %d%%");
-		case POINT_BLEEDING_REDUCE:	return LC_STRING("  %d%%");
-		case POINT_KILL_SP_RECOVER: return LC_STRING("%d%% Ȯ ġ ŷ ȸ");
-		case POINT_EXP_DOUBLE_BONUS: return LC_STRING("%d%% Ȯ ġ ġ ߰ ");
-		case POINT_GOLD_DOUBLE_BONUS: return LC_STRING("%d%% Ȯ ġ  2 ");
-		case POINT_ITEM_DROP_BONUS: return LC_STRING("%d%% Ȯ ġ  2 ");
-		case POINT_POTION_BONUS: return LC_STRING("  %d%%  ");
-		case POINT_KILL_HP_RECOVERY: return LC_STRING("%d%% Ȯ ġ  ȸ");
-			//case POINT_IMMUNE_STUN: return LC_STRING("  %d%%");
-			//case POINT_IMMUNE_SLOW: return LC_STRING("  %d%%");
-			//case POINT_IMMUNE_FALL: return LC_STRING("Ѿ  %d%%");
-			//case POINT_SKILL: return LC_STRING("");
-			//case POINT_BOW_DISTANCE: return LC_STRING("");
-		case POINT_ATT_GRADE_BONUS: return LC_STRING("ݷ +%d");
-		case POINT_DEF_GRADE_BONUS: return LC_STRING(" +%d");
-		case POINT_MAGIC_ATT_GRADE: return LC_STRING(" ݷ +%d");
-		case POINT_MAGIC_DEF_GRADE: return LC_STRING("  +%d");
-			//case POINT_CURSE_PCT: return LC_STRING("");
-		case POINT_MAX_STAMINA: return LC_STRING("ִ  +%d");
-		case POINT_ATTBONUS_WARRIOR: return LC_STRING("翡  +%d%%");
-		case POINT_ATTBONUS_ASSASSIN: return LC_STRING("ڰ  +%d%%");
-		case POINT_ATTBONUS_SURA: return LC_STRING("󿡰  +%d%%");
-		case POINT_ATTBONUS_SHAMAN: return LC_STRING("翡  +%d%%");
-		case POINT_ATTBONUS_WOLFMAN: return LC_STRING("翡  +%d%%");
-		case POINT_ATTBONUS_MONSTER: return LC_STRING("Ϳ  +%d%%");
-		case POINT_MALL_ATTBONUS: return LC_STRING("ݷ +%d%%");
-		case POINT_MALL_DEFBONUS: return LC_STRING(" +%d%%");
-		case POINT_MALL_EXPBONUS: return LC_STRING("ġ %d%%");
-		case POINT_MALL_ITEMBONUS: return LC_STRING("  %.1f");
-		case POINT_MALL_GOLDBONUS: return LC_STRING("  %.1f");
-		case POINT_MAX_HP_PCT: return LC_STRING("ִ  +%d%%");
-		case POINT_MAX_SP_PCT: return LC_STRING("ִ ŷ +%d%%");
-		case POINT_SKILL_DAMAGE_BONUS: return LC_STRING("ų  %d%%");
-		case POINT_NORMAL_HIT_DAMAGE_BONUS: return LC_STRING("Ÿ  %d%%");
-		case POINT_SKILL_DEFEND_BONUS: return LC_STRING("ų   %d%%");
-		case POINT_NORMAL_HIT_DEFEND_BONUS: return LC_STRING("Ÿ   %d%%");
-			//case POINT_PC_BANG_EXP_BONUS: return LC_STRING("");
-			//case POINT_PC_BANG_DROP_BONUS: return LC_STRING("");
-			//case POINT_EXTRACT_HP_PCT: return LC_STRING("");
-		case POINT_RESIST_WARRIOR: return LC_STRING("ݿ %d%% ");
-		case POINT_RESIST_ASSASSIN: return LC_STRING("ڰݿ %d%% ");
-		case POINT_RESIST_SURA: return LC_STRING("ݿ %d%% ");
-		case POINT_RESIST_SHAMAN: return LC_STRING("ݿ %d%% ");
-		case POINT_RESIST_WOLFMAN: return LC_STRING("ݿ %d%% ");
+	case POINT_RESIST_WIND: return LC_TEXT("ٶ  %d%%");
+	case POINT_RESIST_ICE: return LC_TEXT("ñ  %d%%");
+	case POINT_RESIST_EARTH: return LC_TEXT("  %d%%");
+	case POINT_RESIST_DARK: return LC_TEXT("  %d%%");
+	case POINT_REFLECT_MELEE: return LC_TEXT(" Ÿġ ݻ Ȯ : %d%%");
+	case POINT_REFLECT_CURSE: return LC_TEXT(" ǵ Ȯ %d%%");
+	case POINT_POISON_REDUCE: return LC_TEXT("  %d%%");
+	case POINT_BLEEDING_REDUCE:	return LC_TEXT("  %d%%");
+	case POINT_KILL_SP_RECOVER: return LC_TEXT("%d%% Ȯ ġ ŷ ȸ");
+	case POINT_EXP_DOUBLE_BONUS: return LC_TEXT("%d%% Ȯ ġ ġ ߰ ");
+	case POINT_GOLD_DOUBLE_BONUS: return LC_TEXT("%d%% Ȯ ġ  2 ");
+	case POINT_ITEM_DROP_BONUS: return LC_TEXT("%d%% Ȯ ġ  2 ");
+	case POINT_POTION_BONUS: return LC_TEXT("  %d%%  ");
+	case POINT_KILL_HP_RECOVERY: return LC_TEXT("%d%% Ȯ ġ  ȸ");
+	//case POINT_IMMUNE_STUN: return LC_TEXT("  %d%%");
+	//case POINT_IMMUNE_SLOW: return LC_TEXT("  %d%%");
+	//case POINT_IMMUNE_FALL: return LC_TEXT("Ѿ  %d%%");
+	//case POINT_SKILL: return LC_TEXT("");
+	//case POINT_BOW_DISTANCE: return LC_TEXT("");
+	case POINT_ATT_GRADE_BONUS: return LC_TEXT("ݷ +%d");
+	case POINT_DEF_GRADE_BONUS: return LC_TEXT(" +%d");
+	case POINT_MAGIC_ATT_GRADE: return LC_TEXT(" ݷ +%d");
+	case POINT_MAGIC_DEF_GRADE: return LC_TEXT("  +%d");
+		//case POINT_CURSE_PCT: return LC_TEXT("");
+	case POINT_MAX_STAMINA: return LC_TEXT("ִ  +%d");
+	case POINT_ATTBONUS_WARRIOR: return LC_TEXT("翡  +%d%%");
+	case POINT_ATTBONUS_ASSASSIN: return LC_TEXT("ڰ  +%d%%");
+	case POINT_ATTBONUS_SURA: return LC_TEXT("󿡰  +%d%%");
+	case POINT_ATTBONUS_SHAMAN: return LC_TEXT("翡  +%d%%");
+	case POINT_ATTBONUS_WOLFMAN: return LC_TEXT("翡  +%d%%");
+	case POINT_ATTBONUS_MONSTER: return LC_TEXT("Ϳ  +%d%%");
+	case POINT_MALL_ATTBONUS: return LC_TEXT("ݷ +%d%%");
+	case POINT_MALL_DEFBONUS: return LC_TEXT(" +%d%%");
+	case POINT_MALL_EXPBONUS: return LC_TEXT("ġ %d%%");
+	case POINT_MALL_ITEMBONUS: return LC_TEXT("  %.1f");
+	case POINT_MALL_GOLDBONUS: return LC_TEXT("  %.1f");
+	case POINT_MAX_HP_PCT: return LC_TEXT("ִ  +%d%%");
+	case POINT_MAX_SP_PCT: return LC_TEXT("ִ ŷ +%d%%");
+	case POINT_SKILL_DAMAGE_BONUS: return LC_TEXT("ų  %d%%");
+	case POINT_NORMAL_HIT_DAMAGE_BONUS: return LC_TEXT("Ÿ  %d%%");
+	case POINT_SKILL_DEFEND_BONUS: return LC_TEXT("ų   %d%%");
+	case POINT_NORMAL_HIT_DEFEND_BONUS: return LC_TEXT("Ÿ   %d%%");
+	//case POINT_PC_BANG_EXP_BONUS: return LC_TEXT("");
+	//case POINT_PC_BANG_DROP_BONUS: return LC_TEXT("");
+	//case POINT_EXTRACT_HP_PCT: return LC_TEXT("");
+	case POINT_RESIST_WARRIOR: return LC_TEXT("ݿ %d%% ");
+	case POINT_RESIST_ASSASSIN: return LC_TEXT("ڰݿ %d%% ");
+	case POINT_RESIST_SURA: return LC_TEXT("ݿ %d%% ");
+	case POINT_RESIST_SHAMAN: return LC_TEXT("ݿ %d%% ");
+	case POINT_RESIST_WOLFMAN: return LC_TEXT("ݿ %d%% ");
 #if defined(__ELEMENT_SYSTEM__)
-		case POINT_ENCHANT_ELECT: return LC_STRING("Lightning Power + %d%%");
-		case POINT_ENCHANT_FIRE: return LC_STRING("Fire Power + %d%%");
-		case POINT_ENCHANT_ICE: return LC_STRING("Ice Power + %d%%");
-		case POINT_ENCHANT_WIND: return LC_STRING("Wind Power + %d%%");
-		case POINT_ENCHANT_EARTH: return LC_STRING("Earth Power + %d%%");
-		case POINT_ENCHANT_DARK: return LC_STRING("Dark Power + %d%%");
-		case POINT_ATTBONUS_CZ: return LC_STRING("Strong against Zodiac Monsters + %d%%");
-		case POINT_ATTBONUS_INSECT: return LC_STRING("Strong against Insects + %d%%");
-		case POINT_ATTBONUS_DESERT: return LC_STRING("Strong against Desert Monsters + %d%%");
+	case POINT_ENCHANT_ELECT: return LC_TEXT("Lightning Power + %d%%");
+	case POINT_ENCHANT_FIRE: return LC_TEXT("Fire Power + %d%%");
+	case POINT_ENCHANT_ICE: return LC_TEXT("Ice Power + %d%%");
+	case POINT_ENCHANT_WIND: return LC_TEXT("Wind Power + %d%%");
+	case POINT_ENCHANT_EARTH: return LC_TEXT("Earth Power + %d%%");
+	case POINT_ENCHANT_DARK: return LC_TEXT("Dark Power + %d%%");
+	case POINT_ATTBONUS_CZ: return LC_TEXT("Strong against Zodiac Monsters + %d%%");
+	case POINT_ATTBONUS_INSECT: return LC_TEXT("Strong against Insects + %d%%");
+	case POINT_ATTBONUS_DESERT: return LC_TEXT("Strong against Desert Monsters + %d%%");
+#endif
+	case POINT_ATTBONUS_STONE: return LC_TEXT("Strong against Metin Stones +%d%%");
+#if defined(__CONQUEROR_LEVEL_DEBUG__)
+	case POINT_SUNGMA_STR: return LC_TEXT("Sung ma(STR) +%d%%");
+	case POINT_SUNGMA_HP: return LC_TEXT("Sung ma(VIT) +%d%%");
+	case POINT_SUNGMA_MOVE: return LC_TEXT("Sung ma(Resistance) +%d%%");
+	case POINT_SUNGMA_IMMUNE: return LC_TEXT("Sung ma(INT) +%d%%");
 #endif
-		case POINT_ATTBONUS_STONE: return LC_STRING("Strong against Metin Stones +%d%%");
-		default:
-			return LC_STRING("Unkown apply_number %d", dwApplyType);
+	default: return "Unkown apply_number(%d)";
 	}
 }
 
@@ -2003,7 +2155,7 @@
 		return false;
 
 	// set apply string
-	offset = snprintf(buf, bufsiz, FN_point_string(aff->wApplyOn), aff->lApplyValue);
+	offset = snprintf(buf, bufsiz, FN_point_string(aff->bApplyOn), aff->lApplyValue);
 
 	if (offset < 0 || offset >= (int)bufsiz)
 		offset = bufsiz - 1;
@@ -2014,7 +2166,7 @@
 	mon = ltm.tm_mon + 1;
 	day = ltm.tm_mday;
 
-	snprintf(buf + offset, bufsiz - offset, LC_STRING(" ( : %d %d %d)", year, mon, day));
+	snprintf(buf + offset, bufsiz - offset, LC_TEXT(" ( : %d %d %d)"), year, mon, day);
 
 	return true;
 }
@@ -2027,32 +2179,32 @@
 	char arg1[256];
 	one_argument(argument, arg1, sizeof(arg1));
 
-	ch->ChatPacket(CHAT_TYPE_INFO, "COSTUME status:");
-
 	CItem* pBody = ch->GetWear(WEAR_COSTUME_BODY);
-	if (pBody)
-	{
-		const char* itemName = pBody->GetName();
-
-		ch->ChatPacket(CHAT_TYPE_INFO, "   BODY : %s", itemName);
+	CItem* pHair = ch->GetWear(WEAR_COSTUME_HAIR);
+#if defined(__MOUNT_COSTUME_SYSTEM__)
+	CItem* pMount = ch->GetWear(WEAR_COSTUME_MOUNT);
+#endif
+#if defined(__ACCE_COSTUME_SYSTEM__)
+	CItem* pAcce = ch->GetWear(WEAR_COSTUME_ACCE);
+#endif
+#if defined(__WEAPON_COSTUME_SYSTEM__)
+	CItem* pWeapon = ch->GetWear(WEAR_COSTUME_WEAPON);
+#endif
 
-		if (pBody->IsEquipped() && arg1[0] == 'b')
-			ch->UnequipItem(pBody);
-	}
+	ch->ChatPacket(CHAT_TYPE_INFO, "COSTUME status:");
 
-	CItem* pHair = ch->GetWear(WEAR_COSTUME_HAIR);
 	if (pHair)
 	{
-		const char* itemName = pHair->GetName();
+		const char* itemName = pHair->GetLocaleName();
 
 		ch->ChatPacket(CHAT_TYPE_INFO, "   HAIR : %s", itemName);
 
 		for (int i = 0; i < pHair->GetAttributeCount(); ++i)
 		{
 			const TPlayerItemAttribute& attr = pHair->GetAttribute(i);
-			if (0 < attr.wType)
+			if (0 < attr.bType)
 			{
-				snprintf(buf, bufferSize, FN_point_string(attr.wType), attr.lValue);
+				snprintf(buf, bufferSize, FN_point_string(attr.bType), attr.sValue);
 				ch->ChatPacket(CHAT_TYPE_INFO, "     %s", buf);
 			}
 		}
@@ -2061,11 +2213,20 @@
 			ch->UnequipItem(pHair);
 	}
 
+	if (pBody)
+	{
+		const char* itemName = pBody->GetLocaleName();
+
+		ch->ChatPacket(CHAT_TYPE_INFO, "   BODY : %s", itemName);
+
+		if (pBody->IsEquipped() && arg1[0] == 'b')
+			ch->UnequipItem(pBody);
+	}
+
 #if defined(__MOUNT_COSTUME_SYSTEM__)
-	CItem* pMount = ch->GetWear(WEAR_COSTUME_MOUNT);
 	if (pMount)
 	{
-		const char* itemName = pMount->GetName();
+		const char* itemName = pMount->GetLocaleName();
 
 		ch->ChatPacket(CHAT_TYPE_INFO, "   MOUNT : %s", itemName);
 
@@ -2075,10 +2236,9 @@
 #endif
 
 #if defined(__ACCE_COSTUME_SYSTEM__)
-	CItem* pAcce = ch->GetWear(WEAR_COSTUME_ACCE);
 	if (pAcce)
 	{
-		const char* itemName = pAcce->GetName();
+		const char* itemName = pAcce->GetLocaleName();
 
 		ch->ChatPacket(CHAT_TYPE_INFO, "   ACCE : %s", itemName);
 
@@ -2088,26 +2248,16 @@
 #endif
 
 #if defined(__WEAPON_COSTUME_SYSTEM__)
-	CItem* pWeapon = ch->GetWear(WEAR_COSTUME_WEAPON);
 	if (pWeapon)
 	{
-		const char* itemName = pWeapon->GetName();
+		const char* itemName = pWeapon->GetLocaleName();
+
 		ch->ChatPacket(CHAT_TYPE_INFO, "   WEAPON : %s", itemName);
+
 		if (pWeapon->IsEquipped() && arg1[0] == 'w')
 			ch->UnequipItem(pWeapon);
 	}
 #endif
-
-#if defined(__AURA_COSTUME_SYSTEM__)
-	CItem* pAura = ch->GetWear(WEAR_COSTUME_AURA);
-	if (pAura)
-	{
-		const char* itemName = pAura->GetName();
-		ch->ChatPacket(CHAT_TYPE_INFO, "  AURA : %s", itemName);
-		if (pAura->IsEquipped() && arg1[0] == 'a')
-			ch->UnequipItem(pAura);
-	}
-#endif
 }
 
 ACMD(do_hair)
@@ -2151,16 +2301,12 @@
 
 	for (int i = 0; i < count; ++i)
 	{
-#if defined(__EXTEND_INVEN_SYSTEM__)
-		if (index >= ch->GetExtendInvenMax())
-#else
 		if (index >= INVENTORY_MAX_NUM)
-#endif
 			break;
 
 		item = ch->GetInventoryItem(index);
 
-		ch->ChatPacket(CHAT_TYPE_INFO, "inventory [%d] = %s", index, item ? item->GetName() : "<NONE>");
+		ch->ChatPacket(CHAT_TYPE_INFO, "inventory [%d] = %s", index, item ? item->GetLocaleName() : "<NONE>");
 		++index;
 	}
 }
@@ -2171,7 +2317,6 @@
 	ch->ChatPacket(CHAT_TYPE_COMMAND, "gift");
 }
 
-#if !defined(__CUBE_RENEWAL__)
 ACMD(do_cube)
 {
 	if (!ch->CanDoCube())
@@ -2232,52 +2377,148 @@
 
 	switch (LOWER(arg1[0]))
 	{
-		case 'o': // open
-			Cube_open(ch);
-			break;
+	case 'o': // open
+		Cube_open(ch);
+		break;
 
-		case 'c': // close
-			Cube_close(ch);
-			break;
+	case 'c': // close
+		Cube_close(ch);
+		break;
 
-		case 'l': // list
-			Cube_show_list(ch);
-			break;
+	case 'l': // list
+		Cube_show_list(ch);
+		break;
+
+	case 'a': // add cue_index inven_index
+	{
+		if (0 == arg2[0] || !isdigit(*arg2) ||
+			0 == arg3[0] || !isdigit(*arg3))
+			return;
+
+		str_to_number(cube_index, arg2);
+		str_to_number(inven_index, arg3);
+		Cube_add_item(ch, cube_index, inven_index);
+	}
+	break;
+
+	case 'd': // delete
+	{
+		if (0 == arg2[0] || !isdigit(*arg2))
+			return;
 
-		case 'a': // add cue_index inven_index
+		str_to_number(cube_index, arg2);
+		Cube_delete_item(ch, cube_index);
+	}
+	break;
+
+	case 'm': // make
+		if (0 != arg2[0])
 		{
-			if (0 == arg2[0] || !isdigit(*arg2) ||
-				0 == arg3[0] || !isdigit(*arg3))
-				return;
+			while (true == Cube_make(ch))
+				dev_log(LOG_DEB0, "cube make success");
+		}
+		else
+			Cube_make(ch);
+		break;
+
+	default:
+		return;
+	}
+}
+
+#if defined(__MINI_GAME_OKEY__)
+ACMD(do_cards)
+{
+	const char* line;
+	char arg1[256], arg2[256];
+	line = two_arguments(argument, arg1, sizeof(arg1), arg2, sizeof(arg2));
 
-			str_to_number(cube_index, arg2);
-			str_to_number(inven_index, arg3);
-			Cube_add_item(ch, cube_index, inven_index);
+	switch (LOWER(arg1[0]))
+	{
+	case 'o': // open
+		if (isdigit(*arg2))
+		{
+			DWORD safemode;
+			str_to_number(safemode, arg2);
+			ch->Cards_open(safemode);
 		}
 		break;
 
-		case 'd': // delete
+	case 'p': // open
+		ch->Cards_pullout();
+		break;
+
+	case 'e': // open
+		ch->CardsEnd();
+		break;
+
+	case 'd': // open
+		if (isdigit(*arg2))
 		{
-			if (0 == arg2[0] || !isdigit(*arg2))
-				return;
+			DWORD destroy_index;
+			str_to_number(destroy_index, arg2);
+			ch->CardsDestroy(destroy_index);
+		}
+		break;
 
-			str_to_number(cube_index, arg2);
-			Cube_delete_item(ch, cube_index);
+	case 'a': // open
+		if (isdigit(*arg2))
+		{
+			DWORD accpet_index;
+			str_to_number(accpet_index, arg2);
+			ch->CardsAccept(accpet_index);
 		}
 		break;
 
-		case 'm': // make
-			if (0 != arg2[0])
-			{
-				while (true == Cube_make(ch))
-					dev_log(LOG_DEB0, "cube make success");
-			}
-			else
-				Cube_make(ch);
-			break;
+	case 'r': // open
+		if (isdigit(*arg2))
+		{
+			DWORD restore_index;
+			str_to_number(restore_index, arg2);
+			ch->CardsRestore(restore_index);
+		}
+		break;
 
-		default:
+	default:
+		return;
+	}
+}
+#endif
+
+#if defined(__GEM_MARKET_SYSTEM__)
+ACMD(do_gem)
+{
+	char arg1[255];
+	char arg2[255];
+	two_arguments(argument, arg1, sizeof(arg1), arg2, sizeof(arg2));
+
+	if (0 == arg1[0])
+		return;
+
+	const std::string& strArg1 = std::string(arg1);
+
+	if (strArg1 == "craft")
+	{
+		if (0 == arg2[0])
+			return;
+
+		int slot = atoi(arg2);
+		ch->CraftGemItems(slot);
+
+	}
+	else if (strArg1 == "market")
+	{
+
+		if (0 == arg2[0])
 			return;
+
+		int slot = atoi(arg2);
+		ch->MarketGemItems(slot);
+
+	}
+	else if (strArg1 == "refresh")
+	{
+		ch->RefreshGemItems();
 	}
 }
 #endif
@@ -2296,6 +2537,13 @@
 		return;
 	}
 
+	// _ 赵 ۸ URL ϵڵ ߰
+	if (true == LC_IsWE_Korea())
+	{
+		ch->ChatPacket(CHAT_TYPE_COMMAND, "mall http://metin2.co.kr/50_we_mall/mall/login.htm");
+		return;
+	}
+
 	if (LC_IsJapan() == true)
 	{
 		ch->ChatPacket(CHAT_TYPE_COMMAND, "mall http://mt2.oge.jp/itemmall/itemList.php");
@@ -2319,8 +2567,7 @@
 	{
 		ch->ChatPacket(CHAT_TYPE_COMMAND, "mall http://mall.z8games.com/mall_entry.aspx?tb=m2");
 		return;
-	}
-	*/
+	}*/
 
 	if (LC_IsEurope() == true)
 	{
@@ -2328,42 +2575,36 @@
 
 		switch (LC_GetLocalType())
 		{
-			case LC_GERMANY: country_code[0] = 'd'; country_code[1] = 'e'; country_code[2] = '\0'; break;
-			case LC_FRANCE: country_code[0] = 'f'; country_code[1] = 'r'; country_code[2] = '\0'; break;
-			case LC_ITALY: country_code[0] = 'i'; country_code[1] = 't'; country_code[2] = '\0'; break;
-			case LC_SPAIN: country_code[0] = 'e'; country_code[1] = 's'; country_code[2] = '\0'; break;
-			case LC_UK: country_code[0] = 'e'; country_code[1] = 'n'; country_code[2] = '\0'; break;
-			case LC_TURKEY: country_code[0] = 't'; country_code[1] = 'r'; country_code[2] = '\0'; break;
-			case LC_POLAND: country_code[0] = 'p'; country_code[1] = 'l'; country_code[2] = '\0'; break;
-			case LC_PORTUGAL: country_code[0] = 'p'; country_code[1] = 't'; country_code[2] = '\0'; break;
-			case LC_GREEK: country_code[0] = 'g'; country_code[1] = 'r'; country_code[2] = '\0'; break;
-			case LC_RUSSIA: country_code[0] = 'r'; country_code[1] = 'u'; country_code[2] = '\0'; break;
-			case LC_DENMARK: country_code[0] = 'd'; country_code[1] = 'k'; country_code[2] = '\0'; break;
-			case LC_BULGARIA: country_code[0] = 'b'; country_code[1] = 'g'; country_code[2] = '\0'; break;
-			case LC_CROATIA: country_code[0] = 'h'; country_code[1] = 'r'; country_code[2] = '\0'; break;
-			case LC_MEXICO: country_code[0] = 'm'; country_code[1] = 'x'; country_code[2] = '\0'; break;
-			case LC_ARABIA: country_code[0] = 'a'; country_code[1] = 'e'; country_code[2] = '\0'; break;
-			case LC_CZECH: country_code[0] = 'c'; country_code[1] = 'z'; country_code[2] = '\0'; break;
-			case LC_ROMANIA: country_code[0] = 'r'; country_code[1] = 'o'; country_code[2] = '\0'; break;
-			case LC_HUNGARY: country_code[0] = 'h'; country_code[1] = 'u'; country_code[2] = '\0'; break;
-			case LC_NETHERLANDS: country_code[0] = 'n'; country_code[1] = 'l'; country_code[2] = '\0'; break;
-			case LC_USA: country_code[0] = 'u'; country_code[1] = 's'; country_code[2] = '\0'; break;
-			case LC_CANADA: country_code[0] = 'c'; country_code[1] = 'a'; country_code[2] = '\0'; break;
-			default:
+		case LC_GERMANY: country_code[0] = 'd'; country_code[1] = 'e'; country_code[2] = '\0'; break;
+		case LC_FRANCE: country_code[0] = 'f'; country_code[1] = 'r'; country_code[2] = '\0'; break;
+		case LC_ITALY: country_code[0] = 'i'; country_code[1] = 't'; country_code[2] = '\0'; break;
+		case LC_SPAIN: country_code[0] = 'e'; country_code[1] = 's'; country_code[2] = '\0'; break;
+		case LC_UK: country_code[0] = 'e'; country_code[1] = 'n'; country_code[2] = '\0'; break;
+		case LC_TURKEY: country_code[0] = 't'; country_code[1] = 'r'; country_code[2] = '\0'; break;
+		case LC_POLAND: country_code[0] = 'p'; country_code[1] = 'l'; country_code[2] = '\0'; break;
+		case LC_PORTUGAL: country_code[0] = 'p'; country_code[1] = 't'; country_code[2] = '\0'; break;
+		case LC_GREEK: country_code[0] = 'g'; country_code[1] = 'r'; country_code[2] = '\0'; break;
+		case LC_RUSSIA: country_code[0] = 'r'; country_code[1] = 'u'; country_code[2] = '\0'; break;
+		case LC_DENMARK: country_code[0] = 'd'; country_code[1] = 'k'; country_code[2] = '\0'; break;
+		case LC_BULGARIA: country_code[0] = 'b'; country_code[1] = 'g'; country_code[2] = '\0'; break;
+		case LC_CROATIA: country_code[0] = 'h'; country_code[1] = 'r'; country_code[2] = '\0'; break;
+		case LC_MEXICO: country_code[0] = 'm'; country_code[1] = 'x'; country_code[2] = '\0'; break;
+		case LC_ARABIA: country_code[0] = 'a'; country_code[1] = 'e'; country_code[2] = '\0'; break;
+		case LC_CZECH: country_code[0] = 'c'; country_code[1] = 'z'; country_code[2] = '\0'; break;
+		case LC_ROMANIA: country_code[0] = 'r'; country_code[1] = 'o'; country_code[2] = '\0'; break;
+		case LC_HUNGARY: country_code[0] = 'h'; country_code[1] = 'u'; country_code[2] = '\0'; break;
+		case LC_NETHERLANDS: country_code[0] = 'n'; country_code[1] = 'l'; country_code[2] = '\0'; break;
+		case LC_USA: country_code[0] = 'u'; country_code[1] = 's'; country_code[2] = '\0'; break;
+		case LC_CANADA: country_code[0] = 'c'; country_code[1] = 'a'; country_code[2] = '\0'; break;
+		case LC_EUROPE: country_code[0] = 'e'; country_code[1] = 'u'; country_code[2] = '\0'; break;
+		default:
+			if (test_server == true)
 			{
-				if (test_server)
-				{
-					country_code[0] = 'u'; country_code[1] = 's'; country_code[2] = '\0';
-				}
-				break;
+				country_code[0] = 'e'; country_code[1] = 'u'; country_code[2] = '\0';
 			}
+			break;
 		}
 
-#if defined(__LOCALE_CLIENT__)
-		snprintf(country_code, sizeof(country_code),
-			"%s", LocaleService_GetCountry(ch->GetCountry()));
-#endif
-
 		char buf[512 + 1];
 		char sas[33];
 		MD5_CTX ctx;
@@ -2388,8 +2629,15 @@
 		sas[i + i] = '\0';
 #endif
 
-		snprintf(buf, sizeof(buf), "mall http://%s/ishop?pid=%u&c=%s&sid=%d&sas=%s",
-			g_strWebMallURL.c_str(), ch->GetPlayerID(), country_code, g_server_id, sas);
+		char language[3];
+		if (ch->GetDesc() != NULL)
+			strcpy(language, get_locale(ch->GetLanguage()));
+		else
+			strcpy(language, "en");
+
+		snprintf(buf, sizeof(buf), "mall http://owsap-productions.com/osp");
+		//snprintf(buf, sizeof(buf), "mall http://%s/mall?pid=%u&lang=%s&sid=%d&sas=%s",
+		//	g_strWebMallURL.c_str(), ch->GetPlayerID(), language, g_server_id, sas);
 
 		ch->ChatPacket(CHAT_TYPE_COMMAND, buf);
 	}
@@ -2421,14 +2669,14 @@
 
 #if defined(__DICE_SYSTEM__)
 	if (ch->GetParty())
-		ch->GetParty()->ChatPacketToAllMember(CHAT_TYPE_INFO, LC_STRING("%s ֻ  %d Խϴ. (%d-%d)", ch->GetName(), n, start, end));
+		ch->GetParty()->ChatPacketToAllMember(CHAT_TYPE_DICE_INFO, LC_TEXT("%s ֻ  %d Խϴ. (%d-%d)"), ch->GetName(), n, start, end);
 	else
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ֻ  %d Խϴ. (%d-%d)", n, start, end));
+		ch->ChatPacket(CHAT_TYPE_DICE_INFO, LC_TEXT(" ֻ  %d Խϴ. (%d-%d)"), n, start, end);
 #else
 	if (ch->GetParty())
-		ch->GetParty()->ChatPacketToAllMember(CHAT_TYPE_INFO, LC_STRING("%s ֻ  %d Խϴ. (%d-%d)", ch->GetName(), n, start, end));
+		ch->GetParty()->ChatPacketToAllMember(CHAT_TYPE_INFO, LC_TEXT("%s ֻ  %d Խϴ. (%d-%d)"), ch->GetName(), n, start, end);
 	else
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ֻ  %d Խϴ. (%d-%d)", n, start, end));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ֻ  %d Խϴ. (%d-%d)"), n, start, end);;
 #endif
 }
 
@@ -2443,23 +2691,17 @@
 	if (ch->IsDead() || ch->IsStun())
 		return;
 
-	if (ch->IsFishing())
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot carry out this action while fishing."));
-		return;
-	}
-
 #if defined(__MOUNT_COSTUME_SYSTEM__)
-	if (SECTREE_MANAGER::Instance().IsBlockFilterMapIndex(SECTREE_MANAGER::MOUNT_BLOCK_MAP_INDEX, ch->GetMapIndex()))
+	if (IS_BLOCKED_MOUNT_SUMMON_MAP(ch->GetMapIndex()) || IS_BLOCKED_MOUNT_SUMMON_MAP(ch->GetMapIndex()))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot summon your mount/pet right now."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot summon your mount/pet right now."));
 		return;
 	}
 #endif
 
 	if (ch->IsWearingDress())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot ride while you are wearing a Wedding Dress or a Tuxedo."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot ride while you are wearing a Wedding Dress or a Tuxedo."));
 		return;
 	}
 
@@ -2516,13 +2758,13 @@
 			// TODO : ŻͿ SubType ߰
 			switch (item->GetVnum())
 			{
-				case 71114: // ̿
-				case 71116: // ߽̿
-				case 71118: // ̿
-				case 71120: // ڿ̿
-					dev_log(LOG_DEB0, "[DO_RIDE] USE QUEST ITEM");
-					ch->UseItem(TItemPos(INVENTORY, i));
-					return;
+			case 71114: // ̿
+			case 71116: // ߽̿
+			case 71118: // ̿
+			case 71120: // ڿ̿
+				dev_log(LOG_DEB0, "[DO_RIDE] USE QUEST ITEM");
+				ch->UseItem(TItemPos(INVENTORY, i));
+				return;
 			}
 
 			// GF mantis #113524, 52001~52090  Ż
@@ -2536,256 +2778,140 @@
 	}
 
 	// Ÿų   
-	ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("  ȯּ."));
+	ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ȯּ."));
 }
 
-#if defined(__MOVE_CHANNEL__)
-ACMD(do_move_channel)
+#if defined(__SORT_INVENTORY_ITEMS__) && defined(__SPECIAL_INVENTORY_SYSTEM__)
+ACMD(do_sort_special_inventory)
 {
-	if (!ch)
-		return;
-
-	if (ch->m_pkTimedEvent)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" Ǿϴ."));
-		event_cancel(&ch->m_pkTimedEvent);
-		return;
-	}
-
 	char arg1[256];
 	one_argument(argument, arg1, sizeof(arg1));
 
 	if (!*arg1)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Usage: channel <new channel>"));
-		return;
-	}
-
-	short channel;
-	str_to_number(channel, arg1);
-
-	if (channel < 1 || channel > 4)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Please enter a valid channel."));
 		return;
-	}
 
-	if (channel == g_bChannel)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You are already on channel %d.", g_bChannel));
-		return;
-	}
+	BYTE type = 0;
+	str_to_number(type, arg1);
 
-	if (g_bChannel == 99)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot change your channel."));
-		return;
-	}
-
-	if (ch->GetDungeon() || ch->GetMapIndex() >= 10000)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot change your channel."));
-		return;
-	}
-
-	TPacketChangeChannel p;
-	p.iChannel = channel;
-	p.lMapIndex = ch->GetMapIndex();
-
-	db_clientdesc->DBPacket(HEADER_GD_FIND_CHANNEL, ch->GetDesc()->GetHandle(), &p, sizeof(p));
+	ch->SortSpecialInventoryItems(type);
 }
 #endif
 
-#if defined(__POPUP_NOTICE__)
-ACMD(do_popup_notice_check)
+#if defined(__HIDE_COSTUME_SYSTEM__)
+ACMD(do_hide_costume)
 {
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
+	char arg1[256], arg2[256];
+	two_arguments(argument, arg1, sizeof(arg1), arg2, sizeof(arg2));
 
 	if (!*arg1)
 		return;
 
-	int enable;
-	str_to_number(enable, arg1);
+	bool hidden = true;
+	BYTE bPartPos = 0;
+	BYTE bHidden = 0;
 
-	ch->SetQuestFlag("popup_notice.checkbox", enable);
-}
-#endif
+	str_to_number(bPartPos, arg1);
 
-#if defined(__GAME_OPTION_ESCAPE__)
-ACMD(do_escape)
-{
-	if (ch->IsDead() || ch->IsPolymorphed())
-		return;
+	if (*arg2)
+	{
+		str_to_number(bHidden, arg2);
+
+		if (bHidden == 0)
+			hidden = false;
+	}
 
-	if (ch->GetEscapeCooltime() > thecore_pulse() && !ch->IsGM())
+	if (ch->IsDead())
 		return;
 
-	const BYTE bEmpire = ch->GetEmpire();
-	const long lMapIndex = ch->GetMapIndex();
-	const PIXEL_POSITION& rkPos = ch->GetXYZ();
+	bool bAttacking = (get_dword_time() - ch->GetLastAttackTime()) < 1500;
+	bool bMoving = (get_dword_time() - ch->GetLastMoveTime()) < 1500;
+	bool bDelayedCMD = false;
 
-	const LPSECTREE_MAP pSectreeMap = SECTREE_MANAGER::instance().GetMap(lMapIndex);
-	if (pSectreeMap == nullptr)
+	if (ch->IsStateMove() || bAttacking || bMoving)
 	{
-		ch->WarpSet(g_start_position[bEmpire][0], g_start_position[bEmpire][1]);
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You have to stand still to hide your costume."));
 		return;
 	}
 
-	const LPSECTREE pSectree = pSectreeMap->Find(rkPos.x, rkPos.y);
-	const DWORD dwAttr = pSectree->GetAttribute(rkPos.x, rkPos.y);
-
-	int iEscapeDistance = quest::CQuestManager::instance().GetEventFlag("escape_distance");
-	iEscapeDistance = (iEscapeDistance > 0) ? iEscapeDistance : 300;
-
-	int iEscapeCooltime = quest::CQuestManager::instance().GetEventFlag("escape_cooltime");
-	iEscapeCooltime = (iEscapeCooltime > 0) ? iEscapeCooltime : 10;
-
-	if (IS_SET(dwAttr, ATTR_BLOCK /*| ATTR_OBJECT*/))
+	if (bDelayedCMD)
 	{
-		/*
-		* NOTE : If an object doesn't have a blocked area, players can still be blocked if they get inside it.
-		* The problem is that bridges are treated as objects too, and we don't want players to use the escape feature through them.
-		* The tricky part is figuring out whether a specific object is a bridge or not.
-		* In the current state, we are only checking blocked areas.
-		*
-		* 20240117.Owsap
-		*/
-
-		PIXEL_POSITION kNewPos;
-		if (SECTREE_MANAGER::instance().GetRandomLocation(lMapIndex, kNewPos, rkPos.x, rkPos.y, iEscapeDistance))
-		{
-			char szBuf[255 + 1];
-			snprintf(szBuf, sizeof(szBuf), "%ld, (%d, %d) -> (%d, %d)",
-				lMapIndex, rkPos.x, rkPos.y, kNewPos.x, kNewPos.y);
-			LogManager::instance().CharLog(ch, lMapIndex, "ESCAPE", szBuf);
-
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You have successfully freed yourself."));
-			ch->Show(lMapIndex, kNewPos.x, kNewPos.y, rkPos.z);
-		}
-		else
+		int iPulse = thecore_pulse();
+		if (iPulse - ch->GetHideCostumePulse() < passes_per_sec * 3)
 		{
-			char szBuf[255 + 1];
-			snprintf(szBuf, sizeof(szBuf), "%ld, (%d, %d) -> EMPIRE START POSITION",
-				lMapIndex, rkPos.x, rkPos.y);
-			LogManager::instance().CharLog(ch, lMapIndex, "ESCAPE", szBuf);
-
-			ch->WarpSet(g_start_position[bEmpire][0], g_start_position[bEmpire][1]);
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You have to wait 3 seconds before you can hide your costume again."));
+			return;
 		}
+		ch->SetHideCostumePulse(iPulse);
 	}
 
-	ch->SetEscapeCooltime(thecore_pulse() + PASSES_PER_SEC(10));
-}
-#endif
-
-#if defined(__HIDE_COSTUME_SYSTEM__)
-ACMD(do_hide_costume_part)
-{
-	char szArg1[256], szArg2[256];
-	two_arguments(argument, szArg1, sizeof(szArg1), szArg2, sizeof(szArg2));
-
-	if (!*szArg1 || !*szArg2)
+	if (bPartPos == 1)
+		ch->SetBodyCostumeHidden(hidden);
+	else if (bPartPos == 2)
+		ch->SetHairCostumeHidden(hidden);
+	else if (bPartPos == 3)
+		ch->SetAcceCostumeHidden(hidden);
+	else if (bPartPos == 4)
+		ch->SetWeaponCostumeHidden(hidden);
+	else
 		return;
 
-	BYTE bCostumeSubType = 0, bHidden = 0;
-	str_to_number(bCostumeSubType, szArg1);
-	str_to_number(bHidden, szArg2);
-
-	ch->SetHiddenCostumePart(bCostumeSubType, bHidden);
+	ch->UpdatePacket();
 }
 #endif
 
-#ifdef __OFFLINE_SHOP__
-ACMD(do_create_offline_shop)
+#if defined(__MOVE_CHANNEL__)
+ACMD(do_move_channel)
 {
-	if (ch->IsOpeningOfflineShop())
+	if (!ch)
 		return;
-	
-	ch->SetOpeningOfflineShopState(true);
-
-	ch->ChatPacket(CHAT_TYPE_COMMAND, 
-		"StartOpeningOfflineShop %d %d %d %d %d %d %d %d"
-		" %d %d %d %d %d",
-		ch->GetQuestFlag("shop_decoration.shop_skin_0"),
-		ch->GetQuestFlag("shop_decoration.shop_skin_1"),
-		ch->GetQuestFlag("shop_decoration.shop_skin_2"),
-		ch->GetQuestFlag("shop_decoration.shop_skin_3"),
-		ch->GetQuestFlag("shop_decoration.shop_skin_4"),
-		ch->GetQuestFlag("shop_decoration.shop_skin_5"),
-		ch->GetQuestFlag("shop_decoration.shop_skin_6"),
-		ch->GetQuestFlag("shop_decoration.shop_skin_7"),
-		ch->GetQuestFlag("shop_decoration.shop_banner_0"),
-		ch->GetQuestFlag("shop_decoration.shop_banner_1"),
-		ch->GetQuestFlag("shop_decoration.shop_banner_2"),
-		ch->GetQuestFlag("shop_decoration.shop_banner_3"),
-		ch->GetQuestFlag("shop_decoration.shop_banner_4"));
-}
 
-ACMD(do_cancel_opening_offline_shop)
-{
-	if (!ch->IsOpeningOfflineShop()) {
+	if (ch->m_pkTimedEvent)
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" Ǿϴ."));
+		event_cancel(&ch->m_pkTimedEvent);
 		return;
 	}
 
-	ch->SetOpeningOfflineShopState(false);
-	if (ch->GetOfflineShopOpeningItem()) {
-		ch->GetOfflineShopOpeningItem()->Lock(false);
-		ch->SetOfflineShopOpeningItem(nullptr);
-	}
-
-	ch->ChatPacket(CHAT_TYPE_COMMAND, "CancelOpeningOfflineShop");
-}
-
-ACMD(do_open_offline_shop)
-{
 	char arg1[256];
 	one_argument(argument, arg1, sizeof(arg1));
 
-	if (!*arg1) {
+	if (!*arg1)
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Usage: channel <new channel>"));
 		return;
 	}
 
-	uint32_t id = std::atoi(arg1);
+	short channel;
+	str_to_number(channel, arg1);
 
-	auto shopPtr = COfflineShop::Get(id);
-	if (shopPtr) {
-		shopPtr->get()->AddViewer(ch);
+	if (channel < 1 || channel > 4)
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Please enter a valid channel."));
+		return;
 	}
-}
-
-ACMD(do_close_offline_shop)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
 
-	if (!*arg1) {
+	if (channel == g_bChannel)
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You are already on channel %d."), g_bChannel);
 		return;
 	}
 
-	uint32_t id = std::atoi(arg1);
-
-	auto shopPtr = COfflineShop::Get(id);
-	if (shopPtr) {
-		auto shop = shopPtr->get();
-
-		if (shop->GetOwnerPid() != ch->GetPlayerID()) {
-			return;
-		}
-
-		shop->RequestClose();
+	if (g_bChannel == 99)
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot change your channel."));
+		return;
 	}
-}
-ACMD(do_sell_history)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
 
-	BYTE bPage = 1;
-	str_to_number(bPage, arg1);
-	
-	if (bPage < 1 || bPage > 10)
+	if (ch->GetDungeon() || ch->GetMapIndex() >= 10000)
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot change your channel."));
 		return;
-	
-	ch->RequestSellHistory(bPage);
+	}
+
+	TPacketChangeChannel p;
+	p.iChannel = channel;
+	p.lMapIndex = ch->GetMapIndex();
+
+	db_clientdesc->DBPacket(HEADER_GD_FIND_CHANNEL, ch->GetDesc()->GetHandle(), &p, sizeof(p));
 }
 #endif
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/cmd_gm.cpp final/server/server/home/metin2/Source/Server/game/src/cmd_gm.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/cmd_gm.cpp	2025-06-29 16:38:40.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/cmd_gm.cpp	2022-04-27 12:19:26.000000000 +0000
@@ -37,16 +37,7 @@
 #include "unique_item.h"
 #include "DragonSoul.h"
 #include "shop_manager.h"
-#include "OXEvent.h"
-#if defined(__DEFENSE_WAVE__)
-#	include "defense_wave.h"
-#endif
-#if defined(__EXTENDED_RELOAD__)
-#	include "mob_manager.h"
-#endif
-#if defined(__OFFLINE_SHOP__)
-#include "OfflineShop.h"
-#endif
+#include "minigame.h"
 
 extern bool DropEvent_RefineBox_SetValue(const std::string& name, int value);
 
@@ -57,6 +48,127 @@
 	COMMANDAFFECT_SLOW,
 };
 
+static bool HWIDBan(DWORD dwAID)
+{
+	if (!dwAID)
+		return false;
+
+	char szQuery[512 + 1];
+	snprintf(szQuery, sizeof(szQuery), "UPDATE `account`.`hwid` SET `ban` = 1 WHERE `account_id` = %u", dwAID);
+	std::unique_ptr<SQLMsg> pMsg(DBManager::instance().DirectQuery(szQuery));
+	if (pMsg->Get()->uiAffectedRows > 0)
+		return true;
+
+	return false;
+}
+
+ACMD(do_hwid_ban)
+{
+	char arg1[256], arg2[256];
+
+	two_arguments(argument, arg1, sizeof(arg1), arg2, sizeof(arg2));
+
+	if (!*arg1 || !*arg2)
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, "Usage: hwid_ban <player name> <reason>");
+		return;
+	}
+
+	DWORD dwAID = 0;
+	const char* c_szName = arg1;
+	const char* c_szReason = arg2;
+
+	LPCHARACTER pkCh = CHARACTER_MANAGER::instance().FindPC(c_szName);
+	if (pkCh)
+	{
+		if (pkCh->GetGMLevel() >= GM_WIZARD)
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, "You cannot ban GM's.");
+			sys_log(0, "%s tried to ban a GM!", ch->GetName());
+			return;
+		}
+
+		dwAID = pkCh->GetAID();
+
+		if (HWIDBan(dwAID))
+		{
+			pkCh->Disconnect(c_szReason);
+			ch->ChatPacket(CHAT_TYPE_INFO, "Permanently banned player %s", c_szName);
+			sys_log(0, "%s permanently banned (hwid_ban) player %s", ch->GetName(), c_szName);
+		}
+		else
+		{
+			sys_log(0, "Failed to ban player %s", c_szName);
+		}
+
+		return;
+	}
+	else
+	{
+		CCI* pkCCI = P2P_MANAGER::instance().Find(c_szName);
+		if (pkCCI)
+		{
+			LPDESC pkDesc = pkCCI->pkDesc;
+			if (pkDesc)
+			{
+				if (pkDesc->GetCharacter()->GetGMLevel() >= GM_WIZARD)
+				{
+					ch->ChatPacket(CHAT_TYPE_INFO, "You cannot ban GM's.");
+					sys_log(0, "%s tried to ban a GM!", ch->GetName());
+					return;
+				}
+
+				dwAID = pkDesc->GetAccountTable().id;
+
+				if (HWIDBan(dwAID))
+				{
+					pkDesc->GetCharacter()->Disconnect(c_szReason);
+					ch->ChatPacket(CHAT_TYPE_INFO, "Permanently banned player %s", c_szName);
+					sys_log(0, "%s permanently banned (hwid_ban) player %s", ch->GetName(), c_szName);
+				}
+				else
+				{
+					sys_log(0, "Failed to ban player %s from peer.", c_szName);
+				}
+
+				return;
+			}
+		}
+		else
+		{
+			char szQuery[512 + 1];
+			snprintf(szQuery, sizeof(szQuery), "SELECT `account_id` FROM `player`.`player` WHERE `name` = '%s'", c_szName);
+			std::unique_ptr<SQLMsg> pMsg(DBManager::instance().DirectQuery(szQuery));
+			if (pMsg->Get()->uiNumRows > 0)
+			{
+				MYSQL_ROW row = mysql_fetch_row(pMsg->Get()->pSQLResult);
+
+				DWORD dwAID = 0;
+				str_to_number(dwAID, row[0]);
+
+				if (dwAID != 0)
+				{
+					if (HWIDBan(dwAID))
+					{
+						ch->ChatPacket(CHAT_TYPE_INFO, "Permanently banned player %s", c_szName);
+						sys_log(0, "%s permanently banned (hwid_ban) player %s", ch->GetName(), c_szName);
+					}
+					else
+					{
+						sys_log(0, "Failed to ban player %s from direct query.", c_szName);
+					}
+					return;
+				}
+			}
+			else
+			{
+				ch->ChatPacket(CHAT_TYPE_INFO, "Unkown player.");
+				return;
+			}
+		}
+	}
+}
+
 void Command_ApplyAffect(LPCHARACTER ch, const char* argument, const char* affectName, int cmdAffect)
 {
 	char arg1[256];
@@ -79,12 +191,12 @@
 
 	switch (cmdAffect)
 	{
-		case COMMANDAFFECT_STUN:
-			SkillAttackAffect(tch, 1000, IMMUNE_STUN, AFFECT_STUN, POINT_NONE, 0, AFF_STUN, 30, "GM_STUN");
-			break;
-		case COMMANDAFFECT_SLOW:
-			SkillAttackAffect(tch, 1000, IMMUNE_SLOW, AFFECT_SLOW, POINT_MOV_SPEED, -30, AFF_SLOW, 30, "GM_SLOW");
-			break;
+	case COMMANDAFFECT_STUN:
+		SkillAttackAffect(tch, 1000, IMMUNE_STUN, AFFECT_STUN, POINT_NONE, 0, AFF_STUN, 30, "GM_STUN");
+		break;
+	case COMMANDAFFECT_SLOW:
+		SkillAttackAffect(tch, 1000, IMMUNE_SLOW, AFFECT_SLOW, POINT_MOV_SPEED, -30, AFF_SLOW, 30, "GM_SLOW");
+		break;
 	}
 
 	sys_log(0, "%s %s", arg1, affectName);
@@ -618,7 +730,7 @@
 	if (*arg2)
 	{
 		str_to_number(iCount, arg2);
-		iCount = MINMAX(1, iCount, ITEM_MAX_COUNT);
+		iCount = MINMAX(1, iCount, gMaxItemCount);
 	}
 
 	DWORD dwVnum;
@@ -638,7 +750,6 @@
 
 	if (item)
 	{
-#if defined(__DRAGON_SOUL_SYSTEM__)
 		if (item->IsDragonSoul())
 		{
 			int iEmptyPos = ch->GetEmptyDragonSoulInventory(item);
@@ -653,14 +764,75 @@
 				M2_DESTROY_ITEM(item);
 				if (!ch->DragonSoul_IsQualified())
 				{
-					ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Before you open the Cor Draconis, you have to complete the Dragon Stone quest and activate the Dragon Stone Alchemy."));
+					ch->ChatPacket(CHAT_TYPE_INFO, "κ Ȱȭ  .");
 				}
 				else
-					ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You don't have enough space in your inventory."));
+					ch->ChatPacket(CHAT_TYPE_INFO, "Not enough inventory space.");
+			}
+		}
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+		else if (item->IsSkillBook())
+		{
+			int iEmptyPos = ch->GetEmptySkillBookInventory(item->GetSize());
+
+			if (iEmptyPos != -1)
+			{
+				item->AddToCharacter(ch, TItemPos(INVENTORY, iEmptyPos));
+				LogManager::instance().ItemLog(ch, item, "GM", item->GetName());
+			}
+			else
+			{
+				M2_DESTROY_ITEM(item);
+				ch->ChatPacket(CHAT_TYPE_INFO, "Not enough inventory space.");
+			}
+		}
+		else if (item->IsUpgradeItem())
+		{
+			int iEmptyPos = ch->GetEmptyUpgradeItemsInventory(item->GetSize());
+
+			if (iEmptyPos != -1)
+			{
+				item->AddToCharacter(ch, TItemPos(INVENTORY, iEmptyPos));
+				LogManager::instance().ItemLog(ch, item, "GM", item->GetName());
+			}
+			else
+			{
+				M2_DESTROY_ITEM(item);
+				ch->ChatPacket(CHAT_TYPE_INFO, "Not enough inventory space.");
+			}
+		}
+		else if (item->IsStone())
+		{
+			int iEmptyPos = ch->GetEmptyStoneInventory(item->GetSize());
+
+			if (iEmptyPos != -1)
+			{
+				item->AddToCharacter(ch, TItemPos(INVENTORY, iEmptyPos));
+				LogManager::instance().ItemLog(ch, item, "GM", item->GetName());
+			}
+			else
+			{
+				M2_DESTROY_ITEM(item);
+				ch->ChatPacket(CHAT_TYPE_INFO, "Not enough inventory space.");
+			}
+		}
+		else if (item->IsGiftBox())
+		{
+			int iEmptyPos = ch->GetEmptyGiftBoxInventory(item->GetSize());
+
+			if (iEmptyPos != -1)
+			{
+				item->AddToCharacter(ch, TItemPos(INVENTORY, iEmptyPos));
+				LogManager::instance().ItemLog(ch, item, "GM", item->GetName());
+			}
+			else
+			{
+				M2_DESTROY_ITEM(item);
+				ch->ChatPacket(CHAT_TYPE_INFO, "Not enough inventory space.");
 			}
 		}
-		else
 #endif
+		else
 		{
 			int iEmptyPos = ch->GetEmptyInventory(item->GetSize());
 
@@ -677,7 +849,7 @@
 			else
 			{
 				M2_DESTROY_ITEM(item);
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You don't have enough space in your inventory."));
+				ch->ChatPacket(CHAT_TYPE_INFO, "Not enough inventory space.");
 			}
 		}
 	}
@@ -1003,27 +1175,10 @@
 		if (!m_bAll && iDist >= 1000) // 10 ̻ ִ ͵ purge  ʴ´.
 			return;
 
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-		if (CGuildDragonLairManager::Instance().IsUnique(pkChr))
-			return;
-#endif
-
-#if defined(__DEFENSE_WAVE__)
-		if (pkChr->GetDefenseWave() && pkChr->GetDefenseWave()->IsUnique(pkChr))
-			return;
-#endif
-
 		sys_log(0, "PURGE: %s %d", pkChr->GetName(), iDist);
 
 		// todo : check instances
-		if (pkChr->IsNPC() && pkChr->GetRider() == NULL
-#if defined(__PET_SYSTEM__)
-			&& !pkChr->IsPet()
-#endif
-#if defined(__GROWTH_PET_SYSTEM__)
-			&& !pkChr->IsGrowthPet()
-#endif
-			)
+		if (pkChr->IsNPC() && !pkChr->IsPet() && !pkChr->IsGrowthPet() && pkChr->GetRider() == NULL)
 		{
 			M2_DESTROY_CHARACTER(pkChr);
 		}
@@ -1047,55 +1202,118 @@
 		sys_err("PURGE_ERROR.NULL_SECTREE(mapIndex=%d, pos=(%d, %d)", ch->GetMapIndex(), ch->GetX(), ch->GetY());
 }
 
-static void ipurge_window(const LPCHARACTER& ch, BYTE window_type)
+ACMD(do_item_purge)
 {
-	if (NULL == ch)
+	char arg1[256];
+	one_argument(argument, arg1, sizeof(arg1));
+
+	bool all = false;
+	bool inventory = false;
+	bool dragon_soul = false;
+	bool belt = false;
+	bool equipment = false;
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	bool special_inventory = false;
+#endif
+
+	if (!*arg1)
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, "Usage: /item_purge <window>");
+		ch->ChatPacket(CHAT_TYPE_INFO, "   inv - Inventory");
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+		ch->ChatPacket(CHAT_TYPE_INFO, "   sinv - Special Inventory");
+#endif
+		ch->ChatPacket(CHAT_TYPE_INFO, "   ds - Dragon Soul");
+		ch->ChatPacket(CHAT_TYPE_INFO, "   eq - Equipment and Costumes");
+		ch->ChatPacket(CHAT_TYPE_INFO, "   belt - Belt");
+		ch->ChatPacket(CHAT_TYPE_INFO, "   all - All");
+		return;
+	}
+
+	if (*arg1 && !strcmp(arg1, "inv"))
+		inventory = true;
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	else if (*arg1 && !strcmp(arg1, "sinv"))
+		special_inventory = true;
+#endif
+	else if (*arg1 && !strcmp(arg1, "ds"))
+		dragon_soul = true;
+	else if (*arg1 && !strcmp(arg1, "eq"))
+		equipment = true;
+	else if (*arg1 && !strcmp(arg1, "belt"))
+		belt = true;
+	else if (*arg1 && !strcmp(arg1, "all"))
+		all = true;
+	else
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, "Unknown window");
 		return;
+	}
 
-	WORD cell = 0;
-	LPITEM item = nullptr;
+	int i;
+	LPITEM item;
 
-	if (INVENTORY == window_type)
+	if (all)
 	{
-		for (cell = 0; cell < INVENTORY_MAX_NUM; ++cell)
+		for (i = 0; i < INVENTORY_AND_EQUIP_SLOT_MAX; ++i)
 		{
-			if ((item = ch->GetInventoryItem(cell)))
+			if ((item = ch->GetInventoryItem(i)))
 			{
 				if (item->isLocked())
 					continue;
-
 #ifdef __GROWTH_PET_SYSTEM__
+				/*
+					UPBRINGING/BAG item should not be deleted in any way by default.
+					If you have other functions that allow you to delete items,
+					either block destroying UPBRINGING/BAG items or add the following
+					code.
+				*/
 				if (item->GetType() == ITEM_PET)
 				{
 					if (item->GetSubType() == PET_UPBRINGING || item->GetSubType() == PET_BAG)
-						CGrowthPetManager::Instance().DeleteGrowthPet(item->GetSocket(2), true);
+						CGrowthPetManager::Instance().DeleteGrowthPet(item->GetSocket(0), true);
 				}
 #endif
-
 				ITEM_MANAGER::instance().RemoveItem(item, "PURGE");
-				ch->SyncQuickslot(SLOT_TYPE_INVENTORY, cell, WORD_MAX);
+				ch->SyncQuickslot(QUICKSLOT_TYPE_ITEM, i, 255);
 			}
 		}
 	}
-	else if (EQUIPMENT == window_type)
-	{
-		for (cell = 0; cell < EQUIPMENT_MAX_NUM; ++cell)
-			if ((item = ch->GetEquipmentItem(cell)))
-				ITEM_MANAGER::instance().RemoveItem(item, "PURGE");
-	}
-#if defined(__DRAGON_SOUL_SYSTEM__)
-	else if (DRAGON_SOUL_INVENTORY == window_type)
+	else
 	{
-		for (cell = 0; cell < DRAGON_SOUL_INVENTORY_MAX_NUM; ++cell)
-			if ((item = ch->GetItem(TItemPos(DRAGON_SOUL_INVENTORY, cell))))
-				ITEM_MANAGER::instance().RemoveItem(item, "PURGE");
-	}
+		if (inventory)
+		{
+			for (i = 0; i < INVENTORY_MAX_NUM; ++i)
+			{
+				if ((item = ch->GetInventoryItem(i)))
+				{
+					if (item->isLocked())
+						continue;
+#ifdef __GROWTH_PET_SYSTEM__
+					/*
+						UPBRINGING/BAG item should not be deleted in any way by default.
+						If you have other functions that allow you to delete items,
+						either block destroying UPBRINGING/BAG items or add the following
+						code.
+					*/
+					if (item->GetType() == ITEM_PET)
+					{
+						if (item->GetSubType() == PET_UPBRINGING || item->GetSubType() == PET_BAG)
+							CGrowthPetManager::Instance().DeleteGrowthPet(item->GetSocket(0), true);
+					}
 #endif
-	else if (BELT_INVENTORY == window_type)
+					ITEM_MANAGER::instance().RemoveItem(item, "PURGE");
+					ch->SyncQuickslot(QUICKSLOT_TYPE_ITEM, i, 255);
+				}
+			}
+		}
+	}
+
+	if (dragon_soul || all)
 	{
-		for (cell = 0; cell < BELT_INVENTORY_SLOT_COUNT; ++cell)
+		for (i = 0; i < DRAGON_SOUL_INVENTORY_MAX_NUM; ++i)
 		{
-			if ((item = ch->GetBeltInventoryItem(cell)))
+			if ((item = ch->GetItem(TItemPos(DRAGON_SOUL_INVENTORY, i))))
 			{
 				if (item->isLocked())
 					continue;
@@ -1104,55 +1322,101 @@
 			}
 		}
 	}
-	else
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, "Unknown window.");
-	}
-}
 
-ACMD(do_item_purge)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-	if (!*arg1)
-		goto USAGE;
-
-	if (!strcmp(arg1, "all"))
-	{
-		ipurge_window(ch, INVENTORY);
-		ipurge_window(ch, EQUIPMENT);
-		ipurge_window(ch, DRAGON_SOUL_INVENTORY);
-		ipurge_window(ch, BELT_INVENTORY);
-		ch->ChatPacket(CHAT_TYPE_INFO, "all items cleared");
-	}
-	else if (!strcmp(arg1, "inven"))
+	if (equipment || all)
 	{
-		ipurge_window(ch, INVENTORY);
-		ch->ChatPacket(CHAT_TYPE_INFO, "inventory items cleared");
+		for (i = 0; i < WEAR_MAX_NUM; ++i)
+		{
+			if ((item = ch->GetInventoryItem(INVENTORY_MAX_NUM + i)))
+			{
+				ITEM_MANAGER::instance().RemoveItem(item, "PURGE");
+				ch->SyncQuickslot(QUICKSLOT_TYPE_ITEM, INVENTORY_MAX_NUM + i, 255);
+			}
+		}
 	}
-	else if (!strcmp(arg1, "equip"))
+
+	if (belt || all)
 	{
-		ipurge_window(ch, EQUIPMENT);
-		ch->ChatPacket(CHAT_TYPE_INFO, "equipment items cleared!");
+		for (i = 0; i < BELT_INVENTORY_SLOT_COUNT; ++i)
+		{
+			if ((item = ch->GetInventoryItem(BELT_INVENTORY_SLOT_START + i)))
+			{
+				ITEM_MANAGER::instance().RemoveItem(item, "PURGE");
+				ch->SyncQuickslot(QUICKSLOT_TYPE_ITEM, BELT_INVENTORY_SLOT_START + i, 255);
+			}
+		}
 	}
-	else if (!strcmp(arg1, "ds"))
+
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	if (special_inventory || all)
 	{
-		ipurge_window(ch, DRAGON_SOUL_INVENTORY);
-		ch->ChatPacket(CHAT_TYPE_INFO, "dragon soul items cleared!");
+		for (BYTE byPage = 0; byPage < SPECIAL_INVENTORY_PAGE_COUNT; ++byPage)
+		{
+			switch (byPage)
+			{
+			case 0: // Skill book inventory
+			{
+				for (i = 0; i < SPECIAL_INVENTORY_MAX_NUM; ++i)
+				{
+					if ((item = ch->GetSkillBookInventoryItem(SKILL_BOOK_INVENTORY_SLOT_START + i)))
+					{
+						ITEM_MANAGER::instance().RemoveItem(item, "PURGE");
+						ch->SyncQuickslot(QUICKSLOT_TYPE_ITEM, SKILL_BOOK_INVENTORY_SLOT_START + i, 255);
+					}
+				}
+			}
+			break;
+
+			case 1: // Upgrade item inventory
+			{
+				for (i = 0; i < SPECIAL_INVENTORY_MAX_NUM; ++i)
+				{
+					if ((item = ch->GetUpgradeItemsInventoryItem(UPGRADE_ITEMS_INVENTORY_SLOT_START + i)))
+					{
+						ITEM_MANAGER::instance().RemoveItem(item, "PURGE");
+						ch->SyncQuickslot(QUICKSLOT_TYPE_ITEM, UPGRADE_ITEMS_INVENTORY_SLOT_START + i, 255);
+					}
+				}
+			}
+			break;
+
+			case 2: // Stone inventory
+			{
+				for (i = 0; i < SPECIAL_INVENTORY_MAX_NUM; ++i)
+				{
+					if ((item = ch->GetStoneInventoryItem(STONE_INVENTORY_SLOT_START + i)))
+					{
+						ITEM_MANAGER::instance().RemoveItem(item, "PURGE");
+						ch->SyncQuickslot(QUICKSLOT_TYPE_ITEM, STONE_INVENTORY_SLOT_START + i, 255);
+					}
+				}
+			}
+			break;
+
+			case 3: // Gift box inventory
+			{
+				for (i = 0; i < SPECIAL_INVENTORY_MAX_NUM; ++i)
+				{
+					if ((item = ch->GetGiftBoxInventoryItem(GIFT_BOX_INVENTORY_SLOT_START + i)))
+					{
+						ITEM_MANAGER::instance().RemoveItem(item, "PURGE");
+						ch->SyncQuickslot(QUICKSLOT_TYPE_ITEM, GIFT_BOX_INVENTORY_SLOT_START + i, 255);
+					}
+				}
+			}
+			break;
+
+			}
+		}
 	}
-	else if (!strcmp(arg1, "belt"))
+#endif
+
+	if (equipment || all)
 	{
-		ipurge_window(ch, BELT_INVENTORY);
-		ch->ChatPacket(CHAT_TYPE_INFO, "belt items cleared!");
+		for (BYTE byPart = PART_MAIN; byPart < PART_MAX_NUM; ++byPart)
+			ch->SetPart(byPart, FALSE);
+		ch->UpdatePacket();
 	}
-	else
-		goto USAGE;
-
-	return;
-
-USAGE:
-	ch->ChatPacket(CHAT_TYPE_INFO, "usage : ipurge <window>");
-	ch->ChatPacket(CHAT_TYPE_INFO, "		<window> inven, equip, ds, belt");
 }
 
 ACMD(do_state)
@@ -1224,21 +1488,10 @@
 	ch->ChatPacket(CHAT_TYPE_INFO, "LEV %d", tch->GetLevel());
 	ch->ChatPacket(CHAT_TYPE_INFO, "HP %d/%d", tch->GetHP(), tch->GetMaxHP());
 	ch->ChatPacket(CHAT_TYPE_INFO, "SP %d/%d", tch->GetSP(), tch->GetMaxSP());
-
-	ch->ChatPacket(CHAT_TYPE_INFO, "SUNGMA_STR %d SUNGMA_HP %d SUNGMA_MOVE %d SUNGMA_IMMUNE %d",
-		tch->GetPoint(POINT_SUNGMA_STR),
-		tch->GetPoint(POINT_SUNGMA_HP),
-		tch->GetPoint(POINT_SUNGMA_MOVE),
-		tch->GetPoint(POINT_SUNGMA_IMMUNE)
-	);
-
-	ch->ChatPacket(CHAT_TYPE_INFO, "ATT_SPD %d/%d (LIMIT) MOVE_SPD %d/%d (LIMIT) CAST_SPD %d",
-		tch->GetPoint(POINT_ATT_SPEED), tch->GetLimitPoint(POINT_ATT_SPEED),
-		tch->GetPoint(POINT_MOV_SPEED), tch->GetLimitPoint(POINT_MOV_SPEED),
-		tch->GetPoint(POINT_CASTING_SPEED));
-	ch->ChatPacket(CHAT_TYPE_INFO, "ATT %d MAGIC_ATT %d CRIT %d%% PENE %d%% ATT_BONUS %d%%",
+	ch->ChatPacket(CHAT_TYPE_INFO, "ATT %d MAGIC_ATT %d SPD %d CRIT %d%% PENE %d%% ATT_BONUS %d%%",
 		tch->GetPoint(POINT_ATT_GRADE),
 		tch->GetPoint(POINT_MAGIC_ATT_GRADE),
+		tch->GetPoint(POINT_ATT_SPEED),
 		tch->GetPoint(POINT_CRITICAL_PCT),
 		tch->GetPoint(POINT_PENETRATE_PCT),
 		tch->GetPoint(POINT_ATT_BONUS));
@@ -1249,14 +1502,16 @@
 		tch->GetPoint(POINT_DODGE),
 		tch->GetPoint(POINT_DEF_BONUS));
 	ch->ChatPacket(CHAT_TYPE_INFO, "RESISTANCES:");
-	ch->ChatPacket(CHAT_TYPE_INFO, "   WARR:%3d%% ASAS:%3d%% SURA:%3d%% SHAM:%3d%% WOLF:%3d%%"
+	ch->ChatPacket(CHAT_TYPE_INFO, "   WARR:%3d%% ASAS:%3d%% SURA:%3d%% SHAM:%3d%%"
+		" WOLF:%3d%%"
 		, tch->GetPoint(POINT_RESIST_WARRIOR)
 		, tch->GetPoint(POINT_RESIST_ASSASSIN)
 		, tch->GetPoint(POINT_RESIST_SURA)
 		, tch->GetPoint(POINT_RESIST_SHAMAN)
 		, tch->GetPoint(POINT_RESIST_WOLFMAN)
 	);
-	ch->ChatPacket(CHAT_TYPE_INFO, "   SWORD:%3d%% THSWORD:%3d%% DAGGER:%3d%% BELL:%3d%% FAN:%3d%% BOW:%3d%% CLAW:%3d%%"
+	ch->ChatPacket(CHAT_TYPE_INFO, "   SWORD:%3d%% THSWORD:%3d%% DAGGER:%3d%% BELL:%3d%% FAN:%3d%% BOW:%3d%%"
+		" CLAW:%3d%%"
 		, tch->GetPoint(POINT_RESIST_SWORD)
 		, tch->GetPoint(POINT_RESIST_TWOHAND)
 		, tch->GetPoint(POINT_RESIST_DAGGER)
@@ -1350,22 +1605,21 @@
 			int iByPlayer = CPrivManager::instance().GetPrivByCharacter(tch->GetPlayerID(), i);
 
 			if (iByEmpire)
-				ch->ChatPacket(CHAT_TYPE_INFO, "%s for empire : %d", c_apszPrivNames[i], iByEmpire);
+				ch->ChatPacket(CHAT_TYPE_INFO, "%s for empire : %d", LC_TEXT(c_apszPrivNames[i]), iByEmpire);
 
 			if (iByGuild)
-				ch->ChatPacket(CHAT_TYPE_INFO, "%s for guild : %d", c_apszPrivNames[i], iByGuild);
+				ch->ChatPacket(CHAT_TYPE_INFO, "%s for guild : %d", LC_TEXT(c_apszPrivNames[i]), iByGuild);
 
 			if (iByPlayer)
-				ch->ChatPacket(CHAT_TYPE_INFO, "%s for player : %d", c_apszPrivNames[i], iByPlayer);
+				ch->ChatPacket(CHAT_TYPE_INFO, "%s for player : %d", LC_TEXT(c_apszPrivNames[i]), iByPlayer);
 		}
 }
 
 struct notice_packet_func
 {
 	const char* m_str;
-	const bool m_big;
 
-	notice_packet_func(const char* str, const bool big) : m_str(str), m_big(big)
+	notice_packet_func(const char* str) : m_str(str)
 	{
 	}
 
@@ -1374,29 +1628,26 @@
 		if (!d->GetCharacter())
 			return;
 
-		d->GetCharacter()->ChatPacket(m_big ? CHAT_TYPE_BIG_NOTICE : CHAT_TYPE_NOTICE, "%s", m_str);
+		d->GetCharacter()->ChatPacket(CHAT_TYPE_NOTICE, "%s", m_str);
 	}
 };
 
-#if defined(__DUNGEON_RENEWAL__)
-struct party_notice_packet_func
+struct big_notice_packet_func
 {
-	const LPPARTY m_pParty;
-	const char* m_szBuf;
-	party_notice_packet_func(const LPPARTY c_pParty, const char* c_szBuf) : m_pParty(c_pParty), m_szBuf(c_szBuf) {}
-	void operator () (LPDESC d)
+	const char* m_str;
+
+	big_notice_packet_func(const char* str) : m_str(str)
 	{
-		const LPCHARACTER& pChar = d->GetCharacter();
-		if (pChar == nullptr)
-			return;
+	}
 
-		if (pChar->GetParty() != m_pParty)
+	void operator () (LPDESC d)
+	{
+		if (!d->GetCharacter())
 			return;
 
-		pChar->ChatPacket(CHAT_TYPE_PARTY, "%s", m_szBuf);
+		d->GetCharacter()->ChatPacket(CHAT_TYPE_BIG_NOTICE, "%s", m_str);
 	}
 };
-#endif
 
 struct monarch_notice_packet_func
 {
@@ -1419,72 +1670,233 @@
 	}
 };
 
-void SendNotice(const char* c_pszBuf, const bool c_bBigFont)
+void SendLocaleNotice(const char* c_pszNotice, bool bBigFont, ...)
 {
 	const DESC_MANAGER::DESC_SET& c_ref_set = DESC_MANAGER::instance().GetClientSet();
-	std::for_each(c_ref_set.begin(), c_ref_set.end(), notice_packet_func(c_pszBuf, c_bBigFont));
+	DESC_MANAGER::DESC_SET::const_iterator it = c_ref_set.begin();
+
+	while (it != c_ref_set.end())
+	{
+		LPDESC d = *(it++);
+		if (d->GetCharacter())
+		{
+			std::string strMsg = c_pszNotice;
+			const char* c_pszBuf;
+
+			if (!strMsg.empty() && std::all_of(strMsg.begin(), strMsg.end(), ::isdigit))
+			{
+				DWORD dwKey = atoi(c_pszNotice);
+				BYTE bLanguage = (d ? d->GetLanguage() : LOCALE_YMIR);
+
+				c_pszBuf = LC_LOCALE_QUEST_TEXT(dwKey, bLanguage);
+			}
+			else
+			{
+				c_pszBuf = c_pszNotice;
+			}
+
+			std::string strBuffFilter = c_pszBuf;
+			std::string strReplace("%d");
+
+			size_t pos = 0;
+			while ((pos = strBuffFilter.find(strReplace)) != std::string::npos)
+			{
+				strBuffFilter.replace(pos, strReplace.length(), "%s");
+			}
+
+			const char* c_pszConvBuf = strBuffFilter.c_str();
+			char szNoticeBuf[CHAT_MAX_LEN + 1];
+
+			va_list args;
+			va_start(args, bBigFont);
+			int len = vsnprintf(szNoticeBuf, sizeof(szNoticeBuf), c_pszConvBuf, args);
+			va_end(args);
+
+			const char* c_pszToken;
+			const char* c_pszLast = szNoticeBuf;
+
+			std::string strBuff = szNoticeBuf;
+			std::string strDelim = "[ENTER]";
+			std::string strToken;
+
+			while ((pos = strBuff.find(strDelim)) != std::string::npos)
+			{
+				strToken = strBuff.substr(0, pos);
+				c_pszToken = strToken.c_str();
+				d->GetCharacter()->ChatPacket(bBigFont ? CHAT_TYPE_BIG_NOTICE : CHAT_TYPE_NOTICE, "%s", c_pszToken);
+
+				c_pszLast = strBuff.erase(0, pos + strDelim.length()).c_str();
+			}
+			d->GetCharacter()->ChatPacket(bBigFont ? CHAT_TYPE_BIG_NOTICE : CHAT_TYPE_NOTICE, "%s", c_pszLast);
+		}
+	}
 }
 
-void SendMonarchNotice(BYTE bEmpire, const char* c_pszBuf)
+void SendRestrictedNotice(const char* c_pszBuf,
+	const char* c_pszEmpireName,
+	const char* c_pszGuildName,
+	const char* c_pszPrivName,
+	int iValue
+)
 {
 	const DESC_MANAGER::DESC_SET& c_ref_set = DESC_MANAGER::instance().GetClientSet();
-	std::for_each(c_ref_set.begin(), c_ref_set.end(), monarch_notice_packet_func(bEmpire, c_pszBuf));
+	DESC_MANAGER::DESC_SET::const_iterator it = c_ref_set.begin();
+
+	if (!c_pszBuf)
+		return;
+
+	while (it != c_ref_set.end())
+	{
+		LPDESC d = *(it++);
+
+		if (d->GetCharacter())
+		{
+			// Empire Priv
+			if (!c_pszGuildName && (c_pszEmpireName && c_pszPrivName))
+			{
+				const char* c_pszEmpireBuf = LC_LOCALE_TEXT(c_pszEmpireName, d->GetLanguage());
+				const char* c_pszPrivBuf = LC_LOCALE_TEXT(c_pszPrivName, d->GetLanguage());
+				if (iValue != 0)
+					TransNotice(d, c_pszBuf, c_pszEmpireBuf, c_pszPrivBuf, iValue);
+				else
+					TransNotice(d, c_pszBuf, c_pszEmpireBuf, c_pszPrivBuf);
+			}
+			// Guild Priv
+			else if (!c_pszEmpireName && (c_pszGuildName && c_pszPrivName))
+			{
+				const char* c_pszPrivBuf = LC_LOCALE_TEXT(c_pszPrivName, d->GetLanguage());
+				if (iValue != 0)
+					TransNotice(d, c_pszBuf, c_pszGuildName, c_pszPrivBuf, iValue);
+				else
+					TransNotice(d, c_pszBuf, c_pszGuildName, c_pszPrivBuf);
+			}
+			// Empire Notice (For Caste Siege)
+			else if (!c_pszGuildName && (c_pszEmpireName && !c_pszPrivName))
+			{
+				const char* c_pszEmpireBuf = LC_LOCALE_TEXT(c_pszEmpireName, d->GetLanguage());
+				TransNotice(d, c_pszBuf, c_pszEmpireBuf);
+			}
+			// Defaul Notice
+			else
+			{
+				TransNotice(d, c_pszBuf);
+			}
+		}
+	}
 }
 
-#if defined(__DUNGEON_RENEWAL__)
-void SendPartyNotice(const LPPARTY c_pParty, const char* c_pszBuf)
+void TransNotice(LPDESC pkDesc, const char* c_pszBuf, ...)
 {
-	const DESC_MANAGER::DESC_SET& c_ref_set = DESC_MANAGER::instance().GetClientSet();
-	std::for_each(c_ref_set.begin(), c_ref_set.end(), party_notice_packet_func(c_pParty, c_pszBuf));
+	if (!pkDesc || !c_pszBuf)
+		return;
+
+	if (pkDesc->GetCharacter())
+	{
+		const char* c_szLocaleFormat = LC_LOCALE_TEXT(c_pszBuf, pkDesc->GetLanguage());
+
+		char szChatBuf[CHAT_MAX_LEN + 1];
+		va_list args;
+
+		va_start(args, c_pszBuf);
+		int len = vsnprintf(szChatBuf, sizeof(szChatBuf), c_szLocaleFormat, args);
+		va_end(args);
+
+		pkDesc->GetCharacter()->ChatPacket(CHAT_TYPE_NOTICE, "%s", szChatBuf);
+	}
 }
-#endif
 
-struct notice_map_packet_func
+struct direct_notice_packet_func
 {
 	const char* m_str;
-	int m_mapIndex;
-	bool m_bBigFont;
 
-	notice_map_packet_func(const char* str, int idx, bool bBigFont) : m_str(str), m_mapIndex(idx), m_bBigFont(bBigFont)
-	{
-	}
+	direct_notice_packet_func(const char* str) : m_str(str) {}
 
-	void operator() (LPDESC d)
+	void operator () (LPDESC d)
 	{
-		if (d->GetCharacter() == NULL) return;
-		if (d->GetCharacter()->GetMapIndex() != m_mapIndex) return;
+		if (!d->GetCharacter())
+			return;
 
-		d->GetCharacter()->ChatPacket(m_bBigFont == true ? CHAT_TYPE_BIG_NOTICE : CHAT_TYPE_NOTICE, "%s", m_str);
+		d->GetCharacter()->ChatPacket(CHAT_TYPE_NOTICE, "%s", m_str);
 	}
 };
-
-void SendNoticeMap(const char* c_pszBuf, int nMapIndex, bool bBigFont)
+void SendDirectNotice(const char* c_pszBuf)
 {
 	const DESC_MANAGER::DESC_SET& c_ref_set = DESC_MANAGER::instance().GetClientSet();
-	std::for_each(c_ref_set.begin(), c_ref_set.end(), notice_map_packet_func(c_pszBuf, nMapIndex, bBigFont));
+	std::for_each(c_ref_set.begin(), c_ref_set.end(), direct_notice_packet_func(c_pszBuf));
 }
 
-#if defined(__OX_RENEWAL__)
-struct control_notice_packet_func
+void SendNotice(const char* c_pszBuf, ...)
 {
-	const char* m_str;
-	int m_mapIndex;
-	control_notice_packet_func(const char* str, int idx) : m_str(str), m_mapIndex(idx) {}
+	const DESC_MANAGER::DESC_SET& c_ref_set = DESC_MANAGER::instance().GetClientSet();
 
-	void operator() (LPDESC d)
+	if (!c_pszBuf)
+		return;
+
+	DESC_MANAGER::DESC_SET::const_iterator it = c_ref_set.begin();
+
+	while (it != c_ref_set.end())
 	{
-		if (d->GetCharacter() == NULL) return;
-		if (d->GetCharacter()->GetMapIndex() != m_mapIndex) return;
-		d->GetCharacter()->ChatPacket(CHAT_TYPE_BIG_CONTROL_NOTICE, "%s", m_str);
+		LPDESC d = *(it++);
+
+		if (d->GetCharacter())
+		{
+			const char* c_szLocaleFormat = LC_LOCALE_TEXT(c_pszBuf, d->GetLanguage());
+			char szChatBuf[CHAT_MAX_LEN + 1];
+
+			va_list args;
+
+			va_start(args, c_pszBuf);
+			int len = vsnprintf(szChatBuf, sizeof(szChatBuf), c_szLocaleFormat, args);
+			va_end(args);
+
+			d->GetCharacter()->ChatPacket(CHAT_TYPE_NOTICE, "%s", szChatBuf);
+		}
 	}
-};
+}
 
-void SendControlNoticeMap(const char* c_pszBuf, int nMapIndex)
+void SendBigNotice(const char* c_pszBuf)
 {
 	const DESC_MANAGER::DESC_SET& c_ref_set = DESC_MANAGER::instance().GetClientSet();
-	std::for_each(c_ref_set.begin(), c_ref_set.end(), control_notice_packet_func(c_pszBuf, nMapIndex));
+	std::for_each(c_ref_set.begin(), c_ref_set.end(), big_notice_packet_func(c_pszBuf));
+}
+
+void SendMonarchNotice(BYTE bEmpire, const char* c_pszBuf)
+{
+	const DESC_MANAGER::DESC_SET& c_ref_set = DESC_MANAGER::instance().GetClientSet();
+	std::for_each(c_ref_set.begin(), c_ref_set.end(), monarch_notice_packet_func(bEmpire, c_pszBuf));
+}
+
+void SendNoticeMap(const char* c_szBuf, int iMapIndex, bool bBigFont, ...)
+{
+	const DESC_MANAGER::DESC_SET& c_ref_set = DESC_MANAGER::instance().GetClientSet();
+	DESC_MANAGER::DESC_SET::const_iterator it = c_ref_set.begin();
+
+	while (it != c_ref_set.end())
+	{
+		LPDESC d = *(it++);
+		if (d->GetCharacter())
+		{
+			if (d->GetCharacter()->GetMapIndex() != iMapIndex)
+				continue;
+
+			char szChatBuf[CHAT_MAX_LEN + 1];
+			const char* c_szLocaleFormat = {};
+			std::string strBuf = c_szBuf;
+
+			if (std::all_of(strBuf.begin(), strBuf.end(), ::isdigit))
+				c_szLocaleFormat = LC_LOCALE_QUEST_TEXT(atoi(c_szBuf), d->GetLanguage());
+			else
+				c_szLocaleFormat = LC_LOCALE_TEXT(c_szBuf, d->GetLanguage());
+
+			va_list szArgs;
+			va_start(szArgs, bBigFont);
+			int len = vsnprintf(szChatBuf, sizeof(szChatBuf), c_szLocaleFormat, szArgs);
+			va_end(szArgs);
+
+			d->GetCharacter()->ChatPacket(bBigFont ? CHAT_TYPE_BIG_NOTICE : CHAT_TYPE_NOTICE, "%s", szChatBuf);
+		}
+	}
 }
-#endif
 
 struct log_packet_func
 {
@@ -1510,12 +1922,40 @@
 	std::for_each(c_ref_set.begin(), c_ref_set.end(), log_packet_func(c_pszBuf));
 }
 
-void BroadcastNotice(const char* c_pszBuf, const bool c_bBigFont)
+void BroadcastRestrictedNotice(const char* c_pszBuf, /* const char* */ ...)
+{
+	TPacketGGNotice p;
+	p.bHeader = HEADER_GG_NOTICE;
+	p.lSize = strlen(c_pszBuf) + 1;
+
+	char szArg[CHAT_MAX_LEN + 1];
+	int iArgLen = 0;
+	va_list args;
+	{
+		va_start(args, c_pszBuf);
+		iArgLen = vsnprintf(szArg, sizeof(szArg), "%s", args);
+		va_end(args);
+	}
+	if (iArgLen > 0)
+		strlcpy(p.szArg, szArg, sizeof(p.szArg));
+
+	TEMP_BUFFER buf;
+	buf.write(&p, sizeof(p));
+	buf.write(c_pszBuf, p.lSize);
+
+	P2P_MANAGER::instance().Send(buf.read_peek(), buf.size()); // HEADER_GG_NOTICE
+
+	if (iArgLen != 0)
+		SendRestrictedNotice(c_pszBuf, szArg);
+	else
+		SendRestrictedNotice(c_pszBuf);
+}
+
+void BroadcastNotice(const char* c_pszBuf, bool bLocale)
 {
 	TPacketGGNotice p;
 	p.bHeader = HEADER_GG_NOTICE;
 	p.lSize = strlen(c_pszBuf) + 1;
-	p.bBigFont = c_bBigFont;
 
 	TEMP_BUFFER buf;
 	buf.write(&p, sizeof(p));
@@ -1523,7 +1963,25 @@
 
 	P2P_MANAGER::instance().Send(buf.read_peek(), buf.size()); // HEADER_GG_NOTICE
 
-	SendNotice(c_pszBuf, c_bBigFont);
+	if (bLocale)
+		SendNotice(c_pszBuf);
+	else
+		SendDirectNotice(c_pszBuf);
+}
+
+void BroadcastBigNotice(const char* c_pszBuf)
+{
+	TPacketGGBigNotice p;
+	p.bHeader = HEADER_GG_BIG_NOTICE;
+	p.lSize = strlen(c_pszBuf) + 1;
+
+	TEMP_BUFFER buf;
+	buf.write(&p, sizeof(p));
+	buf.write(c_pszBuf, p.lSize);
+
+	P2P_MANAGER::instance().Send(buf.read_peek(), buf.size()); // HEADER_GG_BIG_NOTICE
+
+	SendBigNotice(c_pszBuf);
 }
 
 void BroadcastMonarchNotice(BYTE bEmpire, const char* c_pszBuf)
@@ -1544,32 +2002,38 @@
 
 ACMD(do_notice)
 {
-	char buf[CHAT_MAX_LEN + 1];
-	snprintf(buf, sizeof(buf), "%s : %s", ch->GetName(), argument);
-	BroadcastNotice(buf);
+	if (g_bBroadcastName)
+	{
+		char szChatBuf[CHAT_MAX_LEN + 1];
+		snprintf(szChatBuf, sizeof(szChatBuf), "%s :%s", ch->GetName(), argument);
+		BroadcastNotice(szChatBuf, false);
+	}
+	else
+	{
+		BroadcastNotice(argument, false);
+	}
 }
 
 ACMD(do_map_notice)
 {
-	char buf[CHAT_MAX_LEN + 1];
-	snprintf(buf, sizeof(buf), "%s : %s", ch->GetName(), argument);
-	SendNoticeMap(buf, ch->GetMapIndex(), false);
+	SendNoticeMap(argument, ch->GetMapIndex(), false);
 }
 
 ACMD(do_big_notice)
 {
-	BroadcastNotice(argument, true);
+	//ch->ChatPacket(CHAT_TYPE_BIG_NOTICE, "%s", argument);
+	BroadcastBigNotice(argument);
 }
 
 ACMD(do_monarch_notice)
 {
-	if (ch->IsMonarch() == TRUE)
+	if (ch->IsMonarch() == true)
 	{
 		BroadcastMonarchNotice(ch->GetEmpire(), argument);
 	}
 	else
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ָ   Դϴ"));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ָ   Դϴ"));
 	}
 }
 
@@ -1763,57 +2227,31 @@
 	tch->AttackedByBleeding(NULL);
 }
 
-ACMD(do_fire)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	if (!*arg1)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, "ex) /fire <player name>");
-		return;
-	}
-
-	LPDESC d = DESC_MANAGER::instance().FindByCharacterName(arg1);
-	LPCHARACTER tch = d ? d->GetCharacter() : NULL;
-
-	if (!tch)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, "%s: no such a player", arg1);
-		return;
-	}
-
-	tch->AttackedByFire(NULL, number(1, 5), 5);
-}
-
 #define MISC 0
 #define BINARY 1
 #define NUMBER 2
 
 const struct set_struct
 {
-	const char key;
 	const char* cmd;
 	const char type;
 } set_fields[] = {
-	{ SET_CMD_GOLD, "gold", NUMBER },
-	{ SET_CMD_RACE, "race", BINARY },
-	{ SET_CMD_SEX, "sex", BINARY },
-	{ SET_CMD_EXP, "exp", NUMBER },
-	{ SET_CMD_MAX_HP, "max_hp", NUMBER },
-	{ SET_CMD_MAX_SP, "max_sp", NUMBER },
-	{ SET_CMD_SKILL, "skill", NUMBER },
-	{ SET_CMD_ALIGN, "align", NUMBER },
+	{ "gold", NUMBER },
+	{ "race", BINARY },
+	{ "sex", BINARY },
+	{ "exp", NUMBER },
+	{ "max_hp", NUMBER },
+	{ "max_sp", NUMBER },
+	{ "skill", NUMBER },
+	{ "alignment", NUMBER },
+	{ "align", NUMBER },
 #if defined(__CHEQUE_SYSTEM__)
-	{ SET_CMD_CHEQUE, "cheque", NUMBER },
+	{ "cheque", NUMBER },
 #endif
 #if defined(__GEM_SYSTEM__)
-	{ SET_CMD_GEM, "gem", NUMBER },
+	{ "gem", NUMBER },
 #endif
-#if defined(__EXPRESSING_EMOTIONS__)
-	{ SET_CMD_ACTION, "action", NUMBER },
-#endif
-	{ SET_CMD_MAX_NUN, "\n", MISC }
+	{ "\n", MISC }
 };
 
 ACMD(do_set)
@@ -1835,6 +2273,7 @@
 	}
 
 	tch = CHARACTER_MANAGER::instance().FindPC(arg1);
+
 	if (!tch)
 	{
 		ch->ChatPacket(CHAT_TYPE_INFO, "%s not exist", arg1);
@@ -1849,237 +2288,126 @@
 
 	switch (i)
 	{
-		case SET_CMD_GOLD:
-		{
-			POINT_VALUE gold = 0;
-			safe_str_to_number(gold, arg3);
-
-			int before_gold = tch->GetGold();
-			gold = MINMAXLL(0, (long long)before_gold + gold, GOLD_MAX - 1);
-
-			tch->SetPoint(POINT_GOLD, gold);
-			tch->SetGold(gold);
-			tch->UpdatePointsPacket(POINT_GOLD, gold);
-
-			int after_gold = tch->GetGold();
-
-			if (0 == after_gold && 0 != before_gold)
-				LogManager::instance().CharLog(tch, gold, "ZERO_GOLD", "GM");
-
-			if (before_gold != after_gold)
-			{
-				int gold_diff = after_gold - before_gold;
-				if (gold_diff < 0)
-					DBManager::instance().SendMoneyLog(MONEY_LOG_MISC, 3, -gold_diff);
-				else
-					DBManager::instance().SendMoneyLog(MONEY_LOG_MISC, 3, gold_diff);
-			}
-		}
-		break;
-
-		case SET_CMD_RACE:
-		{
-			BYTE race;
-			str_to_number(race, arg3);
-
-			if (race < 0 || race >= MAIN_RACE_MAX_NUM)
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, "RACE_WARRIOR_M = 0");
-				ch->ChatPacket(CHAT_TYPE_INFO, "RACE_ASSASSIN_W = 1");
-				ch->ChatPacket(CHAT_TYPE_INFO, "RACE_SURA_M = 2");
-				ch->ChatPacket(CHAT_TYPE_INFO, "RACE_SHAMAN_W = 3");
-				ch->ChatPacket(CHAT_TYPE_INFO, "RACE_WARRIOR_W = 4");
-				ch->ChatPacket(CHAT_TYPE_INFO, "RACE_ASSASSIN_M = 5");
-				ch->ChatPacket(CHAT_TYPE_INFO, "RACE_SURA_W = 6");
-				ch->ChatPacket(CHAT_TYPE_INFO, "RACE_SHAMAN_M = 7");
-#if defined(__WOLFMAN_CHARACTER__) && !defined(__DISABLE_WOLFMAN_CREATION__)
-				ch->ChatPacket(CHAT_TYPE_INFO, "RACE_WOLFMAN_M = 8");
-#endif
-				return;
-			}
-
-			tch->SetRace(race);
-
-			tch->ClearSkill();
-			tch->ClearSubSkill();
-			tch->SetSkillGroup(0);
-
-			tch->SetPolymorph(101);
-			tch->SetPolymorph(0);
+	case 0: // gold
+	{
+		long long gold = 0;
+		str_to_number(gold, arg3);
+		DBManager::instance().SendMoneyLog(MONEY_LOG_MISC, 3, gold);
+		long before_gold = tch->GetGold();
+		tch->PointChange(POINT_GOLD, gold, true);
+		long after_gold = tch->GetGold();
+		if (0 == after_gold && 0 != before_gold)
+		{
+			LogManager::instance().CharLog(tch, gold, "ZERO_GOLD", "GM");
+		}
+	}
+	break;
+
+	case 1: // race
+	{
+		BYTE bRace;
+		str_to_number(bRace, arg3);
+		if (bRace > 8 || bRace < 0)
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, "RACE_WARRIOR_M = 0");
+			ch->ChatPacket(CHAT_TYPE_INFO, "RACE_ASSASSIN_W = 1");
+			ch->ChatPacket(CHAT_TYPE_INFO, "RACE_SURA_M = 2");
+			ch->ChatPacket(CHAT_TYPE_INFO, "RACE_SHAMAN_W = 3");
+			ch->ChatPacket(CHAT_TYPE_INFO, "RACE_WARRIOR_W = 4");
+			ch->ChatPacket(CHAT_TYPE_INFO, "RACE_ASSASSIN_M = 5");
+			ch->ChatPacket(CHAT_TYPE_INFO, "RACE_SURA_W = 6");
+			ch->ChatPacket(CHAT_TYPE_INFO, "RACE_SHAMAN_M = 7");
+			ch->ChatPacket(CHAT_TYPE_INFO, "RACE_WOLFMAN_M = 8");
+			return;
 		}
-		break;
-
-		case SET_CMD_SEX:
-		{
-			BYTE sex = 0;
-			str_to_number(sex, arg3);
-
-			if (sex < SEX_MALE || sex > SEX_FEMALE)
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, "SEX_MALE = 0");
-				ch->ChatPacket(CHAT_TYPE_INFO, "SEX_FEMALE = 1");
-				return;
-			}
 
-			BYTE race = 0;
-			switch (tch->GetJob())
-			{
-				case JOB_WARRIOR:
-					race = (sex == SEX_MALE) ? MAIN_RACE_WARRIOR_M : MAIN_RACE_WARRIOR_W;
-					break;
-				case JOB_ASSASSIN:
-					race = (sex == SEX_MALE) ? MAIN_RACE_ASSASSIN_M : MAIN_RACE_ASSASSIN_W;
-					break;
-				case JOB_SURA:
-					race = (sex == SEX_MALE) ? MAIN_RACE_SURA_M : MAIN_RACE_SURA_W;
-					break;
-				case JOB_SHAMAN:
-					race = (sex == SEX_MALE) ? MAIN_RACE_SHAMAN_M : MAIN_RACE_SHAMAN_W;
-					break;
-#if defined(__WOLFMAN_CHARACTER__)
-				case JOB_WOLFMAN:
-					race = (sex == SEX_MALE) ? MAIN_RACE_WOLFMAN_M : MAIN_RACE_WOLFMAN_M;
-					break;
-#endif
-			}
+		ch->SetRace(bRace);
+		ch->ClearSkill();
+		ch->ClearSubSkill();
+		ch->SetSkillGroup(0);
 
-			tch->SetRace(race);
+		ch->SetPolymorph(101);
+		ch->SetPolymorph(0);
+	}
+	break;
 
-			tch->SetPolymorph(101);
-			tch->SetPolymorph(0);
-		}
+	case 2: // sex
 		break;
 
-		case SET_CMD_EXP:
-		{
-			POINT_VALUE amount = 0;
-			safe_str_to_number(amount, arg3);
-
-			amount = MINMAXLL(POINT_MIN, amount, POINT_MAX);
-
+	case 3: // exp
+	{
+		long long amount = 0;
+		str_to_number(amount, arg3);
 #if defined(__CONQUEROR_LEVEL__)
-			if (tch->GetConquerorLevel() > 0)
-				tch->PointChange(POINT_CONQUEROR_EXP, amount, true);
-			else
-				tch->PointChange(POINT_EXP, amount, true);
-#else
+		if (tch->GetConquerorLevel() > 0)
+			tch->PointChange(POINT_CONQUEROR_EXP, amount, true);
+		else
 			tch->PointChange(POINT_EXP, amount, true);
-#endif
-		}
-		break;
-
-		case SET_CMD_MAX_HP:
-		{
-			POINT_VALUE amount = 0;
-			safe_str_to_number(amount, arg3);
-
-			amount = MINMAXLL(POINT_MIN, amount, POINT_MAX);
-
-			tch->PointChange(POINT_MAX_HP, amount, true);
-		}
-		break;
-
-		case SET_CMD_MAX_SP:
-		{
-			POINT_VALUE amount = 0;
-			safe_str_to_number(amount, arg3);
-
-			amount = MINMAXLL(POINT_MIN, amount, POINT_MAX);
-
-			tch->PointChange(POINT_MAX_SP, amount, true);
-		}
-		break;
-
-		case SET_CMD_SKILL: // active skill point
-		{
-			POINT_VALUE amount = 0;
-			safe_str_to_number(amount, arg3);
-
-			amount = MINMAXLL(POINT_MIN, amount, POINT_MAX);
+#else
+		tch->PointChange(POINT_EXP, amount, true);
+#endif	
+	}
+	break;
 
-			tch->PointChange(POINT_SKILL, amount, true);
-		}
-		break;
+	case 4: // max_hp
+	{
+		int amount = 0;
+		str_to_number(amount, arg3);
+		tch->PointChange(POINT_MAX_HP, amount, true);
+	}
+	break;
 
-		case SET_CMD_ALIGN:
-		{
-			int amount = 0;
-			safe_str_to_number(amount, arg3);
+	case 5: // max_sp
+	{
+		int amount = 0;
+		str_to_number(amount, arg3);
+		tch->PointChange(POINT_MAX_SP, amount, true);
+	}
+	break;
 
-			amount = MINMAXLL(INT_MIN, amount, INT_MAX);
+	case 6: // active skill point
+	{
+		int amount = 0;
+		str_to_number(amount, arg3);
+		tch->PointChange(POINT_SKILL, amount, true);
+	}
+	break;
 
-			tch->UpdateAlignment(amount - tch->GetRealAlignment());
-		}
-		break;
+	case 7: // alignment
+	case 8: // alignment
+	{
+		int amount = 0;
+		str_to_number(amount, arg3);
+		tch->UpdateAlignment(amount - ch->GetRealAlignment());
+	}
+	break;
 
 #if defined(__CHEQUE_SYSTEM__)
-		case SET_CMD_CHEQUE:
-		{
-			POINT_VALUE cheque = 0;
-			safe_str_to_number(cheque, arg3);
-
-			int before_cheque = tch->GetCheque();
-			cheque = MINMAXLL(0, (long long)before_cheque + cheque, CHEQUE_MAX);
-
-			tch->SetPoint(POINT_CHEQUE, cheque);
-			tch->SetCheque(cheque);
-			tch->UpdatePointsPacket(POINT_CHEQUE, cheque);
-
-			int after_cheque = tch->GetCheque();
-			if (0 == after_cheque && 0 != before_cheque)
-				LogManager::instance().CharLog(tch, cheque, "ZERO_CHEQUE", "GM");
-
-			if (before_cheque != after_cheque)
-			{
-				int cheque_diff = after_cheque - before_cheque;
-				if (cheque_diff < 0)
-					DBManager::instance().SendMoneyLog(MONEY_LOG_MISC, 3, 0, -cheque_diff);
-				else
-					DBManager::instance().SendMoneyLog(MONEY_LOG_MISC, 3, 0, cheque_diff);
-			}
-		}
-		break;
+	case 9: // cheque
+	{
+		int cheque = 0;
+		str_to_number(cheque, arg3);
+		tch->PointChange(POINT_CHEQUE, cheque, true);
+	}
+	break;
 #endif
 
 #if defined(__GEM_SYSTEM__)
-		case SET_CMD_GEM:
-		{
-			POINT_VALUE gem = 0;
-			safe_str_to_number(gem, arg3);
-
-			int before_gem = tch->GetGem();
-			gem = MINMAXLL(0, (long long)before_gem + gem, GEM_MAX);
-
-			tch->SetPoint(POINT_GEM, gem);
-			tch->SetGem(gem);
-			tch->UpdatePointsPacket(POINT_GEM, gem);
-
-			int after_gem = tch->GetGem();
-			if (0 == after_gem && 0 != before_gem)
-				LogManager::instance().CharLog(tch, gem, "ZERO_GEM", "GM");
-		}
-		break;
-#endif
-
-#if defined(__EXPRESSING_EMOTIONS__)
-		case SET_CMD_ACTION:
-		{
-			int emote_idx = 0;
-			safe_str_to_number(emote_idx, arg3);
-
-			emote_idx = MINMAXLL(0, emote_idx, INT_MAX);
-
-			tch->AddEmote(emote_idx);
-		}
-		break;
+	case 10: // gem
+	{
+		int gem = 0;
+		str_to_number(gem, arg3);
+		tch->PointChange(POINT_GEM, gem, true);
+	}
+	break;
 #endif
 	}
 
 	if (set_fields[i].type == NUMBER)
 	{
 		long long amount = 0;
-		safe_str_to_number(amount, arg3);
-		ch->ChatPacket(CHAT_TYPE_INFO, "%s's %s set to [%lld]", tch->GetName(), set_fields[i].cmd, amount);
+		str_to_number(amount, arg3);
+		ch->ChatPacket(CHAT_TYPE_INFO, "%s's %s set to [%d]", tch->GetName(), set_fields[i].cmd, amount);
 	}
 }
 
@@ -2168,12 +2496,12 @@
 
 	if (!check_name(cp.name))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("   ̸ Դϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("   ̸ Դϴ."));
 		return;
 	}
 
 	gm.CreateGuild(cp);
-	ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("(%s) 尡 Ǿϴ. [ӽ]", cp.name));
+	ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("(%s) 尡 Ǿϴ. [ӽ]"), cp.name);
 }
 
 ACMD(do_deleteguild)
@@ -2264,7 +2592,6 @@
 	if (ch->IsAffectFlag(AFF_INVISIBILITY))
 	{
 		ch->RemoveAffect(AFFECT_INVISIBILITY);
-		ch->EffectPacket(30);
 	}
 	else
 	{
@@ -2308,33 +2635,6 @@
 	quest::CQuestManager::instance().SendEventFlagList(ch);
 }
 
-#if defined(__GUILD_EVENT_FLAG__) //&& defined(__GUILD_RENEWAL__)
-ACMD(do_guild_event_flag)
-{
-	char arg1[256];
-	char arg2[256];
-
-	two_arguments(argument, arg1, sizeof(arg1), arg2, sizeof(arg2));
-
-	if (!(*arg1) || !(*arg2))
-		return;
-
-	int value = 0;
-	str_to_number(value, arg2);
-
-	LPGUILD g = ch->GetGuild();
-	if (g == nullptr)
-		return;
-
-	CGuildManager::Instance().RequestSetEventFlag(g->GetID(), arg1, value);
-}
-
-ACMD(do_get_guild_event_flag)
-{
-	CGuildManager::Instance().SendGuildEventFlagList(ch);
-}
-#endif
-
 ACMD(do_private)
 {
 	char arg1[256];
@@ -2682,189 +2982,90 @@
 	if (*arg1)
 	{
 #if defined(__EXTENDED_RELOAD__)
-		struct s_cmd_data { std::string file_name, base_path; };
-		std::unordered_map<std::string, s_cmd_data> cmd_map = {
-			{ "mob_drop_item", { "mob_drop_item.txt", LocaleService_GetBasePath() } },
-			{ "special_item_group", { "special_item_group.txt", LocaleService_GetBasePath() } },
-			{ "group", { "group.txt", LocaleService_GetBasePath() } },
-			{ "group_group", { "group_group.txt", LocaleService_GetBasePath() } },
-#if defined(__SHOPEX_RENEWAL__)
-			{ "shop_table_ex", { "shop_table_ex.txt", LocaleService_GetBasePath() } },
-#endif
-#if defined(__SET_ITEM__)
-			{ "set_item_table", { "set_item_table.txt", LocaleService_GetBasePath() } },
-#endif
-#if defined(__GEM_SHOP__)
-			{ "new_world", { "new_world.txt", LocaleService_GetMapPath() } },
-#endif
-			{ "pet_block_index", { "pet_block_index.txt", LocaleService_GetMapPath() } },
-			{ "mount_block_index", { "mount_block_index.txt", LocaleService_GetMapPath() } },
-#if defined(__SUMMER_EVENT_ROULETTE__)
-			{ "roulette_table", { "roulette_table.txt", LocaleService_GetMapPath() } },
-#endif
-		};
-
-		if (cmd_map.find(arg1) != cmd_map.end())
+		if (strstr(arg1, "mob_drop"))
 		{
-			char szFileName[FILE_NAME_LEN];
-			snprintf(szFileName, sizeof(szFileName), "%s/%s",
-				cmd_map[arg1].base_path.c_str(), cmd_map[arg1].file_name.c_str());
+			char szMobDropItemGroupFileName[FILE_NAME_LEN];
+			snprintf(szMobDropItemGroupFileName, sizeof(szMobDropItemGroupFileName),
+				"%s/mob_drop_item.txt", LocaleService_GetBasePath().c_str());
 
-			if (strcasecmp(arg1, "mob_drop_item") == 0)
-			{
-				if (ITEM_MANAGER::instance().ReloadMobDropItemGroup(szFileName))
-					ch->ChatPacket(CHAT_TYPE_INFO, "Reloading %s", cmd_map[arg1].file_name.c_str());
-				else
-					ch->ChatPacket(CHAT_TYPE_INFO, "Failed to reload %s", cmd_map[arg1].file_name.c_str());
-				return;
-			}
-
-			if (strcasecmp(arg1, "special_item_group") == 0)
-			{
-				if (ITEM_MANAGER::instance().ReloadSpecialItemGroup(szFileName))
-					ch->ChatPacket(CHAT_TYPE_INFO, "Reloading %s", cmd_map[arg1].file_name.c_str());
-				else
-					ch->ChatPacket(CHAT_TYPE_INFO, "Failed to reload %s", cmd_map[arg1].file_name.c_str());
-				return;
-			}
-
-			if (strcasecmp(arg1, "group") == 0)
-			{
-				if (CMobManager::Instance().LoadGroup(szFileName, true))
-					ch->ChatPacket(CHAT_TYPE_INFO, "Reloading %s", cmd_map[arg1].file_name.c_str());
-				else
-					ch->ChatPacket(CHAT_TYPE_INFO, "Failed to reload %s", cmd_map[arg1].file_name.c_str());
-				return;
-			}
-
-			if (strcasecmp(arg1, "group_group") == 0)
-			{
-				if (CMobManager::Instance().LoadGroupGroup(szFileName))
-					ch->ChatPacket(CHAT_TYPE_INFO, "Reloading %s", cmd_map[arg1].file_name.c_str());
-				else
-					ch->ChatPacket(CHAT_TYPE_INFO, "Failed to reload %s", cmd_map[arg1].file_name.c_str());
-				return;
-			}
+			if (ITEM_MANAGER::instance().ReloadMobDropItemGroup(szMobDropItemGroupFileName))
+				ch->ChatPacket(CHAT_TYPE_INFO, "Reloading MobDropItemGroup.");
+			else
+				ch->ChatPacket(CHAT_TYPE_INFO, "Failed to reload MobDropItemGroup.");
 
-#if defined(__SHOPEX_RENEWAL__)
-			if (strcasecmp(arg1, "shop_table_ex") == 0)
-			{
-				if (CShopManager::instance().ReadShopTableEx(szFileName))
-					ch->ChatPacket(CHAT_TYPE_INFO, "Reloading %s", cmd_map[arg1].file_name.c_str());
-				else
-					ch->ChatPacket(CHAT_TYPE_INFO, "Failed to reload %s", cmd_map[arg1].file_name.c_str());
-				return;
-			}
-#endif
+			return;
+		}
 
-#if defined(__SET_ITEM__)
-			if (strcasecmp(arg1, "set_item_table") == 0)
-			{
-				if (ITEM_MANAGER::instance().LoadSetItemTable(szFileName))
-					ch->ChatPacket(CHAT_TYPE_INFO, "Reloading %s", cmd_map[arg1].file_name.c_str());
-				else
-					ch->ChatPacket(CHAT_TYPE_INFO, "Failed to reload %s", cmd_map[arg1].file_name.c_str());
-				return;
-			}
-#endif
+		if (strstr(arg1, "drop"))
+		{
+			char szSpecialItemGroupFileName[FILE_NAME_LEN];
+			snprintf(szSpecialItemGroupFileName, sizeof(szSpecialItemGroupFileName),
+				"%s/special_item_group.txt", LocaleService_GetBasePath().c_str());
 
-#if defined(__GEM_SHOP__)
-			if (strcasecmp(arg1, "gem_shop_table") == 0)
-			{
-				if (ITEM_MANAGER::instance().ReadGemShopItemGroup(szFileName))
-					ch->ChatPacket(CHAT_TYPE_INFO, "Reloading %s", cmd_map[arg1].file_name.c_str());
-				else
-					ch->ChatPacket(CHAT_TYPE_INFO, "Failed to reload %s", cmd_map[arg1].file_name.c_str());
-				return;
-			}
-#endif
+			if (ITEM_MANAGER::instance().ReloadSpecialItemGroup(szSpecialItemGroupFileName))
+				ch->ChatPacket(CHAT_TYPE_INFO, "Reloading SpecialItemGroup.");
+			else
+				ch->ChatPacket(CHAT_TYPE_INFO, "Failed to reload SpecialItemGroup.");
 
-#if defined(__CONQUEROR_LEVEL__)
-			if (strcasecmp(arg1, "new_world") == 0)
-			{
-				if (SECTREE_MANAGER::Instance().LoadNewWorldMapIndexFile(szFileName))
-					ch->ChatPacket(CHAT_TYPE_INFO, "Reloading %s", cmd_map[arg1].file_name.c_str());
-				else
-					ch->ChatPacket(CHAT_TYPE_INFO, "Failed to reload %s", cmd_map[arg1].file_name.c_str());
-				return;
-			}
+			return;
+		}
 #endif
 
-			if (strcasecmp(arg1, "pet_block_index") == 0)
-			{
-				if (SECTREE_MANAGER::instance().LoadBlockFilterMapIndexFile(SECTREE_MANAGER::PET_BLOCK_MAP_INDEX))
-					ch->ChatPacket(CHAT_TYPE_INFO, "Reloading %s", cmd_map[arg1].file_name.c_str());
-				else
-					ch->ChatPacket(CHAT_TYPE_INFO, "Failed to reload %s", cmd_map[arg1].file_name.c_str());
-				return;
-			}
+#if defined(__SHOPEX_RENEWAL__)
+		if (strstr(arg1, "shop_ex"))
+		{
+			char szShopTableExFileName[FILE_NAME_LEN];
+			snprintf(szShopTableExFileName, sizeof(szShopTableExFileName),
+				"%s/shop_table_ex.txt", LocaleService_GetBasePath().c_str());
 
-			if (strcasecmp(arg1, "mount_block_index") == 0)
-			{
-				if (SECTREE_MANAGER::instance().LoadBlockFilterMapIndexFile(SECTREE_MANAGER::MOUNT_BLOCK_MAP_INDEX))
-					ch->ChatPacket(CHAT_TYPE_INFO, "Reloading %s", cmd_map[arg1].file_name.c_str());
-				else
-					ch->ChatPacket(CHAT_TYPE_INFO, "Failed to reload %s", cmd_map[arg1].file_name.c_str());
-				return;
-			}
+			if (CShopManager::instance().ReadShopTableEx(szShopTableExFileName))
+				ch->ChatPacket(CHAT_TYPE_INFO, "Reloading ShopTableEx.");
+			else
+				ch->ChatPacket(CHAT_TYPE_INFO, "Failed to reload ShopTableEx.");
 
-#if defined(__SUMMER_EVENT_ROULETTE__)
-			if (strcasecmp(arg1, "roulette_table") == 0)
-			{
-				if (CRouletteManager::Instance().ReadRouletteTableFile(szFileName))
-					ch->ChatPacket(CHAT_TYPE_INFO, "Reloading %s", cmd_map[arg1].file_name.c_str());
-				else
-					ch->ChatPacket(CHAT_TYPE_INFO, "Failed to reload %s", cmd_map[arg1].file_name.c_str());
-				return;
-			}
-#endif
+			return;
 		}
 #endif
 
 		switch (LOWER(*arg1))
 		{
-			case 'u':
-				ch->ChatPacket(CHAT_TYPE_INFO, "Reloading state_user_count.");
-				LoadStateUserCount();
-				break;
+		case 'u':
+			ch->ChatPacket(CHAT_TYPE_INFO, "Reloading state_user_count.");
+			LoadStateUserCount();
+			break;
 
-			case 'p':
-				ch->ChatPacket(CHAT_TYPE_INFO, "Reloading prototype tables,");
-				db_clientdesc->DBPacket(HEADER_GD_RELOAD_PROTO, 0, NULL, 0);
-				break;
+		case 'p':
+			ch->ChatPacket(CHAT_TYPE_INFO, "Reloading prototype tables,");
+			db_clientdesc->DBPacket(HEADER_GD_RELOAD_PROTO, 0, NULL, 0);
+			break;
 
-			case 's':
-				ch->ChatPacket(CHAT_TYPE_INFO, "Reloading notice string.");
-				DBManager::instance().LoadDBString();
-				break;
+		case 's':
+			ch->ChatPacket(CHAT_TYPE_INFO, "Reloading notice string.");
+			DBManager::instance().LoadDBString();
+			break;
 
-			case 'q':
-				ch->ChatPacket(CHAT_TYPE_INFO, "Reloading quest.");
-				quest::CQuestManager::instance().Reload();
-				break;
+		case 'q':
+			ch->ChatPacket(CHAT_TYPE_INFO, "Reloading quest.");
+			quest::CQuestManager::instance().Reload();
+			break;
 
-			case 'f':
-				fishing::Initialize();
-				break;
+		case 'f':
+			fishing::Initialize();
+			break;
 
-				// RELOAD_ADMIN
-			case 'a':
-				ch->ChatPacket(CHAT_TYPE_INFO, "Reloading Admin infomation.");
-				db_clientdesc->DBPacket(HEADER_GD_RELOAD_ADMIN, 0, NULL, 0);
-				sys_log(0, "Reloading admin infomation.");
-				break;
-				// END_RELOAD_ADMIN
+			// RELOAD_ADMIN
+		case 'a':
+			ch->ChatPacket(CHAT_TYPE_INFO, "Reloading Admin infomation.");
+			db_clientdesc->DBPacket(HEADER_GD_RELOAD_ADMIN, 0, NULL, 0);
+			sys_log(0, "Reloading admin infomation.");
+			break;
+			// END_RELOAD_ADMIN
 
-			case 'c': // Cube
-			{
-				//  μ Ѵ.
-#if defined(__CUBE_RENEWAL__)
-				CCubeManager::Instance().Initialize();
-#else
-				Cube_init();
-#endif
-			}
+		case 'c': // Cube
+			//  μ Ѵ.
+			Cube_init();
 			break;
+
 		}
 	}
 	else
@@ -2887,18 +3088,17 @@
 
 ACMD(do_level)
 {
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
+	char arg2[256];
+	one_argument(argument, arg2, sizeof(arg2));
 
-	if (!*arg1)
+	if (!*arg2)
 	{
 		ch->ChatPacket(CHAT_TYPE_INFO, "Syntax: level <level>");
 		return;
 	}
 
 	int level = 0;
-	str_to_number(level, arg1);
-
+	str_to_number(level, arg2);
 	ch->ResetPoint(MINMAX(1, level, PLAYER_MAX_LEVEL_CONST));
 	ch->ResetExp();
 
@@ -2908,7 +3108,7 @@
 
 ACMD(do_gwlist)
 {
-	ch->ChatPacket(CHAT_TYPE_NOTICE, LC_STRING("   Դϴ"));
+	ch->ChatPacket(CHAT_TYPE_NOTICE, LC_TEXT("   Դϴ"));
 	CGuildManager::instance().ShowGuildWarList(ch);
 }
 
@@ -2966,7 +3166,7 @@
 	}
 	else
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s:  ʴ  Դϴ.", arg1));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s:  ʴ  Դϴ."), arg1);
 	}
 }
 
@@ -2991,11 +3191,6 @@
 		if (!m_bAll && iDist >= 1000) // 10 ̻ ִ ͵ purge  ʴ´.
 			return;
 
-#if defined(__DEFENSE_WAVE__)
-		if (pkChr->GetDefenseWave() && (pkChr->GetDefenseWave()->IsUnique(pkChr) && pkChr->IsMonster() == false))
-			return;
-#endif
-
 		if (pkChr->IsNPC())
 			pkChr->PointChange(POINT_HP, (10 - pkChr->GetHP()));
 	}
@@ -3011,8 +3206,7 @@
 	if (*arg1 && !strcmp(arg1, "all"))
 		func.m_bAll = true;
 
-	if (ch->GetSectree())
-		ch->GetSectree()->ForEachAround(func);
+	ch->GetSectree()->ForEachAround(func);
 }
 
 ACMD(do_getqf)
@@ -3315,7 +3509,7 @@
 		}
 
 		if (!g)
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("׷ ̸ Ǵ ȣ 尡 ϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("׷ ̸ Ǵ ȣ 尡 ϴ."));
 		else
 		{
 			char buf[1024 + 1];
@@ -3360,22 +3554,19 @@
 
 ACMD(do_socket_item)
 {
-	char arg1[256], arg2[256], arg3[256];
-	three_arguments(argument, arg1, sizeof(arg1), arg2, sizeof(arg2), arg3, sizeof(arg3));
+	char arg1[256], arg2[256];
+	two_arguments(argument, arg1, sizeof(arg1), arg2, sizeof(arg2));
 
 	if (*arg1)
 	{
 		DWORD dwVnum = 0;
 		str_to_number(dwVnum, arg1);
 
-		int iSocketIndex = 0;
-		str_to_number(iSocketIndex, arg2);
+		int iSocketCount = 0;
+		str_to_number(iSocketCount, arg2);
 
-		int iSocketValue = 0;
-		str_to_number(iSocketValue, arg3);
-
-		if (iSocketIndex >= ITEM_SOCKET_MAX_NUM)
-			iSocketIndex = ITEM_SOCKET_MAX_NUM - 1;
+		if (!iSocketCount || iSocketCount >= ITEM_SOCKET_MAX_NUM)
+			iSocketCount = 3;
 
 		if (!dwVnum)
 		{
@@ -3386,9 +3577,12 @@
 			}
 		}
 
-		if (LPITEM item = ch->AutoGiveItem(dwVnum))
+		LPITEM item = ch->AutoGiveItem(dwVnum);
+
+		if (item)
 		{
-			item->SetSocket(iSocketIndex, iSocketValue);
+			for (int i = 0; i < iSocketCount; ++i)
+				item->SetSocket(i, 1);
 		}
 		else
 		{
@@ -3409,17 +3603,17 @@
 
 	switch (subcmd)
 	{
-		case SCMD_XMAS_BOOM:
-			quest::CQuestManager::instance().RequestSetEventFlag("xmas_boom", flag);
-			break;
+	case SCMD_XMAS_SNOW:
+		quest::CQuestManager::instance().RequestSetEventFlag("xmas_snow", flag);
+		break;
 
-		case SCMD_XMAS_SNOW:
-			quest::CQuestManager::instance().RequestSetEventFlag("xmas_snow", flag);
-			break;
+	case SCMD_XMAS_BOOM:
+		quest::CQuestManager::instance().RequestSetEventFlag("xmas_boom", flag);
+		break;
 
-		case SCMD_XMAS_SANTA:
-			quest::CQuestManager::instance().RequestSetEventFlag("xmas_santa", flag);
-			break;
+	case SCMD_XMAS_SANTA:
+		quest::CQuestManager::instance().RequestSetEventFlag("xmas_santa", flag);
+		break;
 	}
 }
 
@@ -3429,7 +3623,7 @@
 	// GM ƴϰų block_chat_privilege   ɾ  Ұ
 	if (!ch || (ch->GetGMLevel() < GM_HIGH_WIZARD && ch->GetQuestFlag("chat_privilege.block") <= 0))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("׷ ɾ ϴ"));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("׷ ɾ ϴ"));
 		return;
 	}
 
@@ -3495,7 +3689,7 @@
 	// GM ƴϰų block_chat_privilege   ɾ  Ұ
 	if (ch && (ch->GetGMLevel() < GM_HIGH_WIZARD && ch->GetQuestFlag("chat_privilege.block") <= 0))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("׷ ɾ ϴ"));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("׷ ɾ ϴ"));
 		return;
 	}
 
@@ -3524,7 +3718,7 @@
 	}
 
 	if (ch)
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s is now blocked.", name));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s is now blocked."), name);
 
 	sys_log(0, "BLOCK CHAT %s %d", name, lBlockDuration);
 
@@ -3608,76 +3802,134 @@
 
 	switch (LOWER(*arg1))
 	{
-		case 'c':
+	case 'c':
+	{
+		// /build c vnum x y x_rot y_rot z_rot
+		char arg5[256], arg6[256];
+		line = one_argument(two_arguments(line, arg1, sizeof(arg1), arg2, sizeof(arg2)), arg3, sizeof(arg3)); // vnum x y
+		one_argument(two_arguments(line, arg4, sizeof(arg4), arg5, sizeof(arg5)), arg6, sizeof(arg6)); // x_rot y_rot z_rot
+
+		if (!*arg1 || !*arg2 || !*arg3 || !*arg4 || !*arg5 || !*arg6)
 		{
-			// /build c vnum x y x_rot y_rot z_rot
-			char arg5[256], arg6[256];
-			line = one_argument(two_arguments(line, arg1, sizeof(arg1), arg2, sizeof(arg2)), arg3, sizeof(arg3)); // vnum x y
-			one_argument(two_arguments(line, arg4, sizeof(arg4), arg5, sizeof(arg5)), arg6, sizeof(arg6)); // x_rot y_rot z_rot
+			ch->ChatPacket(CHAT_TYPE_INFO, "Invalid syntax");
+			return;
+		}
 
-			if (!*arg1 || !*arg2 || !*arg3 || !*arg4 || !*arg5 || !*arg6)
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, "Invalid syntax");
-				return;
-			}
+		DWORD dwVnum = 0;
+		str_to_number(dwVnum, arg1);
+
+		using namespace building;
 
-			DWORD dwVnum = 0;
-			str_to_number(dwVnum, arg1);
+		const TObjectProto* t = CManager::instance().GetObjectProto(dwVnum);
+		if (!t)
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ʴ ǹԴϴ."));
+			return;
+		}
 
-			using namespace building;
+		const DWORD BUILDING_MAX_PRICE = 100000000;
 
-			const TObjectProto* t = CManager::instance().GetObjectProto(dwVnum);
-			if (!t)
+		if (t->dwGroupVnum)
+		{
+			if (pkLand->FindObjectByGroup(t->dwGroupVnum))
 			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ʴ ǹԴϴ."));
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("     ǹ  ֽϴ."));
 				return;
 			}
+		}
 
-			const DWORD BUILDING_MAX_PRICE = 100000000;
-
-			if (t->dwGroupVnum)
+		// ǹ Ӽ üũ ( ǹ  ־)
+		if (t->dwDependOnGroupVnum)
+		{
+			//const TObjectProto* dependent = CManager::instance().GetObjectProto(dwVnum);
+			//if (dependent)
 			{
-				if (pkLand->FindObjectByGroup(t->dwGroupVnum))
+				// ִ°?
+				if (!pkLand->FindObjectByGroup(t->dwDependOnGroupVnum))
 				{
-					ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("     ǹ  ֽϴ."));
+					ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ǽ ʿ ǹ   ʽϴ."));
 					return;
 				}
 			}
+		}
 
-			// ǹ Ӽ üũ ( ǹ  ־)
-			if (t->dwDependOnGroupVnum)
+		int64_t iPrice = t->dwPrice;
+		if (test_server || GMLevel == GM_PLAYER)
+		{
+			// GM ƴҰ츸 (׼ GM Ҹ)
+			// Ǽ  üũ
+			if (iPrice > BUILDING_MAX_PRICE)
 			{
-				//const TObjectProto* dependent = CManager::instance().GetObjectProto(dwVnum);
-				//if (dependent)
-				{
-					// ִ°?
-					if (!pkLand->FindObjectByGroup(t->dwDependOnGroupVnum))
-					{
-						ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ǽ ʿ ǹ   ʽϴ."));
-						return;
-					}
-				}
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ǹ   ̻ Ǽ ۾ ߽ϴ."));
+				return;
 			}
 
-			int32_t iPrice = t->dwPrice;
-			if (test_server || GMLevel == GM_PLAYER)
+			if (ch->GetGold() < iPrice)
 			{
-				// GM ƴҰ츸 (׼ GM Ҹ)
-				// Ǽ  üũ
-				if (iPrice > BUILDING_MAX_PRICE)
-				{
-					ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ǹ   ̻ Ǽ ۾ ߽ϴ."));
-					return;
-				}
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ǽ  մϴ."));
+				return;
+			}
+
+			//    üũ
+
+			int i;
+			for (i = 0; i < OBJECT_MATERIAL_MAX_NUM; ++i)
+			{
+				DWORD dwItemVnum = t->kMaterials[i].dwItemVnum;
+				DWORD dwItemCount = t->kMaterials[i].dwCount;
+
+				if (dwItemVnum == 0)
+					break;
 
-				if (ch->GetGold() < iPrice)
+				if ((int)dwItemCount > ch->CountSpecifyItem(dwItemVnum))
 				{
-					ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ǽ  մϴ."));
+					ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("簡 Ͽ Ǽ  ϴ."));
 					return;
 				}
+			}
+		}
+
+		float x_rot = atof(arg4);
+		float y_rot = atof(arg5);
+		float z_rot = atof(arg6);
+		// 20050811.myevan.ǹ ȸ   
+		/*
+		if (x_rot != 0.0f || y_rot != 0.0f || z_rot != 0.0f)
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, "ǹ ȸ    ʽϴ");
+			return;
+		}
+		*/
+
+		long map_x = 0;
+		str_to_number(map_x, arg2);
+		long map_y = 0;
+		str_to_number(map_y, arg3);
 
-				//    üũ
+		bool isSuccess = pkLand->RequestCreateObject(dwVnum,
+			ch->GetMapIndex(),
+			map_x,
+			map_y,
+			x_rot,
+			y_rot,
+			z_rot, true
+		);
 
+		if (!isSuccess)
+		{
+			if (test_server)
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ǹ    ġԴϴ."));
+			return;
+		}
+
+		if (test_server || GMLevel == GM_PLAYER)
+			// Ǽ  Ҹϱ (׼ GM Ҹ)
+		{
+			// Ǽ  Ҹ
+			ch->PointChange(POINT_GOLD, -iPrice);
+
+			//   ϱ 
+			{
 				int i;
 				for (i = 0; i < OBJECT_MATERIAL_MAX_NUM; ++i)
 				{
@@ -3687,181 +3939,123 @@
 					if (dwItemVnum == 0)
 						break;
 
-					if ((int)dwItemCount > ch->CountSpecifyItem(dwItemVnum))
-					{
-						ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("簡 Ͽ Ǽ  ϴ."));
-						return;
-					}
+					sys_log(0, "BUILD: material %d %u %u", i, dwItemVnum, dwItemCount);
+					ch->RemoveSpecifyItem(dwItemVnum, dwItemCount);
 				}
 			}
+		}
+	}
+	break;
 
-			float x_rot = atof(arg4);
-			float y_rot = atof(arg5);
-			float z_rot = atof(arg6);
-			// 20050811.myevan.ǹ ȸ   
-			/*
-			if (x_rot != 0.0f || y_rot != 0.0f || z_rot != 0.0f)
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, "ǹ ȸ    ʽϴ");
-				return;
-			}
-			*/
-
-			long map_x = 0;
-			str_to_number(map_x, arg2);
-			long map_y = 0;
-			str_to_number(map_y, arg3);
-
-			bool isSuccess = pkLand->RequestCreateObject(dwVnum,
-				ch->GetMapIndex(),
-				map_x,
-				map_y,
-				x_rot,
-				y_rot,
-				z_rot, true
-			);
-
-			if (!isSuccess)
-			{
-				if (test_server)
-					ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ǹ    ġԴϴ."));
-				return;
-			}
-
-			if (test_server || GMLevel == GM_PLAYER)
-				// Ǽ  Ҹϱ (׼ GM Ҹ)
-			{
-				// Ǽ  Ҹ
-				ch->PointChange(POINT_GOLD, -iPrice);
+	case 'd':
+		// build (d)elete ObjectID
+	{
+		one_argument(line, arg1, sizeof(arg1));
 
-				//   ϱ 
-				{
-					int i;
-					for (i = 0; i < OBJECT_MATERIAL_MAX_NUM; ++i)
-					{
-						DWORD dwItemVnum = t->kMaterials[i].dwItemVnum;
-						DWORD dwItemCount = t->kMaterials[i].dwCount;
+		if (!*arg1)
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, "Invalid syntax");
+			return;
+		}
 
-						if (dwItemVnum == 0)
-							break;
+		DWORD vid = 0;
+		str_to_number(vid, arg1);
+		pkLand->RequestDeleteObjectByVID(vid);
+	}
+	break;
 
-						sys_log(0, "BUILD: material %d %u %u", i, dwItemVnum, dwItemCount);
-						ch->RemoveSpecifyItem(dwItemVnum, dwItemCount);
-					}
-				}
-			}
-		}
-		break;
+	// BUILD_WALL
 
-		case 'd':
-			// build (d)elete ObjectID
+	// build w n/e/w/s
+	case 'w':
+		if (GMLevel > GM_PLAYER)
 		{
+			int mapIndex = ch->GetMapIndex();
+
 			one_argument(line, arg1, sizeof(arg1));
 
-			if (!*arg1)
+			sys_log(0, "guild.wall.build map[%d] direction[%s]", mapIndex, arg1);
+
+			switch (arg1[0])
 			{
-				ch->ChatPacket(CHAT_TYPE_INFO, "Invalid syntax");
-				return;
+			case 's':
+				pkLand->RequestCreateWall(mapIndex, 0.0f);
+				break;
+			case 'n':
+				pkLand->RequestCreateWall(mapIndex, 180.0f);
+				break;
+			case 'e':
+				pkLand->RequestCreateWall(mapIndex, 90.0f);
+				break;
+			case 'w':
+				pkLand->RequestCreateWall(mapIndex, 270.0f);
+				break;
+			default:
+				ch->ChatPacket(CHAT_TYPE_INFO, "guild.wall.build unknown_direction[%s]", arg1);
+				sys_err("guild.wall.build unknown_direction[%s]", arg1);
+				break;
 			}
 
-			DWORD vid = 0;
-			str_to_number(vid, arg1);
-			pkLand->RequestDeleteObjectByVID(vid);
 		}
 		break;
 
-		// BUILD_WALL
-
-		// build w n/e/w/s
-		case 'w':
-			if (GMLevel > GM_PLAYER)
-			{
-				int mapIndex = ch->GetMapIndex();
-
-				one_argument(line, arg1, sizeof(arg1));
+	case 'e':
+		if (GMLevel > GM_PLAYER)
+		{
+			pkLand->RequestDeleteWall();
+		}
+		break;
 
-				sys_log(0, "guild.wall.build map[%d] direction[%s]", mapIndex, arg1);
+	case 'W':
+		//  
+		// build (w)all ȣ ũ 빮 빮 빮 빮
 
-				switch (arg1[0])
-				{
-					case 's':
-						pkLand->RequestCreateWall(mapIndex, 0.0f);
-						break;
-					case 'n':
-						pkLand->RequestCreateWall(mapIndex, 180.0f);
-						break;
-					case 'e':
-						pkLand->RequestCreateWall(mapIndex, 90.0f);
-						break;
-					case 'w':
-						pkLand->RequestCreateWall(mapIndex, 270.0f);
-						break;
-					default:
-						ch->ChatPacket(CHAT_TYPE_INFO, "guild.wall.build unknown_direction[%s]", arg1);
-						sys_err("guild.wall.build unknown_direction[%s]", arg1);
-						break;
-				}
+		if (GMLevel > GM_PLAYER)
+		{
+			int setID = 0, wallSize = 0;
+			char arg5[256], arg6[256];
+			line = two_arguments(line, arg1, sizeof(arg1), arg2, sizeof(arg2));
+			line = two_arguments(line, arg3, sizeof(arg3), arg4, sizeof(arg4));
+			two_arguments(line, arg5, sizeof(arg5), arg6, sizeof(arg6));
 
-			}
-			break;
+			str_to_number(setID, arg1);
+			str_to_number(wallSize, arg2);
 
-		case 'e':
-			if (GMLevel > GM_PLAYER)
+			if (setID != 14105 && setID != 14115 && setID != 14125)
 			{
-				pkLand->RequestDeleteWall();
+				sys_log(0, "BUILD_WALL: wrong wall set id %d", setID);
+				break;
 			}
-			break;
-
-		case 'W':
-			//  
-			// build (w)all ȣ ũ 빮 빮 빮 빮
-
-			if (GMLevel > GM_PLAYER)
-			{
-				int setID = 0, wallSize = 0;
-				char arg5[256], arg6[256];
-				line = two_arguments(line, arg1, sizeof(arg1), arg2, sizeof(arg2));
-				line = two_arguments(line, arg3, sizeof(arg3), arg4, sizeof(arg4));
-				two_arguments(line, arg5, sizeof(arg5), arg6, sizeof(arg6));
-
-				str_to_number(setID, arg1);
-				str_to_number(wallSize, arg2);
-
-				if (setID != 14105 && setID != 14115 && setID != 14125)
-				{
-					sys_log(0, "BUILD_WALL: wrong wall set id %d", setID);
-					break;
-				}
-				else
-				{
-					bool door_east = false;
-					str_to_number(door_east, arg3);
-					bool door_west = false;
-					str_to_number(door_west, arg4);
-					bool door_south = false;
-					str_to_number(door_south, arg5);
-					bool door_north = false;
-					str_to_number(door_north, arg6);
-					pkLand->RequestCreateWallBlocks(setID, ch->GetMapIndex(), wallSize, door_east, door_west, door_south, door_north);
-				}
+			else
+			{
+				bool door_east = false;
+				str_to_number(door_east, arg3);
+				bool door_west = false;
+				str_to_number(door_west, arg4);
+				bool door_south = false;
+				str_to_number(door_south, arg5);
+				bool door_north = false;
+				str_to_number(door_north, arg6);
+				pkLand->RequestCreateWallBlocks(setID, ch->GetMapIndex(), wallSize, door_east, door_west, door_south, door_north);
 			}
-			break;
+		}
+		break;
 
-		case 'E':
-			//  
-			// build (e)rase ID
-			if (GMLevel > GM_PLAYER)
-			{
-				one_argument(line, arg1, sizeof(arg1));
-				DWORD id = 0;
-				str_to_number(id, arg1);
-				pkLand->RequestDeleteWallBlocks(id);
-			}
-			break;
+	case 'E':
+		//  
+		// build (e)rase ID
+		if (GMLevel > GM_PLAYER)
+		{
+			one_argument(line, arg1, sizeof(arg1));
+			DWORD id = 0;
+			str_to_number(id, arg1);
+			pkLand->RequestDeleteWallBlocks(id);
+		}
+		break;
 
-		default:
-			ch->ChatPacket(CHAT_TYPE_INFO, "Invalid command %s", arg1);
-			break;
+	default:
+		ch->ChatPacket(CHAT_TYPE_INFO, "Invalid command %s", arg1);
+		break;
 	}
 }
 // END_OF_BUILD_BUILDING
@@ -3906,7 +4100,7 @@
 
 	if (NULL == victim)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ʴ ĳ Դϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ʴ ĳ Դϴ."));
 		return;
 	}
 
@@ -4017,13 +4211,14 @@
 		ch->ChatPacket(CHAT_TYPE_INFO, "Type Point Modif Duration Flag");
 
 		const AffectContainerList& cont = tch->GetAffectContainer();
-		auto it = cont.begin();
+		itertype(cont) it = cont.begin();
+
 		while (it != cont.end())
 		{
 			CAffect* pkAff = *it++;
 
 			ch->ChatPacket(CHAT_TYPE_INFO, "%4d %5d %5d %8d %u",
-				pkAff->dwType, pkAff->wApplyOn, pkAff->lApplyValue, pkAff->lDuration, pkAff->dwFlag);
+				pkAff->dwType, pkAff->bApplyOn, pkAff->lApplyValue, pkAff->lDuration, pkAff->dwFlag);
 		}
 		return;
 	}
@@ -4034,7 +4229,7 @@
 
 	DWORD type = 0;
 	str_to_number(type, arg1);
-	POINT_TYPE point = 0;
+	BYTE point = 0;
 	str_to_number(point, arg2);
 	while ((af = ch->FindAffect(type, point)))
 	{
@@ -4048,46 +4243,6 @@
 		ch->ChatPacket(CHAT_TYPE_INFO, "Not affected by that type and point.");
 }
 
-ACMD(do_affect_add)
-{
-	char arg1[256], arg2[256], arg3[256], arg4[256], arg5[256], arg6[256];
-	one_argument(
-		one_argument(
-			one_argument(
-				one_argument(
-					one_argument(
-						one_argument(argument,
-							arg1, sizeof(arg1)),
-						arg2, sizeof(arg2)),
-					arg3, sizeof(arg3)),
-				arg4, sizeof(arg4)),
-			arg5, sizeof(arg5)),
-		arg6, sizeof(arg6)
-	);
-	if (!*arg1 || !*arg2 || !*arg3 || !*arg4 || !*arg5 || !*arg6)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, "Syntax: /affect_add <type> <apply> <value> <flag> <duration> <override>");
-		return; // invalid syntax
-	}
-
-	DWORD dwType;
-	WORD wApplyOn;
-	long lApplyValue;
-	DWORD dwFlag;
-	long lDuration;
-	bool bOverride;
-
-	str_to_number(dwType, arg1);
-	str_to_number(wApplyOn, arg2);
-	str_to_number(lApplyValue, arg3);
-	str_to_number(dwFlag, arg4);
-	str_to_number(lDuration, arg5);
-	str_to_number(bOverride, arg6);
-
-	ch->AddAffect(dwType, wApplyOn, lApplyValue, dwFlag, lDuration, 0, bOverride);
-	ch->ChatPacket(CHAT_TYPE_INFO, "Affect successfully added.");
-}
-
 ACMD(do_change_attr)
 {
 	LPITEM weapon = ch->GetWear(WEAR_WEAPON);
@@ -4128,17 +4283,17 @@
 	LPCHARACTER pChar = CHARACTER_MANAGER::instance().FindPC(szName);
 	if (pChar == NULL)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ʴ ĳ Դϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ʴ ĳ Դϴ."));
 		return;
 	}
 
 	if (CArenaManager::instance().EndDuel(pChar->GetPlayerID()) == false)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("   "));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("   "));
 	}
 	else
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("   "));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("   "));
 	}
 }
 
@@ -4194,7 +4349,7 @@
 			}
 			else
 			{
-				pChar1->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> Ƽ ̽ϴ."));
+				pChar1->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> Ƽ ̽ϴ."));
 				pParty->Quit(pChar1->GetPlayerID());
 			}
 		}
@@ -4208,23 +4363,23 @@
 			}
 			else
 			{
-				pChar2->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> Ƽ ̽ϴ."));
+				pChar2->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> Ƽ ̽ϴ."));
 				pParty->Quit(pChar2->GetPlayerID());
 			}
 		}
 
 		if (CArenaManager::instance().StartDuel(pChar1, pChar2, set, minute) == true)
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("   Ǿϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("   Ǿϴ."));
 		}
 		else
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ۿ  ֽϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ۿ  ֽϴ."));
 		}
 	}
 	else
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ڰ ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ڰ ϴ."));
 	}
 }
 
@@ -4239,7 +4394,7 @@
 
 	if (ch->IsPolymorphed())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("а ߿ ɷ ø  ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("а ߿ ɷ ø  ϴ."));
 		return;
 	}
 
@@ -4247,7 +4402,7 @@
 
 	if (nRemainPoint <= 0)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("  Ʈ ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  Ʈ ϴ."));
 		return;
 	}
 
@@ -4256,50 +4411,50 @@
 
 	if (nRemainPoint < nPoint)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("  Ʈ ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  Ʈ ϴ."));
 		return;
 	}
 
 	if (nPoint < 0)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ߸ ԷϿϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ߸ ԷϿϴ."));
 		return;
 	}
 
 	switch (subcmd)
 	{
-		case POINT_HT: // ü
-			if (nPoint + ch->GetPoint(POINT_HT) > 90)
-			{
-				nPoint = 90 - ch->GetPoint(POINT_HT);
-			}
-			break;
+	case POINT_HT: // ü
+		if (nPoint + ch->GetPoint(POINT_HT) > 90)
+		{
+			nPoint = 90 - ch->GetPoint(POINT_HT);
+		}
+		break;
 
-		case POINT_IQ: // 
-			if (nPoint + ch->GetPoint(POINT_IQ) > 90)
-			{
-				nPoint = 90 - ch->GetPoint(POINT_IQ);
-			}
-			break;
+	case POINT_IQ: // 
+		if (nPoint + ch->GetPoint(POINT_IQ) > 90)
+		{
+			nPoint = 90 - ch->GetPoint(POINT_IQ);
+		}
+		break;
 
-		case POINT_ST: // ٷ
-			if (nPoint + ch->GetPoint(POINT_ST) > 90)
-			{
-				nPoint = 90 - ch->GetPoint(POINT_ST);
-			}
-			break;
+	case POINT_ST: // ٷ
+		if (nPoint + ch->GetPoint(POINT_ST) > 90)
+		{
+			nPoint = 90 - ch->GetPoint(POINT_ST);
+		}
+		break;
 
-		case POINT_DX: // ø
-			if (nPoint + ch->GetPoint(POINT_DX) > 90)
-			{
-				nPoint = 90 - ch->GetPoint(POINT_DX);
-			}
-			break;
+	case POINT_DX: // ø
+		if (nPoint + ch->GetPoint(POINT_DX) > 90)
+		{
+			nPoint = 90 - ch->GetPoint(POINT_DX);
+		}
+		break;
 
-		default:
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ɾ  Ŀǵ尡 ߸ Ǿϴ."));
-			return;
-			break;
+	default:
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ɾ  Ŀǵ尡 ߸ Ǿϴ."));
+		return;
+		break;
 	}
 
 	if (nPoint != 0)
@@ -4330,7 +4485,7 @@
 	str_to_number(pids.pid1, arg1);
 	str_to_number(pids.pid2, arg2);
 
-	ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("÷̾ %d  ÷̾  %d ȥŵϴ..", pids.pid1, pids.pid2));
+	ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("÷̾ %d  ÷̾  %d ȥŵϴ.."), pids.pid1, pids.pid2);
 	db_clientdesc->DBPacket(HEADER_GD_BREAK_MARRIAGE, 0, &pids, sizeof(pids));
 }
 
@@ -4363,8 +4518,8 @@
 
 ACMD(do_threeway_war_info)
 {
-	ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("  "));
-	ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("    %d  %d %d %d", GetSungziMapIndex(), GetPassMapIndex(1), GetPassMapIndex(2), GetPassMapIndex(3)));
+	ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  "));
+	ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("    %d  %d %d %d"), GetSungziMapIndex(), GetPassMapIndex(1), GetPassMapIndex(2), GetPassMapIndex(3));
 	ch->ChatPacket(CHAT_TYPE_INFO, "ThreewayPhase %d", CThreeWayWar::instance().GetRegenFlag());
 
 	for (int n = 1; n < 4; ++n)
@@ -4387,7 +4542,7 @@
 
 ACMD(do_threeway_war_myinfo)
 {
-	ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" Ÿ "));
+	ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" Ÿ "));
 	ch->ChatPacket(CHAT_TYPE_INFO, "Deadcount %d",
 		CThreeWayWar::instance().GetReviveTokenForPlayer(ch->GetPlayerID()));
 }
@@ -4513,15 +4668,15 @@
 
 	switch (castle_siege(empire, tower_count))
 	{
-		case 0:
-			ch->ChatPacket(CHAT_TYPE_INFO, "SIEGE FAILED");
-			break;
-		case 1:
-			ch->ChatPacket(CHAT_TYPE_INFO, "SIEGE START Empire(%d) Tower(%d)", empire, tower_count);
-			break;
-		case 2:
-			ch->ChatPacket(CHAT_TYPE_INFO, "SIEGE END");
-			break;
+	case 0:
+		ch->ChatPacket(CHAT_TYPE_INFO, "SIEGE FAILED");
+		break;
+	case 1:
+		ch->ChatPacket(CHAT_TYPE_INFO, "SIEGE START Empire(%d) Tower(%d)", empire, tower_count);
+		break;
+	case 2:
+		ch->ChatPacket(CHAT_TYPE_INFO, "SIEGE END");
+		break;
 	}
 }
 
@@ -4563,21 +4718,21 @@
 
 	switch (empire)
 	{
-		case 1:
-		case 2:
-		case 3:
-			if (IS_CASTLE_MAP(ch->GetMapIndex()))
-			{
-				castle_spawn_frog(empire);
-				castle_save();
-			}
-			else
-				ch->ChatPacket(CHAT_TYPE_INFO, "You must spawn frog in castle");
-			break;
+	case 1:
+	case 2:
+	case 3:
+		if (IS_CASTLE_MAP(ch->GetMapIndex()))
+		{
+			castle_spawn_frog(empire);
+			castle_save();
+		}
+		else
+			ch->ChatPacket(CHAT_TYPE_INFO, "You must spawn frog in castle");
+		break;
 
-		default:
-			ch->ChatPacket(CHAT_TYPE_INFO, "Usage: empire(1, 2, 3)");
-			break;
+	default:
+		ch->ChatPacket(CHAT_TYPE_INFO, "Usage: empire(1, 2, 3)");
+		break;
 	}
 
 }
@@ -4642,7 +4797,6 @@
 	}
 }
 
-#if defined(__XMAS_EVENT_2008__)
 ACMD(do_event_helper)
 {
 	char arg1[256];
@@ -4662,7 +4816,6 @@
 		ch->ChatPacket(CHAT_TYPE_INFO, "Event Helper Delete");
 	}
 }
-#endif
 
 struct FMobCounter
 {
@@ -4750,13 +4903,13 @@
 	{
 		if (tch->IsPolymorphed())
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("а ߿ ɷ ø  ϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("а ߿ ɷ ø  ϴ."));
 			return;
 		}
 
 		if (subcmd != POINT_HT && subcmd != POINT_IQ && subcmd != POINT_ST && subcmd != POINT_DX)
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ɾ  Ŀǵ尡 ߸ Ǿϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ɾ  Ŀǵ尡 ߸ Ǿϴ."));
 			return;
 		}
 		int nRemainPoint = tch->GetPoint(POINT_STAT);
@@ -4768,38 +4921,38 @@
 		int n;
 		switch (subcmd)
 		{
-			case POINT_HT:
-				if (nPoint < JobInitialPoints[tch->GetJob()].ht)
-				{
-					ch->ChatPacket(CHAT_TYPE_INFO, "Cannot set stat under initial stat.");
-					return;
-				}
-				n = 0;
-				break;
-			case POINT_IQ:
-				if (nPoint < JobInitialPoints[tch->GetJob()].iq)
-				{
-					ch->ChatPacket(CHAT_TYPE_INFO, "Cannot set stat under initial stat.");
-					return;
-				}
-				n = 1;
-				break;
-			case POINT_ST:
-				if (nPoint < JobInitialPoints[tch->GetJob()].st)
-				{
-					ch->ChatPacket(CHAT_TYPE_INFO, "Cannot set stat under initial stat.");
-					return;
-				}
-				n = 2;
-				break;
-			case POINT_DX:
-				if (nPoint < JobInitialPoints[tch->GetJob()].dx)
-				{
-					ch->ChatPacket(CHAT_TYPE_INFO, "Cannot set stat under initial stat.");
-					return;
-				}
-				n = 3;
-				break;
+		case POINT_HT:
+			if (nPoint < JobInitialPoints[tch->GetJob()].ht)
+			{
+				ch->ChatPacket(CHAT_TYPE_INFO, "Cannot set stat under initial stat.");
+				return;
+			}
+			n = 0;
+			break;
+		case POINT_IQ:
+			if (nPoint < JobInitialPoints[tch->GetJob()].iq)
+			{
+				ch->ChatPacket(CHAT_TYPE_INFO, "Cannot set stat under initial stat.");
+				return;
+			}
+			n = 1;
+			break;
+		case POINT_ST:
+			if (nPoint < JobInitialPoints[tch->GetJob()].st)
+			{
+				ch->ChatPacket(CHAT_TYPE_INFO, "Cannot set stat under initial stat.");
+				return;
+			}
+			n = 2;
+			break;
+		case POINT_DX:
+			if (nPoint < JobInitialPoints[tch->GetJob()].dx)
+			{
+				ch->ChatPacket(CHAT_TYPE_INFO, "Cannot set stat under initial stat.");
+				return;
+			}
+			n = 3;
+			break;
 		}
 
 		if (nPoint > 90)
@@ -4810,7 +4963,7 @@
 
 		if (nRemainPoint < nChangeAmount)
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("  Ʈ ϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  Ʈ ϴ."));
 			return;
 		}
 
@@ -4830,11 +4983,15 @@
 
 ACMD(do_get_item_id_list)
 {
-	for (int i = 0; i < INVENTORY_MAX_NUM; i++)
+	for (int i = 0; i < INVENTORY_AND_EQUIP_SLOT_MAX; i++)
 	{
 		LPITEM item = ch->GetInventoryItem(i);
 		if (item != NULL)
-			ch->ChatPacket(CHAT_TYPE_INFO, "cell : %d, name : %s, id : %d", item->GetCell(), item->GetName(), item->GetID());
+			ch->ChatPacket(CHAT_TYPE_INFO, "cell : %d, name : %s, id : %d",
+				item->GetCell(),
+				item->GetLocaleName(),
+				item->GetID()
+			);
 	}
 }
 
@@ -4855,28 +5012,6 @@
 		item->SetSocket(socket_num, value);
 }
 
-ACMD(do_get_socket)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	int cell;
-	str_to_number(cell, arg1);
-
-	LPITEM item = ch->GetInventoryItem(cell);
-	if (item)
-	{
-		for (int i = 0; i < ITEM_SOCKET_MAX_NUM; ++i)
-		{
-			ch->ChatPacket(CHAT_TYPE_INFO, "cell(%d), socket(%d) : %ld", cell, i, item->GetSocket(i));
-		}
-	}
-	else
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, "    .");
-	}
-}
-
 ACMD(do_can_dead)
 {
 	if (subcmd)
@@ -4908,12 +5043,12 @@
 		{
 			switch (i)
 			{
-				case SKILL_HORSE_WILDATTACK:
-				case SKILL_HORSE_CHARGE:
-				case SKILL_HORSE_ESCAPE:
-				case SKILL_HORSE_WILDATTACK_RANGE:
-					ch->SetSkillLevel(i, SKILL_MAX_LEVEL);
-					break;
+			case SKILL_HORSE_WILDATTACK:
+			case SKILL_HORSE_CHARGE:
+			case SKILL_HORSE_ESCAPE:
+			case SKILL_HORSE_WILDATTACK_RANGE:
+				ch->SetSkillLevel(i, SKILL_MAX_LEVEL);
+				break;
 			}
 		}
 	}
@@ -4923,243 +5058,167 @@
 
 ACMD(do_item_full_set)
 {
-	BYTE bJob = ch->GetJob();
-	LPITEM pItem = nullptr;
+	BYTE job = ch->GetJob();
+	LPITEM item;
 
-	std::vector<BYTE> vWearIndex
+	for (int i = 0; i < 6; i++)
 	{
-		WEAR_BODY,
-		WEAR_HEAD,
-		WEAR_FOOTS,
-		WEAR_WRIST,
-		WEAR_WEAPON,
-		WEAR_NECK,
-		WEAR_EAR,
-		WEAR_UNIQUE1,
-		WEAR_UNIQUE2,
-		WEAR_ARROW,
-		WEAR_SHIELD,
-		WEAR_BELT,
-#if defined(__PENDANT_SYSTEM__)
-		WEAR_PENDANT,
-#endif
-#if defined(__GLOVE_SYSTEM__)
-		WEAR_GLOVE,
-#endif
+		item = ch->GetWear(i);
+		if (item != NULL)
+			ch->UnequipItem(item);
+	}
 
-		WEAR_COSTUME_BODY,
-		WEAR_COSTUME_HAIR,
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-		WEAR_COSTUME_MOUNT,
-#endif
-#if defined(__ACCE_COSTUME_SYSTEM__)
-		WEAR_COSTUME_ACCE,
-#endif
-#if defined(__WEAPON_COSTUME_SYSTEM__)
-		WEAR_COSTUME_WEAPON,
-#endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-		WEAR_COSTUME_AURA,
-#endif
-	};
+	item = ch->GetWear(WEAR_SHIELD);
+	if (item != NULL)
+		ch->UnequipItem(item);
 
-	for (const BYTE bWearIndex : vWearIndex)
+	switch (job)
 	{
-		pItem = ch->GetWear(bWearIndex);
-		if (pItem)
-			ch->UnequipItem(pItem);
-	}
-
-	using WearItemMap = std::unordered_map<BYTE, std::vector<DWORD>>;
-	WearItemMap mWearItem =
-	{
-		{ JOB_WARRIOR,
-			{
-				{ 20869 }, // WEAR_BODY
-				{ 12739 }, // WEAR_HEAD
-				{ 15449 }, // WEAR_FOOTS
-				{ 14209 }, // WEAR_WRIST
-				{ 319 }, // WEAR_WEAPON
-				{ 16209 }, // WEAR_NECK
-				{ 17549 }, // WEAR_EAR
-				{ 71202 }, // WEAR_UNIQUE1
-				{ 0 }, // WEAR_UNIQUE2
-				{ 13149 }, // WEAR_SHIELD
-				{ 18089 }, // WEAR_BELT
-#if defined(__PENDANT_SYSTEM__)
-				{ 9800 }, // WEAR_PENDANT
-#endif
-#if defined(__GLOVE_SYSTEM__)
-				{ 23009 }, // WEAR_GLOVE
-#endif
-				{ 0 }, // WEAR_COSTUME_BODY
-				{ 0 }, // WEAR_COSTUME_HAIR
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-				{ 0 }, // WEAR_COSTUME_MOUNT
-#endif
-#if defined(__ACCE_COSTUME_SYSTEM__)
-				{ 85004 }, // WEAR_COSTUME_ACCE
-#endif
-#if defined(__WEAPON_COSTUME_SYSTEM__)
-				{ 0 }, // WEAR_COSTUME_WEAPON
-#endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-				{ 49006 }, // WEAR_COSTUME_AURA
-#endif
-			},
-		},
-		{ JOB_ASSASSIN,
-			{
-				{ 20879 }, // WEAR_BODY
-				{ 12749 }, // WEAR_HEAD
-				{ 15449 }, // WEAR_FOOTS
-				{ 14209 }, // WEAR_WRIST
-				{ 1189 }, // WEAR_WEAPON
-				{ 16209 }, // WEAR_NECK
-				{ 17549 }, // WEAR_EAR
-				{ 71202 }, // WEAR_UNIQUE1
-				{ 0 }, // WEAR_UNIQUE2
-				{ 79504 }, // WEAR_ARROW
-				{ 13149 }, // WEAR_SHIELD
-				{ 18089 }, // WEAR_BELT
-#if defined(__PENDANT_SYSTEM__)
-				{ 9800 }, // WEAR_PENDANT
-#endif
-#if defined(__GLOVE_SYSTEM__)
-				{ 23009 }, // WEAR_GLOVE
-#endif
-				{ 0 }, // WEAR_COSTUME_BODY
-				{ 0 }, // WEAR_COSTUME_HAIR
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-				{ 0 }, // WEAR_COSTUME_MOUNT
-#endif
-#if defined(__ACCE_COSTUME_SYSTEM__)
-				{ 85004 }, // WEAR_COSTUME_ACCE
-#endif
-#if defined(__WEAPON_COSTUME_SYSTEM__)
-				{ 0 }, // WEAR_COSTUME_WEAPON
-#endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-				{ 49006 }, // WEAR_COSTUME_AURA
-#endif
-			},
-		},
-		{ JOB_SURA,
-			{
-				{ 20889 }, // WEAR_BODY
-				{ 12489 }, // WEAR_HEAD
-				{ 15449 }, // WEAR_FOOTS
-				{ 14209 }, // WEAR_WRIST
-				{ 309 }, // WEAR_WEAPON
-				{ 16209 }, // WEAR_NECK
-				{ 17549 }, // WEAR_EAR
-				{ 71202 }, // WEAR_UNIQUE1
-				{ 0 }, // WEAR_UNIQUE2
-				{ 13149 }, // WEAR_SHIELD
-				{ 18089 }, // WEAR_BELT
-#if defined(__PENDANT_SYSTEM__)
-				{ 9800 }, // WEAR_PENDANT
-#endif
-#if defined(__GLOVE_SYSTEM__)
-				{ 23009 }, // WEAR_GLOVE
-#endif
-				{ 0 }, // WEAR_COSTUME_BODY
-				{ 0 }, // WEAR_COSTUME_HAIR
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-				{ 0 }, // WEAR_COSTUME_MOUNT
-#endif
-#if defined(__ACCE_COSTUME_SYSTEM__)
-				{ 85004 }, // WEAR_COSTUME_ACCE
-#endif
-#if defined(__WEAPON_COSTUME_SYSTEM__)
-				{ 0 }, // WEAR_COSTUME_WEAPON
-#endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-				{ 49006 }, // WEAR_COSTUME_AURA
-#endif
-			},
-		},
-		{ JOB_SHAMAN,
-			{
-				{ 20899 }, // WEAR_BODY
-				{ 12629 }, // WEAR_HEAD
-				{ 15449 }, // WEAR_FOOTS
-				{ 14209 }, // WEAR_WRIST
-				{ 5169 }, // WEAR_WEAPON
-				{ 16209 }, // WEAR_NECK
-				{ 17549 }, // WEAR_EAR
-				{ 71202 }, // WEAR_UNIQUE1
-				{ 0 }, // WEAR_UNIQUE2
-				{ 13149 }, // WEAR_SHIELD
-				{ 18089 }, // WEAR_BELT
-#if defined(__PENDANT_SYSTEM__)
-				{ 9800 }, // WEAR_PENDANT
-#endif
-#if defined(__GLOVE_SYSTEM__)
-				{ 23009 }, // WEAR_GLOVE
-#endif
-				{ 0 }, // WEAR_COSTUME_BODY
-				{ 0 }, // WEAR_COSTUME_HAIR
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-				{ 0 }, // WEAR_COSTUME_MOUNT
-#endif
-#if defined(__ACCE_COSTUME_SYSTEM__)
-				{ 85004 }, // WEAR_COSTUME_ACCE
-#endif
-#if defined(__WEAPON_COSTUME_SYSTEM__)
-				{ 0 }, // WEAR_COSTUME_WEAPON
-#endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-				{ 49006 }, // WEAR_COSTUME_AURA
-#endif
-			},
-		},
-		{ JOB_WOLFMAN,
-			{
-				{ 20909 }, // WEAR_BODY
-				{ 21509 }, // WEAR_HEAD
-				{ 15449 }, // WEAR_FOOTS
-				{ 14209 }, // WEAR_WRIST
-				{ 6129 }, // WEAR_WEAPON
-				{ 16209 }, // WEAR_NECK
-				{ 17549 }, // WEAR_EAR
-				{ 71202 }, // WEAR_UNIQUE1
-				{ 0 }, // WEAR_UNIQUE2
-				{ 13149 }, // WEAR_SHIELD
-				{ 18089 }, // WEAR_BELT
-#if defined(__PENDANT_SYSTEM__)
-				{ 9800 }, // WEAR_PENDANT
-#endif
-#if defined(__GLOVE_SYSTEM__)
-				{ 23009 }, // WEAR_GLOVE
-#endif
-				{ 0 }, // WEAR_COSTUME_BODY
-				{ 0 }, // WEAR_COSTUME_HAIR
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-				{ 0 }, // WEAR_COSTUME_MOUNT
-#endif
-#if defined(__ACCE_COSTUME_SYSTEM__)
-				{ 85004 }, // WEAR_COSTUME_ACCE
-#endif
-#if defined(__WEAPON_COSTUME_SYSTEM__)
-				{ 0 }, // WEAR_COSTUME_WEAPON
-#endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-				{ 49006 }, // WEAR_COSTUME_AURA
-#endif
-			},
-		},
-	};
-
-	const WearItemMap::iterator& it = mWearItem.find(bJob);
-	if (it != mWearItem.end())
-	{
-		for (const DWORD dwVnum : it->second)
-		{
-			pItem = ITEM_MANAGER::instance().CreateItem(dwVnum, 1, 0, false, -1, false, true);
-			if (!pItem || !pItem->EquipTo(ch, pItem->FindEquipCell(ch)))
-				M2_DESTROY_ITEM(pItem);
-		}
+	case JOB_WARRIOR:
+	{
+		item = ITEM_MANAGER::instance().CreateItem(11971); // 11299
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(13049);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(15189);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(3159);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(12249);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(14109);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(17109);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(16109);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+	}
+	break;
+
+	case JOB_ASSASSIN:
+	{
+		item = ITEM_MANAGER::instance().CreateItem(11972); // 11499
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(13049);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(15189);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(1139);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(12389);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(14109);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(17189);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(16189);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+	}
+	break;
+
+	case JOB_SURA:
+	{
+		item = ITEM_MANAGER::instance().CreateItem(11973); // 11699
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(13049);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(15189);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(189);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(12529);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(14109);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(17209);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(16209);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+	}
+	break;
+
+	case JOB_SHAMAN:
+	{
+		item = ITEM_MANAGER::instance().CreateItem(11974); // 11899
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(13049);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(15189);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(7159);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(12669);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(14109);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(17209);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(16209);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+	}
+	break;
+
+	case JOB_WOLFMAN:
+	{
+		item = ITEM_MANAGER::instance().CreateItem(21049);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(13049);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(15189);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(6049);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(21559);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(14109);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(17209);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+		item = ITEM_MANAGER::instance().CreateItem(16209);
+		if (!item || !item->EquipTo(ch, item->FindEquipCell(ch)))
+			M2_DESTROY_ITEM(item);
+	}
+	break;
+
 	}
 
 	ch->ComputePoints();
@@ -5172,232 +5231,101 @@
 
 	switch (job)
 	{
-		case JOB_WARRIOR:
-		case JOB_ASSASSIN:
-		case JOB_SURA:
-		case JOB_SHAMAN:
-		case JOB_WOLFMAN:
-		{
-			//   .
-			// ̰͸  ־ ӽ÷    ̷ Ӽ .
-			// WEAR_BODY
-			item = ch->GetWear(WEAR_BODY);
-			if (item != NULL)
-			{
-				item->ClearAllAttribute();
-				item->SetForceAttribute(0, APPLY_MAX_HP, 2000);
-				item->SetForceAttribute(1, APPLY_CAST_SPEED, 20);
-				item->SetForceAttribute(2, APPLY_STEAL_HP, 10);
-				item->SetForceAttribute(3, APPLY_REFLECT_MELEE, 10);
-				item->SetForceAttribute(4, APPLY_ATT_GRADE_BONUS, 50);
-#if defined(__ATTR_6TH_7TH__)
-				item->SetForceAttribute(5, APPLY_MAX_HP, 500);
-				item->SetForceAttribute(6, APPLY_ATT_GRADE_BONUS, 50);
-#endif
-				item->SetSocket(0, 28438);
-				item->SetSocket(1, 28441);
-				item->SetSocket(2, 28442);
-			}
-			// WEAR_HEAD
-			item = ch->GetWear(WEAR_HEAD);
-			if (item != NULL)
-			{
-				item->ClearAllAttribute();
-				item->SetForceAttribute(0, APPLY_ATT_SPEED, 8);
-				item->SetForceAttribute(1, APPLY_HP_REGEN, 30);
-				item->SetForceAttribute(2, APPLY_SP_REGEN, 30);
-				item->SetForceAttribute(3, APPLY_DODGE, 15);
-				item->SetForceAttribute(4, APPLY_STEAL_SP, 10);
-#if defined(__ATTR_6TH_7TH__)
-				item->SetForceAttribute(5, APPLY_MAX_HP, 500);
-				item->SetForceAttribute(6, APPLY_ATT_GRADE_BONUS, 50);
-#endif
-			}
-			// WEAR_FOOTS
-			item = ch->GetWear(WEAR_FOOTS);
-			if (item != NULL)
-			{
-				item->ClearAllAttribute();
-				item->SetForceAttribute(0, APPLY_MAX_HP, 2000);
-				item->SetForceAttribute(1, APPLY_MAX_SP, 80);
-				item->SetForceAttribute(2, APPLY_MOV_SPEED, 8);
-				item->SetForceAttribute(3, APPLY_ATT_SPEED, 8);
-				item->SetForceAttribute(4, APPLY_CRITICAL_PCT, 10);
-#if defined(__ATTR_6TH_7TH__)
-				item->SetForceAttribute(5, APPLY_MAX_HP, 500);
-				item->SetForceAttribute(6, APPLY_ATT_GRADE_BONUS, 50);
-#endif
-			}
-			// WEAR_WRIST
-			item = ch->GetWear(WEAR_WRIST);
-			if (item != NULL)
-			{
-				item->ClearAllAttribute();
-				item->SetForceAttribute(0, APPLY_MAX_HP, 2000);
-				item->SetForceAttribute(1, APPLY_MAX_SP, 80);
-				item->SetForceAttribute(2, APPLY_PENETRATE_PCT, 10);
-				item->SetForceAttribute(3, APPLY_STEAL_HP, 10);
-				item->SetForceAttribute(4, APPLY_MANA_BURN_PCT, 10);
-#if defined(__ATTR_6TH_7TH__)
-				item->SetForceAttribute(5, APPLY_MAX_HP, 500);
-				item->SetForceAttribute(6, APPLY_ATT_GRADE_BONUS, 50);
-#endif
-				item->SetSocket(0, 3);
-				item->SetSocket(1, 3);
-				item->SetSocket(2, 21600);
-			}
-			// WEAR_WEAPON
-			item = ch->GetWear(WEAR_WEAPON);
-			if (item != NULL)
-			{
-				item->ClearAllAttribute();
-				item->SetForceAttribute(0, APPLY_NORMAL_HIT_DAMAGE_BONUS, 60);
-				item->SetForceAttribute(1, APPLY_CRITICAL_PCT, 10);
-				item->SetForceAttribute(2, APPLY_PENETRATE_PCT, 10);
-				item->SetForceAttribute(3, APPLY_CAST_SPEED, 20);
-				item->SetForceAttribute(4, APPLY_STR, 12);
-#if defined(__ATTR_6TH_7TH__)
-				item->SetForceAttribute(5, APPLY_ATTBONUS_PER_MONSTER, 10);
-				item->SetForceAttribute(6, APPLY_ATT_GRADE_BONUS, 50);
-#endif
-				item->SetSocket(0, 28437);
-				item->SetSocket(1, 28431);
-				item->SetSocket(2, 28430);
-			}
-			// WEAR_NECK
-			item = ch->GetWear(WEAR_NECK);
-			if (item != NULL)
-			{
-				item->ClearAllAttribute();
-				item->SetForceAttribute(0, APPLY_MAX_HP, 2000);
-				item->SetForceAttribute(1, APPLY_MAX_SP, 80);
-				item->SetForceAttribute(2, APPLY_CRITICAL_PCT, 10);
-				item->SetForceAttribute(3, APPLY_PENETRATE_PCT, 10);
-				item->SetForceAttribute(4, APPLY_STEAL_SP, 10);
-#if defined(__ATTR_6TH_7TH__)
-				item->SetForceAttribute(5, APPLY_MAX_HP, 500);
-				item->SetForceAttribute(6, APPLY_ATT_GRADE_BONUS, 50);
-#endif
-				item->SetSocket(0, 3);
-				item->SetSocket(1, 3);
-				item->SetSocket(2, 21600);
-			}
-			// WEAR_EAR
-			item = ch->GetWear(WEAR_EAR);
-			if (item != NULL)
-			{
-				item->ClearAllAttribute();
-				item->SetForceAttribute(0, APPLY_MOV_SPEED, 20);
-				item->SetForceAttribute(1, APPLY_MANA_BURN_PCT, 10);
-				item->SetForceAttribute(2, APPLY_POISON_REDUCE, 5);
-				item->SetForceAttribute(3, APPLY_ATTBONUS_DEVIL, 20);
-				item->SetForceAttribute(4, APPLY_ATTBONUS_UNDEAD, 20);
-#if defined(__ATTR_6TH_7TH__)
-				item->SetForceAttribute(5, APPLY_MAX_HP, 500);
-				item->SetForceAttribute(6, APPLY_ATT_GRADE_BONUS, 50);
-#endif
-				item->SetSocket(0, 3);
-				item->SetSocket(1, 3);
-				item->SetSocket(2, 21600);
-			}
-			// WEAR_SHIELD
-			item = ch->GetWear(WEAR_SHIELD);
-			if (item != NULL)
-			{
-				item->ClearAllAttribute();
-				item->SetForceAttribute(0, APPLY_CON, 12);
-				item->SetForceAttribute(1, APPLY_BLOCK, 15);
-				item->SetForceAttribute(2, APPLY_REFLECT_MELEE, 10);
-				item->SetForceAttribute(3, APPLY_IMMUNE_STUN, 1);
-				item->SetForceAttribute(4, APPLY_IMMUNE_SLOW, 1);
-#if defined(__ATTR_6TH_7TH__)
-				item->SetForceAttribute(5, APPLY_MAX_HP, 500);
-				item->SetForceAttribute(6, APPLY_ATT_GRADE_BONUS, 50);
-#endif
-			}
-			// WEAR_BELT
-			item = ch->GetWear(WEAR_BELT);
-			if (item != NULL)
-			{
-				item->ClearAllAttribute();
-				item->SetSocket(0, 3);
-				item->SetSocket(1, 3);
-				item->SetSocket(2, 21600);
-			}
-			// WEAR_PENDANT
-#if defined(__PENDANT_SYSTEM__)
-			item = ch->GetWear(WEAR_PENDANT);
-			if (item != NULL)
-			{
-				item->ClearAllAttribute();
-				item->SetForceAttribute(0, APPLY_MALL_DEFBONUS, 5);
-				item->SetForceAttribute(1, APPLY_RESIST_ICE, 25);
-				item->SetForceAttribute(2, APPLY_RESIST_EARTH, 25);
-				item->SetForceAttribute(3, APPLY_RESIST_DARK, 25);
-				item->SetForceAttribute(4, APPLY_ATTBONUS_HUMAN, 10);
-#if defined(__ATTR_6TH_7TH__)
-				item->SetForceAttribute(5, APPLY_MAX_HP, 500);
-				item->SetForceAttribute(6, APPLY_ATT_GRADE_BONUS, 50);
-#endif
-			}
-#endif
-			// WEAR_GLOVE
-#if defined(__GLOVE_SYSTEM__)
-			item = ch->GetWear(WEAR_GLOVE);
-			if (item != NULL)
-			{
-				item->ClearAllAttribute();
-				item->SetForceAttribute(0, APPLY_HIT_PCT, 12);
-				item->SetForceAttribute(1, APPLY_RESIST_HUMAN, 10);
-				item->SetForceAttribute(2, APPLY_RESIST_MOUNT_FALL, 20);
-				item->SetForceAttribute(3, APPLY_REFLECT_MELEE, 10);
-				item->SetForceAttribute(4, APPLY_STR, 12);
-#if defined(__ATTR_6TH_7TH__)
-				item->SetForceAttribute(5, APPLY_MAX_HP, 500);
-				item->SetForceAttribute(6, APPLY_ATT_GRADE_BONUS, 50);
-#endif
-			}
-#endif
-			// WEAR_COSTUME_ACCE
-#if defined(__ACCE_COSTUME_SYSTEM__)
-			item = ch->GetWear(WEAR_COSTUME_ACCE);
-			if (item != NULL)
-			{
-				item->ClearAllAttribute();
-				item->SetSocket(ITEM_SOCKET_ACCE_DRAIN_ITEM_VNUM, 2209);
-				item->SetSocket(ITEM_SOCKET_ACCE_DRAIN_VALUE, ACCE_MAX_DRAINRATE);
-				item->SetForceAttribute(0, APPLY_NORMAL_HIT_DAMAGE_BONUS, 12);
-				item->SetForceAttribute(1, APPLY_CRITICAL_PCT, 2);
-				item->SetForceAttribute(2, APPLY_PENETRATE_PCT, 2);
-				item->SetForceAttribute(3, APPLY_DEX, 3);
-				item->SetForceAttribute(4, APPLY_STR, 3);
-#if defined(__ATTR_6TH_7TH__)
-				item->SetForceAttribute(5, APPLY_ATTBONUS_STONE, 2);
-				item->SetForceAttribute(6, APPLY_ATT_GRADE_BONUS, 12);
-#endif
-			}
-#endif
-			// WEAR_COSTUME_AURA
-#if defined(__AURA_COSTUME_SYSTEM__)
-			item = ch->GetWear(WEAR_COSTUME_AURA);
-			if (item != NULL)
-			{
-				item->ClearAllAttribute();
-				item->SetSocket(ITEM_SOCKET_AURA_DRAIN_ITEM_VNUM, 16209);
-
-				item->SetForceAttribute(0, APPLY_MAX_HP, 500);
-				item->SetForceAttribute(1, APPLY_MAX_SP, 20);
-				item->SetForceAttribute(2, APPLY_CRITICAL_PCT, 2);
-				item->SetForceAttribute(3, APPLY_PENETRATE_PCT, 2);
-				item->SetForceAttribute(4, APPLY_DAMAGE_SP_RECOVER, 2);
-#if defined(__ATTR_6TH_7TH__)
-				item->SetForceAttribute(5, APPLY_MAX_HP, 125);
-				item->SetForceAttribute(6, APPLY_ATT_GRADE_BONUS, 12);
-#endif
-			}
-#endif
+	case JOB_WARRIOR:
+	case JOB_ASSASSIN:
+	case JOB_SURA:
+	case JOB_SHAMAN:
+	case JOB_WOLFMAN:
+	{
+		//   .
+		// ̰͸  ־ ӽ÷    ̷ Ӽ .
+		item = ch->GetWear(WEAR_HEAD);
+		if (item != NULL)
+		{
+			item->ClearAttribute();
+			item->SetForceAttribute(0, APPLY_ATT_SPEED, 8);
+			item->SetForceAttribute(1, APPLY_HP_REGEN, 30);
+			item->SetForceAttribute(2, APPLY_SP_REGEN, 30);
+			item->SetForceAttribute(3, APPLY_DODGE, 15);
+			item->SetForceAttribute(4, APPLY_STEAL_SP, 10);
+		}
+
+		item = ch->GetWear(WEAR_WEAPON);
+		if (item != NULL)
+		{
+			item->ClearAttribute();
+			item->SetForceAttribute(0, APPLY_CAST_SPEED, 20);
+			item->SetForceAttribute(1, APPLY_CRITICAL_PCT, 10);
+			item->SetForceAttribute(2, APPLY_PENETRATE_PCT, 10);
+			item->SetForceAttribute(3, APPLY_ATTBONUS_DEVIL, 20);
+			item->SetForceAttribute(4, APPLY_STR, 12);
+		}
+
+		item = ch->GetWear(WEAR_SHIELD);
+		if (item != NULL)
+		{
+			item->ClearAttribute();
+			item->SetForceAttribute(0, APPLY_CON, 12);
+			item->SetForceAttribute(1, APPLY_BLOCK, 15);
+			item->SetForceAttribute(2, APPLY_REFLECT_MELEE, 10);
+			item->SetForceAttribute(3, APPLY_IMMUNE_STUN, 1);
+			item->SetForceAttribute(4, APPLY_IMMUNE_SLOW, 1);
+		}
+
+		item = ch->GetWear(WEAR_BODY);
+		if (item != NULL)
+		{
+			item->ClearAttribute();
+			item->SetForceAttribute(0, APPLY_MAX_HP, 2000);
+			item->SetForceAttribute(1, APPLY_CAST_SPEED, 20);
+			item->SetForceAttribute(2, APPLY_STEAL_HP, 10);
+			item->SetForceAttribute(3, APPLY_REFLECT_MELEE, 10);
+			item->SetForceAttribute(4, APPLY_ATT_GRADE_BONUS, 50);
+		}
+
+		item = ch->GetWear(WEAR_FOOTS);
+		if (item != NULL)
+		{
+			item->ClearAttribute();
+			item->SetForceAttribute(0, APPLY_MAX_HP, 2000);
+			item->SetForceAttribute(1, APPLY_MAX_SP, 80);
+			item->SetForceAttribute(2, APPLY_MOV_SPEED, 8);
+			item->SetForceAttribute(3, APPLY_ATT_SPEED, 8);
+			item->SetForceAttribute(4, APPLY_CRITICAL_PCT, 10);
+		}
+
+		item = ch->GetWear(WEAR_WRIST);
+		if (item != NULL)
+		{
+			item->ClearAttribute();
+			item->SetForceAttribute(0, APPLY_MAX_HP, 2000);
+			item->SetForceAttribute(1, APPLY_MAX_SP, 80);
+			item->SetForceAttribute(2, APPLY_PENETRATE_PCT, 10);
+			item->SetForceAttribute(3, APPLY_STEAL_HP, 10);
+			item->SetForceAttribute(4, APPLY_MANA_BURN_PCT, 10);
+		}
+		item = ch->GetWear(WEAR_NECK);
+		if (item != NULL)
+		{
+			item->ClearAttribute();
+			item->SetForceAttribute(0, APPLY_MAX_HP, 2000);
+			item->SetForceAttribute(1, APPLY_MAX_SP, 80);
+			item->SetForceAttribute(2, APPLY_CRITICAL_PCT, 10);
+			item->SetForceAttribute(3, APPLY_PENETRATE_PCT, 10);
+			item->SetForceAttribute(4, APPLY_STEAL_SP, 10);
+		}
+		item = ch->GetWear(WEAR_EAR);
+		if (item != NULL)
+		{
+			item->ClearAttribute();
+			item->SetForceAttribute(0, APPLY_MOV_SPEED, 20);
+			item->SetForceAttribute(1, APPLY_MANA_BURN_PCT, 10);
+			item->SetForceAttribute(2, APPLY_POISON_REDUCE, 5);
+			item->SetForceAttribute(3, APPLY_ATTBONUS_DEVIL, 20);
+			item->SetForceAttribute(4, APPLY_ATTBONUS_UNDEAD, 20);
 		}
-		break;
+	}
+	break;
 	}
 
 	ch->ComputePoints();
@@ -5442,8 +5370,16 @@
 		{
 			LPCHARACTER ch = (LPCHARACTER)ent;
 
-			if (m_ch == ch || ch->IsNPC() || ch->IsGM() || ch->IsDead() || ch->GetHP() <= 0)
-				return;
+			if (!test_server)
+			{
+				if (!ch->IsPC() || m_ch == ch || ch->IsGM() || ch->IsDead() || ch->GetHP() <= 0)
+					return;
+			}
+			else
+			{
+				if (!ch->IsPC() || m_ch == ch || ch->IsDead() || ch->GetHP() <= 0)
+					return;
+			}
 
 			float fDist = DISTANCE_APPROX(m_ch->GetX() - ch->GetX(), m_ch->GetY() - ch->GetY());
 			if (fDist > 7000.f)
@@ -5507,29 +5443,28 @@
 	}
 }
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
 ACMD(do_dragon_soul)
 {
 	char arg1[512];
 	const char* rest = one_argument(argument, arg1, sizeof(arg1));
 	switch (arg1[0])
 	{
-		case 'a':
-		{
-			one_argument(rest, arg1, sizeof(arg1));
-			int deck_idx = 0;
-			if (str_to_number(deck_idx, arg1) == false)
-			{
-				return;
-			}
-			ch->DragonSoul_ActivateDeck(deck_idx);
-		}
-		break;
-		case 'd':
+	case 'a':
+	{
+		one_argument(rest, arg1, sizeof(arg1));
+		int deck_idx = 0;
+		if (str_to_number(deck_idx, arg1) == false)
 		{
-			ch->DragonSoul_DeactivateAll();
+			return;
 		}
-		break;
+		ch->DragonSoul_ActivateDeck(deck_idx);
+	}
+	break;
+	case 'd':
+	{
+		ch->DragonSoul_DeactivateAll();
+	}
+	break;
 	}
 }
 
@@ -5541,676 +5476,129 @@
 
 		LPITEM item = ch->GetItem(cell);
 		if (item != NULL)
-			ch->ChatPacket(CHAT_TYPE_INFO, "cell : %d, name : %s, id : %d", item->GetCell(), item->GetName(), item->GetID());
+			ch->ChatPacket(CHAT_TYPE_INFO, "cell : %d, name : %s, id : %d",
+				item->GetCell(),
+				item->GetLocaleName(),
+				item->GetID()
+			);
 	}
 }
 
-ACMD(do_ds_qualify)
-{
-	ch->DragonSoul_GiveQualification();
-}
-#endif
-
-#if defined(__INGAME_EVENT_MANAGER__) && defined(__EVENT_BANNER_FLAG__)
-ACMD(do_banner)
+#if defined(__MINI_GAME_CATCH_KING__)
+ACMD(do_catch_king_event)
 {
 	char arg1[256], arg2[256];
-	int iEnable = 0;
-
+	int iCommand = 1;
+	int iDays = 1;
 	two_arguments(argument, arg1, sizeof(arg1), arg2, sizeof(arg2));
 
-	if (!*arg1 || !*arg2 || !isnhdigit(*arg1))
+	if (!*arg1 && !*arg2)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, "Usage: /banner <1:0> <banner_name>");
-		ch->ChatPacket(CHAT_TYPE_INFO, "Example: /banner 1 halloween");
+		ch->ChatPacket(CHAT_TYPE_INFO, "Usage: catch_king_event <command> <days_number>");
+		ch->ChatPacket(CHAT_TYPE_INFO, "	0 = Disable.");
+		ch->ChatPacket(CHAT_TYPE_INFO, "	1 = Enable.");
+		ch->ChatPacket(CHAT_TYPE_INFO, "<days_number> Is the number of days that event is on.");
 		return;
 	}
 
-	str_to_number(iEnable, arg1);
-
-	CInGameEventManager::instance().SpawnBanners(iEnable, arg2);
-
-	return;
-}
-#endif
-
-#if defined(__CONQUEROR_LEVEL__)
-ACMD(do_conqueror_level)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	if (!*arg1)
+	if (isnhdigit(*arg1) && isnhdigit(*arg2))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, "Syntax: conqueror_level <level>");
-		return;
+		str_to_number(iCommand, arg1);
+		str_to_number(iDays, arg2);
 	}
 
-	int level = 0;
-	str_to_number(level, arg1);
-
-	ch->ResetConquerorPoint(MINMAX(0, level, gPlayerMaxConquerorLevel));
-	ch->ResetConquerorExp();
-}
-#endif
-
-#if defined(__MINI_GAME_RUMI__)
-ACMD(do_mini_game_okey)
-{
-	char szArg1[256], szArg2[256], szArg3[256];
-	three_arguments(argument, szArg1, sizeof(szArg1), szArg2, sizeof(szArg2), szArg3, sizeof(szArg3));
-	int iEnable = 0, iDropPerKillPct = 100, iNormal = 0;
-
-	if (strlen(szArg1) == 0)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, "Usage: mini_game_okey <enable_days> <drop_value>");
-		ch->ChatPacket(CHAT_TYPE_INFO, "       <enable_days> days / 0 (disable); -1 (disable + disable reward cooldown)");
-		ch->ChatPacket(CHAT_TYPE_INFO, "       <drop_value> default 100");
-		ch->ChatPacket(CHAT_TYPE_INFO, "       <normal> default 0");
+	if (iDays <= 0)
 		return;
-	}
-
-	if (*szArg1 && !strcmp(szArg1, "-1"))
-		iEnable -= 1;
-	else if (isnhdigit(*szArg1))
-		str_to_number(iEnable, szArg1);
 
-	if (isnhdigit(*szArg2))
-		str_to_number(iDropPerKillPct, szArg2);
-
-	if (isnhdigit(*szArg3))
-		str_to_number(iNormal, szArg3);
-
-	if (iEnable > 0)
+	if (iCommand == 1)
 	{
-		DWORD dwEndTime = std::time(nullptr) + (60 * 60 * 24 * iEnable);
-
-		if (iNormal == 0)
+		if (quest::CQuestManager::instance().GetEventFlag("enable_catch_king_event") == 0)
 		{
-			quest::CQuestManager::instance().RequestSetEventFlag("mini_game_okey", dwEndTime);
-			quest::CQuestManager::instance().RequestSetEventFlag("mini_game_okey_normal", 0);
+			int iEndTime = time(0) + 60 * 60 * 24 * iDays;
+
+			quest::CQuestManager::instance().RequestSetEventFlag("enable_catch_king_event", 1);
+			quest::CQuestManager::instance().RequestSetEventFlag("enable_catch_king_event_drop", 1);
+			quest::CQuestManager::instance().RequestSetEventFlag("catch_king_event_end_day", iEndTime);
+
+			SendNotice(LC_TEXT("Catch king event is now active."));
 		}
 		else
 		{
-			quest::CQuestManager::instance().RequestSetEventFlag("mini_game_okey", 0);
-			quest::CQuestManager::instance().RequestSetEventFlag("mini_game_okey_normal", dwEndTime);
+			ch->ChatPacket(CHAT_TYPE_INFO, "This event is already opened.");
 		}
-
-		quest::CQuestManager::instance().RequestSetEventFlag("mini_game_okey_drop", iDropPerKillPct);
-		quest::CQuestManager::instance().RequestSetEventFlag("mini_game_okey_reward", 0);
-
-		BroadcastNotice(LC_STRING("[Okey Event] The Okey Event has started!"));
-		BroadcastNotice(LC_STRING("[Okey Event] Defeat monsters, collect cards and play a game of okey."));
-		BroadcastNotice(LC_STRING("[Okey Event] Amazing prizes await!"));
-	}
-	else if (iEnable == 0)
-	{
-		quest::CQuestManager::instance().RequestSetEventFlag("mini_game_okey", 0);
-		quest::CQuestManager::instance().RequestSetEventFlag("mini_game_okey_normal", 0);
-		quest::CQuestManager::instance().RequestSetEventFlag("mini_game_okey_reward",
-			std::time(nullptr) + CMiniGameRumi::RUMI_REWARD_COOLDOWN);
-
-		BroadcastNotice(LC_STRING("[Okey Event] The Okey Event is over!"));
-		BroadcastNotice(LC_STRING("[Okey Event] If you make it into the top rankings, you have 7 days to collect your prize."));
 	}
 	else
 	{
-		quest::CQuestManager::instance().RequestSetEventFlag("mini_game_okey", 0);
-		quest::CQuestManager::instance().RequestSetEventFlag("mini_game_okey_normal", 0);
-		quest::CQuestManager::instance().RequestSetEventFlag("mini_game_okey_reward", -1); // -1 to remove the event npc.
-
-		BroadcastNotice(LC_STRING("[Okey Event] The Okey Event is over!"));
+		quest::CQuestManager::instance().RequestSetEventFlag("enable_catch_king_event", 0);
+		quest::CQuestManager::instance().RequestSetEventFlag("enable_catch_king_event_drop", 0);
+		ch->ChatPacket(CHAT_TYPE_INFO, "You deactivated catch king event.");
 	}
 }
 #endif
 
-#if defined(__MINI_GAME_YUTNORI__)
-ACMD(do_mini_game_yutnori)
-{
-	char szArg1[256], szArg2[256];
-	two_arguments(argument, szArg1, sizeof(szArg1), szArg2, sizeof(szArg2));
-	int iEnable = 0, iDropPerKillPct = 100;
-
-	if (strlen(szArg1) == 0)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, "Usage: mini_game_yutnori <enable_days> <drop_value>");
-		ch->ChatPacket(CHAT_TYPE_INFO, "       <enable_days> days / 0 (disable); -1 (disable + disable reward cooldown)");
-		ch->ChatPacket(CHAT_TYPE_INFO, "       <drop_value> default 100");
-		return;
-	}
-
-	if (*szArg1 && !strcmp(szArg1, "-1"))
-		iEnable -= 1;
-	else if (isnhdigit(*szArg1))
-		str_to_number(iEnable, szArg1);
-
-	if (isnhdigit(*szArg2))
-		str_to_number(iDropPerKillPct, szArg2);
-
-	if (iEnable > 0)
-	{
-		DWORD dwEndTime = std::time(nullptr) + (60 * 60 * 24 * iEnable);
-
-		quest::CQuestManager::instance().RequestSetEventFlag("mini_game_yutnori", dwEndTime);
-		quest::CQuestManager::instance().RequestSetEventFlag("mini_game_yutnori_drop", iDropPerKillPct);
-		quest::CQuestManager::instance().RequestSetEventFlag("mini_game_yutnori_reward", 0);
-
-		BroadcastNotice(LC_STRING("Yut Nori has started!"));
-		BroadcastNotice(LC_STRING("Collect Birch Branches, craft Yut Nori Boards from them and play the exciting minigame."));
-		BroadcastNotice(LC_STRING("Fantastic prizes await!"));
-	}
-	else if (iEnable == 0)
-	{
-		quest::CQuestManager::instance().RequestSetEventFlag("mini_game_yutnori", 0);
-		quest::CQuestManager::instance().RequestSetEventFlag("mini_game_yutnori_reward",
-			std::time(nullptr) + CMiniGameYutnori::YUTNORI_REWARD_COOLDOWN);
-
-		BroadcastNotice(LC_STRING("Yut Nori has finished."));
-		BroadcastNotice(LC_STRING("Go to the Yut Nori Table to collect your reward."));
-	}
-	else
-	{
-		quest::CQuestManager::instance().RequestSetEventFlag("mini_game_yutnori", 0);
-		quest::CQuestManager::instance().RequestSetEventFlag("mini_game_yutnori_reward", -1); // -1 to remove the event npc.
-
-		BroadcastNotice(LC_STRING("Yut Nori has finished."));
-	}
-}
-#endif
-
-#if defined(__FLOWER_EVENT__)
-ACMD(do_flower_event)
-{
-	char szArg1[256], szArg2[256];
-	two_arguments(argument, szArg1, sizeof(szArg1), szArg2, sizeof(szArg2));
-	int iDropPerKillPct = 100;
-
-	if (strlen(szArg1) == 0)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, "Usage: flower_event <drop_value>");
-		ch->ChatPacket(CHAT_TYPE_INFO, "       <drop_value> value / 0 (disable)");
-		return;
-	}
-
-	if (isnhdigit(*szArg1))
-		str_to_number(iDropPerKillPct, szArg1);
-
-	if (iDropPerKillPct != 0)
-	{
-		quest::CQuestManager::instance().RequestSetEventFlag("e_flower_drop", iDropPerKillPct);
-		BroadcastNotice(LC_STRING("The Flower Power Event has started."));
-	}
-	else
-	{
-		quest::CQuestManager::instance().RequestSetEventFlag("e_flower_drop", 0);
-		BroadcastNotice(LC_STRING("The Flower Power Event has ended."));
-	}
-}
-#endif
-
-#if defined(__MINI_GAME_CATCH_KING__)
-ACMD(do_mini_game_catchking)
+#if defined(__EVENT_BANNER_FLAG__)
+ACMD(do_banner)
 {
-	char szArg1[256], szArg2[256];
-	two_arguments(argument, szArg1, sizeof(szArg1), szArg2, sizeof(szArg2));
-	int iEnable = 0, iDropPerKillPct = 100;
-
-	if (strlen(szArg1) == 0)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, "Usage: mini_game_catchking <enable_days> <drop_value>");
-		ch->ChatPacket(CHAT_TYPE_INFO, "       <enable_days> days / 0 (disable)");
-		ch->ChatPacket(CHAT_TYPE_INFO, "       <drop_value> default 100");
-		return;
-	}
-
-	if (isnhdigit(*szArg1))
-		str_to_number(iEnable, szArg1);
-
-	if (isnhdigit(*szArg2))
-		str_to_number(iDropPerKillPct, szArg2);
-
-	if (iEnable != 0)
-	{
-		DWORD dwEndTime = std::time(nullptr) + (60 * 60 * 24 * iEnable);
-
-		quest::CQuestManager::instance().RequestSetEventFlag("mini_game_catchking", dwEndTime);
-		quest::CQuestManager::instance().RequestSetEventFlag("mini_game_catchking_drop", iDropPerKillPct);
-
-		BroadcastNotice(LC_STRING("[Catch the King] Play a game of Catch the King now!"));
-		BroadcastNotice(LC_STRING("[Catch the King] Defeat monsters to collect King Cards. You need 25 cards for a King Deck."));
-		BroadcastNotice(LC_STRING("[Catch the King] Loads of great prizes await!"));
-		BroadcastNotice(LC_STRING("[Catch the King] If you make it into the top rankings, you'll receive your prize from the game table."));
-	}
-	else
-	{
-		quest::CQuestManager::instance().RequestSetEventFlag("mini_game_catchking", 0);
-
-		BroadcastNotice(LC_STRING("[Catch the King] Catch the King has ended."));
-	}
-}
-#endif
+	char arg1[256], arg2[256];
+	int iEnable = 0;
 
-#if defined(__SNOWFLAKE_STICK_EVENT__)
-ACMD(do_snowflake_stick_event)
-{
-	char szArg1[256], szArg2[256];
-	two_arguments(argument, szArg1, sizeof(szArg1), szArg2, sizeof(szArg2));
-	int iEnable = 0, iDropPerKillPct = 100;
+	two_arguments(argument, arg1, sizeof(arg1), arg2, sizeof(arg2));
 
-	if (strlen(szArg1) == 0)
+	if (!*arg1 || !*arg2 || !isnhdigit(*arg1))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, "Usage: snowflake_stick_event <enable_days> <drop_value>");
-		ch->ChatPacket(CHAT_TYPE_INFO, "       <enable_days> days / 0 (disable)");
-		ch->ChatPacket(CHAT_TYPE_INFO, "       <drop_value> default 100");
+		ch->ChatPacket(CHAT_TYPE_INFO, "Usage: /banner <1:0> <banner_name>");
+		ch->ChatPacket(CHAT_TYPE_INFO, "Example: /banner 1 halloween");
 		return;
 	}
 
-	if (isnhdigit(*szArg1))
-		str_to_number(iEnable, szArg1);
-
-	if (isnhdigit(*szArg2))
-		str_to_number(iDropPerKillPct, szArg2);
-
-	if (iEnable != 0)
-	{
-		DWORD dwEndTime = std::time(nullptr) + (60 * 60 * 24 * iEnable);
-		quest::CQuestManager::instance().RequestSetEventFlag("snowflake_stick_event", dwEndTime);
-		quest::CQuestManager::instance().RequestSetEventFlag("snowflake_stick_drop", iDropPerKillPct);
-	}
-	else
-	{
-		quest::CQuestManager::instance().RequestSetEventFlag("snowflake_stick_event", 0);
-	}
-}
-#endif
-
-#if defined(__CHECK_PORT_STATUS__)
-ACMD(do_portstatus)
-{
-	char szArg1[256];
-	one_argument(argument, szArg1, sizeof(szArg1));
-	int iListenPort = 0;
-
-	if (strlen(szArg1) == 0)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, "Usage: portstatus <port>");
-		return;
-	}
+	str_to_number(iEnable, arg1);
 
-	if (isnhdigit(*szArg1))
-	{
-		str_to_number(iListenPort, szArg1);
+	CMiniGameManager::instance().SpawnBanners(iEnable, arg2);
 
-		socket_t socket = socket_connect(g_szPublicIP, static_cast<WORD>(iListenPort));
-		if (socket != INVALID_SOCKET)
-		{
-			socket_close(socket);
-
-			ch->ChatPacket(CHAT_TYPE_INFO, "Port %d is available.", iListenPort);
-		}
-		else
-		{
-			ch->ChatPacket(CHAT_TYPE_INFO, "Port %d is not available.", iListenPort);
-		}
-	}
-	else
-		ch->ChatPacket(CHAT_TYPE_INFO, "Usage: portstatus <channel> <port>");
+	return;
 }
 #endif
 
-ACMD(do_view_equip)
-{
-	char szArg1[256];
-	one_argument(argument, szArg1, sizeof(szArg1));
-
-	if (!*szArg1)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, "Usage: view_equip <character name>");
-		return;
-	}
-
-	LPCHARACTER pTargetChar = CHARACTER_MANAGER::instance().FindPC(szArg1);
-	if (NULL == pTargetChar)
-	{
-		const CCI* pkCCI = P2P_MANAGER::instance().Find(szArg1);
-		if (pkCCI && pkCCI->pkDesc)
-			pTargetChar = pkCCI->pkDesc->GetCharacter();
-		else
-			pTargetChar = NULL;
-	}
-
-	if (pTargetChar && pTargetChar->IsPC())
-		pTargetChar->SendEquipment(ch);
-	else
-		ch->ChatPacket(CHAT_TYPE_INFO, "%s is not online or doesn't exist.", szArg1);
-}
-
-ACMD(do_loglevel)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	unsigned int level = 0;
-	str_to_number(level, arg1);
-
-	char buf[255 + 1];
-	snprintf(buf, sizeof(buf), "LOG LEVEL : %d", level);
-	sys_log(0, buf);
-
-	log_set_level(level);
-}
-
-struct ClearGroundItems
-{
-	void operator () (LPENTITY ent)
-	{
-		if (!ent->IsType(ENTITY_ITEM))
-			return;
-
-		LPITEM item = (LPITEM)ent;
-		if (item) M2_DESTROY_ITEM(item);
-	}
-};
-
-ACMD(do_clear_ground)
-{
-	ClearGroundItems func;
-	LPSECTREE sectree = ch->GetSectree();
-	if (sectree)
-		sectree->ForEachAround(func);
-}
-
-struct whisper_notice_packet_func
-{
-	const char* m_str;
-	whisper_notice_packet_func(const char* str) : m_str(str) {}
-
-	void operator() (LPDESC d)
-	{
-		if (d->GetCharacter() == NULL)
-			return;
-
-		TPacketGCWhisper pack;
-
-		int len = MIN(CHAT_MAX_LEN, strlen(m_str) + 1);
-
-		pack.bHeader = HEADER_GC_WHISPER;
-		pack.wSize = sizeof(TPacketGCWhisper) + len;
-		pack.bType = WHISPER_TYPE_SYSTEM;
-		strlcpy(pack.szNameFrom, "[LC;5452]", sizeof(pack.szNameFrom));
-
-		TEMP_BUFFER buf;
-
-		buf.write(&pack, sizeof(TPacketGCWhisper));
-		buf.write(m_str, len);
-		d->Packet(buf.read_peek(), buf.size());
-	}
-};
-
-void SendWhisperNotice(const char* c_pszBuf)
-{
-	const DESC_MANAGER::DESC_SET& c_ref_set = DESC_MANAGER::instance().GetClientSet();
-	std::for_each(c_ref_set.begin(), c_ref_set.end(), whisper_notice_packet_func(c_pszBuf));
-}
-
-ACMD(do_whisper_notice)
+#if defined(__CONQUEROR_LEVEL__)
+ACMD(do_conqueror_level)
 {
 	char arg1[256];
 	one_argument(argument, arg1, sizeof(arg1));
 
-	SendWhisperNotice(arg1);
-}
-
-#if defined(__SUMMER_EVENT_ROULETTE__)
-ACMD(do_mini_game_roulette)
-{
-	char szArg1[256], szArg2[256];
-	two_arguments(argument, szArg1, sizeof(szArg1), szArg2, sizeof(szArg2));
-	int iEnable = 0, iDropPerKillPct = 100;
-
-	if (strlen(szArg1) == 0)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, "Usage: mini_game_roulette <enable_days> <drop_value>");
-		ch->ChatPacket(CHAT_TYPE_INFO, "       <enable_days> days / 0 (disable);");
-		ch->ChatPacket(CHAT_TYPE_INFO, "       <drop_value> default 100");
-		return;
-	}
-
-	if (isnhdigit(*szArg1))
-		str_to_number(iEnable, szArg1);
-
-	if (isnhdigit(*szArg2))
-		str_to_number(iDropPerKillPct, szArg2);
-
-	if (iEnable > 0)
-	{
-		DWORD dwEndTime = std::time(nullptr) + (60 * 60 * 24 * iEnable);
-
-		quest::CQuestManager::instance().RequestSetEventFlag("e_late_summer", dwEndTime);
-		quest::CQuestManager::instance().RequestSetEventFlag("e_late_summer_drop", iDropPerKillPct);
-
-		BroadcastNotice(LC_STRING("The Altar of Blood has appeared."));
-	}
-	else if (iEnable == 0)
-	{
-		quest::CQuestManager::instance().RequestSetEventFlag("e_late_summer", 0);
-		quest::CQuestManager::instance().RequestSetEventFlag("e_late_summer_drop", 0);
-	}
-}
-#endif
-
-#if defined(__DEFENSE_WAVE__)
-ACMD(do_dw_create)
-{
-	LPDEFENSE_WAVE pDefenseWave = CDefenseWaveManager::Instance().Create(MAP_DEFENSEWAVE);
-	if (pDefenseWave == NULL)
+	if (!*arg1)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, "Cannot create CDefenseWave on OriginalMapIndex %ld", MAP_DEFENSEWAVE);
+		ch->ChatPacket(CHAT_TYPE_INFO, "Syntax: conqueror_level <level>");
 		return;
 	}
 
-	ch->ChatPacket(CHAT_TYPE_INFO, "CDefenseWave Created %u", pDefenseWave->GetId());
-	pDefenseWave->Initialize();
-	pDefenseWave->Enter(ch);
-	pDefenseWave->Start();
-}
-#endif
+	int level = 0;
+	str_to_number(level, arg1);
 
-#ifdef __OFFLINE_SHOP__
-ACMD(do_deleteshop)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
+	ch->PointChange(POINT_CONQUEROR_LEVEL, MINMAX(0, level, gPlayerMaxConquerorLevel) - ch->GetConquerorLevel());
 
-	if (!*arg1)
-		return;
+	ch->SetRealPoint(POINT_SUNGMA_STR, 0);
+	ch->SetPoint(POINT_SUNGMA_STR, ch->GetRealPoint(POINT_SUNGMA_STR));
 
-	DWORD vid = 0;
-	str_to_number(vid, arg1);
+	ch->SetRealPoint(POINT_SUNGMA_HP, 0);
+	ch->SetPoint(POINT_SUNGMA_HP, ch->GetRealPoint(POINT_SUNGMA_HP));
 
-	COfflineShop::GM_CloseShop(ch, vid);
-}
-#endif
+	ch->SetRealPoint(POINT_SUNGMA_MOVE, 0);
+	ch->SetPoint(POINT_SUNGMA_MOVE, ch->GetRealPoint(POINT_SUNGMA_MOVE));
 
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-#include "battlepass_manager.h"
-ACMD(do_battlepass_get_info)
-{
-	if (CBattlePassManager::instance().GetNormalBattlePassID() == 0) 
-		ch->ChatPacket(CHAT_TYPE_INFO, "No normal Battlepass is currently active");
-	else
-	{
-		std::unique_ptr<SQLMsg> pMsgRegistred(DBManager::instance().DirectQuery("SELECT COUNT(*) FROM `battlepass_playerindex` WHERE battlepass_type = 1 and battlepass_id = %d", CBattlePassManager::instance().GetNormalBattlePassID()));
-		std::unique_ptr<SQLMsg> pMsgCompledet(DBManager::instance().DirectQuery("SELECT COUNT(*) FROM `battlepass_playerindex` WHERE battlepass_type = 1 and battlepass_id = %d and battlepass_completed = 1", CBattlePassManager::instance().GetNormalBattlePassID()));
-		if (!pMsgRegistred->uiSQLErrno and !pMsgCompledet->uiSQLErrno)
-		{
-			MYSQL_ROW row_registred = mysql_fetch_row(pMsgRegistred->Get()->pSQLResult);
-			MYSQL_ROW row_compledet = mysql_fetch_row(pMsgCompledet->Get()->pSQLResult);
-			
-			ch->ChatPacket(CHAT_TYPE_INFO, "---------------------------------------------------------------");
-			ch->ChatPacket(CHAT_TYPE_INFO, "Actual Normal Battlepass ID = %d", CBattlePassManager::instance().GetNormalBattlePassID());
-			ch->ChatPacket(CHAT_TYPE_INFO, "Registred Player for Normal Battlepass = %d", std::atoi(row_registred[0]));
-			ch->ChatPacket(CHAT_TYPE_INFO, "Finish Player for Normal Battlepass = %d / %d", std::atoi(row_compledet[0]), std::atoi(row_registred[0]));
-			ch->ChatPacket(CHAT_TYPE_INFO, "---------------------------------------------------------------");
-		}
-	}
-		
-	if (CBattlePassManager::instance().GetPremiumBattlePassID() == 0) 
-		ch->ChatPacket(CHAT_TYPE_INFO, "No premium Battlepass is currently active");
-	else
-	{
-		std::unique_ptr<SQLMsg> pMsgRegistred(DBManager::instance().DirectQuery("SELECT COUNT(*) FROM `battlepass_playerindex` WHERE battlepass_type = 2 and battlepass_id = %d", CBattlePassManager::instance().GetPremiumBattlePassID()));
-		std::unique_ptr<SQLMsg> pMsgCompledet(DBManager::instance().DirectQuery("SELECT COUNT(*) FROM `battlepass_playerindex` WHERE battlepass_type = 2 and battlepass_id = %d and battlepass_completed = 1", CBattlePassManager::instance().GetPremiumBattlePassID()));
-		if (!pMsgRegistred->uiSQLErrno and !pMsgCompledet->uiSQLErrno)
-		{
-			MYSQL_ROW row_registred = mysql_fetch_row(pMsgRegistred->Get()->pSQLResult);
-			MYSQL_ROW row_compledet = mysql_fetch_row(pMsgCompledet->Get()->pSQLResult);
-			
-			ch->ChatPacket(CHAT_TYPE_INFO, "---------------------------------------------------------------");
-			ch->ChatPacket(CHAT_TYPE_INFO, "Actual Premium Battlepass ID = %d", CBattlePassManager::instance().GetPremiumBattlePassID());
-			ch->ChatPacket(CHAT_TYPE_INFO, "Registred Player for Premium Battlepass = %d",  std::atoi(row_registred[0]));
-			ch->ChatPacket(CHAT_TYPE_INFO, "Finish Player for Premium Battlepass = %d / %d", std::atoi(row_compledet[0]), std::atoi(row_registred[0]));
-			ch->ChatPacket(CHAT_TYPE_INFO, "---------------------------------------------------------------");
-		}
-	}
-		
-	if (CBattlePassManager::instance().GetEventBattlePassID() == 0) 
-		ch->ChatPacket(CHAT_TYPE_INFO, "No event Battlepass is currently active");
-	else
-	{
-		std::unique_ptr<SQLMsg> pMsgRegistred(DBManager::instance().DirectQuery("SELECT COUNT(*) FROM `battlepass_playerindex` WHERE battlepass_type = 3 and battlepass_id = %d", CBattlePassManager::instance().GetEventBattlePassID()));
-		std::unique_ptr<SQLMsg> pMsgCompledet(DBManager::instance().DirectQuery("SELECT COUNT(*) FROM `battlepass_playerindex` WHERE battlepass_type = 3 and battlepass_id = %d and battlepass_completed = 1", CBattlePassManager::instance().GetEventBattlePassID()));
-		if (!pMsgRegistred->uiSQLErrno and !pMsgCompledet->uiSQLErrno)
-		{
-			MYSQL_ROW row_registred = mysql_fetch_row(pMsgRegistred->Get()->pSQLResult);
-			MYSQL_ROW row_compledet = mysql_fetch_row(pMsgCompledet->Get()->pSQLResult);
-			
-			ch->ChatPacket(CHAT_TYPE_INFO, "---------------------------------------------------------------");
-			ch->ChatPacket(CHAT_TYPE_INFO, "Actual Event Battlepass ID = %d", CBattlePassManager::instance().GetEventBattlePassID());
-			ch->ChatPacket(CHAT_TYPE_INFO, "Registred Player for Event Battlepass = %d", std::atoi(row_registred[0]));
-			ch->ChatPacket(CHAT_TYPE_INFO, "Finish Player for Event Battlepass = %d / %d", std::atoi(row_compledet[0]), std::atoi(row_registred[0]));
-			ch->ChatPacket(CHAT_TYPE_INFO, "---------------------------------------------------------------");
-		}
-	}
-}
+	ch->SetRealPoint(POINT_SUNGMA_IMMUNE, 0);
+	ch->SetPoint(POINT_SUNGMA_IMMUNE, ch->GetRealPoint(POINT_SUNGMA_IMMUNE));
 
-ACMD(do_battlepass_set_mission)
-{
-	char arg1[256], arg2[256], arg3[256], arg4[256];
-	four_arguments(argument, arg1, sizeof(arg1), arg2, sizeof(arg2), arg3, sizeof(arg3), arg4, sizeof(arg4));
-	
-	if (!*arg1 || !*arg2 || !*arg3)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, "Syntax: battlepass_set_mission <battlepass_type> <mission_index> <value> (<playername>)");
-		ch->ChatPacket(CHAT_TYPE_INFO, "battlepass_type: 1 = NORMAL | 2 = PREMIUM | 3 = EVENT");
-		ch->ChatPacket(CHAT_TYPE_INFO, "mission_index: mission index means the number of the mission counted from the top starting with 1");
-		ch->ChatPacket(CHAT_TYPE_INFO, "value: input the value what you will override");
-		return;
-	}
-	
-	int battlepass_type, mission_index, value;
-	str_to_number(battlepass_type, arg1);
-	str_to_number(mission_index, arg2);
-	str_to_number(value, arg3);
-	
-	value = MAX(0, value);
-	
-	if (battlepass_type == 1 and CBattlePassManager::instance().GetNormalBattlePassID() == 0) {
-		ch->ChatPacket(CHAT_TYPE_INFO, "No normal Battlepass is currently active");
-		return;
-	}
-	if (battlepass_type == 2 and CBattlePassManager::instance().GetPremiumBattlePassID() == 0) {
-		ch->ChatPacket(CHAT_TYPE_INFO, "No premium Battlepass is currently active");
-		return;
-	}
-	if (battlepass_type == 3 and CBattlePassManager::instance().GetEventBattlePassID() == 0) {
-		ch->ChatPacket(CHAT_TYPE_INFO, "No event Battlepass is currently active");
-		return;
-	}
-	
-	LPCHARACTER tch;
-	
-	if (*arg4 && ch->GetName() != arg4)
-		tch = CHARACTER_MANAGER::instance().FindPC(arg4);
-	else
-		tch = CHARACTER_MANAGER::instance().FindPC(ch->GetName());
+	ch->PointChange(POINT_CONQUEROR_POINT, (MINMAX(0, level, gPlayerMaxLevelStats) * 1) + ch->GetPoint(POINT_CONQUEROR_LEVEL_STEP) - ch->GetPoint(POINT_CONQUEROR_POINT));
 
-	if (!tch) {
-		ch->ChatPacket(CHAT_TYPE_INFO, "This player is not online or does not exist.");
-		return;
-	}
-	if (battlepass_type == 2 and CBattlePassManager::instance().GetPremiumBattlePassID() != tch->GetExtBattlePassPremiumID()) {
-		ch->ChatPacket(CHAT_TYPE_INFO, "This player does not have access to the current Premium Battle Pass.");
-		return;
-	}
-	DWORD mission_type = CBattlePassManager::instance().GetMissionTypeByIndex(battlepass_type, mission_index);
-	if (mission_type == 0){
-		ch->ChatPacket(CHAT_TYPE_INFO, "There is no mission index %d in battlepass-typ %d", mission_index, battlepass_type);
-		return;
-	}
-	
-	tch->SetExtBattlePassMissionProgress(battlepass_type, mission_index, mission_type, value);
-}
+	ch->SetConquerorExp(0);
 
-ACMD(do_battlepass_premium_activate)
-{
-	char arg1[256], arg2[256];
-	two_arguments(argument, arg1, sizeof(arg1), arg2, sizeof(arg2));
+	ch->ComputePoints();
+	ch->PointsPacket();
+	ch->UpdatePointsPacket(POINT_CONQUEROR_EXP, ch->GetConquerorExp());
 
-	int value;
-	str_to_number(value, arg2);
-	
-	if (!*arg1 || !*arg2 || value > 1)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, "Syntax: battlepass_premium_activate <playername> <activate = 1 / deactivate = 0>");
-		return;
-	}
-	
-	if (CBattlePassManager::instance().GetPremiumBattlePassID() == 0) {
-		ch->ChatPacket(CHAT_TYPE_INFO, "No premium Battlepass is currently active");
-		return;
-	}
-		
-	if (ch->GetName() != arg1) {
-		LPCHARACTER tch = CHARACTER_MANAGER::instance().FindPC(arg1);
-		if (!tch)
-		{
-			ch->ChatPacket(CHAT_TYPE_INFO, "This player is not online or does not exist.");
-			return;
-		}	
-			
-		if (value == 1)
-		{
-			tch->PointChange(POINT_BATTLE_PASS_PREMIUM_ID, CBattlePassManager::instance().GetPremiumBattlePassID());
-			CBattlePassManager::instance().BattlePassRequestOpen(tch, false);
-			tch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("BATTLEPASS_NOW_IS_ACTIVATED_PREMIUM_BATTLEPASS"));
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("BATTLEPASS_CMDGM_ACTIVATE_PREMIUM_TO_PLAYER"), tch->GetName());
-		}
-		if (value == 0)
-		{
-			tch->PointChange(POINT_BATTLE_PASS_PREMIUM_ID, 0);
-			tch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("BATTLEPASS_CMDGM_DEACTIVATE_PREMIUM_PLAYER"));
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("BATTLEPASS_CMDGM_DEACTIVATE_PREMIUM_TO_PLAYER"), tch->GetName());
-		}
-	}
-	else
-	{
-		if (value == 1)
-		{
-			ch->PointChange(POINT_BATTLE_PASS_PREMIUM_ID, CBattlePassManager::instance().GetPremiumBattlePassID());
-			CBattlePassManager::instance().BattlePassRequestOpen(ch, false);
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("BATTLEPASS_NOW_IS_ACTIVATED_PREMIUM_BATTLEPASS_OWN"));
-		}
-		if (value == 0)
-		{
-			ch->PointChange(POINT_BATTLE_PASS_PREMIUM_ID, 0);
-			CBattlePassManager::instance().BattlePassRequestOpen(ch, false);
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("BATTLEPASS_CMDGM_DEACTIVATE_PREMIUM_OWN"));
-		}
-	}
+	LogManager::instance().CharLog(ch, 0, "GM_RESET_CONQUEROR", "");
 }
 #endif
-
 #ifdef __GROWTH_PET_SYSTEM__
 #include "growth_pet.h"
 
@@ -6226,7 +5614,6 @@
 	"itemevo",
 	"time",
 	"age",
-	"maxtime",
 	"\n",
 };
 
@@ -6246,7 +5633,7 @@
 
 	if(!ch->GetActiveGrowthPet())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ONCE_PETI_CAGIR"));
+		ch->ChatPacket(CHAT_TYPE_INFO, "You need to summon your pet first.");
 		return;
 	}
 
@@ -6362,18 +5749,6 @@
 			ch->GetActiveGrowthPet()->ChangePetPoint(POINT_UPBRINGING_BIRTHDAY, dwAge, true);
 		}
 		break;
-		
-		case 11: // Max Time life
-		{
-			int max_time = 0;
-			str_to_number(max_time, arg2);
-			// DWORD maxTime = time(0) - (age * 3600 * 24);
-			// ch->GetActiveGrowthPet()->ChangePetPoint(POINT_UPBRINGING_BIRTHDAY, dwAge, true);
-			ch->ChatPacket(CHAT_TYPE_INFO, "OLD_Cur pet max life = %d", ch->GetActiveGrowthPet()->GetPetPoint(POINT_UPBRINGING_MAX_DURATION));
-			ch->GetActiveGrowthPet()->ChangePetPoint(POINT_UPBRINGING_MAX_DURATION, max_time, true);
-			ch->ChatPacket(CHAT_TYPE_INFO, "NEW_Cur pet max life = %d", ch->GetActiveGrowthPet()->GetPetPoint(POINT_UPBRINGING_MAX_DURATION));
-		}
-		break;
 	}
 }
 #endif
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/constants.cpp final/server/server/home/metin2/Source/Server/game/src/constants.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/constants.cpp	2025-06-28 20:33:40.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/constants.cpp	2026-02-20 18:05:02.406217160 +0000
@@ -1,6 +1,41 @@
 #include "stdafx.h"
 #include "char.h"
 
+#ifdef __AURA_SYSTEM__
+int s_aiAuraRefineInfo[AURA_GRADE_MAX_NUM][AURA_REFINE_INFO_MAX] = {
+//  [ Grade | LevelMin | LevelMax | NeedEXP | EvolMaterial | EvolMaterialCount | EvolCost | EvolPCT ]
+	{1,   1,  49,  1000, 30617, 10,  5000000, 100},
+	{2,  50,  99,  2000, 31136, 10,  5000000, 100},
+	{3, 100, 149,  4000, 31137, 10,  5000000, 100},
+	{4, 150, 199,  8000, 31138, 10,  8000000, 100},
+	{5, 200, 249, 16000, 31138, 20, 10000000, 100},
+	{6, 250, 250,     0,     0,  0,        0,   0},
+	{0,   0,   0,     0,     0,  0,        0,   0}
+};
+
+int* GetAuraRefineInfo(BYTE bLevel)
+{
+	if (bLevel > 250)
+		return NULL;
+
+	for (int i = 0; i < AURA_GRADE_MAX_NUM; ++i)
+	{
+		if (bLevel >= s_aiAuraRefineInfo[i][AURA_REFINE_INFO_LEVEL_MIN] && bLevel <= s_aiAuraRefineInfo[i][AURA_REFINE_INFO_LEVEL_MAX])
+			return s_aiAuraRefineInfo[i];
+	}
+
+	return NULL;
+}
+
+int GetAuraRefineInfo(BYTE bGrade, BYTE bInfo)
+{
+	if (bGrade >= AURA_GRADE_MAX_NUM || bInfo >= AURA_REFINE_INFO_MAX)
+		return 0;
+
+	return s_aiAuraRefineInfo[bGrade - 1][bInfo];
+}
+#endif
+
 #ifdef __GROWTH_PET_SYSTEM__
 const TPetEvolution arPetEvolutionTable[3] =
 {
@@ -43,7 +78,7 @@
 			{30083, 10}, // Unknown Medicine+
 			{27992, 2},  // White Pearl
 			{27993, 2},  // Blue Pearl
-			{30086, 10}, // Demon?s Keepsake+
+			{30086, 10}, // Demons Keepsake+
 			{30077, 10}, // Orc Tooth+
 			{30550, 5},  // Blue Belt
 		}
@@ -115,14 +150,25 @@
 	int stamina_per_lv_begin, stamina_per_lv_end;
 }
 */
+#if defined(__RANDOM_STATUS_PER_LEVEL__)
+{ // Random HP & SP
+	// str con dex int ʱHP ʱSP CON/HP INT/SP HP/lv MP/lv ʱstam stam/con stam/lv
+	{ 6, 4, 3, 3, 600, 200, 40, 20, 36, 44, 18, 22, 800, 5, 1, 3 }, // JOB_WARRIOR 16
+	{ 4, 3, 6, 3, 650, 200, 40, 20, 36, 44, 18, 22, 800, 5, 1, 3 }, // JOB_ASSASSIN 16
+	{ 5, 3, 3, 5, 650, 200, 40, 20, 36, 44, 18, 22, 800, 5, 1, 3 }, // JOB_SURA 16
+	{ 3, 4, 3, 6, 700, 200, 40, 20, 36, 44, 18, 22, 800, 5, 1, 3 }, // JOB_SHAMAN 16
+	{ 2, 6, 6, 2, 600, 200, 40, 20, 36, 44, 18, 22, 800, 5, 1, 3 }, // JOB_WOLFMAN 16
+};
+#else
 {
-	//	str	con	dex	int	ʱHP	ʱSP	CON/HP	INT/SP	HP/lv	MP/lv	ʱstam	stam/con	stam/lv
-	{	 6,	4,	3,	3,	600,	200,	40,		20,		36,	44,		18,	22,		800,		5,			1,	3 }, // JOB_WARRIOR 16
-	{	 4,	3,	6,	3,	650,	200,	40,		20,		36,	44,		18,	22,		800,		5,			1,	3 }, // JOB_ASSASSIN 16
-	{	 5,	3,	3,	5,	650,	200,	40,		20,		36,	44,		18,	22,		800,		5,			1,	3 }, // JOB_SURA 16
-	{	 3,	4,	3,	6,	700,	200,	40,		20,		36,	44,		18,	22,		800,		5,			1,	3 }, // JOB_SHAMAN 16
-	{	 2,	6,	6,	2,	600,	200,	40,		20,		36,	44,		18,	22,		800,		5,			1,	3 }, // JOB_WOLFMAN 16
+	// str con dex int ʱHP ʱSP CON/HP INT/SP HP/lv MP/lv ʱstam stam/con stam/lv
+	{ 6, 4, 3, 3, 600, 200, 40, 20, 0, 0, 0, 0, 800, 5, 1, 3 }, // JOB_WARRIOR 16
+	{ 4, 3, 6, 3, 650, 200, 40, 20, 0, 0, 0, 0, 800, 5, 1, 3 }, // JOB_ASSASSIN 16
+	{ 5, 3, 3, 5, 650, 200, 40, 20, 0, 0, 0, 0, 800, 5, 1, 3 }, // JOB_SURA 16
+	{ 3, 4, 3, 6, 700, 200, 40, 20, 0, 0, 0, 0, 800, 5, 1, 3 }, // JOB_SHAMAN 16
+	{ 2, 6, 6, 2, 600, 200, 40, 20, 0, 0, 0, 0, 800, 5, 1, 3 }, // JOB_WOLFMAN 16
 };
+#endif
 
 const TMobRankStat MobRankStats[MOB_RANK_MAX_NUM] =
 /*
@@ -160,6 +206,7 @@
 };
 
 const DWORD* exp_table = NULL;
+
 const DWORD exp_table_common[PLAYER_EXP_TABLE_MAX + 1] =
 {
 	0, // 0
@@ -285,44 +332,6 @@
 	2790000000, // 120
 };
 
-#if defined(__CONQUEROR_LEVEL__)
-const DWORD* conqueror_exp_table = NULL;
-const DWORD conqueror_exp_table_common[PLAYER_CONQUEROR_EXP_TABLE_MAX + 1] =
-{
-	0, // 0
-	433400,
-	1300204,
-	2600413,
-	4334029,
-	6501054,
-	9101490,
-	12135339,
-	15602603,
-	19503284,
-	23837384, // 10
-	28604905,
-	33805849,
-	39440218,
-	45508014,
-	52009239,
-	58943895,
-	66311984,
-	74113508,
-	82348469,
-	91016869, // 20
-	100118710,
-	109653994,
-	119622723,
-	130024899,
-	140860524,
-	152129600,
-	163832129,
-	175968113,
-	188537554,
-	188537554, // 30
-};
-#endif
-
 const int* aiPercentByDeltaLev = NULL;
 const int* aiPercentByDeltaLevForBoss = NULL;
 
@@ -640,12 +649,11 @@
 	APPLY_STUN_PCT,
 	APPLY_CRITICAL_PCT,
 	APPLY_PENETRATE_PCT,
+	APPLY_BLEEDING_PCT,
 };
 
 const int aiMobResistsApplyIdx[MOB_RESISTS_MAX_NUM] =
 {
-	APPLY_RESIST_FIST,
-
 	APPLY_RESIST_SWORD,
 	APPLY_RESIST_TWOHAND,
 	APPLY_RESIST_DAGGER,
@@ -653,28 +661,14 @@
 	APPLY_RESIST_FAN,
 	APPLY_RESIST_BOW,
 	APPLY_RESIST_CLAW,
-
 	APPLY_RESIST_FIRE,
 	APPLY_RESIST_ELEC,
 	APPLY_RESIST_MAGIC,
 	APPLY_RESIST_WIND,
-
 	APPLY_POISON_REDUCE,
 	APPLY_BLEEDING_REDUCE,
 };
 
-#if defined(__ELEMENT_SYSTEM__)
-const int aiMobElementsApplyIdx[MOB_ELEMENT_MAX_NUM] =
-{
-	APPLY_ENCHANT_ELECT,
-	APPLY_ENCHANT_FIRE,
-	APPLY_ENCHANT_ICE,
-	APPLY_ENCHANT_WIND,
-	APPLY_ENCHANT_EARTH,
-	APPLY_ENCHANT_DARK
-};
-#endif
-
 const int aiSocketPercentByQty[5][4] =
 {
 	{ 0, 0, 0, 0 },
@@ -686,17 +680,24 @@
 
 const int aiWeaponSocketQty[WEAPON_NUM_TYPES] =
 {
+#if defined(__ITEM_SOCKET5__)
+	5, // WEAPON_SWORD,
+	5, // WEAPON_DAGGER,
+	5, // WEAPON_BOW,
+	5, // WEAPON_TWO_HANDED,
+	5, // WEAPON_BELL,
+	5, // WEAPON_FAN,
+#else
 	3, // WEAPON_SWORD,
 	3, // WEAPON_DAGGER,
 	3, // WEAPON_BOW,
 	3, // WEAPON_TWO_HANDED,
 	3, // WEAPON_BELL,
 	3, // WEAPON_FAN,
+#endif
 	0, // WEAPON_ARROW,
 	0, // WEAPON_MOUNT_SPEAR
-#if defined(__WOLFMAN_CHARACTER__)
 	3, // WEAPON_CLAW
-#endif
 #if defined(__QUIVER_SYSTEM__)
 	0, // WEAPON_QUIVER,
 #endif
@@ -704,7 +705,11 @@
 
 const int aiArmorSocketQty[ARMOR_NUM_TYPES] =
 {
+#if defined(__ITEM_SOCKET5__)
+	5, // ARMOR_BODY,
+#else
 	3, // ARMOR_BODY,
+#endif
 	1, // ARMOR_HEAD,
 	1, // ARMOR_SHIELD,
 	0, // ARMOR_WRIST,
@@ -712,388 +717,157 @@
 	0 // ARMOR_ACCESSORY
 };
 
-#if defined(__AURA_COSTUME_SYSTEM__)
-const int s_aiAuraRefineTable[AURA_GRADE_MAX_NUM][AURA_REFINE_INFO_MAX] = {
-	// Grade					MinLevel	MaxLevel		Exp		MaterialVnum	MaterialCount	Cost		Pct
-	{ AURA_GRADE_ORDINARY,		1,			49,				1000,	30617,			10,				5000000,	100 },
-	{ AURA_GRADE_SIMPLE,		50,			99,				2000,	31136,			10,				5000000,	100 },
-	{ AURA_GRADE_NOBLE,			100,		149,			4000,	31137,			10,				5000000,	100 },
-	{ AURA_GRADE_SPARKLING,		150,		199,			8000,	31138,			10,				8000000,	100 },
-	{ AURA_GRADE_MAGNIFICENT,	200,		249,			16000,	31138,			20,				10000000,	100 },
-	{ AURA_GRADE_RADIANT,		250,		250,			0,		0,				0,				0,			0 },
-	{ AURA_GRADE_NONE,			0,			0,				0,		0,				0,				0,			0 }
-};
-
-const int* GetAuraRefineInfo(BYTE bLevel)
-{
-	if (bLevel > AURA_MAX_LEVEL)
-		return NULL;
-
-	for (int i = 0; i < AURA_GRADE_MAX_NUM; ++i)
-	{
-		if (bLevel >= s_aiAuraRefineTable[i][AURA_REFINE_INFO_LEVEL_MIN] && bLevel <= s_aiAuraRefineTable[i][AURA_REFINE_INFO_LEVEL_MAX])
-			return s_aiAuraRefineTable[i];
-	}
-
-	return NULL;
-}
-
-const int GetAuraRefineInfo(BYTE bGrade, BYTE bInfo)
-{
-	if (bGrade >= AURA_GRADE_MAX_NUM || bInfo >= AURA_REFINE_INFO_MAX)
-		return 0;
-
-	return s_aiAuraRefineTable[bGrade - 1][bInfo];
-}
-#endif
-
 TItemAttrMap g_map_itemAttr;
 TItemAttrMap g_map_itemRare;
 
 const TApplyInfo aApplyInfo[MAX_APPLY_NUM] =
 /*
 {
-	POINT_TYPE wApplyType;
-	POINT_TYPE wPointType;
+	DWORD dwPointType;
 }
 */
 {
-	{ APPLY_NONE, POINT_NONE, },
-	{ APPLY_MAX_HP, POINT_MAX_HP, },
-	{ APPLY_MAX_SP, POINT_MAX_SP, },
-	{ APPLY_CON, POINT_HT, },
-	{ APPLY_INT, POINT_IQ, },
-	{ APPLY_STR, POINT_ST, },
-	{ APPLY_DEX, POINT_DX, },
-	{ APPLY_ATT_SPEED, POINT_ATT_SPEED, },
-	{ APPLY_MOV_SPEED, POINT_MOV_SPEED, },
-	{ APPLY_CAST_SPEED, POINT_CASTING_SPEED, },
-	{ APPLY_HP_REGEN, POINT_HP_REGEN, },
-	{ APPLY_SP_REGEN, POINT_SP_REGEN, },
-	{ APPLY_POISON_PCT, POINT_POISON_PCT, },
-	{ APPLY_STUN_PCT, POINT_STUN_PCT, },
-	{ APPLY_SLOW_PCT, POINT_SLOW_PCT, },
-	{ APPLY_CRITICAL_PCT, POINT_CRITICAL_PCT, },
-	{ APPLY_PENETRATE_PCT, POINT_PENETRATE_PCT, },
-	{ APPLY_ATTBONUS_HUMAN, POINT_ATTBONUS_HUMAN, },
-	{ APPLY_ATTBONUS_ANIMAL, POINT_ATTBONUS_ANIMAL, },
-	{ APPLY_ATTBONUS_ORC, POINT_ATTBONUS_ORC, },
-	{ APPLY_ATTBONUS_MILGYO, POINT_ATTBONUS_MILGYO, },
-	{ APPLY_ATTBONUS_UNDEAD, POINT_ATTBONUS_UNDEAD, },
-	{ APPLY_ATTBONUS_DEVIL, POINT_ATTBONUS_DEVIL, },
-	{ APPLY_STEAL_HP, POINT_STEAL_HP, },
-	{ APPLY_STEAL_SP, POINT_STEAL_SP, },
-	{ APPLY_MANA_BURN_PCT, POINT_MANA_BURN_PCT, },
-	{ APPLY_DAMAGE_SP_RECOVER, POINT_DAMAGE_SP_RECOVER, },
-	{ APPLY_BLOCK, POINT_BLOCK, },
-	{ APPLY_DODGE, POINT_DODGE, },
-	{ APPLY_RESIST_SWORD, POINT_RESIST_SWORD, },
-	{ APPLY_RESIST_TWOHAND, POINT_RESIST_TWOHAND, },
-	{ APPLY_RESIST_DAGGER, POINT_RESIST_DAGGER, },
-	{ APPLY_RESIST_BELL, POINT_RESIST_BELL, },
-	{ APPLY_RESIST_FAN, POINT_RESIST_FAN, },
-	{ APPLY_RESIST_BOW, POINT_RESIST_BOW, },
-	{ APPLY_RESIST_FIRE, POINT_RESIST_FIRE, },
-	{ APPLY_RESIST_ELEC, POINT_RESIST_ELEC, },
-	{ APPLY_RESIST_MAGIC, POINT_RESIST_MAGIC, },
-	{ APPLY_RESIST_WIND, POINT_RESIST_WIND, },
-	{ APPLY_REFLECT_MELEE, POINT_REFLECT_MELEE, },
-	{ APPLY_REFLECT_CURSE, POINT_REFLECT_CURSE, },
-	{ APPLY_POISON_REDUCE, POINT_POISON_REDUCE, },
-	{ APPLY_KILL_SP_RECOVER, POINT_KILL_SP_RECOVER, },
-	{ APPLY_EXP_DOUBLE_BONUS, POINT_EXP_DOUBLE_BONUS, },
-	{ APPLY_GOLD_DOUBLE_BONUS, POINT_GOLD_DOUBLE_BONUS, },
-	{ APPLY_ITEM_DROP_BONUS, POINT_ITEM_DROP_BONUS, },
-	{ APPLY_POTION_BONUS, POINT_POTION_BONUS, },
-	{ APPLY_KILL_HP_RECOVER, POINT_KILL_HP_RECOVERY, },
-	{ APPLY_IMMUNE_STUN, POINT_IMMUNE_STUN, },
-	{ APPLY_IMMUNE_SLOW, POINT_IMMUNE_SLOW, },
-	{ APPLY_IMMUNE_FALL, POINT_IMMUNE_FALL, },
-	{ APPLY_SKILL, POINT_NONE, },
-	{ APPLY_BOW_DISTANCE, POINT_BOW_DISTANCE, },
-	{ APPLY_ATT_GRADE_BONUS, POINT_ATT_GRADE_BONUS, },
-	{ APPLY_DEF_GRADE_BONUS, POINT_DEF_GRADE_BONUS, },
-	{ APPLY_MAGIC_ATT_GRADE, POINT_MAGIC_ATT_GRADE_BONUS, },
-	{ APPLY_MAGIC_DEF_GRADE, POINT_MAGIC_DEF_GRADE_BONUS, },
-	{ APPLY_CURSE_PCT, POINT_CURSE_PCT, },
-	{ APPLY_MAX_STAMINA, POINT_MAX_STAMINA, },
-	{ APPLY_ATTBONUS_WARRIOR, POINT_ATTBONUS_WARRIOR, },
-	{ APPLY_ATTBONUS_ASSASSIN, POINT_ATTBONUS_ASSASSIN, },
-	{ APPLY_ATTBONUS_SURA, POINT_ATTBONUS_SURA, },
-	{ APPLY_ATTBONUS_SHAMAN, POINT_ATTBONUS_SHAMAN, },
-	{ APPLY_ATTBONUS_MONSTER, POINT_ATTBONUS_MONSTER, },
-	{ APPLY_MALL_ATTBONUS, POINT_ATT_BONUS, },
-	{ APPLY_MALL_DEFBONUS, POINT_MALL_DEFBONUS, },
-	{ APPLY_MALL_EXPBONUS, POINT_MALL_EXPBONUS, },
-	{ APPLY_MALL_ITEMBONUS, POINT_MALL_ITEMBONUS, },
-	{ APPLY_MALL_GOLDBONUS, POINT_MALL_GOLDBONUS, },
-	{ APPLY_MAX_HP_PCT, POINT_MAX_HP_PCT, },
-	{ APPLY_MAX_SP_PCT, POINT_MAX_SP_PCT, },
-	{ APPLY_SKILL_DAMAGE_BONUS, POINT_SKILL_DAMAGE_BONUS, },
-	{ APPLY_NORMAL_HIT_DAMAGE_BONUS, POINT_NORMAL_HIT_DAMAGE_BONUS, },
-
-	{ APPLY_SKILL_DEFEND_BONUS, POINT_SKILL_DEFEND_BONUS, },
-	{ APPLY_NORMAL_HIT_DEFEND_BONUS, POINT_NORMAL_HIT_DEFEND_BONUS, },
-
-	{ APPLY_PC_BANG_EXP_BONUS, POINT_PC_BANG_EXP_BONUS, },
-	{ APPLY_PC_BANG_DROP_BONUS, POINT_PC_BANG_DROP_BONUS, },
-
-	{ APPLY_EXTRACT_HP_PCT, POINT_NONE, },
-
-	{ APPLY_RESIST_WARRIOR, POINT_RESIST_WARRIOR, },
-	{ APPLY_RESIST_ASSASSIN, POINT_RESIST_ASSASSIN, },
-	{ APPLY_RESIST_SURA, POINT_RESIST_SURA, },
-	{ APPLY_RESIST_SHAMAN, POINT_RESIST_SHAMAN, },
-	{ APPLY_ENERGY, POINT_ENERGY, },
-	{ APPLY_DEF_GRADE, POINT_DEF_GRADE, },
-	{ APPLY_COSTUME_ATTR_BONUS, POINT_COSTUME_ATTR_BONUS, },
-	{ APPLY_MAGIC_ATTBONUS_PER, POINT_MAGIC_ATT_BONUS_PER, },
-	{ APPLY_MELEE_MAGIC_ATTBONUS_PER, POINT_MELEE_MAGIC_ATT_BONUS_PER, },
-
-	{ APPLY_RESIST_ICE, POINT_RESIST_ICE, },
-	{ APPLY_RESIST_EARTH, POINT_RESIST_EARTH, },
-	{ APPLY_RESIST_DARK, POINT_RESIST_DARK, },
-
-	{ APPLY_ANTI_CRITICAL_PCT, POINT_RESIST_CRITICAL, },
-	{ APPLY_ANTI_PENETRATE_PCT, POINT_RESIST_PENETRATE, },
-
-	{ APPLY_BLEEDING_REDUCE, POINT_BLEEDING_REDUCE, },
-	{ APPLY_BLEEDING_PCT, POINT_BLEEDING_PCT, },
-	{ APPLY_ATTBONUS_WOLFMAN, POINT_ATTBONUS_WOLFMAN, },
-	{ APPLY_RESIST_WOLFMAN, POINT_RESIST_WOLFMAN, },
-	{ APPLY_RESIST_CLAW, POINT_RESIST_CLAW, },
+	// Point Type
+	{ POINT_NONE, },						// APPLY_NONE,						// 0
+	{ POINT_MAX_HP, },						// APPLY_MAX_HP,					// 1
+	{ POINT_MAX_SP, },						// APPLY_MAX_SP,					// 2
+	{ POINT_HT, },							// APPLY_CON,						// 3
+	{ POINT_IQ, },							// APPLY_INT,						// 4
+	{ POINT_ST, },							// APPLY_STR,						// 5
+	{ POINT_DX, },							// APPLY_DEX,						// 6
+	{ POINT_ATT_SPEED, },					// APPLY_ATT_SPEED,					// 7
+	{ POINT_MOV_SPEED, },					// APPLY_MOV_SPEED,					// 8
+	{ POINT_CASTING_SPEED, },				// APPLY_CAST_SPEED,				// 9
+	{ POINT_HP_REGEN, },					// APPLY_HP_REGEN,					// 10
+	{ POINT_SP_REGEN, },					// APPLY_SP_REGEN,					// 11
+	{ POINT_POISON_PCT, },					// APPLY_POISON_PCT,				// 12
+	{ POINT_STUN_PCT, },					// APPLY_STUN_PCT,					// 13
+	{ POINT_SLOW_PCT, },					// APPLY_SLOW_PCT,					// 14
+	{ POINT_CRITICAL_PCT, },				// APPLY_CRITICAL_PCT,				// 15
+	{ POINT_PENETRATE_PCT, },				// APPLY_PENETRATE_PCT,				// 16
+	{ POINT_ATTBONUS_HUMAN, },				// APPLY_ATTBONUS_HUMAN,			// 17
+	{ POINT_ATTBONUS_ANIMAL, },				// APPLY_ATTBONUS_ANIMAL,			// 18
+	{ POINT_ATTBONUS_ORC,},					// APPLY_ATTBONUS_ORC,				// 19
+	{ POINT_ATTBONUS_MILGYO, },				// APPLY_ATTBONUS_MILGYO,			// 20
+	{ POINT_ATTBONUS_UNDEAD, },				// APPLY_ATTBONUS_UNDEAD,			// 21
+	{ POINT_ATTBONUS_DEVIL, },				// APPLY_ATTBONUS_DEVIL,			// 22
+	{ POINT_STEAL_HP, },					// APPLY_STEAL_HP,					// 23
+	{ POINT_STEAL_SP, },					// APPLY_STEAL_SP,					// 24
+	{ POINT_MANA_BURN_PCT, },				// APPLY_MANA_BURN_PCT,				// 25
+	{ POINT_DAMAGE_SP_RECOVER, },			// APPLY_DAMAGE_SP_RECOVER,			// 26
+	{ POINT_BLOCK, },						// APPLY_BLOCK,						// 27
+	{ POINT_DODGE, },						// APPLY_DODGE,						// 28
+	{ POINT_RESIST_SWORD, },				// APPLY_RESIST_SWORD,				// 29
+	{ POINT_RESIST_TWOHAND, },				// APPLY_RESIST_TWOHAND,			// 30
+	{ POINT_RESIST_DAGGER, },				// APPLY_RESIST_DAGGER,				// 31
+	{ POINT_RESIST_BELL, },					// APPLY_RESIST_BELL,				// 32
+	{ POINT_RESIST_FAN, },					// APPLY_RESIST_FAN,				// 33
+	{ POINT_RESIST_BOW, },					// APPLY_RESIST_BOW,				// 34
+	{ POINT_RESIST_FIRE, },					// APPLY_RESIST_FIRE,				// 35
+	{ POINT_RESIST_ELEC, },					// APPLY_RESIST_ELEC,				// 36
+	{ POINT_RESIST_MAGIC, },				// APPLY_RESIST_MAGIC,				// 37
+	{ POINT_RESIST_WIND, },					// APPLY_RESIST_WIND,				// 38
+	{ POINT_REFLECT_MELEE, },				// APPLY_REFLECT_MELEE,				// 39
+	{ POINT_REFLECT_CURSE, },				// APPLY_REFLECT_CURSE,				// 40
+	{ POINT_POISON_REDUCE, },				// APPLY_POISON_REDUCE,				// 41
+	{ POINT_KILL_SP_RECOVER, },				// APPLY_KILL_SP_RECOVER,			// 42
+	{ POINT_EXP_DOUBLE_BONUS, },			// APPLY_EXP_DOUBLE_BONUS,			// 43
+	{ POINT_GOLD_DOUBLE_BONUS, },			// APPLY_GOLD_DOUBLE_BONUS,			// 44
+	{ POINT_ITEM_DROP_BONUS, },				// APPLY_ITEM_DROP_BONUS,			// 45
+	{ POINT_POTION_BONUS, },				// APPLY_POTION_BONUS,				// 46
+	{ POINT_KILL_HP_RECOVERY, },			// APPLY_KILL_HP_RECOVER,			// 47
+	{ POINT_IMMUNE_STUN, },					// APPLY_IMMUNE_STUN,				// 48
+	{ POINT_IMMUNE_SLOW, },					// APPLY_IMMUNE_SLOW,				// 49
+	{ POINT_IMMUNE_FALL, },					// APPLY_IMMUNE_FALL,				// 50
+	{ POINT_NONE, },						// APPLY_SKILL,						// 51
+	{ POINT_BOW_DISTANCE, },				// APPLY_BOW_DISTANCE,				// 52
+	{ POINT_ATT_GRADE_BONUS, },				// APPLY_ATT_GRADE,					// 53
+	{ POINT_DEF_GRADE_BONUS, },				// APPLY_DEF_GRADE,					// 54
+	{ POINT_MAGIC_ATT_GRADE_BONUS, },		// APPLY_MAGIC_ATT_GRADE,			// 55
+	{ POINT_MAGIC_DEF_GRADE_BONUS, },		// APPLY_MAGIC_DEF_GRADE,			// 56
+	{ POINT_CURSE_PCT, },					// APPLY_CURSE_PCT,					// 57
+	{ POINT_MAX_STAMINA, },					// APPLY_MAX_STAMINA,				// 58
+	{ POINT_ATTBONUS_WARRIOR, },			// APPLY_ATTBONUS_WARRIOR,			// 59
+	{ POINT_ATTBONUS_ASSASSIN, },			// APPLY_ATTBONUS_ASSASSIN,			// 60
+	{ POINT_ATTBONUS_SURA, },				// APPLY_ATTBONUS_SURA,				// 61
+	{ POINT_ATTBONUS_SHAMAN, },				// APPLY_ATTBONUS_SHAMAN,			// 62
+	{ POINT_ATTBONUS_MONSTER, },			// APPLY_ATTBONUS_MONSTER,			// 63
+	{ POINT_ATT_BONUS, },					// APPLY_MALL_ATTBONUS,				// 64 ݷ +x%
+	{ POINT_MALL_DEFBONUS, },				// APPLY_MALL_DEFBONUS,				// 65  +x%
+	{ POINT_MALL_EXPBONUS, },				// APPLY_MALL_EXPBONUS,				// 66 ġ +x%
+	{ POINT_MALL_ITEMBONUS, },				// APPLY_MALL_ITEMBONUS,			// 67   x/10
+	{ POINT_MALL_GOLDBONUS, },				// APPLY_MALL_GOLDBONUS,			// 68   x/10
+	{ POINT_MAX_HP_PCT, },					// APPLY_MAX_HP_PCT,				// 69 ִ  +x%
+	{ POINT_MAX_SP_PCT, },					// APPLY_MAX_SP_PCT,				// 70 ִ ŷ +x%
+	{ POINT_SKILL_DAMAGE_BONUS, },			// APPLY_SKILL_DAMAGE_BONUS,		// 71 ų  * (100+x)%
+	{ POINT_NORMAL_HIT_DAMAGE_BONUS, },		// APPLY_NORMAL_HIT_DAMAGE_BONUS,	// 72 Ÿ  * (100+x)%
+
+	// DEFEND_BONUS_ATTRIBUTES
+	{ POINT_SKILL_DEFEND_BONUS, },			// APPLY_SKILL_DEFEND_BONUS,		// 73 ų   * (100-x)%
+	{ POINT_NORMAL_HIT_DEFEND_BONUS, },		// APPLY_NORMAL_HIT_DEFEND_BONUS,	// 74 Ÿ   * (100-x)%
+	// END_OF_DEFEND_BONUS_ATTRIBUTES
+
+	// PC_BANG_ITEM_ADD
+	{ POINT_PC_BANG_EXP_BONUS, },			// APPLY_PC_BANG_EXP_BONUS,			// 75 PC  EXP ʽ
+	{ POINT_PC_BANG_DROP_BONUS, },			// APPLY_PC_BANG_DROP_BONUS,		// 76 PC   ʽ
+	// END_PC_BANG_ITEM_ADD
+
+	{ POINT_NONE, },						// APPLY_EXTRACT_HP_PCT, UNUSED		// 77  HP Ҹ
+
+	{ POINT_RESIST_WARRIOR, },				// APPLY_RESIST_WARRIOR,			// 78 翡 
+	{ POINT_RESIST_ASSASSIN, },				// APPLY_RESIST_ASSASSIN,			// 79 ڰ 
+	{ POINT_RESIST_SURA, },					// APPLY_RESIST_SURA,				// 80 󿡰 
+	{ POINT_RESIST_SHAMAN, },				// APPLY_RESIST_SHAMAN,				// 81 翡 
+	{ POINT_ENERGY, },						// APPLY_ENERGY,					// 82 
+	{ POINT_DEF_GRADE, },					// APPLY_DEF_GRADE,					// 83 . DEF_GRADE_BONUS Ŭ󿡼 ι  ǵ (...) ִ.
+	{ POINT_COSTUME_ATTR_BONUS, },			// APPLY_COSTUME_ATTR_BONUS,		// 84 ڽƬ ۿ  Ӽġ ʽ
+	{ POINT_MAGIC_ATT_BONUS_PER, },			// APPLY_MAGIC_ATTBONUS_PER,		// 85  ݷ +x%
+	{ POINT_MELEE_MAGIC_ATT_BONUS_PER, },	// APPLY_MELEE_MAGIC_ATTBONUS_PER,	// 86  + и ݷ +x%
+
+	{ POINT_RESIST_ICE, },					// APPLY_RESIST_ICE,				// 87 ñ 
+	{ POINT_RESIST_EARTH, },				// APPLY_RESIST_EARTH,				// 88  
+	{ POINT_RESIST_DARK, },					// APPLY_RESIST_DARK,				// 89  
+
+	{ POINT_RESIST_CRITICAL, },				// APPLY_ANTI_CRITICAL_PCT,			// 90 ũƼ 
+	{ POINT_RESIST_PENETRATE, },			// APPLY_ANTI_PENETRATE_PCT,		// 91 Ÿ 
+
+	{ POINT_BLEEDING_REDUCE, },				// APPLY_BLEEDING_REDUCE,			// 92
+	{ POINT_BLEEDING_PCT, },				// APPLY_BLEEDING_PCT,				// 93
+	{ POINT_ATTBONUS_WOLFMAN, },			// APPLY_ATT_BONUS_TO_WOLFMAN,		// 94  
+	{ POINT_RESIST_WOLFMAN, },				// APPLY_RESIST_WOLFMAN,			// 95  
+	{ POINT_RESIST_CLAW, },					// APPLY_RESIST_CLAW,				// 96 CLAW 
 
-	{ APPLY_ACCEDRAIN_RATE, POINT_NONE, },
-#if defined(__MAGIC_REDUCTION__)
-	{ APPLY_RESIST_MAGIC_REDUCTION, POINT_RESIST_MAGIC_REDUCTION, },
+#if defined(__ACCE_COSTUME_SYSTEM__)
+	{ POINT_ACCEDRAIN_RATE, }, 				// APPLY_ACCEDRAIN_RATE,			// 97
 #endif
 
-	{ APPLY_ENCHANT_ELECT, POINT_ENCHANT_ELECT, },
-	{ APPLY_ENCHANT_FIRE, POINT_ENCHANT_FIRE, },
-	{ APPLY_ENCHANT_ICE, POINT_ENCHANT_ICE, },
-	{ APPLY_ENCHANT_WIND, POINT_ENCHANT_WIND, },
-	{ APPLY_ENCHANT_EARTH, POINT_ENCHANT_EARTH, },
-	{ APPLY_ENCHANT_DARK, POINT_ENCHANT_DARK, },
-
-	{ APPLY_ATTBONUS_CZ, POINT_ATTBONUS_CZ, },
-	{ APPLY_ATTBONUS_INSECT, POINT_ATTBONUS_INSECT, },
-	{ APPLY_ATTBONUS_DESERT, POINT_ATTBONUS_DESERT, },
-	{ APPLY_ATTBONUS_SWORD, POINT_ATTBONUS_SWORD, },
-	{ APPLY_ATTBONUS_TWOHAND, POINT_ATTBONUS_TWOHAND, },
-	{ APPLY_ATTBONUS_DAGGER, POINT_ATTBONUS_DAGGER, },
-	{ APPLY_ATTBONUS_BELL, POINT_ATTBONUS_BELL, },
-	{ APPLY_ATTBONUS_FAN, POINT_ATTBONUS_FAN, },
-	{ APPLY_ATTBONUS_BOW, POINT_ATTBONUS_BOW, },
-	{ APPLY_ATTBONUS_CLAW, POINT_ATTBONUS_CLAW, },
-
-	{ APPLY_RESIST_HUMAN, POINT_RESIST_HUMAN, },
-	{ APPLY_RESIST_MOUNT_FALL, POINT_RESIST_MOUNT_FALL, },
-	{ APPLY_RESIST_FIST, POINT_RESIST_FIST, },
-
-	{ APPLY_MOUNT, POINT_MOUNT, },
-
-	{ APPLY_SKILL_DAMAGE_SAMYEON, POINT_SKILL_DAMAGE_SAMYEON, },
-	{ APPLY_SKILL_DAMAGE_TANHWAN, POINT_SKILL_DAMAGE_TANHWAN, },
-	{ APPLY_SKILL_DAMAGE_PALBANG, POINT_SKILL_DAMAGE_PALBANG, },
-	{ APPLY_SKILL_DAMAGE_GIGONGCHAM, POINT_SKILL_DAMAGE_GIGONGCHAM, },
-	{ APPLY_SKILL_DAMAGE_GYOKSAN, POINT_SKILL_DAMAGE_GYOKSAN, },
-	{ APPLY_SKILL_DAMAGE_GEOMPUNG, POINT_SKILL_DAMAGE_GEOMPUNG, },
-	{ APPLY_SKILL_DAMAGE_AMSEOP, POINT_SKILL_DAMAGE_AMSEOP, },
-	{ APPLY_SKILL_DAMAGE_GUNGSIN, POINT_SKILL_DAMAGE_GUNGSIN, },
-	{ APPLY_SKILL_DAMAGE_CHARYUN, POINT_SKILL_DAMAGE_CHARYUN, },
-	{ APPLY_SKILL_DAMAGE_SANGONG, POINT_SKILL_DAMAGE_SANGONG, },
-	{ APPLY_SKILL_DAMAGE_YEONSA, POINT_SKILL_DAMAGE_YEONSA, },
-	{ APPLY_SKILL_DAMAGE_KWANKYEOK, POINT_SKILL_DAMAGE_KWANKYEOK, },
-	{ APPLY_SKILL_DAMAGE_GIGUNG, POINT_SKILL_DAMAGE_GIGUNG, },
-	{ APPLY_SKILL_DAMAGE_HWAJO, POINT_SKILL_DAMAGE_HWAJO, },
-	{ APPLY_SKILL_DAMAGE_SWAERYUNG, POINT_SKILL_DAMAGE_SWAERYUNG, },
-	{ APPLY_SKILL_DAMAGE_YONGKWON, POINT_SKILL_DAMAGE_YONGKWON, },
-	{ APPLY_SKILL_DAMAGE_PABEOB, POINT_SKILL_DAMAGE_PABEOB, },
-	{ APPLY_SKILL_DAMAGE_MARYUNG, POINT_SKILL_DAMAGE_MARYUNG, },
-	{ APPLY_SKILL_DAMAGE_HWAYEOMPOK, POINT_SKILL_DAMAGE_HWAYEOMPOK, },
-	{ APPLY_SKILL_DAMAGE_MAHWAN, POINT_SKILL_DAMAGE_MAHWAN, },
-	{ APPLY_SKILL_DAMAGE_BIPABU, POINT_SKILL_DAMAGE_BIPABU, },
-	{ APPLY_SKILL_DAMAGE_YONGBI, POINT_SKILL_DAMAGE_YONGBI, },
-	{ APPLY_SKILL_DAMAGE_PAERYONG, POINT_SKILL_DAMAGE_PAERYONG, },
-	{ APPLY_SKILL_DAMAGE_NOEJEON, POINT_SKILL_DAMAGE_NOEJEON, },
-	{ APPLY_SKILL_DAMAGE_BYEURAK, POINT_SKILL_DAMAGE_BYEURAK, },
-	{ APPLY_SKILL_DAMAGE_CHAIN, POINT_SKILL_DAMAGE_CHAIN, },
-	{ APPLY_SKILL_DAMAGE_CHAYEOL, POINT_SKILL_DAMAGE_CHAYEOL, },
-	{ APPLY_SKILL_DAMAGE_SALPOONG, POINT_SKILL_DAMAGE_SALPOONG, },
-	{ APPLY_SKILL_DAMAGE_GONGDAB, POINT_SKILL_DAMAGE_GONGDAB, },
-	{ APPLY_SKILL_DAMAGE_PASWAE, POINT_SKILL_DAMAGE_PASWAE, },
-
-	{ APPLY_NORMAL_HIT_DEFEND_BONUS_BOSS_OR_MORE, POINT_NORMAL_HIT_DEFEND_BONUS_BOSS_OR_MORE, },
-	{ APPLY_SKILL_DEFEND_BONUS_BOSS_OR_MORE, POINT_SKILL_DEFEND_BONUS_BOSS_OR_MORE, },
-	{ APPLY_NORMAL_HIT_DAMAGE_BONUS_BOSS_OR_MORE, POINT_NORMAL_HIT_DAMAGE_BONUS_BOSS_OR_MORE, },
-	{ APPLY_SKILL_DAMAGE_BONUS_BOSS_OR_MORE, POINT_SKILL_DAMAGE_BONUS_BOSS_OR_MORE, },
-
-	{ APPLY_HIT_BUFF_ENCHANT_FIRE, POINT_HIT_BUFF_ENCHANT_FIRE, },
-	{ APPLY_HIT_BUFF_ENCHANT_ICE, POINT_HIT_BUFF_ENCHANT_ICE, },
-	{ APPLY_HIT_BUFF_ENCHANT_ELEC, POINT_HIT_BUFF_ENCHANT_ELEC, },
-	{ APPLY_HIT_BUFF_ENCHANT_WIND, POINT_HIT_BUFF_ENCHANT_WIND, },
-	{ APPLY_HIT_BUFF_ENCHANT_DARK, POINT_HIT_BUFF_ENCHANT_DARK, },
-	{ APPLY_HIT_BUFF_ENCHANT_EARTH, POINT_HIT_BUFF_ENCHANT_EARTH, },
-	{ APPLY_HIT_BUFF_RESIST_FIRE, POINT_HIT_BUFF_RESIST_FIRE, },
-	{ APPLY_HIT_BUFF_RESIST_ICE, POINT_HIT_BUFF_RESIST_ICE, },
-	{ APPLY_HIT_BUFF_RESIST_ELEC, POINT_HIT_BUFF_RESIST_ELEC, },
-	{ APPLY_HIT_BUFF_RESIST_WIND, POINT_HIT_BUFF_RESIST_WIND, },
-	{ APPLY_HIT_BUFF_RESIST_DARK, POINT_HIT_BUFF_RESIST_DARK, },
-	{ APPLY_HIT_BUFF_RESIST_EARTH, POINT_HIT_BUFF_RESIST_EARTH, },
-
-	{ APPLY_USE_SKILL_CHEONGRANG_MOV_SPEED, POINT_USE_SKILL_CHEONGRANG_MOV_SPEED, },
-	{ APPLY_USE_SKILL_CHEONGRANG_CASTING_SPEED, POINT_USE_SKILL_CHEONGRANG_CASTING_SPEED, },
-	{ APPLY_USE_SKILL_CHAYEOL_CRITICAL_PCT, POINT_USE_SKILL_CHAYEOL_CRITICAL_PCT, },
-	{ APPLY_USE_SKILL_SANGONG_ATT_GRADE_BONUS, POINT_USE_SKILL_SANGONG_ATT_GRADE_BONUS, },
-	{ APPLY_USE_SKILL_GIGUNG_ATT_GRADE_BONUS, POINT_USE_SKILL_GIGUNG_ATT_GRADE_BONUS, },
-	{ APPLY_USE_SKILL_JEOKRANG_DEF_BONUS, POINT_USE_SKILL_JEOKRANG_DEF_BONUS, },
-	{ APPLY_USE_SKILL_GWIGEOM_DEF_BONUS, POINT_USE_SKILL_GWIGEOM_DEF_BONUS, },
-	{ APPLY_USE_SKILL_TERROR_ATT_GRADE_BONUS, POINT_USE_SKILL_TERROR_ATT_GRADE_BONUS, },
-	{ APPLY_USE_SKILL_MUYEONG_ATT_GRADE_BONUS, POINT_USE_SKILL_MUYEONG_ATT_GRADE_BONUS, },
-	{ APPLY_USE_SKILL_MANASHILED_CASTING_SPEED, POINT_USE_SKILL_MANASHILED_CASTING_SPEED, },
-	{ APPLY_USE_SKILL_HOSIN_DEF_BONUS, POINT_USE_SKILL_HOSIN_DEF_BONUS, },
-	{ APPLY_USE_SKILL_GICHEON_ATT_GRADE_BONUS, POINT_USE_SKILL_GICHEON_ATT_GRADE_BONUS, },
-	{ APPLY_USE_SKILL_JEONGEOP_ATT_GRADE_BONUS, POINT_USE_SKILL_JEONGEOP_ATT_GRADE_BONUS, },
-	{ APPLY_USE_SKILL_JEUNGRYEOK_DEF_BONUS, POINT_USE_SKILL_JEUNGRYEOK_DEF_BONUS, },
-	{ APPLY_USE_SKILL_GIHYEOL_ATT_GRADE_BONUS, POINT_USE_SKILL_GIHYEOL_ATT_GRADE_BONUS, },
-	{ APPLY_USE_SKILL_CHUNKEON_CASTING_SPEED, POINT_USE_SKILL_CHUNKEON_CASTING_SPEED, },
-	{ APPLY_USE_SKILL_NOEGEOM_ATT_GRADE_BONUS, POINT_USE_SKILL_NOEGEOM_ATT_GRADE_BONUS, },
-
-	{ APPLY_SKILL_DURATION_INCREASE_EUNHYUNG, POINT_SKILL_DURATION_INCREASE_EUNHYUNG, },
-	{ APPLY_SKILL_DURATION_INCREASE_GYEONGGONG, POINT_SKILL_DURATION_INCREASE_GYEONGGONG, },
-	{ APPLY_SKILL_DURATION_INCREASE_GEOMKYUNG, POINT_SKILL_DURATION_INCREASE_GEOMKYUNG, },
-	{ APPLY_SKILL_DURATION_INCREASE_JEOKRANG, POINT_SKILL_DURATION_INCREASE_JEOKRANG, },
-
-	{ APPLY_USE_SKILL_PALBANG_HP_ABSORB, POINT_USE_SKILL_PALBANG_HP_ABSORB, },
-	{ APPLY_USE_SKILL_AMSEOP_HP_ABSORB, POINT_USE_SKILL_AMSEOP_HP_ABSORB, },
-	{ APPLY_USE_SKILL_YEONSA_HP_ABSORB, POINT_USE_SKILL_YEONSA_HP_ABSORB, },
-	{ APPLY_USE_SKILL_YONGBI_HP_ABSORB, POINT_USE_SKILL_YONGBI_HP_ABSORB, },
-	{ APPLY_USE_SKILL_CHAIN_HP_ABSORB, POINT_USE_SKILL_CHAIN_HP_ABSORB, },
-	{ APPLY_USE_SKILL_PASWAE_SP_ABSORB, POINT_USE_SKILL_PASWAE_SP_ABSORB, },
-	{ APPLY_USE_SKILL_GIGONGCHAM_STUN, POINT_USE_SKILL_GIGONGCHAM_STUN, },
-	{ APPLY_USE_SKILL_CHARYUN_STUN, POINT_USE_SKILL_CHARYUN_STUN, },
-	{ APPLY_USE_SKILL_PABEOB_STUN, POINT_USE_SKILL_PABEOB_STUN, },
-	{ APPLY_USE_SKILL_MAHWAN_STUN, POINT_USE_SKILL_MAHWAN_STUN, },
-	{ APPLY_USE_SKILL_GONGDAB_STUN, POINT_USE_SKILL_GONGDAB_STUN, },
-	{ APPLY_USE_SKILL_SAMYEON_STUN, POINT_USE_SKILL_SAMYEON_STUN, },
-	{ APPLY_USE_SKILL_GYOKSAN_KNOCKBACK, POINT_USE_SKILL_GYOKSAN_KNOCKBACK, },
-	{ APPLY_USE_SKILL_SEOMJEON_KNOCKBACK, POINT_USE_SKILL_SEOMJEON_KNOCKBACK, },
-	{ APPLY_USE_SKILL_SWAERYUNG_KNOCKBACK, POINT_USE_SKILL_SWAERYUNG_KNOCKBACK, },
-	{ APPLY_USE_SKILL_HWAYEOMPOK_KNOCKBACK, POINT_USE_SKILL_HWAYEOMPOK_KNOCKBACK, },
-	{ APPLY_USE_SKILL_GONGDAB_KNOCKBACK, POINT_USE_SKILL_GONGDAB_KNOCKBACK, },
-	{ APPLY_USE_SKILL_KWANKYEOK_KNOCKBACK, POINT_USE_SKILL_KWANKYEOK_KNOCKBACK, },
-	{ APPLY_USE_SKILL_SAMYEON_NEXT_COOLTIME_DECREASE_10PER, POINT_USE_SKILL_SAMYEON_NEXT_COOLTIME_DECREASE_10PER, },
-	{ APPLY_USE_SKILL_GEOMPUNG_NEXT_COOLTIME_DECREASE_10PER, POINT_USE_SKILL_GEOMPUNG_NEXT_COOLTIME_DECREASE_10PER, },
-	{ APPLY_USE_SKILL_GUNGSIN_NEXT_COOLTIME_DECREASE_10PER, POINT_USE_SKILL_GUNGSIN_NEXT_COOLTIME_DECREASE_10PER, },
-	{ APPLY_USE_SKILL_KWANKYEOK_NEXT_COOLTIME_DECREASE_10PER, POINT_USE_SKILL_KWANKYEOK_NEXT_COOLTIME_DECREASE_10PER, },
-	{ APPLY_USE_SKILL_YONGKWON_NEXT_COOLTIME_DECREASE_10PER, POINT_USE_SKILL_YONGKWON_NEXT_COOLTIME_DECREASE_10PER, },
-	{ APPLY_USE_SKILL_MARYUNG_NEXT_COOLTIME_DECREASE_10PER, POINT_USE_SKILL_MARYUNG_NEXT_COOLTIME_DECREASE_10PER, },
-	{ APPLY_USE_SKILL_BIPABU_NEXT_COOLTIME_DECREASE_10PER, POINT_USE_SKILL_BIPABU_NEXT_COOLTIME_DECREASE_10PER, },
-	{ APPLY_USE_SKILL_NOEJEON_NEXT_COOLTIME_DECREASE_10PER, POINT_USE_SKILL_NOEJEON_NEXT_COOLTIME_DECREASE_10PER, },
-	{ APPLY_USE_SKILL_SALPOONG_NEXT_COOLTIME_DECREASE_10PER, POINT_USE_SKILL_SALPOONG_NEXT_COOLTIME_DECREASE_10PER, },
-	{ APPLY_USE_SKILL_PASWAE_NEXT_COOLTIME_DECREASE_10PER, POINT_USE_SKILL_PASWAE_NEXT_COOLTIME_DECREASE_10PER, },
-
-	{ APPLY_ATTBONUS_STONE, POINT_ATTBONUS_STONE, },
-
-	{ APPLY_DAMAGE_HP_RECOVERY, POINT_DAMAGE_HP_RECOVERY, },
-	{ APPLY_DAMAGE_SP_RECOVERY, POINT_DAMAGE_SP_RECOVERY, },
-
-	{ APPLY_ALIGNMENT_DAMAGE_BONUS, POINT_ALIGNMENT_DAMAGE_BONUS, },
-
-	{ APPLY_NORMAL_DAMAGE_GUARD, POINT_NORMAL_DAMAGE_GUARD },
-	{ APPLY_MORE_THEN_HP90_DAMAGE_REDUCE, POINT_MORE_THEN_HP90_DAMAGE_REDUCE, },
-
-	{ APPLY_USE_SKILL_TUSOK_HP_ABSORB, POINT_USE_SKILL_TUSOK_HP_ABSORB, },
-	{ APPLY_USE_SKILL_PAERYONG_HP_ABSORB, POINT_USE_SKILL_PAERYONG_HP_ABSORB, },
-	{ APPLY_USE_SKILL_BYEURAK_HP_ABSORB, POINT_USE_SKILL_BYEURAK_HP_ABSORB, },
-
-	{ APPLY_FIRST_ATTRIBUTE_BONUS, POINT_NONE, },
-	{ APPLY_SECOND_ATTRIBUTE_BONUS, POINT_NONE, },
-	{ APPLY_THIRD_ATTRIBUTE_BONUS, POINT_NONE, },
-	{ APPLY_FOURTH_ATTRIBUTE_BONUS, POINT_NONE, },
-	{ APPLY_FIFTH_ATTRIBUTE_BONUS, POINT_NONE, },
-
-	{ APPLY_USE_SKILL_SAMYEON_NEXT_COOLTIME_DECREASE_20PER, POINT_USE_SKILL_SAMYEON_NEXT_COOLTIME_DECREASE_20PER, },
-	{ APPLY_USE_SKILL_GEOMPUNG_NEXT_COOLTIME_DECREASE_20PER, POINT_USE_SKILL_GEOMPUNG_NEXT_COOLTIME_DECREASE_20PER, },
-	{ APPLY_USE_SKILL_GUNGSIN_NEXT_COOLTIME_DECREASE_20PER, POINT_USE_SKILL_GUNGSIN_NEXT_COOLTIME_DECREASE_20PER, },
-	{ APPLY_USE_SKILL_KWANKYEOK_NEXT_COOLTIME_DECREASE_20PER, POINT_USE_SKILL_KWANKYEOK_NEXT_COOLTIME_DECREASE_20PER, },
-	{ APPLY_USE_SKILL_YONGKWON_NEXT_COOLTIME_DECREASE_20PER, POINT_USE_SKILL_YONGKWON_NEXT_COOLTIME_DECREASE_20PER, },
-	{ APPLY_USE_SKILL_MARYUNG_NEXT_COOLTIME_DECREASE_20PER, POINT_USE_SKILL_MARYUNG_NEXT_COOLTIME_DECREASE_20PER, },
-	{ APPLY_USE_SKILL_BIPABU_NEXT_COOLTIME_DECREASE_20PER, POINT_USE_SKILL_BIPABU_NEXT_COOLTIME_DECREASE_20PER, },
-	{ APPLY_USE_SKILL_NOEJEON_NEXT_COOLTIME_DECREASE_20PER, POINT_USE_SKILL_NOEJEON_NEXT_COOLTIME_DECREASE_20PER, },
-	{ APPLY_USE_SKILL_SALPOONG_NEXT_COOLTIME_DECREASE_20PER, POINT_USE_SKILL_SALPOONG_NEXT_COOLTIME_DECREASE_20PER, },
-	{ APPLY_USE_SKILL_PASWAE_NEXT_COOLTIME_DECREASE_20PER, POINT_USE_SKILL_PASWAE_NEXT_COOLTIME_DECREASE_20PER, },
-	{ APPLY_USE_SKILL_CHAYEOL_HP_ABSORB, POINT_USE_SKILL_CHAYEOL_HP_ABSORB, },
-
-	{ APPLY_SUNGMA_STR, POINT_SUNGMA_STR, },
-	{ APPLY_SUNGMA_HP, POINT_SUNGMA_HP, },
-	{ APPLY_SUNGMA_MOVE, POINT_SUNGMA_MOVE, },
-	{ APPLY_SUNGMA_IMMUNE, POINT_SUNGMA_IMMUNE, },
-
-	{ APPLY_HIT_PCT, POINT_HIT_PCT, },
-	{ APPLY_RANDOM, POINT_NONE, },
-
-	{ APPLY_ATTBONUS_PER_HUMAN, POINT_ATTBONUS_PER_HUMAN, },
-	{ APPLY_ATTBONUS_PER_ANIMAL, POINT_ATTBONUS_PER_ANIMAL, },
-	{ APPLY_ATTBONUS_PER_ORC, POINT_ATTBONUS_PER_ORC, },
-	{ APPLY_ATTBONUS_PER_MILGYO, POINT_ATTBONUS_PER_MILGYO, },
-	{ APPLY_ATTBONUS_PER_UNDEAD, POINT_ATTBONUS_PER_UNDEAD, },
-	{ APPLY_ATTBONUS_PER_DEVIL, POINT_ATTBONUS_PER_DEVIL, },
-
-	{ APPLY_ENCHANT_PER_ELECT, POINT_ENCHANT_PER_ELECT, },
-	{ APPLY_ENCHANT_PER_FIRE, POINT_ENCHANT_PER_FIRE, },
-	{ APPLY_ENCHANT_PER_ICE, POINT_ENCHANT_PER_ICE, },
-	{ APPLY_ENCHANT_PER_WIND, POINT_ENCHANT_PER_WIND, },
-	{ APPLY_ENCHANT_PER_EARTH, POINT_ENCHANT_PER_EARTH, },
-	{ APPLY_ENCHANT_PER_DARK, POINT_ENCHANT_PER_DARK, },
-
-	{ APPLY_ATTBONUS_PER_CZ, POINT_ATTBONUS_PER_CZ, },
-	{ APPLY_ATTBONUS_PER_INSECT, POINT_ATTBONUS_PER_INSECT, },
-	{ APPLY_ATTBONUS_PER_DESERT, POINT_ATTBONUS_PER_DESERT, },
-	{ APPLY_ATTBONUS_PER_STONE, POINT_ATTBONUS_PER_STONE, },
-	{ APPLY_ATTBONUS_PER_MONSTER, POINT_ATTBONUS_PER_MONSTER, },
-
-	{ APPLY_RESIST_PER_HUMAN, POINT_RESIST_PER_HUMAN, },
-	{ APPLY_RESIST_PER_ICE, POINT_RESIST_PER_ICE, },
-	{ APPLY_RESIST_PER_DARK, POINT_RESIST_PER_DARK, },
-	{ APPLY_RESIST_PER_EARTH, POINT_RESIST_PER_EARTH, },
-	{ APPLY_RESIST_PER_FIRE, POINT_RESIST_PER_FIRE, },
-	{ APPLY_RESIST_PER_ELEC, POINT_RESIST_PER_ELEC, },
-	{ APPLY_RESIST_PER_MAGIC, POINT_RESIST_PER_MAGIC, },
-	{ APPLY_RESIST_PER_WIND, POINT_RESIST_PER_WIND, },
-
-	{ APPLY_HIT_BUFF_SUNGMA_STR, POINT_HIT_BUFF_SUNGMA_STR, },
-	{ APPLY_HIT_BUFF_SUNGMA_MOVE, POINT_HIT_BUFF_SUNGMA_MOVE, },
-	{ APPLY_HIT_BUFF_SUNGMA_HP, POINT_HIT_BUFF_SUNGMA_HP, },
-	{ APPLY_HIT_BUFF_SUNGMA_IMMUNE, POINT_HIT_BUFF_SUNGMA_IMMUNE, },
-
-	{ APPLY_MOUNT_MELEE_MAGIC_ATTBONUS_PER, POINT_MOUNT_MELEE_MAGIC_ATTBONUS_PER, },
-	{ APPLY_DISMOUNT_MOVE_SPEED_BONUS_PER, POINT_DISMOUNT_MOVE_SPEED_BONUS_PER, },
-
-	{ APPLY_HIT_AUTO_HP_RECOVERY, POINT_HIT_AUTO_HP_RECOVERY, },
-	{ APPLY_HIT_AUTO_SP_RECOVERY, POINT_HIT_AUTO_SP_RECOVERY, },
-
-	{ APPLY_USE_SKILL_COOLTIME_DECREASE_ALL, POINT_USE_SKILL_COOLTIME_DECREASE_ALL, },
-
-	{ APPLY_HIT_STONE_ATTBONUS_STONE, POINT_HIT_STONE_ATTBONUS_STONE, },
-	{ APPLY_HIT_STONE_DEF_GRADE_BONUS, POINT_HIT_STONE_DEF_GRADE_BONUS, },
-
-	{ APPLY_KILL_BOSS_ITEM_BONUS, POINT_KILL_BOSS_ITEM_BONUS, },
-	{ APPLY_MOB_HIT_MOB_AGGRESSIVE, POINT_MOB_HIT_MOB_AGGRESSIVE, },
-	{ APPLY_NO_DEATH_AND_HP_RECOVERY30, POINT_NO_DEATH_AND_HP_RECOVERY30, },
-
-	{ APPLY_AUTO_PICKUP, POINT_AUTO_PICKUP, },
-	{ APPLY_MOUNT_NO_KNOCKBACK, POINT_MOUNT_NO_KNOCKBACK, },
-
-	{ APPLY_SUNGMA_PER_STR, POINT_SUNGMA_PER_STR, },
-	{ APPLY_SUNGMA_PER_HP, POINT_SUNGMA_PER_HP, },
-	{ APPLY_SUNGMA_PER_MOVE, POINT_SUNGMA_PER_MOVE, },
-	{ APPLY_SUNGMA_PER_IMMUNE, POINT_SUNGMA_PER_IMMUNE, },
+#if defined(__MAGIC_REDUCTION__)
+	{ POINT_RESIST_MAGIC_REDUCTION, },		// APPLY_RESIST_MAGIC_REDUCTION,	// 98
+#endif
 
-	{ APPLY_IMMUNE_POISON100, POINT_IMMUNE_POISON100, },
-	{ APPLY_IMMUNE_BLEEDING100, POINT_IMMUNE_BLEEDING100, },
+#if defined(__ELEMENT_SYSTEM__)
+	{ POINT_ENCHANT_ELECT, },				// APPLY_ENCHANT_ELECT,				// 99
+	{ POINT_ENCHANT_FIRE, },				// APPLY_ENCHANT_FIRE,				// 100
+	{ POINT_ENCHANT_ICE, },					// APPLY_ENCHANT_ICE,				// 101
+	{ POINT_ENCHANT_WIND, },				// APPLY_ENCHANT_WIND,				// 102
+	{ POINT_ENCHANT_EARTH, },				// APPLY_ENCHANT_EARTH,				// 103
+	{ POINT_ENCHANT_DARK, },				// APPLY_ENCHANT_DARK,				// 104
+	{ POINT_ATTBONUS_CZ, },					// APPLY_ATTBONUS_CZ,				// 105
+	{ POINT_ATTBONUS_INSECT, },				// APPLY_ATTBONUS_INSECT,			// 106
+	{ POINT_ATTBONUS_DESERT, },				// APPLY_ATTBONUS_DESERT,			// 107
+	{ POINT_ATTBONUS_SWORD, },				// APPLY_ATTBONUS_SWORD,			// 108
+	{ POINT_ATTBONUS_TWOHAND, },			// APPLY_ATTBONUS_TWOHAND,			// 109
+	{ POINT_ATTBONUS_DAGGER, },				// APPLY_ATTBONUS_DAGGER,			// 110
+	{ POINT_ATTBONUS_BELL, },				// APPLY_ATTBONUS_BELL,				// 111
+	{ POINT_ATTBONUS_FAN, },				// APPLY_ATTBONUS_FAN,				// 112
+	{ POINT_ATTBONUS_BOW, },				// APPLY_ATTBONUS_BOW,				// 113
+	{ POINT_ATTBONUS_CLAW, },				// APPLY_ATTBONUS_CLAW,				// 114
+	{ POINT_RESIST_HUMAN, },				// APPLY_RESIST_HUMAN,				// 115
+#endif
 
-	{ APPLY_MONSTER_DEFEND_BONUS, POINT_MONSTER_DEFEND_BONUS, },
+#if defined(__9TH_SKILL__)
+	{ POINT_INVINCIBLE, },					// APPLY_INVINCIBLE,				// 119
+#endif
 };
 
 const int aiItemMagicAttributePercentHigh[ITEM_ATTRIBUTE_MAX_LEVEL] =
@@ -1251,55 +1025,27 @@
 	{ 8012, 60, { 10, 26, 37, 24, 3 } },
 	{ 8013, 60, { 2, 26, 40, 29, 3 } },
 	{ 8014, 60, { 0, 26, 41, 30, 3 } },
-	{ 8018, 60, { 0, 25, 42, 30, 3 } },
-	{ 8019, 60, { 0, 23, 42, 32, 3 } },
-	{ 8024, 60, { 0, 22, 43, 32, 3 } },
-	{ 8025, 60, { 0, 21, 43, 32, 4 } },
-	{ 8026, 60, { 0, 19, 44, 33, 4 } },
-	{ 8027, 60, { 0, 17, 45, 34, 4 } },
-	{ 8051, 60, { 0, 15, 46, 34, 5 } },
-	{ 8052, 60, { 0, 15, 46, 34, 5 } },
-	{ 8053, 60, { 0, 12, 47, 36, 5 } },
-	{ 8054, 60, { 0, 12, 47, 36, 5 } },
-	{ 8055, 60, { 0, 9, 48, 37, 6 } },
-	{ 8056, 60, { 0, 9, 48, 37, 6 } },
 };
 
 const char* c_apszEmpireNames[EMPIRE_MAX_NUM] =
 {
-#if defined(__LOCALE_CLIENT__)
-	"[LS;1037]",
-	"[LS;793]",
-	"[LS;794]",
-	"[LS;795]"
-#else
 	"",
 	"ż",
 	"õ",
 	"뱹"
-#endif
 };
 
 const char* c_apszPrivNames[MAX_PRIV_NUM] =
 {
-#if defined(__LOCALE_CLIENT__)
-	"",
-	"[LS;1038]",
-	"[LS;1039]",
-	"[LS;1031]",
-	"[LS;1040]"
-#else
 	"",
 	"  Ȯ",
 	"  Ȯ",
 	"   Ȯ",
-	"ġ "
-#endif
+	"ġ ",
 };
 
 const int aiPolymorphPowerByLevel[SKILL_MAX_LEVEL + 1] =
 {
-	0, // 0
 	10, // 1
 	11, // 2
 	11, // 3
@@ -1319,7 +1065,7 @@
 	26, // 17
 	27, // 18
 	29, // 19
-	31, // 20 M1
+	31, // 20
 	33, // 21
 	35, // 22
 	37, // 23
@@ -1329,7 +1075,7 @@
 	46, // 27
 	49, // 28
 	52, // 29
-	55, // 30 G1
+	55, // 30
 	59, // 31
 	62, // 32
 	66, // 33
@@ -1338,63 +1084,8 @@
 	79, // 36
 	84, // 37
 	89, // 38
-	94,	// 39
-	100, // 40 P
-};
-
-#if defined(__PARTY_PROFICY__)
-const int aiProficiencyPowerByLevel[SKILL_MAX_LEVEL + 1] = {
-	0, 1, 2, 3, 4, 5, 6, 7,8, 9,
-	10, 11, 12, 13, 14, 15, 16, 17, 18, 19,
-	20, 21, 22, 23, 24, 25, 26, 27, 28, 29,
-	30, 32, 34, 36, 38, 40, 42, 44, 46, 48,
-	50,
-};
-#endif
-
-const int aiPrecisionPowerByLevel[SKILL_MAX_LEVEL + 1] =
-{
-	0,	// 0
-	0,	// 1
-	0,	// 2
-	1,	// 3
-	1,	// 4
-	1,	// 5
-	2,	// 6
-	2,	// 7
-	2,	// 8
-	3,	// 9
-	3,	// 10
-	3,	// 11
-	4,	// 12
-	4,	// 13
-	4,	// 14
-	5,	// 15
-	5,	// 16
-	5,	// 17
-	6,	// 18
-	6,	// 19
-	8,	// 20
-	8,	// 21
-	8,	// 22
-	9,	// 23
-	9,	// 24
-	9,	// 25
-	10,	// 26
-	10,	// 27
-	11,	// 28
-	11,	// 29
-	13,	// 30
-	13,	// 31
-	14,	// 32
-	14,	// 33
-	15,	// 34
-	16,	// 35
-	16,	// 36
-	17,	// 37
-	18,	// 38
-	18,	// 39
-	20,	// 40
+	94, // 39
+	100, // 40
 };
 
 TGuildWarInfo KOR_aGuildWarInfo[GUILD_WAR_TYPE_MAX_NUM] =
@@ -1443,38 +1134,6 @@
 };
 // END_OF_ACCESSORY_REFINE
 
-#if defined(__ACCE_COSTUME_SYSTEM__)
-const int aiAcceDrainRateAdvancePct[ACCE_MAX_DRAINRATE + 1] =
-{
-	100, // 0
-	100, // 1
-	100, // 2
-	100, // 3
-	100, // 4
-	100, // 5
-	100, // 6
-	100, // 7
-	100, // 8
-	100, // 9
-	100, // 10
-	100, // 11
-	100, // 12
-	100, // 13
-	100, // 14
-	100, // 15
-	100, // 16
-	90, // 17
-	80, // 18
-	50, // 19
-	40, // 20
-	35, // 21
-	30, // 22
-	25, // 23
-	20, // 24
-	0 // 25
-};
-#endif
-
 #include "../../common/length.h"
 // from import_item_proto.c
 typedef struct SValueName
@@ -1544,67 +1203,57 @@
 	{ "MAGIC_DEF_GRADE", APPLY_MAGIC_DEF_GRADE },
 	{ "CURSE_PCT", APPLY_CURSE_PCT },
 	{ "MAX_STAMINA", APPLY_MAX_STAMINA },
-
-	{ "ATTBONUS_WARRIOR", APPLY_ATTBONUS_WARRIOR },
-	{ "ATTBONUS_ASSASSIN", APPLY_ATTBONUS_ASSASSIN },
-	{ "ATTBONUS_SURA", APPLY_ATTBONUS_SURA },
-	{ "ATTBONUS_SHAMAN", APPLY_ATTBONUS_SHAMAN },
-	{ "ATTBONUS_MONSTER", APPLY_ATTBONUS_MONSTER },
-
+	{ "ATTBONUS_WARRIOR", APPLY_ATT_BONUS_TO_WARRIOR },
+	{ "ATTBONUS_ASSASSIN", APPLY_ATT_BONUS_TO_ASSASSIN },
+	{ "ATTBONUS_SURA", APPLY_ATT_BONUS_TO_SURA },
+	{ "ATTBONUS_SHAMAN", APPLY_ATT_BONUS_TO_SHAMAN },
+	{ "ATTBONUS_MONSTER", APPLY_ATT_BONUS_TO_MONSTER },
 	{ "MALL_ATTBONUS", APPLY_MALL_ATTBONUS },
 	{ "MALL_DEFBONUS", APPLY_MALL_DEFBONUS },
 	{ "MALL_EXPBONUS", APPLY_MALL_EXPBONUS },
 	{ "MALL_ITEMBONUS", APPLY_MALL_ITEMBONUS },
 	{ "MALL_GOLDBONUS", APPLY_MALL_GOLDBONUS },
-
 	{ "MAX_HP_PCT", APPLY_MAX_HP_PCT },
 	{ "MAX_SP_PCT", APPLY_MAX_SP_PCT },
-
 	{ "SKILL_DAMAGE_BONUS", APPLY_SKILL_DAMAGE_BONUS },
 	{ "NORMAL_HIT_DAMAGE_BONUS", APPLY_NORMAL_HIT_DAMAGE_BONUS },
-
 	{ "SKILL_DEFEND_BONUS", APPLY_SKILL_DEFEND_BONUS },
-
 	{ "NORMAL_HIT_DEFEND_BONUS", APPLY_NORMAL_HIT_DEFEND_BONUS },
 	{ "PC_BANG_EXP_BONUS", APPLY_PC_BANG_EXP_BONUS },
 	{ "PC_BANG_DROP_BONUS", APPLY_PC_BANG_DROP_BONUS },
-
 	{ "EXTRACT_HP_PCT", APPLY_EXTRACT_HP_PCT },
-
 	{ "RESIST_WARRIOR", APPLY_RESIST_WARRIOR },
 	{ "RESIST_ASSASSIN", APPLY_RESIST_ASSASSIN },
 	{ "RESIST_SURA", APPLY_RESIST_SURA },
 	{ "RESIST_SHAMAN", APPLY_RESIST_SHAMAN },
-
 	{ "ENERGY", APPLY_ENERGY },
 	{ "DEF_GRADE", APPLY_DEF_GRADE },
 	{ "COSTUME_ATTR_BONUS", APPLY_COSTUME_ATTR_BONUS },
 	{ "MAGIC_ATTBONUS_PER", APPLY_MAGIC_ATTBONUS_PER },
 	{ "MELEE_MAGIC_ATTBONUS_PER", APPLY_MELEE_MAGIC_ATTBONUS_PER },
-
 	{ "RESIST_ICE", APPLY_RESIST_ICE },
 	{ "RESIST_EARTH", APPLY_RESIST_EARTH },
 	{ "RESIST_DARK", APPLY_RESIST_DARK },
-
 	{ "RESIST_CRITICAL", APPLY_ANTI_CRITICAL_PCT /* APPLY_RESIST_CRITICAL */ },
 	{ "RESIST_PENETRATE", APPLY_ANTI_PENETRATE_PCT /* APPLY_RESIST_PENETRATE */ },
-
 	{ "BLEEDING_REDUCE", APPLY_BLEEDING_REDUCE },
 	{ "BLEEDING_PCT", APPLY_BLEEDING_PCT },
-	{ "ATTBONUS_WOLFMAN", APPLY_ATTBONUS_WOLFMAN },
+	{ "ATTBONUS_WOLFMAN", APPLY_ATT_BONUS_TO_WOLFMAN },
 	{ "RESIST_WOLFMAN", APPLY_RESIST_WOLFMAN },
 	{ "RESIST_CLAW", APPLY_RESIST_CLAW },
-
+#if defined(__ACCE_COSTUME_SYSTEM__)
 	{ "ACCEDRAIN_RATE", APPLY_ACCEDRAIN_RATE },
+#endif
+#if defined(__MAGIC_REDUCTION__)
 	{ "RESIST_MAGIC_REDUCTION", APPLY_RESIST_MAGIC_REDUCTION },
-
+#endif
+#if defined(__ELEMENT_SYSTEM__)
 	{ "ENCHANT_ELECT", APPLY_ENCHANT_ELECT },
 	{ "ENCHANT_FIRE", APPLY_ENCHANT_FIRE },
 	{ "ENCHANT_ICE", APPLY_ENCHANT_ICE },
 	{ "ENCHANT_WIND", APPLY_ENCHANT_WIND },
 	{ "ENCHANT_EARTH", APPLY_ENCHANT_EARTH },
 	{ "ENCHANT_DARK", APPLY_ENCHANT_DARK },
-
 	{ "ATTBONUS_CZ", APPLY_ATTBONUS_CZ },
 	{ "ATTBONUS_INSECT", APPLY_ATTBONUS_INSECT },
 	{ "ATTBONUS_DESERT", APPLY_ATTBONUS_DESERT },
@@ -1615,234 +1264,27 @@
 	{ "ATTBONUS_FAN", APPLY_ATTBONUS_FAN },
 	{ "ATTBONUS_BOW", APPLY_ATTBONUS_BOW },
 	{ "ATTBONUS_CLAW", APPLY_ATTBONUS_CLAW },
-
 	{ "RESIST_HUMAN", APPLY_RESIST_HUMAN },
-	{ "RESIST_MOUNT_FALL", APPLY_RESIST_MOUNT_FALL },
-	{ "RESIST_FIST", APPLY_RESIST_FIST },
-
-	{ "MOUNT", APPLY_MOUNT },
-
-	{ "SKILL_DAMAGE_SAMYEON", APPLY_SKILL_DAMAGE_SAMYEON },
-	{ "SKILL_DAMAGE_TANHWAN", APPLY_SKILL_DAMAGE_TANHWAN },
-	{ "SKILL_DAMAGE_PALBANG", APPLY_SKILL_DAMAGE_PALBANG },
-	{ "SKILL_DAMAGE_GIGONGCHAM", APPLY_SKILL_DAMAGE_GIGONGCHAM },
-	{ "SKILL_DAMAGE_GYOKSAN", APPLY_SKILL_DAMAGE_GYOKSAN },
-	{ "SKILL_DAMAGE_GEOMPUNG", APPLY_SKILL_DAMAGE_GEOMPUNG },
-	{ "SKILL_DAMAGE_AMSEOP", APPLY_SKILL_DAMAGE_AMSEOP },
-	{ "SKILL_DAMAGE_GUNGSIN", APPLY_SKILL_DAMAGE_GUNGSIN },
-	{ "SKILL_DAMAGE_CHARYUN", APPLY_SKILL_DAMAGE_CHARYUN },
-	{ "SKILL_DAMAGE_SANGONG", APPLY_SKILL_DAMAGE_SANGONG },
-	{ "SKILL_DAMAGE_YEONSA", APPLY_SKILL_DAMAGE_YEONSA },
-	{ "SKILL_DAMAGE_KWANKYEOK", APPLY_SKILL_DAMAGE_KWANKYEOK },
-	{ "SKILL_DAMAGE_GIGUNG", APPLY_SKILL_DAMAGE_GIGUNG },
-	{ "SKILL_DAMAGE_HWAJO", APPLY_SKILL_DAMAGE_HWAJO },
-	{ "SKILL_DAMAGE_SWAERYUNG", APPLY_SKILL_DAMAGE_SWAERYUNG },
-	{ "SKILL_DAMAGE_YONGKWON", APPLY_SKILL_DAMAGE_YONGKWON },
-	{ "SKILL_DAMAGE_PABEOB", APPLY_SKILL_DAMAGE_PABEOB },
-	{ "SKILL_DAMAGE_MARYUNG", APPLY_SKILL_DAMAGE_MARYUNG },
-	{ "SKILL_DAMAGE_HWAYEOMPOK", APPLY_SKILL_DAMAGE_HWAYEOMPOK },
-	{ "SKILL_DAMAGE_MAHWAN", APPLY_SKILL_DAMAGE_MAHWAN },
-	{ "SKILL_DAMAGE_BIPABU", APPLY_SKILL_DAMAGE_BIPABU },
-	{ "SKILL_DAMAGE_YONGBI", APPLY_SKILL_DAMAGE_YONGBI },
-	{ "SKILL_DAMAGE_PAERYONG", APPLY_SKILL_DAMAGE_PAERYONG },
-	{ "SKILL_DAMAGE_NOEJEON", APPLY_SKILL_DAMAGE_NOEJEON },
-	{ "SKILL_DAMAGE_BYEURAK", APPLY_SKILL_DAMAGE_BYEURAK },
-	{ "SKILL_DAMAGE_CHAIN", APPLY_SKILL_DAMAGE_CHAIN },
-	{ "SKILL_DAMAGE_CHAYEOL", APPLY_SKILL_DAMAGE_CHAYEOL },
-	{ "SKILL_DAMAGE_SALPOONG", APPLY_SKILL_DAMAGE_SALPOONG },
-	{ "SKILL_DAMAGE_GONGDAB", APPLY_SKILL_DAMAGE_GONGDAB },
-	{ "SKILL_DAMAGE_PASWAE", APPLY_SKILL_DAMAGE_PASWAE },
-
-	{ "NORMAL_HIT_DEFEND_BONUS_BOSS_OR_MORE", APPLY_NORMAL_HIT_DEFEND_BONUS_BOSS_OR_MORE },
-	{ "SKILL_DEFEND_BONUS_BOSS_OR_MORE", APPLY_SKILL_DEFEND_BONUS_BOSS_OR_MORE },
-	{ "NORMAL_HIT_DAMAGE_BONUS_BOSS_OR_MORE", APPLY_NORMAL_HIT_DAMAGE_BONUS_BOSS_OR_MORE },
-	{ "SKILL_DAMAGE_BONUS_BOSS_OR_MORE", APPLY_SKILL_DAMAGE_BONUS_BOSS_OR_MORE },
-
-	{ "HIT_BUFF_ENCHANT_FIRE", APPLY_HIT_BUFF_ENCHANT_FIRE },
-	{ "HIT_BUFF_ENCHANT_ICE", APPLY_HIT_BUFF_ENCHANT_ICE },
-	{ "HIT_BUFF_ENCHANT_ELEC", APPLY_HIT_BUFF_ENCHANT_ELEC },
-	{ "HIT_BUFF_ENCHANT_WIND", APPLY_HIT_BUFF_ENCHANT_WIND },
-	{ "HIT_BUFF_ENCHANT_DARK", APPLY_HIT_BUFF_ENCHANT_DARK },
-	{ "HIT_BUFF_ENCHANT_EARTH", APPLY_HIT_BUFF_ENCHANT_EARTH },
-	{ "HIT_BUFF_RESIST_FIRE", APPLY_HIT_BUFF_RESIST_FIRE },
-	{ "HIT_BUFF_RESIST_ICE", APPLY_HIT_BUFF_RESIST_ICE },
-	{ "HIT_BUFF_RESIST_ELEC", APPLY_HIT_BUFF_RESIST_ELEC },
-	{ "HIT_BUFF_RESIST_WIND", APPLY_HIT_BUFF_RESIST_WIND },
-	{ "HIT_BUFF_RESIST_DARK", APPLY_HIT_BUFF_RESIST_DARK },
-	{ "HIT_BUFF_RESIST_EARTH", APPLY_HIT_BUFF_RESIST_EARTH },
-
-	{ "USE_SKILL_CHEONGRANG_MOV_SPEED", APPLY_USE_SKILL_CHEONGRANG_MOV_SPEED },
-	{ "USE_SKILL_CHEONGRANG_CASTING_SPEED", APPLY_USE_SKILL_CHEONGRANG_CASTING_SPEED },
-	{ "USE_SKILL_CHAYEOL_CRITICAL_PCT", APPLY_USE_SKILL_CHAYEOL_CRITICAL_PCT },
-	{ "USE_SKILL_SANGONG_ATT_GRADE_BONUS", APPLY_USE_SKILL_SANGONG_ATT_GRADE_BONUS },
-	{ "USE_SKILL_GIGUNG_ATT_GRADE_BONUS", APPLY_USE_SKILL_GIGUNG_ATT_GRADE_BONUS },
-	{ "USE_SKILL_JEOKRANG_DEF_BONUS", APPLY_USE_SKILL_JEOKRANG_DEF_BONUS },
-	{ "USE_SKILL_GWIGEOM_DEF_BONUS", APPLY_USE_SKILL_GWIGEOM_DEF_BONUS },
-	{ "USE_SKILL_TERROR_ATT_GRADE_BONUS", APPLY_USE_SKILL_TERROR_ATT_GRADE_BONUS },
-	{ "USE_SKILL_MUYEONG_ATT_GRADE_BONUS", APPLY_USE_SKILL_MUYEONG_ATT_GRADE_BONUS },
-	{ "USE_SKILL_MANASHILED_CASTING_SPEED", APPLY_USE_SKILL_MANASHILED_CASTING_SPEED },
-	{ "USE_SKILL_HOSIN_DEF_BONUS", APPLY_USE_SKILL_HOSIN_DEF_BONUS },
-	{ "USE_SKILL_GICHEON_ATT_GRADE_BONUS", APPLY_USE_SKILL_GICHEON_ATT_GRADE_BONUS },
-	{ "USE_SKILL_JEONGEOP_ATT_GRADE_BONUS", APPLY_USE_SKILL_JEONGEOP_ATT_GRADE_BONUS },
-	{ "USE_SKILL_JEUNGRYEOK_DEF_BONUS", APPLY_USE_SKILL_JEUNGRYEOK_DEF_BONUS },
-	{ "USE_SKILL_GIHYEOL_ATT_GRADE_BONUS", APPLY_USE_SKILL_GIHYEOL_ATT_GRADE_BONUS },
-	{ "USE_SKILL_CHUNKEON_CASTING_SPEED", APPLY_USE_SKILL_CHUNKEON_CASTING_SPEED },
-	{ "USE_SKILL_NOEGEOM_ATT_GRADE_BONUS", APPLY_USE_SKILL_NOEGEOM_ATT_GRADE_BONUS },
-
-	{ "SKILL_DURATION_INCREASE_EUNHYUNG", APPLY_SKILL_DURATION_INCREASE_EUNHYUNG },
-	{ "SKILL_DURATION_INCREASE_GYEONGGONG", APPLY_SKILL_DURATION_INCREASE_GYEONGGONG },
-	{ "SKILL_DURATION_INCREASE_GEOMKYUNG", APPLY_SKILL_DURATION_INCREASE_GEOMKYUNG },
-	{ "SKILL_DURATION_INCREASE_JEOKRANG", APPLY_SKILL_DURATION_INCREASE_JEOKRANG },
-
-	{ "USE_SKILL_PALBANG_HP_ABSORB", APPLY_USE_SKILL_PALBANG_HP_ABSORB },
-	{ "USE_SKILL_AMSEOP_HP_ABSORB", APPLY_USE_SKILL_AMSEOP_HP_ABSORB },
-	{ "USE_SKILL_YEONSA_HP_ABSORB", APPLY_USE_SKILL_YEONSA_HP_ABSORB },
-	{ "USE_SKILL_YONGBI_HP_ABSORB", APPLY_USE_SKILL_YONGBI_HP_ABSORB },
-	{ "USE_SKILL_CHAIN_HP_ABSORB", APPLY_USE_SKILL_CHAIN_HP_ABSORB },
-	{ "USE_SKILL_PASWAE_SP_ABSORB", APPLY_USE_SKILL_PASWAE_SP_ABSORB },
-
-	{ "USE_SKILL_GIGONGCHAM_STUN", APPLY_USE_SKILL_GIGONGCHAM_STUN },
-	{ "USE_SKILL_CHARYUN_STUN", APPLY_USE_SKILL_CHARYUN_STUN },
-	{ "USE_SKILL_PABEOB_STUN", APPLY_USE_SKILL_PABEOB_STUN },
-	{ "USE_SKILL_MAHWAN_STUN", APPLY_USE_SKILL_MAHWAN_STUN },
-	{ "USE_SKILL_GONGDAB_STUN", APPLY_USE_SKILL_GONGDAB_STUN },
-	{ "USE_SKILL_SAMYEON_STUN", APPLY_USE_SKILL_SAMYEON_STUN },
-
-	{ "USE_SKILL_GYOKSAN_KNOCKBACK", APPLY_USE_SKILL_GYOKSAN_KNOCKBACK },
-	{ "USE_SKILL_SEOMJEON_KNOCKBACK", APPLY_USE_SKILL_SEOMJEON_KNOCKBACK },
-	{ "USE_SKILL_SWAERYUNG_KNOCKBACK", APPLY_USE_SKILL_SWAERYUNG_KNOCKBACK },
-	{ "USE_SKILL_HWAYEOMPOK_KNOCKBACK", APPLY_USE_SKILL_HWAYEOMPOK_KNOCKBACK },
-	{ "USE_SKILL_GONGDAB_KNOCKBACK", APPLY_USE_SKILL_GONGDAB_KNOCKBACK },
-	{ "USE_SKILL_KWANKYEOK_KNOCKBACK", APPLY_USE_SKILL_KWANKYEOK_KNOCKBACK },
-
-	{ "USE_SKILL_SAMYEON_NEXT_COOLTIME_DECREASE_10PER", APPLY_USE_SKILL_SAMYEON_NEXT_COOLTIME_DECREASE_10PER },
-	{ "USE_SKILL_GEOMPUNG_NEXT_COOLTIME_DECREASE_10PER", APPLY_USE_SKILL_GEOMPUNG_NEXT_COOLTIME_DECREASE_10PER },
-	{ "USE_SKILL_GUNGSIN_NEXT_COOLTIME_DECREASE_10PER", APPLY_USE_SKILL_GUNGSIN_NEXT_COOLTIME_DECREASE_10PER },
-	{ "USE_SKILL_KWANKYEOK_NEXT_COOLTIME_DECREASE_10PER", APPLY_USE_SKILL_KWANKYEOK_NEXT_COOLTIME_DECREASE_10PER },
-	{ "USE_SKILL_YONGKWON_NEXT_COOLTIME_DECREASE_10PER", APPLY_USE_SKILL_YONGKWON_NEXT_COOLTIME_DECREASE_10PER },
-	{ "USE_SKILL_MARYUNG_NEXT_COOLTIME_DECREASE_10PER", APPLY_USE_SKILL_MARYUNG_NEXT_COOLTIME_DECREASE_10PER },
-	{ "USE_SKILL_BIPABU_NEXT_COOLTIME_DECREASE_10PER", APPLY_USE_SKILL_BIPABU_NEXT_COOLTIME_DECREASE_10PER },
-	{ "USE_SKILL_NOEJEON_NEXT_COOLTIME_DECREASE_10PER", APPLY_USE_SKILL_NOEJEON_NEXT_COOLTIME_DECREASE_10PER },
-	{ "USE_SKILL_SALPOONG_NEXT_COOLTIME_DECREASE_10PER", APPLY_USE_SKILL_SALPOONG_NEXT_COOLTIME_DECREASE_10PER },
-	{ "USE_SKILL_PASWAE_NEXT_COOLTIME_DECREASE_10PER", APPLY_USE_SKILL_PASWAE_NEXT_COOLTIME_DECREASE_10PER },
-
-	{ "ATTBONUS_STONE", APPLY_ATTBONUS_STONE },
-
-	{ "DAMAGE_HP_RECOVERY", APPLY_DAMAGE_HP_RECOVERY },
-	{ "DAMAGE_SP_RECOVERY", APPLY_DAMAGE_SP_RECOVERY },
-
-	{ "ALIGNMENT_DAMAGE_BONUS", APPLY_ALIGNMENT_DAMAGE_BONUS },
-
-	{ "NORMAL_DAMAGE_GUARD", APPLY_NORMAL_DAMAGE_GUARD },
-	{ "MORE_THEN_HP90_DAMAGE_REDUCE", APPLY_MORE_THEN_HP90_DAMAGE_REDUCE },
-
-	{ "USE_SKILL_TUSOK_HP_ABSORB", APPLY_USE_SKILL_TUSOK_HP_ABSORB },
-	{ "USE_SKILL_PAERYONG_HP_ABSORB", APPLY_USE_SKILL_PAERYONG_HP_ABSORB },
-	{ "USE_SKILL_BYEURAK_HP_ABSORB", APPLY_USE_SKILL_BYEURAK_HP_ABSORB },
-
-	{ "FIRST_ATTRIBUTE_BONUS", APPLY_FIRST_ATTRIBUTE_BONUS },
-	{ "SECOND_ATTRIBUTE_BONUS", APPLY_SECOND_ATTRIBUTE_BONUS },
-	{ "THIRD_ATTRIBUTE_BONUS", APPLY_THIRD_ATTRIBUTE_BONUS },
-	{ "FOURTH_ATTRIBUTE_BONUS", APPLY_FOURTH_ATTRIBUTE_BONUS },
-	{ "FIFTH_ATTRIBUTE_BONUS", APPLY_FIFTH_ATTRIBUTE_BONUS },
-
-	{ "USE_SKILL_SAMYEON_NEXT_COOLTIME_DECREASE_20PER", APPLY_USE_SKILL_SAMYEON_NEXT_COOLTIME_DECREASE_20PER },
-	{ "USE_SKILL_GEOMPUNG_NEXT_COOLTIME_DECREASE_20PER", APPLY_USE_SKILL_GEOMPUNG_NEXT_COOLTIME_DECREASE_20PER },
-	{ "USE_SKILL_GUNGSIN_NEXT_COOLTIME_DECREASE_20PER", APPLY_USE_SKILL_GUNGSIN_NEXT_COOLTIME_DECREASE_20PER },
-	{ "USE_SKILL_KWANKYEOK_NEXT_COOLTIME_DECREASE_20PER", APPLY_USE_SKILL_KWANKYEOK_NEXT_COOLTIME_DECREASE_20PER },
-	{ "USE_SKILL_YONGKWON_NEXT_COOLTIME_DECREASE_20PER", APPLY_USE_SKILL_YONGKWON_NEXT_COOLTIME_DECREASE_20PER },
-	{ "USE_SKILL_MARYUNG_NEXT_COOLTIME_DECREASE_20PER", APPLY_USE_SKILL_MARYUNG_NEXT_COOLTIME_DECREASE_20PER },
-	{ "USE_SKILL_BIPABU_NEXT_COOLTIME_DECREASE_20PER", APPLY_USE_SKILL_BIPABU_NEXT_COOLTIME_DECREASE_20PER },
-	{ "USE_SKILL_NOEJEON_NEXT_COOLTIME_DECREASE_20PER", APPLY_USE_SKILL_NOEJEON_NEXT_COOLTIME_DECREASE_20PER },
-	{ "USE_SKILL_SALPOONG_NEXT_COOLTIME_DECREASE_20PER", APPLY_USE_SKILL_SALPOONG_NEXT_COOLTIME_DECREASE_20PER },
-	{ "USE_SKILL_PASWAE_NEXT_COOLTIME_DECREASE_20PER", APPLY_USE_SKILL_PASWAE_NEXT_COOLTIME_DECREASE_20PER },
-	{ "USE_SKILL_CHAYEOL_HP_ABSORB", APPLY_USE_SKILL_CHAYEOL_HP_ABSORB },
-
-	{ "SUNGMA_STR", APPLY_SUNGMA_STR },
-	{ "SUNGMA_HP", APPLY_SUNGMA_HP },
-	{ "SUNGMA_MOVE", APPLY_SUNGMA_MOVE },
-	{ "SUNGMA_IMMUNE", APPLY_SUNGMA_IMMUNE },
-
-	{ "HIT_PCT", APPLY_HIT_PCT },
-#if defined(__ITEM_APPLY_RANDOM__)
-	{ "RANDOM", APPLY_NONE },
 #endif
 
-	{ "ATTBONUS_PER_HUMAN", APPLY_ATTBONUS_PER_HUMAN },
-	{ "ATTBONUS_PER_ANIMAL", APPLY_ATTBONUS_PER_ANIMAL },
-	{ "ATTBONUS_PER_ORC", APPLY_ATTBONUS_PER_ORC },
-	{ "ATTBONUS_PER_MILGYO", APPLY_ATTBONUS_PER_MILGYO },
-	{ "ATTBONUS_PER_UNDEAD", APPLY_ATTBONUS_PER_UNDEAD },
-	{ "ATTBONUS_PER_DEVIL", APPLY_ATTBONUS_PER_DEVIL },
-
-	{ "ENCHANT_PER_ELECT", APPLY_ENCHANT_PER_ELECT },
-	{ "ENCHANT_PER_FIRE", APPLY_ENCHANT_PER_FIRE },
-	{ "ENCHANT_PER_ICE", APPLY_ENCHANT_PER_ICE },
-	{ "ENCHANT_PER_WIND", APPLY_ENCHANT_PER_WIND },
-	{ "ENCHANT_PER_EARTH", APPLY_ENCHANT_PER_EARTH },
-	{ "ENCHANT_PER_DARK", APPLY_ENCHANT_PER_DARK },
-
-	{ "ATTBONUS_PER_CZ", APPLY_ATTBONUS_PER_CZ },
-	{ "ATTBONUS_PER_INSECT", APPLY_ATTBONUS_PER_INSECT },
-	{ "ATTBONUS_PER_DESERT", APPLY_ATTBONUS_PER_DESERT },
-	{ "ATTBONUS_PER_STONE", APPLY_ATTBONUS_PER_STONE },
-	{ "ATTBONUS_PER_MONSTER", APPLY_ATTBONUS_PER_MONSTER },
-
-	{ "RESIST_PER_HUMAN", APPLY_RESIST_PER_HUMAN },
-	{ "RESIST_PER_ICE", APPLY_RESIST_PER_ICE },
-	{ "RESIST_PER_DARK", APPLY_RESIST_PER_DARK },
-	{ "RESIST_PER_EARTH", APPLY_RESIST_PER_EARTH },
-	{ "RESIST_PER_FIRE", APPLY_RESIST_PER_FIRE },
-	{ "RESIST_PER_ELEC", APPLY_RESIST_PER_ELEC },
-	{ "RESIST_PER_MAGIC", APPLY_RESIST_PER_MAGIC },
-	{ "RESIST_PER_WIND", APPLY_RESIST_PER_WIND },
-
-	{ "HIT_BUFF_SUNGMA_STR", APPLY_HIT_BUFF_SUNGMA_STR },
-	{ "HIT_BUFF_SUNGMA_MOVE", APPLY_HIT_BUFF_SUNGMA_MOVE },
-	{ "HIT_BUFF_SUNGMA_HP", APPLY_HIT_BUFF_SUNGMA_HP },
-	{ "HIT_BUFF_SUNGMA_IMMUNE", APPLY_HIT_BUFF_SUNGMA_IMMUNE },
-
-	{ "MOUNT_MELEE_MAGIC_ATTBONUS_PER", APPLY_MOUNT_MELEE_MAGIC_ATTBONUS_PER },
-	{ "DISMOUNT_MOVE_SPEED_BONUS_PER", APPLY_DISMOUNT_MOVE_SPEED_BONUS_PER },
-
-	{ "HIT_AUTO_HP_RECOVERY", APPLY_HIT_AUTO_HP_RECOVERY },
-	{ "HIT_AUTO_SP_RECOVERY", APPLY_HIT_AUTO_SP_RECOVERY },
-
-	{ "USE_SKILL_COOLTIME_DECREASE_ALL", APPLY_USE_SKILL_COOLTIME_DECREASE_ALL },
-
-	{ "HIT_STONE_ATTBONUS_STONE", APPLY_HIT_STONE_ATTBONUS_STONE },
-	{ "HIT_STONE_DEF_GRADE_BONUS", APPLY_HIT_STONE_DEF_GRADE_BONUS },
-
-	{ "KILL_BOSS_ITEM_BONUS", APPLY_KILL_BOSS_ITEM_BONUS },
-	{ "MOB_HIT_MOB_AGGRESSIVE", APPLY_MOB_HIT_MOB_AGGRESSIVE },
-	{ "NO_DEATH_AND_HP_RECOVERY30", APPLY_NO_DEATH_AND_HP_RECOVERY30 },
-
-	{ "AUTO_PICKUP", APPLY_AUTO_PICKUP },
-	{ "MOUNT_NO_KNOCKBACK", APPLY_MOUNT_NO_KNOCKBACK },
-
-	{ "SUNGMA_PER_STR", APPLY_SUNGMA_PER_STR },
-	{ "SUNGMA_PER_HP", APPLY_SUNGMA_PER_HP },
-	{ "SUNGMA_PER_MOVE", APPLY_SUNGMA_PER_MOVE },
-	{ "SUNGMA_PER_IMMUNE", APPLY_SUNGMA_PER_IMMUNE },
-
-	{ "IMMUNE_POISON100", APPLY_IMMUNE_POISON100 },
-	{ "IMMUNE_BLEEDING100", APPLY_IMMUNE_BLEEDING100 },
-
-	{ "MONSTER_DEFEND_BONUS", APPLY_MONSTER_DEFEND_BONUS },
+#if defined(__9TH_SKILL__)
+	{ "INVINCIBLE", APPLY_INVINCIBLE },
+#endif
 
 	// by mhh game/affect.h ǵǾ. INFINITE_AFFECT_DURATION = 0x1FFFFFFF
 	{ "INFINITE_AFFECT_DURATION", 0x1FFFFFFF },
 
-	// 20200806.Owsap : Old apply values support.
+	//< 2020.08.06.Owsap - Old apply values support.
 	{ "ATTACK_SPEED", APPLY_ATT_SPEED },
 	{ "MOVE_SPEED", APPLY_MOV_SPEED },
 	{ "ATT_BONUS", APPLY_ATT_GRADE_BONUS },
 	{ "DEF_BONUS", APPLY_DEF_GRADE_BONUS },
-	{ "ATT_BONUS_TO_WARRIOR", APPLY_ATTBONUS_WARRIOR },
-	{ "ATT_BONUS_TO_ASSASSIN", APPLY_ATTBONUS_ASSASSIN },
-	{ "ATT_BONUS_TO_SURA", APPLY_ATTBONUS_SURA },
-	{ "ATT_BONUS_TO_SHAMAN", APPLY_ATTBONUS_SHAMAN },
-	{ "ATT_BONUS_TO_WOLFMAN", APPLY_ATTBONUS_WOLFMAN },
+	{ "ATT_BONUS_TO_WARRIOR", APPLY_ATT_BONUS_TO_WARRIOR },
+	{ "ATT_BONUS_TO_ASSASSIN", APPLY_ATT_BONUS_TO_ASSASSIN },
+	{ "ATT_BONUS_TO_SURA", APPLY_ATT_BONUS_TO_SURA },
+	{ "ATT_BONUS_TO_SHAMAN", APPLY_ATT_BONUS_TO_SHAMAN },
+	{ "ATT_BONUS_TO_WOLFMAN", APPLY_ATT_BONUS_TO_WOLFMAN },
+	//>
 
 	{ NULL, 0 }
 };
@@ -1859,88 +1301,20 @@
 	return 0;
 }
 
-#if defined(__SOUL_SYSTEM__)
-const int soul_refine_prob[SOUL_GRADE_MAX + 1] = { 0, 60, 40, 20, 30, 15 };
-#endif
-
-#if defined(__EXTEND_INVEN_SYSTEM__)
-/*
-* By hard coding the required keys, the code becomes more readable
-* and maintainable, as anyone reading the code can immediately can
-* immediately see the requiremented keys for each stage.
-*/
-const BYTE abInvenStageKeys[EX_INVENTORY_STAGE_MAX] =
-{
-	// 90 - 135
-	2, 2, 2,
-	3, 3, 3,
-	4, 4, 4,
-	// 135 - 180
-	5, 5, 5,
-	6, 6, 6,
-	7, 7, 7
+#if defined(__EREBUS_DUNGEON__)
+DWORD dwHealerPos[4/*SUMMON_HEALER_COUNT*/][2] = {
+	// X, Y
+	{ 776500, 1503700 }, // Healer 1
+	{ 773100, 1503700 }, // Healer 2
+	{ 773200, 1500400 }, // Healer 3
+	{ 776500, 1500400 }, // Healer 4
 };
-#endif
 
-TEmotionInfoMap EmotionInfoMap
-{
-	{ EMOTION_NONE, { 0, 0.0f } },
-	{ EMOTION_CLAP, { EMOTION_FLAG_SELF, 2.66667f } },
-	{ EMOTION_CONGRATULATION, { EMOTION_FLAG_SELF, 6.33333f } },
-	{ EMOTION_FORGIVE, { EMOTION_FLAG_SELF, 8.33333f } },
-	{ EMOTION_ANGRY, { EMOTION_FLAG_SELF, 4.33333f } },
-	{ EMOTION_ATTRACTIVE, { EMOTION_FLAG_SELF, 4.83333f } },
-	{ EMOTION_SAD, { EMOTION_FLAG_SELF, 7.33333f } },
-	{ EMOTION_SHY, { EMOTION_FLAG_SELF, 4.66667f } },
-	{ EMOTION_CHEERUP, { EMOTION_FLAG_SELF, 5.0f } },
-	{ EMOTION_BANTER, { EMOTION_FLAG_SELF, 7.0f } },
-	{ EMOTION_JOY, { EMOTION_FLAG_SELF, 5.33333f } },
-	{ EMOTION_CHEERS_1, { EMOTION_FLAG_SELF, 2.33333f } },
-	{ EMOTION_CHEERS_2, { EMOTION_FLAG_SELF, 2.33333f } },
-	{ EMOTION_DANCE_1, { EMOTION_FLAG_SELF, 28.3333f } },
-	{ EMOTION_DANCE_2, { EMOTION_FLAG_SELF, 4.76667f } },
-	{ EMOTION_DANCE_3, { EMOTION_FLAG_SELF, 27.3333f } },
-	{ EMOTION_DANCE_4, { EMOTION_FLAG_SELF, 30.3333f } },
-	{ EMOTION_DANCE_5, { EMOTION_FLAG_SELF, 21.1f } },
-	{ EMOTION_DANCE_6, { EMOTION_FLAG_SELF, 30.433332f } },
-	{ EMOTION_KISS, { EMOTION_FLAG_TARGET | EMOTION_FLAG_OTHER_SEX, 1.5f } },
-	{ EMOTION_FRENCH_KISS, { EMOTION_FLAG_TARGET | EMOTION_FLAG_OTHER_SEX, 4.0f } },
-	{ EMOTION_SLAP, { EMOTION_FLAG_TARGET, 2.0f } },
-#if defined(__EXPRESSING_EMOTIONS__)
-	{ EMOTION_PUSH_UP, { EMOTION_FLAG_SELF, 6.666667f } },
-	{ EMOTION_DANCE_7, { EMOTION_FLAG_SELF, 12.0f } },
-	{ EMOTION_EXERCISE, { EMOTION_FLAG_SELF, 6.333333f } },
-	{ EMOTION_DOZE, { EMOTION_FLAG_SELF, 4.666667f } },
-	{ EMOTION_SELFIE, { EMOTION_FLAG_SELF, 3.000000f } },
-	{ EMOTION_CHARGING, { EMOTION_FLAG_SELF, 0.0f } },
-	{ EMOTION_NOSAY, { EMOTION_FLAG_SELF, 0.0f } },
-	{ EMOTION_WEATHER_1, { EMOTION_FLAG_SELF, 0.0f } },
-	{ EMOTION_WEATHER_2, { EMOTION_FLAG_SELF, 0.0f } },
-	{ EMOTION_WEATHER_3, { EMOTION_FLAG_SELF, 0.0f } },
-	{ EMOTION_HUNGRY, { EMOTION_FLAG_SELF, 0.0f } },
-	{ EMOTION_SIREN, { EMOTION_FLAG_SELF, 0.0f } },
-	{ EMOTION_LETTER, { EMOTION_FLAG_SELF, 0.0f } },
-	{ EMOTION_CALL, { EMOTION_FLAG_SELF, 0.0f } },
-	{ EMOTION_CELEBRATION, { EMOTION_FLAG_SELF, 0.0f } },
-	{ EMOTION_ALCOHOL, { EMOTION_FLAG_SELF, 0.0f } },
-	{ EMOTION_BUSY, { EMOTION_FLAG_SELF, 0.0f } },
-	{ EMOTION_WHIRL, { EMOTION_FLAG_SELF, 0.0f } },
-#endif
-};
-
-#if defined(__HIDE_COSTUME_SYSTEM__)
-THiddenCostumePartMap HiddenCostumePartMap
-{
-	{ COSTUME_BODY, "costume_option.hide_body" },
-	{ COSTUME_HAIR, "costume_option.hide_hair" },
-#if defined(__ACCE_COSTUME_SYSTEM__)
-	{ COSTUME_ACCE, "costume_option.hide_acce" },
-#endif
-#if defined(__WEAPON_COSTUME_SYSTEM__)
-	{ COSTUME_WEAPON, "costume_option.hide_weapon" },
-#endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-	{ COSTUME_AURA, "costume_option.hide_aura" },
-#endif
+ErebusHealers vErebusHealers = {
+	// HP, SP
+	{ 75, 4 },
+	{ 50, 3 },
+	{ 25, 2 },
+	{ 2, 1 },
 };
 #endif
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/constants.h final/server/server/home/metin2/Source/Server/game/src/constants.h
--- baseline/server/server/home/metin2/Source/Server/game/src/constants.h	2025-06-28 20:31:54.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/constants.h	2022-04-27 12:20:36.000000000 +0000
@@ -51,8 +51,7 @@
 
 typedef struct SApplyInfo
 {
-	POINT_TYPE wApplyType; // APPLY -> POINT
-	POINT_TYPE wPointType;
+	BYTE bPointType; // APPLY -> POINT
 } TApplyInfo;
 
 enum {
@@ -66,7 +65,7 @@
 	FORTUNE_MAX_NUM,
 };
 
-const int STONE_INFO_MAX_NUM = 22;
+const int STONE_INFO_MAX_NUM = 10;
 const int STONE_LEVEL_MAX_NUM = 4;
 
 struct SStoneDropInfo
@@ -100,15 +99,13 @@
 
 extern const DWORD exp_table_euckr[PLAYER_EXP_TABLE_MAX + 1];
 extern const DWORD exp_table_common[PLAYER_EXP_TABLE_MAX + 1];
+#if defined(__CONQUEROR_LEVEL__)
+extern const DWORD conqueror_exp_table[PLAYER_CONQUEROR_EXP_TABLE_MAX + 1];
+#endif
 extern const DWORD exp_table_newcibn[PLAYER_EXP_TABLE_MAX + 1];
 
 extern const DWORD* exp_table;
 
-#if defined(__CONQUEROR_LEVEL__)
-extern const DWORD* conqueror_exp_table;
-extern const DWORD conqueror_exp_table_common[PLAYER_CONQUEROR_EXP_TABLE_MAX + 1];
-#endif
-
 extern const DWORD guild_exp_table[GUILD_MAX_LEVEL + 1];
 extern const DWORD guild_exp_table2[GUILD_MAX_LEVEL + 1];
 
@@ -116,7 +113,6 @@
 #define PERCENT_LVDELTA(me, victim) aiPercentByDeltaLev[MINMAX(0, (victim + 15) - me, MAX_EXP_DELTA_OF_LEV - 1)]
 #define PERCENT_LVDELTA_BOSS(me, victim) aiPercentByDeltaLevForBoss[MINMAX(0, (victim + 15) - me, MAX_EXP_DELTA_OF_LEV - 1)]
 #define CALCULATE_VALUE_LVDELTA(me, victim, val) ((val * PERCENT_LVDELTA(me, victim)) / 100)
-
 extern const int aiPercentByDeltaLev_euckr[MAX_EXP_DELTA_OF_LEV];
 extern const int aiPercentByDeltaLevForBoss_euckr[MAX_EXP_DELTA_OF_LEV];
 extern const int* aiPercentByDeltaLev;
@@ -143,22 +139,12 @@
 extern const int aiArmorSocketQty[ARMOR_NUM_TYPES];
 extern const int aiSocketPercentByQty[5][4];
 
-#if defined(__AURA_COSTUME_SYSTEM__)
-extern const int s_aiAuraRefineTable[AURA_GRADE_MAX_NUM][AURA_REFINE_INFO_MAX];
-extern const int* GetAuraRefineInfo(BYTE bLevel);
-extern const int GetAuraRefineInfo(BYTE bGrade, BYTE bInfo);
-#endif
-
 extern const int aiExpLossPercents[PLAYER_EXP_TABLE_MAX + 1];
 
 extern const int* aiSkillPowerByLevel;
 extern const int aiSkillPowerByLevel_euckr[SKILL_MAX_LEVEL + 1];
 
 extern const int aiPolymorphPowerByLevel[SKILL_MAX_LEVEL + 1];
-#if defined(__PARTY_PROFICY__)
-extern const int aiProficiencyPowerByLevel[SKILL_MAX_LEVEL + 1];
-#endif
-extern const int aiPrecisionPowerByLevel[SKILL_MAX_LEVEL + 1];
 
 extern const int aiSkillBookCountForLevelUp[10];
 extern const int aiGrandMasterSkillBookCountForLevelUp[10];
@@ -201,33 +187,11 @@
 extern const int aiAccessorySocketEffectivePct[ITEM_ACCESSORY_SOCKET_MAX_NUM + 1];
 extern const int aiAccessorySocketDegradeTime[ITEM_ACCESSORY_SOCKET_MAX_NUM + 1];
 extern const int aiAccessorySocketPutPct[ITEM_ACCESSORY_SOCKET_MAX_NUM + 1];
-// END_OF_ACCESSORY_REFINE
-
-#if defined(__ACCE_COSTUME_SYSTEM__)
-extern const int aiAcceDrainRateAdvancePct[ACCE_MAX_DRAINRATE + 1];
-#endif
-
 long FN_get_apply_type(const char* apply_type_string);
 
-#if defined(__SOUL_SYSTEM__)
-extern const int soul_refine_prob[SOUL_GRADE_MAX + 1];
-#endif
-
-#if defined(__EXTEND_INVEN_SYSTEM__)
-extern const BYTE abInvenStageKeys[EX_INVENTORY_STAGE_MAX];
-#endif
+// END_OF_ACCESSORY_REFINE
 
-typedef struct SEmotionInfo
-{
-	DWORD dwFlag; float fDelay;
-} TEmotionInfo;
-typedef std::unordered_map<WORD, TEmotionInfo> TEmotionInfoMap;
-extern TEmotionInfoMap EmotionInfoMap;
-
-#if defined(__HIDE_COSTUME_SYSTEM__)
-typedef std::map<BYTE, std::string> THiddenCostumePartMap;
-extern THiddenCostumePartMap HiddenCostumePartMap;
-#endif
+long FN_get_apply_type(const char* apply_type_string);
 
 #ifdef __GROWTH_PET_SYSTEM__
 #include "growth_pet.h"
@@ -259,4 +223,32 @@
 extern const TPetBonus arPetDefBonusTable[PET_MAX_BONUS_NUM];
 #endif
 
+#if defined(__EREBUS_DUNGEON__)
+#include <unordered_map>
+struct SErebusHealers
+{
+	int iHealthPCT;
+	int iStaminaPCT;
+};
+using ErebusHealers = std::vector<SErebusHealers>;
+extern ErebusHealers vErebusHealers;
+extern DWORD dwHealerPos[4/*SUMMON_HEALER_COUNT*/][2];
+#endif
+
+#if defined(__CONQUEROR_LEVEL__)
+typedef struct SApplyRandomPaths
+{
+	int index;
+	int type;
+	int lv[15];
+} TApplyRandomPaths;
+
+struct SSungMaWill
+{
+	uint8_t str, hp, move, immune;
+};
+typedef std::unordered_map<int32_t, SSungMaWill> TSungMaWillMap;
+extern TSungMaWillMap SungMaWillMap;
+#endif
+
 #endif // __INC_CONSTANTS_H__
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/cube.cpp final/server/server/home/metin2/Source/Server/game/src/cube.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/cube.cpp	2026-02-17 15:33:28.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/cube.cpp	2022-04-27 12:20:43.000000000 +0000
@@ -1,538 +1,3 @@
-#include "stdafx.h"
-
-#if defined(__CUBE_RENEWAL__)
-/**
-* Filename: cube.cpp
-* Author: Owsap
-**/
-
-#include "cube.h"
-#include "char.h"
-#include "item.h"
-#include "desc.h"
-#include "locale_service.h"
-#include "utils.h"
-#if defined(__QUEST_EVENT_CRAFT__)
-#	include "questmanager.h"
-#endif
-
-#include <fstream>
-#include <cryptopp/crc.h>
-#include <cryptopp/files.h>
-#include <cryptopp/filters.h>
-
-CCubeManager::CCubeManager()
-{
-	m_vCubeData.clear();
-	m_dwFileCrc = 0;
-}
-
-CCubeManager::~CCubeManager()
-{
-	m_vCubeData.clear();
-	m_dwFileCrc = 0;
-}
-
-void CCubeManager::Initialize()
-{
-	char szCubeFileTable[256 + 1];
-	snprintf(szCubeFileTable, sizeof(szCubeFileTable), "%s/cube.txt", LocaleService_GetBasePath().c_str());
-
-	LoadCubeTable(szCubeFileTable);
-	sys_log(0, "cube: initialize");
-}
-
-void CCubeManager::LoadCubeTable(const char* szFileName)
-{
-	m_vCubeData.clear();
-
-	std::ifstream ifStream(szFileName);
-	if (!ifStream.is_open())
-	{
-		sys_err("cube: load cube table error: failed to open %s", szFileName);
-		return;
-	}
-
-	{
-		CryptoPP::CRC32 Crc32;
-		CryptoPP::byte szBuffer[4096];
-
-		std::ifstream ifStream(szFileName, std::ios::binary);
-		while (!ifStream.eof())
-		{
-			ifStream.read(reinterpret_cast<char*>(szBuffer), sizeof(szBuffer));
-			Crc32.Update(szBuffer, ifStream.gcount());
-		}
-
-		CryptoPP::byte bDigest[CryptoPP::CRC32::DIGESTSIZE];
-		Crc32.Final(bDigest);
-
-		m_dwFileCrc = *reinterpret_cast<DWORD*>(bDigest);
-	}
-
-	CubeDataPtr pCubeData = nullptr;
-	SCubeValue CubeValue = { 0, 0 };
-	UINT iCubeIndex = 0;
-
-	std::string stLine;
-	while (std::getline(ifStream, stLine))
-	{
-		if (stLine.empty() || stLine[0] == '#')
-			continue;
-
-		std::istringstream isStream(stLine);
-		std::string stToken;
-		isStream >> stToken;
-
-		if (stToken == "section")
-			pCubeData = std::make_unique<SCubeData>();
-		else if (stToken == "npc")
-			isStream >> pCubeData->dwNPCVnum;
-		else if (stToken == "item")
-		{
-			isStream >> CubeValue.dwVnum >> CubeValue.iCount;
-			pCubeData->vItem.emplace_back(CubeValue);
-		}
-		else if (stToken == "reward")
-		{
-			isStream >> CubeValue.dwVnum >> CubeValue.iCount;
-			pCubeData->Reward = CubeValue;
-		}
-		else if (stToken == "percent")
-			isStream >> pCubeData->iPercent;
-		else if (stToken == "gold")
-			isStream >> pCubeData->iGold;
-		else if (stToken == "gem")
-			isStream >> pCubeData->iGem;
-#if defined(__SET_ITEM__)
-		else if (stToken == "set_value")
-			isStream >> pCubeData->iSetValue;
-		else if (stToken == "not_remove")
-			isStream >> pCubeData->dwNotRemove;
-#endif
-		else if (stToken == "category")
-		{
-			std::string stCategory;
-			isStream >> stCategory;
-			pCubeData->iCategory = GetCubeCategory(stCategory);
-		}
-		else if (stToken == "subcategory")
-			isStream >> pCubeData->iSubCategory;
-		else if (stToken == "end")
-		{
-			if (pCubeData && CheckCubeData(pCubeData))
-			{
-				pCubeData->iIndex = ++iCubeIndex;
-				m_vCubeData.emplace_back(std::move(pCubeData));
-			}
-			else
-			{
-				pCubeData.reset();
-				continue;
-			}
-		}
-	}
-
-	ifStream.close();
-}
-
-bool CCubeManager::CheckCubeData(const CubeDataPtr& pkCubeData)
-{
-	std::size_t dwIndex = 0;
-	std::size_t dwEndIndex = 0;
-
-	if (pkCubeData->dwNPCVnum == 0)
-		return false;
-
-	dwEndIndex = pkCubeData->vItem.size();
-	for (dwIndex = 0; dwIndex < dwEndIndex; ++dwIndex)
-	{
-		if (pkCubeData->vItem[dwIndex].dwVnum == 0)
-			return false;
-
-		if (pkCubeData->vItem[dwIndex].iCount == 0)
-			return false;
-	}
-
-	if (pkCubeData->Reward.dwVnum == 0)
-		return false;
-
-	if (pkCubeData->Reward.iCount == 0)
-		return false;
-
-	return true;
-}
-
-const CCubeManager::SCubeData& CCubeManager::GetCubeData(const DWORD dwNPCVnum, const UINT iCubeIndex)
-{
-	for (const CubeDataPtr& pkCubeData : m_vCubeData)
-	{
-		if (pkCubeData->dwNPCVnum == dwNPCVnum && pkCubeData->iIndex == iCubeIndex)
-			return *pkCubeData;
-	}
-	throw std::runtime_error("cube data not found");
-}
-
-bool CCubeManager::CheckValidNPC(const DWORD dwNPCVnum)
-{
-	for (const CubeDataPtr& pkCubeData : m_vCubeData)
-	{
-		if (pkCubeData->dwNPCVnum == dwNPCVnum)
-			return true;
-	}
-	return false;
-}
-
-void CCubeManager::OpenCube(const LPCHARACTER pChar)
-{
-	if (pChar == nullptr)
-		return;
-
-	const LPDESC pDesc = pChar->GetDesc();
-	if (pDesc == nullptr)
-		return;
-
-	if (pChar->IsCubeOpen())
-		return;
-
-	const LPCHARACTER pNPC = pChar->GetQuestNPC();
-	if (pNPC == nullptr)
-	{
-		if (test_server)
-			sys_log(0, "cube: ch %s error: cannot find quest npc", pChar->GetName());
-		return;
-	}
-
-	if (CheckValidNPC(pNPC->GetRaceNum()) == false)
-	{
-		if (test_server)
-		{
-			sys_log(0, "cube: npc %d ch %s error: cannot find cube for npc",
-				pNPC->GetRaceNum(), pChar->GetName());
-		}
-		return;
-	}
-
-	if (pChar->PreventTradeWindow(WND_CUBE, true/*except*/))
-	{
-		pChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ٸ ŷϰ λ  ϴ."));
-		return;
-	}
-
-	if (pChar->IsCubeOpen())
-	{
-		pChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING("â  ʽϴ"));
-		return;
-	}
-
-	int iDistance = DISTANCE_APPROX(pChar->GetX() - pNPC->GetX(), pChar->GetY() - pNPC->GetY());
-	if (iDistance >= CUBE_MAX_DISTANCE)
-	{
-		sys_log(0, "cube: npc %d ch %s distance %d error: too far to open",
-			pNPC->GetRaceNum(), pChar->GetName(), iDistance);
-		return;
-	}
-
-	pChar->SetCubeNpc(pNPC);
-	Process(pChar->GetDesc(), SUBHEADER_GC_CUBE_OPEN, pNPC->GetRaceNum());
-}
-
-void CCubeManager::CloseCube(const LPCHARACTER pChar)
-{
-	if (pChar->IsCubeOpen())
-		pChar->SetCubeNpc(nullptr);
-}
-
-std::vector<TItemData> GenerateRewardItems(const CCubeManager::SCubeData& pkCube, const LPCHARACTER pChar, const INT iMultiplier)
-{
-	std::vector<TItemData> vRewardItem;
-	for (INT iCount = 0; iCount < pkCube.Reward.iCount * iMultiplier;)
-	{
-		const TItemTable* pItemTable = ITEM_MANAGER::Instance().GetTable(pkCube.Reward.dwVnum);
-		if (!pItemTable)
-		{
-			sys_log(0, "cube: npc %d index(%d) ch %s error: failed to create item",
-				pkCube.dwNPCVnum, pkCube.iIndex, pChar->GetName());
-			throw std::runtime_error("failed to get item table");
-		}
-
-		TItemData ItemData;
-		ItemData.dwVnum = pItemTable->dwVnum;
-
-		if (IS_SET(pItemTable->dwFlags, ITEM_FLAG_STACKABLE))
-		{
-			ItemData.dwCount = MIN(ITEM_MAX_COUNT, pkCube.Reward.iCount * iMultiplier - iCount);
-			iCount += ItemData.dwCount;
-		}
-		else
-		{
-			ItemData.dwCount = 1;
-			iCount += 1;
-		}
-
-		vRewardItem.emplace_back(ItemData);
-	}
-
-	return vRewardItem;
-}
-
-void CCubeManager::MakeCube(const LPCHARACTER pChar, const UINT iCubeIndex, INT iMultiplier, const INT iImproveItemPos)
-{
-	if (pChar->IsCubeOpen() == false)
-		return;
-
-	const LPCHARACTER pNPC = pChar->GetCubeNpc();
-	if (pNPC == nullptr)
-		return;
-
-	// [Security] Re-validate proximity to the cube NPC on every craft (prevents remote crafting via packet injection)
-	if (pNPC->GetMapIndex() != pChar->GetMapIndex())
-	{
-		CCubeManager::Instance().CloseCube(pChar);
-		return;
-	}
-
-	const int kMaxCubeDistance = 500;
-	if (DISTANCE_APPROX(pChar->GetX() - pNPC->GetX(), pChar->GetY() - pNPC->GetY()) > kMaxCubeDistance)
-	{
-		pChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You are too far away from the crafting NPC."));
-		CCubeManager::Instance().CloseCube(pChar);
-		return;
-	}
-
-	try
-	{
-		const SCubeData& pkCube = GetCubeData(pNPC->GetRaceNum(), iCubeIndex);
-
-#if defined(__SET_ITEM__)
-		if (IsCubeSetAddCategory(pkCube.iCategory) && pkCube.iSetValue)
-		{
-			if (iMultiplier != 1)
-			{
-				sys_log(0, "cube: npc %d index(%d) ch %s warning: cannot craft multiple set items",
-					pkCube.dwNPCVnum, pkCube.iIndex, pChar->GetName());
-			}
-			iMultiplier = 1;
-		}
-#endif
-
-		if (pChar->GetGold() < pkCube.iGold * iMultiplier)
-		{
-			pChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You don't have enough Yang."));
-			return;
-		}
-
-		if (pChar->GetGem() < pkCube.iGem * iMultiplier)
-		{
-			pChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You don't have enough Gaya."));
-			return;
-		}
-
-		for (const SCubeValue& kMaterial : pkCube.vItem)
-		{
-			INT iCount = pChar->CountSpecifyItem(kMaterial.dwVnum, -1
-#if defined(__SOUL_BIND_SYSTEM__)
-				, true /* bIgnoreSealedItem */
-#endif
-#if defined(__SET_ITEM__)
-				, pkCube.iSetValue ? true : false /* bIgnoreSetValue */
-#endif
-			);
-
-			INT iMaterialCount = MINMAX(1, kMaterial.iCount * iMultiplier, CUBE_MAX_MATERIAL_QUANTITY);
-			if (iCount < iMaterialCount)
-			{
-				pChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You have insufficient materials for the upgrade. (Soulbound items cannot be used.)"));
-				return;
-			}
-		}
-
-		std::vector<TItemData> vRewardItem = GenerateRewardItems(pkCube, pChar, iMultiplier);
-		if (vRewardItem.empty())
-		{
-			sys_log(0, "cube: npc %d index(%d) ch %s error: failed to generate reward item",
-				pkCube.dwNPCVnum, pkCube.iIndex, pChar->GetName());
-			return;
-		}
-
-		if (pChar->HasEnoughInventorySpace(vRewardItem) == false)
-		{
-			pChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING("There isn't enough space in your inventory."));
-			sys_log(0, "cube: npc %d index(%d) ch %s error: no inventory space reward",
-				pNPC->GetRaceNum(), iCubeIndex, pChar->GetName());
-			return;
-		}
-
-		LPITEM pNotRemoveItem = nullptr;
-		for (const SCubeValue& kMaterial : pkCube.vItem)
-		{
-			if (pkCube.dwNotRemove == kMaterial.dwVnum)
-			{
-				pNotRemoveItem = pChar->FindSpecifyItem(pkCube.dwNotRemove
-#if defined(__SOUL_BIND_SYSTEM__)
-					, true /* bIgnoreSealedItem */
-#endif
-#if defined(__SET_ITEM__)
-					, pkCube.iSetValue ? true : false /* bIgnoreSetValue */
-#endif
-				);
-				continue;
-			}
-
-			INT iMaterialCount = MINMAX(1, kMaterial.iCount * iMultiplier, CUBE_MAX_MATERIAL_QUANTITY);
-			pChar->RemoveSpecifyItem(kMaterial.dwVnum, iMaterialCount, -1
-#if defined(__SOUL_BIND_SYSTEM__)
-				, true /* bIgnoreSealedItem */
-#endif
-#if defined(__SET_ITEM__)
-				, pkCube.iSetValue ? true : false /* bIgnoreSetValue */
-#endif
-			);
-		}
-
-		if (pkCube.iGold > 0)
-			pChar->PointChange(POINT_GOLD, -(pkCube.iGold * iMultiplier), false);
-
-		if (pkCube.iGem > 0)
-			pChar->PointChange(POINT_GEM, -(pkCube.iGem * iMultiplier), false);
-
-		INT iImprovePercent = 0;
-		LPITEM pImproveItem = nullptr;
-		if (iImproveItemPos != -1)
-		{
-			pImproveItem = pChar->GetItem(TItemPos(INVENTORY, iImproveItemPos));
-			if (pImproveItem && pkCube.iPercent < 100)
-			{
-				if (pImproveItem->GetSubType() == pkCube.iCategory)
-				{
-					if (pImproveItem->GetCount() < iMultiplier)
-					{
-						sys_log(0, "cube: npc %d index(%d) ch %s error: not enough catalyst for multiplier",
-							pNPC->GetRaceNum(), iCubeIndex, pChar->GetName());
-						return;
-					}
-
-					iImprovePercent = pImproveItem->GetValue(0);
-					pImproveItem->SetCount(pImproveItem->GetCount() - iMultiplier);
-
-					if (test_server)
-						pChar->ChatPacket(CHAT_TYPE_INFO, "cube using catalyst pct %d total success pct %d",
-							iImprovePercent, pkCube.iPercent + iImprovePercent);
-				}
-				else
-				{
-					sys_log(0, "cube: npc %d index(%d) ch %s (possible cheat) error: using catalyst wrong category",
-						pNPC->GetRaceNum(), iCubeIndex, pChar->GetName());
-				}
-			}
-		}
-
-#if defined(__QUEST_EVENT_CRAFT__)
-		LPITEM pLastRewardItem = nullptr;
-#endif
-		for (const TItemData& kRewardItem : vRewardItem)
-		{
-			BYTE bPercent = number(1, 100);
-			if (bPercent > pkCube.iPercent + iImprovePercent)
-			{
-				Process(pChar->GetDesc(), SUBHEADER_GC_CUBE_RESULT, 0, false);
-				continue;
-			}
-
-			LPITEM pRewardItem = ITEM_MANAGER::Instance().CreateItem(kRewardItem.dwVnum, kRewardItem.dwCount);
-			if (pRewardItem == nullptr)
-				continue;
-
-			if (pRewardItem->GetVnum() == pkCube.dwNotRemove)
-			{
-				if (pNotRemoveItem == nullptr)
-				{
-					sys_log(0, "cube: npc %d index(%d) ch %s (possible cheat) error: cannot find material %d",
-						pNPC->GetRaceNum(), iCubeIndex, pChar->GetName(), pkCube.dwNotRemove);
-					continue;
-				}
-
-				ITEM_MANAGER::CopyAllAttrTo(pNotRemoveItem, pRewardItem);
-#if defined(__ITEM_APPLY_RANDOM__)
-				TPlayerItemAttribute aApplyRandom[ITEM_APPLY_MAX_NUM];
-				pNotRemoveItem->GetRandomApplyTable(aApplyRandom, CApplyRandomTable::GET_CURRENT);
-				if (aApplyRandom)
-					pRewardItem->SetRandomApplies(aApplyRandom);
-#endif
-#if defined(__SET_ITEM__)
-				pRewardItem->SetItemSetValue(pkCube.iSetValue);
-#endif
-				ITEM_MANAGER::instance().RemoveItem(pNotRemoveItem, "CUBE COPY");
-			}
-			else
-			{
-				// NOTE : Removes the `not_remove` item if the craft succeeds.
-				// This condition is only true if `reward` != `not_remove`.
-				if (pNotRemoveItem != nullptr)
-					ITEM_MANAGER::instance().RemoveItem(pNotRemoveItem, "CUBE");
-			}
-
-#if defined(__WJ_PICKUP_ITEM_EFFECT__)
-			pChar->AutoGiveItem(pRewardItem, false, true, true);
-#else
-			pChar->AutoGiveItem(pRewardItem);
-#endif
-
-#if defined(__QUEST_EVENT_CRAFT__)
-			pLastRewardItem = pRewardItem;
-#endif
-
-			Process(pChar->GetDesc(), SUBHEADER_GC_CUBE_RESULT, 0, true);
-		}
-
-#if defined(__QUEST_EVENT_CRAFT__)
-		if (pLastRewardItem != nullptr)
-		{
-			pChar->SetQuestNPCID(pNPC->GetVID());
-			quest::CQuestManager::instance().CraftItem(pChar->GetPlayerID(), pNPC->GetRaceNum(), pLastRewardItem);
-		}
-#endif
-	}
-	catch (const std::runtime_error& kError)
-	{
-		sys_err("cube: npc %d index(%d) ch %s error: %s",
-			pNPC->GetRaceNum(), iCubeIndex, pChar->GetName(), kError.what());
-		return;
-	}
-}
-
-void CCubeManager::Process(LPDESC pDesc, BYTE bSubHeader, DWORD dwNPCVnum, bool bSuccess)
-{
-	if (pDesc)
-	{
-		TPacketGCCube Packet;
-		Packet.bHeader = HEADER_GC_CUBE;
-		Packet.bSubHeader = bSubHeader;
-		Packet.dwNPCVnum = dwNPCVnum;
-		Packet.bSuccess = bSuccess;
-		Packet.dwFileCrc = m_dwFileCrc;
-		pDesc->Packet(&Packet, sizeof(TPacketGCCube));
-	}
-}
-
-bool CCubeManager::IsCubeSetAddCategory(const BYTE bCategory) const
-{
-	switch (bCategory)
-	{
-		case CUBE_SETADD_WEAPON:
-		case CUBE_SETADD_ARMOR_BODY:
-		case CUBE_SETADD_ARMOR_HELMET:
-			return true;
-	}
-	return false;
-}
-
-INT CCubeManager::GetCubeCategory(const std::string& rkCategory) const
-{
-	CategoryNameMap::const_iterator it = g_map_CubeCategoryName.find(rkCategory);
-	return (it != g_map_CubeCategoryName.end() ? it->second : -1);
-}
-#else
 /**
 * File : cube.cpp
 * Date : 2006.11.20
@@ -540,6 +5,7 @@
 * Description :
 **/
 
+#include "stdafx.h"
 #include "constants.h"
 #include "utils.h"
 #include "log.h"
@@ -548,9 +14,6 @@
 #include "locale_service.h"
 #include "item.h"
 #include "item_manager.h"
-#if defined(__QUEST_EVENT_CRAFT__)
-#	include "questmanager.h"
-#endif
 
 #include <sstream>
 
@@ -608,8 +71,8 @@
 
 // ڷᱸ ̷ ΰ ...  ȥ  ¿ 
 typedef std::vector<SCubeMaterialInfo> TCubeResultList;
-typedef std::unordered_map<DWORD, TCubeResultList> TCubeMapByNPC; //  NPC     ְ ᰡ ...
-typedef std::unordered_map<DWORD, std::string> TCubeResultInfoTextByNPC; //  NPC   ִ     
+typedef boost::unordered_map<DWORD, TCubeResultList> TCubeMapByNPC; //  NPC     ְ ᰡ ...
+typedef boost::unordered_map<DWORD, std::string> TCubeResultInfoTextByNPC; //  NPC   ִ     
 
 TCubeMapByNPC cube_info_map;
 TCubeResultInfoTextByNPC cube_result_info_map_by_npc; // ̹  Ű 
@@ -855,23 +318,15 @@
 		return;
 	}
 
-#ifdef __GROWTH_PET_SYSTEM__
-	if (ch->GetPetWindowType() == PET_WINDOW_ATTR_CHANGE || ch->GetPetWindowType() == PET_WINDOW_PRIMIUM_FEEDSTUFF)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("While modifying your pet's stats, you cannot trade, sell items, use the storeroom etc."));
-		return;
-	}
-#endif
-
 	if (ch->IsCubeOpen())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("̹ â ֽϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("̹ â ֽϴ."));
 		return;
 	}
 
 	if (ch->PreventTradeWindow(WND_ALL))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ٸ ŷ(â,ȯ,)   ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ٸ ŷ(â,ȯ,)   ϴ."));
 		return;
 	}
 
@@ -1084,7 +539,7 @@
 
 	if (!(ch)->IsCubeOpen())
 	{
-		(ch)->ChatPacket(CHAT_TYPE_INFO, LC_STRING("â  ʽϴ"));
+		(ch)->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("â  ʽϴ"));
 		return false;
 	}
 
@@ -1099,7 +554,7 @@
 
 	if (NULL == cube_proto)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ᰡ մϴ"));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ᰡ մϴ"));
 		return false;
 	}
 
@@ -1112,7 +567,7 @@
 	unsigned long long gold = ch->GetGold();
 	if (gold < static_cast<unsigned long long>(cube_proto->gold))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ϰų  ڸ ϴ."));	//  ؽƮ ̹ θ ̴°Ŷ ߰ ʿ 
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ϰų  ڸ ϴ."));	//  ؽƮ ̹ θ ̴°Ŷ ߰ ʿ 
 		return false;
 	}
 
@@ -1132,15 +587,6 @@
 		ch->ChatPacket(CHAT_TYPE_COMMAND, "cube success %d %d", reward_value->vnum, reward_value->count);
 		new_item = ch->AutoGiveItem(reward_value->vnum, reward_value->count);
 
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-		ch->UpdateExtBattlePassMissionProgress(BP_ITEM_CRAFT, reward_value->count, reward_value->vnum);
-#endif
-
-#if defined(__QUEST_EVENT_CRAFT__)
-		ch->SetQuestNPCID(npc->GetVID());
-		quest::CQuestManager::instance().CraftItem(ch->GetPlayerID(), npc->GetRaceNum(), new_item);
-#endif
-
 		LogManager::instance().CubeLog(ch->GetPlayerID(), ch->GetX(), ch->GetY(),
 			reward_value->vnum, new_item->GetID(), reward_value->count, 1);
 		return true;
@@ -1148,7 +594,7 @@
 	else
 	{
 		// 
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" Ͽϴ.")); // 2012.11.12  ߰ ޼ (locale_string.txt  ߰ؾ )
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" Ͽϴ.")); // 2012.11.12  ߰ ޼ (locale_string.txt  ߰ؾ )
 		ch->ChatPacket(CHAT_TYPE_COMMAND, "cube fail");
 		LogManager::instance().CubeLog(ch->GetPlayerID(), ch->GetX(), ch->GetY(),
 			reward_value->vnum, 0, 0, 0);
@@ -1173,7 +619,7 @@
 		item = cube_item[i];
 		if (NULL == item) continue;
 
-		ch->ChatPacket(CHAT_TYPE_INFO, "cube[%d]: inventory[%d]: %s", i, item->GetCell(), item->GetName());
+		ch->ChatPacket(CHAT_TYPE_INFO, "cube[%d]: inventory[%d]: %s", i, item->GetCell(), item->GetLocaleName());
 	}
 }
 
@@ -1189,8 +635,13 @@
 
 	RETURN_IF_CUBE_IS_NOT_OPENED(ch);
 
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	if ((inven_index < 0) || (INVENTORY_MAX_NUM + SPECIAL_INVENTORY_MAX_PAGE_NUM <= inven_index))
+		return;
+#else
 	if (inven_index < 0 || INVENTORY_MAX_NUM <= inven_index)
 		return;
+#endif
 
 	if (cube_index < 0 || CUBE_MAX_NUM <= cube_index)
 		return;
@@ -1214,7 +665,7 @@
 	cube_item[cube_index] = item;
 
 	if (test_server)
-		ch->ChatPacket(CHAT_TYPE_INFO, "cube[%d]: inventory[%d]: %s added", cube_index, inven_index, item->GetName());
+		ch->ChatPacket(CHAT_TYPE_INFO, "cube[%d]: inventory[%d]: %s added", cube_index, inven_index, item->GetLocaleName());
 
 	//  ڿ ö ۵    ִ Ŭ̾Ʈ  
 	//  ϰ; ׳ ʿ 尡  
@@ -1241,7 +692,7 @@
 	cube_item[cube_index] = NULL;
 
 	if (test_server)
-		ch->ChatPacket(CHAT_TYPE_INFO, "cube[%d]: cube[%d]: %s deleted", cube_index, item->GetCell(), item->GetName());
+		ch->ChatPacket(CHAT_TYPE_INFO, "cube[%d]: cube[%d]: %s deleted", cube_index, item->GetCell(), item->GetLocaleName());
 
 	//  ڿ ö ۵    ִ Ŭ̾Ʈ  
 	//  ϰ; ׳ ʿ 尡  
@@ -1548,4 +999,3 @@
 
 	ch->ChatPacket(CHAT_TYPE_COMMAND, "cube m_info %d %d %s", requestStartIndex, requestCount, materialInfoText.c_str());
 }
-#endif
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/dungeon.cpp final/server/server/home/metin2/Source/Server/game/src/dungeon.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/dungeon.cpp	2026-02-18 18:17:34.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/dungeon.cpp	2021-06-22 10:56:56.000000000 +0000
@@ -15,10 +15,6 @@
 #include "questmanager.h"
 #include "desc_manager.h"
 
-#if defined(__DEFENSE_WAVE__)
-#	include "defense_wave.h"
-#endif
-
 CDungeon::CDungeon(IdType id, long lOriginalMapIndex, long lMapIndex)
 	: m_id(id),
 	m_lOrigMapIndex(lOriginalMapIndex),
@@ -51,9 +47,6 @@
 	jump_to_event_ = NULL;
 	regen_id_ = 0;
 
-	m_bRegenInProgress = false;
-	m_dwLastRegenTick = 0;
-
 	m_iMobKill = 0;
 	m_iStoneKill = 0;
 	m_bUsePotion = false;
@@ -79,7 +72,7 @@
 
 void CDungeon::SetFlag(std::string name, int value)
 {
-	auto it =  m_map_Flag.find(name);
+	itertype(m_map_Flag) it =  m_map_Flag.find(name);
 	if (it != m_map_Flag.end())
 		it->second = value;
 	else
@@ -88,7 +81,7 @@
 
 int CDungeon::GetFlag(std::string name)
 {
-	auto it =  m_map_Flag.find(name);
+	itertype(m_map_Flag) it =  m_map_Flag.find(name);
 	if (it != m_map_Flag.end())
 		return it->second;
 	else
@@ -180,8 +173,8 @@
 {
 	pParty->SetDungeon(NULL);
 	//sys_log(0, "DUNGEON-PARTY quit %p %p", this, pParty);
-
 	TPartyMap::iterator it = m_map_pkParty.find(pParty);
+
 	if (it != m_map_pkParty.end())
 		m_map_pkParty.erase(it);
 }
@@ -216,19 +209,6 @@
 	return 0;
 }
 
-#if defined(__DUNGEON_RENEWAL__)
-void CDungeon::Destroy()
-{
-	m_set_pkCharacter.clear();
-
-	dungeon_id_info* info = AllocEventInfo<dungeon_id_info>();
-	info->dungeon_id = m_id;
-
-	event_cancel(&deadEvent);
-	deadEvent = event_create(dungeon_dead_event, info, PASSES_PER_SEC(10));
-}
-#endif
-
 void CDungeon::IncMember(LPCHARACTER ch)
 {
 	if (m_set_pkCharacter.find(ch) == m_set_pkCharacter.end())
@@ -239,7 +219,8 @@
 
 void CDungeon::DecMember(LPCHARACTER ch)
 {
-	auto it = m_set_pkCharacter.find(ch);
+	itertype(m_set_pkCharacter) it = m_set_pkCharacter.find(ch);
+
 	if (it == m_set_pkCharacter.end())
 		return;
 
@@ -376,26 +357,7 @@
 	pMap->for_each(f);
 }
 
-#if defined(__DUNGEON_RENEWAL__)
-void CDungeon::SetParty(LPPARTY pParty)
-{
-	if (pParty->GetDungeon_for_Only_party() == NULL)
-	{
-		if (m_pParty == NULL)
-		{
-			m_pParty = pParty;
-		}
-		else if (m_pParty != pParty)
-		{
-			sys_err("Dungeon already has party : index %d", GetMapIndex());
-			return;
-		}
-		pParty->SetDungeon_for_Only_party(this);
-	}
-}
-#endif
-
-void CDungeon::JumpParty(LPPARTY pParty, long lFromMapIndex, int x, int y)
+void CDungeon::JumpParty(LPPARTY pParty, long lFromMapIndex, int x, int y, bool single)
 {
 	x *= 100;
 	y *= 100;
@@ -408,18 +370,21 @@
 		return;
 	}
 
-	if (pParty->GetDungeon_for_Only_party() == NULL)
+	if (single) //< 2018.12.30.Owsap - JumpSingleParty single party in dungeon
 	{
-		if (m_pParty == NULL)
-		{
-			m_pParty = pParty;
-		}
-		else if (m_pParty != pParty)
+		if (pParty->GetDungeon_for_Only_party() == NULL)
 		{
-			sys_err("Dungeon already has party. Another party cannot jump in dungeon : index %d", GetMapIndex());
-			return;
+			if (m_pParty == NULL)
+			{
+				m_pParty = pParty;
+			}
+			else if (m_pParty != pParty)
+			{
+				sys_err("Dungeon already has party. Another party cannot jump in dungeon : index %d", GetMapIndex());
+				return;
+			}
+			pParty->SetDungeon_for_Only_party(this);
 		}
-		pParty->SetDungeon_for_Only_party(this);
 	}
 
 	FWarpToPosition f(m_lMapIndex, x, y);
@@ -447,17 +412,13 @@
 	DWORD server_timer_arg = lMapIndex;
 	quest::CQuestManager::instance().CancelServerTimers(server_timer_arg);
 
-#if defined(__DUNGEON_RENEWAL__)
-	pDungeon->ExitAll();
-#endif
-
 	SECTREE_MANAGER::instance().DestroyPrivateMap(lMapIndex);
 	M2_DELETE(pDungeon);
 }
 
 LPDUNGEON CDungeonManager::Find(CDungeon::IdType dungeon_id)
 {
-	auto it = m_map_pkDungeon.find(dungeon_id);
+	itertype(m_map_pkDungeon) it = m_map_pkDungeon.find(dungeon_id);
 	if (it != m_map_pkDungeon.end())
 		return it->second;
 	return NULL;
@@ -465,18 +426,19 @@
 
 LPDUNGEON CDungeonManager::FindByMapIndex(long lMapIndex)
 {
-	auto it = m_map_pkMapDungeon.find(lMapIndex);
+	itertype(m_map_pkMapDungeon) it = m_map_pkMapDungeon.find(lMapIndex);
 	if (it != m_map_pkMapDungeon.end())
 		return it->second;
 	return NULL;
 }
 
-LPDUNGEON CDungeonManager::Create(long lOriginalMapIndex, EDungeonType eType)
+LPDUNGEON CDungeonManager::Create(long lOriginalMapIndex)
 {
-	DWORD lPrivateMapIndex = SECTREE_MANAGER::instance().CreatePrivateMap(lOriginalMapIndex);
-	if (lPrivateMapIndex == 0)
+	DWORD lMapIndex = SECTREE_MANAGER::instance().CreatePrivateMap(lOriginalMapIndex);
+
+	if (!lMapIndex)
 	{
-		sys_log(0, "Failed to Create Dungeon : OriginalMapIndex %d PrivateMapIndex %d", lOriginalMapIndex, lPrivateMapIndex);
+		sys_log(0, "Fail to Create Dungeon : OrginalMapindex %d NewMapindex %d", lOriginalMapIndex, lMapIndex);
 		return NULL;
 	}
 
@@ -487,26 +449,14 @@
 		id = next_id_++;
 	}
 
-	LPDUNGEON pDungeon = NULL;
-	if (eType == DUNGEON_TYPE_DEFAULT)
-	{
-		pDungeon = M2_NEW CDungeon(id, lOriginalMapIndex, lPrivateMapIndex);
-	}
-#if defined(__DEFENSE_WAVE__)
-	else if (eType == DUNGEON_TYPE_DEFENSE_WAVE)
-	{
-		pDungeon = M2_NEW CDefenseWave(id, lOriginalMapIndex, lPrivateMapIndex);
-	}
-#endif
-
+	LPDUNGEON pDungeon = M2_NEW CDungeon(id, lOriginalMapIndex, lMapIndex);
 	if (!pDungeon)
 	{
-		sys_err("Failed to create dungeon instance");
+		sys_err("M2_NEW CDungeon failed");
 		return NULL;
 	}
-
-	m_map_pkDungeon.emplace(id, pDungeon);
-	m_map_pkMapDungeon.emplace(lPrivateMapIndex, pDungeon);
+	m_map_pkDungeon.insert(std::make_pair(id, pDungeon));
+	m_map_pkMapDungeon.insert(std::make_pair(lMapIndex, pDungeon));
 
 	return pDungeon;
 }
@@ -520,7 +470,7 @@
 {
 }
 
-void CDungeon::UniqueSetMaxHP(const std::string& key, DWORD dwMaxHP)
+void CDungeon::UniqueSetMaxHP(const std::string& key, int64_t iMaxHP)
 {
 	TUniqueMobMap::iterator it = m_map_UniqueMob.find(key);
 	if (it == m_map_UniqueMob.end())
@@ -528,10 +478,10 @@
 		sys_err("Unknown Key : %s", key.c_str());
 		return;
 	}
-	it->second->SetMaxHP(dwMaxHP);
+	it->second->SetMaxHP(iMaxHP);
 }
 
-void CDungeon::UniqueSetHP(const std::string& key, int iHP)
+void CDungeon::UniqueSetHP(const std::string& key, int64_t iHP)
 {
 	TUniqueMobMap::iterator it = m_map_UniqueMob.find(key);
 	if (it == m_map_UniqueMob.end())
@@ -697,7 +647,7 @@
 	ch->Dead();
 }
 
-DWORD CDungeon::GetUniqueVID(const std::string& key)
+DWORD CDungeon::GetUniqueVid(const std::string& key)
 {
 	TUniqueMobMap::iterator it = m_map_UniqueMob.find(key);
 	if (it == m_map_UniqueMob.end())
@@ -705,29 +655,8 @@
 		sys_err("Unknown Key or Dead: %s", key.c_str());
 		return 0;
 	}
-	return it->second->GetVID();
-}
-
-bool CDungeon::IsUnique(LPCHARACTER pChar)
-{
-	TUniqueMobMap::iterator it = m_map_UniqueMob.begin();
-	for (; it != m_map_UniqueMob.end(); ++it)
-	{
-		if (it->second == pChar)
-			return true;
-	}
-	return false;
-}
-
-LPCHARACTER CDungeon::GetUnique(const std::string& key)
-{
-	TUniqueMobMap::iterator it = m_map_UniqueMob.find(key);
-	if (it == m_map_UniqueMob.end())
-	{
-		sys_err("Unknown Key or Dead: %s", key.c_str());
-		return NULL;
-	}
-	return it->second;
+	LPCHARACTER ch = it->second;
+	return ch->GetVID();
 }
 
 float CDungeon::GetUniqueHpPerc(const std::string& key)
@@ -736,7 +665,7 @@
 	if (it == m_map_UniqueMob.end())
 	{
 		sys_err("Unknown Key : %s", key.c_str());
-		return 0.0f;
+		return false;
 	}
 	return (100.f * it->second->GetHP()) / it->second->GetMaxHP();
 }
@@ -762,11 +691,13 @@
 bool CDungeon::IsUniqueDead(const std::string& key)
 {
 	TUniqueMobMap::iterator it = m_map_UniqueMob.find(key);
+
 	if (it == m_map_UniqueMob.end())
 	{
 		sys_err("Unknown Key or Dead : %s", key.c_str());
 		return true;
 	}
+
 	return it->second->IsDead();
 }
 
@@ -923,32 +854,13 @@
 		return;
 	}
 
-	// Generic anti-spam / entity-limit guard (quest/UI agnostic).
-	// Prevents packet/NPC click spamming from spawning tens of thousands of entities.
-	const DWORD now = get_dword_time();
-	static const DWORD kRegenCooldownMs = 1200;
-	static const int kMaxDungeonMonstersBeforeBlock = 100;
-
-	if (m_bRegenInProgress)
-		return;
-
-	if (m_dwLastRegenTick && (now - m_dwLastRegenTick) < kRegenCooldownMs)
-		return;
-
-	if (CountMonster() >= kMaxDungeonMonstersBeforeBlock)
-		return;
-
 	LPSECTREE_MAP pkSectreeMap = SECTREE_MANAGER::instance().GetMap(m_lMapIndex);
 	if (!pkSectreeMap)
 	{
 		sys_err("CDungeon::SpawnRegen(filename=%s, bOnce=%d) - m_lMapIndex[%d]", filename, bOnce, m_lMapIndex);
 		return;
 	}
-
-	m_bRegenInProgress = true;
-	m_dwLastRegenTick = now;
 	regen_do(filename, m_lMapIndex, pkSectreeMap->m_setting.iBaseX, pkSectreeMap->m_setting.iBaseY, this, bOnce);
-	m_bRegenInProgress = false;
 }
 
 void CDungeon::AddRegen(LPREGEN regen)
@@ -959,7 +871,7 @@
 
 void CDungeon::ClearRegen()
 {
-	for (auto it = m_regen.begin(); it != m_regen.end(); ++it)
+	for (itertype(m_regen) it = m_regen.begin(); it != m_regen.end(); ++it)
 	{
 		LPREGEN regen = *it;
 
@@ -971,7 +883,7 @@
 
 bool CDungeon::IsValidRegen(LPREGEN regen, size_t regen_id)
 {
-	auto it = std::find(m_regen.begin(), m_regen.end(), regen);
+	itertype(m_regen) it = std::find(m_regen.begin(), m_regen.end(), regen);
 	if (it == m_regen.end())
 		return false;
 	LPREGEN found = *it;
@@ -1029,11 +941,7 @@
 			{
 				LPCHARACTER ch = (LPCHARACTER)ent;
 
-				if (!ch->IsPC()
-#if defined(__PET_SYSTEM__)
-					&& !ch->IsPet()
-#endif
-					)
+				if (!ch->IsPC() && !ch->IsPet() && !ch->IsGrowthPet())
 					ch->Dead();
 			}
 		}
@@ -1048,11 +956,7 @@
 			{
 				LPCHARACTER ch = (LPCHARACTER)ent;
 
-				if (!ch->IsPC()
-#if defined(__PET_SYSTEM__)
-					&& !ch->IsPet()
-#endif
-					)
+				if (!ch->IsPC() && !ch->IsPet() && !ch->IsGrowthPet())
 				{
 					M2_DESTROY_CHARACTER(ch);
 				}
@@ -1198,24 +1102,10 @@
 {
 	struct FNotice
 	{
-		FNotice(const char* psz) : m_psz(psz) {}
-		void operator() (LPENTITY ent)
+		FNotice(const char* psz) : m_psz(psz)
 		{
-			if (ent->IsType(ENTITY_CHARACTER))
-			{
-				LPCHARACTER ch = (LPCHARACTER)ent;
-				if (ch->IsPC())
-				{
-					ch->ChatPacket(CHAT_TYPE_NOTICE, "%s", m_psz);
-				}
-			}
 		}
-		const char* m_psz;
-	};
 
-	struct FMissionMessage
-	{
-		FMissionMessage(const char* psz) : m_psz(psz) {}
 		void operator() (LPENTITY ent)
 		{
 			if (ent->IsType(ENTITY_CHARACTER))
@@ -1223,32 +1113,17 @@
 				LPCHARACTER ch = (LPCHARACTER)ent;
 				if (ch->IsPC())
 				{
-					ch->ChatPacket(CHAT_TYPE_MISSION, "%s", m_psz);
+					ch->ChatPacket(CHAT_TYPE_NOTICE, "%s", m_psz);
 				}
-			}
-		}
-		const char* m_psz;
-	};
 
-	struct FSubMissionMessage
-	{
-		FSubMissionMessage(const char* psz) : m_psz(psz) {}
-		void operator() (LPENTITY ent)
-		{
-			if (ent->IsType(ENTITY_CHARACTER))
-			{
-				LPCHARACTER ch = (LPCHARACTER)ent;
-				if (ch->IsPC())
-				{
-					ch->ChatPacket(CHAT_TYPE_SUB_MISSION, "%s", m_psz);
-				}
 			}
 		}
+
 		const char* m_psz;
 	};
 }
 
-void CDungeon::Notice(const char* msg)
+void CDungeon::Notice(const char* msg, ...)
 {
 	sys_log(0, "XXX Dungeon Notice %p %s", this, msg);
 	LPSECTREE_MAP pMap = SECTREE_MANAGER::instance().GetMap(m_lMapIndex);
@@ -1259,38 +1134,73 @@
 		return;
 	}
 
-	FNotice f(msg);
-	pMap->for_each(f);
-}
+	const DESC_MANAGER::DESC_SET& c_ref_set = DESC_MANAGER::instance().GetClientSet();
 
-void CDungeon::MissionMessage(const char* msg)
-{
-	sys_log(0, "XXX Dungeon Mission Message %p %s", this, msg);
-	LPSECTREE_MAP pMap = SECTREE_MANAGER::instance().GetMap(m_lMapIndex);
+	if (!msg)
+		return;
 
-	if (!pMap)
+	DESC_MANAGER::DESC_SET::const_iterator it = c_ref_set.begin();
+
+	while (it != c_ref_set.end())
 	{
-		sys_err("cannot find map by index %d", m_lMapIndex);
-		return;
-	}
+		LPDESC d = *(it++);
 
-	FMissionMessage f(msg);
-	pMap->for_each(f);
-}
+		if (d->GetCharacter())
+		{
+			LPSECTREE_MAP pSecMap = SECTREE_MANAGER::instance().GetMap(d->GetCharacter()->GetMapIndex());
+			if (pSecMap != pMap)
+				continue;
 
-void CDungeon::SubMissionMessage(const char* msg)
-{
-	sys_log(0, "XXX Dungeon SubMission Message %p %s", this, msg);
-	LPSECTREE_MAP pMap = SECTREE_MANAGER::instance().GetMap(m_lMapIndex);
+			std::string strMsg = msg;
+			const char* c_pszBuf;
 
-	if (!pMap)
-	{
-		sys_err("cannot find map by index %d", m_lMapIndex);
-		return;
-	}
+			if (!strMsg.empty() && std::all_of(strMsg.begin(), strMsg.end(), ::isdigit))
+			{
+				DWORD dwKey = atoi(msg);
+				BYTE bLanguage = (d ? d->GetLanguage() : LOCALE_YMIR);
 
-	FSubMissionMessage f(msg);
-	pMap->for_each(f);
+				c_pszBuf = LC_LOCALE_QUEST_TEXT(dwKey, bLanguage);
+			}
+			else
+			{
+				c_pszBuf = msg;
+			}
+
+			std::string strBuffFilter = c_pszBuf;
+			std::string strReplace("%d");
+
+			size_t pos = 0;
+			while ((pos = strBuffFilter.find(strReplace)) != std::string::npos)
+			{
+				strBuffFilter.replace(pos, strReplace.length(), "%s");
+			}
+
+			const char* c_pszConvBuf = strBuffFilter.c_str();
+			char szNoticeBuf[CHAT_MAX_LEN + 1];
+
+			va_list args;
+			va_start(args, msg);
+			int len = vsnprintf(szNoticeBuf, sizeof(szNoticeBuf), c_pszConvBuf, args);
+			va_end(args);
+
+			const char* c_pszToken;
+			const char* c_pszLast = szNoticeBuf;
+
+			std::string strBuff = szNoticeBuf;
+			std::string strDelim = "[ENTER]";
+			std::string strToken;
+
+			while ((pos = strBuff.find(strDelim)) != std::string::npos)
+			{
+				strToken = strBuff.substr(0, pos);
+				c_pszToken = strToken.c_str();
+				d->GetCharacter()->ChatPacket(CHAT_TYPE_NOTICE, "%s", c_pszToken);
+
+				c_pszLast = strBuff.erase(0, pos + strDelim.length()).c_str();
+			}
+			d->GetCharacter()->ChatPacket(CHAT_TYPE_NOTICE, "%s", c_pszLast);
+		}
+	}
 }
 // END_OF_DUNGEON_NOTICE
 
@@ -1343,14 +1253,12 @@
 	}
 
 	LPDUNGEON pDungeon = CDungeonManager::instance().Find(info->dungeon_id);
+	pDungeon->jump_to_event_ = NULL;
 
 	if (pDungeon)
-	{
-		pDungeon->jump_to_event_ = NULL;
 		pDungeon->JumpToEliminateLocation();
-	}
 	else
-		sys_err("cannot find dungeon with id %u", info->dungeon_id);
+		sys_err("cannot find dungeon with map index %u", info->dungeon_id);
 
 	return 0;
 }
@@ -1366,14 +1274,10 @@
 	}
 
 	LPDUNGEON pDungeon = CDungeonManager::instance().Find(info->dungeon_id);
+	pDungeon->exit_all_event_ = NULL;
 
 	if (pDungeon)
-	{
-		pDungeon->exit_all_event_ = NULL;
 		pDungeon->ExitAll();
-	}
-	else
-		sys_err("cannot find dungeon with id %u", info->dungeon_id);
 
 	return 0;
 }
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/exchange.cpp final/server/server/home/metin2/Source/Server/game/src/exchange.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/exchange.cpp	2026-02-17 15:41:06.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/exchange.cpp	2026-02-20 18:05:02.437297659 +0000
@@ -12,13 +12,9 @@
 #include "locale_service.h"
 #include "../../common/length.h"
 #include "exchange.h"
-#include "questmanager.h"
 #include "DragonSoul.h"
-#if defined(__PET_SYSTEM__)
-#	include "PetSystem.h"
-#endif
 #if defined(__MESSENGER_BLOCK_SYSTEM__)
-#	include "messenger_manager.h"
+#include "messenger_manager.h"
 #endif
 
 void exchange_packet(LPCHARACTER ch, BYTE sub_header, bool is_me, DWORD arg1, TItemPos arg2, DWORD arg3, void* pvData = NULL);
@@ -45,16 +41,7 @@
 		thecore_memcpy(&pack_exchg.alSockets, ((LPITEM)pvData)->GetSockets(), sizeof(pack_exchg.alSockets));
 		thecore_memcpy(&pack_exchg.aAttr, ((LPITEM)pvData)->GetAttributes(), sizeof(pack_exchg.aAttr));
 #if defined(__CHANGE_LOOK_SYSTEM__)
-		pack_exchg.dwTransmutationVnum = static_cast<LPITEM>(pvData)->GetTransmutationVnum();
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-		thecore_memcpy(&pack_exchg.RefineElement, ((LPITEM)pvData)->GetRefineElement(), sizeof(pack_exchg.RefineElement));
-#endif
-#if defined(__ITEM_APPLY_RANDOM__)
-		thecore_memcpy(&pack_exchg.aApplyRandom, ((LPITEM)pvData)->GetRandomApplies(), sizeof(pack_exchg.aApplyRandom));
-#endif
-#if defined(__SET_ITEM__)
-		pack_exchg.bSetItem = static_cast<LPITEM>(pvData)->GetItemSetValue();
+		pack_exchg.dwTransmutation = ((LPITEM)pvData)->GetTransmutation();
 #endif
 	}
 	else
@@ -64,16 +51,7 @@
 		memset(&pack_exchg.alSockets, 0, sizeof(pack_exchg.alSockets));
 		memset(&pack_exchg.aAttr, 0, sizeof(pack_exchg.aAttr));
 #if defined(__CHANGE_LOOK_SYSTEM__)
-		pack_exchg.dwTransmutationVnum = 0;
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-		memset(&pack_exchg.RefineElement, 0, sizeof(pack_exchg.RefineElement));
-#endif
-#if defined(__ITEM_APPLY_RANDOM__)
-		memset(&pack_exchg.aApplyRandom, 0, sizeof(pack_exchg.aApplyRandom));
-#endif
-#if defined(__SET_ITEM__)
-		pack_exchg.bSetItem = 0;
+		pack_exchg.dwTransmutation = 0;
 #endif
 	}
 
@@ -88,36 +66,26 @@
 
 	if (IsObserverMode())
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ¿ ȯ   ϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ¿ ȯ   ϴ."));
 		return false;
 	}
 
-	if (victim->IsRunningQuest())
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("The other person is currently busy so you cannot trade right now."));
-		return false;
-	}
-
-	if (IsRunningQuest())
-		return false;
-
 	if (victim->IsNPC())
 		return false;
-
+	
 #ifdef __GROWTH_PET_SYSTEM__
 	if (GetPetWindowType() == PET_WINDOW_ATTR_CHANGE || GetPetWindowType() == PET_WINDOW_PRIMIUM_FEEDSTUFF)
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("While modifying your pet's stats, you cannot trade, sell items, use the storeroom etc."));
+		ChatPacket(CHAT_TYPE_INFO, "While modifying your pet's stats, you cannot trade, sell items, use the storeroom etc.");
 		return false;
 	}
 
 	if (victim->GetPetWindowType() == PET_WINDOW_ATTR_CHANGE || victim->GetPetWindowType() == PET_WINDOW_PRIMIUM_FEEDSTUFF)
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot trade while your trading partner is modifying their pet's stats."));
+		ChatPacket(CHAT_TYPE_INFO, "You cannot trade while your trading partner is modifying their pet's stats.");
 		return false;
 	}
 
-	/*
 	if (GetActiveGrowthPet())
 	{
 		ChatPacket(CHAT_TYPE_INFO, "You cannot open a private shop whilst summoning your pet.");
@@ -129,32 +97,39 @@
 		ChatPacket(CHAT_TYPE_INFO, "You cannot trade whilst your partner is summoning their pet.");
 		return false;
 	}
-	*/
 #endif
 
 #if defined(__MESSENGER_BLOCK_SYSTEM__)
-	if (CMessengerManager::instance().IsBlocked(GetName(), victim->GetName()))
+	if (MessengerManager::instance().IsBlocked(GetName(), victim->GetName()))
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("Unblock %s to continue.", victim->GetName()));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Unblock %s to continue."), victim->GetName());
 		return false;
 	}
-	else if (CMessengerManager::instance().IsBlocked(victim->GetName(), GetName()))
+	else if (MessengerManager::instance().IsBlocked(victim->GetName(), GetName()))
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s has blocked you.", victim->GetName()));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s has blocked you."), victim->GetName());
 		return false;
 	}
 #endif
 
 	// PREVENT_TRADE_WINDOW
-	if (PreventTradeWindow(WND_EXCHANGE, true/*except*/))
+	if (IsOpenSafebox() || GetShopOwner() || GetMyShop() || IsCubeOpen()
+#ifdef __AURA_SYSTEM__
+		|| IsAuraRefineWindowOpen()
+#endif
+		)
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("ٸ ŷâ  ŷ Ҽ ϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ٸ ŷâ  ŷ Ҽ ϴ."));
 		return false;
 	}
 
-	if (victim->PreventTradeWindow(WND_EXCHANGE, true/*except*/))
+	if (victim->IsOpenSafebox() || victim->GetShopOwner() || victim->GetMyShop() || victim->IsCubeOpen()
+#ifdef __AURA_SYSTEM__
+		|| victim->IsAuraRefineWindowOpen()
+#endif
+		)
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ٸ ŷ̶ ŷ Ҽ ϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ٸ ŷ̶ ŷ Ҽ ϴ."));
 		return false;
 	}
 	// END_PREVENT_TRADE_WINDOW
@@ -176,7 +151,7 @@
 
 	if (victim->IsBlockMode(BLOCK_EXCHANGE))
 	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ȯ ź Դϴ."));
+		ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ȯ ź Դϴ."));
 		return false;
 	}
 
@@ -236,12 +211,6 @@
 	if (item_pos.IsEquipPosition())
 		return false;
 
-	if (m_pGrid && display_pos >= m_pGrid->GetSize())
-	{
-		sys_err("EXCHANGE invalid display_pos %u", display_pos);
-		return false;
-	}
-
 	LPITEM item;
 
 	if (!(item = m_pOwner->GetItem(item_pos)))
@@ -249,23 +218,19 @@
 
 	if (IS_SET(item->GetAntiFlag(), ITEM_ANTIFLAG_GIVE))
 	{
-		m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ǳ  ϴ."));
+		m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ǳ  ϴ."));
 		return false;
 	}
 
 	if (true == item->isLocked())
+	{
 		return false;
-
-#if defined(__PET_SYSTEM__)
-	CPetSystem* pPetSystem = m_pOwner->GetPetSystem();
-	if (pPetSystem && pPetSystem->GetSummonItemVID() == item->GetVID())
-		return false;
-#endif
+	}
 
 #if defined(__SOUL_BIND_SYSTEM__)
 	if (item->IsSealed())
 	{
-		m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot give away a soulbound item."));
+		m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot give away a soulbound item."));
 		return false;
 	}
 #endif
@@ -296,8 +261,6 @@
 		m_abItemDisplayPos[i] = display_pos;
 		m_pGrid->Put(display_pos, 1, item->GetSize());
 
-		item->SetExchanging(true);
-
 #ifdef __GROWTH_PET_SYSTEM__
 		if (item->GetType() == ITEM_PET && item->GetSubType() == PET_BAG)
 		{
@@ -309,6 +272,8 @@
 		}
 #endif
 
+		item->SetExchanging(true);
+
 		exchange_packet(m_pOwner,
 			EXCHANGE_SUBHEADER_GC_ITEM_ADD,
 			true,
@@ -361,7 +326,7 @@
 
 bool CExchange::AddGold(long gold)
 {
-	if (gold <= 0 || gold > EXCHANGE_YANG_MAX)
+	if (gold <= 0)
 		return false;
 
 	if (GetOwner()->GetGold() < gold)
@@ -392,7 +357,7 @@
 #if defined(__CHEQUE_SYSTEM__)
 bool CExchange::AddCheque(long cheque)
 {
-	if (cheque <= 0 || cheque > EXCHANGE_CHEQUE_MAX)
+	if (cheque <= 0)
 		return false;
 
 	if (GetOwner()->GetCheque() < cheque)
@@ -409,7 +374,7 @@
 		if (vic_cheque > CHEQUE_MAX)
 		{
 			exchange_packet(GetOwner(), EXCHANGE_SUBHEADER_GC_LESS_CHEQUE, 0, 0, NPOS, 0);
-			GetOwner()->ChatPacket(CHAT_TYPE_INFO, LC_STRING("This user can not accept that much cheque."));
+			GetOwner()->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("This user can not accept that much cheque."));
 			return false;
 		}
 	}
@@ -468,18 +433,68 @@
 {
 	static CGrid s_grid1(5, INVENTORY_MAX_NUM / 5 / INVENTORY_PAGE_COUNT);
 	static CGrid s_grid2(5, INVENTORY_MAX_NUM / 5 / INVENTORY_PAGE_COUNT);
-#if defined(__EXTEND_INVEN_SYSTEM__)
+#if defined(__INVENTORY_4PAGES__)
 	static CGrid s_grid3(5, INVENTORY_MAX_NUM / 5 / INVENTORY_PAGE_COUNT);
 	static CGrid s_grid4(5, INVENTORY_MAX_NUM / 5 / INVENTORY_PAGE_COUNT);
 #endif
 
 	s_grid1.Clear();
 	s_grid2.Clear();
-#if defined(__EXTEND_INVEN_SYSTEM__)
+#if defined(__INVENTORY_4PAGES__)
 	s_grid3.Clear();
 	s_grid4.Clear();
 #endif
 
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	static CGrid s_grid5(5, SKILL_BOOK_INVENTORY_MAX_NUM / 5 / SPECIAL_INVENTORY_PAGE_COUNT);
+	static CGrid s_grid6(5, SKILL_BOOK_INVENTORY_MAX_NUM / 5 / SPECIAL_INVENTORY_PAGE_COUNT);
+	static CGrid s_grid7(5, SKILL_BOOK_INVENTORY_MAX_NUM / 5 / SPECIAL_INVENTORY_PAGE_COUNT);
+	static CGrid s_grid8(5, SKILL_BOOK_INVENTORY_MAX_NUM / 5 / SPECIAL_INVENTORY_PAGE_COUNT);
+	static CGrid s_grid9(5, SKILL_BOOK_INVENTORY_MAX_NUM / 5 / SPECIAL_INVENTORY_PAGE_COUNT);
+
+	static CGrid s_grid10(5, UPGRADE_ITEMS_INVENTORY_MAX_NUM / 5 / SPECIAL_INVENTORY_PAGE_COUNT);
+	static CGrid s_grid11(5, UPGRADE_ITEMS_INVENTORY_MAX_NUM / 5 / SPECIAL_INVENTORY_PAGE_COUNT);
+	static CGrid s_grid12(5, UPGRADE_ITEMS_INVENTORY_MAX_NUM / 5 / SPECIAL_INVENTORY_PAGE_COUNT);
+	static CGrid s_grid13(5, UPGRADE_ITEMS_INVENTORY_MAX_NUM / 5 / SPECIAL_INVENTORY_PAGE_COUNT);
+	static CGrid s_grid14(5, UPGRADE_ITEMS_INVENTORY_MAX_NUM / 5 / SPECIAL_INVENTORY_PAGE_COUNT);
+
+	static CGrid s_grid15(5, STONE_INVENTORY_MAX_NUM / 5 / SPECIAL_INVENTORY_PAGE_COUNT);
+	static CGrid s_grid16(5, STONE_INVENTORY_MAX_NUM / 5 / SPECIAL_INVENTORY_PAGE_COUNT);
+	static CGrid s_grid17(5, STONE_INVENTORY_MAX_NUM / 5 / SPECIAL_INVENTORY_PAGE_COUNT);
+	static CGrid s_grid18(5, STONE_INVENTORY_MAX_NUM / 5 / SPECIAL_INVENTORY_PAGE_COUNT);
+	static CGrid s_grid19(5, STONE_INVENTORY_MAX_NUM / 5 / SPECIAL_INVENTORY_PAGE_COUNT);
+
+	static CGrid s_grid20(5, GIFT_BOX_INVENTORY_MAX_NUM / 5 / SPECIAL_INVENTORY_PAGE_COUNT);
+	static CGrid s_grid21(5, GIFT_BOX_INVENTORY_MAX_NUM / 5 / SPECIAL_INVENTORY_PAGE_COUNT);
+	static CGrid s_grid22(5, GIFT_BOX_INVENTORY_MAX_NUM / 5 / SPECIAL_INVENTORY_PAGE_COUNT);
+	static CGrid s_grid23(5, GIFT_BOX_INVENTORY_MAX_NUM / 5 / SPECIAL_INVENTORY_PAGE_COUNT);
+	static CGrid s_grid24(5, GIFT_BOX_INVENTORY_MAX_NUM / 5 / SPECIAL_INVENTORY_PAGE_COUNT);
+
+	s_grid5.Clear();
+	s_grid6.Clear();
+	s_grid7.Clear();
+	s_grid8.Clear();
+	s_grid9.Clear();
+
+	s_grid10.Clear();
+	s_grid11.Clear();
+	s_grid12.Clear();
+	s_grid13.Clear();
+	s_grid15.Clear();
+
+	s_grid15.Clear();
+	s_grid16.Clear();
+	s_grid17.Clear();
+	s_grid18.Clear();
+	s_grid19.Clear();
+
+	s_grid20.Clear();
+	s_grid21.Clear();
+	s_grid22.Clear();
+	s_grid23.Clear();
+	s_grid24.Clear();
+#endif
+
 	LPCHARACTER victim = GetCompany()->GetOwner();
 	LPITEM item;
 
@@ -499,7 +514,7 @@
 
 		s_grid2.Put(i - INVENTORY_PAGE_SIZE * 1, 1, item->GetSize());
 	}
-#if defined(__EXTEND_INVEN_SYSTEM__)
+#if defined(__INVENTORY_4PAGES__)
 	for (i = INVENTORY_PAGE_SIZE * 2; i < INVENTORY_PAGE_SIZE * 3; ++i)
 	{
 		if (!(item = victim->GetInventoryItem(i)))
@@ -516,20 +531,97 @@
 	}
 #endif
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	int x;
+
+	// SKILL_BOOK_INVENTORY
+	for (x = 0; x < SKILL_BOOK_INVENTORY_MAX_NUM; ++x)
+	{
+		if (!(item = victim->GetSkillBookInventoryItem(SKILL_BOOK_INVENTORY_SLOT_START + x)))
+			continue;
+
+		if (x < SPECIAL_INVENTORY_PAGE_SIZE)
+			s_grid5.Put(x, 1, item->GetSize());
+		else if (x < SPECIAL_INVENTORY_PAGE_SIZE * 2)
+			s_grid6.Put(x - SPECIAL_INVENTORY_PAGE_SIZE, 1, item->GetSize());
+		else if (x < SPECIAL_INVENTORY_PAGE_SIZE * 3)
+			s_grid7.Put(x - SPECIAL_INVENTORY_PAGE_SIZE * 2, 1, item->GetSize());
+		else if (x < SPECIAL_INVENTORY_PAGE_SIZE * 4)
+			s_grid8.Put(x - SPECIAL_INVENTORY_PAGE_SIZE * 3, 1, item->GetSize());
+		else if (x < SPECIAL_INVENTORY_PAGE_SIZE * 5)
+			s_grid9.Put(x - SPECIAL_INVENTORY_PAGE_SIZE * 4, 1, item->GetSize());
+	}
+	// END_OF_SKILL_BOOK_INVENTORY
+
+	// UPGRADE_ITEMS_INVENTORY
+	for (x = 0; x < UPGRADE_ITEMS_INVENTORY_MAX_NUM; ++x)
+	{
+		if (!(item = victim->GetUpgradeItemsInventoryItem(UPGRADE_ITEMS_INVENTORY_SLOT_START + x)))
+			continue;
+
+		if (x < SPECIAL_INVENTORY_PAGE_SIZE)
+			s_grid10.Put(x, 1, item->GetSize());
+		else if (x < SPECIAL_INVENTORY_PAGE_SIZE * 2)
+			s_grid11.Put(x - SPECIAL_INVENTORY_PAGE_SIZE, 1, item->GetSize());
+		else if (x < SPECIAL_INVENTORY_PAGE_SIZE * 3)
+			s_grid12.Put(x - SPECIAL_INVENTORY_PAGE_SIZE * 2, 1, item->GetSize());
+		else if (x < SPECIAL_INVENTORY_PAGE_SIZE * 4)
+			s_grid13.Put(x - SPECIAL_INVENTORY_PAGE_SIZE * 3, 1, item->GetSize());
+		else if (x < SPECIAL_INVENTORY_PAGE_SIZE * 5)
+			s_grid14.Put(x - SPECIAL_INVENTORY_PAGE_SIZE * 4, 1, item->GetSize());
+	}
+	// END_OF_UPGRADE_ITEMS_INVENTORY
+
+	// STONE_INVENTORY
+	for (x = 0; x < STONE_INVENTORY_MAX_NUM; ++x)
+	{
+		if (!(item = victim->GetStoneInventoryItem(STONE_INVENTORY_SLOT_START + x)))
+			continue;
+
+		if (x < SPECIAL_INVENTORY_PAGE_SIZE)
+			s_grid15.Put(x, 1, item->GetSize());
+		else if (x < SPECIAL_INVENTORY_PAGE_SIZE * 2)
+			s_grid16.Put(x - SPECIAL_INVENTORY_PAGE_SIZE, 1, item->GetSize());
+		else if (x < SPECIAL_INVENTORY_PAGE_SIZE * 3)
+			s_grid17.Put(x - SPECIAL_INVENTORY_PAGE_SIZE * 2, 1, item->GetSize());
+		else if (x < SPECIAL_INVENTORY_PAGE_SIZE * 4)
+			s_grid18.Put(x - SPECIAL_INVENTORY_PAGE_SIZE * 3, 1, item->GetSize());
+		else if (x < SPECIAL_INVENTORY_PAGE_SIZE * 5)
+			s_grid19.Put(x - SPECIAL_INVENTORY_PAGE_SIZE * 4, 1, item->GetSize());
+	}
+	// END_OF_STONE_INVENTORY
+
+	// GIFT_BOX
+	for (x = 0; x < GIFT_BOX_INVENTORY_MAX_NUM; ++x)
+	{
+		if (!(item = victim->GetGiftBoxInventoryItem(GIFT_BOX_INVENTORY_SLOT_START + x)))
+			continue;
+
+		if (x < SPECIAL_INVENTORY_PAGE_SIZE)
+			s_grid20.Put(x, 1, item->GetSize());
+		else if (x < SPECIAL_INVENTORY_PAGE_SIZE * 2)
+			s_grid21.Put(x - SPECIAL_INVENTORY_PAGE_SIZE, 1, item->GetSize());
+		else if (x < SPECIAL_INVENTORY_PAGE_SIZE * 3)
+			s_grid22.Put(x - SPECIAL_INVENTORY_PAGE_SIZE * 2, 1, item->GetSize());
+		else if (x < SPECIAL_INVENTORY_PAGE_SIZE * 4)
+			s_grid23.Put(x - SPECIAL_INVENTORY_PAGE_SIZE * 3, 1, item->GetSize());
+		else if (x < SPECIAL_INVENTORY_PAGE_SIZE * 5)
+			s_grid24.Put(x - SPECIAL_INVENTORY_PAGE_SIZE * 4, 1, item->GetSize());
+	}
+	// END_OF_GIFT_BOX
+#endif
+
 	// ...   ... ȥ κ  κ     ߸̴ Ф
 	static std::vector <WORD> s_vDSGrid(DRAGON_SOUL_INVENTORY_MAX_NUM);
 
 	// ϴ ȥ ȯ  ɼ ũǷ, ȥ κ  ȥ   ϵ Ѵ.
 	bool bDSInitialized = false;
-#endif
 
 	for (i = 0; i < EXCHANGE_ITEM_MAX_NUM; ++i)
 	{
 		if (!(item = m_apItems[i]))
 			continue;
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
 		if (item->IsDragonSoul())
 		{
 			if (!victim->DragonSoul_IsQualified())
@@ -576,8 +668,77 @@
 			if (!bExistEmptySpace)
 				return false;
 		}
-		else
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+		else if (item->IsSkillBook())
+		{
+			int iPos;
+
+			if ((iPos = s_grid5.FindBlank(1, item->GetSize())) >= 0)
+				s_grid5.Put(iPos, 1, item->GetSize());
+			else if ((iPos = s_grid6.FindBlank(1, item->GetSize())) >= 0)
+				s_grid6.Put(iPos, 1, item->GetSize());
+			else if ((iPos = s_grid7.FindBlank(1, item->GetSize())) >= 0)
+				s_grid7.Put(iPos, 1, item->GetSize());
+			else if ((iPos = s_grid8.FindBlank(1, item->GetSize())) >= 0)
+				s_grid8.Put(iPos, 1, item->GetSize());
+			else if ((iPos = s_grid9.FindBlank(1, item->GetSize())) >= 0)
+				s_grid9.Put(iPos, 1, item->GetSize());
+			else
+				return false; // No space left in inventory
+		}
+		else if (item->IsUpgradeItem())
+		{
+			int iPos;
+
+			if ((iPos = s_grid10.FindBlank(1, item->GetSize())) >= 0)
+				s_grid10.Put(iPos, 1, item->GetSize());
+			else if ((iPos = s_grid11.FindBlank(1, item->GetSize())) >= 0)
+				s_grid11.Put(iPos, 1, item->GetSize());
+			else if ((iPos = s_grid12.FindBlank(1, item->GetSize())) >= 0)
+				s_grid12.Put(iPos, 1, item->GetSize());
+			else if ((iPos = s_grid13.FindBlank(1, item->GetSize())) >= 0)
+				s_grid13.Put(iPos, 1, item->GetSize());
+			else if ((iPos = s_grid14.FindBlank(1, item->GetSize())) >= 0)
+				s_grid14.Put(iPos, 1, item->GetSize());
+			else
+				return false; // No space left in inventory
+		}
+		else if (item->IsStone())
+		{
+			int iPos;
+
+			if ((iPos = s_grid15.FindBlank(1, item->GetSize())) >= 0)
+				s_grid15.Put(iPos, 1, item->GetSize());
+			else if ((iPos = s_grid16.FindBlank(1, item->GetSize())) >= 0)
+				s_grid16.Put(iPos, 1, item->GetSize());
+			else if ((iPos = s_grid17.FindBlank(1, item->GetSize())) >= 0)
+				s_grid17.Put(iPos, 1, item->GetSize());
+			else if ((iPos = s_grid18.FindBlank(1, item->GetSize())) >= 0)
+				s_grid18.Put(iPos, 1, item->GetSize());
+			else if ((iPos = s_grid19.FindBlank(1, item->GetSize())) >= 0)
+				s_grid19.Put(iPos, 1, item->GetSize());
+			else
+				return false; // No space left in inventory
+		}
+		else if (item->IsGiftBox())
+		{
+			int iPos;
+
+			if ((iPos = s_grid20.FindBlank(1, item->GetSize())) >= 0)
+				s_grid20.Put(iPos, 1, item->GetSize());
+			else if ((iPos = s_grid21.FindBlank(1, item->GetSize())) >= 0)
+				s_grid21.Put(iPos, 1, item->GetSize());
+			else if ((iPos = s_grid22.FindBlank(1, item->GetSize())) >= 0)
+				s_grid22.Put(iPos, 1, item->GetSize());
+			else if ((iPos = s_grid23.FindBlank(1, item->GetSize())) >= 0)
+				s_grid23.Put(iPos, 1, item->GetSize());
+			else if ((iPos = s_grid24.FindBlank(1, item->GetSize())) >= 0)
+				s_grid24.Put(iPos, 1, item->GetSize());
+			else
+				return false; // No space left in inventory
+		}
 #endif
+		else
 		{
 			int iPos;
 
@@ -585,35 +746,11 @@
 				s_grid1.Put(iPos, 1, item->GetSize());
 			else if ((iPos = s_grid2.FindBlank(1, item->GetSize())) >= 0)
 				s_grid2.Put(iPos, 1, item->GetSize());
-#if defined(__EXTEND_INVEN_SYSTEM__)
+#if defined(__INVENTORY_4PAGES__)
 			else if ((iPos = s_grid3.FindBlank(1, item->GetSize())) >= 0)
-			{
-				int iExtendMaxPos = (INVENTORY_WIDTH * victim->GetExtendInvenStage()) - 1;
-				if (iPos > iExtendMaxPos)
-					return false;
-
-				if (item->GetSize() > 1)
-				{
-					iExtendMaxPos -= (INVENTORY_WIDTH * (item->GetSize() - 1));
-					if (iPos > iExtendMaxPos)
-						return false;
-				}
 				s_grid3.Put(iPos, 1, item->GetSize());
-			}
 			else if ((iPos = s_grid4.FindBlank(1, item->GetSize())) >= 0)
-			{
-				int iExtendMaxPos = (INVENTORY_WIDTH * (victim->GetExtendInvenStage() - INVENTORY_HEIGHT)) - 1;
-				if (iPos > iExtendMaxPos)
-					return false;
-
-				if (item->GetSize() > 1)
-				{
-					iExtendMaxPos -= (INVENTORY_WIDTH * (item->GetSize() - 1));
-					if (iPos > iExtendMaxPos)
-						return false;
-				}
 				s_grid4.Put(iPos, 1, item->GetSize());
-			}
 #endif
 			else
 				return false; // No space left in inventory
@@ -638,7 +775,7 @@
 		if (vic_cheque > CHEQUE_MAX)
 		{
 			// exchange_packet(GetOwner(), EXCHANGE_SUBHEADER_GC_LESS_CHEQUE, 0, 0, NPOS, 0);
-			GetOwner()->ChatPacket(CHAT_TYPE_INFO, LC_STRING("The has reached cheque limit."));
+			GetOwner()->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("The has reached cheque limit."));
 			return false;
 		}
 	}
@@ -649,11 +786,19 @@
 		if (!(item = m_apItems[i]))
 			continue;
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
 		if (item->IsDragonSoul())
 			empty_pos = victim->GetEmptyDragonSoulInventory(item);
-		else
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+		else if (item->IsSkillBook())
+			empty_pos = victim->GetEmptySkillBookInventory(item->GetSize());
+		else if (item->IsUpgradeItem())
+			empty_pos = victim->GetEmptyUpgradeItemsInventory(item->GetSize());
+		else if (item->IsStone())
+			empty_pos = victim->GetEmptyStoneInventory(item->GetSize());
+		else if (item->IsGiftBox())
+			empty_pos = victim->GetEmptyGiftBoxInventory(item->GetSize());
 #endif
+		else
 			empty_pos = victim->GetEmptyInventory(item->GetSize());
 
 		if (empty_pos < 0)
@@ -671,9 +816,7 @@
 		}
 
 		assert(empty_pos >= 0);
-
-		m_pOwner->SyncQuickslot(SLOT_TYPE_INVENTORY, item->GetCell(), WORD_MAX);
-
+		
 #ifdef __GROWTH_PET_SYSTEM__
 		if (item->GetType() == ITEM_PET && item->GetSubType() == PET_BAG)
 		{
@@ -690,12 +833,22 @@
 		}
 #endif
 
+		m_pOwner->SyncQuickslot(QUICKSLOT_TYPE_ITEM, item->GetCell(), 255);
+
 		item->RemoveFromCharacter();
-#if defined(__DRAGON_SOUL_SYSTEM__)
 		if (item->IsDragonSoul())
 			item->AddToCharacter(victim, TItemPos(DRAGON_SOUL_INVENTORY, empty_pos));
-		else
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+		else if (item->IsSkillBook())
+			item->AddToCharacter(victim, TItemPos(INVENTORY, empty_pos));
+		else if (item->IsUpgradeItem())
+			item->AddToCharacter(victim, TItemPos(INVENTORY, empty_pos));
+		else if (item->IsStone())
+			item->AddToCharacter(victim, TItemPos(INVENTORY, empty_pos));
+		else if (item->IsGiftBox())
+			item->AddToCharacter(victim, TItemPos(INVENTORY, empty_pos));
 #endif
+		else
 			item->AddToCharacter(victim, TItemPos(INVENTORY, empty_pos));
 		ITEM_MANAGER::instance().FlushDelayedSave(item);
 
@@ -776,44 +929,41 @@
 
 		LPCHARACTER victim = GetCompany()->GetOwner();
 
-		// PREVENT_PORTAL_AFTER_EXCHANGE
+		//PREVENT_PORTAL_AFTER_EXCHANGE
 		GetOwner()->SetExchangeTime();
 		victim->SetExchangeTime();
-		// END_PREVENT_PORTAL_AFTER_EXCHANGE
+		//END_PREVENT_PORTAL_AFTER_EXCHANGE
 
-		if (GetOwner()->IsRunningQuest() || victim->IsRunningQuest())
-			goto EXCHANGE_END;
-	
 		// exchange_check  ȯ ۵ ڸ ֳ Ȯϰ,
 		// ũ  ֳ ȮѴ, ι° ڷ ȯ  
 		//  Ѵ.
 		if (!Check(&iItemCount))
 		{
-			GetOwner()->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ϰų  ڸ ϴ."));
-			victim->ChatPacket(CHAT_TYPE_INFO, LC_STRING("  ϰų  ڸ ϴ."));
+			GetOwner()->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ϰų  ڸ ϴ."));
+			victim->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ϰų  ڸ ϴ."));
 			goto EXCHANGE_END;
 		}
 
 		//      ǰ  ڸ ֳ ȮѴ.
 		if (!CheckSpace())
 		{
-			GetOwner()->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ǰ   ϴ."));
-			victim->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ǰ   ϴ."));
+			GetOwner()->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ǰ   ϴ."));
+			victim->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ǰ   ϴ."));
 			goto EXCHANGE_END;
 		}
 
 		// 浵 ..
 		if (!GetCompany()->Check(&iItemCount))
 		{
-			victim->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ϰų  ڸ ϴ."));
-			GetOwner()->ChatPacket(CHAT_TYPE_INFO, LC_STRING("  ϰų  ڸ ϴ."));
+			victim->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ϰų  ڸ ϴ."));
+			GetOwner()->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ϰų  ڸ ϴ."));
 			goto EXCHANGE_END;
 		}
 
 		if (!GetCompany()->CheckSpace())
 		{
-			victim->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ǰ   ϴ."));
-			GetOwner()->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ǰ   ϴ."));
+			victim->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ǰ   ϴ."));
+			GetOwner()->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ǰ   ϴ."));
 			goto EXCHANGE_END;
 		}
 
@@ -846,8 +996,8 @@
 #endif
 
 				// INTERNATIONAL_VERSION
-				GetOwner()->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s ԰ ȯ  Ǿϴ.", victim->GetName()));
-				victim->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s ԰ ȯ  Ǿϴ.", GetOwner()->GetName()));
+				GetOwner()->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s ԰ ȯ  Ǿϴ."), victim->GetName());
+				victim->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s ԰ ȯ  Ǿϴ."), GetOwner()->GetName());
 				// END_OF_INTERNATIONAL_VERSION
 			}
 		}
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/growth_pet.cpp final/server/server/home/metin2/Source/Server/game/src/growth_pet.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/growth_pet.cpp	2025-06-29 13:59:36.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/growth_pet.cpp	2026-02-20 18:05:02.450190375 +0000
@@ -1,4 +1,5 @@
 #include "stdafx.h"
+#ifdef __GROWTH_PET_SYSTEM__
 #include "growth_pet.h"
 #include "utils.h"
 #include "vector.h"
@@ -189,7 +190,7 @@
 ///////////////////////////////////////////////////////////////////////////////////////
 CGrowthPet::CGrowthPet(LPCHARACTER pOwner)
 {
-	m_pGrowthPet = nullptr;
+	m_pGrowthPet = 0;
 	m_pOwner = pOwner;
 
 	m_dwID = 0;
@@ -228,21 +229,25 @@
 
 LPGROWTH_PET CGrowthPet::Summon(LPITEM pSummonItem, bool bIsResummon /* = false */)
 {
+	TItemTable* lItem = ITEM_MANAGER::instance().GetTable(pSummonItem->GetVnum());
+	if (!lItem)
+		return nullptr;
+
 	if (GetPetPoint(POINT_UPBRINGING_DURATION) < time(0))
 	{
-		m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s is currently fast asleep."), m_strName.c_str());
+		m_pOwner->ChatPacket(CHAT_TYPE_INFO, "%s is currently fast asleep.", lItem->szLocaleName);
 		return nullptr;
 	}
 
 	if (GetPetPoint(POINT_UPBRINGING_PET_LEVEL) > m_pOwner->GetLevel())
 	{
-		m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Your level is too low to summon the pet."));
+		m_pOwner->ChatPacket(CHAT_TYPE_INFO, "Your level is too low to summon the pet.");
 		return nullptr;
 	}
 
 	if (m_pOwner->GetExchange() || m_pOwner->IsOpenSafebox() || m_pOwner->GetMyShop() || m_pOwner->GetShopOwner() || m_pOwner->IsCubeOpen())
 	{
-		m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot summon your pet whilst trading."));
+		m_pOwner->ChatPacket(CHAT_TYPE_INFO, "You cannot summon your pet whilst trading.");
 		return nullptr;
 	}
 
@@ -263,9 +268,9 @@
 	y += number(-100, 100);
 
 	const DWORD dwPetEvol = GetPetPoint(POINT_UPBRINGING_PET_EVOL_LEVEL);
-	DWORD dwPetVnum = dwPetEvol < PET_EVOLUTION_4 ? pSummonItem->GetValue(0) : pSummonItem->GetValue(3);
+	const DWORD dwPetVnum = dwPetEvol < PET_EVOLUTION_4 ? pSummonItem->GetValue(0) : pSummonItem->GetValue(3);
 
-	m_pGrowthPet = CHARACTER_MANAGER::Instance().SpawnMob(
+	m_pGrowthPet = CHARACTER_MANAGER::instance().SpawnMob(
 		dwPetVnum,
 		m_pOwner->GetMapIndex(),
 		x, y, z,
@@ -303,15 +308,12 @@
 
 	if (!bIsResummon)
 	{
-		m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You have summoned %s."), m_strName.c_str());
+		m_pOwner->ChatPacket(CHAT_TYPE_INFO, "You have summoned %s.", m_strName.c_str());
 
 		m_bMobExpMsg = false;
 		m_bItemExpMsg = false;
 	}
 
-	if (m_pOwner && m_pOwner->GetDesc())
-		m_pOwner->SetQuestFlag("system.grow_pet_summoned", pSummonItem->GetID());
-
 	m_pOwner->ComputePoints();
 
 	growthpet_update_event_info* info = AllocEventInfo<growthpet_update_event_info>();
@@ -322,7 +324,7 @@
 	return this;
 }
 
-void CGrowthPet::Unsummon(bool bSetFlag)
+void CGrowthPet::Unsummon()
 {
 	if (IsSummoned())
 	{
@@ -339,10 +341,7 @@
 
 			m_pOwner->GetDesc()->Packet(&packet, sizeof(packet));
 
-			m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You have dismissed %s."), m_strName.c_str());
-			
-			if (bSetFlag)
-				m_pOwner->SetQuestFlag("system.grow_pet_summoned", 0);
+			m_pOwner->ChatPacket(CHAT_TYPE_INFO, "You have dismissed %s.", m_strName.c_str());
 		}
 	}
 
@@ -363,7 +362,7 @@
 	bool bResult = true;
 	bool bUnsummon = false;
 
-	if (IsSummoned() && (m_pGrowthPet && m_pGrowthPet->IsDead()))
+	if (IsSummoned() && m_pGrowthPet->IsDead())
 		bUnsummon = true;
 	else if (!m_pSummonItem)
 		bUnsummon = true;
@@ -561,7 +560,7 @@
 	SetPetPoint(POINT_UPBRINGING_BIRTHDAY, pGrowthPetTable->lBirthday);
 
 	RefreshAutoSkillFlag();
-
+	
 	m_pSummonItem = ITEM_MANAGER::Instance().FindByVID(m_dwID);
 }
 
@@ -628,7 +627,7 @@
 			DWORD dwNewLevel = GetPetPoint(POINT_UPBRINGING_PET_LEVEL);
 
 			if(m_pOwner)
-				m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s has reached level %d!"), m_strName.c_str(), dwNewLevel);
+				m_pOwner->ChatPacket(CHAT_TYPE_INFO, "%s has reached level %d!", m_strName.c_str(), dwNewLevel);
 
 			ChangePetPoint(POINT_UPBRINGING_PET_NEXT_EXP, GetRequiredTotalExp(dwNewLevel), true);
 
@@ -701,11 +700,11 @@
 		return;
 
 	struct packet_point_change pack;
-	pack.bHeader = HEADER_GC_CHARACTER_POINT_CHANGE;
+	pack.header = HEADER_GC_CHARACTER_POINT_CHANGE;
 	pack.dwVID = m_pGrowthPet->GetVID();
-	pack.wType = POINT_LEVEL;
-	pack.lValue = GetPetPoint(POINT_UPBRINGING_PET_LEVEL);
-	pack.lAmount = 0;
+	pack.type = POINT_LEVEL;
+	pack.value = GetPetPoint(POINT_UPBRINGING_PET_LEVEL);
+	pack.amount = 0;
 
 	GetOwner()->PacketAround(&pack, sizeof(pack));
 }
@@ -720,11 +719,11 @@
 
 	struct packet_point_change pack;
 
-	pack.bHeader = HEADER_GC_CHARACTER_POINT_CHANGE;
+	pack.header = HEADER_GC_CHARACTER_POINT_CHANGE;
 	pack.dwVID = m_pGrowthPet->GetVID();
-	pack.wType = POINT_LEVEL_STEP;
-	pack.lValue = 0;
-	pack.lAmount = 0;
+	pack.type = POINT_LEVEL_STEP;
+	pack.value = 0;
+	pack.amount = 0;
 
 	DWORD dwCurrentEXP = GetPetPoint(POINT_UPBRINGING_PET_EXP);
 	DWORD dwNextEXP = GetRequiredMobExp(GetPetPoint(POINT_UPBRINGING_PET_LEVEL));
@@ -830,6 +829,7 @@
 						pSkillProto->kActivatePctPoly.SetVar("k", j);
 						bSkillFormula1 = (BYTE)pSkillProto->kActivatePctPoly.Eval();
 					}
+
 					packet.aSkill[i].bSkillFormula1[j - 1] = bSkillFormula1;
 
 					pSkillProto->kDurationPoly.SetVar("lv", dwPetLevel);
@@ -856,6 +856,7 @@
 	Change pet's name if new chosen name is valid and
 	player has enough money.
 */
+
 void CGrowthPet::NameChange(const char* c_szName, LPITEM pChangeNameItem, LPITEM pUpBringingItem)
 {
 	if (!m_pOwner)
@@ -872,7 +873,7 @@
 		packet.subheader = SUBHEADER_PET_NAME_CHANGE_FAILED;
 		m_pOwner->GetDesc()->Packet(&packet, sizeof(packet));
 
-		m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("The name entered is too short."));
+		m_pOwner->ChatPacket(CHAT_TYPE_INFO, "The name entered is too short.");
 		return;
 	}
 
@@ -881,7 +882,7 @@
 		packet.subheader = SUBHEADER_PET_NAME_CHANGE_FAILED;
 		m_pOwner->GetDesc()->Packet(&packet, sizeof(packet));
 
-		m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Please enter another name."));
+		m_pOwner->ChatPacket(CHAT_TYPE_INFO, "Please enter another name.");
 		return;
 	}
 
@@ -890,11 +891,11 @@
 		packet.subheader = SUBHEADER_PET_NAME_CHANGE_FAILED;
 		m_pOwner->GetDesc()->Packet(&packet, sizeof(packet));
 
-		m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Please enter another name."));
+		m_pOwner->ChatPacket(CHAT_TYPE_INFO, "Please enter another name.");
 		return;
 	}
 
-	char szNameText[64 + 1];
+	char szNameText[PET_NAME_MAX_SIZE + 1];
 	DBManager::instance().EscapeString(szNameText, sizeof(szNameText), c_szName, strlen(c_szName));
 
 	int iPrice = PET_HATCHING_MONEY;
@@ -903,7 +904,7 @@
 		packet.subheader = SUBHEADER_PET_NAME_CHANGE_FAILED;
 		m_pOwner->GetDesc()->Packet(&packet, sizeof(packet));
 
-		m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You do not have enough Yang."));
+		m_pOwner->ChatPacket(CHAT_TYPE_INFO, "You do not have enough Yang.");
 		return;
 	}
 
@@ -932,7 +933,7 @@
 
 	if (feedPacket->index == FEED_LIFE_TIME_EVENT && m_pOwner->IsUnderRefine())
 	{
-		m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot feed your pet while the refinement window is open."));
+		m_pOwner->ChatPacket(CHAT_TYPE_INFO, "You cannot feed your pet while the refinement window is open.");
 		return;
 	}
 
@@ -973,13 +974,11 @@
 				// Break loop if pet has reached maximum life
 				if (!RewardFood(item, PET_FEED_TYPE_PCT))
 					break;
-
 			}
 		} break;
 
 		case FEED_EXP_EVENT:
 		{
-			DWORD dwTotalEXP = 0;
 			for (int i = 0; i < PET_FEED_SLOT_MAX; ++i)
 			{
 				if (!feedPacket->count[i])
@@ -992,12 +991,12 @@
 					break;
 				}
 
-				DWORD dwItemEXP = 0;
+				DWORD itemEXP = 0;
 				switch (item->GetType())
 				{
 					case ITEM_WEAPON:
 					case ITEM_ARMOR:
-						dwItemEXP = (item->GetCount() * item->GetShopBuyPrice()) / 2;
+						itemEXP = (item->GetCount() * item->GetShopBuyPrice()) / 2;
 						break;
 
 					case ITEM_PET:
@@ -1005,28 +1004,23 @@
 						switch (item->GetSubType())
 						{
 							case PET_EXPFOOD:
-								dwItemEXP = (item->GetCount() * item->GetShopBuyPrice()) / 2;
+								itemEXP = (item->GetCount() * item->GetShopBuyPrice()) / 2;
 								break;
 
 							case PET_EXPFOOD_PER:
-								dwItemEXP = GetRequiredItemExp(GetPetPoint(POINT_UPBRINGING_PET_LEVEL)) * 0.05f;
+								itemEXP = GetRequiredItemExp(GetPetPoint(POINT_UPBRINGING_PET_LEVEL)) * 0.05f;
 								break;
 
 						}
 					} break;
 				}
 				// Reward pet with EXP, if failed break the process 
-				if (RewardEXP(EXP_TYPE_ITEM, dwItemEXP))
-				{
-					ITEM_MANAGER::Instance().RemoveItem(item);
-					dwTotalEXP += dwItemEXP;
-
-				}
+				if (RewardEXP(EXP_TYPE_ITEM, itemEXP))
+					// M2_DESTROY_ITEM(item);
+					ITEM_MANAGER::instance().RemoveItem(item);
 				else
 					break;
 			}
-
-			m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Experience has increased to %d points."), dwTotalEXP);
 		} break;
 
 		case FEED_EVOL_EVENT:
@@ -1155,7 +1149,7 @@
 				{
 					if (!m_bItemExpMsg && (dwCurrentItemEXP >= GetRequiredItemExp(dwPetLevel)))
 					{
-						m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Your pet has gathered enough experience. It now requires Item EXP to reach the next stage of evolution."));
+						m_pOwner->ChatPacket(CHAT_TYPE_INFO, "Your pet has gathered enough experience. It now requires Item EXP to reach the next stage of evolution.");
 						m_bItemExpMsg = true;
 					}
 
@@ -1180,7 +1174,7 @@
 					{
 						if (!m_bMobExpMsg && (bError == LEVELUP_ERROR_OWNER_LEVEL))
 						{
-							m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("The pet's level cannot be higher than the player's."));
+							m_pOwner->ChatPacket(CHAT_TYPE_INFO, "The pet's level cannot be higher than the player's.");
 							m_bMobExpMsg = true;
 						}
 
@@ -1201,7 +1195,7 @@
 			{
 				if (!m_bItemExpMsg)
 				{
-					m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Your pet has gathered enough experience. It now requires Item EXP to reach the next stage of evolution."));
+					m_pOwner->ChatPacket(CHAT_TYPE_INFO, "Your pet has gathered enough experience. It now requires Item EXP to reach the next stage of evolution.");
 					m_bItemExpMsg = true;
 				}
 			}
@@ -1216,9 +1210,9 @@
 			if (dwCurrentItemEXP >= dwRequiredItemEXP)
 			{
 				if (bError == LEVELUP_ERROR_OWNER_LEVEL && (dwCurrentMobEXP >= GetRequiredMobExp(dwPetLevel)))
-					m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("The pet's level cannot be higher than the player's."));
+					m_pOwner->ChatPacket(CHAT_TYPE_INFO, "The pet's level cannot be higher than the player's.");
 
-				m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s refuses to eat anything!"), m_strName.c_str());
+				m_pOwner->ChatPacket(CHAT_TYPE_INFO, "% s refuses to eat anything!", m_strName.c_str());
 
 				return false;
 			}
@@ -1237,7 +1231,7 @@
 					if (bError != LEVELUP_ERROR_NONE)
 					{
 						if (bError == LEVELUP_ERROR_OWNER_LEVEL)
-							m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("The pet's level cannot be higher than the player's."));
+							m_pOwner->ChatPacket(CHAT_TYPE_INFO, "The pet's level cannot be higher than the player's.");
 
 						return true;
 					}
@@ -1334,7 +1328,8 @@
 	if (pItem->GetSubType() == PET_UPBRINGING)
 		CGrowthPetManager::Instance().DeleteGrowthPet(pItem->GetSocket(2), true);
 
-	ITEM_MANAGER::Instance().RemoveItem(pItem);
+	// M2_DESTROY_ITEM(pItem);
+	ITEM_MANAGER::instance().RemoveItem(pItem);
 
 	return true;
 }
@@ -1393,7 +1388,8 @@
 		if (dwItemCount < requiredMaterialCount)
 		{
 			requiredMaterialCount -= dwItemCount;
-			ITEM_MANAGER::Instance().RemoveItem(item);
+			//M2_DESTROY_ITEM(item);
+			ITEM_MANAGER::instance().RemoveItem(item);
 			continue;
 		}
 		else
@@ -1441,7 +1437,7 @@
 	else
 	{
 		ChangePetPoint(POINT_UPBRINGING_BIRTHDAY, time(0), true);
-		m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Your pet enthusiastically tucks into the Protein Snack."));
+		m_pOwner->ChatPacket(CHAT_TYPE_INFO, "Your pet enthusiastically tucks into the Protein Snack.");
 	}
 
 	m_dwAgeApply = 0;
@@ -1478,9 +1474,9 @@
 			}
 
 			if (i < PET_EVOLUTION_3)
-				m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Your pet is ready to evolve. Use Pet Books to achieve this."));
+				m_pOwner->ChatPacket(CHAT_TYPE_INFO, "Your pet is ready to evolve. Use Pet Books to achieve this.");
 			else if (i == PET_EVOLUTION_3)
-				m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Acquire the Valiant Pet Book for your pet's hero training."));
+				m_pOwner->ChatPacket(CHAT_TYPE_INFO, "Acquire the Valiant Pet Book for your pet's hero training.");
 		}
 	}
 }
@@ -1500,22 +1496,22 @@
 
 	if (dwEvolution == PET_EVOLUTION_4)
 	{
-		m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Your pet has already reached the highest stage of evolution."));
+		m_pOwner->ChatPacket(CHAT_TYPE_INFO, "Your pet has already reached the highest stage of evolution.");
 		return true;
 	}
 
 	DWORD idx = dwEvolution - 1;
 	DWORD dwLevel = GetPetPoint(POINT_UPBRINGING_PET_LEVEL);
 
-	if (dwLevel >= m_pOwner->GetLevel() && dwEvolution < PET_EVOLUTION_3)
+	if (dwLevel >= m_pOwner->GetLevel() && dwEvolution < PET_EVOLUTION_4)
 	{
-		m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("The pet's level cannot be higher than the player's."));
+		m_pOwner->ChatPacket(CHAT_TYPE_INFO, "The pet's level cannot be higher than the player's.");
 		return true;
 	}
 
 	if (dwLevel < arPetEvolutionTable[idx].dwLevel)
 	{
-		m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Your pet must be level %d to train and promote it to the next stage of evolution."), arPetEvolutionTable[idx].dwLevel);
+		m_pOwner->ChatPacket(CHAT_TYPE_INFO, "Your pet must be level %d to train and promote it to the next stage of evolution.", arPetEvolutionTable[idx].dwLevel);
 		return true;
 	}
 
@@ -1523,7 +1519,7 @@
 	{
 		if ((GetPetPoint(POINT_UPBRINGING_PET_EXP) + GetPetPoint(POINT_UPBRINGING_PET_ITEM_EXP)) < GetPetPoint(POINT_UPBRINGING_PET_NEXT_EXP))
 		{
-			m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Your pet must have 100% experience to train and promote it to the next stage of evolution."));
+			m_pOwner->ChatPacket(CHAT_TYPE_INFO, "Your pet must have 100% experience to train and promote it to the next stage of evolution.");
 			return true;
 		}
 	}
@@ -1534,7 +1530,7 @@
 
 		if (dwDayCount < PET_LAST_EVOL_MIN_DAY_COUNT)
 		{
-			m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Your pet must be %d days old to train and promote it to the next stage of evolution."), PET_LAST_EVOL_MIN_DAY_COUNT);
+			m_pOwner->ChatPacket(CHAT_TYPE_INFO, "Your pet must be %d days old to train and promote it to the next stage of evolution.", PET_LAST_EVOL_MIN_DAY_COUNT);
 			return true;
 		}
 	}
@@ -1547,10 +1543,6 @@
 
 		for (int j = 0; j < PET_FEED_SLOT_MAX; ++j)
 		{
-
-			if (requiredItem.first == 0)
-				continue;
-
 			// We hit end of the array, break the loop
 			if (!feedPacket->count[j])
 				break;
@@ -1568,9 +1560,9 @@
 
 		if (!bIsFound)
 		{
-			TItemTable* lItem = ITEM_MANAGER::Instance().GetTable(requiredItem.first);
+			TItemTable* lItem = ITEM_MANAGER::instance().GetTable(requiredItem.first);
 			if (lItem)
-				m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s is insufficient. You need %d for the next stage of evolution."), lItem->szLocaleName, requiredItem.second);
+				m_pOwner->ChatPacket(CHAT_TYPE_INFO, "%s is insufficient. You need %d for the next stage of evolution.", lItem->szLocaleName, requiredItem.second);
 		}
 	}
 
@@ -1599,7 +1591,7 @@
 			ChangePetPoint(POINT_UPBRINGING_PET_LEVEL, 1);
 		}
 
-		m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s has evolved to %s! Excellent!"), m_strName.c_str(), arPetEvolutionTable[idx].szEvolutionName);
+		m_pOwner->ChatPacket(CHAT_TYPE_INFO, "%s has evolved to %s! Excellent!", m_strName.c_str(), arPetEvolutionTable[idx].szEvolutionName);
 	}
 
 	return true;
@@ -1621,7 +1613,7 @@
 	Summon(m_pSummonItem, true);
 	
 	if(GetPetPoint(POINT_UPBRINGING_PET_EVOL_LEVEL) > PET_EVOLUTION_1)
-		m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s has evolved to %s! Excellent!"), m_strName.c_str(), arPetEvolutionTable[dwEvolution - 2].szEvolutionName);
+		m_pOwner->ChatPacket(CHAT_TYPE_INFO, "%s has evolved to %s! Excellent!", m_strName.c_str(), arPetEvolutionTable[dwEvolution - 2].szEvolutionName);
 }
 
 /*
@@ -1849,7 +1841,6 @@
 	ChangePetPoint(POINT_UPBRINGING_DURATION, time(0) + petDuration, true);
 	pSummonItem->SetSocket(0, time(0) + petDuration);
 	pSummonItem->SetSocket(1, petDuration);
-	pSummonItem->SetSocket(3, m_bType);
 
 	// Change skill slot count in case no skills have been learned yet
 	bool bChangeSkill = true;
@@ -1867,7 +1858,6 @@
 		BYTE bSkillCount = number(1, hatchTable.bMaxSKillCount);
 		if (pSummonItem->GetVnum() == PET_EXEDYAR)
 			bSkillCount = 3;
-
 		for (int i = 0; i < PET_SKILL_COUNT_MAX; ++i)
 		{
 			if(i < bSkillCount)
@@ -1877,11 +1867,7 @@
 		}
 	}
 
-	m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Your pet's stats have been modified."));
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	m_pOwner->UpdateExtBattlePassMissionProgress(PET_ENCHANT, 1, m_bType);
-#endif
+	m_pOwner->ChatPacket(CHAT_TYPE_INFO, "Your pet's stats have been modified.");
 
 	if (m_pOwner->GetDesc())
 	{
@@ -1918,7 +1904,7 @@
 	{
 		if (skill.bSkill == bSkillValue)
 		{
-			m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Your pet has already learnt this skill and refuses to practice it again."));
+			m_pOwner->ChatPacket(CHAT_TYPE_INFO, "Your pet has already learnt this skill and refuses to practice it again.");
 			return;
 		}
 	}
@@ -1926,9 +1912,10 @@
 	m_aSkill[bSlot].bLevel = 1;
 	m_aSkill[bSlot].bSkill = bSkillValue;
 
-	m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You've taught your pet well! It's quickly learning its new skills!"));
+	m_pOwner->ChatPacket(CHAT_TYPE_INFO, "You've taught your pet well! It's quickly learning its new skills!");
 
-	ITEM_MANAGER::Instance().RemoveItem(pSkillBookItem);
+	//M2_DESTROY_ITEM(pSkillBookItem);
+	ITEM_MANAGER::instance().RemoveItem(pSkillBookItem);
 
 	RefreshAutoSkillFlag();
 	UpdateSkillPacket();
@@ -1958,7 +1945,7 @@
 	m_pOwner->PointChange(POINT_GOLD, -iPrice);
 	m_aSkill[bSlot].bLevel += 1;
 
-	m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You've taught your pet well! It's quickly learning its new skills!"));
+	m_pOwner->ChatPacket(CHAT_TYPE_INFO, "You've taught your pet well! It's quickly learning its new skills!");
 
 	UpdateSkillPacket();
 
@@ -1977,7 +1964,8 @@
 	m_aSkill[bSlot].bSkill = 0;
 	m_aSkill[bSlot].bLevel = 0;
 	m_aSkill[bSlot].dwCooltime = 0;
-	ITEM_MANAGER::Instance().RemoveItem(pSkillDeleteItem);
+	// M2_DESTROY_ITEM(pSkillDeleteItem);
+	ITEM_MANAGER::instance().RemoveItem(pSkillDeleteItem);
 
 	RefreshAutoSkillFlag();
 	UpdateSkillPacket();
@@ -1998,7 +1986,8 @@
 		m_aSkill[i].dwCooltime = 0;
 	}
 
-	ITEM_MANAGER::Instance().RemoveItem(pDeleteAllSkillItem);
+	// M2_DESTROY_ITEM(pDeleteAllSkillItem);
+	ITEM_MANAGER::instance().RemoveItem(pDeleteAllSkillItem);
 
 	RefreshAutoSkillFlag();
 	UpdateSkillPacket();
@@ -2096,7 +2085,7 @@
 			{
 				m_pOwner->PointChange(POINT_HP, wSkillValue);
 				m_pOwner->EffectPacket(SE_HPUP_RED);
-				m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s skill activated. HP restored by %d."), pSkillProto->szName, wSkillValue);
+				m_pOwner->ChatPacket(CHAT_TYPE_INFO, "%s skill activated. HP restored by %d.", pSkillProto->szName, wSkillValue);
 			} break;
 
 			case PET_SKILL_AFFECT_INVINCIBILITY:
@@ -2108,13 +2097,13 @@
 				info->ch = m_pOwner;
 
 				event_create(invincible_skill_end_event, info, PASSES_PER_SEC(fInvincibleTime));
-				m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s skill activated. You will now receive no damage."), pSkillProto->szName);
+				m_pOwner->ChatPacket(CHAT_TYPE_INFO, "%s skill activated. You will now receive no damage.", pSkillProto->szName);
 			} break;
 
 			case PET_SKILL_AFFECT_REMOVAL:
 			{
 				m_pOwner->RemoveBadAffect();
-				m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s skill activated. Slow, poison and bleeding effects were removed."), pSkillProto->szName);
+				m_pOwner->ChatPacket(CHAT_TYPE_INFO, "%s skill activated. Slow, poison and bleeding effects were removed.", pSkillProto->szName);
 			} break;
 
 			case PET_SKILL_FEATHER:
@@ -2131,7 +2120,7 @@
 
 				m_pFeatherSkillEvent = event_create(feather_skill_event, info, PASSES_PER_SEC(1));
 
-				m_pOwner->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s's pet skill has been activated. %s uses Feather Walk."), m_pOwner->GetName() , m_strName.c_str());
+				m_pOwner->ChatPacket(CHAT_TYPE_INFO, "%s's pet skill has been activated. %s uses Feather Walk.", m_pOwner->GetName() , m_strName.c_str());
 			} break;
 		}
 	}
@@ -2220,17 +2209,14 @@
 
 CGrowthPetManager::~CGrowthPetManager()
 {
-	if (m_growthPetSkillMap.size())
-	{
-		auto it = m_growthPetSkillMap.begin();
+	auto it = m_growthPetSkillMap.begin();
 
-		while (it != m_growthPetSkillMap.end())
-		{
-			for (const auto& kv : it->second)
-				M2_DELETE(kv.second);
+	while (it != m_growthPetSkillMap.end()) 
+	{
+		for (const auto& kv : it->second)
+			M2_DELETE(kv.second);
 
-			++it;
-		}
+		++it;
 	}
 }
 
@@ -2298,10 +2284,10 @@
 	return it->second;
 }
 
-void CGrowthPetManager::GenerateGrowthPetProto(LPCHARACTER ch, TGrowthPet* pGrowthPetTable, LPITEM pEggItem, const char* c_szName)
+void CGrowthPetManager::GenerateGrowthPetProto(LPCHARACTER ch, TGrowthPet* pGrowthPetTable, LPITEM pEgg, const char* c_szName)
 {
-	int iHatchPrice = pEggItem->GetValue(3);
-	DWORD dwUpBringingVnum = pEggItem->GetVnum() + EGG_TO_UPBRINGING_DELTA;
+	int iHatchPrice = pEgg->GetValue(3);
+	DWORD dwUpBringingVnum = pEgg->GetVnum() + EGG_TO_UPBRINGING_DELTA;
 	TPetHatch hatchTable = arPetHatchTable[dwUpBringingVnum - PET_MONKEY];
 
 	// Duration
@@ -2313,7 +2299,6 @@
 	BYTE bSkillCount = number(1, hatchTable.bMaxSKillCount);
 	if (dwUpBringingVnum == PET_EXEDYAR)
 		bSkillCount = 3;
-
 	for (int i = 0; i < bSkillCount; ++i)
 		aSkill[i].bLocked = false;
 
@@ -2334,14 +2319,15 @@
 	dwDef = number(1, 21);
 
 	ch->PointChange(POINT_GOLD, -iHatchPrice);
-	ITEM_MANAGER::Instance().RemoveItem(pEggItem, "REMOVE (EGG HATCH)");
+	//ch->PointChange(POINT_GOLD, -PET_HATCHING_MONEY);
+	ITEM_MANAGER::Instance().RemoveItem(pEgg, "REMOVE (EGG HATCH)");
+
 
 	LPITEM pUpBringingItem = ch->AutoGiveItem(dwUpBringingVnum, 1);
 
 	pUpBringingItem->SetSocket(0, time(0) + petDuration);
 	pUpBringingItem->SetSocket(1, petDuration);
 	pUpBringingItem->SetSocket(2, pUpBringingItem->GetID());
-	pUpBringingItem->SetSocket(3, bPetType);
 
 	// Fill pet's information table with values
 	pGrowthPetTable->dwID = pUpBringingItem->GetID();
@@ -2374,31 +2360,28 @@
 	TPacketGCPet packet;
 	packet.header = HEADER_GC_PET;
 
-	LPITEM pEggItem = ch->GetItem(Cell);
+	LPITEM eggItem = ch->GetItem(Cell);
 
-	if (!pEggItem)
+	if (!eggItem)
 	{
 		packet.subheader = SUBHEADER_PET_EGG_USE_FAILED_TIMEOVER;
 		ch->GetDesc()->Packet(&packet, sizeof(packet));
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("SUBHEADER_PET_EGG_USE_FAILED_TIMEOVER"));
 		return;
 	}
 
-	if (!(pEggItem->GetType() == ITEM_PET && pEggItem->GetSubType() == PET_EGG))
+	if (!(eggItem->GetType() == ITEM_PET && eggItem->GetSubType() == PET_EGG))
 	{
 		packet.subheader = SUBHEADER_PET_EGG_USE_FAILED_TIMEOVER;
 		ch->GetDesc()->Packet(&packet, sizeof(packet));
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("SUBHEADER_PET_EGG_USE_FAILED_TIMEOVER2"));
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Type: %d, Subtype: %d"), pEggItem->GetType(), pEggItem->GetSubType());
 		return;
 	}
 
-	if (ch->GetGold() < pEggItem->GetValue(3))
+	if (ch->GetGold() < eggItem->GetValue(3))
 	{
 		packet.subheader = SUBHEADER_PET_EGG_USE_FAILED_TIMEOVER;
 		ch->GetDesc()->Packet(&packet, sizeof(packet));
 
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You do not have enough Yang."));
+		ch->ChatPacket(CHAT_TYPE_INFO, "You do not have enough Yang.");
 		return;
 	}
 
@@ -2407,16 +2390,16 @@
 		packet.subheader = SUBHEADER_PET_EGG_USE_FAILED_BECAUSE_NAME;
 		ch->GetDesc()->Packet(&packet, sizeof(packet));
 
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("The name entered is too short."));
+		ch->ChatPacket(CHAT_TYPE_INFO, "The name entered is too short.");
 		return;
 	}
 
-	if (CBanwordManager::Instance().CheckString(c_szName, strlen(c_szName)))
+	if (CBanwordManager::instance().CheckString(c_szName, strlen(c_szName)))
 	{
 		packet.subheader = SUBHEADER_PET_EGG_USE_FAILED_BECAUSE_NAME;
 		ch->GetDesc()->Packet(&packet, sizeof(packet));
 
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Please enter another name."));
+		ch->ChatPacket(CHAT_TYPE_INFO, "Please enter another name.");
 		return;
 	}
 
@@ -2425,7 +2408,7 @@
 		packet.subheader = SUBHEADER_PET_EGG_USE_FAILED_BECAUSE_NAME;
 		ch->GetDesc()->Packet(&packet, sizeof(packet));
 
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Please enter another name."));
+		ch->ChatPacket(CHAT_TYPE_INFO, "Please enter another name.");
 		return;
 	}
 
@@ -2433,33 +2416,25 @@
 	DBManager::instance().EscapeString(szNameText, sizeof(szNameText), c_szName, strlen(c_szName));
 
 	TGrowthPet petTable;
-	GenerateGrowthPetProto(ch, &petTable, pEggItem, szNameText);
+	GenerateGrowthPetProto(ch, &petTable, eggItem, szNameText);
 	if (!petTable.dwID)
-	{
-		ch->GetDesc()->Packet(&packet, sizeof(packet));
-		ch->ChatPacket(CHAT_TYPE_INFO, "1");
 		return;
-	}
 
-	LPGROWTH_PET pPet = CreateGrowthPet(ch, petTable.dwID);
-	if (!pPet)
-	{
-		ch->GetDesc()->Packet(&packet, sizeof(packet));
-		ch->ChatPacket(CHAT_TYPE_INFO, "2");
+	LPGROWTH_PET pet = CreateGrowthPet(ch, petTable.dwID);
+	if (!pet)
 		return;
-	}
 
-	pPet->SetGrowthPetProto(&petTable);
-	pPet->Save();
+	pet->SetGrowthPetProto(&petTable);
+	pet->Save();
 
-	ch->SetGrowthPet(pPet);
+	ch->SetGrowthPet(pet);
 
 	packet.subheader = SUBHEADER_PET_EGG_USE_SUCCESS;
 	ch->GetDesc()->Packet(&packet, sizeof(packet));
 
-	TItemTable* lItem = ITEM_MANAGER::Instance().GetTable(petTable.dwVnum);
+	TItemTable* lItem = ITEM_MANAGER::instance().GetTable(petTable.dwVnum);
 	if (lItem)
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s has hatched!"), lItem->szLocaleName);
+		ch->ChatPacket(CHAT_TYPE_INFO, "%s has hatched!", lItem->szLocaleName);
 }
 
 struct SPetPointOnType
@@ -2471,8 +2446,8 @@
 	{ "RESIST_SURA",				POINT_RESIST_SURA	},
 	{ "RESIST_ASSASSIN",			POINT_RESIST_ASSASSIN	},
 	{ "RESIST_SHAMAN",				POINT_RESIST_SHAMAN	},
-	{ "RESIST_WOLFMAN",				POINT_NONE	},
-	{ "RESIST_MAGIC_REDUCTION",		POINT_NONE	},
+	{ "RESIST_WOLFMAN",				POINT_RESIST_WOLFMAN	},
+	{ "RESIST_MAGIC_REDUCTION",		POINT_RESIST_MAGIC_REDUCTION	},
 	{ "MELEE_MAGIC_ATT_BONUS_PER",	POINT_MELEE_MAGIC_ATT_BONUS_PER	},
 	{ "ATTBONUS_MONSTER",			POINT_ATTBONUS_MONSTER	},
 	{ "PENETRATE_PCT",				POINT_PENETRATE_PCT	},
@@ -2532,7 +2507,7 @@
 	for (int i = 0; i < iSize; ++i, ++pTab)
 	{
 		CPetSkillProto* pProto = M2_NEW CPetSkillProto;
-				 
+		 
 		pProto->dwPetVnum = pTab->dwPetVnum;
 		pProto->dwSkillVnum = pTab->dwSkillVnum;
 		strlcpy(pProto->szName, pTab->szName, sizeof(pProto->szName));
@@ -2646,7 +2621,7 @@
 		}
 
 		// Insert loaded skills
-		for (const auto& pSkill : skillVec)
+		for (auto pSkill : skillVec)
 			m_growthPetSkillMap[pSkill->dwPetVnum][pSkill->dwSkillVnum] = pSkill;
 	}
 
@@ -2665,4 +2640,6 @@
 		return nullptr;
 
 	return skillIterator->second;
-}
\ No newline at end of file
+}
+
+#endif
\ No newline at end of file
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/growth_pet.h final/server/server/home/metin2/Source/Server/game/src/growth_pet.h
--- baseline/server/server/home/metin2/Source/Server/game/src/growth_pet.h	2024-07-20 11:53:34.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/growth_pet.h	2026-02-20 18:05:02.462776627 +0000
@@ -137,7 +137,7 @@
 		TPetSkill*		GetPetSkill() { return m_aSkill; }
 		
 		LPGROWTH_PET	Summon(LPITEM pSummonItem, bool bIsResummon = false);
-		void			Unsummon(bool bSetFlag = true);
+		void			Unsummon();
 		bool			IsSummoned() const	{ return 0 != m_pGrowthPet; }
 
 		/* Update Functions */
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/guild.cpp final/server/server/home/metin2/Source/Server/game/src/guild.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/guild.cpp	2026-02-17 17:38:44.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/guild.cpp	2021-06-22 11:06:27.000000000 +0000
@@ -16,6 +16,9 @@
 #include "locale_service.h"
 #include "log.h"
 #include "questmanager.h"
+#if defined(__GUILD_DRAGONLAIR__)
+#include "MeleyLair.h"
+#endif
 
 SGuildMember::SGuildMember(LPCHARACTER ch, BYTE grade, DWORD offer_exp)
 	: pid(ch->GetPlayerID()), grade(grade), is_general(0), job(ch->GetJob()), level(ch->GetLevel()), offer_exp(offer_exp), name(ch->GetName())
@@ -63,35 +66,30 @@
 
 	strlcpy(m_data.name, cp.name, sizeof(m_data.name));
 	m_data.master_pid = cp.master->GetPlayerID();
-	strlcpy(m_data.grade_array[0].grade_name, LC_STRING(""), sizeof(m_data.grade_array[0].grade_name));
+	strlcpy(m_data.grade_array[0].grade_name, "Leader", sizeof(m_data.grade_array[0].grade_name));
 	m_data.grade_array[0].auth_flag = GUILD_AUTH_ADD_MEMBER | GUILD_AUTH_REMOVE_MEMBER | GUILD_AUTH_NOTICE | GUILD_AUTH_USE_SKILL;
 
 	for (int i = 1; i < GUILD_GRADE_COUNT; ++i)
 	{
-		strlcpy(m_data.grade_array[i].grade_name, LC_STRING(""), sizeof(m_data.grade_array[i].grade_name));
+		strlcpy(m_data.grade_array[i].grade_name, "...", sizeof(m_data.grade_array[i].grade_name));
 		m_data.grade_array[i].auth_flag = 0;
 	}
 
 	std::unique_ptr<SQLMsg> pmsg(DBManager::instance().DirectQuery(
-		"INSERT INTO `guild%s` (`name`, `master`, `sp`, `level`, `exp`, `skill_point`, `skill`) "
+		"INSERT INTO guild%s(name, master, sp, level, exp, skill_point, skill) "
 		"VALUES('%s', %u, 1000, 1, 0, 0, '\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0')",
 		get_table_postfix(), m_data.name, m_data.master_pid));
 
 	// TODO if error occur?
 	m_data.guild_id = pmsg->Get()->uiInsertID;
 
-	char grade_name[GUILD_GRADE_NAME_MAX_LEN * 2 + 1];
-
 	for (int i = 0; i < GUILD_GRADE_COUNT; ++i)
 	{
-		DBManager::instance().EscapeString(grade_name, sizeof(grade_name),
-			m_data.grade_array[i].grade_name, strlen(m_data.grade_array[i].grade_name));
-
-		DBManager::instance().Query("INSERT INTO `guild_grade%s` VALUES(%u, %d, '%s', %d)",
+		DBManager::instance().Query("INSERT INTO guild_grade%s VALUES(%u, %d, '%s', %d)",
 			get_table_postfix(),
 			m_data.guild_id,
 			i + 1,
-			grade_name,
+			m_data.grade_array[i].grade_name,
 			m_data.grade_array[i].auth_flag);
 	}
 
@@ -196,9 +194,6 @@
 	if (it->second.grade == GUILD_LEADER_GRADE)
 		return false;
 
-	if (UnderAnyWar() != 0)
-		return false;
-
 	TPacketGuild gd_guild;
 
 	gd_guild.dwGuild = GetID();
@@ -231,14 +226,10 @@
 
 	if (ch)
 	{
-		// Hardening: if the member is removed while any safebox-like window is open,
-		// force-close it to prevent "window persistence" item theft after guild kick.
-		if (ch->IsOpenSafebox())
-			ch->CloseSafebox();
-
-		if (ch->GetMall())
-			ch->CloseMall();
 		//GuildRemoveAffect(ch);
+#if defined(__GUILD_DRAGONLAIR__)
+		MeleyLair::CMgr::instance().MemberRemoved(ch, this);
+#endif
 		m_memberOnline.erase(ch);
 		ch->SetGuild(NULL);
 	}
@@ -390,6 +381,7 @@
 
 void CGuild::SendListOneToAll(DWORD pid)
 {
+
 	TPacketGCGuild pack;
 	pack.header = HEADER_GC_GUILD;
 	pack.size = sizeof(TPacketGCGuild);
@@ -629,6 +621,11 @@
 	str_to_number(m_data.draw, row[9]);
 	str_to_number(m_data.loss, row[10]);
 	str_to_number(m_data.gold, row[11]);
+#if defined(__GUILD_DRAGONLAIR_PARTY_SYSTEM__)
+	str_to_number(m_data.dungeon_ch, row[12]);
+	str_to_number(m_data.dungeon_map, row[13]);
+	str_to_number(m_data.dungeon_cooldown, row[14]);
+#endif
 
 	ComputeGuildPoints();
 }
@@ -641,6 +638,9 @@
 
 	DBManager::instance().FuncQuery(std::bind(&CGuild::LoadGuildData, this, std::placeholders::_1),
 		"SELECT master, level, exp, name, skill_point, skill, sp, ladder_point, win, draw, loss, gold"
+#if defined(__GUILD_DRAGONLAIR_PARTY_SYSTEM__)
+		", dungeon_ch, dungeon_map, dungeon_cooldown"
+#endif
 		" FROM guild%s WHERE id = %u", get_table_postfix(), m_data.guild_id);
 
 	sys_log(0, "GUILD: loading guild id %12s %u", m_data.name, guild_id);
@@ -953,12 +953,20 @@
 	if (m_data.exp + amount < m_data.exp)
 		return false;
 
+#if defined(__ANTI_EXP_RING__)
+	if (ch->HasFrozenEXP())
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You have frozen your experience."));
+		return false;
+	}
+#endif
+
 	if (amount < 0)
 		return false;
 
 	if (ch->GetExp() < (DWORD)amount)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> ϰ ϴ ġ  ġ ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> ϰ ϴ ġ  ġ ϴ."));
 		return false;
 	}
 
@@ -967,6 +975,14 @@
 		sys_err("Wrong guild offer amount %d by %s[%u]", amount, ch->GetName(), ch->GetPlayerID());
 		return false;
 	}
+	
+#ifdef __GROWTH_PET_SYSTEM__
+	if (ch->GetActiveGrowthPet())
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, "You cannot donate while your pet is summoned.");
+		return false;
+	}
+#endif
 
 	ch->PointChange(POINT_EXP, -amount);
 
@@ -1063,7 +1079,7 @@
 		int iMin = iDeltaSecs / 60;
 		int iSec = (iDeltaSecs - (iMin * 60));
 
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You can post a new comment in %02d minutes and %02d seconds!", iMin, iSec));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You can post a new comment in %02d minutes and %02d seconds!"), iMin, iSec);
 		return;
 	}
 
@@ -1087,7 +1103,7 @@
 		pmsg = DBManager::instance().DirectQuery("DELETE FROM guild_comment%s WHERE id = %u AND guild_id = %u AND name = '%s'", get_table_postfix(), comment_id, m_data.guild_id, ch->GetName());
 
 	if (pmsg->Get()->uiAffectedRows == 0 || pmsg->Get()->uiAffectedRows == (uint32_t)-1)
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>    Դϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>    Դϴ."));
 	else
 		RefreshCommentForce(ch->GetPlayerID());
 
@@ -1147,10 +1163,8 @@
 
 bool CGuild::ChangeMemberGeneral(DWORD pid, BYTE is_general)
 {
-#if !defined(__GUILD_DRAGONLAIR_SYSTEM__)
 	if (is_general && GetGeneralCount() >= GetMaxGeneralCount())
 		return false;
-#endif
 
 	TGuildMemberContainer::iterator it = m_member.find(pid);
 	if (it == m_member.end())
@@ -1191,19 +1205,6 @@
 	return true;
 }
 
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-BYTE CGuild::IsGeneralMember(DWORD pid)
-{
-	TGuildMemberContainer::iterator it = m_member.begin();
-	for (; it != m_member.end(); ++it)
-	{
-		if (it->first == pid)
-			return it->second.is_general;
-	}
-	return 0;
-}
-#endif
-
 void CGuild::ChangeMemberGrade(DWORD pid, BYTE grade)
 {
 	if (grade == 1)
@@ -1360,7 +1361,7 @@
 
 	if (GetSP() < iNeededSP)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> ŷ մϴ. (%d, %d)", GetSP(), iNeededSP));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> ŷ մϴ. (%d, %d)"), GetSP(), iNeededSP);
 		return;
 	}
 
@@ -1369,7 +1370,7 @@
 
 	if (!abSkillUsable[dwRealVnum])
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> Ÿ  ʾ  ų   ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> Ÿ  ʾ  ų   ϴ."));
 		return;
 	}
 
@@ -1388,7 +1389,7 @@
 	//GuildPointChange(POINT_SP, -iNeededSP);
 
 	if (test_server)
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> %d ų  (%d, %d) to %lu", dwVnum, GetSP(), iNeededSP, pid));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> %d ų  (%d, %d) to %lu"), dwVnum, GetSP(), iNeededSP, pid);
 
 	switch (dwVnum)
 	{
@@ -1409,7 +1410,7 @@
 
 				if (pcci->bChannel != g_bChannel)
 				{
-					ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> 밡 %d äο ֽϴ. ( ä %d)", pcci->bChannel, g_bChannel));
+					ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> 밡 %d äο ֽϴ. ( ä %d)"), pcci->bChannel, g_bChannel);
 				}
 				else
 				{
@@ -1422,7 +1423,7 @@
 				}
 			}
 			else
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> 밡 ¶ ° ƴմϴ."));
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> 밡 ¶ ° ƴմϴ."));
 		}
 		break;
 
@@ -1439,20 +1440,20 @@
 		/*
 		if (ch->GetPlayerID() != GetMasterPID())
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> 常  ų   ֽϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> 常  ų   ֽϴ."));
 			return;
 		}
 		*/
 
 		if (!UnderAnyWar())
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>  ų  ߿   ֽϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>  ų  ߿   ֽϴ."));
 			return;
 		}
 
 		SendDBSkillUpdate(-iNeededSP);
 
-		for (auto it = m_memberOnline.begin(); it != m_memberOnline.end(); ++it)
+		for (itertype(m_memberOnline) it = m_memberOnline.begin(); it != m_memberOnline.end(); ++it)
 		{
 			LPCHARACTER victim = *it;
 			victim->RemoveAffect(dwVnum);
@@ -1600,6 +1601,7 @@
 
 			while (m_data.exp >= __guild_levelup_exp(m_data.level))
 			{
+
 				if (m_data.level < GUILD_MAX_LEVEL)
 				{
 					m_data.exp -= __guild_levelup_exp(m_data.level);
@@ -1781,7 +1783,7 @@
 
 void CGuild::Packet(const void* buf, int size)
 {
-	for (auto it = m_memberOnline.begin(); it!=m_memberOnline.end();++it)
+	for (itertype(m_memberOnline) it = m_memberOnline.begin(); it!=m_memberOnline.end();++it)
 	{
 		LPDESC d = (*it)->GetDesc();
 
@@ -1794,7 +1796,7 @@
 {
 	int total = 0;
 
-	for (auto it = m_member.begin(); it != m_member.end(); ++it)
+	for (itertype(m_member) it = m_member.begin(); it != m_member.end(); ++it)
 	{
 		total += it->second.level;
 	}
@@ -1822,7 +1824,7 @@
 
 	SendDBSkillUpdate(iSP);
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> %lu ŷ ȸϿϴ.", iSP));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> %lu ŷ ȸϿϴ."), iSP);
 	}
 	return true;
 }
@@ -1860,29 +1862,6 @@
 	P2P_MANAGER::instance().Send(&m_iMemberCountBonus, sizeof(int));
 }
 
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-int CGuild::GetNearMemberCount(LPCHARACTER ch)
-{
-	int count = 0;
-
-	TGuildMemberOnlineContainer::iterator it = m_memberOnline.begin();;
-	for (; it != m_memberOnline.end(); ++it)
-	{
-		LPCHARACTER member = *it;
-		if (member == NULL)
-			continue;
-
-		if (ch->GetMapIndex() != member->GetMapIndex())
-			continue;
-
-		if (DISTANCE_APPROX(ch->GetX() - member->GetX(), ch->GetY() - member->GetY()) < 1000)
-			++count;
-	}
-
-	return count;
-}
-#endif
-
 int CGuild::GetMaxMemberCount()
 {
 	// GUILD_IS_FULL_BUG_FIX
@@ -1917,19 +1896,9 @@
 
 void CGuild::RequestDepositMoney(LPCHARACTER ch, int iGold)
 {
-	if (!ch)
-		return;
-	if (iGold <= 0)
-		return;
-	// Prevent negative/overflow deposits (guild bank max is 2,000,000,000 Yang).
-	const long long llMaxGuildGold = 2000000000LL;
-	const long long llNewGold = (long long)m_data.gold + (long long)iGold;
-	if (llNewGold > llMaxGuildGold || llNewGold < 0)
-		return;
-
 	if (false == ch->CanDeposit())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> Ŀ ֽ̿ʽÿ"));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> Ŀ ֽ̿ʽÿ"));
 		return;
 	}
 
@@ -1953,30 +1922,21 @@
 
 void CGuild::RequestWithdrawMoney(LPCHARACTER ch, int iGold)
 {
-	if (!ch)
-		return;
-	if (iGold <= 0)
-		return;
-	// Prevent negative/overflow withdrawals.
-	const long long llMaxGuildGold = 2000000000LL;
-	if ((long long)iGold > (long long)m_data.gold || (long long)m_data.gold > llMaxGuildGold)
-		return;
-
 	if (false == ch->CanDeposit())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> Ŀ ֽ̿ʽÿ"));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> Ŀ ֽ̿ʽÿ"));
 		return;
 	}
 
 	if (ch->GetPlayerID() != GetMasterPID())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>  ݰ 常   ֽϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>  ݰ 常   ֽϴ."));
 		return;
 	}
 
 	if (m_data.gold < iGold)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>  ִ  մϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>  ִ  մϴ."));
 		return;
 	}
 
@@ -1990,9 +1950,6 @@
 
 void CGuild::RecvMoneyChange(int iGold)
 {
-	if (iGold < 0)
-		iGold = 0;
-
 	m_data.gold = iGold;
 
 	TPacketGCGuild p;
@@ -2000,7 +1957,7 @@
 	p.size = sizeof(p) + sizeof(int);
 	p.subheader = GUILD_SUBHEADER_GC_MONEY_CHANGE;
 
-	for (auto it = m_memberOnline.begin(); it != m_memberOnline.end(); ++it)
+	for (itertype(m_memberOnline) it = m_memberOnline.begin(); it != m_memberOnline.end(); ++it)
 	{
 		LPCHARACTER ch = *it;
 		LPDESC d = ch->GetDesc();
@@ -2074,7 +2031,7 @@
 {
 	if (quest::CQuestManager::instance().GetPCForce(pchInviter->GetPlayerID())->IsRunning() == true)
 	{
-		pchInviter->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>  ʴ û    Դϴ."));
+		pchInviter->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>  ʴ û    Դϴ."));
 		return;
 	}
 
@@ -2083,17 +2040,17 @@
 
 	if (pchInvitee->IsBlockMode(BLOCK_GUILD_INVITE))
 	{
-		pchInviter->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>   ʴ ź Դϴ."));
+		pchInviter->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>   ʴ ź Դϴ."));
 		return;
 	}
 	else if (!HasGradeAuth(GetMember(pchInviter->GetPlayerID())->grade, GUILD_AUTH_ADD_MEMBER))
 	{
-		pchInviter->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>  ʴ  ϴ."));
+		pchInviter->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>  ʴ  ϴ."));
 		return;
 	}
 	else if (pchInvitee->GetEmpire() != pchInviter->GetEmpire())
 	{
-		pchInviter->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> ٸ   忡 ʴ  ϴ."));
+		pchInviter->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> ٸ   忡 ʴ  ϴ."));
 		return;
 	}
 
@@ -2103,18 +2060,18 @@
 	case GERR_NONE: break;
 	case GERR_WITHDRAWPENALTY:
 		pchInviter->ChatPacket(CHAT_TYPE_INFO,
-			LC_STRING("<> Ż  %d    忡 ʴ  ϴ.",
-			quest::CQuestManager::instance().GetEventFlag("guild_withdraw_delay")));
+			LC_TEXT("<> Ż  %d    忡 ʴ  ϴ."),
+			quest::CQuestManager::instance().GetEventFlag("guild_withdraw_delay"));
 		return;
 	case GERR_COMMISSIONPENALTY:
 		pchInviter->ChatPacket(CHAT_TYPE_INFO,
-			LC_STRING("<> 带 ػ  %d    忡 ʴ  ϴ.",
-			quest::CQuestManager::instance().GetEventFlag("guild_disband_delay")));
+			LC_TEXT("<> 带 ػ  %d    忡 ʴ  ϴ."),
+			quest::CQuestManager::instance().GetEventFlag("guild_disband_delay"));
 		return;
-	case GERR_ALREADYJOIN:	pchInviter->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>  ̹ ٸ 忡 ֽϴ.")); return;
-	case GERR_GUILDISFULL:	pchInviter->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> ִ   ʰ߽ϴ.")); return;
-	case GERR_GUILD_IS_IN_WAR: pchInviter->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>  尡   Դϴ.")); return;
-	case GERR_INVITE_LIMIT: pchInviter->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>  ű    Դϴ.")); return;
+	case GERR_ALREADYJOIN:	pchInviter->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>  ̹ ٸ 忡 ֽϴ.")); return;
+	case GERR_GUILDISFULL:	pchInviter->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> ִ   ʰ߽ϴ.")); return;
+	case GERR_GUILD_IS_IN_WAR: pchInviter->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>  尡   Դϴ.")); return;
+	case GERR_INVITE_LIMIT: pchInviter->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>  ű    Դϴ.")); return;
 
 	default: sys_err("ignore guild join error(%d)", errcode); return;
 	}
@@ -2168,18 +2125,18 @@
 	case GERR_NONE: break;
 	case GERR_WITHDRAWPENALTY:
 		pchInvitee->ChatPacket(CHAT_TYPE_INFO,
-			LC_STRING("<> Ż  %d    忡 ʴ  ϴ.",
-			quest::CQuestManager::instance().GetEventFlag("guild_withdraw_delay")));
+			LC_TEXT("<> Ż  %d    忡 ʴ  ϴ."),
+			quest::CQuestManager::instance().GetEventFlag("guild_withdraw_delay"));
 		return;
 	case GERR_COMMISSIONPENALTY:
 		pchInvitee->ChatPacket(CHAT_TYPE_INFO,
-			LC_STRING("<> 带 ػ  %d    忡 ʴ  ϴ.",
-			quest::CQuestManager::instance().GetEventFlag("guild_disband_delay")));
+			LC_TEXT("<> 带 ػ  %d    忡 ʴ  ϴ."),
+			quest::CQuestManager::instance().GetEventFlag("guild_disband_delay"));
 		return;
-	case GERR_ALREADYJOIN:	pchInvitee->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>  ̹ ٸ 忡 ֽϴ.")); return;
-	case GERR_GUILDISFULL:	pchInvitee->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> ִ   ʰ߽ϴ.")); return;
-	case GERR_GUILD_IS_IN_WAR: pchInvitee->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>  尡   Դϴ.")); return;
-	case GERR_INVITE_LIMIT: pchInvitee->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>  ű    Դϴ.")); return;
+	case GERR_ALREADYJOIN:	pchInvitee->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>  ̹ ٸ 忡 ֽϴ.")); return;
+	case GERR_GUILDISFULL:	pchInvitee->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> ִ   ʰ߽ϴ.")); return;
+	case GERR_GUILD_IS_IN_WAR: pchInvitee->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>  尡   Դϴ.")); return;
+	case GERR_INVITE_LIMIT: pchInvitee->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>  ű    Դϴ.")); return;
 
 	default: sys_err("ignore guild join error(%d)", errcode); return;
 	}
@@ -2271,3 +2228,49 @@
 		SendAllGradePacket(*iter);
 	}
 }
+
+#if defined(__GUILD_DRAGONLAIR_PARTY_SYSTEM__)
+bool CGuild::RequestDungeon(BYTE bChannel, long lMapIndex)
+{
+	TPacketGDGuildDungeon sPacket;
+	sPacket.dwGuildID = GetID();
+	sPacket.bChannel = bChannel;
+	sPacket.lMapIndex = lMapIndex;
+	db_clientdesc->DBPacket(HEADER_GD_GUILD_DUNGEON, 0, &sPacket, sizeof(sPacket));
+	return true;
+}
+
+void CGuild::RecvDungeon(BYTE bChannel, long lMapIndex)
+{
+	m_data.dungeon_ch = bChannel;
+	m_data.dungeon_map = lMapIndex;
+}
+
+bool CGuild::SetDungeonCooldown(DWORD dwTime)
+{
+	TPacketGDGuildDungeonCD sPacket;
+	sPacket.dwGuildID = GetID();
+	sPacket.dwTime = dwTime;
+	db_clientdesc->DBPacket(HEADER_GD_GUILD_DUNGEON_CD, 0, &sPacket, sizeof(sPacket));
+	return true;
+}
+
+void CGuild::RecvDungeonCD(DWORD dwTime)
+{
+	m_data.dungeon_cooldown = dwTime;
+}
+
+bool CGuild::SetDungeonStart(DWORD dwDungeon_start)
+{
+	TPacketGDGuildDungeonST sPacket;
+	sPacket.dwGuildID = GetID();
+	sPacket.dwDungeon_start = dwDungeon_start;
+	db_clientdesc->DBPacket(HEADER_GD_GUILD_DUNGEON_ST, 0, &sPacket, sizeof(sPacket));
+	return true;
+}
+
+void CGuild::RecvDungeonST(DWORD dwDungeon_start)
+{
+	m_data.dungeon_start = dwDungeon_start;
+}
+#endif
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/input.h final/server/server/home/metin2/Source/Server/game/src/input.h
--- baseline/server/server/home/metin2/Source/Server/game/src/input.h	2025-06-28 21:24:14.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/input.h	2022-04-27 12:34:31.000000000 +0000
@@ -18,6 +18,15 @@
 
 void LoginFailure(LPDESC d, const char* c_pszStatus);
 
+enum EHWIDStatus
+{
+	HWID_STATUS_UNTOUCHED,
+	HWID_STATUS_CHANGED,
+	HWID_STATUS_BLOCKED,
+};
+
+std::tuple<BYTE /* Status */, BYTE, /* PID1 */ BYTE, /* PID2 */ BYTE, /* PID3 */ BYTE, /* PID4 */ BYTE /* PID5 */> GetHWIDStatus(DWORD dwAID, const char* c_szHWID, bool bCheckBlock = false);
+
 class CInputProcessor
 {
 public:
@@ -29,6 +38,7 @@
 
 	void BindPacketInfo(CPacketInfo* pPacketInfo);
 	void Pong(LPDESC d);
+	void Phase(const char* c_pData);
 	void Handshake(LPDESC d, const char* c_pData);
 	void Version(LPCHARACTER ch, const char* c_pData);
 
@@ -37,6 +47,7 @@
 
 	CPacketInfo* m_pPacketInfo;
 	int m_iBufferLeft;
+	BOOL m_bState;
 
 	CPacketInfoCG m_packetInfoCG;
 };
@@ -82,6 +93,7 @@
 	void CharacterSelect(LPDESC d, const char* data);
 	void CharacterCreate(LPDESC d, const char* data);
 	void CharacterDelete(LPDESC d, const char* data);
+	void CharacterPinCode(LPDESC d, const char* c_pData);
 
 	void Entergame(LPDESC d, const char* data);
 	void Empire(LPDESC d, const char* c_pData);
@@ -129,27 +141,22 @@
 	void FlyTarget(LPCHARACTER ch, const char* pcData, BYTE bHeader);
 	void UseSkill(LPCHARACTER ch, const char* pcData);
 
+#if defined(__SKILL_COLOR_SYSTEM__)
+	void SetSkillColor(LPCHARACTER ch, const char* pcData);
+#endif
+
 	void ScriptAnswer(LPCHARACTER ch, const void* pvData);
 	void ScriptButton(LPCHARACTER ch, const void* pvData);
 	void ScriptSelectItem(LPCHARACTER ch, const void* pvData);
-#if defined(__GEM_SYSTEM__)
-	void SelectItemEx(LPCHARACTER c_lpCh, const void* c_pvData);
-#endif
-#if defined(__QUEST_REQUEST_EVENT__)
-	void RequestEventQuest(LPCHARACTER pChar, const void* c_pvData);
-#endif
 
 	void QuestInputString(LPCHARACTER ch, const void* pvData);
-#if defined(__OX_RENEWAL__)
-	void QuestInputLongString(LPCHARACTER ch, const void* pvData);
-#endif
 	void QuestConfirm(LPCHARACTER ch, const void* pvData);
 	void Target(LPCHARACTER ch, const char* pcData);
 	void Warp(LPCHARACTER ch, const char* pcData);
 	void SafeboxCheckin(LPCHARACTER ch, const char* c_pData);
 	void SafeboxCheckout(LPCHARACTER ch, const char* c_pData, bool bMall);
 	void SafeboxItemMove(LPCHARACTER ch, const char* data);
-	int Messenger(const LPCHARACTER c_lpChar, const char* c_pData, std::size_t uiBytes);
+	int Messenger(LPCHARACTER ch, const char* c_pData, size_t uiBytes);
 
 	void PartyInvite(LPCHARACTER ch, const char* c_pData);
 	void PartyInviteAnswer(LPCHARACTER ch, const char* c_pData);
@@ -162,157 +169,62 @@
 	void AnswerMakeGuild(LPCHARACTER ch, const char* c_pData);
 
 	void Fishing(LPCHARACTER ch, const char* c_pData);
-
-#if defined(__FISHING_GAME__)
-	// Fishing Game
-	void FishingGame(const LPCHARACTER c_lpChar, const char* c_pszData);
-#endif
-
 	void ItemGive(LPCHARACTER ch, const char* c_pData);
 	void Hack(LPCHARACTER ch, const char* c_pData);
 	int MyShop(LPCHARACTER ch, const char* c_pData, size_t uiBytes);
-
 #if defined(__MYSHOP_DECO__)
-	void MyShopDecoState(LPCHARACTER ch, const char* c_pData);
-	void MyShopDecoAdd(LPCHARACTER ch, const char* c_pData);
+	void MyShopDeco(LPCHARACTER ch, const char* c_pData);
 #endif
 
 	void Refine(LPCHARACTER ch, const char* c_pData);
 
-#ifdef __GROWTH_PET_SYSTEM__
-	void PetHatch(LPCHARACTER ch, const char* c_pData);
-	void PetWindow(LPCHARACTER ch, const char* c_pData);
-	void PetWindowType(LPCHARACTER ch, const char* c_pData);
-	void PetFeed(LPCHARACTER ch, const char* c_pData);
-	void PetDetermine(LPCHARACTER ch, const char* c_pData);
-	void PetAttrChange(LPCHARACTER ch, const char* c_pData);
-	void PetRevive(LPCHARACTER ch, const char* c_pData);
-	void PetLearnSkill(LPCHARACTER ch, const char* c_pData);
-	void PetSkillUpgrade(LPCHARACTER ch, const char* c_pData);
-	void PetDeleteSkill(LPCHARACTER ch, const char* c_pData);
-	void PetDeleteAllSkill(LPCHARACTER ch, const char* c_pData);
-	void PetNameChange(LPCHARACTER ch, const char* c_pData);
-#endif
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	int ReciveExtBattlePassActions(LPCHARACTER ch, const char* data, size_t uiBytes);
-	int ReciveExtBattlePassPremiumItem(LPCHARACTER ch, const char* data, size_t uiBytes);
-#endif
-
-#if defined(__CUBE_RENEWAL__)
-	// Cube
-	void Cube(const LPCHARACTER pChar, const char* pData);
-#endif
+	void Roulette(LPCHARACTER ch, const char* c_pData);
 
 #if defined(__SEND_TARGET_INFO__)
-	void TargetInfo(LPCHARACTER pChar, const char* c_pszData);
-#endif
-
-#if defined(__MOVE_COSTUME_ATTR__)
-	// Item Combination
-	void ItemCombination(LPCHARACTER ch, const char* c_pData);
-	void ItemCombinationCancel(LPCHARACTER ch, const char* c_pData);
-#endif
-
-#if defined(__CHANGED_ATTR__)
-	// Select Attribute
-	void ItemSelectAttr(LPCHARACTER ch, const char* c_pData);
+	void TargetInfoLoad(LPCHARACTER ch, const char* c_pData);
 #endif
 
 #if defined(__ACCE_COSTUME_SYSTEM__)
-	// Acce Refine
-	int AcceRefine(const LPCHARACTER pChar, const char* pszData, size_t uiBytes);
+	void Acce(LPCHARACTER pkChar, const char* c_pData);
 #endif
 
-#if defined(__AURA_COSTUME_SYSTEM__)
-	// Aura Refine
-	int AuraRefine(const LPCHARACTER pChar, const char* pszData, size_t uiBytes);
+#if defined(__CHANGE_LOOK_SYSTEM__)
+	void ChangeLook(LPCHARACTER pkChar, const char* c_pData);
 #endif
 
-#if defined(__CHANGE_LOOK_SYSTEM__)
-	// Change Look
-	void ChangeLook(LPCHARACTER lpCh, const char* c_pszData);
+#if defined(__PRIVATESHOP_SEARCH_SYSTEM__)
+	// Private Shop Search
+	void PrivateShopSearch(LPCHARACTER ch, const char* data);
+	void PrivateShopSearchClose(LPCHARACTER ch, const char* data);
+	void PrivateShopSearchBuyItem(LPCHARACTER ch, const char* data);
 #endif
 
+	void ChangeLanguage(LPCHARACTER ch, BYTE bLanguage);
+
 #if defined(__SKILLBOOK_COMB_SYSTEM__)
-	// Skill Book Combination
 	bool SkillBookCombination(LPCHARACTER ch, TItemPos(&CombItemGrid)[SKILLBOOK_COMB_SLOT_MAX], BYTE bAction);
 #endif
 
+	void WhisperDetails(LPCHARACTER ch, const char* c_pData);
+#ifdef __GROWTH_PET_SYSTEM__
+	void		PetHatch(LPCHARACTER ch, const char* c_pData);
+	void		PetWindow(LPCHARACTER ch, const char* c_pData);
+	void		PetWindowType(LPCHARACTER ch, const char* c_pData);
+	void		PetFeed(LPCHARACTER ch, const char* c_pData);
+	void		PetDetermine(LPCHARACTER ch, const char* c_pData);
+	void		PetAttrChange(LPCHARACTER ch, const char* c_pData);
+	void		PetRevive(LPCHARACTER ch, const char* c_pData);
+	void		PetLearnSkill(LPCHARACTER ch, const char* c_pData);
+	void		PetSkillUpgrade(LPCHARACTER ch, const char* c_pData);
+	void		PetDeleteSkill(LPCHARACTER ch, const char* c_pData);
+	void		PetDeleteAllSkill(LPCHARACTER ch, const char* c_pData);
+	void		PetNameChange(LPCHARACTER ch, const char* c_pData);
+#endif
 #if defined(__MAILBOX__)
-	// Mail Box
 	void MailboxWrite(LPCHARACTER ch, const char* data);
 	void MailboxConfirm(LPCHARACTER ch, const char* data);
 	void MailboxProcess(LPCHARACTER ch, const char* c_pData);
 #endif
-
-#ifdef __SHOP_SEARCH__
-	void ShopSearchByName(LPCHARACTER ch, const char* data);
-	int ShopSearchByOptions(LPCHARACTER ch, const char* data, size_t uiBytes);
-	void ShopSearchBuy(LPCHARACTER ch, const char* data);
-	void ShopSearchOwnerMessage(LPCHARACTER ch, const char* data);
-	void ShopSearchRequestSoldInfo(LPCHARACTER ch, const char* data);
-#endif
-
-#if defined(__LOOT_FILTER_SYSTEM__)
-	// Loot Filter
-	void LootFilter(LPCHARACTER ch, const char* c_pData);
-#endif
-
-#if defined(__MINI_GAME_RUMI__)
-	// Mini-Game Rumi
-	void MiniGameRumi(LPCHARACTER pChar, const char* pszData);
-#endif
-
-#if defined(__MINI_GAME_YUTNORI__)
-	// Mini-Game Yutnori
-	void MiniGameYutnori(LPCHARACTER pChar, const char* pszData);
-#endif
-
-#if defined(__ATTR_6TH_7TH__)
-	// 6th and 7th Attribute
-	void Attr67Add(LPCHARACTER ch, const char* c_pData);
-#endif
-
-#if defined(__LUCKY_BOX__)
-	// Lucky Box
-	void LuckyBox(LPCHARACTER ch, const char* c_pData);
-#endif
-
-#if defined(__GEM_SHOP__)
-	// Gem Shop
-	void GemShop(LPCHARACTER c_lpCh, const char* c_pszData);
-#endif
-
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	// Extend Inven
-	void ExtendInven(LPCHARACTER pChar, const char* c_pszData);
-#endif
-
-#if defined(__SNOWFLAKE_STICK_EVENT__)
-	// Snowflake Stick Event
-	void SnowflakeStickEvent(LPCHARACTER pChar, const char* c_pszData);
-#endif
-
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	// Refine Element
-	void RefineElement(LPCHARACTER pChar, const char* c_pszData);
-#endif
-
-#if defined(__LEFT_SEAT__)
-	// Left Seat
-	void LeftSeat(LPCHARACTER pChar, const char* c_pszData);
-#endif
-
-#if defined(__SUMMER_EVENT_ROULETTE__)
-	// Mini-Game Roulette (Late Summer Event)
-	void MiniGameRoulette(LPCHARACTER pChar, const char* pszData);
-#endif
-
-#if defined(__FLOWER_EVENT__)
-	// Flower Event
-	void FlowerEvent(LPCHARACTER pChar, const char* pszData);
-#endif
 };
 
 class CInputDead : public CInputMain
@@ -338,11 +250,7 @@
 	void LoginSuccess(DWORD dwHandle, const char* data);
 	void PlayerCreateFailure(LPDESC d, BYTE bType); // 0 = Ϲ  1 = ̹ 
 	void PlayerDeleteSuccess(LPDESC d, const char* data);
-	void PlayerDeleteFail(LPDESC d
-#if defined(__DELETE_FAILURE_TYPE__)
-		, const char* c_pszData
-#endif
-	);
+	void PlayerDeleteFail(LPDESC d);
 	void PlayerLoad(LPDESC d, const char* data);
 	void PlayerCreateSuccess(LPDESC d, const char* data);
 	void Boot(const char* data);
@@ -357,8 +265,8 @@
 	void ItemLoad(LPDESC d, const char* c_pData);
 	void AffectLoad(LPDESC d, const char* c_pData);
 
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	void ExtBattlePassLoad(LPDESC d, const char* c_pData);
+#if defined(__SKILL_COLOR_SYSTEM__)
+	void SkillColorLoad(LPDESC d, const char* c_pData);
 #endif
 
 	void GuildLoad(const char* c_pData);
@@ -412,6 +320,7 @@
 	void UpdateLand(const char* c_pData);
 
 	void Notice(const char* c_pData);
+	void BigNotice(const char* c_pData);
 
 	void MarriageAdd(TPacketMarriageAdd* p);
 	void MarriageUpdate(TPacketMarriageUpdate* p);
@@ -451,37 +360,24 @@
 
 	void RespondChannelStatus(LPDESC desc, const char* pcData);
 
-#if defined(__MOVE_CHANNEL__)
-	void MoveChannel(LPDESC desc, const char* pcData);
-#endif
-
-#if defined(__EXPRESSING_EMOTIONS__)
-	// Emotions
-	void EmoteLoad(LPDESC pDesc, const char* c_pData);
-	void EmoteGet(LPDESC pDesc, const char* c_pData);
+#if defined(__GUILD_DRAGONLAIR_PARTY_SYSTEM__)
+	void GuildDungeon(const char* c_pData);
+	void GuildDungeonCD(const char* c_pData);
+	void GuildDungeonST(const char* c_pData);
 #endif
 
-#if defined(__MAILBOX__)
-	void MailBoxRespondLoad(LPDESC d, const char* c_pData);
-	void MailBoxRespondName(LPDESC d, const char* c_pData);
-	void MailBoxRespondUnreadData(LPDESC d, const char* c_pData);
-#endif
-
-#if defined(__GEM_SHOP__)
-	// Gem Shop
-	void GemShopLoad(LPDESC lpDesc, const char* c_pszData);
-	void GemShopUpdate(LPDESC lpDesc, const char* c_pszData);
+#if defined(__MOVE_CHANNEL__)
+	void MoveChannel(LPDESC desc, const char* pcData);
 #endif
 
-#if defined(__GUILD_EVENT_FLAG__) //&& defined(__GUILD_RENEWAL__)
-	void GuildSetEventFlag(const char* c_pData);
-#endif
-#ifdef __OFFLINE_SHOP__
-	void RespondOfflineShopId(const char* data);
-#endif
 #ifdef __GROWTH_PET_SYSTEM__
 	void GrowthPetLoad(LPDESC d, const char* c_pData);
 #endif
+#if defined(__MAILBOX__)
+	void MailBoxRespondLoad(LPDESC d, const char * c_pData);
+	void MailBoxRespondName(LPDESC d, const char * c_pData);
+	void MailBoxRespondUnreadData(LPDESC d, const char * c_pData);
+#endif
 
 protected:
 	DWORD m_dwHandle;
@@ -523,6 +419,7 @@
 	void Logout(LPDESC d, const char* c_pData);
 	int Relay(LPDESC d, const char* c_pData, size_t uiBytes);
 	int Notice(LPDESC d, const char* c_pData, size_t uiBytes);
+	int BigNotice(LPDESC d, const char* c_pData, size_t uiBytes);
 	int MonarchNotice(LPDESC d, const char* c_pData, size_t uiBytes);
 	int MonarchTransfer(LPDESC d, const char* c_pData);
 	int Guild(LPDESC d, const char* c_pData, size_t uiBytes);
@@ -538,17 +435,13 @@
 	void WarpCharacter(const char* c_pData);
 	void GuildWarZoneMapIndex(const char* c_pData);
 	void Transfer(const char* c_pData);
-#if defined(__XMAS_EVENT_2008__)
 	void XmasWarpSanta(const char* c_pData);
 	void XmasWarpSantaReply(const char* c_pData);
-#endif
 	void LoginPing(LPDESC d, const char* c_pData);
 	void BlockChat(const char* c_pData);
 	void PCBangUpdate(const char* c_pData);
 	void IamAwake(LPDESC d, const char* c_pData);
-#ifdef __OFFLINE_SHOP__
-	void UpdateSellHistory(LPDESC d, const char* c_pData);
-#endif
+	void LocaleNotice(const char* c_pData);
 
 protected:
 	CPacketInfoGG m_packetInfoGG;
@@ -567,4 +460,5 @@
 	void Login(LPDESC d, const char* c_pData);
 
 };
+
 #endif // __INC_INPUT_PROCESSOR_H__
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/input_db.cpp final/server/server/home/metin2/Source/Server/game/src/input_db.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/input_db.cpp	2025-06-28 21:28:12.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/input_db.cpp	2026-02-20 18:05:02.475309069 +0000
@@ -46,34 +46,7 @@
 #include "map_location.h"
 
 #include "DragonSoul.h"
-#if defined(__CUBE_RENEWAL__)
-#include "cube.h"
-#endif
-
-#if defined(__MT_THUNDER_DUNGEON__)
-#include "mt_thunder_dungeon.h"
-#endif
-
-#if defined(__MAILBOX__)
-#	include "MailBox.h"
-#endif
-
-#ifdef __OFFLINE_SHOP__
-#include "OfflineShop.h"
-#include "DynamicPacket.h"
-#endif
-
-#if defined(__SHOP_SEARCH__)
-	#include "ShopSearchManager.h"
-#endif
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-#include "battlepass_manager.h"
-#endif
-
-#ifdef __GROWTH_PET_SYSTEM__
-	#include "safebox.h"
-#endif
+#include "safebox.h" // __GROWTH_PET_SYSTEM__
 
 extern BYTE g_bAuthServer;
 
@@ -117,20 +90,10 @@
 					rTab.players[i].y,
 					rTab.players[i].szName);
 
-#if defined(__PROXY_IP__)
-				if (!g_stProxyIP.empty())
-					rTab.players[i].lAddr = inet_addr(g_stProxyIP.c_str());
-#endif
-
 				continue;
 			}
 		}
 
-#if defined(__PROXY_IP__)
-		if (!g_stProxyIP.empty())
-			rTab.players[i].lAddr = inet_addr(g_stProxyIP.c_str());
-#endif
-
 		struct in_addr in;
 		in.s_addr = rTab.players[i].lAddr;
 		sys_log(0, "success to %s:%d", inet_ntoa(in), rTab.players[i].wPort);
@@ -148,7 +111,7 @@
 
 	TAccountTable* pTab = (TAccountTable*)data;
 
-	auto it = g_sim.find(pTab->id);
+	itertype(g_sim) it = g_sim.find(pTab->id);
 	if (g_sim.end() != it)
 	{
 		sys_log(0, "CInputDB::LoginSuccess - already exist sim [%s]", pTab->login);
@@ -210,6 +173,17 @@
 	d->SetPhase(PHASE_SELECT);
 	d->SendLoginSuccessPacket();
 
+	{
+		auto aHWID = GetHWIDStatus(pTab->id, pTab->hwid);
+		d->SendHWIDStatusPacket(std::get<0>(aHWID),
+			std::get<1>(aHWID),
+			std::get<2>(aHWID),
+			std::get<3>(aHWID),
+			std::get<4>(aHWID),
+			std::get<5>(aHWID)
+		);
+	}
+
 	sys_log(0, "InputDB::login_success: %s", pTab->login);
 }
 
@@ -262,10 +236,6 @@
 	pack.header = HEADER_GC_CHARACTER_CREATE_SUCCESS;
 	pack.bAccountCharacterIndex = pPacketDB->bAccountCharacterIndex;
 	pack.player = pPacketDB->player;
-#if defined(__PROXY_IP__)
-	if (!g_stProxyIP.empty())
-		pack.player.lAddr = inet_addr(g_stProxyIP.c_str());
-#endif
 
 	d->Packet(&pack, sizeof(TPacketGCPlayerCreateSuccess));
 
@@ -275,9 +245,9 @@
 
 	if (china_event_server)
 	{
-		t.bWindow = INVENTORY;
-		t.dwCount = 1;
-		t.dwOwner = r_Tab.players[pPacketDB->bAccountCharacterIndex].dwID;
+		t.window = INVENTORY;
+		t.count = 1;
+		t.owner = r_Tab.players[pPacketDB->bAccountCharacterIndex].dwID;
 
 		//: ΰ+3,ö+3,Ź+3,+3,ݸ+3, ܱͰ+3, һ+3, +3, +3 
 		//ڰ+3,ȯΰ+3,Ź+3,ȵ+3,ȭȱ+3,+3, Ͱ+3, +3, +3 
@@ -357,9 +327,9 @@
 			if (initialItems[job][i].dwVnum == 0)
 				continue;
 
-			t.dwID = ITEM_MANAGER::instance().GetNewID();
-			t.wPos = initialItems[job][i].pos;
-			t.dwVnum = initialItems[job][i].dwVnum;
+			t.id = ITEM_MANAGER::instance().GetNewID();
+			t.pos = initialItems[job][i].pos;
+			t.vnum = initialItems[job][i].dwVnum;
 
 			db_clientdesc->DBPacketHeader(HEADER_GD_ITEM_SAVE, 0, sizeof(TPlayerItem));
 			db_clientdesc->Packet(&t, sizeof(TPlayerItem));
@@ -382,26 +352,15 @@
 	d->GetAccountTable().players[account_index].dwID = 0;
 }
 
-void CInputDB::PlayerDeleteFail(LPDESC d
-#if defined(__DELETE_FAILURE_TYPE__)
-	, const char* c_pszData
-#endif
-)
+void CInputDB::PlayerDeleteFail(LPDESC d)
 {
 	if (!d)
 		return;
 
-#if defined(__DELETE_FAILURE_TYPE__)
-	const TPlayerDeleteFailurePacket* pPacket = reinterpret_cast<const TPlayerDeleteFailurePacket*>(c_pszData);
-	if (pPacket == nullptr)
-		return;
-
-	d->BufferedPacket(encode_byte(HEADER_GC_CHARACTER_DELETE_WRONG_SOCIAL_ID), sizeof(BYTE));
-	d->BufferedPacket(&pPacket->bType, sizeof(pPacket->bType));
-	d->Packet(&pPacket->iTime, sizeof(pPacket->iTime));
-#else
 	d->Packet(encode_byte(HEADER_GC_CHARACTER_DELETE_WRONG_SOCIAL_ID), 1);
-#endif
+	//d->Packet(encode_byte(account_index), 1);
+
+	//d->GetAccountTable().players[account_index].dwID = 0;
 }
 
 void CInputDB::ChangeName(LPDESC d, const char* data)
@@ -469,15 +428,16 @@
 	// by rtsummit
 	if (!SECTREE_MANAGER::instance().GetValidLocation(pTab->lMapIndex, pTab->x, pTab->y, lMapIndex, pos, d->GetEmpire()))
 	{
-		//sys_err("InputDB::PlayerLoad : cannot find valid location %d x %d (name: %s)", pTab->x, pTab->y, pTab->name);
-		sys_err("InputDB::PlayerLoad : cannot find valid location %d x %d (name: %s) sending to village", pTab->x, pTab->y, pTab->name);
+		sys_err("InputDB::PlayerLoad : cannot find valid location %d x %d (name: %s)", pTab->x, pTab->y, pTab->name);
 
+		//< 2020.06.25.Owsap - Warp to empire village if location doesn't exist.
 		lMapIndex = EMPIRE_START_MAP(d->GetAccountTable().bEmpire);
 		pos.x = EMPIRE_START_X(d->GetAccountTable().bEmpire);
 		pos.y = EMPIRE_START_Y(d->GetAccountTable().bEmpire);
+		//>
 
-		d->SetPhase(PHASE_CLOSE);
-		return;
+		//d->SetPhase(PHASE_CLOSE);
+		//return;
 	}
 
 	pTab->x = pos.x;
@@ -502,9 +462,6 @@
 	ch->BindDesc(d);
 	ch->SetPlayerProto(pTab);
 	ch->SetEmpire(d->GetEmpire());
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-	ch->SetCountry(LocaleService_GetCountry(d->GetAccountTable().country));
-#endif
 
 	d->BindCharacter(ch);
 
@@ -518,20 +475,21 @@
 		p.bEmpire = ch->GetEmpire();
 		p.lMapIndex = SECTREE_MANAGER::instance().GetMapIndex(ch->GetX(), ch->GetY());
 		p.bChannel = g_bChannel;
+		p.bLanguage = ch->GetLanguage();
 
 		P2P_MANAGER::instance().Send(&p, sizeof(TPacketGGLogin));
 
 #if defined(__CHEQUE_SYSTEM__) && defined(__GEM_SYSTEM__)
 		char buf[55];
-		snprintf(buf, sizeof(buf), "%s %d %d %d %d %ld %d",
+		snprintf(buf, sizeof(buf), "%s %lld %d %d %d %ld %d",
 			inet_ntoa(ch->GetDesc()->GetAddr().sin_addr), ch->GetGold(), ch->GetCheque(), ch->GetGem(), g_bChannel, ch->GetMapIndex(), ch->GetAlignment());
 #elif defined(__CHEQUE_SYSTEM__)
 		char buf[55];
-		snprintf(buf, sizeof(buf), "%s %d %d %d %ld %d",
+		snprintf(buf, sizeof(buf), "%s %lld %d %d %ld %d",
 			inet_ntoa(ch->GetDesc()->GetAddr().sin_addr), ch->GetGold(), ch->GetCheque(), g_bChannel, ch->GetMapIndex(), ch->GetAlignment());
 #else
 		char buf[51];
-		snprintf(buf, sizeof(buf), "%s %d %d %ld %d",
+		snprintf(buf, sizeof(buf), "%s %lld %d %ld %d",
 			inet_ntoa(ch->GetDesc()->GetAddr().sin_addr), ch->GetGold(), g_bChannel, ch->GetMapIndex(), ch->GetAlignment());
 #endif
 
@@ -629,6 +587,7 @@
 #ifdef __GROWTH_PET_SYSTEM__
 	sys_log(0, "sizeof(TGrowthPetSkillTable) = %d", sizeof(TGrowthPetSkillTable));
 #endif
+
 	// ADMIN_MANAGER
 	sys_log(0, "sizeof(TAdminManager) = %d", sizeof(TAdminInfo));
 	// END_ADMIN_MANAGER
@@ -777,11 +736,11 @@
 
 		for (int i = 0; i < size; ++i, ++p)
 		{
-			if (p->wApplyIndex >= MAX_APPLY_NUM)
+			if (p->dwApplyIndex >= MAX_APPLY_NUM)
 				continue;
 
-			g_map_itemAttr[p->wApplyIndex] = *p;
-			sys_log(0, "ITEM_ATTR[%d]: %s %u", p->wApplyIndex, p->szApply, p->dwProb);
+			g_map_itemAttr[p->dwApplyIndex] = *p;
+			sys_log(0, "ITEM_ATTR[%d]: %s %u", p->dwApplyIndex, p->szApply, p->dwProb);
 		}
 	}
 
@@ -809,11 +768,11 @@
 
 		for (int i = 0; i < size; ++i, ++p)
 		{
-			if (p->wApplyIndex >= MAX_APPLY_NUM)
+			if (p->dwApplyIndex >= MAX_APPLY_NUM)
 				continue;
 
-			g_map_itemRare[p->wApplyIndex] = *p;
-			sys_log(0, "ITEM_RARE[%d]: %s %u", p->wApplyIndex, p->szApply, p->dwProb);
+			g_map_itemRare[p->dwApplyIndex] = *p;
+			sys_log(0, "ITEM_RARE[%d]: %s %u", p->dwApplyIndex, p->szApply, p->dwProb);
 		}
 	}
 
@@ -900,7 +859,7 @@
 		for (WORD i = 0; i < size; ++i, ++kObj)
 			CManager::instance().LoadObject(kObj, true);
 	}
-
+	
 #ifdef __GROWTH_PET_SYSTEM__
 	/*
 	* GROWTH PET SKILL
@@ -908,7 +867,7 @@
 
 	if (decode_2bytes(data) != sizeof(TGrowthPetSkillTable))
 	{
-		sys_err("growth pet table size error");
+		sys_err("event table size error");
 		thecore_shutdown();
 		return;
 	}
@@ -1000,55 +959,6 @@
 	data += CandidacySize * CandidacyCount;
 	// END_MONARCH
 
-#ifdef __OFFLINE_SHOP__
-	{
-		CDynamicPacket packet(data);
-
-		auto size = *packet.Get<uint32_t>();
-		if (size != sizeof(TOfflineShop)) {
-			sys_err("TOfflineShop size error! Expected size %u.", sizeof(TOfflineShop));
-			thecore_shutdown();
-			return;
-		}
-
-		auto count = *packet.Get<uint32_t>();
-		while (count > 0) {
-			count--;
-
-			const auto& shopData = *packet.Get<TOfflineShop>();
-			if (shopData.channel != g_bChannel || !map_allow_find(shopData.mapIndex)) {
-				continue;
-			}
-
-			COfflineShop::LoadShop(shopData);
-		}
-
-
-		size = *packet.Get<uint32_t>();
-		if (size != sizeof(TOfflineShopItem)) {
-			sys_err("TOfflineShopItem size error! Expected size %u.", sizeof(TOfflineShopItem));
-			thecore_shutdown();
-			return;
-		}
-
-		count = *packet.Get<uint32_t>();
-		while (count > 0) {
-			count--;
-
-			const auto& itemData = *packet.Get<TOfflineShopItem>();
-
-			auto shop = COfflineShop::Get(itemData.id.first);
-			if (!shop) {
-				continue;
-			}
-
-			shop->get()->AddItem(itemData);
-		}
-
-		data += packet.GetExtraSize();
-	}
-#endif
-
 	WORD endCheck = decode_2bytes(data);
 	if (endCheck != 0xffff)
 	{
@@ -1082,17 +992,8 @@
 	char szDropItemGroupFileName[FILE_NAME_LEN];
 	char szSpecialItemGroupFileName[FILE_NAME_LEN];
 	char szMapIndexFileName[FILE_NAME_LEN];
-#if defined(__CONQUEROR_LEVEL__)
-	char szNewWorldMapIndexFileName[FILE_NAME_LEN];
-#endif
 	char szItemVnumMaskTableFileName[FILE_NAME_LEN];
 	char szDragonSoulTableFileName[FILE_NAME_LEN];
-#if defined(__LUCKY_BOX__)
-	char szLuckyBoxFileName[FILE_NAME_LEN];
-#endif
-#if defined(__SUMMER_EVENT_ROULETTE__)
-	char szRouletteTableFileName[FILE_NAME_LEN];
-#endif
 
 	snprintf(szCommonDropItemFileName, sizeof(szCommonDropItemFileName),
 		"%s/common_drop_item.txt", LocaleService_GetBasePath().c_str());
@@ -1105,25 +1006,12 @@
 	snprintf(szDropItemGroupFileName, sizeof(szDropItemGroupFileName),
 		"%s/drop_item_group.txt", LocaleService_GetBasePath().c_str());
 	snprintf(szMapIndexFileName, sizeof(szMapIndexFileName),
-		"%s/index.txt", LocaleService_GetMapPath().c_str());
-#if defined(__CONQUEROR_LEVEL__)
-	snprintf(szNewWorldMapIndexFileName, sizeof(szNewWorldMapIndexFileName),
-		"%s/new_world.txt", LocaleService_GetMapPath().c_str());
-#endif
+		"%s/index", LocaleService_GetMapPath().c_str());
 	snprintf(szItemVnumMaskTableFileName, sizeof(szItemVnumMaskTableFileName),
 		"%s/ori_to_new_table.txt", LocaleService_GetBasePath().c_str());
 	snprintf(szDragonSoulTableFileName, sizeof(szDragonSoulTableFileName),
 		"%s/dragon_soul_table.txt", LocaleService_GetBasePath().c_str());
-#if defined(__LUCKY_BOX__)
-	snprintf(szLuckyBoxFileName, sizeof(szLuckyBoxFileName),
-		"%s/lucky_box.txt", LocaleService_GetBasePath().c_str());
-#endif
-#if defined(__SUMMER_EVENT_ROULETTE__)
-	snprintf(szRouletteTableFileName, sizeof(szRouletteTableFileName),
-		"%s/roulette_table.txt", LocaleService_GetBasePath().c_str());
-#endif
 
-#if !defined(__CUBE_RENEWAL__)
 	sys_log(0, "Initializing Informations of Cube System");
 	if (!Cube_InformationInitialize())
 	{
@@ -1131,7 +1019,6 @@
 		thecore_shutdown();
 		return;
 	}
-#endif
 
 	sys_log(0, "LoadLocaleFile: CommonDropItem: %s", szCommonDropItemFileName);
 	if (!ITEM_MANAGER::instance().ReadCommonDropItemFile(szCommonDropItemFileName))
@@ -1187,80 +1074,13 @@
 		return;
 	}
 
-#if defined(__CONQUEROR_LEVEL__)
-	sys_log(0, "LoadLocaleFile: NewWorldMapIndex: %s", szNewWorldMapIndexFileName);
-	if (!SECTREE_MANAGER::Instance().LoadNewWorldMapIndexFile(szNewWorldMapIndexFileName))
-		sys_err("cannot load NewWorldMapIndex: %s", szNewWorldMapIndexFileName);
-#endif
-
-	SECTREE_MANAGER::instance().LoadBlockFilterMapIndexFile(SECTREE_MANAGER::PET_BLOCK_MAP_INDEX);
-	SECTREE_MANAGER::instance().LoadBlockFilterMapIndexFile(SECTREE_MANAGER::MOUNT_BLOCK_MAP_INDEX);
-
-#if defined(__DRAGON_SOUL_SYSTEM__)
 	sys_log(0, "LoadLocaleFile: DragonSoulTable: %s", szDragonSoulTableFileName);
 	if (!DSManager::instance().ReadDragonSoulTableFile(szDragonSoulTableFileName))
 	{
 		sys_err("cannot load DragonSoulTable: %s", szDragonSoulTableFileName);
-		//thecore_shutdown();
-		//return;
+		// thecore_shutdown();
+		// return;
 	}
-#endif
-
-#if defined(__LUCKY_BOX__)
-	sys_log(0, "LoadLocaleFile: LuckyBoxFile: %s", szLuckyBoxFileName);
-	if (!ITEM_MANAGER::instance().ReadLuckyBoxFile(szLuckyBoxFileName))
-	{
-		sys_err("cannot load LuckyBoxFile: %s", szLuckyBoxFileName);
-		thecore_shutdown();
-		return;
-	}
-#endif
-
-#if defined(__ITEM_APPLY_RANDOM__)
-	char szApplyRandomTableFileName[FILE_NAME_LEN];
-	snprintf(szApplyRandomTableFileName, sizeof(szApplyRandomTableFileName),
-		"%s/apply_random_table.txt", LocaleService_GetBasePath().c_str());
-	sys_log(0, "LoadLocaleFile: ApplyRandomTable: %s", szApplyRandomTableFileName);
-	if (!ITEM_MANAGER::instance().ReadApplyRandomTableFile(szApplyRandomTableFileName))
-	{
-		sys_err("LoadLocaleFile: Cannot load ApplyRandomTable: %s", szApplyRandomTableFileName);
-		thecore_shutdown();
-		return;
-	}
-#endif
-
-#if defined(__GEM_SHOP__)
-	char szGemShopTableFileName[FILE_NAME_LEN];
-	snprintf(szGemShopTableFileName, sizeof(szGemShopTableFileName),
-		"%s/gem_shop_table.txt", LocaleService_GetBasePath().c_str());
-	sys_log(0, "LoadLocaleFile: GemShopTable: %s", szGemShopTableFileName);
-	if (!ITEM_MANAGER::instance().ReadGemShopItemGroup(szGemShopTableFileName))
-		sys_err("LoadLocaleFile: Cannot load GemShopTable: %s", szGemShopTableFileName);
-#endif
-
-#if defined(__SET_ITEM__)
-	char szSetItemTableFileName[FILE_NAME_LEN];
-	snprintf(szSetItemTableFileName, sizeof(szSetItemTableFileName),
-		"%s/set_item_table.txt", LocaleService_GetBasePath().c_str());
-	sys_log(0, "LoadLocaleFile: SetItemTable: %s", szSetItemTableFileName);
-	if (!ITEM_MANAGER::instance().LoadSetItemTable(szSetItemTableFileName))
-		sys_err("LoadLocaleFile: Cannot load SetItemTable: %s", szSetItemTableFileName);
-#endif
-
-#if defined(__SUMMER_EVENT_ROULETTE__)
-	sys_log(0, "LoadLocaleFile: RouletteTable: %s", szRouletteTableFileName);
-	if (!CRouletteManager::Instance().ReadRouletteTableFile(szRouletteTableFileName))
-	{
-		sys_err("cannot load RouletteTable: %s", szRouletteTableFileName);
-		thecore_shutdown();
-		return;
-	}
-#endif
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	if (!CBattlePassManager::instance().InitializeBattlePass())
-		sys_err("Failure to Initialize Extended BattlePass!");
-#endif
 
 	// END_OF_LOCALE_SERVICE
 
@@ -1276,16 +1096,10 @@
 	}
 
 	CPCBangManager::instance().RequestUpdateIPList(0);
-#ifdef __OFFLINE_SHOP__
-	COfflineShop::OpenShops();
-#endif
+
 	// castle_boot
 	castle_boot();
 
-#if defined(__MT_THUNDER_DUNGEON__)
-	CMTThunderDungeon::Instance().Initialize();
-#endif
-
 	// request blocked_country_ip
 	{
 		db_clientdesc->DBPacket(HEADER_GD_BLOCK_COUNTRY_IP, 0, NULL, 0);
@@ -1437,25 +1251,31 @@
 
 	LPCHARACTER ch = d->GetCharacter();
 
-	// PREVENT_TRADE_WINDOW
-	if (ch->PreventTradeWindow(WND_SAFEBOX, true/*except*/))
+	//PREVENT_TRADE_WINDOW
+	if (ch->GetShopOwner() || ch->GetExchange() || ch->GetMyShop() || ch->IsCubeOpen()
+#ifdef __AURA_SYSTEM__
+	|| ch->IsAuraRefineWindowOpen()
+#endif
+	)
 	{
-		d->GetCharacter()->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ٸŷâ ¿ â  ϴ."));
+		d->GetCharacter()->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ٸŷâ ¿ â  ϴ."));
 		d->GetCharacter()->CancelSafeboxLoad();
 		return;
 	}
-	// END_PREVENT_TRADE_WINDOW
+	//END_PREVENT_TRADE_WINDOW
 
 	// ADD_PREMIUM
-	if (d->GetCharacter()->GetPremiumRemainSeconds(PREMIUM_SAFEBOX) > 0)
+	if (d->GetCharacter()->GetPremiumRemainSeconds(PREMIUM_SAFEBOX) > 0 ||
+		d->GetCharacter()->IsEquipUniqueGroup(UNIQUE_GROUP_LARGE_SAFEBOX))
 		bSize = 3;
 	// END_OF_ADD_PREMIUM
 
-	if (d->GetCharacter()->IsEquipUniqueGroup(UNIQUE_GROUP_LARGE_SAFEBOX))
-		bSize = 3; // âȮ
+	//if (d->GetCharacter()->IsEquipUniqueItem(UNIQUE_ITEM_SAFEBOX_EXPAND))
+	//bSize = 3; // âȮ
 
 	//d->GetCharacter()->LoadSafebox(p->bSize * SAFEBOX_PAGE_SIZE, p->dwGold, p->wItemCount, (TPlayerItem *) (c_pData + sizeof(TSafeboxTable)));
 	d->GetCharacter()->LoadSafebox(bSize * SAFEBOX_PAGE_SIZE, p->dwGold, p->wItemCount, (TPlayerItem*)(c_pData + sizeof(TSafeboxTable)));
+	
 #ifdef __GROWTH_PET_SYSTEM__
 	c_pData += sizeof(TSafeboxTable) + sizeof(TPlayerItem) * p->wItemCount;
 
@@ -1508,12 +1328,11 @@
 	TSafeboxChangePasswordPacketAnswer* p = (TSafeboxChangePasswordPacketAnswer*)c_pData;
 	if (p->flag)
 	{
-		d->GetCharacter()->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<â> â йȣ Ǿϴ."));
-		d->GetCharacter()->SetSafeboxBuff();
+		d->GetCharacter()->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<â> â йȣ Ǿϴ."));
 	}
 	else
 	{
-		d->GetCharacter()->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<â>  йȣ ƲȽϴ."));
+		d->GetCharacter()->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<â>  йȣ ƲȽϴ."));
 	}
 }
 
@@ -1580,13 +1399,11 @@
 	d->Packet(&pe, sizeof(pe));
 
 	for (int i = 0; i < PLAYER_PER_ACCOUNT; ++i)
-	{
 		if (rTable.players[i].dwID)
 		{
 			rTable.players[i].x = EMPIRE_START_X(rTable.bEmpire);
 			rTable.players[i].y = EMPIRE_START_Y(rTable.bEmpire);
 		}
-	}
 
 	GetServerLocation(d->GetAccountTable(), rTable.bEmpire);
 
@@ -1659,42 +1476,42 @@
 
 	switch (p->bWar)
 	{
-		case GUILD_WAR_SEND_DECLARE:
-		case GUILD_WAR_RECV_DECLARE:
-			CGuildManager::instance().DeclareWar(p->dwGuildFrom, p->dwGuildTo, p->bType);
-			break;
+	case GUILD_WAR_SEND_DECLARE:
+	case GUILD_WAR_RECV_DECLARE:
+		CGuildManager::instance().DeclareWar(p->dwGuildFrom, p->dwGuildTo, p->bType);
+		break;
 
-		case GUILD_WAR_REFUSE:
-			CGuildManager::instance().RefuseWar(p->dwGuildFrom, p->dwGuildTo);
-			break;
+	case GUILD_WAR_REFUSE:
+		CGuildManager::instance().RefuseWar(p->dwGuildFrom, p->dwGuildTo);
+		break;
 
-		case GUILD_WAR_WAIT_START:
-			CGuildManager::instance().WaitStartWar(p->dwGuildFrom, p->dwGuildTo);
-			break;
+	case GUILD_WAR_WAIT_START:
+		CGuildManager::instance().WaitStartWar(p->dwGuildFrom, p->dwGuildTo);
+		break;
 
-		case GUILD_WAR_CANCEL:
-			CGuildManager::instance().CancelWar(p->dwGuildFrom, p->dwGuildTo);
-			break;
+	case GUILD_WAR_CANCEL:
+		CGuildManager::instance().CancelWar(p->dwGuildFrom, p->dwGuildTo);
+		break;
 
-		case GUILD_WAR_ON_WAR:
-			CGuildManager::instance().StartWar(p->dwGuildFrom, p->dwGuildTo);
-			break;
+	case GUILD_WAR_ON_WAR:
+		CGuildManager::instance().StartWar(p->dwGuildFrom, p->dwGuildTo);
+		break;
 
-		case GUILD_WAR_END:
-			CGuildManager::instance().EndWar(p->dwGuildFrom, p->dwGuildTo);
-			break;
+	case GUILD_WAR_END:
+		CGuildManager::instance().EndWar(p->dwGuildFrom, p->dwGuildTo);
+		break;
 
-		case GUILD_WAR_OVER:
-			CGuildManager::instance().WarOver(p->dwGuildFrom, p->dwGuildTo, p->bType);
-			break;
+	case GUILD_WAR_OVER:
+		CGuildManager::instance().WarOver(p->dwGuildFrom, p->dwGuildTo, p->bType);
+		break;
 
-		case GUILD_WAR_RESERVE:
-			CGuildManager::instance().ReserveWar(p->dwGuildFrom, p->dwGuildTo, p->bType);
-			break;
+	case GUILD_WAR_RESERVE:
+		CGuildManager::instance().ReserveWar(p->dwGuildFrom, p->dwGuildTo, p->bType);
+		break;
 
-		default:
-			sys_err("Unknown guild war state");
-			break;
+	default:
+		sys_err("Unknown guild war state");
+		break;
 	}
 }
 
@@ -1774,6 +1591,18 @@
 	g->SetWarData(p->lWin, p->lDraw, p->lLoss);
 }
 
+#if defined(__SKILL_COLOR_SYSTEM__)
+void CInputDB::SkillColorLoad(LPDESC d, const char* c_pData)
+{
+	LPCHARACTER ch;
+
+	if (!d || !(ch = d->GetCharacter()))
+		return;
+
+	ch->SetSkillColor((DWORD*)c_pData);
+}
+#endif
+
 void CInputDB::ItemLoad(LPDESC d, const char* c_pData)
 {
 	LPCHARACTER ch;
@@ -1795,72 +1624,67 @@
 
 	for (DWORD i = 0; i < dwCount; ++i, ++p)
 	{
-		LPITEM item = ITEM_MANAGER::instance().CreateItem(p->dwVnum, p->dwCount, p->dwID);
+		LPITEM item = ITEM_MANAGER::instance().CreateItem(p->vnum, p->count, p->id);
 
 		if (!item)
 		{
-			sys_err("cannot create item by vnum %u (name %s id %u)", p->dwVnum, ch->GetName(), p->dwID);
+			sys_err("cannot create item by vnum %u (name %s id %u)", p->vnum, ch->GetName(), p->id);
 			continue;
 		}
 
 		item->SetSkipSave(true);
-#if defined(__SOUL_BIND_SYSTEM__)
-		item->SealItem(p->lSealDate);
-#endif
 		item->SetSockets(p->alSockets);
 		item->SetAttributes(p->aAttr);
-#if defined(__CHANGE_LOOK_SYSTEM__)
-		item->SetTransmutationVnum(p->dwTransmutationVnum);
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-		item->SetRefineElement(&p->RefineElement);
-#endif
-#if defined(__ITEM_APPLY_RANDOM__)
-		item->SetRandomApplies(p->aApplyRandom);
+#if defined(__SOUL_BIND_SYSTEM__)
+		item->SetSoulBind(p->soulbind);
 #endif
-#if defined(__SET_ITEM__)
-		item->SetItemSetValue(p->bSetValue);
+#if defined(__CHANGE_LOOK_SYSTEM__)
+		item->SetTransmutation(p->transmutation);
 #endif
 
-		if ((p->bWindow == INVENTORY && ch->GetInventoryItem(p->wPos)) ||
-			(p->bWindow == EQUIPMENT && ch->GetEquipmentItem(p->wPos)))
+		if (p->window == BELT_INVENTORY)
+		{
+			p->window = INVENTORY;
+			p->pos = p->pos + BELT_INVENTORY_SLOT_START;
+		}
+
+		if ((p->window == INVENTORY && ch->GetInventoryItem(p->pos)) ||
+			(p->window == EQUIPMENT && ch->GetWear(p->pos)))
 		{
 			sys_log(0, "ITEM_RESTORE: %s %s", ch->GetName(), item->GetName());
-			v.emplace_back(item);
+			v.push_back(item);
 		}
 		else
 		{
-			switch (p->bWindow)
+			switch (p->window)
 			{
-				case INVENTORY:
-				case DRAGON_SOUL_INVENTORY:
-				case BELT_INVENTORY:
-#if defined(__ATTR_6TH_7TH__)
-				case NPC_STORAGE:
+			case INVENTORY:
+			case DRAGON_SOUL_INVENTORY:
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+			case SKILL_BOOK_INVENTORY:
+			case UPGRADE_ITEMS_INVENTORY:
+			case STONE_INVENTORY:
+			case GIFT_BOX_INVENTORY:
 #endif
-				{
 #if defined(__WJ_PICKUP_ITEM_EFFECT__)
-					item->AddToCharacter(ch, TItemPos(p->bWindow, p->wPos), false);
+				item->AddToCharacter(ch, TItemPos(p->window, p->pos), false);
 #else
-					item->AddToCharacter(ch, TItemPos(p->bWindow, p->wPos));
+				item->AddToCharacter(ch, TItemPos(p->window, p->pos));
 #endif
-				}
 				break;
 
-				case EQUIPMENT:
+			case EQUIPMENT:
+				if (item->CheckItemUseLevel(ch->GetLevel()) == true)
 				{
-					if (item->CheckItemUseLevel(ch->GetLevel()) == true)
-					{
-						if (item->EquipTo(ch, p->wPos) == false)
-						{
-							v.emplace_back(item);
-						}
-					}
-					else
+					if (item->EquipTo(ch, p->pos) == false)
 					{
-						v.emplace_back(item);
+						v.push_back(item);
 					}
 				}
+				else
+				{
+					v.push_back(item);
+				}
 				break;
 			}
 		}
@@ -1871,12 +1695,33 @@
 		item->SetSkipSave(false);
 	}
 
-	auto it = v.begin();
+	itertype(v) it = v.begin();
+
 	while (it != v.end())
 	{
 		LPITEM item = *(it++);
 
 		int pos = ch->GetEmptyInventory(item->GetSize());
+
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+		if (item->IsSkillBook())
+		{
+			pos = ch->GetEmptySkillBookInventory(item->GetSize());
+		}
+		else if (item->IsUpgradeItem())
+		{
+			pos = ch->GetEmptyUpgradeItemsInventory(item->GetSize());
+		}
+		else if (item->IsStone())
+		{
+			pos = ch->GetEmptyStoneInventory(item->GetSize());
+		}
+		else if (item->IsGiftBox())
+		{
+			pos = ch->GetEmptyGiftBoxInventory(item->GetSize());
+		}
+#endif
+
 		if (pos < 0)
 		{
 			PIXEL_POSITION coord;
@@ -1895,40 +1740,12 @@
 #endif
 	}
 
-#if defined(__WEAPON_COSTUME_SYSTEM__) && defined(__HIDE_WEAPON_COSTUME_WITH_NO_MAIN_WEAPON__)
-	if (ch->GetWear(WEAR_COSTUME_WEAPON) && !ch->GetWear(WEAR_WEAPON))
-		ch->SetPart(PART_WEAPON, 0);
-#endif
-
 	ch->CheckMaximumPoints();
 	ch->PointsPacket();
 
 	ch->SetItemLoaded();
 }
 
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-void CInputDB::ExtBattlePassLoad(LPDESC d, const char* c_pData)
-{
-	if (!d || !d->GetCharacter())
-		return;
-
-	LPCHARACTER ch = d->GetCharacter();
-	if (!ch)
-		return;
-
-	DWORD dwPID = decode_4bytes(c_pData);
-	c_pData += sizeof(DWORD);
-
-	DWORD dwCount = decode_4bytes(c_pData);
-	c_pData += sizeof(DWORD);
-
-	if (ch->GetPlayerID() != dwPID)
-		return;
-
-	ch->LoadExtBattlePass(dwCount, (TPlayerExtBattlePassMission*)c_pData);
-}
-#endif
-
 void CInputDB::AffectLoad(LPDESC d, const char* c_pData)
 {
 	if (!d)
@@ -1949,6 +1766,7 @@
 		return;
 
 	ch->LoadAffect(dwCount, (TPacketAffectElement*)c_pData);
+
 }
 
 void CInputDB::PartyCreate(const char* c_pData)
@@ -2065,7 +1883,7 @@
 		CRefineManager::instance().Initialize((TRefineTable*)c_pData, wSize);
 		c_pData += wSize * sizeof(TRefineTable);
 	}
-
+	
 #ifdef __GROWTH_PET_SYSTEM__
 	/*
 	* GROWTH PET SKILL
@@ -2101,6 +1919,7 @@
 		return;
 
 	BYTE bResult = *(BYTE*)c_pData;
+	m_bState = TCS;
 
 	TPacketGCAuthSuccess ptoc;
 
@@ -2125,6 +1944,7 @@
 	}
 
 	ptoc.bResult = bResult;
+	ptoc.bState = m_bState;
 
 	d->Packet(&ptoc, sizeof(TPacketGCAuthSuccess));
 	sys_log(0, "AuthLogin result %u key %u", bResult, d->GetLoginKey());
@@ -2140,8 +1960,8 @@
 }
 
 /**
-* @version 05/06/08 Bang2ni - ӽð ߰
-**/
+ * @version 05/06/08 Bang2ni - ӽð ߰
+ */
 void CInputDB::ChangeGuildPriv(const char* c_pData)
 {
 	TPacketDGChangeGuildPriv* p = (TPacketDGChangeGuildPriv*)c_pData;
@@ -2167,11 +1987,7 @@
 	if (g_bAuthServer == true)
 		return;
 
-	LogManager::instance().MoneyLog(p->type, p->vnum, p->gold
-#if defined(__CHEQUE_SYSTEM__)
-		, p->cheque
-#endif
-	);
+	LogManager::instance().MoneyLog(p->type, p->vnum, p->gold);
 }
 
 void CInputDB::GuildMoneyChange(const char* c_pData)
@@ -2222,14 +2038,14 @@
 
 void CInputDB::Notice(const char* c_pData)
 {
-	extern void SendNotice(const char* c_pszBuf, const bool c_bBigFont = false);
+	extern void SendNotice(const char* c_pszBuf, ...);
 
 	char szBuf[256 + 1];
 	strlcpy(szBuf, c_pData, sizeof(szBuf));
 
 	sys_log(0, "InputDB:: Notice: %s", szBuf);
 
-	//SendNotice(LC_STRING(szBuf));
+	//SendNotice(LC_TEXT(szBuf));
 	SendNotice(szBuf);
 }
 
@@ -2248,14 +2064,6 @@
 	CGuildManager::instance().ReserveWarBet(p);
 }
 
-#if defined(__GUILD_EVENT_FLAG__) //&& defined(__GUILD_RENEWAL__)
-void CInputDB::GuildSetEventFlag(const char* c_pData)
-{
-	const TPacketSetGuildEventFlag* p = (TPacketSetGuildEventFlag*)c_pData;
-	CGuildManager::Instance().SetEventFlag(p->dwGuildID, p->szFlagName, p->lValue);
-}
-#endif
-
 void CInputDB::MarriageAdd(TPacketMarriageAdd* p)
 {
 	sys_log(0, "MarriageAdd %u %u %u %s %s", p->dwPID1, p->dwPID2, (DWORD)p->tMarryTime, p->szName1, p->szName2);
@@ -2347,458 +2155,415 @@
 }
 // END_RELOAD_ADMIN
 
-////////////////////////////////////////////////////////////////////
-// Analyze
-// @version 05/06/10 Bang2ni -   Ʈ Ŷ(HEADER_DG_MYSHOP_PRICELIST_RES) óƾ ߰.
-////////////////////////////////////////////////////////////////////
-int CInputDB::Analyze(LPDESC d, BYTE bHeader, const char* c_pData)
+#ifdef __GROWTH_PET_SYSTEM__
+void CInputDB::GrowthPetLoad(LPDESC d, const char* c_pData)
 {
-	switch (bHeader)
-	{
-		case HEADER_DG_BOOT:
-			Boot(c_pData);
-			break;
-
-		case HEADER_DG_LOGIN_SUCCESS:
-			LoginSuccess(m_dwHandle, c_pData);
-			break;
-
-		case HEADER_DG_LOGIN_NOT_EXIST:
-			LoginFailure(DESC_MANAGER::instance().FindByHandle(m_dwHandle), "NOID");
-			break;
-
-		case HEADER_DG_LOGIN_WRONG_PASSWD:
-			LoginFailure(DESC_MANAGER::instance().FindByHandle(m_dwHandle), "WRONGPWD");
-			break;
-
-		case HEADER_DG_LOGIN_ALREADY:
-			LoginAlready(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
+	LPCHARACTER ch;
 
-		case HEADER_DG_PLAYER_LOAD_SUCCESS:
-			PlayerLoad(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
+	if (!d || !(ch = d->GetCharacter()))
+		return;
 
-		case HEADER_DG_PLAYER_CREATE_SUCCESS:
-			PlayerCreateSuccess(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
+	if (ch->IsGrowthPetLoaded())
+		return;
 
-		case HEADER_DG_PLAYER_CREATE_FAILED:
-			PlayerCreateFailure(DESC_MANAGER::instance().FindByHandle(m_dwHandle), 0);
-			break;
+	DWORD dwCount = decode_4bytes(c_pData);
+	c_pData += sizeof(DWORD);
 
-		case HEADER_DG_PLAYER_CREATE_ALREADY:
-			PlayerCreateFailure(DESC_MANAGER::instance().FindByHandle(m_dwHandle), 1);
-			break;
+	sys_log(0, "GROWTH_PET_LOAD: COUNT %s %u", ch->GetName(), dwCount);
 
-		case HEADER_DG_PLAYER_DELETE_SUCCESS:
-			PlayerDeleteSuccess(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
+	TGrowthPet* p = (TGrowthPet*)c_pData;
 
-		case HEADER_DG_PLAYER_LOAD_FAILED:
-			//sys_log(0, "PLAYER_LOAD_FAILED");
-			break;
+	for (DWORD i = 0; i < dwCount; ++i, ++p)
+	{
+		LPGROWTH_PET pPet = CGrowthPetManager::Instance().CreateGrowthPet(ch, p->dwID);
+		if (pPet)
+		{
+			pPet->SetGrowthPetProto(p);
+			ch->SetGrowthPet(pPet);
+		}
+	}
 
-		case HEADER_DG_PLAYER_DELETE_FAILED:
-			//sys_log(0, "PLAYER_DELETE_FAILED");
-#if defined(__DELETE_FAILURE_TYPE__)
-			PlayerDeleteFail(DESC_MANAGER::Instance().FindByHandle(m_dwHandle), c_pData);
-#else
-			PlayerDeleteFail(DESC_MANAGER::instance().FindByHandle(m_dwHandle));
+	ch->SetGrowthPetLoaded(true);
+}
 #endif
-			break;
-
-		case HEADER_DG_ITEM_LOAD:
-			ItemLoad(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
-
-		case HEADER_DG_QUEST_LOAD:
-			QuestLoad(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
-
-		case HEADER_DG_AFFECT_LOAD:
-			AffectLoad(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
+////////////////////////////////////////////////////////////////////
+// Analyze
+// @version 05/06/10 Bang2ni -   Ʈ Ŷ(HEADER_DG_MYSHOP_PRICELIST_RES) óƾ ߰.
+////////////////////////////////////////////////////////////////////
+int CInputDB::Analyze(LPDESC d, BYTE bHeader, const char* c_pData)
+{
+	switch (bHeader)
+	{
+	case HEADER_DG_BOOT:
+		Boot(c_pData);
+		break;
 
-		case HEADER_DG_SAFEBOX_LOAD:
-			SafeboxLoad(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
+	case HEADER_DG_LOGIN_SUCCESS:
+		LoginSuccess(m_dwHandle, c_pData);
+		break;
 
-		case HEADER_DG_SAFEBOX_CHANGE_SIZE:
-			SafeboxChangeSize(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
+	case HEADER_DG_LOGIN_NOT_EXIST:
+		LoginFailure(DESC_MANAGER::instance().FindByHandle(m_dwHandle), "NOID");
+		break;
 
-		case HEADER_DG_SAFEBOX_WRONG_PASSWORD:
-			SafeboxWrongPassword(DESC_MANAGER::instance().FindByHandle(m_dwHandle));
-			break;
+	case HEADER_DG_LOGIN_WRONG_PASSWD:
+		LoginFailure(DESC_MANAGER::instance().FindByHandle(m_dwHandle), "WRONGPWD");
+		break;
 
-		case HEADER_DG_SAFEBOX_CHANGE_PASSWORD_ANSWER:
-			SafeboxChangePasswordAnswer(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
+	case HEADER_DG_LOGIN_ALREADY:
+		LoginAlready(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
+		break;
 
-		case HEADER_DG_MALL_LOAD:
-			MallLoad(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
+	case HEADER_DG_PLAYER_LOAD_SUCCESS:
+		PlayerLoad(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
+		break;
 
-		case HEADER_DG_EMPIRE_SELECT:
-			EmpireSelect(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
+	case HEADER_DG_PLAYER_CREATE_SUCCESS:
+		PlayerCreateSuccess(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
+		break;
 
-		case HEADER_DG_MAP_LOCATIONS:
-			MapLocations(c_pData);
-			break;
+	case HEADER_DG_PLAYER_CREATE_FAILED:
+		PlayerCreateFailure(DESC_MANAGER::instance().FindByHandle(m_dwHandle), 0);
+		break;
 
-		case HEADER_DG_P2P:
-			P2P(c_pData);
-			break;
+	case HEADER_DG_PLAYER_CREATE_ALREADY:
+		PlayerCreateFailure(DESC_MANAGER::instance().FindByHandle(m_dwHandle), 1);
+		break;
 
-		case HEADER_DG_GUILD_SKILL_UPDATE:
-			GuildSkillUpdate(c_pData);
-			break;
+	case HEADER_DG_PLAYER_DELETE_SUCCESS:
+		PlayerDeleteSuccess(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
+		break;
 
-		case HEADER_DG_GUILD_LOAD:
-			GuildLoad(c_pData);
-			break;
+	case HEADER_DG_PLAYER_LOAD_FAILED:
+		//sys_log(0, "PLAYER_LOAD_FAILED");
+		break;
 
-		case HEADER_DG_GUILD_SKILL_RECHARGE:
-			GuildSkillRecharge();
-			break;
+	case HEADER_DG_PLAYER_DELETE_FAILED:
+		//sys_log(0, "PLAYER_DELETE_FAILED");
+		PlayerDeleteFail(DESC_MANAGER::instance().FindByHandle(m_dwHandle));
+		break;
 
-		case HEADER_DG_GUILD_EXP_UPDATE:
-			GuildExpUpdate(c_pData);
-			break;
+	case HEADER_DG_ITEM_LOAD:
+		ItemLoad(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
+		break;
 
-		case HEADER_DG_PARTY_CREATE:
-			PartyCreate(c_pData);
-			break;
+	case HEADER_DG_QUEST_LOAD:
+		QuestLoad(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
+		break;
 
-		case HEADER_DG_PARTY_DELETE:
-			PartyDelete(c_pData);
-			break;
+	case HEADER_DG_AFFECT_LOAD:
+		AffectLoad(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
+		break;
 
-		case HEADER_DG_PARTY_ADD:
-			PartyAdd(c_pData);
-			break;
+	case HEADER_DG_SAFEBOX_LOAD:
+		SafeboxLoad(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
+		break;
 
-		case HEADER_DG_PARTY_REMOVE:
-			PartyRemove(c_pData);
-			break;
+	case HEADER_DG_SAFEBOX_CHANGE_SIZE:
+		SafeboxChangeSize(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
+		break;
 
-		case HEADER_DG_PARTY_STATE_CHANGE:
-			PartyStateChange(c_pData);
-			break;
+	case HEADER_DG_SAFEBOX_WRONG_PASSWORD:
+		SafeboxWrongPassword(DESC_MANAGER::instance().FindByHandle(m_dwHandle));
+		break;
 
-		case HEADER_DG_PARTY_SET_MEMBER_LEVEL:
-			PartySetMemberLevel(c_pData);
-			break;
+	case HEADER_DG_SAFEBOX_CHANGE_PASSWORD_ANSWER:
+		SafeboxChangePasswordAnswer(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
+		break;
 
-		case HEADER_DG_TIME:
-			Time(c_pData);
-			break;
+	case HEADER_DG_MALL_LOAD:
+		MallLoad(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
+		break;
 
-		case HEADER_DG_GUILD_ADD_MEMBER:
-			GuildAddMember(c_pData);
-			break;
+	case HEADER_DG_EMPIRE_SELECT:
+		EmpireSelect(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
+		break;
 
-		case HEADER_DG_GUILD_REMOVE_MEMBER:
-			GuildRemoveMember(c_pData);
-			break;
+	case HEADER_DG_MAP_LOCATIONS:
+		MapLocations(c_pData);
+		break;
 
-		case HEADER_DG_GUILD_CHANGE_GRADE:
-			GuildChangeGrade(c_pData);
-			break;
+	case HEADER_DG_P2P:
+		P2P(c_pData);
+		break;
 
-		case HEADER_DG_GUILD_CHANGE_MEMBER_DATA:
-			GuildChangeMemberData(c_pData);
-			break;
+	case HEADER_DG_GUILD_SKILL_UPDATE:
+		GuildSkillUpdate(c_pData);
+		break;
 
-		case HEADER_DG_GUILD_DISBAND:
-			GuildDisband(c_pData);
-			break;
+	case HEADER_DG_GUILD_LOAD:
+		GuildLoad(c_pData);
+		break;
 
-		case HEADER_DG_RELOAD_PROTO:
-			ReloadProto(c_pData);
-			break;
+	case HEADER_DG_GUILD_SKILL_RECHARGE:
+		GuildSkillRecharge();
+		break;
 
-		case HEADER_DG_GUILD_WAR:
-			GuildWar(c_pData);
-			break;
+	case HEADER_DG_GUILD_EXP_UPDATE:
+		GuildExpUpdate(c_pData);
+		break;
 
-		case HEADER_DG_GUILD_WAR_SCORE:
-			GuildWarScore(c_pData);
-			break;
+	case HEADER_DG_PARTY_CREATE:
+		PartyCreate(c_pData);
+		break;
 
-		case HEADER_DG_GUILD_LADDER:
-			GuildLadder(c_pData);
-			break;
+	case HEADER_DG_PARTY_DELETE:
+		PartyDelete(c_pData);
+		break;
 
-		case HEADER_DG_GUILD_SKILL_USABLE_CHANGE:
-			GuildSkillUsableChange(c_pData);
-			break;
+	case HEADER_DG_PARTY_ADD:
+		PartyAdd(c_pData);
+		break;
 
-		case HEADER_DG_CHANGE_NAME:
-			ChangeName(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
+	case HEADER_DG_PARTY_REMOVE:
+		PartyRemove(c_pData);
+		break;
 
-		case HEADER_DG_AUTH_LOGIN:
-			AuthLogin(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
+	case HEADER_DG_PARTY_STATE_CHANGE:
+		PartyStateChange(c_pData);
+		break;
 
-		case HEADER_DG_CHANGE_EMPIRE_PRIV:
-			ChangeEmpirePriv(c_pData);
-			break;
+	case HEADER_DG_PARTY_SET_MEMBER_LEVEL:
+		PartySetMemberLevel(c_pData);
+		break;
 
-		case HEADER_DG_CHANGE_GUILD_PRIV:
-			ChangeGuildPriv(c_pData);
-			break;
+	case HEADER_DG_TIME:
+		Time(c_pData);
+		break;
 
-		case HEADER_DG_CHANGE_CHARACTER_PRIV:
-			ChangeCharacterPriv(c_pData);
-			break;
+	case HEADER_DG_GUILD_ADD_MEMBER:
+		GuildAddMember(c_pData);
+		break;
 
-		case HEADER_DG_MONEY_LOG:
-			MoneyLog(c_pData);
-			break;
+	case HEADER_DG_GUILD_REMOVE_MEMBER:
+		GuildRemoveMember(c_pData);
+		break;
 
-		case HEADER_DG_GUILD_WITHDRAW_MONEY_GIVE:
-			GuildWithdrawMoney(c_pData);
-			break;
+	case HEADER_DG_GUILD_CHANGE_GRADE:
+		GuildChangeGrade(c_pData);
+		break;
 
-		case HEADER_DG_GUILD_MONEY_CHANGE:
-			GuildMoneyChange(c_pData);
-			break;
+	case HEADER_DG_GUILD_CHANGE_MEMBER_DATA:
+		GuildChangeMemberData(c_pData);
+		break;
 
-		case HEADER_DG_SET_EVENT_FLAG:
-			SetEventFlag(c_pData);
-			break;
+	case HEADER_DG_GUILD_DISBAND:
+		GuildDisband(c_pData);
+		break;
 
-		case HEADER_DG_CREATE_OBJECT:
-			CreateObject(c_pData);
-			break;
+	case HEADER_DG_RELOAD_PROTO:
+		ReloadProto(c_pData);
+		break;
 
-		case HEADER_DG_DELETE_OBJECT:
-			DeleteObject(c_pData);
-			break;
+	case HEADER_DG_GUILD_WAR:
+		GuildWar(c_pData);
+		break;
 
-		case HEADER_DG_UPDATE_LAND:
-			UpdateLand(c_pData);
-			break;
+	case HEADER_DG_GUILD_WAR_SCORE:
+		GuildWarScore(c_pData);
+		break;
 
-		case HEADER_DG_NOTICE:
-			Notice(c_pData);
-			break;
+	case HEADER_DG_GUILD_LADDER:
+		GuildLadder(c_pData);
+		break;
 
-		case HEADER_DG_GUILD_WAR_RESERVE_ADD:
-			GuildWarReserveAdd((TGuildWarReserve*)c_pData);
-			break;
+	case HEADER_DG_GUILD_SKILL_USABLE_CHANGE:
+		GuildSkillUsableChange(c_pData);
+		break;
 
-		case HEADER_DG_GUILD_WAR_RESERVE_DEL:
-			GuildWarReserveDelete(*(DWORD*)c_pData);
-			break;
+	case HEADER_DG_CHANGE_NAME:
+		ChangeName(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
+		break;
 
-		case HEADER_DG_GUILD_WAR_BET:
-			GuildWarBet((TPacketGDGuildWarBet*)c_pData);
-			break;
+	case HEADER_DG_AUTH_LOGIN:
+		AuthLogin(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
+		break;
 
-#if defined(__GUILD_EVENT_FLAG__) //&& defined(__GUILD_RENEWAL__)
-		case HEADER_DG_GUILD_EVENT_FLAG:
-			GuildSetEventFlag(c_pData);
-			break;
-#endif
+	case HEADER_DG_CHANGE_EMPIRE_PRIV:
+		ChangeEmpirePriv(c_pData);
+		break;
 
-		case HEADER_DG_MARRIAGE_ADD:
-			MarriageAdd((TPacketMarriageAdd*)c_pData);
-			break;
+	case HEADER_DG_CHANGE_GUILD_PRIV:
+		ChangeGuildPriv(c_pData);
+		break;
 
-		case HEADER_DG_MARRIAGE_UPDATE:
-			MarriageUpdate((TPacketMarriageUpdate*)c_pData);
-			break;
+	case HEADER_DG_CHANGE_CHARACTER_PRIV:
+		ChangeCharacterPriv(c_pData);
+		break;
 
-		case HEADER_DG_MARRIAGE_REMOVE:
-			MarriageRemove((TPacketMarriageRemove*)c_pData);
-			break;
+	case HEADER_DG_MONEY_LOG:
+		MoneyLog(c_pData);
+		break;
 
-		case HEADER_DG_WEDDING_REQUEST:
-			WeddingRequest((TPacketWeddingRequest*)c_pData);
-			break;
+	case HEADER_DG_GUILD_WITHDRAW_MONEY_GIVE:
+		GuildWithdrawMoney(c_pData);
+		break;
 
-		case HEADER_DG_WEDDING_READY:
-			WeddingReady((TPacketWeddingReady*)c_pData);
-			break;
+	case HEADER_DG_GUILD_MONEY_CHANGE:
+		GuildMoneyChange(c_pData);
+		break;
 
-		case HEADER_DG_WEDDING_START:
-			WeddingStart((TPacketWeddingStart*)c_pData);
-			break;
+	case HEADER_DG_SET_EVENT_FLAG:
+		SetEventFlag(c_pData);
+		break;
 
-		case HEADER_DG_WEDDING_END:
-			WeddingEnd((TPacketWeddingEnd*)c_pData);
-			break;
+	case HEADER_DG_CREATE_OBJECT:
+		CreateObject(c_pData);
+		break;
 
-			// MYSHOP_PRICE_LIST
-		case HEADER_DG_MYSHOP_PRICELIST_RES:
-			MyshopPricelistRes(DESC_MANAGER::instance().FindByHandle(m_dwHandle), (TPacketMyshopPricelistHeader*)c_pData);
-			break;
-			// END_OF_MYSHOP_PRICE_LIST
+	case HEADER_DG_DELETE_OBJECT:
+		DeleteObject(c_pData);
+		break;
 
-			// RELOAD_ADMIN
-		case HEADER_DG_RELOAD_ADMIN:
-			ReloadAdmin(c_pData);
-			break;
-			// END_RELOAD_ADMIN
+	case HEADER_DG_UPDATE_LAND:
+		UpdateLand(c_pData);
+		break;
 
-		case HEADER_DG_ADD_MONARCH_MONEY:
-			AddMonarchMoney(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
+	case HEADER_DG_NOTICE:
+		Notice(c_pData);
+		break;
 
-		case HEADER_DG_DEC_MONARCH_MONEY:
-			DecMonarchMoney(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
+	case HEADER_DG_GUILD_WAR_RESERVE_ADD:
+		GuildWarReserveAdd((TGuildWarReserve*)c_pData);
+		break;
 
-		case HEADER_DG_TAKE_MONARCH_MONEY:
-			TakeMonarchMoney(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
+	case HEADER_DG_GUILD_WAR_RESERVE_DEL:
+		GuildWarReserveDelete(*(DWORD*)c_pData);
+		break;
 
-		case HEADER_DG_CHANGE_MONARCH_LORD_ACK:
-			ChangeMonarchLord((TPacketChangeMonarchLordACK*)c_pData);
-			break;
+	case HEADER_DG_GUILD_WAR_BET:
+		GuildWarBet((TPacketGDGuildWarBet*)c_pData);
+		break;
 
-		case HEADER_DG_UPDATE_MONARCH_INFO:
-			UpdateMonarchInfo((TMonarchInfo*)c_pData);
-			break;
+	case HEADER_DG_MARRIAGE_ADD:
+		MarriageAdd((TPacketMarriageAdd*)c_pData);
+		break;
 
-		case HEADER_DG_BLOCK_COUNTRY_IP:
-			this->AddBlockCountryIp((TPacketBlockCountryIp*)c_pData);
-			break;
-		case HEADER_DG_BLOCK_EXCEPTION:
-			this->BlockException((TPacketBlockException*)c_pData);
-			break;
+	case HEADER_DG_MARRIAGE_UPDATE:
+		MarriageUpdate((TPacketMarriageUpdate*)c_pData);
+		break;
 
-		case HEADER_DG_ACK_CHANGE_GUILD_MASTER:
-			this->GuildChangeMaster((TPacketChangeGuildMaster*)c_pData);
-			break;
+	case HEADER_DG_MARRIAGE_REMOVE:
+		MarriageRemove((TPacketMarriageRemove*)c_pData);
+		break;
 
-		case HEADER_DG_ACK_SPARE_ITEM_ID_RANGE:
-			ITEM_MANAGER::instance().SetMaxSpareItemID(*((TItemIDRangeTable*)c_pData));
-			break;
+	case HEADER_DG_WEDDING_REQUEST:
+		WeddingRequest((TPacketWeddingRequest*)c_pData);
+		break;
 
-		case HEADER_DG_UPDATE_HORSE_NAME:
-		case HEADER_DG_ACK_HORSE_NAME:
-			CHorseNameManager::instance().UpdateHorseName(
-				((TPacketUpdateHorseName*)c_pData)->dwPlayerID,
-				((TPacketUpdateHorseName*)c_pData)->szHorseName);
-			break;
+	case HEADER_DG_WEDDING_READY:
+		WeddingReady((TPacketWeddingReady*)c_pData);
+		break;
 
-		case HEADER_DG_NEED_LOGIN_LOG:
-			DetailLog((TPacketNeedLoginLogInfo*)c_pData);
-			break;
+	case HEADER_DG_WEDDING_START:
+		WeddingStart((TPacketWeddingStart*)c_pData);
+		break;
 
-			//    ׽Ʈ
-		case HEADER_DG_ITEMAWARD_INFORMER:
-			ItemAwardInformer((TPacketItemAwardInfromer*)c_pData);
-			break;
+	case HEADER_DG_WEDDING_END:
+		WeddingEnd((TPacketWeddingEnd*)c_pData);
+		break;
 
-		case HEADER_DG_RESPOND_CHANNELSTATUS:
-			RespondChannelStatus(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
+	// MYSHOP_PRICE_LIST
+	case HEADER_DG_MYSHOP_PRICELIST_RES:
+		MyshopPricelistRes(DESC_MANAGER::instance().FindByHandle(m_dwHandle), (TPacketMyshopPricelistHeader*)c_pData);
+		break;
+	// END_OF_MYSHOP_PRICE_LIST
 
-#if defined(__MOVE_CHANNEL__)
-		case HEADER_DG_CHANNEL_RESULT:
-			MoveChannel(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
-#endif
+	// RELOAD_ADMIN
+	case HEADER_DG_RELOAD_ADMIN:
+		ReloadAdmin(c_pData);
+		break;
+	// END_RELOAD_ADMIN
 
-#if defined(__MAILBOX__)
-		case HEADER_DG_RESPOND_MAILBOX_LOAD:
-			MailBoxRespondLoad(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
+	case HEADER_DG_ADD_MONARCH_MONEY:
+		AddMonarchMoney(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
+		break;
 
-		case HEADER_DG_RESPOND_MAILBOX_CHECK_NAME:
-			MailBoxRespondName(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
+	case HEADER_DG_DEC_MONARCH_MONEY:
+		DecMonarchMoney(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
+		break;
 
-		case HEADER_DG_RESPOND_MAILBOX_UNREAD:
-			MailBoxRespondUnreadData(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
-#endif
+	case HEADER_DG_TAKE_MONARCH_MONEY:
+		TakeMonarchMoney(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
+		break;
 
-#if defined(__GEM_SHOP__)
-		case HEADER_DG_GEM_SHOP_LOAD:
-			GemShopLoad(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
+	case HEADER_DG_CHANGE_MONARCH_LORD_ACK:
+		ChangeMonarchLord((TPacketChangeMonarchLordACK*)c_pData);
+		break;
 
-		case HEADER_DG_GEM_SHOP_UPDATE:
-			GemShopUpdate(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
-#endif
+	case HEADER_DG_UPDATE_MONARCH_INFO:
+		UpdateMonarchInfo((TMonarchInfo*)c_pData);
+		break;
 
-#if defined(__EXPRESSING_EMOTIONS__)
-		case HEADER_DG_EMOTE_LOAD:
-			EmoteLoad(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
+	case HEADER_DG_BLOCK_COUNTRY_IP:
+		this->AddBlockCountryIp((TPacketBlockCountryIp*)c_pData);
+		break;
+	case HEADER_DG_BLOCK_EXCEPTION:
+		this->BlockException((TPacketBlockException*)c_pData);
+		break;
 
-		case HEADER_DG_EMOTE_GET:
-			EmoteGet(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
-#endif
+	case HEADER_DG_ACK_CHANGE_GUILD_MASTER:
+		this->GuildChangeMaster((TPacketChangeGuildMaster*)c_pData);
+		break;
 
-#ifdef __SHOP_SEARCH__
-		case HEADER_DG_SHOP_SEARCH_RESULT:
-		{
-			LPDESC chDesc = DESC_MANAGER::instance().FindByHandle(m_dwHandle);
-			if (!chDesc || !chDesc->GetCharacter())
-				break;
+	case HEADER_DG_ACK_SPARE_ITEM_ID_RANGE:
+		ITEM_MANAGER::instance().SetMaxSpareItemID(*((TItemIDRangeTable*)c_pData));
+		break;
 
-			WORD maxPageNum = *(WORD*)c_pData;
-			c_pData += sizeof(WORD);
-			WORD itemCount = *(WORD*)c_pData;
-			c_pData += sizeof(WORD);
+	case HEADER_DG_UPDATE_HORSE_NAME:
+	case HEADER_DG_ACK_HORSE_NAME:
+		CHorseNameManager::instance().UpdateHorseName(
+			((TPacketUpdateHorseName*)c_pData)->dwPlayerID,
+			((TPacketUpdateHorseName*)c_pData)->szHorseName);
+		break;
 
-			CShopSearchManager::DB_ResultSearch(chDesc->GetCharacter(), maxPageNum, (const TShopSearchClientItem*)c_pData, itemCount);
-		}
+	case HEADER_DG_NEED_LOGIN_LOG:
+		DetailLog((TPacketNeedLoginLogInfo*)c_pData);
 		break;
 
-		case HEADER_DG_SHOP_SEARCH_BUY_FROM_SHOP:
-			CShopSearchManager::DB_BuyFromShop((const TPacketDGShopSearchBuyFromShop*)c_pData);
-			break;
+	//    ׽Ʈ
+	case HEADER_DG_ITEMAWARD_INFORMER:
+		ItemAwardInformer((TPacketItemAwardInfromer*)c_pData);
+		break;
 
-		case HEADER_DG_SHOP_SEARCH_BUY_RESULT:
-			CShopSearchManager::DB_BuyResult(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
+	case HEADER_DG_RESPOND_CHANNELSTATUS:
+		RespondChannelStatus(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
+		break;
 
-		case HEADER_DG_SHOP_SEARCH_SOLD_INFO:
-		{
-			LPDESC chDesc = DESC_MANAGER::instance().FindByHandle(m_dwHandle);
-			if (!chDesc || !chDesc->GetCharacter())
-				break;
+#if defined(__GUILD_DRAGONLAIR_PARTY_SYSTEM__)
+	case HEADER_DG_GUILD_DUNGEON:
+		GuildDungeon(c_pData);
+		break;
 
-			bool hasResults = *(bool*)c_pData;
-			c_pData += sizeof(bool);
+	case HEADER_DG_GUILD_DUNGEON_CD:
+		GuildDungeonCD(c_pData);
+		break;
 
-			CShopSearchManager::DB_SoldInfo(chDesc->GetCharacter(), hasResults, (const TShopSearchSoldItemInfo*)c_pData);
-		}
+	case HEADER_DG_GUILD_DUNGEON_ST:
+		GuildDungeonST(c_pData);
 		break;
 #endif
 
-#ifdef __GROWTH_PET_SYSTEM__
-		case HEADER_DG_GROWTH_PET_LOAD:
-			GrowthPetLoad(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
+#if defined(__MOVE_CHANNEL__)
+	case HEADER_DG_CHANNEL_RESULT:
+		MoveChannel(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
+		break;
 #endif
 
-#ifdef __OFFLINE_SHOP__
-		case HEADER_DG_RESPOND_OFFLINE_SHOP_ID:
-			RespondOfflineShopId(c_pData);
-			break;
+#if defined(__SKILL_COLOR_SYSTEM__)
+	case HEADER_DG_SKILL_COLOR_LOAD:
+		SkillColorLoad(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
+		break;
 #endif
 
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-		case HEADER_DG_EXT_BATTLE_PASS_LOAD:
-			ExtBattlePassLoad(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
-			break;
+#ifdef __GROWTH_PET_SYSTEM__
+	case HEADER_DG_GROWTH_PET_LOAD:
+		GrowthPetLoad(DESC_MANAGER::instance().FindByHandle(m_dwHandle), c_pData);
+		break;
 #endif
 
-		default:
-			return (-1);
+	default:
+		return (-1);
 	}
 
 	return 0;
@@ -2864,7 +2629,7 @@
 	if (ch)
 	{
 		if (number(1, 100) > 95)
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" %s  %u   ֽϴ", EMPIRE_NAME(Empire), CMonarch::instance().GetMoney(Empire)));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" %s  %u   ֽϴ"), EMPIRE_NAME(Empire), CMonarch::instance().GetMoney(Empire));
 	}
 }
 
@@ -2884,7 +2649,7 @@
 
 	if (ch)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" %s  %d   ֽϴ", EMPIRE_NAME(Empire), CMonarch::instance().GetMoney(Empire)));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" %s  %d   ֽϴ"), EMPIRE_NAME(Empire), CMonarch::instance().GetMoney(Empire));
 	}
 }
 
@@ -2905,14 +2670,14 @@
 			return;
 
 		LPCHARACTER ch = d->GetCharacter();
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("  ϰų  ü  ȲԴϴ"));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  ϰų  ü  ȲԴϴ"));
 	}
 }
 
 void CInputDB::ChangeMonarchLord(TPacketChangeMonarchLordACK* info)
 {
 	char notice[256];
-	snprintf(notice, sizeof(notice), LC_STRING("%s ְ %s  üǾϴ.", EMPIRE_NAME(info->bEmpire), info->szName));
+	snprintf(notice, sizeof(notice), LC_TEXT("%s ְ %s  üǾϴ."), EMPIRE_NAME(info->bEmpire), info->szName);
 	SendNotice(notice);
 }
 
@@ -2965,7 +2730,7 @@
 
 		if (d->IsPhase(PHASE_GAME)) // ϶
 		{
-			ch->ChatPacket(CHAT_TYPE_NOTICE, LC_STRING("You have recieved a gift! Check your Item Shop-Storeroom."));
+			ch->ChatPacket(CHAT_TYPE_NOTICE, LC_TEXT("You have recieved a gift! Check your Item Shop-Storeroom."));
 			ch->ChatPacket(CHAT_TYPE_COMMAND, "gift");
 
 			quest::CQuestManager::instance().ItemInformer(ch->GetPlayerID(), ch->GetItemAward_vnum()); // questmanager ȣ
@@ -3008,7 +2773,7 @@
 	if (!p->lAddr || !p->wPort)
 	{
 		std::string pName = d->GetCharacter()->GetName();
-		d->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Cannot change channel."));
+		d->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Cannot change channel."));
 		sys_err("Can't move channel for player %s!", pName.c_str());
 		return;
 	}
@@ -3017,163 +2782,28 @@
 }
 #endif
 
-#if defined(__EXPRESSING_EMOTIONS__)
-void CInputDB::EmoteLoad(LPDESC pDesc, const char* c_pData)
-{
-	if (pDesc == nullptr)
-		return;
-
-	const LPCHARACTER pkChar = pDesc->GetCharacter();
-	if (pkChar == nullptr)
-		return;
-
-	WORD wSize;
-	if (decode_2bytes(c_pData) != sizeof(TPacketGDEmote))
-	{
-		sys_err("emotion table size error");
-		return;
-	}
-
-	c_pData += 2;
-	wSize = decode_2bytes(c_pData);
-	c_pData += 2;
-
-	pkChar->SetEmotes((TPacketGDEmote*)c_pData, wSize);
-}
-
-void CInputDB::EmoteGet(LPDESC pDesc, const char* c_pData)
-{
-	const TPacketGDEmote* pPacket = reinterpret_cast<const TPacketGDEmote*>(c_pData);
-	if (pPacket == nullptr || pDesc == nullptr)
-		return;
-
-	TPacketGCEmote GCPacket;
-	GCPacket.bHeader = HEADER_GC_EMOTE;
-	GCPacket.bSubHeader = SUBHEADER_EMOTE_ADD;
-	GCPacket.dwEmoteVnum = pPacket->dwVnum;
-	GCPacket.dwDuration = pPacket->dwDuration;
-	pDesc->Packet(&GCPacket, sizeof(TPacketGCEmote));
-}
-#endif
-
-#if defined(__MAILBOX__)
-void CInputDB::MailBoxRespondLoad(LPDESC d, const char* c_pData)
-{
-	if (!d)
-		return;
-
-	const LPCHARACTER ch = d->GetCharacter();
-	if (ch == nullptr)
-		return;
-
-	WORD size;
-
-	if (decode_2bytes(c_pData) != sizeof(TMailBoxTable))
-	{
-		sys_err("mailbox table size error");
-		return;
-	}
-
-	c_pData += 2;
-	size = decode_2bytes(c_pData);
-	c_pData += 2;
-
-	CMailBox::Create(ch, (TMailBoxTable*)c_pData, size);
-}
-
-void CInputDB::MailBoxRespondName(LPDESC d, const char* c_pData)
-{
-	if (d == nullptr)
-		return;
-
-	const LPCHARACTER ch = d->GetCharacter();
-	if (ch == nullptr)
-		return;
-
-	CMailBox* mail = ch->GetMailBox();
-	if (mail == nullptr)
-		return;
-
-	mail->CheckPlayerResult((TMailBox*)c_pData);
-}
-
-void CInputDB::MailBoxRespondUnreadData(LPDESC d, const char* c_pData)
-{
-	if (d == nullptr)
-		return;
-
-	CMailBox::ResultUnreadData(d->GetCharacter(), (TMailBoxRespondUnreadData*)c_pData);
-}
-#endif
-
-#if defined(__GEM_SHOP__)
-void CInputDB::GemShopLoad(LPDESC lpDesc, const char* c_pszData)
-{
-	if (!lpDesc)
-		return;
-
-	const LPCHARACTER c_lpCh = lpDesc->GetCharacter();
-	if (c_lpCh == nullptr)
-		return;
-
-	CGemShop::Create(c_lpCh, (TGemShopTable*)c_pszData);
-}
-
-void CInputDB::GemShopUpdate(LPDESC lpDesc, const char* c_pszData)
+#if defined(__GUILD_DRAGONLAIR_PARTY_SYSTEM__)
+void CInputDB::GuildDungeon(const char* c_pData)
 {
-	if (!lpDesc)
-		return;
-
-	const LPCHARACTER c_lpCh = lpDesc->GetCharacter();
-	if (c_lpCh == nullptr)
-		return;
-
-	CGemShop* pGemShop = c_lpCh->GetGemShop();
-	if (pGemShop == nullptr)
-		return;
-
-	pGemShop->Update((TGemShopTable*)c_pszData);
+	TPacketDGGuildDungeon* sPacket = (TPacketDGGuildDungeon*)c_pData;
+	CGuild* pkGuild = CGuildManager::instance().TouchGuild(sPacket->dwGuildID);
+	if (pkGuild)
+		pkGuild->RecvDungeon(sPacket->bChannel, sPacket->lMapIndex);
 }
-#endif
 
-#ifdef __OFFLINE_SHOP__
-void CInputDB::RespondOfflineShopId(const char* data)
+void CInputDB::GuildDungeonCD(const char* c_pData)
 {
-	auto queueId = *reinterpret_cast<const uint32_t*>(data);
-	auto shopId = *reinterpret_cast<const uint32_t*>(data + sizeof(uint32_t));
-
-	COfflineShop::DequeueCreate(queueId, shopId);
+	TPacketDGGuildDungeonCD* sPacket = (TPacketDGGuildDungeonCD*)c_pData;
+	CGuild* pkGuild = CGuildManager::instance().TouchGuild(sPacket->dwGuildID);
+	if (pkGuild)
+		pkGuild->RecvDungeonCD(sPacket->dwTime);
 }
-#endif
 
-#ifdef __GROWTH_PET_SYSTEM__
-void CInputDB::GrowthPetLoad(LPDESC d, const char* c_pData)
+void CInputDB::GuildDungeonST(const char* c_pData)
 {
-	LPCHARACTER ch;
-
-	if (!d || !(ch = d->GetCharacter()))
-		return;
-
-	if (ch->IsGrowthPetLoaded())
-		return;
-
-	DWORD dwCount = decode_4bytes(c_pData);
-	c_pData += sizeof(DWORD);
-
-	sys_log(0, "GROWTH_PET_LOAD: COUNT %s %u", ch->GetName(), dwCount);
-
-	TGrowthPet* p = (TGrowthPet*)c_pData;
-
-	for (DWORD i = 0; i < dwCount; ++i, ++p)
-	{
-		LPGROWTH_PET pPet = CGrowthPetManager::Instance().CreateGrowthPet(ch, p->dwID);
-		if (pPet)
-		{
-			pPet->SetGrowthPetProto(p);
-			ch->SetGrowthPet(pPet);
-		}
-	}
-
-	ch->SetGrowthPetLoaded(true);
+	TPacketDGGuildDungeonST* sPacket = (TPacketDGGuildDungeonST*)c_pData;
+	CGuild* pkGuild = CGuildManager::instance().TouchGuild(sPacket->dwGuildID);
+	if (pkGuild)
+		pkGuild->RecvDungeonST(sPacket->dwDungeon_start);
 }
 #endif
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/input_login.cpp final/server/server/home/metin2/Source/Server/game/src/input_login.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/input_login.cpp	2026-02-17 17:39:40.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/input_login.cpp	2022-04-27 12:36:00.000000000 +0000
@@ -29,18 +29,13 @@
 #include "log.h"
 #include "horsename_manager.h"
 #include "MarkManager.h"
-#if defined(__SNOWFLAKE_STICK_EVENT__)
-#	include "xmas_event.h"
-#endif
-#if defined(__DEFENSE_WAVE__)
-#	include "defense_wave.h"
-#endif
 
-#ifdef __OFFLINE_SHOP__
-#include "OfflineShop.h"
+#if defined(__GUILD_DRAGONLAIR__)
+#include "MeleyLair.h"
 #endif
-#ifdef __GROWTH_PET_SYSTEM__
-	#include "item_manager.h"
+
+#if defined(__MINI_GAME_CATCH_KING__)
+#include "minigame.h"
 #endif
 
 static void _send_bonus_info(LPCHARACTER ch)
@@ -58,22 +53,22 @@
 	if (item_drop_bonus)
 	{
 		ch->ChatPacket(CHAT_TYPE_NOTICE,
-			LC_STRING(" ӷ  %d%% ߰ ̺Ʈ Դϴ.", item_drop_bonus));
+			LC_TEXT(" ӷ  %d%% ߰ ̺Ʈ Դϴ."), item_drop_bonus);
 	}
 	if (gold_drop_bonus)
 	{
 		ch->ChatPacket(CHAT_TYPE_NOTICE,
-			LC_STRING(" ӷ %d%% ߰ ̺Ʈ Դϴ.", gold_drop_bonus));
+			LC_TEXT(" ӷ %d%% ߰ ̺Ʈ Դϴ."), gold_drop_bonus);
 	}
 	if (gold10_drop_bonus)
 	{
 		ch->ChatPacket(CHAT_TYPE_NOTICE,
-			LC_STRING("ڰ ӷ %d%% ߰ ̺Ʈ Դϴ.", gold10_drop_bonus));
+			LC_TEXT("ڰ ӷ %d%% ߰ ̺Ʈ Դϴ."), gold10_drop_bonus);
 	}
 	if (exp_bonus)
 	{
 		ch->ChatPacket(CHAT_TYPE_NOTICE,
-			LC_STRING("ġ %d%% ߰ ȹ ̺Ʈ Դϴ.", exp_bonus));
+			LC_TEXT("ġ %d%% ߰ ȹ ̺Ʈ Դϴ."), exp_bonus);
 	}
 }
 
@@ -81,14 +76,14 @@
 {
 	switch (ch->GetMapIndex())
 	{
-		case 1: // ż 1 
-		case 2: // ż 2 
-		case 21: // õ 1 
-		case 23: // õ 2 
-		case 41: //  1 
-		case 43: //  2 
-		case 113: // OX 
-			return false;
+	case 1: // ż 1 
+	case 2: // ż 2 
+	case 21: // õ 1 
+	case 23: // õ 2 
+	case 41: //  1 
+	case 43: //  2 
+	case 113: // OX 
+		return false;
 	}
 
 	return true;
@@ -259,11 +254,7 @@
 void CInputLogin::CharacterSelect(LPDESC d, const char* data)
 {
 	struct command_player_select* pinfo = (struct command_player_select*)data;
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-	TAccountTable& c_r = d->GetAccountTable();
-#else
 	const TAccountTable& c_r = d->GetAccountTable();
-#endif
 
 	sys_log(0, "player_select: login: %s index: %d", c_r.login, pinfo->index);
 
@@ -292,25 +283,6 @@
 		return;
 	}
 
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-	if (!LocaleService_GetLocale(pinfo->country))
-	{
-		sys_err("cannot find locale country %s, login %s, name %s",
-			pinfo->country, c_r.login, c_r.players[pinfo->index].szName);
-		return;
-	}
-
-	if (strcmp(c_r.country, pinfo->country))
-	{
-		thecore_memcpy(c_r.country, pinfo->country, sizeof(c_r.country));
-
-		char query[128];
-		snprintf(query, sizeof(query), "UPDATE `account`.`account` SET `country` = '%s' WHERE `id` = %u",
-			LocaleService_GetCountry(pinfo->country), c_r.id);
-		std::unique_ptr<SQLMsg> msg(DBManager::instance().DirectQuery(query));
-	}
-#endif
-
 	TPlayerLoadPacket player_load_packet;
 
 	player_load_packet.account_id = c_r.id;
@@ -383,7 +355,7 @@
 	return true;
 }
 
-bool RaceToJob(BYTE race, BYTE* ret_job)
+bool RaceToJob(unsigned race, unsigned* ret_job)
 {
 	*ret_job = 0;
 
@@ -392,51 +364,51 @@
 
 	switch (race)
 	{
-		case MAIN_RACE_WARRIOR_M:
-			*ret_job = JOB_WARRIOR;
-			break;
-
-		case MAIN_RACE_WARRIOR_W:
-			*ret_job = JOB_WARRIOR;
-			break;
-
-		case MAIN_RACE_ASSASSIN_M:
-			*ret_job = JOB_ASSASSIN;
-			break;
-
-		case MAIN_RACE_ASSASSIN_W:
-			*ret_job = JOB_ASSASSIN;
-			break;
-
-		case MAIN_RACE_SURA_M:
-			*ret_job = JOB_SURA;
-			break;
-
-		case MAIN_RACE_SURA_W:
-			*ret_job = JOB_SURA;
-			break;
-
-		case MAIN_RACE_SHAMAN_M:
-			*ret_job = JOB_SHAMAN;
-			break;
-
-		case MAIN_RACE_SHAMAN_W:
-			*ret_job = JOB_SHAMAN;
-			break;
-
-		case MAIN_RACE_WOLFMAN_M:
-			*ret_job = JOB_WOLFMAN;
-			break;
-
-		default:
-			return false;
-			break;
+	case MAIN_RACE_WARRIOR_M:
+		*ret_job = JOB_WARRIOR;
+		break;
+
+	case MAIN_RACE_WARRIOR_W:
+		*ret_job = JOB_WARRIOR;
+		break;
+
+	case MAIN_RACE_ASSASSIN_M:
+		*ret_job = JOB_ASSASSIN;
+		break;
+
+	case MAIN_RACE_ASSASSIN_W:
+		*ret_job = JOB_ASSASSIN;
+		break;
+
+	case MAIN_RACE_SURA_M:
+		*ret_job = JOB_SURA;
+		break;
+
+	case MAIN_RACE_SURA_W:
+		*ret_job = JOB_SURA;
+		break;
+
+	case MAIN_RACE_SHAMAN_M:
+		*ret_job = JOB_SHAMAN;
+		break;
+
+	case MAIN_RACE_SHAMAN_W:
+		*ret_job = JOB_SHAMAN;
+		break;
+
+	case MAIN_RACE_WOLFMAN_M:
+		*ret_job = JOB_WOLFMAN;
+		break;
+
+	default:
+		return false;
+		break;
 	}
 	return true;
 }
 
 // ű ĳ 
-bool NewPlayerTable2(TPlayerTable* table, const char* name, BYTE race, BYTE shape, BYTE bEmpire)
+bool NewPlayerTable2(TPlayerTable* table, const char* name, BYTE race, BYTE shape, BYTE bEmpire, const char* pin)
 {
 	if (race >= MAIN_RACE_MAX_NUM)
 	{
@@ -444,7 +416,8 @@
 		return false;
 	}
 
-	BYTE job;
+	unsigned job;
+
 	if (!RaceToJob(race, &job))
 	{
 		sys_err("NewPlayerTable2.RACE_TO_JOB_ERROR(%d)\n", race);
@@ -481,6 +454,8 @@
 
 	table->skill_group = 0;
 
+	strlcpy(table->pin, pin, sizeof(table->pin));
+
 	return true;
 }
 
@@ -549,7 +524,7 @@
 
 	memset(&player_create_packet, 0, sizeof(TPlayerCreatePacket));
 
-	if (!NewPlayerTable2(&player_create_packet.player_table, pinfo->name, pinfo->job, pinfo->shape, d->GetEmpire()))
+	if (!NewPlayerTable2(&player_create_packet.player_table, pinfo->name, pinfo->job, pinfo->shape, d->GetEmpire(), pinfo->pin))
 	{
 		sys_err("player_prototype error: job %d face %d ", pinfo->job);
 		d->Packet(&packFailure, sizeof(packFailure));
@@ -609,6 +584,77 @@
 	db_clientdesc->DBPacket(HEADER_GD_PLAYER_DELETE, d->GetHandle(), &player_delete_packet, sizeof(TPlayerDeletePacket));
 }
 
+void CInputLogin::CharacterPinCode(LPDESC d, const char* c_pData)
+{
+	const TPacketCGCharacterPinCode& CharacterPinCodeCGPacket = *((TPacketCGCharacterPinCode*)c_pData);
+	const TAccountTable& c_rAccountTable = d->GetAccountTable();
+
+	if (!c_rAccountTable.id)
+	{
+		sys_err("PlayerPinCode: no login data");
+		return;
+	}
+
+	sys_log(0, "PlayerPinCode: login: %s index: %d, pin %s", c_rAccountTable.login, CharacterPinCodeCGPacket.bIndex, CharacterPinCodeCGPacket.szPinCode);
+
+	if (CharacterPinCodeCGPacket.bIndex >= PLAYER_PER_ACCOUNT || CharacterPinCodeCGPacket.bIndex < 0)
+	{
+		sys_err("PlayerPinCode: index overflow %d, login: %s", CharacterPinCodeCGPacket.bIndex, c_rAccountTable.login);
+		return;
+	}
+
+	if (!c_rAccountTable.players[CharacterPinCodeCGPacket.bIndex].dwID)
+	{
+		sys_err("PlayerPinCode: no player id, login %s", c_rAccountTable.login);
+		return;
+	}
+
+	TPacketGCCharacterPinCode CharacterPinCodeGCPacket;
+	CharacterPinCodeGCPacket.bHeader = HEADER_GC_PLAYER_PIN_CODE;
+	if (strcmp(c_rAccountTable.players[CharacterPinCodeCGPacket.bIndex].szPinCode, CharacterPinCodeCGPacket.szPinCode) != 0)
+	{
+		sys_log(0, "PlayerPinCode: failed cached pin: %s - %s", c_rAccountTable.players[CharacterPinCodeCGPacket.bIndex].szPinCode, CharacterPinCodeCGPacket.szPinCode);
+
+		char szPinCode[PIN_CODE_LENGTH + 1] = {};
+		// PLAYER_PIN_CODE_RESULT
+		{
+			char szQuery[128];
+			snprintf(szQuery, sizeof(szQuery), "SELECT `pin` FROM `player`.`player` WHERE `id` = %u AND `account_id` = %u", c_rAccountTable.players[CharacterPinCodeCGPacket.bIndex].dwID, c_rAccountTable.id);
+			std::unique_ptr<SQLMsg> pMsg(DBManager::instance().DirectQuery(szQuery));
+			if (pMsg->Get()->uiNumRows > 0)
+			{
+				MYSQL_ROW row = mysql_fetch_row(pMsg->Get()->pSQLResult);
+				strlcpy(szPinCode, row[0], sizeof(szPinCode));
+			}
+		}
+		// END_OF_PLAYER_PIN_CODE_RESULT
+
+		if (strcmp(CharacterPinCodeCGPacket.szPinCode, szPinCode) != 0)
+		{
+			CharacterPinCodeGCPacket.bValid = false;
+			d->DelayedDisconnect(3);
+		}
+		else
+		{
+			CharacterPinCodeGCPacket.bValid = true;
+		}
+	}
+	else
+	{
+		CharacterPinCodeGCPacket.bValid = true;
+	}
+
+	if (CharacterPinCodeGCPacket.bValid == true)
+	{
+		char szQuery[128];
+		snprintf(szQuery, sizeof(szQuery), "UPDATE `account`.`hwid` SET `valid%d` = 1 WHERE `account_id` = %u",
+			CharacterPinCodeCGPacket.bIndex + 1, c_rAccountTable.id);
+		std::unique_ptr<SQLMsg> pMsg(DBManager::instance().DirectQuery(szQuery));
+	}
+
+	d->Packet(&CharacterPinCodeGCPacket, sizeof(TPacketGCCharacterPinCode));
+}
+
 #pragma pack(1)
 typedef struct SPacketGTLogin
 {
@@ -628,12 +674,8 @@
 		return;
 	}
 
-	// Hardening: never allow observer mode to persist across logins (e.g. Alt+F4 while observing).
-	if (ch->IsObserverMode())
-		ch->SetObserverMode(false);
-	ch->SetArenaObserverMode(false);
-
 	PIXEL_POSITION pos = ch->GetXYZ();
+
 	if (!SECTREE_MANAGER::instance().GetMovablePosition(ch->GetMapIndex(), pos.x, pos.y, pos))
 	{
 		PIXEL_POSITION pos2;
@@ -649,9 +691,8 @@
 
 	CGuildManager::instance().LoginMember(ch);
 
-	// ĳ͸ ʿ ߰
+	// ĳ͸ ʿ ߰ 
 	ch->Show(ch->GetMapIndex(), pos.x, pos.y, pos.z);
-	ch->ReviveInvisible(5);
 
 #if !defined(__BINARY_ATLAS_MARK_INFO__)
 	SECTREE_MANAGER::instance().SendNPCPosition(ch);
@@ -660,32 +701,82 @@
 	d->SetPhase(PHASE_GAME);
 
 #if defined(__HIDE_COSTUME_SYSTEM__)
-	ch->SetHiddenCostumeParts();
+	if (ch->GetQuestFlag("costume_option.hide_body") != 0)
+		ch->SetBodyCostumeHidden(true);
+	else
+		ch->SetBodyCostumeHidden(false);
+
+	if (ch->GetQuestFlag("costume_option.hide_hair") != 0)
+		ch->SetHairCostumeHidden(true);
+	else
+		ch->SetHairCostumeHidden(false);
+
+#if defined(__ACCE_COSTUME_SYSTEM__)
+	if (ch->GetQuestFlag("costume_option.hide_acce") != 0)
+		ch->SetAcceCostumeHidden(true);
+	else
+		ch->SetAcceCostumeHidden(false);
 #endif
 
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-	const LPITEM& rkCostumeMount = ch->GetWear(WEAR_COSTUME_MOUNT);
-	if (rkCostumeMount)
-		ch->MountVnum(rkCostumeMount->GetMountVnum());
-	else if (ch->GetHorseLevel() > 0)
-		ch->EnterHorse();
-#else
-	if (ch->GetHorseLevel() > 0)
-		ch->EnterHorse();
+#if defined(__WEAPON_COSTUME_SYSTEM__)
+	if (ch->GetQuestFlag("costume_option.hide_weapon") != 0)
+		ch->SetWeaponCostumeHidden(true);
+	else
+		ch->SetWeaponCostumeHidden(false);
+#endif
+#endif
+
+#if defined(__EXPRESSING_EMOTIONS__)
+	{
+		ch->ChatPacket(CHAT_TYPE_COMMAND, "ClearSpecialEmotions");
+		for (int iActionID = 60; iActionID < 78; ++iActionID)
+		{
+			char szQuestFlag[20] = "0";
+			snprintf(szQuestFlag, sizeof(szQuestFlag), "emotions.expire_%d", iActionID);
+
+			DWORD dwExpireTime = ch->GetQuestFlag(szQuestFlag);
+			if (dwExpireTime != 0 && dwExpireTime > get_global_time())
+				ch->ChatPacket(CHAT_TYPE_COMMAND, "RegisterSpecialEmotion %d %d 0", iActionID, dwExpireTime);
+		}
+	}
 #endif
 
+	if (ch->affectInfo)
+	{
+		ch->LoadAffect(ch->affectInfo->count, (TPacketAffectElement*)ch->affectInfo->data);
+		M2_DELETE_ARRAY(ch->affectInfo->data);
+		M2_DELETE(ch->affectInfo);
+
+		ch->affectInfo = NULL;
+	}
+
+	if (ch->IsGM() && ch->IsAffectFlag(AFF_INVISIBILITY) && !test_server)
+	{
+		ch->SetObserverMode(true);
+	}
+
+	ch->Show(ch->GetMapIndex(), pos.x, pos.y, pos.z);
+
 	if (ch->GetItemAward_cmd()[0] != '\0') //  
 		quest::CQuestManager::instance().ItemInformer(ch->GetPlayerID(), ch->GetItemAward_vnum()); // questmanager ȣ
 
 	sys_log(0, "ENTERGAME: %s %dx%dx%d %s map_index %d",
 		ch->GetName(), ch->GetX(), ch->GetY(), ch->GetZ(), d->GetHostName(), ch->GetMapIndex());
 
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	ch->SendExtendInvenPacket();
-#endif
+	if (ch->GetHorseLevel() > 0)
+	{
+		ch->EnterHorse();
+	}
 
-	// Check unwanted quickslot items.
-	ch->CheckQuickSlotItems();
+#if defined(__MOUNT_COSTUME_SYSTEM__)
+	LPITEM pCostumeMount = ch->GetWear(WEAR_COSTUME_MOUNT);
+	if (pCostumeMount)
+	{
+		DWORD dwMountVnum = pCostumeMount->GetMountVnum();
+		if (dwMountVnum > 0)
+			ch->MountVnum(dwMountVnum);
+	}
+#endif
 
 	// ÷̽ð ڵ 
 	ch->ResetPlayTime();
@@ -699,7 +790,7 @@
 	CPVPManager::instance().Connect(ch);
 	CPVPManager::instance().SendList(d);
 
-	CMessengerManager::instance().Login(ch->GetName());
+	MessengerManager::instance().Login(ch->GetName());
 
 	CPartyManager::instance().SetParty(ch);
 	CGuildManager::instance().SendGuildWar(ch);
@@ -707,17 +798,9 @@
 	building::CManager::instance().SendLandList(d, ch->GetMapIndex());
 
 	marriage::CManager::instance().Login(ch);
-
-#ifdef __OFFLINE_SHOP__
-	COfflineShop::Login(ch);
-#endif
-
-#if defined(__EXPRESSING_EMOTIONS__)
-	TPacketGDEmote GDPacket = {};
-	GDPacket.dwPID = ch->GetPlayerID();
-	db_clientdesc->DBPacket(HEADER_GD_EMOTE_LOAD, ch->GetDesc()->GetHandle(), &GDPacket, sizeof(GDPacket));
+#ifdef __GROWTH_PET_SYSTEM__
+	ch->SendDeadPetMessage();
 #endif
-
 	TPacketGCTime p;
 	p.bHeader = HEADER_GC_TIME;
 	p.time = get_global_time();
@@ -728,23 +811,22 @@
 	p2.channel = g_bChannel;
 	d->Packet(&p2, sizeof(p2));
 
-#if defined(__LOOT_FILTER_SYSTEM__) && !defined(__PREMIUM_LOOT_FILTER__)
-	ch->SetLootFilter();
-#endif
-
+	ch->SendGreetMessage();
 #if defined(__MAILBOX__)
 	CMailBox::UnreadData(ch);
 #endif
 
-	ch->SendGreetMessage();
+	ch->ReviveInvisible(5);
+#if defined(__CONQUEROR_LEVEL__)
+	ch->SetSungMaWill();
+#endif
+
 	_send_bonus_info(ch);
 
 	std::unique_ptr<SQLMsg> pMsg(DBManager::instance().DirectQuery("UPDATE player%s SET `last_play` = NOW() WHERE `name` = '%s'",
 		get_table_postfix(), ch->GetName())
 	);
 
-	ch->LoadSafeboxBuff();
-
 	for (int i = 0; i <= PREMIUM_MAX_NUM; ++i)
 	{
 		int remain = ch->GetPremiumRemainSeconds(i);
@@ -752,25 +834,9 @@
 		if (remain <= 0)
 			continue;
 
-#if defined(__CONQUEROR_LEVEL__)
-		int idx = AFFECT_PREMIUM_START + i;
-		if (idx == AFFECT_SUNGMA_BONUS)
-		{
-			for (int affect = POINT_SUNGMA_STR; affect <= POINT_SUNGMA_IMMUNE; ++affect)
-				ch->AddAffect(idx, affect, 10, 0, remain, 0, true, true);
-		}
-		else
-			ch->AddAffect(idx, POINT_NONE, 0, 0, remain, 0, true);
-#else
 		ch->AddAffect(AFFECT_PREMIUM_START + i, POINT_NONE, 0, 0, remain, 0, true);
-#endif
 		sys_log(0, "PREMIUM: %s type %d %dmin", ch->GetName(), i, remain);
 	}
-#ifdef __OFFLINE_SHOP__
-	int remainBuy = ch->GetQuestFlag("decoration.limit_time") - get_global_time();
-	if (remainBuy > 0)
-		ch->AddAffect(AFFECT_OFFLINE_SHOP_DECORATION, POINT_NONE, 0, 0, remainBuy, 0, true);
-#endif
 
 	if (g_bCheckClientVersion)
 	{
@@ -784,7 +850,7 @@
 		{
 			if (0 != g_stClientVersion.compare(d->GetClientVersion()))
 			{
-				ch->ChatPacket(CHAT_TYPE_NOTICE, LC_STRING("Ŭ̾Ʈ  Ʋ α׾ƿ ˴ϴ.  ġ  ϼ."));
+				ch->ChatPacket(CHAT_TYPE_NOTICE, LC_TEXT("Ŭ̾Ʈ  Ʋ α׾ƿ ˴ϴ.  ġ  ϼ."));
 				d->DelayedDisconnect(0);
 				LogManager::instance().HackLog("VERSION_CONFLICT", ch);
 
@@ -805,50 +871,22 @@
 	if (ch->IsGM() == true)
 		ch->ChatPacket(CHAT_TYPE_COMMAND, "ConsoleEnable");
 
-#if defined(__POPUP_NOTICE__)
-	if (quest::CQuestManager::instance().GetEventFlag("PopupNoticeEventFlag") > 0)
-	{
-		ch->ChatPacket(CHAT_TYPE_COMMAND, "PopupNoticeProcess %d %s",
-			ch->GetQuestFlag("popup_notice.checkbox"), g_strWebPopupNoticeURL.c_str());
-	}
-#endif
-
-#if defined(__MOVE_CHANNEL__)
-	ch->ChatPacket(CHAT_TYPE_COMMAND, "server_info %d %d", g_bChannel, ch->GetMapIndex());
-#endif
-
-#if defined(__SNOWFLAKE_STICK_EVENT__)
-	CSnowflakeStickEvent::EnterGame(ch);
-#endif
-
 	if (ch->GetMapIndex() >= 10000)
 	{
 		if (CWarMapManager::instance().IsWarMap(ch->GetMapIndex()))
-		{
 			ch->SetWarMap(CWarMapManager::instance().Find(ch->GetMapIndex()));
-		}
 		else if (marriage::WeddingManager::instance().IsWeddingMap(ch->GetMapIndex()))
-		{
 			ch->SetWeddingMap(marriage::WeddingManager::instance().Find(ch->GetMapIndex()));
-		}
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-		else if (CGuildDragonLairManager::Instance().IsRedDragonLair(ch->GetMapIndex()))
-		{
-			ch->SetGuildDragonLair(CGuildDragonLairManager::Instance().FindByMapIndex(ch->GetMapIndex()));
-		}
-#endif
-#if defined(__DEFENSE_WAVE__)
-		else if (CDefenseWaveManager::instance().IsDefenseWaveMap(ch->GetMapIndex()))
-		{
-			ch->SetDefenseWave(CDefenseWaveManager::instance().FindByMapIndex(ch->GetMapIndex()));
-		}
+#if defined(__GUILD_DRAGONLAIR__)
+		else if (MeleyLair::CMgr::instance().IsMeleyMap(ch->GetMapIndex()))
+			MeleyLair::CMgr::instance().Leave(ch->GetGuild(), ch, true);
 #endif
 		else
 		{
 			ch->SetDungeon(CDungeonManager::instance().FindByMapIndex(ch->GetMapIndex()));
 		}
 	}
-	else if (CArenaManager::instance().IsArenaMap(ch->GetMapIndex()))
+	else if (CArenaManager::instance().IsArenaMap(ch->GetMapIndex()) == true)
 	{
 		int memberFlag = CArenaManager::instance().IsMember(ch->GetMapIndex(), ch->GetPlayerID());
 		if (memberFlag == MEMBER_OBSERVER)
@@ -860,15 +898,11 @@
 				sys_log(0, "ARENA : Observer add failed");
 			}
 
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-			ch->UnMount(ch);
-#else
 			if (ch->IsHorseRiding() == true)
 			{
 				ch->StopRiding();
 				ch->HorseSummon(false);
 			}
-#endif
 		}
 		else if (memberFlag == MEMBER_DUELIST)
 		{
@@ -878,15 +912,11 @@
 
 			ch->GetDesc()->Packet(&duelStart, sizeof(TPacketGCDuelStart));
 
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-			ch->UnMount(ch);
-#else
 			if (ch->IsHorseRiding() == true)
 			{
 				ch->StopRiding();
 				ch->HorseSummon(false);
 			}
-#endif
 
 			LPPARTY pParty = ch->GetParty();
 			if (pParty != NULL)
@@ -913,7 +943,7 @@
 		}
 		*/
 	}
-	else if (ch->GetMapIndex() == MAP_OXEVENT)
+	else if (ch->GetMapIndex() == 113)
 	{
 		// ox ̺Ʈ 
 		if (COXEventManager::instance().Enter(ch) == false)
@@ -923,12 +953,6 @@
 				ch->WarpSet(EMPIRE_START_X(ch->GetEmpire()), EMPIRE_START_Y(ch->GetEmpire()));
 		}
 	}
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-	else if (ch->GetMapIndex() == MAP_N_FLAME_DRAGON)
-	{
-		CGuildDragonLairManager::Instance().Exit(ch);
-	}
-#endif
 	else
 	{
 		if (CWarMapManager::instance().IsWarMap(ch->GetMapIndex()) ||
@@ -937,13 +961,6 @@
 			if (!test_server)
 				ch->WarpSet(EMPIRE_START_X(ch->GetEmpire()), EMPIRE_START_Y(ch->GetEmpire()));
 		}
-
-#if defined(__ELEMENTAL_DUNGEON__)
-		if (ch->GetMapIndex() == MAP_ELEMENTAL_04)
-			ch->StartElementalCurseEvent();
-		else
-			ch->StopElementalCurseEvent();
-#endif
 	}
 
 	if (ch->GetHorseLevel() > 0)
@@ -963,32 +980,23 @@
 	{
 		if (FN_is_battle_zone(ch))
 		{
-			ch->ChatPacket(CHAT_TYPE_NOTICE, LC_STRING(" ʿ     ֽϴ."));
-			ch->ChatPacket(CHAT_TYPE_NOTICE, LC_STRING(" ׿  "));
-			ch->ChatPacket(CHAT_TYPE_NOTICE, LC_STRING(" ּ  μ ưñ ٶϴ."));
-		}
-	}
-#ifdef __GROWTH_PET_SYSTEM__
-	if (!IS_BLOCKED_PET(ch->GetMapIndex()))
-	{
-		DWORD growthPetID = ch->GetQuestFlag("system.grow_pet_summoned");
-		if (growthPetID)
-		{
-			LPITEM petSeal = ITEM_MANAGER::instance().Find(growthPetID);
-			if (petSeal && petSeal->GetType() == ITEM_PET && petSeal->GetSubType() == PET_UPBRINGING)
-			{
-				LPGROWTH_PET pPet = ch->GetGrowthPet(petSeal->GetSocket(2));
-				if (pPet)
-				{
-					if (!ch->GetActiveGrowthPet())
-					{
-						LPGROWTH_PET pkPet = pPet->Summon(petSeal);
-						ch->SetActiveGrowthPet(pkPet);
-					}
-				}
-			}
+			ch->ChatPacket(CHAT_TYPE_NOTICE, LC_TEXT(" ʿ     ֽϴ."));
+			ch->ChatPacket(CHAT_TYPE_NOTICE, LC_TEXT(" ׿  "));
+			ch->ChatPacket(CHAT_TYPE_NOTICE, LC_TEXT(" ּ  μ ưñ ٶϴ."));
 		}
 	}
+
+#if defined(__MINI_GAME_CATCH_KING__)
+	CMiniGameManager::instance().MiniGameCatchKingEventInfo(ch);
+#endif
+
+#if defined(__MOUNT_COSTUME_SYSTEM__)
+	if (IS_BLOCKED_MOUNT_SUMMON_MAP(ch->GetMapIndex()) || IS_BLOCKED_MOUNT_SUMMON_MAP(ch->GetMapIndex()))
+		ch->UnMount(true);
+#endif
+
+#if defined(__MOVE_CHANNEL__)
+	ch->ChatPacket(CHAT_TYPE_COMMAND, "ChannelInfo %d %d", g_bChannel, ch->GetMapIndex());
 #endif
 }
 
@@ -1164,7 +1172,7 @@
 	DWORD blockCount = 0;
 	TEMP_BUFFER buf(1024 * 1024); // 1M 
 
-	for (auto it = mapDiffBlocks.begin(); it != mapDiffBlocks.end(); ++it)
+	for (itertype(mapDiffBlocks) it = mapDiffBlocks.begin(); it != mapDiffBlocks.end(); ++it)
 	{
 		BYTE posBlock = it->first;
 		const SGuildMarkBlock& rkBlock = *it->second;
@@ -1200,97 +1208,107 @@
 
 	switch (bHeader)
 	{
-		case HEADER_CG_PONG:
-			Pong(d);
-			break;
-
-		case HEADER_CG_TIME_SYNC:
-			Handshake(d, c_pData);
-			break;
-
-		case HEADER_CG_LOGIN:
-			Login(d, c_pData);
-			break;
-
-		case HEADER_CG_LOGIN2:
-			LoginByKey(d, c_pData);
-			break;
-
-		case HEADER_CG_CHARACTER_SELECT:
-			CharacterSelect(d, c_pData);
-			break;
-
-		case HEADER_CG_CHARACTER_CREATE:
-			CharacterCreate(d, c_pData);
-			break;
-
-		case HEADER_CG_CHARACTER_DELETE:
-			CharacterDelete(d, c_pData);
-			break;
-
-		case HEADER_CG_ENTERGAME:
-			Entergame(d, c_pData);
-			break;
-
-		case HEADER_CG_EMPIRE:
-			Empire(d, c_pData);
-			break;
-
-		case HEADER_CG_MOVE:
-		case HEADER_CG_ITEM_USE:
-		case HEADER_CG_TARGET:
-			break;
-
-			///////////////////////////////////////
-			// Guild Mark
-			/////////////////////////////////////
-		case HEADER_CG_MARK_LOGIN:
-			break;
-
-		case HEADER_CG_MARK_CRCLIST:
-			GuildMarkCRCList(d, c_pData);
-			break;
-
-		case HEADER_CG_MARK_IDXLIST:
-			GuildMarkIDXList(d, c_pData);
-			break;
-
-		case HEADER_CG_MARK_UPLOAD:
-			GuildMarkUpload(d, c_pData);
-			break;
-
-			//////////////////////////////////////
-			// Guild Symbol
-			/////////////////////////////////////
-		case HEADER_CG_GUILD_SYMBOL_UPLOAD:
-			if ((iExtraLen = GuildSymbolUpload(d, c_pData, m_iBufferLeft)) < 0)
-				return -1;
-			break;
-
-		case HEADER_CG_SYMBOL_CRC:
-			GuildSymbolCRC(d, c_pData);
-			break;
-			/////////////////////////////////////
-
-		case HEADER_CG_HACK:
-			break;
-
-		case HEADER_CG_CHANGE_NAME:
-			ChangeName(d, c_pData);
-			break;
-
-		case HEADER_CG_CLIENT_VERSION:
-			Version(d->GetCharacter(), c_pData);
-			break;
-
-		case HEADER_CG_CLIENT_VERSION2:
-			Version(d->GetCharacter(), c_pData);
-			break;
-
-		default:
-			sys_err("login phase does not handle this packet! header %d", bHeader);
-			//d->SetPhase(PHASE_CLOSE);
-			return (0);
+	case HEADER_CG_PONG:
+		Pong(d);
+		break;
+
+	case HEADER_CG_TIME_SYNC:
+		Handshake(d, c_pData);
+		break;
+
+	case HEADER_CG_LOGIN:
+		Login(d, c_pData);
+		break;
+
+	case HEADER_CG_LOGIN2:
+		LoginByKey(d, c_pData);
+		break;
+
+	case HEADER_CG_CHARACTER_SELECT:
+		CharacterSelect(d, c_pData);
+		break;
+
+	case HEADER_CG_CHARACTER_CREATE:
+		CharacterCreate(d, c_pData);
+		break;
+
+	case HEADER_CG_CHARACTER_DELETE:
+		CharacterDelete(d, c_pData);
+		break;
+
+	case HEADER_CG_ENTERGAME:
+		Entergame(d, c_pData);
+		break;
+
+	case HEADER_CG_EMPIRE:
+		Empire(d, c_pData);
+		break;
+
+	case HEADER_CG_MOVE:
+	case HEADER_CG_ITEM_USE:
+	case HEADER_CG_TARGET:
+		break;
+
+		///////////////////////////////////////
+		// Guild Mark
+		/////////////////////////////////////
+	case HEADER_CG_MARK_CRCLIST:
+		GuildMarkCRCList(d, c_pData);
+		break;
+
+	case HEADER_CG_MARK_IDXLIST:
+		GuildMarkIDXList(d, c_pData);
+		break;
+
+	case HEADER_CG_MARK_UPLOAD:
+		GuildMarkUpload(d, c_pData);
+		break;
+
+		//////////////////////////////////////
+		// Guild Symbol
+		/////////////////////////////////////
+	case HEADER_CG_GUILD_SYMBOL_UPLOAD:
+		if ((iExtraLen = GuildSymbolUpload(d, c_pData, m_iBufferLeft)) < 0)
+			return -1;
+		break;
+
+	case HEADER_CG_SYMBOL_CRC:
+		GuildSymbolCRC(d, c_pData);
+		break;
+		/////////////////////////////////////
+
+	case HEADER_CG_HACK:
+		break;
+
+	case HEADER_CG_CHANGE_NAME:
+		ChangeName(d, c_pData);
+		break;
+
+	case HEADER_CG_CLIENT_VERSION:
+		Version(d->GetCharacter(), c_pData);
+		break;
+
+	case HEADER_CG_CLIENT_VERSION2:
+		Version(d->GetCharacter(), c_pData);
+		break;
+
+	case HEADER_CG_PLAYER_PIN_CODE:
+		CharacterPinCode(d, c_pData);
+		break;
+		
+#ifdef __GROWTH_PET_SYSTEM__
+	/*
+		This packet is sent at python window initialization. No need
+		to update anything.
+	*/
+	case HEADER_CG_PET_WINDOW_TYPE:
+		break;
+#endif
+
+	default:
+		sys_err("login phase does not handle this packet! header %d", bHeader);
+		//d->SetPhase(PHASE_CLOSE);
+		return (0);
 	}
 
 	return (iExtraLen);
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/input_main.cpp final/server/server/home/metin2/Source/Server/game/src/input_main.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/input_main.cpp	2026-02-18 17:49:44.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/input_main.cpp	2026-02-20 18:05:02.527702682 +0000
@@ -1,5 +1,4 @@
 #include "stdafx.h"
-#include <cstring>
 #include "constants.h"
 #include "config.h"
 #include "utils.h"
@@ -12,9 +11,6 @@
 #include "char_manager.h"
 #include "item.h"
 #include "item_manager.h"
-#ifdef ENABLE_QUEEN_NETHIS
-#include "SnakeLair.h"
-#endif
 #include "cmd.h"
 #include "shop.h"
 #include "shop_manager.h"
@@ -45,42 +41,32 @@
 #include "DragonSoul.h"
 #include "belt_inventory_helper.h"
 
-#if defined(__LOOT_FILTER_SYSTEM__)
-#	include "LootFilter.h"
-#endif
-#if defined(__SNOWFLAKE_STICK_EVENT__)
-#	include "xmas_event.h"
-#endif
-
-#if defined(__DEFENSE_WAVE__)
-#	include "defense_wave.h"
-#endif
-
-#if defined(__OFFLINE_SHOP__)
-#include "OfflineShop.h"
+#if defined(__MINI_GAME_CATCH_KING__)
+#include "minigame.h"
 #endif
 
-#if defined(__SHOP_SEARCH__)
-	#include "ShopSearchManager.h"
+#if defined(__SKILLBOOK_COMB_SYSTEM__)
+#include <random>
 #endif
 
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-#include "battlepass_manager.h"
+#if defined(__PRIVATE_SHOP_SEARCH_SYSTEM__)
+#include "entity.h"
+#include <unordered_map>
+bool CompareItemVnumAcPriceAC(COfflineShop::OFFLINE_SHOP_ITEM i, COfflineShop::OFFLINE_SHOP_ITEM j)
+{
+	return (i.vnum < j.vnum) && (i.price < j.price);
+}
 #endif
 
 #ifdef __GROWTH_PET_SYSTEM__
 #include "growth_pet.h"
 #endif
 
-extern void SendShout(const char* szText, BYTE bEmpire
 #if defined(__MESSENGER_BLOCK_SYSTEM__)
-	, const char* c_szName
-#endif
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-	, const char* c_szCountry
+extern void SendShout(const char* szText, const char* c_szName, BYTE bEmpire);
+#else
+extern void SendShout(const char* szText, BYTE bEmpire);
 #endif
-);
-
 extern int g_nPortalLimitTime;
 
 static int __deposit_limit()
@@ -92,7 +78,7 @@
 {
 	if (sec <= 0)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ä  Դϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ä  Դϴ."));
 		return;
 	}
 
@@ -102,14 +88,16 @@
 	long min = (sec / 60);
 	sec -= min * 60;
 
+	char buf[128 + 1];
+
 	if (hour > 0 && min > 0)
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%d ð %d  %d   äñ Դϴ", hour, min, sec));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%d ð %d  %d   äñ Դϴ"), hour, min, sec);
 	else if (hour > 0 && min == 0)
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%d ð %d   äñ Դϴ", hour, sec));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%d ð %d   äñ Դϴ"), hour, sec);
 	else if (hour == 0 && min > 0)
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%d  %d   äñ Դϴ", min, sec));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%d  %d   äñ Դϴ"), min, sec);
 	else
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%d   äñ Դϴ", sec));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%d   äñ Դϴ"), sec);
 }
 
 EVENTINFO(spam_event_info)
@@ -122,7 +110,7 @@
 	}
 };
 
-typedef std::unordered_map<std::string, std::pair<unsigned int, LPEVENT>> spam_score_of_ip_t;
+typedef boost::unordered_map<std::string, std::pair<unsigned int, LPEVENT>> spam_score_of_ip_t;
 spam_score_of_ip_t spam_score_of_ip;
 
 EVENTFUNC(block_chat_by_ip_event)
@@ -265,7 +253,7 @@
 
 int ProcessTextTag(LPCHARACTER ch, const char* c_pszText, size_t len)
 {
-	// 20120517 
+	// 2012.05.17 
 	// 0 :  
 	// 1 : ݰ 
 	// 2 : ݰ , λ 
@@ -336,7 +324,7 @@
 	{
 		sys_log(0, "WHISPER_HACK: %s", ch->GetName());
 		//ch->GetDesc()->DelayedDisconnect(5);
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Please do not spam the chat."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Please do not spam the chat."));
 		ch->AddAffect(AFFECT_BLOCK_CHAT, POINT_NONE, 0, AFF_NONE, 10, 0, true);
 
 		return iExtraLen;
@@ -344,7 +332,7 @@
 
 	if (ch->FindAffect(AFFECT_BLOCK_CHAT))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ä  Դϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ä  Դϴ."));
 		return (iExtraLen);
 	}
 
@@ -411,7 +399,6 @@
 			pack.bType = WHISPER_TYPE_NOT_EXIST;
 			pack.wSize = sizeof(TPacketGCWhisper);
 			strlcpy(pack.szNameFrom, pinfo->szNameTo, sizeof(pack.szNameFrom));
-
 			ch->GetDesc()->Packet(&pack, sizeof(TPacketGCWhisper));
 			sys_log(0, "WHISPER: no player");
 		}
@@ -443,14 +430,14 @@
 			}
 		}
 #if defined(__MESSENGER_BLOCK_SYSTEM__)
-		else if (pkDesc && CMessengerManager::instance().IsBlocked(ch->GetName(), pinfo->szNameTo))
+		else if (pkChr && MessengerManager::instance().IsBlocked(ch->GetName(), pkChr->GetName()))
 		{
 			if (ch->GetDesc())
 			{
 				TPacketGCWhisper pack;
 
 				char msg[CHAT_MAX_LEN + 1];
-				snprintf(msg, sizeof(msg), LC_STRING("Unblock %s to continue.", pinfo->szNameTo));
+				snprintf(msg, sizeof(msg), LC_TEXT("Unblock %s to continue."), pkChr->GetName());
 				int len = MIN(CHAT_MAX_LEN, strlen(msg) + 1);
 
 				pack.bHeader = HEADER_GC_WHISPER;
@@ -464,17 +451,17 @@
 				buf.write(msg, len);
 				ch->GetDesc()->Packet(buf.read_peek(), buf.size());
 
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Unblock %s to continue.", pinfo->szNameTo));
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Unblock %s to continue."), pkChr->GetName());
 			}
 		}
-		else if (pkDesc && CMessengerManager::instance().IsBlocked(pinfo->szNameTo, ch->GetName()))
+		else if (pkChr && MessengerManager::instance().IsBlocked(pkChr->GetName(), ch->GetName()))
 		{
 			if (ch->GetDesc())
 			{
 				TPacketGCWhisper pack;
 
 				char msg[CHAT_MAX_LEN + 1];
-				snprintf(msg, sizeof(msg), LC_STRING("%s has blocked you.", pinfo->szNameTo));
+				snprintf(msg, sizeof(msg), LC_TEXT("%s has blocked you."), pkChr->GetName());
 				int len = MIN(CHAT_MAX_LEN, strlen(msg) + 1);
 
 				pack.bHeader = HEADER_GC_WHISPER;
@@ -488,7 +475,7 @@
 				buf.write(msg, len);
 				ch->GetDesc()->Packet(buf.read_peek(), buf.size());
 
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s has blocked you.", pinfo->szNameTo));
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s has blocked you."), pkChr->GetName());
 			}
 		}
 #endif
@@ -519,29 +506,23 @@
 			//	CBanwordManager::instance().ConvertString(buf, buflen);
 			//}
 
-			if (!g_bEmpireWhisper)
-			{
-				if (!ch->IsEquipUniqueGroup(UNIQUE_GROUP_RING_OF_LANGUAGE))
-				{
-					if (!(pkChr && pkChr->IsEquipUniqueGroup(UNIQUE_GROUP_RING_OF_LANGUAGE)))
-					{
-						if (bOpponentEmpire != ch->GetEmpire() && ch->GetEmpire() && bOpponentEmpire //   ٸ鼭
-							&& ch->GetGMLevel() == GM_PLAYER && gm_get_level(pinfo->szNameTo) == GM_PLAYER) // Ѵ Ϲ ÷̸̾
-							// ̸ ۿ 𸣴 gm_get_level Լ 
-						{
-							if (!pkChr)
-							{
-								// ٸ    ǥø Ѵ. bType  4Ʈ Empireȣ Ѵ.
-								bType = ch->GetEmpire() << 4;
-							}
-							else
-							{
-								ConvertEmpireText(ch->GetEmpire(), buf, buflen, 10 + 2 * pkChr->GetSkillPower(SKILL_LANGUAGE1 + ch->GetEmpire() - 1) /* ȯȮ */);
-							}
-						}
-					}
-				}
-			}
+			//if (g_bEmpireWhisper)
+			//	if (!ch->IsEquipUniqueGroup(UNIQUE_GROUP_RING_OF_LANGUAGE))
+			//		if (!(pkChr && pkChr->IsEquipUniqueGroup(UNIQUE_GROUP_RING_OF_LANGUAGE)))
+			//			if (bOpponentEmpire != ch->GetEmpire() && ch->GetEmpire() && bOpponentEmpire //   ٸ鼭
+			//				&& ch->GetGMLevel() == GM_PLAYER && gm_get_level(pinfo->szNameTo) == GM_PLAYER) // Ѵ Ϲ ÷̸̾
+			//			// ̸ ۿ 𸣴 gm_get_level Լ 
+			//			{
+			//				if (!pkChr)
+			//				{
+			//					// ٸ    ǥø Ѵ. bType  4Ʈ Empireȣ Ѵ.
+			//					bType = ch->GetEmpire() << 4;
+			//				}
+			//				else
+			//				{
+			//					ConvertEmpireText(ch->GetEmpire(), buf, buflen, 10 + 2 * pkChr->GetSkillPower(SKILL_LANGUAGE1 + ch->GetEmpire() - 1) /* ȯȮ */);
+			//				}
+			//			}
 
 			if (!g_bDisableGlassInsight)
 			{
@@ -557,10 +538,10 @@
 							char buf[128];
 							int len;
 							if (processReturn == 3) // ȯ
-								len = snprintf(buf, sizeof(buf), LC_STRING("ٸ ŷ(â,ȯ,) λ   ϴ."));
+								len = snprintf(buf, sizeof(buf), LC_TEXT("ٸ ŷ(â,ȯ,) λ   ϴ."));
 							else
 							{
-								len = snprintf(buf, sizeof(buf), LC_STRING("%s  ʿմϴ", LC_ITEM(pTable->dwVnum)));
+								len = snprintf(buf, sizeof(buf), LC_TEXT("%s  ʿմϴ"), LC_LOCALE_ITEM_TEXT(ITEM_PRISM, ch->GetLanguage()));
 							}
 
 							if (len < 0 || len >= (int)sizeof(buf))
@@ -599,12 +580,6 @@
 				pack.wSize = sizeof(TPacketGCWhisper) + buflen;
 				pack.bType = bType;
 				strlcpy(pack.szNameFrom, ch->GetName(), sizeof(pack.szNameFrom));
-#if defined(__LOCALE_CLIENT__)
-				pack.bCanFormat = false;
-#endif
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-				strlcpy(pack.szCountry, ch->GetCountry(), sizeof(pack.szCountry));
-#endif
 
 				// desc->BufferedPacket  ʰ ۿ ϴ  
 				// P2P relayǾ Ŷ ĸȭ   ֱ ̴.
@@ -781,14 +756,6 @@
 
 	if (buflen > 1 && *buf == '/')
 	{
-		// NOTE : Block players from accessing the command interpreter
-		// through normal chat. (CHAT_TYPE_TALKING) 20230607.Owsap
-		if (!ch->IsGM() && pinfo->type == CHAT_TYPE_TALKING)
-		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("׷ ɾ ϴ"));
-			return iExtraLen;
-		}
-
 		interpret_command(ch, buf + 1, buflen - 1);
 		return iExtraLen;
 	}
@@ -798,12 +765,61 @@
 	{
 		sys_log(0, "CHAT_HACK: %s", ch->GetName());
 		//ch->GetDesc()->DelayedDisconnect(5);
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Please do not spam the chat."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Please do not spam the chat."));
 		ch->AddAffect(AFFECT_BLOCK_CHAT, POINT_NONE, 0, AFF_NONE, 10, 0, true);
 
 		return iExtraLen;
 	}
 
+	if (g_bChatWhisper)
+	{
+		std::string findstr(buf);
+		if (findstr.at(0) == '@')
+		{
+			findstr = findstr.substr(1); // or findstr.erase(0, 1);
+			int pos = findstr.find(" ");
+			std::string message = findstr.substr(pos + 1);
+			std::string chname = findstr.substr(0, pos);
+
+			if (!check_name(chname.c_str()) || chname.length() > GUILD_NAME_MAX_LEN) // unvalid name
+			{
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("׷  ϴ."));
+				return (iExtraLen);
+			}
+
+			LPCHARACTER stch = CHARACTER_MANAGER::instance().FindPC(chname.c_str());
+
+			if (!stch)
+			{
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s is not around."), chname.c_str());
+				return (iExtraLen);
+			}
+
+			if (stch != ch)
+			{
+#if defined(__MESSENGER_BLOCK_SYSTEM__)
+				if (stch && MessengerManager::instance().IsBlocked(ch->GetName(), stch->GetName()))
+				{
+					ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Unblock %s to continue."), stch->GetName());
+					return (iExtraLen);
+				}
+
+				if (stch && MessengerManager::instance().IsBlocked(stch->GetName(), ch->GetName()))
+				{
+					ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s has blocked you."), stch->GetName());
+					return (iExtraLen);
+				}
+#endif
+				ch->ChatPacket(CHAT_TYPE_WHISPER, "%s -> %s : %s", ch->GetName(), stch->GetName(), message.c_str());
+				stch->ChatPacket(CHAT_TYPE_WHISPER, "%s : %s", ch->GetName(), message.c_str());
+			}
+			else
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot whisper to yourself."));
+
+			return (iExtraLen);
+		}
+	}
+
 	// ä  Affect ó
 	const CAffect* pAffect = ch->FindAffect(AFFECT_BLOCK_CHAT);
 
@@ -813,12 +829,14 @@
 		return iExtraLen;
 	}
 
-	if (SpamBlockCheck(ch, buf, buflen))
+	if (true == SpamBlockCheck(ch, buf, buflen))
+	{
 		return iExtraLen;
+	}
 
 	if (CHAT_TYPE_SHOUT == pinfo->type && g_bDisableShout && !ch->IsGM())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("The shout is disabled."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("The shout is disabled."));
 		return iExtraLen;
 	}
 
@@ -845,10 +863,10 @@
 			if (NULL != pTable)
 			{
 				if (3 == processReturn) //ȯ
-					ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ٸ ŷ(â,ȯ,) λ   ϴ."));
+					ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ٸ ŷ(â,ȯ,) λ   ϴ."));
 				else
 				{
-					ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s  ʿմϴ", LC_ITEM(pTable->dwVnum)));
+					ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s  ʿմϴ"), LC_LOCALE_ITEM_TEXT(ITEM_PRISM, ch->GetLanguage()));
 				}
 			}
 
@@ -862,115 +880,182 @@
 
 		if (ch->GetLevel() < SHOUT_LIMIT_LEVEL)
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ġ  %d ̻   մϴ.", SHOUT_LIMIT_LEVEL));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ġ  %d ̻   մϴ."), SHOUT_LIMIT_LEVEL);
 			return (iExtraLen);
 		}
 
 		if (thecore_heart->pulse - (int)ch->GetLastShoutPulse() < passes_per_sec * 15 && !ch->IsGM())
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You can only call every 15 seconds."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You can only call every 15 seconds."));
 			return (iExtraLen);
 		}
 
 		ch->SetLastShoutPulse(thecore_heart->pulse);
 
-		TPacketGGShout p;
-		p.bHeader = HEADER_GG_SHOUT;
-		p.bEmpire = ch->GetEmpire();
-		strlcpy(p.szText, chatbuf, sizeof(p.szText));
-#if defined(__MESSENGER_BLOCK_SYSTEM__)
-		strlcpy(p.szName, ch->GetName(), sizeof(p.szName));
+		if (g_bGlobalShout)
+		{
+			char buf[256];
+			char chatbuf_global[CHAT_MAX_LEN + 1];
+			const BYTE char_empire = ch->GetEmpire();
+			const BYTE char_channel = g_bChannel;
+			const BYTE char_level = ch->GetLevel();
+
+			if (ch->GetGMLevel() != GM_PLAYER)
+			{
+				strlcpy(buf, LC_TEXT("GM"), sizeof(buf));
+				std::string staff_color = "|cFFFFC700|H|h[";
+				staff_color += buf;
+				staff_color += "]|cFFA7FFD4|H|h";
+				sprintf(chatbuf_global, "|L%s|l %s %s", LC_LOCALE(ch->GetLanguage()), staff_color.c_str(), chatbuf);
+			}
+			else if (char_empire == 1)
+			{
+#if defined(__FLAG_IMAGE_SHOUT_LINE__)
+				std::string kingdom_red = "|Iflag/shinsoo|i";
+#else
+				strlcpy(buf, LC_TEXT("Shinsoo"), sizeof(buf));
+				std::string kingdom_red = "|cFFff0000|H|h[";
+				kingdom_red += buf;
+				kingdom_red += "]|cFFA7FFD4|H|h";
 #endif
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-		strlcpy(p.szCountry, ch->GetCountry(), sizeof(p.szCountry));
+				if (g_bDetailShout)
+					sprintf(chatbuf_global, "|L%s|l [CH%d] Lv.%d %s %s", LC_LOCALE(ch->GetLanguage()), char_channel, char_level, kingdom_red.c_str(), chatbuf);
+				else
+					sprintf(chatbuf_global, "|L%s|l %s %s", LC_LOCALE(ch->GetLanguage()), kingdom_red.c_str(), chatbuf);
+			}
+			else if (char_empire == 2)
+			{
+#if defined(__FLAG_IMAGE_SHOUT_LINE__)
+				std::string kingdom_yel = "|Iflag/chunjo|i";
+#else
+				strlcpy(buf, LC_TEXT("Chunjo"), sizeof(buf));
+				std::string kingdom_yel = "|cFFFFFF00|H|h[";
+				kingdom_yel += buf;
+				kingdom_yel += "]|cFFA7FFD4|H|h";
 #endif
+				if (g_bDetailShout)
+					sprintf(chatbuf_global, "|L%s|l [CH%d] Lv.%d %s %s", LC_LOCALE(ch->GetLanguage()), char_channel, char_level, kingdom_yel.c_str(), chatbuf);
+				else
+					sprintf(chatbuf_global, "|L%s|l %s %s", LC_LOCALE(ch->GetLanguage()), kingdom_yel.c_str(), chatbuf);
+			}
+			else if (char_empire == 3)
+			{
+#if defined(__FLAG_IMAGE_SHOUT_LINE__)
+				std::string kingdom_blue = "|Iflag/jinno|i";
+#else
+				strlcpy(buf, LC_TEXT("Jinno"), sizeof(buf));
+				std::string kingdom_blue = "|cFF0080FF|H|h[";
+				kingdom_blue += buf;
+				kingdom_blue += "]|cFFA7FFD4|H|h";
+#endif
+				if (g_bDetailShout)
+					sprintf(chatbuf_global, "|L%s|l [CH%d] Lv.%d %s %s", LC_LOCALE(ch->GetLanguage()), char_channel, char_level, kingdom_blue.c_str(), chatbuf);
+				else
+					sprintf(chatbuf_global, "|L%s|l %s %s", LC_LOCALE(ch->GetLanguage()), kingdom_blue.c_str(), chatbuf);
+			}
 
-		P2P_MANAGER::instance().Send(&p, sizeof(TPacketGGShout));
+			TPacketGGShout p;
+			p.bHeader = HEADER_GG_SHOUT;
+			p.bEmpire = char_empire;
+#if defined(__MESSENGER_BLOCK_SYSTEM__)
+			strlcpy(p.szName, ch->GetName(), sizeof(p.szName));
+#endif
+			strlcpy(p.szText, chatbuf_global, sizeof(p.szText));
 
-		SendShout(chatbuf, ch->GetEmpire()
+			P2P_MANAGER::instance().Send(&p, sizeof(TPacketGGShout));
 #if defined(__MESSENGER_BLOCK_SYSTEM__)
-			, ch->GetName()
+			SendShout(chatbuf_global, ch->GetName(), ch->GetEmpire());
+#else
+			SendShout(chatbuf_global, ch->GetEmpire());
 #endif
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-			, ch->GetCountry()
+		}
+		else
+		{
+			TPacketGGShout p;
+
+			p.bHeader = HEADER_GG_SHOUT;
+			p.bEmpire = ch->GetEmpire();
+			strlcpy(p.szText, chatbuf, sizeof(p.szText));
+
+			P2P_MANAGER::instance().Send(&p, sizeof(TPacketGGShout));
+
+#if defined(__MESSENGER_BLOCK_SYSTEM__)
+			SendShout(chatbuf, ch->GetName(), ch->GetEmpire());
+#else
+			SendShout(chatbuf, ch->GetEmpire());
 #endif
-		);
+		}
 
 		return (iExtraLen);
 	}
 
 	TPacketGCChat pack_chat;
+
 	pack_chat.header = HEADER_GC_CHAT;
 	pack_chat.size = sizeof(TPacketGCChat) + len;
 	pack_chat.type = pinfo->type;
 	pack_chat.id = ch->GetVID();
-#if defined(__LOCALE_CLIENT__)
-	pack_chat.bCanFormat = false;
-#endif
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-	strlcpy(pack_chat.szCountry, ch->GetCountry(), sizeof(pack_chat.szCountry));
-#endif
 
 	switch (pinfo->type)
 	{
-		case CHAT_TYPE_TALKING:
-		{
-			const DESC_MANAGER::DESC_SET& c_ref_set = DESC_MANAGER::instance().GetClientSet();
+	case CHAT_TYPE_TALKING:
+	{
+		const DESC_MANAGER::DESC_SET& c_ref_set = DESC_MANAGER::instance().GetClientSet();
 
-			if (false)
-			{
-				std::for_each(c_ref_set.begin(), c_ref_set.end(),
-					FYmirChatPacket(pack_chat,
-						buf,
-						strlen(buf),
-						ch->GetName(),
-						strlen(ch->GetName()),
-						ch->GetMapIndex(),
-						ch->GetEmpire(),
-						ch->IsEquipUniqueGroup(UNIQUE_GROUP_RING_OF_LANGUAGE)));
-			}
-			else
-			{
-				std::for_each(c_ref_set.begin(), c_ref_set.end(),
-					FEmpireChatPacket(pack_chat,
-						chatbuf,
-						len,
-						(ch->GetGMLevel() > GM_PLAYER ||
-							ch->IsEquipUniqueGroup(UNIQUE_GROUP_RING_OF_LANGUAGE)) ? 0 : ch->GetEmpire(),
-						ch->GetMapIndex(), strlen(ch->GetName())));
-			}
+		if (false)
+		{
+			std::for_each(c_ref_set.begin(), c_ref_set.end(),
+				FYmirChatPacket(pack_chat,
+					buf,
+					strlen(buf),
+					ch->GetName(),
+					strlen(ch->GetName()),
+					ch->GetMapIndex(),
+					ch->GetEmpire(),
+					ch->IsEquipUniqueGroup(UNIQUE_GROUP_RING_OF_LANGUAGE)));
 		}
-		break;
+		else
+		{
+			std::for_each(c_ref_set.begin(), c_ref_set.end(),
+				FEmpireChatPacket(pack_chat,
+					chatbuf,
+					len,
+					(ch->GetGMLevel() > GM_PLAYER ||
+						ch->IsEquipUniqueGroup(UNIQUE_GROUP_RING_OF_LANGUAGE)) ? 0 : ch->GetEmpire(),
+					ch->GetMapIndex(), strlen(ch->GetName())));
+		}
+	}
+	break;
 
-		case CHAT_TYPE_PARTY:
+	case CHAT_TYPE_PARTY:
+	{
+		if (!ch->GetParty())
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ƽ  ƴմϴ."));
+		else
 		{
-			if (!ch->GetParty())
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ƽ  ƴմϴ."));
-			else
-			{
-				TEMP_BUFFER tbuf;
+			TEMP_BUFFER tbuf;
 
-				tbuf.write(&pack_chat, sizeof(pack_chat));
-				tbuf.write(chatbuf, len);
+			tbuf.write(&pack_chat, sizeof(pack_chat));
+			tbuf.write(chatbuf, len);
 
-				RawPacketToCharacterFunc f(tbuf.read_peek(), tbuf.size());
-				ch->GetParty()->ForEachOnlineMember(f);
-			}
+			RawPacketToCharacterFunc f(tbuf.read_peek(), tbuf.size());
+			ch->GetParty()->ForEachOnlineMember(f);
 		}
-		break;
+	}
+	break;
 
-		case CHAT_TYPE_GUILD:
-		{
-			if (!ch->GetGuild())
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("忡  ʾҽϴ."));
-			else
-				ch->GetGuild()->Chat(chatbuf);
-		}
-		break;
+	case CHAT_TYPE_GUILD:
+	{
+		if (!ch->GetGuild())
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("忡  ʾҽϴ."));
+		else
+			ch->GetGuild()->Chat(chatbuf);
+	}
+	break;
 
-		default:
-			sys_err("Unknown chat type %d", pinfo->type);
-			break;
+	default:
+		sys_err("Unknown chat type %d", pinfo->type);
+		break;
 	}
 
 	return (iExtraLen);
@@ -1042,6 +1127,475 @@
 }
 #endif
 
+#if defined(__PRIVATE_SHOP_SEARCH_SYSTEM__)
+void CInputMain::ShopSearch(LPCHARACTER ch, const char* data, bool bName)
+{
+	TPacketCGShopSearch* pinfo = (TPacketCGShopSearch*)data;
+
+	if (!ch)
+		return;
+
+	if (!data)
+		return;
+
+	if (ch->IsOpenSafebox() || ch->GetShop() || ch->IsCubeOpen() || ch->IsDead() || ch->GetExchange() || ch->GetMyShop())
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("CANT_DO_THIS_BECAUSE_OTHER_WINDOW_OPEN"));
+		return;
+	}
+
+#if defined(__PRIVATE_SHOP_SEARCH_NEED_ITEM__)
+	if (!ch->FindSpecifyItem(60004) && !ch->FindSpecifyItem(60005))
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("PRIVATE_SHOP_SEARCH_NEED_ITEM"));
+		return;
+	}
+#endif
+
+	int32_t Race = pinfo->Race;
+	int32_t Cat = pinfo->ItemCat;
+	int32_t SubCat = pinfo->SubCat;
+	int32_t MinLevel = pinfo->MinLevel;
+	int32_t MaxLevel = pinfo->MaxLevel;
+	int32_t MinRefine = pinfo->MinRefine;
+	int32_t MaxRefine = pinfo->MaxRefine;
+	uint64_t MinGold = pinfo->MinGold;
+	uint64_t MaxGold = pinfo->MaxGold;
+#if defined(__CHEQUE_SYSTEM__)
+	uint64_t MinCheque = pinfo->MinCheque;
+	uint64_t MaxCheque = pinfo->MaxCheque;
+#endif
+	std::string itemName = "";
+
+	//Checks
+	if (Race < JOB_WARRIOR || Race > JOB_WOLFMAN)
+		return;
+
+	if (Cat < ITEM_NONE || Cat > ITEM_SOUL) // @ enum EItemTypes common/item_length.h
+		return;
+
+	if (SubCat < USE_POTION || SubCat > USE_EMOTION_PACK)
+		return;
+
+	if (MinLevel < 0 || MinLevel > 999 /*PLAYER_MAX_LEVEL_CONST*/)
+		return;
+
+	if (MaxLevel < 0 || MaxLevel > 999 /*PLAYER_MAX_LEVEL_CONST*/)
+		return;
+
+	if (MinRefine < 0 || MinRefine > 999)
+		return;
+
+	if (MaxRefine < 0 || MaxRefine > 999)
+		return;
+
+	if (MinGold < 0 || MinGold > g_MaxGold)
+		return;
+
+	if (MaxGold < 0 || MaxGold > g_MaxGold)
+		return;
+
+#if defined(__CHEQUE_SYSTEM__)
+	if (MinCheque < 0 || MinCheque > CHEQUE_MAX)
+		return;
+
+	if (MaxCheque < 0 || MaxCheque > CHEQUE_MAX)
+		return;
+#endif
+
+	if (MinLevel > MaxLevel)
+		return;
+
+	if (MinRefine > MaxRefine)
+		return;
+
+	if (MinGold > MaxGold)
+		return;
+
+#if defined(__CHEQUE_SYSTEM__)
+	if (MinCheque > MaxCheque)
+		return;
+#endif
+
+	if (bName)
+	{
+		itemName = pinfo->ItemName;
+		std::replace(itemName.begin(), itemName.end(), '_', ' ');
+	}
+
+	quest::PC* pPC = quest::CQuestManager::instance().GetPC(ch->GetPlayerID());
+
+	if (!pPC)
+		return;
+
+	DWORD dwShopSearchSecCycle = 2; // 1 sec
+	DWORD dwNowSec = get_global_time();
+	DWORD dwLastShopSearchAttrSec = pPC->GetFlag("ShopSearch.LastShopSearchSecAttr");
+
+	if (dwLastShopSearchAttrSec + dwShopSearchSecCycle > dwNowSec)
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("PRIVATE_SHOP_SEARCH_NEED_WAIT_%d_LEFT_(%d)"),
+			dwShopSearchSecCycle, dwShopSearchSecCycle - (dwNowSec - dwLastShopSearchAttrSec));
+		return;
+	}
+
+	pPC->SetFlag("ShopSearch.LastShopSearchSecAttr", dwNowSec);
+
+	std::vector<COfflineShop::OFFLINE_SHOP_ITEM> sendItems;
+	std::vector<COfflineShop::OFFLINE_SHOP_ITEM> shop_items;
+	std::vector<COfflineShop::OFFLINE_SHOP_ITEM>::iterator item;
+
+	char szQuery[1024];
+	if (bName)
+	{
+		sprintf(szQuery, "select of.*,(case when of.vnum in(50300,70037) then (select concat(convert(sp.szName using latin5),' ',convert(ip.locale_name using latin5)) from skill_proto sp where sp.dwVnum = of.socket0) else convert(ip.locale_name using latin5) end) as item_name from offline_shop_item of inner join item_proto ip on ip.vnum = of.vnum where (case when of.vnum in(50300,70037) then (select concat(convert(sp.szName using latin5),' ',convert(ip.locale_name using latin5)) from skill_proto sp where sp.dwVnum = of.socket0) else convert(ip.locale_name using latin5) end) like CONCAT('%%%%', '%s', '%%%%')", itemName.c_str());
+	}
+	else
+	{
+		sprintf(szQuery, "select of.*,(case when of.vnum in(50300,70037) then (select concat(convert(sp.szName using latin5),' ',convert(ip.locale_name using latin5)) from skill_proto sp where sp.dwVnum = of.socket0) else convert(ip.locale_name using latin5) end) as item_name from offline_shop_item of inner join item_proto ip on ip.vnum = of.vnum");
+	}
+
+	SQLMsg* pSearchQuery(DBManager::instance().DirectQuery(szQuery));
+	if (pSearchQuery->uiSQLErrno != 0)
+	{
+		sys_err("Item Search Query Failed, Error code: %ld", pSearchQuery->uiSQLErrno);
+		return;
+	}
+
+	if (!pSearchQuery->Get()->uiNumRows)
+		return;
+
+	int i = 0;
+	while (MYSQL_ROW row = mysql_fetch_row(pSearchQuery->Get()->pSQLResult))
+	{
+		shop_items.resize(i + 1);
+
+		const TItemTable* item_table;
+
+		DWORD vnum = 0;
+		str_to_number(vnum, row[4]);
+
+		item_table = ITEM_MANAGER::instance().GetTable(vnum);
+
+		if (!item_table)
+		{
+			sys_err("OfflineShop: no item table by item vnum #%d", vnum);
+			continue;
+		}
+
+		COfflineShop::OFFLINE_SHOP_ITEM& item = shop_items[i];
+		str_to_number(item.id, row[0]);									// 0
+		str_to_number(item.owner_id, row[1]);							// 1
+		str_to_number(item.pos, row[2]);								// 2
+		str_to_number(item.count, row[3]);								// 3
+		str_to_number(item.vnum, row[4]);								// 4
+		str_to_number(item.alSockets[0], row[5]);						// 5
+		str_to_number(item.alSockets[1], row[6]);						// 6
+		str_to_number(item.alSockets[2], row[7]);						// 7
+#if defined(__ITEM_SOCKET5__)
+		str_to_number(item.alSockets[3], row[8]);						// 8
+		str_to_number(item.alSockets[4], row[9]);						// 9
+		str_to_number(item.alSockets[5], row[10]);						// 10
+#endif
+		str_to_number(item.aAttr[0].bType, row[11]);					// 11 ~ 8
+		str_to_number(item.aAttr[0].sValue, row[12]);					// 12 ~ 9
+		str_to_number(item.aAttr[1].bType, row[13]);					// 13 ~ 10
+		str_to_number(item.aAttr[1].sValue, row[14]);					// 14 ~ 11
+		str_to_number(item.aAttr[2].bType, row[15]);					// 15 ~ 12
+		str_to_number(item.aAttr[2].sValue, row[16]);					// 16 ~ 13
+		str_to_number(item.aAttr[3].bType, row[17]);					// 17 ~ 14
+		str_to_number(item.aAttr[3].sValue, row[18]);					// 18 ~ 15
+		str_to_number(item.aAttr[4].bType, row[19]);					// 19 ~ 16
+		str_to_number(item.aAttr[4].sValue, row[20]);					// 20 ~ 17
+		str_to_number(item.aAttr[5].bType, row[21]);					// 21 ~ 18
+		str_to_number(item.aAttr[5].sValue, row[22]);					// 22 ~ 19
+		str_to_number(item.aAttr[6].bType, row[23]);					// 23 ~ 20
+		str_to_number(item.aAttr[6].sValue, row[24]);					// 24 ~ 21
+		str_to_number(item.aAttr[7].bType, row[25]);					// 25 ~ 22
+		str_to_number(item.aAttr[7].sValue, row[26]);					// 26 ~ 23
+		str_to_number(item.aAttr[8].bType, row[27]);					// 27 ~ 24
+		str_to_number(item.aAttr[8].sValue, row[28]);					// 28 ~ 25
+		str_to_number(item.aAttr[9].bType, row[29]);					// 29 ~ 26
+		str_to_number(item.aAttr[9].sValue, row[30]);					// 30 ~ 27
+		str_to_number(item.aAttr[10].bType, row[31]);					// 31 ~ 28
+		str_to_number(item.aAttr[10].sValue, row[32]);					// 32 ~ 29
+		str_to_number(item.aAttr[11].bType, row[33]);					// 33 ~ 30
+		str_to_number(item.aAttr[11].sValue, row[34]);					// 34 ~ 31
+		str_to_number(item.aAttr[12].bType, row[35]);					// 35 ~ 32
+		str_to_number(item.aAttr[12].sValue, row[36]);					// 36 ~ 33
+		str_to_number(item.aAttr[13].bType, row[37]);					// 37 ~ 34
+		str_to_number(item.aAttr[13].sValue, row[38]);					// 38 ~ 35
+		str_to_number(item.aAttr[14].bType, row[39]);					// 39 ~ 36
+		str_to_number(item.aAttr[14].sValue, row[40]);					// 40 ~ 37
+		str_to_number(item.price, row[41]);								// 41 ~ 38
+#if defined(__CHEQUE_SYSTEM__)
+		str_to_number(item.price_cheque, row[42]);						// 42 ~ 39
+#endif
+		str_to_number(item.status, row[43]);							// 43 ~ 40
+		strlcpy(item.szBuyerName, row[44], sizeof(item.szBuyerName));	// 44 ~ 41
+#if defined(__CHANGE_LOOK_SYSTEM__)
+		str_to_number(item.transmutation, row[45]);						// 45 ~ 42
+#endif
+
+		strlcpy(item.szName, row[46], sizeof(item.szName));				// 46 ~ 43
+		str_to_number(item.refine_level, row[47]);						// 47 ~ 44
+
+		i++;
+	}
+
+	for (item = shop_items.begin(); item != shop_items.end(); ++item)
+	{
+		bool bLimit = false;
+
+		if (item->status != 0 || item->vnum == 0)
+			continue;
+
+		TItemTable* itemTable = ITEM_MANAGER::instance().GetTable(item->vnum);
+
+		if (!itemTable)
+			continue;
+
+		if (!bName)
+		{
+			if (itemTable->bType == Cat && (itemTable->bSubType == SubCat || itemTable->bSubType == 99))
+			{
+				if (itemTable->bType == ITEM_WEAPON || itemTable->bType == ITEM_ARMOR)
+				{
+					if (!(item->refine_level >= MinRefine && item->refine_level <= MaxRefine))
+						continue;
+				}
+			}
+			else
+			{
+				continue;
+			}
+		}
+
+		for (int i = 0; i < ITEM_LIMIT_MAX_NUM; ++i)
+		{
+			long lLimit = itemTable->aLimits[i].lValue;
+			switch (itemTable->aLimits[i].bType)
+			{
+			case LIMIT_LEVEL:
+				if (!(lLimit >= MinLevel && lLimit <= MaxLevel))
+					bLimit = true;
+				break;
+			case LIMIT_REAL_TIME:
+				if (lLimit == 0)
+					bLimit = true;
+				break;
+			}
+		}
+
+		if (bLimit)
+			continue;
+
+		if (!(item->price >= MinGold && item->price <= MaxGold))
+			continue;
+
+#if defined(__CHEQUE_SYSTEM__)
+		if (!(item->price_cheque >= MinCheque && item->price_cheque <= MaxCheque))
+			continue;
+#endif
+
+		bool skillBook = false;
+		DWORD bkType = 0;
+
+		if ((itemTable->bType == ITEM_SKILLBOOK) || (itemTable->bType == ITEM_SKILLFORGET))
+		{
+			CSkillProto* pkSk = CSkillManager::instance().Get(item->alSockets[0]);
+			bkType = pkSk->dwType;
+			skillBook = false;
+		}
+
+		bool cont = false;
+		if (skillBook)
+		{
+			switch (Race)
+			{
+			case JOB_WARRIOR:
+				if (bkType != JOB_WARRIOR + 1)
+				{
+					cont = true;
+				}
+				break;
+			case JOB_ASSASSIN:
+				if (bkType != JOB_ASSASSIN + 1)
+				{
+					cont = true;
+				}
+				break;
+			case JOB_SURA:
+				if (bkType != JOB_SURA + 1)
+				{
+					cont = true;
+				}
+				break;
+			case JOB_SHAMAN:
+				if (bkType != JOB_SHAMAN + 1)
+				{
+					cont = true;
+				}
+				break;
+			case JOB_WOLFMAN:
+				if (bkType != JOB_WOLFMAN + 1)
+				{
+					cont = true;
+				}
+				break;
+			}
+		}
+		else
+		{
+			switch (Race)
+			{
+			case JOB_WARRIOR:
+				if (IS_SET(itemTable->dwAntiFlags, ITEM_ANTIFLAG_WARRIOR))
+					cont = true;
+				break;
+
+			case JOB_ASSASSIN:
+				if (IS_SET(itemTable->dwAntiFlags, ITEM_ANTIFLAG_ASSASSIN))
+					cont = true;
+				break;
+
+			case JOB_SURA:
+				if (IS_SET(itemTable->dwAntiFlags, ITEM_ANTIFLAG_SURA))
+					cont = true;
+				break;
+
+			case JOB_SHAMAN:
+				if (IS_SET(itemTable->dwAntiFlags, ITEM_ANTIFLAG_SHAMAN))
+					cont = true;
+				break;
+
+			case JOB_WOLFMAN:
+				if (IS_SET(itemTable->dwAntiFlags, ITEM_ANTIFLAG_WOLFMAN))
+					cont = true;
+				break;
+
+			}
+		}
+
+		if (cont)
+			continue;
+
+		sendItems.push_back(*item);
+	}
+
+	std::stable_sort(sendItems.begin(), sendItems.end(), CompareItemVnumAcPriceAC);
+
+	for (item = sendItems.begin(); item != sendItems.end(); ++item)
+	{
+		if (item->status != 0 || item->vnum == 0)
+			continue;
+
+		TItemTable* itemTable = ITEM_MANAGER::instance().GetTable(item->vnum);
+
+		LPCHARACTER offlineShopNpc = CHARACTER_MANAGER::instance().Find(COfflineShopManager::instance().FindMyOfflineShop(item->owner_id));
+		if (!offlineShopNpc || !pPC)
+			return;
+
+		if (itemTable)
+		{
+			LPDESC d = ch->GetDesc();
+
+			if (!d)
+				return;
+
+			TPacketGCShopSearchItemSet pack;
+			pack.header = HEADER_GC_SHOPSEARCH_SET;
+
+			pack.count = static_cast<BYTE>(item->count);
+			pack.vnum = item->vnum;
+			pack.flags = itemTable->dwFlags;
+			pack.anti_flags = itemTable->dwAntiFlags;
+			pack.price = item->price;
+#if defined(__CHEQUE_SYSTEM__)
+			pack.price_cheque = item->price_cheque;
+#endif
+			pack.vid = offlineShopNpc->GetVID();
+#if defined(__CHANGE_LOOK_SYSTEM__)
+			pack.transmutation = item->transmutation;
+#endif
+			pack.Cell = item->pos;
+
+			thecore_memcpy(pack.alSockets, item->alSockets, sizeof(pack.alSockets));
+			thecore_memcpy(pack.aAttr, item->aAttr, sizeof(pack.aAttr));
+
+			d->LargePacket(&pack, sizeof(TPacketGCShopSearchItemSet));
+		}
+	}
+}
+
+void CInputMain::ShopSearchBuy(LPCHARACTER ch, const char* data)
+{
+	TPacketCGShopSearchBuy* pinfo = (TPacketCGShopSearchBuy*)data;
+
+	int32_t shopVid = pinfo->shopVid;
+	int32_t shopItemPos = pinfo->shopItemPos;
+
+	if (!ch)
+		return;
+
+	if (0 == quest::CQuestManager::instance().GetEventFlag("enable_shop_search"))
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("PRIVATE_SHOP_SEARCH_SYSTEM_DISABLED"));
+		return;
+	}
+
+#if defined(__PRIVATE_SHOP_SEARCH_NEED_ITEM__)
+	if (!ch->FindSpecifyItem(60005))
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("PRIVATE_SHOP_SEARCH_NEED_ITEM"));
+		return;
+	}
+#endif
+
+	LPCHARACTER pkChrShop = CHARACTER_MANAGER::instance().Find(shopVid);
+
+	if (!pkChrShop)
+		return;
+
+	LPOFFLINESHOP pkShop = pkChrShop->GetOfflineShop();
+
+	if (!pkShop)
+		return;
+
+	if (DISTANCE_APPROX(ch->GetX() - pkChrShop->GetX(), ch->GetY() - pkChrShop->GetY()) > VIEW_RANGE)
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" Ÿ ʹ ־    ϴ."));
+		return;
+	}
+
+	if (ch->GetMapIndex() != pkChrShop->GetMapIndex())
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("YOU_CANNOT_BUY_THIS_BECAUSE_NOT_IN_SAME_MAP"));
+		return;
+	}
+
+	ch->SetOfflineShopOwner(pkChrShop);
+	pkShop->SetGuestMap(ch);
+	int32_t returnHeader = pkShop->Buy(ch, shopItemPos);
+
+	if (SHOP_SUBHEADER_GC_OK == returnHeader)
+	{
+		// being lazy starting in 3 2 ..
+		ch->ChatPacket(CHAT_TYPE_COMMAND, "ShopSearchBuy");
+		ch->SetOfflineShop(NULL);
+		ch->SetOfflineShopOwner(NULL);
+		pkShop->RemoveGuestMap(ch);
+	}
+	else
+	{
+		ch->ChatPacket(CHAT_TYPE_COMMAND, "ShopSearchError %d", returnHeader);
+		ch->SetOfflineShop(NULL);
+		ch->SetOfflineShopOwner(NULL);
+		pkShop->RemoveGuestMap(ch);
+	}
+}
+#endif
+
 void CInputMain::ItemMove(LPCHARACTER ch, const char* data)
 {
 	struct command_item_move* pinfo = (struct command_item_move*)data;
@@ -1075,262 +1629,255 @@
 	ch->SwapQuickslot(pinfo->pos, pinfo->change_pos);
 }
 
-int CInputMain::Messenger(const LPCHARACTER c_lpChar, const char* c_pData, std::size_t uiBytes)
+int CInputMain::Messenger(LPCHARACTER ch, const char* c_pData, size_t uiBytes)
 {
-	const TPacketCGMessenger* c_pPacket = reinterpret_cast<const TPacketCGMessenger*>(c_pData);
+	TPacketCGMessenger* p = (TPacketCGMessenger*)c_pData;
+
 	if (uiBytes < sizeof(TPacketCGMessenger))
 		return -1;
 
 	c_pData += sizeof(TPacketCGMessenger);
 	uiBytes -= sizeof(TPacketCGMessenger);
 
-	switch (c_pPacket->bSubHeader)
+	switch (p->subheader)
 	{
-		case MESSENGER_SUBHEADER_CG_ADD_BY_VID:
-		{
-			if (uiBytes < sizeof(TPacketCGMessengerAddByVID))
-				return -1;
+	case MESSENGER_SUBHEADER_CG_ADD_BY_VID:
+	{
+		if (uiBytes < sizeof(TPacketCGMessengerAddByVID))
+			return -1;
 
-			const TPacketCGMessengerAddByVID* c_pAddByVIDPacket = reinterpret_cast<const TPacketCGMessengerAddByVID*>(c_pData);
-			const LPCHARACTER c_lpCharCompanion = CHARACTER_MANAGER::instance().Find(c_pAddByVIDPacket->dwVID);
+		TPacketCGMessengerAddByVID* p2 = (TPacketCGMessengerAddByVID*)c_pData;
+		LPCHARACTER ch_companion = CHARACTER_MANAGER::instance().Find(p2->vid);
 
-			if (c_lpCharCompanion == nullptr)
-				return sizeof(TPacketCGMessengerAddByVID);
+		if (!ch_companion)
+			return sizeof(TPacketCGMessengerAddByVID);
 
-			if (c_lpCharCompanion->IsObserverMode())
-				return sizeof(TPacketCGMessengerAddByVID);
+		if (ch->IsObserverMode())
+			return sizeof(TPacketCGMessengerAddByVID);
 
-			if (c_lpCharCompanion->IsBlockMode(BLOCK_MESSENGER_INVITE))
-			{
-				c_lpChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ޽ ߰ ź Դϴ."));
-				return sizeof(TPacketCGMessengerAddByVID);
-			}
+		if (ch_companion->IsBlockMode(BLOCK_MESSENGER_INVITE))
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ޽ ߰ ź Դϴ."));
+			return sizeof(TPacketCGMessengerAddByVID);
+		}
 
-			const LPDESC c_lpCompanionDesc = c_lpCharCompanion->GetDesc();
-			if (c_lpCompanionDesc == nullptr)
-				return sizeof(TPacketCGMessengerAddByVID);
+		LPDESC d = ch_companion->GetDesc();
 
-			if (c_lpChar->GetGMLevel() == GM_PLAYER && c_lpCharCompanion->GetGMLevel() != GM_PLAYER)
-			{
-				c_lpChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<޽> ڴ ޽ ߰  ϴ."));
-				return sizeof(TPacketCGMessengerAddByVID);
-			}
+		if (!d)
+			return sizeof(TPacketCGMessengerAddByVID);
+
+		if (ch->GetGMLevel() == GM_PLAYER && ch_companion->GetGMLevel() != GM_PLAYER)
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<޽> ڴ ޽ ߰  ϴ."));
+			return sizeof(TPacketCGMessengerAddByVID);
+		}
 
 #if defined(__MESSENGER_BLOCK_SYSTEM__)
-			if (CMessengerManager::instance().IsBlocked(c_lpChar->GetName(), c_lpCharCompanion->GetName()))
-			{
-				c_lpChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Unblock %s to continue.", c_lpCharCompanion->GetName()));
-				return sizeof(TPacketCGMessengerAddByVID);
-			}
-			else if (CMessengerManager::instance().IsBlocked(c_lpCharCompanion->GetName(), c_lpChar->GetName()))
-			{
-				c_lpChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s has blocked you.", c_lpCharCompanion->GetName()));
-				return sizeof(TPacketCGMessengerAddByVID);
-			}
+		if (MessengerManager::instance().IsBlocked(ch->GetName(), ch_companion->GetName()))
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Unblock %s to continue."), ch_companion->GetName());
+			return sizeof(TPacketCGMessengerAddByVID);
+		}
+		else if (MessengerManager::instance().IsBlocked(ch_companion->GetName(), ch->GetName()))
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s has blocked you."), ch_companion->GetName());
+			return sizeof(TPacketCGMessengerAddByVID);
+		}
 #endif
 
-			if (c_lpChar->GetDesc() == c_lpCompanionDesc) // ڽ ߰  .
-				return sizeof(TPacketCGMessengerAddByVID);
+		if (ch->GetDesc() == d) // ڽ ߰  .
+			return sizeof(TPacketCGMessengerAddByVID);
 
-			CMessengerManager::instance().RequestToAdd(c_lpChar, c_lpCharCompanion);
-			//CMessengerManager::instance().AddToList(c_lpChar->GetName(), c_lpCharCompanion->GetName());
-		}
-		return sizeof(TPacketCGMessengerAddByVID);
+		MessengerManager::instance().RequestToAdd(ch, ch_companion);
+		//MessengerManager::instance().AddToList(ch->GetName(), ch_companion->GetName());
+	}
+	return sizeof(TPacketCGMessengerAddByVID);
 
-		case MESSENGER_SUBHEADER_CG_ADD_BY_NAME:
+	case MESSENGER_SUBHEADER_CG_ADD_BY_NAME:
+	{
+		if (uiBytes < CHARACTER_NAME_MAX_LEN)
+			return -1;
+
+		char name[CHARACTER_NAME_MAX_LEN + 1];
+		strlcpy(name, c_pData, sizeof(name));
+
+		if (ch->GetGMLevel() == GM_PLAYER && gm_get_level(name) != GM_PLAYER)
 		{
-			if (uiBytes < CHARACTER_NAME_MAX_LEN)
-				return -1;
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<޽> ڴ ޽ ߰  ϴ."));
+			return CHARACTER_NAME_MAX_LEN;
+		}
 
-			char szName[CHARACTER_NAME_MAX_LEN + 1] = {};
-			strlcpy(szName, c_pData, sizeof(szName));
+		LPCHARACTER tch = CHARACTER_MANAGER::instance().FindPC(name);
 
-			if (c_lpChar->GetGMLevel() == GM_PLAYER && gm_get_level(szName) != GM_PLAYER)
+		if (!tch)
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s  ӵ  ʽϴ."), name);
+		else
+		{
+			if (tch == ch) // ڽ ߰  .
+				return CHARACTER_NAME_MAX_LEN;
+
+#if defined(__MESSENGER_BLOCK_SYSTEM__)
+			if (MessengerManager::instance().IsBlocked(ch->GetName(), tch->GetName()))
 			{
-				c_lpChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<޽> ڴ ޽ ߰  ϴ."));
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Unblock %s to continue."), tch->GetName());
 				return CHARACTER_NAME_MAX_LEN;
 			}
-
-			const LPCHARACTER c_lpCharTarget = CHARACTER_MANAGER::instance().FindPC(szName);
-			if (c_lpCharTarget == nullptr)
-				c_lpChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s  ӵ  ʽϴ.", szName));
-			else
+			else if (MessengerManager::instance().IsBlocked(tch->GetName(), ch->GetName()))
 			{
-				if (c_lpCharTarget == c_lpChar) // ڽ ߰  .
-					return CHARACTER_NAME_MAX_LEN;
-
-#if defined(__MESSENGER_BLOCK_SYSTEM__)
-				if (CMessengerManager::instance().IsBlocked(c_lpChar->GetName(), c_lpCharTarget->GetName()))
-				{
-					c_lpChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Unblock %s to continue.", c_lpCharTarget->GetName()));
-					return CHARACTER_NAME_MAX_LEN;
-				}
-				else if (CMessengerManager::instance().IsBlocked(c_lpCharTarget->GetName(), c_lpChar->GetName()))
-				{
-					c_lpChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s has blocked you.", c_lpCharTarget->GetName()));
-					return CHARACTER_NAME_MAX_LEN;
-				}
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s has blocked you."), tch->GetName());
+				return CHARACTER_NAME_MAX_LEN;
+			}
 #endif
 
-				if (c_lpCharTarget->IsBlockMode(BLOCK_MESSENGER_INVITE) == true)
-				{
-					c_lpChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ޽ ߰ ź Դϴ."));
-				}
-				else
-				{
-					// ޽ ĳʹ Ǹ鼭 
-					CMessengerManager::instance().RequestToAdd(c_lpChar, c_lpCharTarget);
-					//CMessengerManager::instance().AddToList(c_lpChar->GetName(), c_lpCharTarget->GetName());
-				}
+			if (tch->IsBlockMode(BLOCK_MESSENGER_INVITE) == true)
+			{
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ޽ ߰ ź Դϴ."));
+			}
+			else
+			{
+				// ޽ ĳʹ Ǹ鼭 
+				MessengerManager::instance().RequestToAdd(ch, tch);
+				//MessengerManager::instance().AddToList(ch->GetName(), tch->GetName());
 			}
 		}
-		return CHARACTER_NAME_MAX_LEN;
+	}
+	return CHARACTER_NAME_MAX_LEN;
 
-		case MESSENGER_SUBHEADER_CG_REMOVE:
-		{
-			if (uiBytes < CHARACTER_NAME_MAX_LEN)
-				return -1;
+	case MESSENGER_SUBHEADER_CG_REMOVE:
+	{
+		if (uiBytes < CHARACTER_NAME_MAX_LEN)
+			return -1;
 
-			char szName[CHARACTER_NAME_MAX_LEN + 1] = {};
-			strlcpy(szName, c_pData, sizeof(szName));
-			CMessengerManager::instance().RemoveFromList(c_lpChar->GetName(), szName);
-		}
-		return CHARACTER_NAME_MAX_LEN;
+		char char_name[CHARACTER_NAME_MAX_LEN + 1];
+		strlcpy(char_name, c_pData, sizeof(char_name));
+		MessengerManager::instance().RemoveFromList(ch->GetName(), char_name);
+	}
+	return CHARACTER_NAME_MAX_LEN;
 
 #if defined(__MESSENGER_BLOCK_SYSTEM__)
-		case MESSENGER_SUBHEADER_CG_BLOCK_ADD_BY_VID:
-		{
-			if (uiBytes < sizeof(TPacketCGMessengerAddBlockByVID))
-				return -1;
+	case MESSENGER_SUBHEADER_CG_ADD_BLOCK_BY_VID:
+	{
+		if (uiBytes < sizeof(TPacketCGMessengerAddBlockByVID))
+			return -1;
 
-			const TPacketCGMessengerAddBlockByVID* c_pAddBlockByVIDPacket = reinterpret_cast<const TPacketCGMessengerAddBlockByVID*>(c_pData);
-			const LPCHARACTER c_lpCharCompanion = CHARACTER_MANAGER::instance().Find(c_pAddBlockByVIDPacket->dwVID);
-			if (c_lpCharCompanion == nullptr)
-				return sizeof(TPacketCGMessengerAddBlockByVID);
+		TPacketCGMessengerAddBlockByVID* p2 = (TPacketCGMessengerAddBlockByVID*)c_pData;
+		LPCHARACTER ch_companion = CHARACTER_MANAGER::instance().Find(p2->vid);
 
-			if (c_lpChar->IsObserverMode())
-				return sizeof(TPacketCGMessengerAddBlockByVID);
+		if (!ch_companion)
+			return sizeof(TPacketCGMessengerAddBlockByVID);
 
-			const LPDESC c_lpDescCompanion = c_lpCharCompanion->GetDesc();
-			if (c_lpDescCompanion == nullptr)
-				return sizeof(TPacketCGMessengerAddByVID);
+		if (ch->IsObserverMode())
+			return sizeof(TPacketCGMessengerAddBlockByVID);
 
-			const LPCHARACTER c_pPartner = c_lpChar->GetMarryPartner();
-			if (c_pPartner)
-			{
-				if (c_lpCharCompanion->GetName() == c_pPartner->GetName())
-				{
-					c_lpChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot block your spouse."));
-					return sizeof(TPacketCGMessengerAddBlockByVID);
-				}
-			}
+		LPDESC d = ch_companion->GetDesc();
 
-			if (CMessengerManager::instance().IsBlocked(c_lpChar->GetName(), c_lpCharCompanion->GetName()))
-			{
-				c_lpChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Remove %s from your friends list to continue.", c_lpCharCompanion->GetName()));
-				return sizeof(TPacketCGMessengerAddBlockByVID);
-			}
+		if (!d)
+			return sizeof(TPacketCGMessengerAddByVID);
 
-			if (CMessengerManager::instance().IsBlocked(c_lpChar->GetName(), c_lpCharCompanion->GetName()))
+		LPCHARACTER pkPartner = ch->GetMarryPartner();
+		if (pkPartner)
+		{
+			if (ch_companion->GetName() == pkPartner->GetName())
 			{
-				c_lpChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s is already being blocked.", c_lpCharCompanion->GetName()));
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot block your spouse."));
 				return sizeof(TPacketCGMessengerAddBlockByVID);
 			}
+		}
 
-			if (c_lpChar->GetGMLevel() == GM_PLAYER && c_lpCharCompanion->GetGMLevel() != GM_PLAYER && !test_server)
-			{
-				c_lpChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot block this player."));
-				return sizeof(TPacketCGMessengerAddByVID);
-			}
-
-			if (c_lpChar->GetDesc() == c_lpDescCompanion)
-				return sizeof(TPacketCGMessengerAddBlockByVID);
+		if (MessengerManager::instance().IsBlocked(ch->GetName(), ch_companion->GetName()))
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Remove %s from your friends list to continue."), ch_companion->GetName());
+			return sizeof(TPacketCGMessengerAddBlockByVID);
+		}
 
-			CMessengerManager::instance().AddToBlockList(c_lpChar->GetName(), c_lpCharCompanion->GetName());
+		if (MessengerManager::instance().IsBlocked(ch->GetName(), ch_companion->GetName()))
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s is already being blocked."), ch_companion->GetName());
+			return sizeof(TPacketCGMessengerAddBlockByVID);
 		}
-		return sizeof(TPacketCGMessengerAddBlockByVID);
 
-		case MESSENGER_SUBHEADER_CG_BLOCK_ADD_BY_NAME:
+		if (ch->GetGMLevel() == GM_PLAYER && ch_companion->GetGMLevel() != GM_PLAYER && !test_server)
 		{
-			if (uiBytes < CHARACTER_NAME_MAX_LEN)
-				return -1;
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot block this player."));
+			return sizeof(TPacketCGMessengerAddByVID);
+		}
 
-			char szName[CHARACTER_NAME_MAX_LEN + 1] = {};
-			strlcpy(szName, c_pData, sizeof(szName));
+		if (ch->GetDesc() == d)
+			return sizeof(TPacketCGMessengerAddBlockByVID);
 
-			if (gm_get_level(szName) != GM_PLAYER && !test_server)
-			{
-				c_lpChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot block this player."));
-				return CHARACTER_NAME_MAX_LEN;
-			}
+		MessengerManager::instance().AddToBlockList(ch->GetName(), ch_companion->GetName());
+	}
+	return sizeof(TPacketCGMessengerAddBlockByVID);
 
-			const LPCHARACTER c_lpCharTarget = CHARACTER_MANAGER::instance().FindPC(szName);
-			if (c_lpCharTarget == c_lpChar)
-				return CHARACTER_NAME_MAX_LEN;
+	case MESSENGER_SUBHEADER_CG_ADD_BLOCK_BY_NAME:
+	{
+		if (uiBytes < CHARACTER_NAME_MAX_LEN)
+			return -1;
 
-			LPDESC pDescTarget = nullptr;
-			if (c_lpCharTarget == nullptr)
-			{
-				const CCI* c_pCCI = P2P_MANAGER::instance().Find(szName);
-				if (c_pCCI)
-					pDescTarget = c_pCCI->pkDesc;
-			}
-			else
-				pDescTarget = c_lpCharTarget->GetDesc();
+		char name[CHARACTER_NAME_MAX_LEN + 1];
+		strlcpy(name, c_pData, sizeof(name));
 
-			if (pDescTarget == nullptr)
-			{
-				c_lpChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s is not online.", szName));
+		if (gm_get_level(name) != GM_PLAYER && !test_server)
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot block this player."));
+			return CHARACTER_NAME_MAX_LEN;
+		}
+
+		LPCHARACTER tch = CHARACTER_MANAGER::instance().FindPC(name);
+
+		if (!tch)
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s is not online."), name);
+		else
+		{
+			if (tch == ch)
 				return CHARACTER_NAME_MAX_LEN;
-			}
-			else
-			{
-				const LPCHARACTER c_pPartner = c_lpChar->GetMarryPartner();
-				if (c_pPartner)
-				{
-					if (c_pPartner->GetName() == szName)
-					{
-						c_lpChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot block your spouse."));
-						return CHARACTER_NAME_MAX_LEN;
-					}
-				}
 
-				if (CMessengerManager::instance().IsBlocked(c_lpChar->GetName(), szName))
+			LPCHARACTER partner = ch->GetMarryPartner();
+			if (partner)
+			{
+				if (tch->GetName() == partner->GetName())
 				{
-					c_lpChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Remove %s from your friends list to continue.", szName));
+					ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot block your spouse."));
 					return CHARACTER_NAME_MAX_LEN;
 				}
+			}
 
-				if (CMessengerManager::instance().IsBlocked(c_lpChar->GetName(), szName))
-				{
-					c_lpChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s is already being blocked.", szName));
-					return CHARACTER_NAME_MAX_LEN;
-				}
+			if (MessengerManager::instance().IsBlocked(ch->GetName(), tch->GetName()))
+			{
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Remove %s from your friends list to continue."), tch->GetName());
+				return CHARACTER_NAME_MAX_LEN;
+			}
 
-				CMessengerManager::instance().AddToBlockList(c_lpChar->GetName(), szName);
+			if (MessengerManager::instance().IsBlocked(ch->GetName(), tch->GetName()))
+			{
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s is already being blocked."), tch->GetName());
+				return CHARACTER_NAME_MAX_LEN;
 			}
+
+			MessengerManager::instance().AddToBlockList(ch->GetName(), tch->GetName());
 		}
-		return CHARACTER_NAME_MAX_LEN;
+	}
+	return CHARACTER_NAME_MAX_LEN;
 
-		case MESSENGER_SUBHEADER_CG_BLOCK_REMOVE:
-		{
-			if (uiBytes < CHARACTER_NAME_MAX_LEN)
-				return -1;
+	case MESSENGER_SUBHEADER_CG_REMOVE_BLOCK:
+	{
+		if (uiBytes < CHARACTER_NAME_MAX_LEN)
+			return -1;
 
-			char szName[CHARACTER_NAME_MAX_LEN + 1] = {};
-			strlcpy(szName, c_pData, sizeof(szName));
+		char char_name[CHARACTER_NAME_MAX_LEN + 1];
+		strlcpy(char_name, c_pData, sizeof(char_name));
 
-			if (!CMessengerManager::instance().IsBlocked(c_lpChar->GetName(), szName))
-				return CHARACTER_NAME_MAX_LEN;
+		if (!MessengerManager::instance().IsBlocked(ch->GetName(), char_name))
+			return CHARACTER_NAME_MAX_LEN;
 
-			CMessengerManager::instance().RemoveFromBlockList(c_lpChar->GetName(), szName);
-		}
-		return CHARACTER_NAME_MAX_LEN;
+		MessengerManager::instance().RemoveFromBlockList(ch->GetName(), char_name);
+	}
+	return CHARACTER_NAME_MAX_LEN;
 #endif
 
-		default:
-			sys_err("CInputMain::Messenger : Unknown subheader %d : %s", c_pPacket->bSubHeader, c_lpChar->GetName());
-			break;
+	default:
+		sys_err("CInputMain::Messenger : Unknown subheader %d : %s", p->subheader, ch->GetName());
+		break;
 	}
 
 	return 0;
@@ -1351,47 +1898,47 @@
 
 	switch (p->subheader)
 	{
-		case SHOP_SUBHEADER_CG_END:
-			sys_log(1, "INPUT: %s SHOP: END", ch->GetName());
-			CShopManager::instance().StopShopping(ch);
-			return 0;
+	case SHOP_SUBHEADER_CG_END:
+		sys_log(1, "INPUT: %s SHOP: END", ch->GetName());
+		CShopManager::instance().StopShopping(ch);
+		return 0;
 
-		case SHOP_SUBHEADER_CG_BUY:
-		{
-			if (uiBytes < sizeof(BYTE) + sizeof(BYTE))
-				return -1;
+	case SHOP_SUBHEADER_CG_BUY:
+	{
+		if (uiBytes < sizeof(BYTE) + sizeof(BYTE))
+			return -1;
 
-			BYTE bPos = *(c_pData + 1);
-			sys_log(1, "INPUT: %s SHOP: BUY %d", ch->GetName(), bPos);
-			CShopManager::instance().Buy(ch, bPos);
-			return (sizeof(BYTE) + sizeof(BYTE));
-		}
+		BYTE bPos = *(c_pData + 1);
+		sys_log(1, "INPUT: %s SHOP: BUY %d", ch->GetName(), bPos);
+		CShopManager::instance().Buy(ch, bPos);
+		return (sizeof(BYTE) + sizeof(BYTE));
+	}
 
-		case SHOP_SUBHEADER_CG_SELL:
-		{
-			if (uiBytes < sizeof(BYTE))
-				return -1;
+	case SHOP_SUBHEADER_CG_SELL:
+	{
+		if (uiBytes < sizeof(BYTE))
+			return -1;
 
-			BYTE pos = *c_pData;
+		BYTE pos = *c_pData;
 
-			sys_log(0, "INPUT: %s SHOP: SELL", ch->GetName());
-			CShopManager::instance().Sell(ch, pos);
-			return sizeof(BYTE);
-		}
+		sys_log(0, "INPUT: %s SHOP: SELL", ch->GetName());
+		CShopManager::instance().Sell(ch, pos);
+		return sizeof(BYTE);
+	}
 
-		case SHOP_SUBHEADER_CG_SELL2:
-		{
-			const TPacketCGShopSell* p = reinterpret_cast<const TPacketCGShopSell*>(c_pData);
+	case SHOP_SUBHEADER_CG_SELL2:
+	{
+		const TPacketCGShopSell* p = reinterpret_cast<const TPacketCGShopSell*>(c_pData);
 
-			sys_log(0, "INPUT: %s SHOP: SELL2", ch->GetName());
+		sys_log(0, "INPUT: %s SHOP: SELL2", ch->GetName());
 
-			CShopManager::instance().Sell(ch, p->wPos, p->wCount, p->bType);
-			return sizeof(TPacketCGShopSell);
-		}
+		CShopManager::instance().Sell(ch, p->wPos, p->wCount, p->bType);
+		return sizeof(TPacketCGShopSell);
+	}
 
-		default:
-			sys_err("CInputMain::Shop : Unknown subheader %d : %s", p->subheader, ch->GetName());
-			break;
+	default:
+		sys_err("CInputMain::Shop : Unknown subheader %d : %s", p->subheader, ch->GetName());
+		break;
 	}
 
 	return 0;
@@ -1424,7 +1971,7 @@
 	{
 		if (iPulse - to_ch->GetSafeboxLoadTime() < PASSES_PER_SEC(g_nPortalLimitTime))
 		{
-			to_ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ŷ  %d ̳ â  ϴ.", g_nPortalLimitTime));
+			to_ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ŷ  %d ̳ â  ϴ."), g_nPortalLimitTime);
 			return;
 		}
 
@@ -1438,155 +1985,161 @@
 
 	if (iPulse - ch->GetSafeboxLoadTime() < PASSES_PER_SEC(g_nPortalLimitTime))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ŷ  %d ̳ â  ϴ.", g_nPortalLimitTime));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ŷ  %d ̳ â  ϴ."), g_nPortalLimitTime);
 		return;
 	}
 
 	switch (pinfo->sub_header)
 	{
-		case EXCHANGE_SUBHEADER_CG_START: // arg1 == vid of target character
-			if (!ch->GetExchange())
+	case EXCHANGE_SUBHEADER_CG_START: // arg1 == vid of target character
+		if (!ch->GetExchange())
+		{
+			if ((to_ch = CHARACTER_MANAGER::instance().Find(pinfo->arg1)))
 			{
-				if ((to_ch = CHARACTER_MANAGER::instance().Find(pinfo->arg1)))
+				//MONARCH_LIMIT
+				/*
+				if (to_ch->IsMonarch() || ch->IsMonarch())
 				{
-					//MONARCH_LIMIT
-					/*
-					if (to_ch->IsMonarch() || ch->IsMonarch())
-					{
-						ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ֿʹ ŷ Ҽ ϴ", g_nPortalLimitTime));
-						return;
-					}
-					//END_MONARCH_LIMIT
-					*/
-					if (iPulse - ch->GetSafeboxLoadTime() < PASSES_PER_SEC(g_nPortalLimitTime))
-					{
-						ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("â  %d ̳ ŷ Ҽ ϴ.", g_nPortalLimitTime));
+					ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ֿʹ ŷ Ҽ ϴ"), g_nPortalLimitTime);
+					return;
+				}
+				//END_MONARCH_LIMIT
+				*/
+				if (iPulse - ch->GetSafeboxLoadTime() < PASSES_PER_SEC(g_nPortalLimitTime))
+				{
+					ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("â  %d ̳ ŷ Ҽ ϴ."), g_nPortalLimitTime);
 
-						if (test_server)
-							ch->ChatPacket(CHAT_TYPE_INFO, "[TestOnly][Safebox]Pulse %d LoadTime %d PASS %d", iPulse, ch->GetSafeboxLoadTime(), PASSES_PER_SEC(g_nPortalLimitTime));
-						return;
-					}
+					if (test_server)
+						ch->ChatPacket(CHAT_TYPE_INFO, "[TestOnly][Safebox]Pulse %d LoadTime %d PASS %d", iPulse, ch->GetSafeboxLoadTime(), PASSES_PER_SEC(g_nPortalLimitTime));
+					return;
+				}
 
-					if (iPulse - to_ch->GetSafeboxLoadTime() < PASSES_PER_SEC(g_nPortalLimitTime))
-					{
-						to_ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("â  %d ̳ ŷ Ҽ ϴ.", g_nPortalLimitTime));
+				if (iPulse - to_ch->GetSafeboxLoadTime() < PASSES_PER_SEC(g_nPortalLimitTime))
+				{
+					to_ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("â  %d ̳ ŷ Ҽ ϴ."), g_nPortalLimitTime);
 
-						if (test_server)
-							to_ch->ChatPacket(CHAT_TYPE_INFO, "[TestOnly][Safebox]Pulse %d LoadTime %d PASS %d", iPulse, to_ch->GetSafeboxLoadTime(), PASSES_PER_SEC(g_nPortalLimitTime));
-						return;
-					}
+					if (test_server)
+						to_ch->ChatPacket(CHAT_TYPE_INFO, "[TestOnly][Safebox]Pulse %d LoadTime %d PASS %d", iPulse, to_ch->GetSafeboxLoadTime(), PASSES_PER_SEC(g_nPortalLimitTime));
+					return;
+				}
 
-					if (ch->GetGold() >= GOLD_MAX)
-					{
-						ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("׼ 20  ʰϿ ŷ Ҽ ϴ.."));
+				if (ch->GetGold() >= g_MaxGold)
+				{
+					ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("׼ 20  ʰϿ ŷ Ҽ ϴ.."));
 
-						sys_err("[OVERFLOG_GOLD] START (%d) id %u name %s ", ch->GetGold(), ch->GetPlayerID(), ch->GetName());
-						return;
-					}
+					sys_err("[OVERFLOG_GOLD] START (%u) id %u name %s ", ch->GetGold(), ch->GetPlayerID(), ch->GetName());
+					return;
+				}
 
 #if defined(__CHEQUE_SYSTEM__)
-					if (ch->GetCheque() > CHEQUE_MAX)
-					{
-						ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("׼ 20  ʰϿ ŷ Ҽ ϴ.."));
+				if (ch->GetCheque() > CHEQUE_MAX)
+				{
+					ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("׼ 20  ʰϿ ŷ Ҽ ϴ.."));
 
-						sys_err("[OVERFLOW_CHEQUE] START (%d) id %u name %s ", ch->GetCheque(), ch->GetPlayerID(), ch->GetName());
-						return;
-					}
+					sys_err("[OVERFLOW_CHEQUE] START (%lld) id %u name %s ", ch->GetCheque(), ch->GetPlayerID(), ch->GetName());
+					return;
+				}
 #endif
 
-					if (to_ch->IsPC())
-					{
-						if (quest::CQuestManager::instance().GiveItemToPC(ch->GetPlayerID(), to_ch))
-						{
-							sys_log(0, "Exchange canceled by quest %s %s", ch->GetName(), to_ch->GetName());
-							return;
-						}
-					}
-
-					if (ch->PreventTradeWindow(WND_EXCHANGE, true/*except*/))
+				if (to_ch->IsPC())
+				{
+					if (quest::CQuestManager::instance().GiveItemToPC(ch->GetPlayerID(), to_ch))
 					{
-						ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ٸ ŷϰ λ  ϴ."));
+						sys_log(0, "Exchange canceled by quest %s %s", ch->GetName(), to_ch->GetName());
 						return;
 					}
+				}
 
-					ch->ExchangeStart(to_ch);
+				if (ch->GetMyShop() || ch->IsOpenSafebox() || ch->GetShopOwner() || ch->IsCubeOpen()
+#ifdef __AURA_SYSTEM__
+				|| ch->IsAuraRefineWindowOpen()
+#endif
+				)
+				{
+					ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ٸ ŷϰ λ  ϴ."));
+					return;
 				}
-			}
-			break;
 
-		case EXCHANGE_SUBHEADER_CG_ITEM_ADD: // arg1 == position of item, arg2 == position in exchange window
-			if (ch->GetExchange())
-			{
-				if (ch->GetExchange()->GetCompany()->GetAcceptStatus() != true)
-					ch->GetExchange()->AddItem(pinfo->Pos, pinfo->arg2);
+				ch->ExchangeStart(to_ch);
 			}
-			break;
+		}
+		break;
 
-		case EXCHANGE_SUBHEADER_CG_ITEM_DEL: // arg1 == position of item
-			if (ch->GetExchange())
-			{
-				if (ch->GetExchange()->GetCompany()->GetAcceptStatus() != true)
-					ch->GetExchange()->RemoveItem(pinfo->arg1);
-			}
-			break;
+	case EXCHANGE_SUBHEADER_CG_ITEM_ADD: // arg1 == position of item, arg2 == position in exchange window
+		if (ch->GetExchange())
+		{
+			if (ch->GetExchange()->GetCompany()->GetAcceptStatus() != true)
+				ch->GetExchange()->AddItem(pinfo->Pos, pinfo->arg2);
+		}
+		break;
 
-		case EXCHANGE_SUBHEADER_CG_ELK_ADD: // arg1 == amount of gold
-			if (ch->GetExchange())
-			{
-				const int64_t nTotalGold = static_cast<int64_t>(ch->GetExchange()->GetCompany()->GetOwner()->GetGold()) + static_cast<int64_t>(pinfo->arg1);
-				if (GOLD_MAX <= nTotalGold)
-				{
-					ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot exchange as this would exceed the maximum amount of Yang."));
+	case EXCHANGE_SUBHEADER_CG_ITEM_DEL: // arg1 == position of item
+		if (ch->GetExchange())
+		{
+			if (ch->GetExchange()->GetCompany()->GetAcceptStatus() != true)
+				ch->GetExchange()->RemoveItem(pinfo->arg1);
+		}
+		break;
+
+	case EXCHANGE_SUBHEADER_CG_ELK_ADD: // arg1 == amount of gold
+		if (ch->GetExchange())
+		{
+			const long long nTotalGold = static_cast<long long>(ch->GetExchange()->GetCompany()->GetOwner()->GetGold()) + static_cast<long long>(pinfo->arg1);
 
-					sys_err("[OVERFLOW_GOLD] ELK_ADD (%d) id %u name %s ",
-						ch->GetExchange()->GetCompany()->GetOwner()->GetGold(),
-						ch->GetExchange()->GetCompany()->GetOwner()->GetPlayerID(),
-						ch->GetExchange()->GetCompany()->GetOwner()->GetName());
+			if (g_MaxGold <= nTotalGold)
+			{
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ѱݾ 20  ʰϿ ŷ Ҽ ϴ.."));
 
-					return;
-				}
+				sys_err("[OVERFLOW_GOLD] ELK_ADD (%lld) id %u name %s ",
+					ch->GetExchange()->GetCompany()->GetOwner()->GetGold(),
+					ch->GetExchange()->GetCompany()->GetOwner()->GetPlayerID(),
+					ch->GetExchange()->GetCompany()->GetOwner()->GetName());
 
-				if (ch->GetExchange()->GetCompany()->GetAcceptStatus() != true)
-					ch->GetExchange()->AddGold(pinfo->arg1);
+				return;
 			}
-			break;
 
-#if defined(__CHEQUE_SYSTEM__)
-		case EXCHANGE_SUBHEADER_CG_CHEQUE_ADD: // arg1 == amount of cheque
-			if (ch->GetExchange())
-			{
-				const int64_t nTotalCheque = static_cast<int64_t>(ch->GetExchange()->GetCompany()->GetOwner()->GetCheque()) + static_cast<int64_t>(pinfo->arg1);
+			if (ch->GetExchange()->GetCompany()->GetAcceptStatus() != true)
+				ch->GetExchange()->AddGold(pinfo->arg1);
+		}
+		break;
 
-				if (nTotalCheque > CHEQUE_MAX)
-				{
-					ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot exchange as this would exceed the maximum amount of Won."));
+#if defined(__CHEQUE_SYSTEM__)
+	case EXCHANGE_SUBHEADER_CG_CHEQUE_ADD: // arg1 == amount of cheque
+		if (ch->GetExchange())
+		{
+			const int64_t nTotalCheque = static_cast<int64_t>(ch->GetExchange()->GetCompany()->GetOwner()->GetCheque()) + static_cast<int64_t>(pinfo->arg1);
 
-					sys_err("[OVERFLOW_CHEQUE] CHEQUE_ADD (%u) id %u name %s ",
-						ch->GetExchange()->GetCompany()->GetOwner()->GetCheque(),
-						ch->GetExchange()->GetCompany()->GetOwner()->GetPlayerID(),
-						ch->GetExchange()->GetCompany()->GetOwner()->GetName());
+			if (CHEQUE_MAX <= nTotalCheque)
+			{
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ѱݾ 20  ʰϿ ŷ Ҽ ϴ.."));
 
-					return;
-				}
+				sys_err("[OVERFLOW_CHEQUE] CHEQUE_ADD (%u) id %u name %s ",
+					ch->GetExchange()->GetCompany()->GetOwner()->GetCheque(),
+					ch->GetExchange()->GetCompany()->GetOwner()->GetPlayerID(),
+					ch->GetExchange()->GetCompany()->GetOwner()->GetName());
 
-				if (ch->GetExchange()->GetCompany()->GetAcceptStatus() != true)
-					ch->GetExchange()->AddCheque(pinfo->arg1);
+				return;
 			}
-			break;
+
+			if (ch->GetExchange()->GetCompany()->GetAcceptStatus() != true)
+				ch->GetExchange()->AddCheque(pinfo->arg1);
+		}
+		break;
 #endif
 
-		case EXCHANGE_SUBHEADER_CG_ACCEPT: // arg1 == not used
-			if (ch->GetExchange())
-			{
-				sys_log(0, "CInputMain()::Exchange() ==> ACCEPT ");
-				ch->GetExchange()->Accept(true);
-			}
-			break;
+	case EXCHANGE_SUBHEADER_CG_ACCEPT: // arg1 == not used
+		if (ch->GetExchange())
+		{
+			sys_log(0, "CInputMain()::Exchange() ==> ACCEPT ");
+			ch->GetExchange()->Accept(true);
+		}
 
-		case EXCHANGE_SUBHEADER_CG_CANCEL: // arg1 == not used
-			if (ch->GetExchange())
-				ch->GetExchange()->Cancel();
-			break;
+		break;
+
+	case EXCHANGE_SUBHEADER_CG_CANCEL: // arg1 == not used
+		if (ch->GetExchange())
+			ch->GetExchange()->Cancel();
+		break;
 	}
 }
 
@@ -1596,17 +2149,17 @@
 
 	switch (pinfo->position)
 	{
-		case POSITION_GENERAL:
-			ch->Standup();
-			break;
+	case POSITION_GENERAL:
+		ch->Standup();
+		break;
 
-		case POSITION_SITTING_CHAIR:
-			ch->Sitdown(0);
-			break;
+	case POSITION_SITTING_CHAIR:
+		ch->Sitdown(0);
+		break;
 
-		case POSITION_SITTING_GROUND:
-			ch->Sitdown(1);
-			break;
+	case POSITION_SITTING_GROUND:
+		ch->Sitdown(1);
+		break;
 	}
 }
 
@@ -1855,14 +2408,10 @@
 
 	// ڷƮ  üũ
 
-	//if (!test_server) // 20120515  : ׼ (·) ټ   ٿǸ鼭 ݽ ޺ ״  ־.
+	//if (!test_server) // 2012.05.15  : ׼ (·) ټ   ٿǸ鼭 ݽ ޺ ״  ־.
 	{
 		const float fDist = DISTANCE_SQRT((ch->GetX() - pinfo->lX) / 100, (ch->GetY() - pinfo->lY) / 100);
-#ifdef MOUNT_FIX
-		if (((false == ch->IsRiding() && fDist > 750) || fDist > 999) && OXEVENT_MAP_INDEX != ch->GetMapIndex())
-#else
 		if (((false == ch->IsRiding() && fDist > 25) || fDist > 60) && OXEVENT_MAP_INDEX != ch->GetMapIndex())
-#endif
 		{
 			sys_log(0, "MOVE: %s trying to move too far (dist: %.1fm) Riding(%d)", ch->GetName(), fDist, ch->IsRiding());
 
@@ -1904,10 +2453,7 @@
 		//
 		if (pinfo->bFunc == FUNC_COMBO && g_bCheckMultiHack)
 		{
-			// DoS mitigation: rate-limit combo packets
-			if (ch->CheckComboFlood(dwCurTime))
-				return;
-			CheckComboHack(ch, pinfo->bArg, pinfo->dwTime, CheckSpeedHack);
+			CheckComboHack(ch, pinfo->bArg, pinfo->dwTime, CheckSpeedHack); // ޺ üũ
 		}
 	}
 
@@ -1916,8 +2462,8 @@
 		if (ch->GetLimitPoint(POINT_MOV_SPEED) == 0)
 			return;
 
-		ch->SetRotation(pinfo->bRot * 5);
-		ch->ResetStopTime();
+		ch->SetRotation(pinfo->bRot * 5); // ߺ ڵ
+		ch->ResetStopTime(); // ""
 
 		ch->Goto(pinfo->lX, pinfo->lY);
 	}
@@ -2002,13 +2548,41 @@
 	*/
 }
 
-void CInputMain::Attack(LPCHARACTER ch, const BYTE header, const char* data)
+#if defined(__SKILL_COLOR_SYSTEM__)
+void CInputMain::SetSkillColor(LPCHARACTER ch, const char* pcData)
 {
-	if (NULL == ch)
+	if (!ch)
 		return;
 
-	// [Security] Spectator/observer characters must never be able to attack (packet injection / ghost attack)
-	if (ch->IsObserverMode() || ch->IsDead())
+	TPacketCGSkillColor* CGPacket = (TPacketCGSkillColor*)pcData;
+
+	if (CGPacket->bSkillSlot >= ESkillColorLength::MAX_SKILL_COUNT)
+		return;
+
+	DWORD dwData[ESkillColorLength::MAX_SKILL_COUNT + ESkillColorLength::MAX_BUFF_COUNT][ESkillColorLength::MAX_EFFECT_COUNT];
+	memcpy(dwData, ch->GetSkillColor(), sizeof(dwData));
+
+	dwData[CGPacket->bSkillSlot][0] = CGPacket->dwCol1;
+	dwData[CGPacket->bSkillSlot][1] = CGPacket->dwCol2;
+	dwData[CGPacket->bSkillSlot][2] = CGPacket->dwCol3;
+	dwData[CGPacket->bSkillSlot][3] = CGPacket->dwCol4;
+	dwData[CGPacket->bSkillSlot][4] = CGPacket->dwCol5;
+
+	ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You have changed the color of your skill."));
+
+	ch->SetSkillColor(dwData[0]);
+
+	TSkillColor GDPacket;
+	memcpy(GDPacket.dwSkillColor, dwData, sizeof(dwData));
+	GDPacket.dwPlayerID = ch->GetPlayerID();
+	db_clientdesc->DBPacketHeader(HEADER_GD_SKILL_COLOR_SAVE, 0, sizeof(TSkillColor));
+	db_clientdesc->Packet(&GDPacket, sizeof(TSkillColor));
+}
+#endif
+
+void CInputMain::Attack(LPCHARACTER ch, const BYTE header, const char* data)
+{
+	if (NULL == ch)
 		return;
 
 	struct type_identifier
@@ -2028,85 +2602,82 @@
 
 		switch (type->type)
 		{
-			case SKILL_GEOMPUNG:
-			case SKILL_SANGONG:
-			case SKILL_YEONSA:
-			case SKILL_KWANKYEOK:
-			case SKILL_HWAJO:
-			case SKILL_GIGUNG:
-			case SKILL_PABEOB:
-			case SKILL_MARYUNG:
-			case SKILL_TUSOK:
+		case SKILL_GEOMPUNG:
+		case SKILL_SANGONG:
+		case SKILL_YEONSA:
+		case SKILL_KWANKYEOK:
+		case SKILL_HWAJO:
+		case SKILL_GIGUNG:
+		case SKILL_PABEOB:
+		case SKILL_MARYUNG:
+		case SKILL_TUSOK:
 #if defined(__9TH_SKILL__)
-			case SKILL_ILGWANGPYO:
-			case SKILL_PUNGLOEPO:
-			case SKILL_MABEOBAGGWI:
-			case SKILL_METEO:
-#endif
-			case SKILL_MAHWAN:
-			case SKILL_BIPABU:
-			case SKILL_NOEJEON:
-			case SKILL_CHAIN:
-			case SKILL_HORSE_WILDATTACK_RANGE:
-				if (HEADER_CG_SHOOT != type->header)
-				{
-					if (test_server)
-						ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Attack :name[%s] Vnum[%d] can't use skill by attack(warning)", type->type));
-					return;
-				}
-				break;
+		case SKILL_PUNGLOEPO:
+		case SKILL_ILGWANGPYO:
+		case SKILL_MABEOBAGGWI:
+		case SKILL_METEO:
+#endif
+		case SKILL_MAHWAN:
+		case SKILL_BIPABU:
+		case SKILL_NOEJEON:
+		case SKILL_CHAIN:
+		case SKILL_HORSE_WILDATTACK_RANGE:
+			if (HEADER_CG_SHOOT != type->header)
+			{
+				if (test_server)
+					ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Attack :name[%s] Vnum[%d] can't use skill by attack(warning)"), type->type);
+				return;
+			}
+			break;
 		}
 	}
 
 	switch (header)
 	{
-		case HEADER_CG_ATTACK:
-		{
-			if (NULL == ch->GetDesc())
-				return;
+	case HEADER_CG_ATTACK:
+	{
+		if (NULL == ch->GetDesc())
+			return;
 
-			const TPacketCGAttack* const packMelee = reinterpret_cast<const TPacketCGAttack*>(data);
+		const TPacketCGAttack* const packMelee = reinterpret_cast<const TPacketCGAttack*>(data);
 
-			ch->GetDesc()->AssembleCRCMagicCube(packMelee->bCRCMagicCubeProcPiece, packMelee->bCRCMagicCubeFilePiece);
+		ch->GetDesc()->AssembleCRCMagicCube(packMelee->bCRCMagicCubeProcPiece, packMelee->bCRCMagicCubeFilePiece);
 
-			LPCHARACTER victim = CHARACTER_MANAGER::instance().Find(packMelee->dwVID);
+		LPCHARACTER victim = CHARACTER_MANAGER::instance().Find(packMelee->dwVID);
 
-			if (NULL == victim || ch == victim)
-				return;
+		if (NULL == victim || ch == victim)
+			return;
 
-			switch (victim->GetCharType())
-			{
-				case CHAR_TYPE_NPC:
-				case CHAR_TYPE_WARP:
-				case CHAR_TYPE_GOTO:
-				case CHAR_TYPE_HORSE:
-					//#if defined(__GROWTH_PET_SYSTEM__)
-				case CHAR_TYPE_PET:
-					//#endif
-				case CHAR_TYPE_PET_PAY:
-				case CHAR_TYPE_SHOP:
-					return;
-			}
+		switch (victim->GetCharType())
+		{
+		case CHAR_TYPE_NPC:
+		case CHAR_TYPE_WARP:
+		case CHAR_TYPE_GOTO:
+		case CHAR_TYPE_HORSE:
+		case CHAR_TYPE_PET:
+		case CHAR_TYPE_PET_PAY:
+			return;
+		}
 
-			if (packMelee->bType > 0)
+		if (packMelee->bType > 0)
+		{
+			if (false == ch->CheckSkillHitCount(packMelee->bType, victim->GetVID()))
 			{
-				if (false == ch->CheckSkillHitCount(packMelee->bType, victim->GetVID()))
-				{
-					return;
-				}
+				return;
 			}
-
-			ch->Attack(victim, packMelee->bType);
 		}
-		break;
 
-		case HEADER_CG_SHOOT:
-		{
-			const TPacketCGShoot* const packShoot = reinterpret_cast<const TPacketCGShoot*>(data);
+		ch->Attack(victim, packMelee->bType);
+	}
+	break;
 
-			ch->Shoot(packShoot->bType);
-		}
-		break;
+	case HEADER_CG_SHOOT:
+	{
+		const TPacketCGShoot* const packShoot = reinterpret_cast<const TPacketCGShoot*>(data);
+
+		ch->Shoot(packShoot->bType);
+	}
+	break;
 	}
 }
 
@@ -2169,16 +2740,13 @@
 
 		switch (victim->GetCharType())
 		{
-			case CHAR_TYPE_NPC:
-			case CHAR_TYPE_WARP:
-			case CHAR_TYPE_GOTO:
-			case CHAR_TYPE_HORSE:
-				//#if defined(__GROWTH_PET_SYSTEM__)
-			case CHAR_TYPE_PET:
-				//#endif
-			case CHAR_TYPE_PET_PAY:
-			case CHAR_TYPE_SHOP:
-				continue;
+		case CHAR_TYPE_NPC:
+		case CHAR_TYPE_WARP:
+		case CHAR_TYPE_GOTO:
+		case CHAR_TYPE_HORSE:
+		case CHAR_TYPE_PET:
+		case CHAR_TYPE_PET_PAY:
+			continue;
 		}
 
 		//  ˻
@@ -2329,34 +2897,6 @@
 }
 // END_OF_SCRIPT_SELECT_ITEM
 
-#if defined(__GEM_SYSTEM__)
-void CInputMain::SelectItemEx(LPCHARACTER c_lpCh, const void* c_pvData)
-{
-	if (c_lpCh == nullptr)
-		return;
-
-	TPacketCGSelectItemEx* pPacket = (TPacketCGSelectItemEx*)c_pvData;
-	sys_log(0, "SelectItemEx player (pid: %d) item (pos: %d)", c_lpCh->GetPlayerID(), pPacket->dwItemPos);
-	c_lpCh->SelectItemEx(pPacket->dwItemPos, pPacket->bType);
-}
-#endif
-
-#if defined(__QUEST_REQUEST_EVENT__)
-void CInputMain::RequestEventQuest(LPCHARACTER pChar, const void* c_pvData)
-{
-	const TPacketCGRequestEventQuest* c_pData = reinterpret_cast<const TPacketCGRequestEventQuest*>(c_pvData);
-	unsigned int uiQuestIndex = quest::CQuestManager::instance().GetQuestIndexByName(c_pData->szEventQuest);
-	if (uiQuestIndex)
-	{
-		if (quest::CQuestManager::instance().GetPCForce(pChar->GetPlayerID())->IsRunning())
-			return;
-
-		sys_log(0, "QUEST RequestEventQuest pid(%d), qid(%d)", pChar->GetPlayerID(), uiQuestIndex);
-		quest::CQuestManager::instance().RequestEvent(pChar->GetPlayerID(), uiQuestIndex, 0);
-	}
-}
-#endif
-
 void CInputMain::QuestInputString(LPCHARACTER ch, const void* c_pData)
 {
 	TPacketCGQuestInputString* p = (TPacketCGQuestInputString*)c_pData;
@@ -2368,19 +2908,6 @@
 	quest::CQuestManager::Instance().Input(ch->GetPlayerID(), msg);
 }
 
-#if defined(__OX_RENEWAL__)
-void CInputMain::QuestInputLongString(LPCHARACTER ch, const void* c_pData)
-{
-	TPacketCGQuestInputLongString* p = (TPacketCGQuestInputLongString*)c_pData;
-
-	char msg[129];
-	strlcpy(msg, p->msg, sizeof(msg));
-	sys_log(0, "QUEST InputLongString pid %u msg %s", ch->GetPlayerID(), msg);
-
-	quest::CQuestManager::Instance().Input(ch->GetPlayerID(), msg);
-}
-#endif
-
 void CInputMain::QuestConfirm(LPCHARACTER ch, const void* c_pData)
 {
 	TPacketCGQuestConfirm* p = (TPacketCGQuestConfirm*)c_pData;
@@ -2390,7 +2917,7 @@
 	sys_log(0, "QuestConfirm from %s pid %u name %s answer %d", ch->GetName(), p->requestPID, (ch_wait) ? ch_wait->GetName() : "", p->answer);
 	if (ch_wait)
 	{
-		quest::CQuestManager::Instance().Confirm(ch_wait->GetPlayerID(), (quest::EQuestConfirmType)p->answer, ch->GetPlayerID());
+		quest::CQuestManager::Instance().Confirm(ch_wait->GetPlayerID(), (quest::EQuestConfirmType) p->answer, ch->GetPlayerID());
 	}
 }
 
@@ -2405,9 +2932,6 @@
 		TPacketGCTarget pckTarget;
 		pckTarget.header = HEADER_GC_TARGET;
 		pckTarget.dwVID = p->dwVID;
-#if defined(__DEFENSE_WAVE__)
-		pckTarget.bAlliance = false;
-#endif
 		ch->GetDesc()->Packet(&pckTarget, sizeof(TPacketGCTarget));
 	}
 	else
@@ -2429,81 +2953,66 @@
 	if (!ch->CanHandleItem())
 		return;
 
-	// [Security] Mutual exclusion: forbid safebox actions while other trade windows are open
-	if (!ch->IsOpenSafebox())
-		return;
-	if (ch->GetExchange() || ch->GetShop() || ch->GetMyShop() || ch->GetShopOwner() || ch->IsCubeOpen())
-		return;
-
 	CSafebox* pkSafebox = ch->GetSafebox();
 	LPITEM pkItem = ch->GetItem(p->ItemPos);
 
 	if (!pkSafebox || !pkItem)
 		return;
 
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	if (pkItem->GetCell() >= ch->GetExtendInvenMax() && IS_SET(pkItem->GetFlag(), ITEM_FLAG_IRREMOVABLE))
-#else
+	if (pkItem->GetType() == ITEM_BELT && pkItem->IsEquipped() && CBeltInventoryHelper::IsExistItemInBeltInventory(ch))
+	{
+		if (!CBeltInventoryHelper::ClearBelt(ch))
+			return;
+	}
+
 	if (pkItem->GetCell() >= INVENTORY_MAX_NUM && IS_SET(pkItem->GetFlag(), ITEM_FLAG_IRREMOVABLE))
-#endif
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<â> â ű    Դϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<â> â ű    Դϴ."));
 		return;
 	}
 
 	if (!pkSafebox->IsEmpty(p->bSafePos, pkItem->GetSize()))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<â> ű   ġԴϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<â> ű   ġԴϴ."));
 		return;
 	}
 
-	if (pkItem->GetSIGVnum() == UNIQUE_GROUP_LARGE_SAFEBOX)
+	if (pkItem->GetVnum() == UNIQUE_ITEM_SAFEBOX_EXPAND)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<â>     ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<â>     ϴ."));
 		return;
 	}
 
 	if (IS_SET(pkItem->GetAntiFlag(), ITEM_ANTIFLAG_SAFEBOX))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<â>     ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<â>     ϴ."));
 		return;
 	}
 
 	if (pkItem->IsEquipped())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Storeroom] An item that is currently being used cannot be stored."));
-		return;
-	}
-
-#if defined(__PET_SYSTEM__)
-	CPetSystem* pPetSystem = ch->GetPetSystem();
-	if (pPetSystem && pPetSystem->GetSummonItemVID() == pkItem->GetVID())
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Storeroom] An item that is currently being used cannot be stored."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("[Storeroom] An item that is currently being used cannot be stored."));
 		return;
 	}
-#endif
 
 	if (true == pkItem->isLocked())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<â>     ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<â>     ϴ."));
 		return;
 	}
 
-	// Prevent items from the belt inventory checking-in the safebox.
-	if (p->ItemPos.window_type == BELT_INVENTORY)
+	if (ITEM_BELT == pkItem->GetType() && CBeltInventoryHelper::IsExistItemInBeltInventory(ch))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Cannot proceed."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ʈ κ丮  ϸ   ϴ."));
 		return;
 	}
 
 	pkItem->RemoveFromCharacter();
-#if defined(__DRAGON_SOUL_SYSTEM__)
 	if (!pkItem->IsDragonSoul())
-#endif
-		ch->SyncQuickslot(SLOT_TYPE_INVENTORY, p->ItemPos.cell, WORD_MAX);
+		ch->SyncQuickslot(QUICKSLOT_TYPE_ITEM, p->ItemPos.cell, INT_MAX);
 
 	pkSafebox->Add(p->bSafePos, pkItem);
+
 #ifdef __GROWTH_PET_SYSTEM__
 	if (pkItem->GetType() == ITEM_PET)
 	{
@@ -2515,6 +3024,7 @@
 		}
 	}
 #endif
+
 	char szHint[128];
 	snprintf(szHint, sizeof(szHint), "%s %u", pkItem->GetName(), pkItem->GetCount());
 	LogManager::instance().ItemLog(ch, pkItem, "SAFEBOX PUT", szHint);
@@ -2527,12 +3037,6 @@
 	if (!ch->CanHandleItem())
 		return;
 
-	// [Security] Mutual exclusion: safebox operations must not be possible alongside exchange/shop/cube (packet overlap / dup prevention)
-	if (!bMall && !ch->IsOpenSafebox())
-		return;
-	if (ch->GetExchange() || ch->GetShop() || ch->GetMyShop() || ch->GetShopOwner() || ch->IsCubeOpen())
-		return;
-
 	CSafebox* pkSafebox;
 
 	if (bMall)
@@ -2544,71 +3048,38 @@
 		return;
 
 	LPITEM pkItem = pkSafebox->Get(p->bSafePos);
+
 	if (!pkItem)
 		return;
 
 	if (p->ItemPos.IsBeltInventoryPosition())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Cannot proceed."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You can't move items from your storage into your belt inventory."));
 		return;
 	}
 
-#if defined(__SAFEBOX_IMPROVING__)
-	if ((p->ItemPos.window_type == INVENTORY) && (p->ItemPos.cell == 0))
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	if (p->ItemPos.IsSkillBookInventoryPosition() && !pkItem->IsSkillBook())
 	{
-		BYTE bWindow = INVENTORY;
-		INT iCell = -1;
-
-#if defined(__DRAGON_SOUL_SYSTEM__)
-		if (pkItem->IsDragonSoul())
-		{
-			bWindow = DRAGON_SOUL_INVENTORY;
-			iCell = ch->GetEmptyDragonSoulInventory(pkItem);
-		}
-
-		else
-#endif
-		{
-			bWindow = INVENTORY;
-			iCell = ch->GetEmptyInventory(pkItem->GetSize());
-		}
-
-
-		if (iCell < 0)
-			return;
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You can only move skill books into this inventory."));
+		return;
+	}
 
-		pkSafebox->Remove(p->bSafePos);
-		if (bMall)
-		{
-			if (NULL == pkItem->GetProto())
-			{
-				sys_err("pkItem->GetProto() == NULL (id : %d)", pkItem->GetID());
-				return;
-			}
-			// 100% Ȯ Ӽ پ ϴµ  پִٸ  . ...............
-			if (100 == pkItem->GetProto()->bAlterToMagicItemPct && 0 == pkItem->GetAttributeCount())
-			{
-				pkItem->AlterToMagicItem(number(40, 50), number(10, 15));
-			}
-		}
-		pkItem->AddToCharacter(ch, TItemPos(bWindow, (WORD)iCell)
-#if defined(__WJ_PICKUP_ITEM_EFFECT__)
-			, false
-#endif
-		);
-		ITEM_MANAGER::Instance().FlushDelayedSave(pkItem);
-
-		DWORD dwID = pkItem->GetID();
-		db_clientdesc->DBPacketHeader(HEADER_GD_ITEM_FLUSH, 0, sizeof(DWORD));
-		db_clientdesc->Packet(&dwID, sizeof(DWORD));
+	if (p->ItemPos.IsUpgradeItemsInventoryPosition() && !pkItem->IsUpgradeItem())
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You can only move upgrade items into this inventory."));
+		return;
+	}
 
-		char szHint[128];
-		snprintf(szHint, sizeof(szHint), "%s %u", pkItem->GetName(), pkItem->GetCount());
-		if (bMall)
-			LogManager::instance().ItemLog(ch, pkItem, "MALL GET", szHint);
-		else
-			LogManager::instance().ItemLog(ch, pkItem, "SAFEBOX GET", szHint);
+	if (p->ItemPos.IsStoneInventoryPosition() && !pkItem->IsStone())
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You can only move stones into this inventory."));
+		return;
+	}
 
+	if (p->ItemPos.IsGiftBoxInventoryPosition() && !pkItem->IsGiftBox())
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You can only move chests into this inventory."));
 		return;
 	}
 #endif
@@ -2619,7 +3090,6 @@
 	//   κ ű κп ȥ Ư ó
 	// (   item_proto ǵȴ Ӽ ٱ ,
 	// ȥ ,  ó   Ӽ ϳ  ʰ ȴ.)
-#if defined(__DRAGON_SOUL_SYSTEM__)
 	if (pkItem->IsDragonSoul())
 	{
 		if (bMall)
@@ -2629,7 +3099,7 @@
 
 		if (DRAGON_SOUL_INVENTORY != p->ItemPos.window_type)
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<â> ű   ġԴϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<â> ű   ġԴϴ."));
 			return;
 		}
 
@@ -2639,7 +3109,7 @@
 			int iCell = ch->GetEmptyDragonSoulInventory(pkItem);
 			if (iCell < 0)
 			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<â> ű   ġԴϴ."));
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<â> ű   ġԴϴ."));
 				return;
 			}
 			DestPos = TItemPos(DRAGON_SOUL_INVENTORY, iCell);
@@ -2650,15 +3120,12 @@
 		ITEM_MANAGER::instance().FlushDelayedSave(pkItem);
 	}
 	else
-#endif
 	{
-#if defined(__DRAGON_SOUL_SYSTEM__)
 		if (DRAGON_SOUL_INVENTORY == p->ItemPos.window_type)
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<â> ű   ġԴϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<â> ű   ġԴϴ."));
 			return;
 		}
-#endif
 
 		pkSafebox->Remove(p->bSafePos);
 		if (bMall)
@@ -2704,12 +3171,6 @@
 	if (!ch->CanHandleItem())
 		return;
 
-	// [Security] Mutual exclusion: block safebox operations while other trade windows are open
-	if (!ch->IsOpenSafebox())
-		return;
-	if (ch->GetExchange() || ch->GetShop() || ch->GetMyShop() || ch->GetShopOwner() || ch->IsCubeOpen())
-		return;
-
 	if (!ch->GetSafebox())
 		return;
 
@@ -2724,21 +3185,13 @@
 
 	if (ch->GetArena())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("忡 Ͻ  ϴ."));
-		return;
-	}
-
-	if (m_iBufferLeft < (int)sizeof(TPacketCGPartyInvite))
-	{
-		sys_err("PARTY_INVITE: malformed packet (len=%d < %u)", m_iBufferLeft, (unsigned)sizeof(TPacketCGPartyInvite));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("忡 Ͻ  ϴ."));
 		return;
 	}
 
 	TPacketCGPartyInvite* p = (TPacketCGPartyInvite*)c_pData;
 
 	LPCHARACTER pInvitee = CHARACTER_MANAGER::instance().Find(p->vid);
-	if (ch == pInvitee)
-		return;
 
 	if (!pInvitee || !ch->GetDesc() || !pInvitee->GetDesc() || !pInvitee->IsPC() || !ch->IsPC())
 	{
@@ -2747,14 +3200,14 @@
 	}
 
 #if defined(__MESSENGER_BLOCK_SYSTEM__)
-	if (CMessengerManager::instance().IsBlocked(ch->GetName(), pInvitee->GetName()))
+	if (MessengerManager::instance().IsBlocked(ch->GetName(), pInvitee->GetName()))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Unblock %s to continue.", pInvitee->GetName()));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Unblock %s to continue."), pInvitee->GetName());
 		return;
 	}
-	else if (CMessengerManager::instance().IsBlocked(pInvitee->GetName(), ch->GetName()))
+	else if (MessengerManager::instance().IsBlocked(pInvitee->GetName(), ch->GetName()))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s has blocked you.", pInvitee->GetName()));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s has blocked you."), pInvitee->GetName());
 		return;
 	}
 #endif
@@ -2769,13 +3222,7 @@
 
 	if (ch->GetArena())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("忡 Ͻ  ϴ."));
-		return;
-	}
-
-	if (m_iBufferLeft < (int)sizeof(TPacketCGPartyInviteAnswer))
-	{
-		sys_err("PARTY_INVITE_ANSWER: malformed packet (len=%d < %u)", m_iBufferLeft, (unsigned)sizeof(TPacketCGPartyInviteAnswer));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("忡 Ͻ  ϴ."));
 		return;
 	}
 
@@ -2786,7 +3233,7 @@
 	// pInviter  ch  Ƽ û ߾.
 
 	if (!pInviter || !pInviter->IsPC())
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> Ƽû  ĳ͸ ã ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> Ƽû  ĳ͸ ã ϴ."));
 	else if (!p->accept)
 		pInviter->PartyInviteDeny(ch->GetPlayerID());
 	else
@@ -2798,7 +3245,7 @@
 {
 	if (!CPartyManager::instance().IsEnablePCParty())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>   Ƽ  ó   ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ>   Ƽ  ó   ϴ."));
 		return;
 	}
 
@@ -2809,20 +3256,13 @@
 
 	if (ch->GetParty()->GetLeaderPID() != ch->GetPlayerID())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>    ֽϴ."));
-		return;
-	}
-
-	// HARDENING: disallow assigning party roles to self (prevents spoofed packets / recursion edge-cases)
-	if (p->pid == ch->GetPlayerID() && p->byRole != PARTY_ROLE_NORMAL)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, "<Party> You cannot assign a party role to yourself.");
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ>    ֽϴ."));
 		return;
 	}
 
 	if (!ch->GetParty()->IsMember(p->pid))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> ¸ Ϸ  Ƽ ƴմϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> ¸ Ϸ  Ƽ ƴմϴ."));
 		return;
 	}
 
@@ -2831,33 +3271,33 @@
 
 	switch (p->byRole)
 	{
-		case PARTY_ROLE_NORMAL:
-			break;
+	case PARTY_ROLE_NORMAL:
+		break;
 
-		case PARTY_ROLE_ATTACKER:
-		case PARTY_ROLE_TANKER:
-		case PARTY_ROLE_BUFFER:
-		case PARTY_ROLE_SKILL_MASTER:
-		case PARTY_ROLE_HASTE:
-		case PARTY_ROLE_DEFENDER:
-			if (ch->GetParty()->SetRole(pid, p->byRole, p->flag))
-			{
-				TPacketPartyStateChange pack;
-				pack.dwLeaderPID = ch->GetPlayerID();
-				pack.dwPID = p->pid;
-				pack.bRole = p->byRole;
-				pack.bFlag = p->flag;
-				db_clientdesc->DBPacket(HEADER_GD_PARTY_STATE_CHANGE, 0, &pack, sizeof(pack));
-			}
-			/*
-			else
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> Ŀ  Ͽϴ."));
-			*/
-			break;
+	case PARTY_ROLE_ATTACKER:
+	case PARTY_ROLE_TANKER:
+	case PARTY_ROLE_BUFFER:
+	case PARTY_ROLE_SKILL_MASTER:
+	case PARTY_ROLE_HASTE:
+	case PARTY_ROLE_DEFENDER:
+		if (ch->GetParty()->SetRole(pid, p->byRole, p->flag))
+		{
+			TPacketPartyStateChange pack;
+			pack.dwLeaderPID = ch->GetPlayerID();
+			pack.dwPID = p->pid;
+			pack.bRole = p->byRole;
+			pack.bFlag = p->flag;
+			db_clientdesc->DBPacket(HEADER_GD_PARTY_STATE_CHANGE, 0, &pack, sizeof(pack));
+		}
+		/*
+		else
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> Ŀ  Ͽϴ."));
+		*/
+		break;
 
-		default:
-			sys_err("wrong byRole in PartySetState Packet name %s state %d", ch->GetName(), p->byRole);
-			break;
+	default:
+		sys_err("wrong byRole in PartySetState Packet name %s state %d", ch->GetName(), p->byRole);
+		break;
 	}
 }
 
@@ -2865,58 +3305,36 @@
 {
 	if (ch->GetArena())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("忡 Ͻ  ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("忡 Ͻ  ϴ."));
 		return;
 	}
 
 	if (!CPartyManager::instance().IsEnablePCParty())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>   Ƽ  ó   ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ>   Ƽ  ó   ϴ."));
 		return;
 	}
 
-#if defined(__GUILD_DRAGONLAIR_PARTY_SYSTEM__)
-	if (ch->GetGuildDragonLair())
+	if (ch->GetDungeon())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot disband the group while you are still active in Meley's Lair."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ>  ȿ Ƽ ߹  ϴ."));
 		return;
 	}
-#endif
 
 	TPacketCGPartyRemove* p = (TPacketCGPartyRemove*)c_pData;
-	LPPARTY pParty = ch->GetParty();
 
-	if (!pParty)
-		return;
-
-	if (pParty->GetDungeon_for_Only_party())
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>  ȿ Ƽ   ϴ."));
+	if (!ch->GetParty())
 		return;
-	}
 
+	LPPARTY pParty = ch->GetParty();
 	if (pParty->GetLeaderPID() == ch->GetPlayerID())
 	{
-		if (ch->GetDungeon()
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-			|| ch->GetGuildDragonLair()
-#endif
-#if defined(__DEFENSE_WAVE__)
-			|| ch->GetDefenseWave()
-#endif
-			)
+		if (ch->GetDungeon())
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>  Ƽ ߹  ϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ>  Ƽ ߹  ϴ."));
 		}
 		else
 		{
-#ifdef ENABLE_QUEEN_NETHIS
-			if (SnakeLair::CSnk::instance().IsSnakeMap(ch->GetMapIndex()))
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>  Ƽ ߹  ϴ."));
-				return;
-			}
-#endif
 			// leader can remove any member
 			if (p->pid == ch->GetPlayerID() || pParty->GetMemberCount() == 2)
 			{
@@ -2929,7 +3347,7 @@
 				if (B)
 				{
 					//pParty->SendPartyRemoveOneToAll(B);
-					B->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> Ƽ ߹ϼ̽ϴ."));
+					B->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> Ƽ ߹ϼ̽ϴ."));
 					//pParty->Unlink(B);
 					//CPartyManager::instance().SetPartyMember(B->GetPlayerID(), NULL);
 				}
@@ -2942,26 +3360,12 @@
 		// otherwise, only remove itself
 		if (p->pid == ch->GetPlayerID())
 		{
-			if (ch->GetDungeon()
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-				|| ch->GetGuildDragonLair()
-#endif
-#if defined(__DEFENSE_WAVE__)
-				|| ch->GetDefenseWave()
-#endif
-				)
+			if (ch->GetDungeon())
 			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>  Ƽ   ϴ."));
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ>  Ƽ   ϴ."));
 			}
 			else
 			{
-#ifdef ENABLE_QUEEN_NETHIS
-				if (SnakeLair::CSnk::instance().IsSnakeMap(ch->GetMapIndex()))
-				{
-					ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ>  Ƽ ߹  ϴ."));
-					return;
-				}
-#endif
 				if (pParty->GetMemberCount() == 2)
 				{
 					// party disband
@@ -2969,7 +3373,7 @@
 				}
 				else
 				{
-					ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> Ƽ ̽ϴ."));
+					ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> Ƽ ̽ϴ."));
 					//pParty->SendPartyRemoveOneToAll(ch);
 					pParty->Quit(ch->GetPlayerID());
 					//pParty->SendPartyRemoveAllToOne(ch);
@@ -2979,7 +3383,7 @@
 		}
 		else
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> ٸ Ƽ Żų  ϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> ٸ Ƽ Żų  ϴ."));
 		}
 	}
 }
@@ -2991,22 +3395,19 @@
 	if (ch->GetGold() < 200000)
 		return;
 
-	if (ch->GetLevel() < 40)
-		return;
-
 	if (get_global_time() - ch->GetQuestFlag("guild_manage.new_disband_time") <
 		CGuildManager::instance().GetDisbandDelay())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> ػ  %d ̳ 带   ϴ.",
-			quest::CQuestManager::instance().GetEventFlag("guild_disband_delay")));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> ػ  %d ̳ 带   ϴ."),
+			quest::CQuestManager::instance().GetEventFlag("guild_disband_delay"));
 		return;
 	}
 
 	if (get_global_time() - ch->GetQuestFlag("guild_manage.new_withdraw_time") <
 		CGuildManager::instance().GetWithdrawDelay())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> Ż  %d ̳ 带   ϴ.",
-			quest::CQuestManager::instance().GetEventFlag("guild_withdraw_delay")));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> Ż  %d ̳ 带   ϴ."),
+			quest::CQuestManager::instance().GetEventFlag("guild_withdraw_delay"));
 		return;
 	}
 
@@ -3023,7 +3424,7 @@
 
 	if (cp.name[0] == 0 || !check_name(cp.name))
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("   ̸ Դϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("   ̸ Դϴ."));
 		return;
 	}
 
@@ -3031,7 +3432,7 @@
 
 	if (dwGuildID)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> [%s] 尡 Ǿϴ.", cp.name));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> [%s] 尡 Ǿϴ."), cp.name);
 
 		int GuildCreateFee;
 
@@ -3054,13 +3455,9 @@
 		if (g_iUseLocale)
 			ch->RemoveSpecifyItem(GUILD_CREATE_ITEM_VNUM, 1);
 		//ch->SendGuildName(dwGuildID);
-
-#if defined(__GUILD_EVENT_FLAG__) //&& defined(__GUILD_RENEWAL__)
-		CGuildManager::Instance().RequestSetEventFlag(dwGuildID, "create_time", get_global_time());
-#endif
 	}
 	else
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>   Ͽϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>   Ͽϴ."));
 }
 
 void CInputMain::PartyUseSkill(LPCHARACTER ch, const char* c_pData)
@@ -3071,24 +3468,24 @@
 
 	if (ch->GetPlayerID() != ch->GetParty()->GetLeaderPID())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> Ƽ  Ƽ常   ֽϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> Ƽ  Ƽ常   ֽϴ."));
 		return;
 	}
 
 	switch (p->bySkillIndex)
 	{
-		case PARTY_SKILL_HEAL:
-			ch->GetParty()->HealParty();
-			break;
-		case PARTY_SKILL_WARP:
-		{
-			LPCHARACTER pch = CHARACTER_MANAGER::instance().Find(p->vid);
-			if (pch && pch->IsPC())
-				ch->GetParty()->SummonToLeader(pch->GetPlayerID());
-			else
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ƽ> ȯϷ  ã  ϴ."));
-		}
+	case PARTY_SKILL_HEAL:
+		ch->GetParty()->HealParty();
 		break;
+	case PARTY_SKILL_WARP:
+	{
+		LPCHARACTER pch = CHARACTER_MANAGER::instance().Find(p->vid);
+		if (pch && pch->IsPC())
+			ch->GetParty()->SummonToLeader(pch->GetPlayerID());
+		else
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<Ƽ> ȯϷ  ã  ϴ."));
+	}
+	break;
 	}
 }
 
@@ -3096,7 +3493,7 @@
 {
 	TPacketCGPartyParameter* p = (TPacketCGPartyParameter*)c_pData;
 
-	if (ch->GetParty() && ch->GetParty()->GetLeaderPID() == ch->GetPlayerID())
+	if (ch->GetParty())
 		ch->GetParty()->SetParameter(p->bDistributeMode);
 }
 
@@ -3104,21 +3501,21 @@
 {
 	switch (header)
 	{
-		case GUILD_SUBHEADER_CG_DEPOSIT_MONEY: return sizeof(int);
-		case GUILD_SUBHEADER_CG_WITHDRAW_MONEY: return sizeof(int);
-		case GUILD_SUBHEADER_CG_ADD_MEMBER: return sizeof(DWORD);
-		case GUILD_SUBHEADER_CG_REMOVE_MEMBER: return sizeof(DWORD);
-		case GUILD_SUBHEADER_CG_CHANGE_GRADE_NAME: return 10;
-		case GUILD_SUBHEADER_CG_CHANGE_GRADE_AUTHORITY: return sizeof(BYTE) + sizeof(BYTE);
-		case GUILD_SUBHEADER_CG_OFFER: return sizeof(DWORD);
-		case GUILD_SUBHEADER_CG_CHARGE_GSP: return sizeof(int);
-		case GUILD_SUBHEADER_CG_POST_COMMENT: return 1;
-		case GUILD_SUBHEADER_CG_DELETE_COMMENT: return sizeof(DWORD);
-		case GUILD_SUBHEADER_CG_REFRESH_COMMENT: return 0;
-		case GUILD_SUBHEADER_CG_CHANGE_MEMBER_GRADE: return sizeof(DWORD) + sizeof(BYTE);
-		case GUILD_SUBHEADER_CG_USE_SKILL: return sizeof(TPacketCGGuildUseSkill);
-		case GUILD_SUBHEADER_CG_CHANGE_MEMBER_GENERAL: return sizeof(DWORD) + sizeof(BYTE);
-		case GUILD_SUBHEADER_CG_GUILD_INVITE_ANSWER: return sizeof(DWORD) + sizeof(BYTE);
+	case GUILD_SUBHEADER_CG_DEPOSIT_MONEY: return sizeof(int);
+	case GUILD_SUBHEADER_CG_WITHDRAW_MONEY: return sizeof(int);
+	case GUILD_SUBHEADER_CG_ADD_MEMBER: return sizeof(DWORD);
+	case GUILD_SUBHEADER_CG_REMOVE_MEMBER: return sizeof(DWORD);
+	case GUILD_SUBHEADER_CG_CHANGE_GRADE_NAME: return 10;
+	case GUILD_SUBHEADER_CG_CHANGE_GRADE_AUTHORITY: return sizeof(BYTE) + sizeof(BYTE);
+	case GUILD_SUBHEADER_CG_OFFER: return sizeof(DWORD);
+	case GUILD_SUBHEADER_CG_CHARGE_GSP: return sizeof(int);
+	case GUILD_SUBHEADER_CG_POST_COMMENT: return 1;
+	case GUILD_SUBHEADER_CG_DELETE_COMMENT: return sizeof(DWORD);
+	case GUILD_SUBHEADER_CG_REFRESH_COMMENT: return 0;
+	case GUILD_SUBHEADER_CG_CHANGE_MEMBER_GRADE: return sizeof(DWORD) + sizeof(BYTE);
+	case GUILD_SUBHEADER_CG_USE_SKILL: return sizeof(TPacketCGGuildUseSkill);
+	case GUILD_SUBHEADER_CG_CHANGE_MEMBER_GENERAL: return sizeof(DWORD) + sizeof(BYTE);
+	case GUILD_SUBHEADER_CG_GUILD_INVITE_ANSWER: return sizeof(DWORD) + sizeof(BYTE);
 	}
 
 	return 0;
@@ -3148,353 +3545,350 @@
 	{
 		if (SubHeader != GUILD_SUBHEADER_CG_GUILD_INVITE_ANSWER)
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> 忡  ʽϴ."));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> 忡  ʽϴ."));
 			return SubPacketLen;
 		}
 	}
 
 	switch (SubHeader)
 	{
-		case GUILD_SUBHEADER_CG_DEPOSIT_MONEY:
+	case GUILD_SUBHEADER_CG_DEPOSIT_MONEY:
+	{
+		// by mhh : ڱ а   .
+		return SubPacketLen;
+
+		const int gold = MIN(*reinterpret_cast<const int*>(c_pData), __deposit_limit());
+
+		if (gold < 0)
 		{
-			// by mhh : ڱ а   .
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> ߸ ݾԴϴ."));
 			return SubPacketLen;
+		}
 
-			const int gold = MIN(*reinterpret_cast<const int*>(c_pData), __deposit_limit());
+		if (ch->GetGold() < gold)
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>  ִ  մϴ."));
+			return SubPacketLen;
+		}
 
-			if (gold < 0)
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> ߸ ݾԴϴ."));
-				return SubPacketLen;
-			}
+		pGuild->RequestDepositMoney(ch, gold);
+	}
+	return SubPacketLen;
 
-			if (ch->GetGold() < gold)
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>  ִ  մϴ."));
-				return SubPacketLen;
-			}
+	case GUILD_SUBHEADER_CG_WITHDRAW_MONEY:
+	{
+		// by mhh : ڱ а   .
+		return SubPacketLen;
+
+		const int gold = MIN(*reinterpret_cast<const int*>(c_pData), 500000);
 
-			pGuild->RequestDepositMoney(ch, gold);
+		if (gold < 0)
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> ߸ ݾԴϴ."));
+			return SubPacketLen;
 		}
-		return SubPacketLen;
 
-		case GUILD_SUBHEADER_CG_WITHDRAW_MONEY:
+		pGuild->RequestWithdrawMoney(ch, gold);
+	}
+	return SubPacketLen;
+
+	case GUILD_SUBHEADER_CG_ADD_MEMBER:
+	{
+		const DWORD vid = *reinterpret_cast<const DWORD*>(c_pData);
+		LPCHARACTER newmember = CHARACTER_MANAGER::instance().Find(vid);
+
+		if (!newmember)
 		{
-			// by mhh : ڱ а   .
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> ׷  ã  ϴ."));
 			return SubPacketLen;
+		}
 
-			const int gold = MIN(*reinterpret_cast<const int*>(c_pData), 500000);
+		if (!ch->IsPC() || !newmember->IsPC())
+			return SubPacketLen;
 
-			if (gold < 0)
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> ߸ ݾԴϴ."));
-				return SubPacketLen;
-			}
+#if defined(__MESSENGER_BLOCK_SYSTEM__)
+		if (MessengerManager::instance().IsBlocked(ch->GetName(), newmember->GetName()))
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Unblock %s to continue."), newmember->GetName());
+			return SubPacketLen;
+		}
+		else if (MessengerManager::instance().IsBlocked(newmember->GetName(), ch->GetName()))
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s has blocked you."), newmember->GetName());
+			return SubPacketLen;
+		}
+#endif
 
-			pGuild->RequestWithdrawMoney(ch, gold);
+		if (newmember->GetQuestFlag("change_guild_master.be_other_member") > get_global_time())
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>     ĳԴϴ"));
+			return SubPacketLen;
 		}
-		return SubPacketLen;
 
-		case GUILD_SUBHEADER_CG_ADD_MEMBER:
+		pGuild->Invite(ch, newmember);
+	}
+	return SubPacketLen;
+
+	case GUILD_SUBHEADER_CG_REMOVE_MEMBER:
+	{
+		if (pGuild->UnderAnyWar() != 0)
 		{
-			const DWORD vid = *reinterpret_cast<const DWORD*>(c_pData);
-			LPCHARACTER newmember = CHARACTER_MANAGER::instance().Find(vid);
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>  ߿  Żų  ϴ."));
+			return SubPacketLen;
+		}
 
-			if (!newmember)
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> ׷  ã  ϴ."));
-				return SubPacketLen;
-			}
+		const DWORD pid = *reinterpret_cast<const DWORD*>(c_pData);
+		const TGuildMember* m = pGuild->GetMember(ch->GetPlayerID());
 
-			if (!ch->IsPC() || !newmember->IsPC())
-				return SubPacketLen;
+		if (NULL == m)
+			return -1;
 
-#if defined(__MESSENGER_BLOCK_SYSTEM__)
-			if (CMessengerManager::instance().IsBlocked(ch->GetName(), newmember->GetName()))
+		LPCHARACTER member = CHARACTER_MANAGER::instance().FindByPID(pid);
+
+		if (member)
+		{
+			if (member->GetGuild() != pGuild)
 			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Unblock %s to continue.", newmember->GetName()));
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>   尡 ƴմϴ."));
 				return SubPacketLen;
 			}
-			else if (CMessengerManager::instance().IsBlocked(newmember->GetName(), ch->GetName()))
+
+			if (!pGuild->HasGradeAuth(m->grade, GUILD_AUTH_REMOVE_MEMBER))
 			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s has blocked you.", newmember->GetName()));
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>   Ż ų  ϴ."));
 				return SubPacketLen;
 			}
-#endif
 
-			if (newmember->GetQuestFlag("change_guild_master.be_other_member") > get_global_time())
+			member->SetQuestFlag("guild_manage.new_withdraw_time", get_global_time());
+			pGuild->RequestRemoveMember(member->GetPlayerID());
+
+			if (LC_IsBrazil() == true)
 			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>     ĳԴϴ"));
-				return SubPacketLen;
+				DBManager::instance().Query("REPLACE INTO guild_invite_limit VALUES(%d, %d)", pGuild->GetID(), get_global_time());
 			}
-
-			pGuild->Invite(ch, newmember);
 		}
-		return SubPacketLen;
-
-		case GUILD_SUBHEADER_CG_REMOVE_MEMBER:
+		else
 		{
-			if (pGuild->UnderAnyWar() != 0)
+			if (!pGuild->HasGradeAuth(m->grade, GUILD_AUTH_REMOVE_MEMBER))
 			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>  ߿  Żų  ϴ."));
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>   Ż ų  ϴ."));
 				return SubPacketLen;
 			}
 
-			const DWORD pid = *reinterpret_cast<const DWORD*>(c_pData);
-			const TGuildMember* m = pGuild->GetMember(ch->GetPlayerID());
-
-			if (NULL == m)
-				return -1;
-
-			LPCHARACTER member = CHARACTER_MANAGER::instance().FindByPID(pid);
-
-			if (member)
-			{
-				if (member->GetGuild() != pGuild)
-				{
-					ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>   尡 ƴմϴ."));
-					return SubPacketLen;
-				}
+			if (pGuild->RequestRemoveMember(pid))
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>   Ż ׽ϴ."));
+			else
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> ׷  ã  ϴ."));
+		}
+	}
+	return SubPacketLen;
 
-				if (!pGuild->HasGradeAuth(m->grade, GUILD_AUTH_REMOVE_MEMBER))
-				{
-					ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>   Ż ų  ϴ."));
-					return SubPacketLen;
-				}
+	case GUILD_SUBHEADER_CG_CHANGE_GRADE_NAME:
+	{
+		char gradename[GUILD_GRADE_NAME_MAX_LEN + 1];
+		strlcpy(gradename, c_pData + 1, sizeof(gradename));
 
-				member->SetQuestFlag("guild_manage.new_withdraw_time", get_global_time());
-				pGuild->RequestRemoveMember(member->GetPlayerID());
+		const TGuildMember* m = pGuild->GetMember(ch->GetPlayerID());
 
-				if (LC_IsBrazil() == true)
-				{
-					DBManager::instance().Query("REPLACE INTO guild_invite_limit VALUES(%d, %d)", pGuild->GetID(), get_global_time());
-				}
-			}
-			else
-			{
-				if (!pGuild->HasGradeAuth(m->grade, GUILD_AUTH_REMOVE_MEMBER))
-				{
-					ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>   Ż ų  ϴ."));
-					return SubPacketLen;
-				}
+		if (NULL == m)
+			return -1;
 
-				if (pGuild->RequestRemoveMember(pid))
-					ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>   Ż ׽ϴ."));
-				else
-					ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> ׷  ã  ϴ."));
-			}
+		if (m->grade != GUILD_LEADER_GRADE)
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>  ̸   ϴ."));
 		}
-		return SubPacketLen;
-
-		case GUILD_SUBHEADER_CG_CHANGE_GRADE_NAME:
+		else if (*c_pData == GUILD_LEADER_GRADE)
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>   ̸   ϴ."));
+		}
+		else if (!check_name(gradename))
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>    ̸ Դϴ."));
+		}
+		else
 		{
-			char gradename[GUILD_GRADE_NAME_MAX_LEN + 1];
-			strlcpy(gradename, c_pData + 1, sizeof(gradename));
+			pGuild->ChangeGradeName(*c_pData, gradename);
+		}
+	}
+	return SubPacketLen;
 
-			const TGuildMember* m = pGuild->GetMember(ch->GetPlayerID());
+	case GUILD_SUBHEADER_CG_CHANGE_GRADE_AUTHORITY:
+	{
+		const TGuildMember* m = pGuild->GetMember(ch->GetPlayerID());
 
-			if (NULL == m)
-				return -1;
+		if (NULL == m)
+			return -1;
 
-			if (m->grade != GUILD_LEADER_GRADE)
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>  ̸   ϴ."));
-			}
-			else if (*c_pData == GUILD_LEADER_GRADE)
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>   ̸   ϴ."));
-			}
-			else if (!check_name(gradename))
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>    ̸ Դϴ."));
-			}
-			else
-			{
-				pGuild->ChangeGradeName(*c_pData, gradename);
-			}
+		if (m->grade != GUILD_LEADER_GRADE)
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>     ϴ."));
 		}
-		return SubPacketLen;
-
-		case GUILD_SUBHEADER_CG_CHANGE_GRADE_AUTHORITY:
+		else if (*c_pData == GUILD_LEADER_GRADE)
 		{
-			const TGuildMember* m = pGuild->GetMember(ch->GetPlayerID());
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>     ϴ."));
+		}
+		else
+		{
+			pGuild->ChangeGradeAuth(*c_pData, *(c_pData + 1));
+		}
+	}
+	return SubPacketLen;
 
-			if (NULL == m)
-				return -1;
+	case GUILD_SUBHEADER_CG_OFFER:
+	{
+		DWORD offer = *reinterpret_cast<const DWORD*>(c_pData);
 
-			if (m->grade != GUILD_LEADER_GRADE)
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>     ϴ."));
-			}
-			else if (*c_pData == GUILD_LEADER_GRADE)
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>     ϴ."));
-			}
-			else
-			{
-				pGuild->ChangeGradeAuth(*c_pData, *(c_pData + 1));
-			}
+		if (pGuild->GetLevel() >= GUILD_MAX_LEVEL && LC_IsHongKong() == false)
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> 尡 ̹ ְ Դϴ."));
 		}
-		return SubPacketLen;
-
-		case GUILD_SUBHEADER_CG_OFFER:
+		else
 		{
-			DWORD offer = *reinterpret_cast<const DWORD*>(c_pData);
+			offer /= 100;
+			offer *= 100;
 
-			if (pGuild->GetLevel() >= GUILD_MAX_LEVEL && LC_IsHongKong() == false)
+			if (pGuild->OfferExp(ch, offer))
 			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> 尡 ̹ ְ Դϴ."));
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> %u ġ Ͽϴ."), offer);
 			}
 			else
 			{
-				offer /= 100;
-				offer *= 100;
-
-				if (pGuild->OfferExp(ch, offer))
-				{
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-					ch->UpdateExtBattlePassMissionProgress(GUILD_SPENT_EXP, offer, 0);
-#endif
-					ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> %u ġ Ͽϴ.", offer));
-				}
-				else
-				{
-					ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> ġ ڿ Ͽϴ."));
-				}
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> ġ ڿ Ͽϴ."));
 			}
 		}
-		return SubPacketLen;
-
-		case GUILD_SUBHEADER_CG_CHARGE_GSP:
-		{
-			const int offer = *reinterpret_cast<const int*>(c_pData);
-			const int gold = offer * 100;
+	}
+	return SubPacketLen;
 
-			if (offer < 0 || gold < offer || gold < 0 || ch->GetGold() < gold)
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>  մϴ."));
-				return SubPacketLen;
-			}
+	case GUILD_SUBHEADER_CG_CHARGE_GSP:
+	{
+		const int offer = *reinterpret_cast<const int*>(c_pData);
+		const int gold = offer * 100;
 
-			if (!pGuild->ChargeSP(ch, offer))
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> ŷ ȸ Ͽϴ."));
-			}
+		if (offer < 0 || gold < offer || gold < 0 || ch->GetGold() < gold)
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>  մϴ."));
+			return SubPacketLen;
 		}
-		return SubPacketLen;
 
-		case GUILD_SUBHEADER_CG_POST_COMMENT:
+		if (!pGuild->ChargeSP(ch, offer))
 		{
-			const size_t length = *c_pData;
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> ŷ ȸ Ͽϴ."));
+		}
+	}
+	return SubPacketLen;
 
-			if (length > GUILD_COMMENT_MAX_LEN)
-			{
-				// ߸ .. .
-				sys_err("POST_COMMENT: %s comment too long (length: %u)", ch->GetName(), length);
-				ch->GetDesc()->SetPhase(PHASE_CLOSE);
-				return -1;
-			}
+	case GUILD_SUBHEADER_CG_POST_COMMENT:
+	{
+		const size_t length = *c_pData;
 
-			if (uiBytes < 1 + length)
-				return -1;
+		if (length > GUILD_COMMENT_MAX_LEN)
+		{
+			// ߸ .. .
+			sys_err("POST_COMMENT: %s comment too long (length: %u)", ch->GetName(), length);
+			ch->GetDesc()->SetPhase(PHASE_CLOSE);
+			return -1;
+		}
 
-			const TGuildMember* m = pGuild->GetMember(ch->GetPlayerID());
+		if (uiBytes < 1 + length)
+			return -1;
 
-			if (NULL == m)
-				return -1;
+		const TGuildMember* m = pGuild->GetMember(ch->GetPlayerID());
 
-			if (length && !pGuild->HasGradeAuth(m->grade, GUILD_AUTH_NOTICE) && *(c_pData + 1) == '!')
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>  ۼ  ϴ."));
-			}
-			else
-			{
-				std::string str(c_pData + 1, length);
-				pGuild->AddComment(ch, str);
-			}
+		if (NULL == m)
+			return -1;
 
-			return (1 + length);
+		if (length && !pGuild->HasGradeAuth(m->grade, GUILD_AUTH_NOTICE) && *(c_pData + 1) == '!')
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>  ۼ  ϴ."));
 		}
-
-		case GUILD_SUBHEADER_CG_DELETE_COMMENT:
+		else
 		{
-			const DWORD comment_id = *reinterpret_cast<const DWORD*>(c_pData);
-
-			pGuild->DeleteComment(ch, comment_id);
+			std::string str(c_pData + 1, length);
+			pGuild->AddComment(ch, str);
 		}
-		return SubPacketLen;
 
-		case GUILD_SUBHEADER_CG_REFRESH_COMMENT:
-			pGuild->RefreshComment(ch);
-			return SubPacketLen;
+		return (1 + length);
+	}
 
-		case GUILD_SUBHEADER_CG_CHANGE_MEMBER_GRADE:
-		{
-			const DWORD pid = *reinterpret_cast<const DWORD*>(c_pData);
-			const BYTE grade = *(c_pData + sizeof(DWORD));
-			const TGuildMember* m = pGuild->GetMember(ch->GetPlayerID());
+	case GUILD_SUBHEADER_CG_DELETE_COMMENT:
+	{
+		const DWORD comment_id = *reinterpret_cast<const DWORD*>(c_pData);
 
-			if (NULL == m)
-				return -1;
+		pGuild->DeleteComment(ch, comment_id);
+	}
+	return SubPacketLen;
 
-			if (m->grade != GUILD_LEADER_GRADE)
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>    ϴ."));
-			else if (ch->GetPlayerID() == pid)
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>     ϴ."));
-			else if (grade == 1)
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<>     ϴ."));
-			else
-				pGuild->ChangeMemberGrade(pid, grade);
-		}
+	case GUILD_SUBHEADER_CG_REFRESH_COMMENT:
+		pGuild->RefreshComment(ch);
 		return SubPacketLen;
 
-		case GUILD_SUBHEADER_CG_USE_SKILL:
-		{
-			const TPacketCGGuildUseSkill* p = reinterpret_cast<const TPacketCGGuildUseSkill*>(c_pData);
+	case GUILD_SUBHEADER_CG_CHANGE_MEMBER_GRADE:
+	{
+		const DWORD pid = *reinterpret_cast<const DWORD*>(c_pData);
+		const BYTE grade = *(c_pData + sizeof(DWORD));
+		const TGuildMember* m = pGuild->GetMember(ch->GetPlayerID());
 
-			pGuild->UseSkill(p->dwVnum, ch, p->dwPID);
-		}
-		return SubPacketLen;
+		if (NULL == m)
+			return -1;
 
-		case GUILD_SUBHEADER_CG_CHANGE_MEMBER_GENERAL:
-		{
-			const DWORD pid = *reinterpret_cast<const DWORD*>(c_pData);
-			const BYTE is_general = *(c_pData + sizeof(DWORD));
-			const TGuildMember* m = pGuild->GetMember(ch->GetPlayerID());
+		if (m->grade != GUILD_LEADER_GRADE)
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>    ϴ."));
+		else if (ch->GetPlayerID() == pid)
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>     ϴ."));
+		else if (grade == 1)
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<>     ϴ."));
+		else
+			pGuild->ChangeMemberGrade(pid, grade);
+	}
+	return SubPacketLen;
 
-			if (NULL == m)
-				return -1;
+	case GUILD_SUBHEADER_CG_USE_SKILL:
+	{
+		const TPacketCGGuildUseSkill* p = reinterpret_cast<const TPacketCGGuildUseSkill*>(c_pData);
 
-			if (m->grade != GUILD_LEADER_GRADE)
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> 屺   ϴ."));
-			}
-			else
+		pGuild->UseSkill(p->dwVnum, ch, p->dwPID);
+	}
+	return SubPacketLen;
+
+	case GUILD_SUBHEADER_CG_CHANGE_MEMBER_GENERAL:
+	{
+		const DWORD pid = *reinterpret_cast<const DWORD*>(c_pData);
+		const BYTE is_general = *(c_pData + sizeof(DWORD));
+		const TGuildMember* m = pGuild->GetMember(ch->GetPlayerID());
+
+		if (NULL == m)
+			return -1;
+
+		if (m->grade != GUILD_LEADER_GRADE)
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> 屺   ϴ."));
+		}
+		else
+		{
+			if (!pGuild->ChangeMemberGeneral(pid, is_general))
 			{
-				if (!pGuild->ChangeMemberGeneral(pid, is_general))
-				{
-					ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<> ̻    ϴ."));
-				}
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("<> ̻    ϴ."));
 			}
 		}
-		return SubPacketLen;
+	}
+	return SubPacketLen;
 
-		case GUILD_SUBHEADER_CG_GUILD_INVITE_ANSWER:
-		{
-			const DWORD guild_id = *reinterpret_cast<const DWORD*>(c_pData);
-			const BYTE accept = *(c_pData + sizeof(DWORD));
+	case GUILD_SUBHEADER_CG_GUILD_INVITE_ANSWER:
+	{
+		const DWORD guild_id = *reinterpret_cast<const DWORD*>(c_pData);
+		const BYTE accept = *(c_pData + sizeof(DWORD));
 
-			CGuild* g = CGuildManager::instance().FindGuild(guild_id);
+		CGuild* g = CGuildManager::instance().FindGuild(guild_id);
 
-			if (g)
-			{
-				if (accept)
-					g->InviteAccept(ch);
-				else
-					g->InviteDeny(ch->GetPlayerID());
-			}
+		if (g)
+		{
+			if (accept)
+				g->InviteAccept(ch);
+			else
+				g->InviteDeny(ch->GetPlayerID());
 		}
-		return SubPacketLen;
+	}
+	return SubPacketLen;
 
 	}
 
@@ -3509,42 +3903,6 @@
 	return;
 }
 
-#if defined(__FISHING_GAME__)
-#include "fishing.h"
-void CInputMain::FishingGame(const LPCHARACTER c_lpChar, const char* c_pszData)
-{
-	const TPacketCGFishingGame* c_pData = reinterpret_cast<const TPacketCGFishingGame*>(c_pszData);
-	if (c_pData == nullptr || c_lpChar == nullptr)
-		return;
-
-	const LPITEM c_lpFishingRod = c_lpChar->GetWear(WEAR_WEAPON);
-	if (c_lpFishingRod && c_lpFishingRod->GetType() == ITEM_ROD)
-	{
-		if (c_lpChar->m_pkFishingEvent)
-		{
-			switch (c_pData->bSubHeader)
-			{
-				case FISHING_GAME_SUBHEADER_GOAL:
-				{
-					c_lpChar->SetFishingGameGoals(c_pData->bGoals);
-					if (c_lpChar->GetFishingGameGoals() >= 3)
-						c_lpChar->fishing();
-				}
-				break;
-
-				case FISHING_GAME_SUBHEADER_QUIT:
-				{
-					event_cancel(&c_lpChar->m_pkFishingEvent);
-					c_lpFishingRod->SetSocket(2, 0);
-					fishing::FishingFail(c_lpChar);
-				}
-				break;
-			};
-		}
-	}
-}
-#endif
-
 void CInputMain::ItemGive(LPCHARACTER ch, const char* c_pData)
 {
 	TPacketCGGiveItem* p = (TPacketCGGiveItem*)c_pData;
@@ -3553,7 +3911,7 @@
 	if (to_ch)
 		ch->GiveItem(to_ch, p->ItemPos);
 	else
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" ǳ  ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" ǳ  ϴ."));
 }
 
 void CInputMain::Hack(LPCHARACTER ch, const char* c_pData)
@@ -3570,37 +3928,31 @@
 }
 
 #if defined(__MYSHOP_DECO__)
-void CInputMain::MyShopDecoState(LPCHARACTER ch, const char* c_pData)
+void CInputMain::MyShopDeco(LPCHARACTER ch, const char* c_pData)
 {
-	const TPacketCGMyShopDecoState* p = (TPacketCGMyShopDecoState*)c_pData;
-	ch->SetMyShopDecoState(p->bState);
-}
+	TPacketCGMyShopDeco* p = (TPacketCGMyShopDeco*)c_pData;
 
-void CInputMain::MyShopDecoAdd(LPCHARACTER ch, const char* c_pData)
-{
-	const TPacketCGMyShopDecoAdd* p = (TPacketCGMyShopDecoAdd*)c_pData;
-	if (ch->GetMyShopDecoState())
+	if (!ch)
+		return;
+
+	// NOTE : We will check for the KashmirBundle when the packet is sent to server
+	// .
+	if (ch->CountSpecifyItem(KASHMIR_BUNDLE) <= 0)
 	{
-		if (p->dwPolyVnum < 30000 && p->dwPolyVnum > 30008)
-		{
-			sys_err("MyShopDecoAdd : Unknown PolyVnum");
-			return;
-		}
+		sys_err("MyShopDeco : Kashmir Bundle not found (%s).", ch->GetName());
+		return;
+	}
 
+	if (p->dwPolyVnum >= 30000 && p->dwPolyVnum <= 30008)
+	{
 		ch->SetMyShopDecoType(p->bType);
 		ch->SetMyShopDecoPolyVnum(p->dwPolyVnum);
-
-#if defined(__MYSHOP_EXPANSION__)
-		//ch->OpenPrivateShop(2, true);
-		// NOTE : Ideally, the Kashmir Bundle should have the same benefits as the Silk Bundle.
-		ch->UseSilkBotary();
-#else
-		ch->OpenPrivateShop(1, true);
-#endif
+		ch->SetMyShopTabs(MYSHOP_MAX_TABS);
+		ch->ChatPacket(CHAT_TYPE_COMMAND, "MyPrivShopOpen %d %d", TRUE, MYSHOP_MAX_TABS);
 	}
 	else
 	{
-		sys_err("MyShopDecoAdd : Unknown State");
+		sys_err("MyShopDeco : Unkown PolyVnum");
 		return;
 	}
 }
@@ -3608,23 +3960,23 @@
 
 int CInputMain::MyShop(LPCHARACTER ch, const char* c_pData, size_t uiBytes)
 {
-	const TPacketCGMyShop* p = (TPacketCGMyShop*)c_pData;
-	const int iExtraLen = p->bCount * sizeof(TShopItemTable);
+	TPacketCGMyShop* p = (TPacketCGMyShop*)c_pData;
+	int iExtraLen = p->wCount * sizeof(TShopItemTable);
 
 	if (uiBytes < sizeof(TPacketCGMyShop) + iExtraLen)
 		return -1;
 
-	if (ch->GetGold() >= GOLD_MAX)
+	if (ch->GetGold() >= g_MaxGold)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("  20 Ѿ ŷ ۼ ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  20 Ѿ ŷ ۼ ϴ."));
 		sys_log(0, "MyShop ==> OverFlow Gold id %u name %s ", ch->GetPlayerID(), ch->GetName());
 		return (iExtraLen);
 	}
 
 #if defined(__CHEQUE_SYSTEM__)
-	if (ch->GetCheque() > CHEQUE_MAX)
+	if (ch->GetCheque() >= CHEQUE_MAX)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("  20 Ѿ ŷ ۼ ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("  20 Ѿ ŷ ۼ ϴ."));
 		sys_log(0, "MyShop ==> OverFlow Cheque id %u name %s ", ch->GetPlayerID(), ch->GetName());
 		return (iExtraLen);
 	}
@@ -3633,23 +3985,18 @@
 	if (ch->IsStun() || ch->IsDead())
 		return (iExtraLen);
 
-	if (ch->PreventTradeWindow(WND_MYSHOP, true/*except*/))
+	if (ch->GetExchange() || ch->IsOpenSafebox() || ch->GetShopOwner() || ch->IsCubeOpen()
+#ifdef __AURA_SYSTEM__
+	|| ch->IsAuraRefineWindowOpen()
+#endif
+	)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ٸ ŷϰ λ  ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ٸ ŷϰ λ  ϴ."));
 		return (iExtraLen);
 	}
 
-	sys_log(0, "MyShop count %u", p->bCount);
-	char szSign[SHOP_SIGN_MAX_LEN + 1];
-	strlcpy(szSign, p->szSign, sizeof(szSign));
-	for (size_t i = 0; i < sizeof(szSign) && szSign[i]; ++i)
-	{
-		const unsigned char c = static_cast<unsigned char>(szSign[i]);
-		if (c < 0x20 || c == 0x7F)
-			szSign[i] = ' ';
-	}
-
-	ch->OpenMyShop(szSign, (TShopItemTable*)(c_pData + sizeof(TPacketCGMyShop)), p->bCount);
+	sys_log(0, "MyShop count %d", p->wCount);
+	ch->OpenMyShop(p->szSign, (TShopItemTable*)(c_pData + sizeof(TPacketCGMyShop)), p->wCount);
 	return (iExtraLen);
 }
 
@@ -3657,9 +4004,13 @@
 {
 	const TPacketCGRefine* p = reinterpret_cast<const TPacketCGRefine*>(c_pData);
 
-	if (ch->PreventTradeWindow(WND_REFINE, true/*except*/))
+	if (ch->GetExchange() || ch->IsOpenSafebox() || ch->GetShopOwner() || ch->GetMyShop() || ch->IsCubeOpen()
+#ifdef __AURA_SYSTEM__
+	|| ch->IsAuraRefineWindowOpen()
+#endif
+	)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("â,ŷâ  ¿  Ҽ ϴ"));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("â,ŷâ  ¿  Ҽ ϴ"));
 		ch->ClearRefineMode();
 		return;
 	}
@@ -3671,17 +4022,14 @@
 		return;
 	}
 
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	if (p->pos >= ch->GetExtendInvenMax())
-#else
 	if (p->pos >= INVENTORY_MAX_NUM)
-#endif
 	{
 		ch->ClearRefineMode();
 		return;
 	}
 
 	LPITEM item = ch->GetInventoryItem(p->pos);
+
 	if (!item)
 	{
 		ch->ClearRefineMode();
@@ -3695,25 +4043,19 @@
 		sys_log(0, "refine_type_noraml");
 		ch->DoRefine(item);
 	}
-	else if (p->type == REFINE_TYPE_SCROLL
-		|| p->type == REFINE_TYPE_NOT_USED1
-		|| p->type == REFINE_TYPE_HYUNIRON
-		|| p->type == REFINE_TYPE_MUSIN
-		|| p->type == REFINE_TYPE_BDRAGON
+	else if (p->type == REFINE_TYPE_SCROLL || p->type == REFINE_TYPE_HYUNIRON || p->type == REFINE_TYPE_MUSIN || p->type == REFINE_TYPE_BDRAGON
 #if defined(__STONE_OF_BLESS__)
-		|| p->type == REFINE_TYPE_BLESSING_STONE
+		|| p->type == REFINE_TYPE_STONE_OF_BLESS
+#endif
+#if defined(__SOUL_SYSTEM__)
+		|| p->type == REFINE_TYPE_SOUL_EVOLVE
+		|| p->type == REFINE_TYPE_SOUL_AWAKE
 #endif
 		)
 	{
 		sys_log(0, "refine_type_scroll, ...");
 		ch->DoRefineWithScroll(item);
 	}
-#if defined(__SOUL_SYSTEM__)
-	else if (p->type == REFINE_TYPE_SOUL_AWAKE || p->type == REFINE_TYPE_SOUL_EVOLVE)
-	{
-		ch->DoRefineSoul(item);
-	}
-#endif
 	else if (p->type == REFINE_TYPE_MONEY_ONLY)
 	{
 		const LPITEM item = ch->GetInventoryItem(p->pos);
@@ -3742,295 +4084,157 @@
 	ch->ClearRefineMode();
 }
 
-#if defined(__CUBE_RENEWAL__)
-void CInputMain::Cube(const LPCHARACTER pChar, const char* pData)
+#if defined(__ACCE_COSTUME_SYSTEM__)
+void CInputMain::Acce(LPCHARACTER pkChar, const char* c_pData)
 {
-	const TPacketCGCube* pPacket = reinterpret_cast<const TPacketCGCube*>(pData);
-	if (pPacket == nullptr)
+	quest::PC* pPC = quest::CQuestManager::instance().GetPCForce(pkChar->GetPlayerID());
+	if (pPC->IsRunning())
 		return;
 
-	const DWORD dwFileCrc = CCubeManager::Instance().GetFileCrc();
-	if (pPacket->dwFileCrc != dwFileCrc)
+	TPacketAcce* sPacket = (TPacketAcce*)c_pData;
+	switch (sPacket->subheader)
 	{
-		const char* szSubHeader[] = {
-			{ "SUBHEADER_CG_CUBE_CLOSE" },
-			{ "SUBHEADER_CG_CUBE_MAKE" },
-		};
-
-		if (test_server)
-			pChar->ChatPacket(CHAT_TYPE_INFO, "cube crc mismatch: %u != %u",
-				pPacket->dwFileCrc, dwFileCrc);
-
-		sys_log(0, "cube: recv %s ch %s file crc mismatch: %u != %u",
-			szSubHeader[pPacket->bSubHeader], pChar->GetName(),
-			pPacket->dwFileCrc, dwFileCrc);
-
-		LogManager::instance().CharLog(pChar, 0, "CUBE FILE MISMATCH", "");
-		CCubeManager::Instance().CloseCube(pChar);
+	case ACCE_SUBHEADER_CG_CLOSE:
+	{
+		pkChar->CloseAcce();
 	}
-
-	if (pChar->PreventTradeWindow(WND_CUBE, true/*except*/))
+	break;
+	case ACCE_SUBHEADER_CG_ADD:
 	{
-		pChar->ChatPacket(CHAT_TYPE_INFO, LC_STRING("â,ŷâ  ¿  Ҽ ϴ"));
-		return;
+		pkChar->AddAcceMaterial(sPacket->tPos, sPacket->bPos);
 	}
-
-	switch (pPacket->bSubHeader)
+	break;
+	case ACCE_SUBHEADER_CG_REMOVE:
 	{
-		case SUBHEADER_CG_CUBE_CLOSE:
-			CCubeManager::Instance().CloseCube(pChar);
-			break;
-
-		case SUBHEADER_CG_CUBE_MAKE:
-			CCubeManager::Instance().MakeCube(pChar, pPacket->iCubeIndex, pPacket->iQuantity, pPacket->iImproveItemPos);
-			break;
+		pkChar->RemoveAcceMaterial(sPacket->bPos);
+	}
+	break;
+	case ACCE_SUBHEADER_CG_REFINE:
+	{
+		pkChar->RefineAcceMaterials();
+	}
+	break;
+	default:
+		break;
 	}
 }
 #endif
 
-#if defined(__MOVE_COSTUME_ATTR__)
-void CInputMain::ItemCombination(LPCHARACTER ch, const char* c_pData)
-{
-	const TPacketCGItemCombination* p = reinterpret_cast<const TPacketCGItemCombination*>(c_pData);
-
-	ch->ItemCombination(p->MediumIndex, p->BaseIndex, p->MaterialIndex);
-}
-
-void CInputMain::ItemCombinationCancel(LPCHARACTER ch, const char* c_pData)
-{
-	const TPacketCGItemCombinationCancel* p = reinterpret_cast<const TPacketCGItemCombinationCancel*>(c_pData);
-
-	ch->SetItemCombNpc(NULL);
-}
-#endif
-
-#if defined(__CHANGED_ATTR__)
-void CInputMain::ItemSelectAttr(LPCHARACTER ch, const char* c_pData)
+#if defined(__CHANGE_LOOK_SYSTEM__)
+void CInputMain::ChangeLook(LPCHARACTER pkChar, const char* c_pData)
 {
-	const TPacketCGItemSelectAttr* p = reinterpret_cast<const TPacketCGItemSelectAttr*>(c_pData);
-
-	ch->SelectAttrResult(p->bNew, p->pItemPos);
-}
-#endif
+	quest::PC* pPC = quest::CQuestManager::instance().GetPCForce(pkChar->GetPlayerID());
+	if (pPC->IsRunning())
+		return;
 
-#if defined(__ACCE_COSTUME_SYSTEM__)
-static size_t GetAcceSubPacketLength(const ESubHeaderCGAcceRefine& eSubHeader)
-{
-	switch (eSubHeader)
+	TPacketChangeLook* sPacket = (TPacketChangeLook*)c_pData;
+	switch (sPacket->bSubHeader)
 	{
-		case ACCE_REFINE_SUBHEADER_CG_CHECKIN:
-			return sizeof(TSubPacketCGAcceRefineCheckIn);
-		case ACCE_REFINE_SUBHEADER_CG_CHECKOUT:
-			return sizeof(TSubPacketCGAcceRefineCheckOut);
-		case ACCE_REFINE_SUBHEADER_CG_ACCEPT:
-			return sizeof(TSubPacketCGAcceRefineAccept);
-		case ACCE_REFINE_SUBHEADER_CG_CANCEL:
-			return 0;
+	case SUBHEADER_CHANGE_LOOK_CLOSE:
+	{
+		pkChar->ChangeLookWindow(false);
 	}
-	return 0;
-}
+	break;
 
-int CInputMain::AcceRefine(const LPCHARACTER pChar, const char* pszData, size_t uiBytes)
-{
-	if (uiBytes < sizeof(TPacketCGAcceRefine))
-		return -1;
-
-	const TPacketCGAcceRefine* pPacket = reinterpret_cast<const TPacketCGAcceRefine*>(pszData);
-	const char* pszDataPacket = pszData + sizeof(TPacketCGAcceRefine);
-
-	uiBytes -= sizeof(TPacketCGAcceRefine);
-
-	const ESubHeaderCGAcceRefine eSubHeader = static_cast<ESubHeaderCGAcceRefine>(pPacket->bSubHeader);
-	const size_t uiSubPacketLength = GetAcceSubPacketLength(eSubHeader);
-	if (uiBytes < uiSubPacketLength)
+	case SUBHEADER_CHANGE_LOOK_ADD:
 	{
-		sys_err("Invalid AcceRefine SubPacket length (SubPacketLength %d Size %u Buffer %u)", uiSubPacketLength, sizeof(TPacketCGAcceRefine), uiBytes);
-		return -1;
+		pkChar->AddChangeLookMaterial(sPacket->tPos, sPacket->bPos);
 	}
+	break;
 
-	switch (eSubHeader)
+	case SUBHEADER_CHANGE_LOOK_REMOVE:
 	{
-		case ACCE_REFINE_SUBHEADER_CG_CHECKIN:
-		{
-			const TSubPacketCGAcceRefineCheckIn* pSubPacket = reinterpret_cast<const TSubPacketCGAcceRefineCheckIn*>(pszDataPacket);
-			pChar->AcceRefineWindowCheckIn(pSubPacket->bType, pSubPacket->SelectedPos, pSubPacket->AttachedPos);
-		}
-		return uiSubPacketLength;
-
-		case ACCE_REFINE_SUBHEADER_CG_CHECKOUT:
-		{
-			const TSubPacketCGAcceRefineCheckOut* pSubPacket = reinterpret_cast<const TSubPacketCGAcceRefineCheckOut*>(pszDataPacket);
-			pChar->AcceRefineWindowCheckOut(pSubPacket->bType, pSubPacket->SelectedPos);
-		}
-		return uiSubPacketLength;
-
-		case ACCE_REFINE_SUBHEADER_CG_ACCEPT:
-		{
-			const TSubPacketCGAcceRefineAccept* pSubPacket = reinterpret_cast<const TSubPacketCGAcceRefineAccept*>(pszDataPacket);
-			pChar->AcceRefineWindowAccept(pSubPacket->bType);
-		}
-		return uiSubPacketLength;
-
-		case ACCE_REFINE_SUBHEADER_CG_CANCEL:
-		{
-			pChar->AcceRefineWindowClose();
-		}
-		return uiSubPacketLength;
+		pkChar->RemoveChangeLookMaterial(sPacket->bPos);
 	}
+	break;
 
-	return 0;
-}
-#endif
-
-#if defined(__AURA_COSTUME_SYSTEM__)
-static size_t GetAuraSubPacketLength(const ESubHeaderCGAuraRefine& eSubHeader)
-{
-	switch (eSubHeader)
+	case SUBHEADER_CHANGE_LOOK_REFINE:
 	{
-		case AURA_REFINE_SUBHEADER_CG_CHECKIN:
-			return sizeof(TSubPacketCGAuraRefineCheckIn);
-		case AURA_REFINE_SUBHEADER_CG_CHECKOUT:
-			return sizeof(TSubPacketCGAuraRefineCheckOut);
-		case AURA_REFINE_SUBHEADER_CG_ACCEPT:
-			return sizeof(TSubPacketCGAuraRefineAccept);
-		case AURA_REFINE_SUBHEADER_CG_CANCEL:
-			return 0;
+		pkChar->RefineChangeLookMaterials();
+	}
+	break;
+
+	default:
+		break;
 	}
-	return 0;
 }
+#endif
 
-int CInputMain::AuraRefine(const LPCHARACTER pChar, const char* pszData, size_t uiBytes)
+#if defined(__SEND_TARGET_INFO__)
+void CInputMain::TargetInfoLoad(LPCHARACTER ch, const char* c_pData)
 {
-	if (uiBytes < sizeof(TPacketCGAuraRefine))
-		return -1;
+	TPacketCGTargetInfoLoad* p = (TPacketCGTargetInfoLoad*)c_pData;
+	TPacketGCTargetInfo pInfo;
+	pInfo.header = HEADER_GC_TARGET_INFO;
 
-	const TPacketCGAuraRefine* pPacket = reinterpret_cast<const TPacketCGAuraRefine*>(pszData);
-	const char* pszDataPacket = pszData + sizeof(TPacketCGAuraRefine);
+	static std::vector<LPITEM> s_vec_item;
+	s_vec_item.clear();
 
-	uiBytes -= sizeof(TPacketCGAuraRefine);
+	LPITEM pkInfoItem;
+	LPCHARACTER m_pkChrTarget = CHARACTER_MANAGER::instance().Find(p->dwVID);
 
-	const ESubHeaderCGAuraRefine eSubHeader = static_cast<ESubHeaderCGAuraRefine>(pPacket->bSubHeader);
-	const size_t uiSubPacketLength = GetAuraSubPacketLength(eSubHeader);
-	if (uiBytes < uiSubPacketLength)
-	{
-		sys_err("Invalid AuraRefine SubPacket length (SubPacketLength %d Size %u Buffer %u)", uiSubPacketLength, sizeof(TPacketCGAuraRefine), uiBytes);
-		return -1;
-	}
+	if (!ch || !m_pkChrTarget)
+		return;
 
-	switch (eSubHeader)
+	if (ITEM_MANAGER::instance().CreateDropItemVector(m_pkChrTarget, ch, s_vec_item) && (m_pkChrTarget->IsMonster() || m_pkChrTarget->IsStone()))
 	{
-		case AURA_REFINE_SUBHEADER_CG_CHECKIN:
+		if (s_vec_item.size() == 0);
+		else if (s_vec_item.size() == 1)
 		{
-			const TSubPacketCGAuraRefineCheckIn* c_pSubPacket = reinterpret_cast<const TSubPacketCGAuraRefineCheckIn*>(pszDataPacket);
-			pChar->AuraRefineWindowCheckIn(c_pSubPacket->bType, c_pSubPacket->SelectedPos, c_pSubPacket->AttachedPos);
+			pkInfoItem = s_vec_item[0];
+			pInfo.dwVID = m_pkChrTarget->GetVID();
+			pInfo.race = m_pkChrTarget->GetRaceNum();
+			pInfo.dwVnum = pkInfoItem->GetVnum();
+			pInfo.count = pkInfoItem->GetCount();
+			ch->GetDesc()->Packet(&pInfo, sizeof(TPacketGCTargetInfo));
 		}
-		return uiSubPacketLength;
-
-		case AURA_REFINE_SUBHEADER_CG_CHECKOUT:
+		else
 		{
-			const TSubPacketCGAuraRefineCheckOut* c_pSubPacket = reinterpret_cast<const TSubPacketCGAuraRefineCheckOut*>(pszDataPacket);
-			pChar->AuraRefineWindowCheckOut(c_pSubPacket->bType, c_pSubPacket->SelectedPos);
-		}
-		return uiSubPacketLength;
+			int iItemIdx = s_vec_item.size() - 1;
+			while (iItemIdx >= 0)
+			{
+				pkInfoItem = s_vec_item[iItemIdx--];
 
-		case AURA_REFINE_SUBHEADER_CG_ACCEPT:
-		{
-			const TSubPacketCGAuraRefineAccept* c_pSubPacket = reinterpret_cast<const TSubPacketCGAuraRefineAccept*>(pszDataPacket);
-			pChar->AuraRefineWindowAccept(c_pSubPacket->bType);
-		}
-		return uiSubPacketLength;
+				if (!pkInfoItem)
+				{
+					sys_err("pkInfoItem null in vector idx %d", iItemIdx + 1);
+					continue;
+				}
 
-		case AURA_REFINE_SUBHEADER_CG_CANCEL:
-		{
-			pChar->AuraRefineWindowClose();
+				pInfo.dwVID = m_pkChrTarget->GetVID();
+				pInfo.race = m_pkChrTarget->GetRaceNum();
+				pInfo.dwVnum = pkInfoItem->GetVnum();
+				pInfo.count = pkInfoItem->GetCount();
+				ch->GetDesc()->Packet(&pInfo, sizeof(TPacketGCTargetInfo));
+			}
 		}
-		return uiSubPacketLength;
 	}
-
-	return 0;
 }
 #endif
 
-#if defined(__CHANGE_LOOK_SYSTEM__)
-void CInputMain::ChangeLook(LPCHARACTER lpCh, const char* c_pszData)
+void CInputMain::ChangeLanguage(LPCHARACTER ch, BYTE bLanguage)
 {
-	const TPacketCGChangeLook* c_pData = reinterpret_cast<const TPacketCGChangeLook*>(c_pszData);
-
-	CChangeLook* pChangeLook = lpCh->GetChangeLook();
-	if (pChangeLook == nullptr)
+	if (!ch)
 		return;
 
-	switch (static_cast<EPacketCGChangeLookSubHeader>(c_pData->bSubHeader))
-	{
-		case EPacketCGChangeLookSubHeader::ITEM_CHECK_IN:
-			pChangeLook->ItemCheckIn(c_pData->ItemPos, c_pData->bSlotIndex);
-			break;
-		case EPacketCGChangeLookSubHeader::ITEM_CHECK_OUT:
-			pChangeLook->ItemCheckOut(c_pData->bSlotIndex);
-			break;
-		case EPacketCGChangeLookSubHeader::FREE_ITEM_CHECK_IN:
-			pChangeLook->FreeItemCheckIn(c_pData->ItemPos);
-			break;
-		case EPacketCGChangeLookSubHeader::FREE_ITEM_CHECK_OUT:
-			pChangeLook->FreeItemCheckOut();
-			break;
-		case EPacketCGChangeLookSubHeader::ACCEPT:
-			pChangeLook->Accept();
-			break;
-		case EPacketCGChangeLookSubHeader::CANCEL:
-			lpCh->SetChangeLook(nullptr);
-			break;
-		default:
-			sys_err("Unknown Subheader ch:%s, %d", lpCh->GetName(), c_pData->bSubHeader);
-			return;
-	}
-}
-#endif
-
-#if defined(__SEND_TARGET_INFO__)
-void CInputMain::TargetInfo(LPCHARACTER pChar, const char* c_pszData)
-{
-	const TPacketCGTargetInfo* c_pData = reinterpret_cast<const TPacketCGTargetInfo*>(c_pszData);
-	const LPCHARACTER pkTarget = CHARACTER_MANAGER::instance().Find(c_pData->dwVID);
-	if (pChar == nullptr || pkTarget == nullptr)
+	if (!ch->GetDesc())
 		return;
 
-	const DWORD dwVID = pkTarget->GetVID();
-	const DWORD dwRaceVnum = pkTarget->GetRaceNum();
+	if (ch->GetLanguage() == bLanguage)
+		return;
 
-	if (pkTarget->IsMonster() || pkTarget->IsStone())
+	if (bLanguage > LOCALE_YMIR && bLanguage < LOCALE_MAX_NUM)
 	{
-		MonsterItemDropMap ItemDropMap; bool bDropMetinStone = false;
-		ITEM_MANAGER::instance().GetMonsterItemDropMap(pkTarget, pChar, ItemDropMap, bDropMetinStone);
+		TRequestChangeLanguage packet;
+		packet.dwAID = ch->GetDesc()->GetAccountTable().id;
+		packet.bLanguage = bLanguage;
 
-		TEMP_BUFFER TempBuffer;
-		for (const MonsterItemDropMap::value_type& it : ItemDropMap)
-		{
-			TPacketGCTargetDropInfo DropInfoPacket;
-			DropInfoPacket.dwVnum = it.first;
-			DropInfoPacket.bCount = it.second;
-			TempBuffer.write(&DropInfoPacket, sizeof(DropInfoPacket));
-		}
-
-		TPacketGCTargetInfo TargetInfoPacket;
-		TargetInfoPacket.bHeader = HEADER_GC_TARGET_INFO;
-		TargetInfoPacket.wSize = sizeof(TargetInfoPacket) + TempBuffer.size();
-		TargetInfoPacket.dwRaceVnum = dwRaceVnum;
-		TargetInfoPacket.dwVID = dwVID;
-		TargetInfoPacket.bDropMetinStone = bDropMetinStone;
+		db_clientdesc->DBPacketHeader(HEADER_GD_REQUEST_CHANGE_LANGUAGE, 0, sizeof(TRequestChangeLanguage));
+		db_clientdesc->Packet(&packet, sizeof(packet));
 
-		if (TempBuffer.size())
-		{
-			pChar->GetDesc()->BufferedPacket(&TargetInfoPacket, sizeof(TargetInfoPacket));
-			pChar->GetDesc()->Packet(TempBuffer.read_peek(), TempBuffer.size());
-		}
-		else
-			pChar->GetDesc()->Packet(&TargetInfoPacket, sizeof(TargetInfoPacket));
+		ch->ChangeLanguage(bLanguage);
 	}
-
-	pChar->ChatPacket(CHAT_TYPE_COMMAND, "RefreshMonsterDropInfo %d", pkTarget->GetRaceNum());
 }
-#endif
 
 #if defined(__SKILLBOOK_COMB_SYSTEM__)
 bool CInputMain::SkillBookCombination(LPCHARACTER ch, TItemPos(&CombItemGrid)[SKILLBOOK_COMB_SLOT_MAX], BYTE bAction)
@@ -4041,7 +4245,7 @@
 	// if (CombItemGrid.empty())
 		// return false;
 
-	if (ch->PreventTradeWindow(WND_ALL))
+	if (ch->GetExchange() || ch->GetShop() || ch->GetMyShop() || ch->IsOpenSafebox() || ch->IsCubeOpen())
 		return false;
 
 	if (bAction != 2/*COMBI_START*/)
@@ -4065,7 +4269,7 @@
 
 	if (ch->GetGold() < SKILLBOOK_COMB_COST)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You don't have enough Yang to trade books with me."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You don't have enough Yang to trade books with me."));
 		return false;
 	}
 
@@ -4118,1195 +4322,47 @@
 		ch->AutoGiveItem(dwRandomBook, 1);
 	}
 	else
-		ch->AutoGiveItem(ITEM_SKILLBOOK_VNUM, 1);
+		ch->AutoGiveItem(50300, 1);
 
 	return true;
 }
 #endif
 
-#if defined(__MAILBOX__)
-void CInputMain::MailboxWrite(LPCHARACTER ch, const char* c_pData)
-{
-	const auto* p = reinterpret_cast<const TPacketCGMailboxWrite*>(c_pData);
-	if (p == nullptr)
-		return;
-
-	CMailBox* mail = ch->GetMailBox();
-	if (mail == nullptr)
-		return;
-
-	mail->Write(p->szName, p->szTitle, p->szMessage, p->pos, p->iYang, p->iWon);
-}
-
-void CInputMain::MailboxConfirm(LPCHARACTER ch, const char* c_pData)
-{
-	const auto* p = reinterpret_cast<const TPacketCGMailboxWriteConfirm*>(c_pData);
-	if (p == nullptr)
-		return;
-
-	CMailBox* mail = ch->GetMailBox();
-	if (mail == nullptr)
-		return;
-
-	mail->CheckPlayer(p->szName);
-}
-
-void CInputMain::MailboxProcess(LPCHARACTER ch, const char* c_pData)
-{
-	const auto* p = reinterpret_cast<const TPacketMailboxProcess*>(c_pData);
-	if (p == nullptr)
-		return;
-
-	CMailBox* mail = ch->GetMailBox();
-	if (mail == nullptr)
-		return;
-
-	switch (p->bSubHeader)
-	{
-		case CMailBox::EMAILBOX_CG::MAILBOX_CG_CLOSE:
-			ch->SetMailBox(nullptr);
-			break;
-		case CMailBox::EMAILBOX_CG::MAILBOX_CG_DELETE:
-			mail->DeleteMail(p->bArg1, false);
-			break;
-		case CMailBox::EMAILBOX_CG::MAILBOX_CG_ALL_DELETE:
-			mail->DeleteAllMails();
-			break;
-		case CMailBox::EMAILBOX_CG::MAILBOX_CG_GET_ITEMS:
-			mail->GetItem(p->bArg1, false);
-			break;
-		case CMailBox::EMAILBOX_CG::MAILBOX_CG_ALL_GET_ITEMS:
-			mail->GetAllItems();
-			break;
-		case CMailBox::EMAILBOX_CG::MAILBOX_CG_ADD_DATA:
-			mail->AddData(p->bArg1, p->bArg2);
-			break;
-		default:
-			sys_err("CInputMain::MailboxProcess Unknown SubHeader (ch: %s) (%d)", ch->GetName(), p->bSubHeader);
-			break;
-	}
-}
-#endif
-
-#if defined(__MINI_GAME_RUMI__)
-void CInputMain::MiniGameRumi(LPCHARACTER pChar, const char* pszData)
-{
-	const TPacketCGMiniGameRumi* pkData = reinterpret_cast<const TPacketCGMiniGameRumi*>(pszData);
-	if (pkData == nullptr)
-		return;
-
-	switch (pkData->bSubHeader)
-	{
-		case RUMI_CG_SUBHEADER_END:
-			CMiniGameRumi::EndGame(pChar);
-			break;
-
-		case RUMI_CG_SUBHEADER_START:
-			CMiniGameRumi::StartGame(pChar);
-			break;
-
-		case RUMI_CG_SUBHEADER_DECK_CARD_CLICK:
-		case RUMI_CG_SUBHEADER_HAND_CARD_CLICK:
-		case RUMI_CG_SUBHEADER_FIELD_CARD_CLICK:
-			CMiniGameRumi::Analyze(pChar, pkData->bSubHeader, pkData->bUseCard, pkData->bIndex);
-			break;
-
-#if defined(__OKEY_EVENT_FLAG_RENEWAL__)
-		case RUMI_CG_SUBHEADER_REQUEST_QUEST_FLAG:
-			CMiniGameRumi::RequestQuestFlag(pChar, RUMI_GC_SUBHEADER_SET_QUEST_FLAG);
-			break;
-#endif
-
-		default:
-			sys_err("CInputMain::MiniGameRumi Unknown SubHeader (ch: %s) (%d)", pChar->GetName(), pkData->bSubHeader);
-			break;
-	}
-}
-#endif
-
-#if defined(__MINI_GAME_YUTNORI__)
-void CInputMain::MiniGameYutnori(LPCHARACTER pChar, const char* pszData)
+void CInputMain::WhisperDetails(LPCHARACTER ch, const char* c_pData)
 {
-	const TPacketCGMiniGameYutnori* pkData = reinterpret_cast<const TPacketCGMiniGameYutnori*>(pszData);
-	if (pkData == nullptr)
-	{
-		sys_err("CInputMain::MiniGameYutnori - Null Data! (ch: %s)", pChar->GetName());
-		return;
-	}
+	TPacketCGWhisperDetails* CGWhisperDetails = (TPacketCGWhisperDetails*)c_pData;
 
-	switch (pkData->bSubHeader)
-	{
-		case YUTNORI_CG_SUBHEADER_START:
-			CMiniGameYutnori::Create(pChar);
-			break;
-
-		case YUTNORI_CG_SUBHEADER_GIVEUP:
-			CMiniGameYutnori::Destroy(pChar);
-			break;
-
-#if defined(__YUTNORI_EVENT_FLAG_RENEWAL__)
-		case YUTNORI_CG_SUBHEADER_REQUEST_QUEST_FLAG:
-			CMiniGameYutnori::RequestQuestFlag(pChar, YUTNORI_GC_SUBHEADER_SET_QUEST_FLAG);
-			break;
-#endif
-
-		default:
-			CMiniGameYutnori::Analyze(pChar, pkData->bSubHeader, pkData->bArgument);
-			break;
-	}
-}
-#endif
-
-#if defined(__LOOT_FILTER_SYSTEM__)
-void CInputMain::LootFilter(LPCHARACTER ch, const char* c_pData)
-{
-	const TPacketCGLootFilter* p = reinterpret_cast<const TPacketCGLootFilter*>(c_pData);
-	if (ch->GetLootFilter())
-		ch->GetLootFilter()->SetLootFilterSettings(p->settings);
-}
-#endif
-
-#if defined(__GEM_SHOP__)
-void CInputMain::GemShop(LPCHARACTER c_lpCh, const char* c_pszData)
-{
-	const TPacketCGGemShop* c_pPacket = reinterpret_cast<const TPacketCGGemShop*>(c_pszData);
-	if (c_pPacket == nullptr)
+	if (!*CGWhisperDetails->name)
 		return;
 
-	CGemShop* pGemShop = c_lpCh->GetGemShop();
-	if (pGemShop == nullptr)
-		return;
+	TPacketGCWhisperDetails GCWhisperDetails;
+	GCWhisperDetails.header = HEADER_GC_WHISPER_DETAILS;
+	strncpy(GCWhisperDetails.name, CGWhisperDetails->name, sizeof(GCWhisperDetails.name) - 1);
 
-	switch (c_pPacket->bSubHeader)
-	{
-		case SUBHEADER_GEM_SHOP_CLOSE:
-			c_lpCh->SetGemShop(nullptr);
-			break;
-		case SUBHEADER_GEM_SHOP_BUY:
-			pGemShop->Buy(c_pPacket->bSlotIndex);
-			break;
-		case SUBHEADER_GEM_SHOP_SLOT_ADD:
-			pGemShop->AddSlot();
-			break;
-		case SUBHEADER_GEM_SHOP_REFRESH:
-			pGemShop->Refresh();
-			break;
-		default:
-			sys_err("CInputMain::GemShop Unknown SubHeader (ch: %s) (%d)", c_lpCh->GetName(), c_pPacket->bSubHeader);
-			break;
-	}
-}
-#endif
+	BYTE bLanguage = LOCALE_DEFAULT;
 
-#if defined(__ATTR_6TH_7TH__)
-void CInputMain::Attr67Add(LPCHARACTER ch, const char* c_pData)
-{
-	const TPacketCGAttr67Add* pkPacket = (TPacketCGAttr67Add*)c_pData;
-	switch (pkPacket->bySubHeader)
-	{
-		case SUBHEADER_CG_ATTR67_ADD_CLOSE:
-			ch->SetOpenAttr67Add(false);
-			break;
-		case SUBHEADER_CG_ATTR67_ADD_OPEN:
-			if (!ch->IsOpenAttr67Add())
-				ch->SetOpenAttr67Add(true);
-			break;
-		case SUBHEADER_CG_ATTR67_ADD_REGIST:
-			if (ch->IsOpenAttr67Add())
-				ch->Attr67Add(pkPacket->Attr67AddData);
-			break;
-		default:
-			return;
-	}
-}
-#endif
-
-#if defined(__EXTEND_INVEN_SYSTEM__)
-void CInputMain::ExtendInven(LPCHARACTER pChar, const char* c_pszData)
-{
-	const TPacketCGExtendInven* pPacket = reinterpret_cast<const TPacketCGExtendInven*>(c_pszData);
-	if (pPacket == nullptr)
-		return;
-
-	if (pPacket->bUpgrade)
-		pChar->ExtendInvenUpgrade();
-	else
-		pChar->ExtendInvenRequest();
-}
-#endif
-
-#if defined(__SNOWFLAKE_STICK_EVENT__)
-void CInputMain::SnowflakeStickEvent(LPCHARACTER pChar, const char* c_pszData)
-{
-	const TPacketCGSnowflakeStickEvent* pPacket = reinterpret_cast<const TPacketCGSnowflakeStickEvent*>(c_pszData);
-	if (pPacket == nullptr)
-		return;
-
-	switch (pPacket->bSubHeader)
-	{
-		case SNOWFLAKE_STICK_EVENT_CG_SUBHEADER_REQUEST_INFO:
-			CSnowflakeStickEvent::Process(pChar, SNOWFLAKE_STICK_EVENT_GC_SUBHEADER_EVENT_INFO);
-			break;
-
-		case SNOWFLAKE_STICK_EVENT_CG_SUBHEADER_EXCHANGE_STICK:
-		case SNOWFLAKE_STICK_EVENT_CG_SUBHEADER_EXCHANGE_PET:
-		case SNOWFLAKE_STICK_EVENT_CG_SUBHEADER_EXCHANGE_MOUNT:
-			CSnowflakeStickEvent::Exchange(pChar, pPacket->bSubHeader);
-			break;
-
-		default:
-			return;
-	}
-}
-#endif
-
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-void CInputMain::RefineElement(LPCHARACTER pChar, const char* c_pszData)
-{
-	const TPacketCGRefineElement* pPacket = reinterpret_cast<const TPacketCGRefineElement*>(c_pszData);
-	if (pPacket == nullptr)
-		return;
+	LPCHARACTER pkChr = CHARACTER_MANAGER::instance().FindPC(CGWhisperDetails->name);
 
-	switch (pPacket->bSubHeader)
-	{
-		case REFINE_ELEMENT_CG_CLOSE:
-			pChar->SetUnderRefineElement(false);
-			break;
-
-		case REFINE_ELEMENT_CG_REFINE:
-			pChar->RefineElement(pPacket->wChangeElement);
-			break;
-
-		default:
-			sys_err("CInputMain::RefineElement: %s received unknown sub header.", pChar->GetName());
-			break;
-	}
-}
-#endif
-
-#if defined(__LEFT_SEAT__)
-void CInputMain::LeftSeat(LPCHARACTER pChar, const char* c_pszData)
-{
-	const TPacketCGLeftSeat* c_pPacket = reinterpret_cast<const TPacketCGLeftSeat*>(c_pszData);
-	if (c_pPacket == nullptr)
-		return;
-
-	switch (c_pPacket->bSubHeader)
-	{
-		case LEFT_SEAT_SET_WAIT_TIME_INDEX:
-			pChar->SetLeftSeatWaitTime(c_pPacket->bIndex);
-			break;
-
-		case LEFT_SEAT_SET_LOGOUT_TIME_INDEX:
-			pChar->SetLeftSeatLogoutTime(c_pPacket->bIndex);
-			break;
-
-		case LEFT_SEAT_DISABLE_LOGOUT_STATE:
-			pChar->DisableLeftSeatLogOutState(false);
-			break;
-
-		default:
-			sys_err("CInputMain::LeftSeat: %s received unknown sub header.", pChar->GetName());
-			break;
-	}
-}
-#endif
-
-#if defined(__SUMMER_EVENT_ROULETTE__)
-void CInputMain::MiniGameRoulette(LPCHARACTER pChar, const char* pszData)
-{
-	const TPacketCGMiniGameRoulette* pData = reinterpret_cast<const TPacketCGMiniGameRoulette*>(pszData);
-	if (pData == nullptr)
-	{
-		sys_err("CInputMain::MiniGameRoulette : Data NULL (ch: %s)", pChar->GetName());
-		return;
-	}
-
-	CMiniGameRoulette* pMiniGameRoulette = pChar->GetMiniGameRoulette();
-	if (pMiniGameRoulette == nullptr)
-	{
-		sys_err("CInputMain::MiniGameRoulette : MiniGameRoulette NULL (ch: %s)", pChar->GetName());
-		return;
-	}
-
-	switch (pData->bSubHeader)
-	{
-		case ROULETTE_CG_START:
-			pMiniGameRoulette->Start();
-			break;
-
-		case ROULETTE_CG_REQUEST:
-			pMiniGameRoulette->Request();
-			break;
-
-		case ROULETTE_CG_END:
-			pMiniGameRoulette->End();
-			break;
-
-		case ROULETTE_CG_CLOSE:
-			pMiniGameRoulette->Close();
-			break;
-
-		default:
-			sys_err("CInputMain::MiniGameRoulette : Unknown SubHeader %u (ch: %s)",
-				pData->bSubHeader, pChar->GetName());
-			break;
-	}
-}
-#endif
-
-#if defined(__FLOWER_EVENT__)
-void CInputMain::FlowerEvent(LPCHARACTER pChar, const char* pszData)
-{
-	if (!quest::CQuestManager::instance().GetEventFlag("e_flower_drop"))
-		return;
-
-	const TPacketCGFlowerEvent* pPacketData = reinterpret_cast<const TPacketCGFlowerEvent*>(pszData);
-	if (NULL == pPacketData)
-	{
-		sys_err("NULL TPacketCGFlowerEvent (ch: %s)", pChar->GetName());
-		return;
-	}
-
-	switch (pPacketData->bSubHeader)
-	{
-		case FLOWER_EVENT_SUBHEADER_CG_INFO_ALL:
-			CFlowerEvent::RequestAllInfo(pChar);
-			break;
-
-		case FLOWER_EVENT_SUBHEADER_CG_EXCHANGE:
-			CFlowerEvent::Exchange(pChar, pPacketData->bShootType, pPacketData->bExchangeKey);
-			break;
-
-		default:
-			sys_err("Unknown SubHeader %u (ch: %s)",
-				pPacketData->bSubHeader, pChar->GetName());
-			break;
-	}
-}
-#endif
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-int CInputMain::ReciveExtBattlePassActions(LPCHARACTER ch, const char* data, size_t uiBytes)
-{
-	TPacketCGExtBattlePassAction* p = (TPacketCGExtBattlePassAction*)data;
-
-	if (uiBytes < sizeof(TPacketCGExtBattlePassAction))
-		return -1;
-
-	const char* c_pData = data + sizeof(TPacketCGExtBattlePassAction);
-	uiBytes -= sizeof(TPacketCGExtBattlePassAction);
-
-	switch (p->bAction)
-	{
-		case 1:
-			CBattlePassManager::instance().BattlePassRequestOpen(ch);
-			return 0;
-
-		case 2:
-			if(get_dword_time() < ch->GetLastReciveExtBattlePassOpenRanking()) {
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("BATTLEPASS_NEXT_REFRESH_RANKLIST_TIME"), ((ch->GetLastReciveExtBattlePassOpenRanking() - get_dword_time()) / 1000) + 1 );
-				return 0;
-			}
-			ch->SetLastReciveExtBattlePassOpenRanking(get_dword_time() + 10000);
-			
-			for (BYTE bBattlePassType = 1; bBattlePassType <= 3 ; ++bBattlePassType)
-			{
-				BYTE bBattlePassID;
-				if (bBattlePassType == 1)
-					bBattlePassID = CBattlePassManager::instance().GetNormalBattlePassID();
-				if (bBattlePassType == 2){
-					bBattlePassID = CBattlePassManager::instance().GetPremiumBattlePassID();
-					if (bBattlePassID != ch->GetExtBattlePassPremiumID())
-						continue;
-				}
-				if (bBattlePassType == 3)
-					bBattlePassID = CBattlePassManager::instance().GetEventBattlePassID();
-
-				std::unique_ptr<SQLMsg> pMsg(DBManager::instance().DirectQuery("SELECT player_name, battlepass_type+0, battlepass_id, UNIX_TIMESTAMP(start_time), UNIX_TIMESTAMP(end_time) FROM player.battlepass_playerindex WHERE battlepass_type = %d and battlepass_id = %d and battlepass_completed = 1 and not player_name LIKE '[%%' ORDER BY (UNIX_TIMESTAMP(end_time)-UNIX_TIMESTAMP(start_time)) ASC LIMIT 40", bBattlePassType, bBattlePassID));
-				if (pMsg->uiSQLErrno)
-					return 0;
-
-				MYSQL_ROW row;
-
-				while ((row = mysql_fetch_row(pMsg->Get()->pSQLResult)))
-				{
-					TPacketGCExtBattlePassRanking pack;
-					pack.bHeader = HEADER_GC_EXT_BATTLE_PASS_SEND_RANKING;
-					strlcpy(pack.szPlayerName, row[0], sizeof(pack.szPlayerName));
-					pack.bBattlePassType = std::atoi(row[1]);
-					pack.bBattlePassID = std::atoll(row[2]);
-					pack.dwStartTime = std::atoll(row[3]);
-					pack.dwEndTime = std::atoll(row[4]);
-
-					ch->GetDesc()->Packet(&pack, sizeof(pack));
-				}
-			}
-			break;
-
-		case 10:
-			CBattlePassManager::instance().BattlePassRequestReward(ch, 1);
-			return 0;
-			
-		case 11:
-			CBattlePassManager::instance().BattlePassRequestReward(ch, 2);
-			return 0;
-			
-		case 12:
-			CBattlePassManager::instance().BattlePassRequestReward(ch, 3);
-			return 0;
-
-
-		default:
-			break;
-	}
-
-	return 0;
-}
-
-int CInputMain::ReciveExtBattlePassPremiumItem(LPCHARACTER ch, const char* data, size_t uiBytes)
-{
-	TPacketCGExtBattlePassSendPremiumItem* p = (TPacketCGExtBattlePassSendPremiumItem*)data;
-
-	if (uiBytes < sizeof(TPacketCGExtBattlePassSendPremiumItem))
-		return -1;
-
-	const char* c_pData = data + sizeof(TPacketCGExtBattlePassSendPremiumItem);
-	uiBytes -= sizeof(TPacketCGExtBattlePassSendPremiumItem);
-
-	LPITEM item = ch->GetInventoryItem(p->iSlotIndex);
-	if (item != NULL and item->GetVnum() == 93100)
-	{
-		ch->PointChange(POINT_BATTLE_PASS_PREMIUM_ID, CBattlePassManager::instance().GetPremiumBattlePassID());
-		CBattlePassManager::instance().BattlePassRequestOpen(ch);
-		item->SetCount(item->GetCount() - 1);
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("BATTLEPASS_NOW_IS_ACTIVATED_PREMIUM_BATTLEPASS_OWN"));
-	}
-	return 0;
-}
-#endif
-
-int CInputMain::Analyze(LPDESC d, BYTE bHeader, const char* c_pData)
-{
-	LPCHARACTER ch;
-
-	if (!(ch = d->GetCharacter()))
-	{
-		sys_err("no character on desc");
-		d->SetPhase(PHASE_CLOSE);
-		return (0);
-	}
-
-	int iExtraLen = 0;
-
-	if (test_server && bHeader != HEADER_CG_MOVE)
-		sys_log(0, "CInputMain::Analyze() ==> Header [%d] ", bHeader);
-
-#if defined(__LEFT_SEAT__)
-	const std::unordered_set<BYTE> bExcludeLeftSeatHeader = {
-		HEADER_CG_LEFT_SEAT,
-		HEADER_CG_TIME_SYNC,
-		HEADER_CG_PONG,
-	};
-
-	if (bExcludeLeftSeatHeader.find(bHeader) == bExcludeLeftSeatHeader.end())
-	{
-		if (ch->LeftSeat())
-			ch->DisableLeftSeatLogOutState(true);
-
-		ch->SetLastRequestTime(get_dword_time());
-	}
-#endif
-
-	switch (bHeader)
+	if (!pkChr)
 	{
-		case HEADER_CG_PONG:
-			Pong(d);
-			break;
+		LPDESC pkDesc = NULL;
+		CCI* pkCCI = P2P_MANAGER::instance().Find(CGWhisperDetails->name);
 
-		case HEADER_CG_TIME_SYNC:
-			Handshake(d, c_pData);
-			break;
-
-		case HEADER_CG_CHAT:
-			if (test_server)
-			{
-				char* pBuf = (char*)c_pData;
-				sys_log(0, "%s", pBuf + sizeof(TPacketCGChat));
-			}
-
-			if ((iExtraLen = Chat(ch, c_pData, m_iBufferLeft)) < 0)
-				return -1;
-
-			break;
-
-		case HEADER_CG_WHISPER:
-			if ((iExtraLen = Whisper(ch, c_pData, m_iBufferLeft)) < 0)
-				return -1;
-			break;
-
-		case HEADER_CG_MOVE:
-			Move(ch, c_pData);
-			break;
-
-		case HEADER_CG_CHARACTER_POSITION:
-			Position(ch, c_pData);
-			break;
-
-		case HEADER_CG_ITEM_USE:
-			if (!ch->IsObserverMode())
-				ItemUse(ch, c_pData);
-			break;
-
-		case HEADER_CG_ITEM_DROP:
-			if (!ch->IsObserverMode())
-			{
-				ItemDrop(ch, c_pData);
-			}
-			break;
-
-		case HEADER_CG_ITEM_DROP2:
-			if (!ch->IsObserverMode())
-				ItemDrop2(ch, c_pData);
-			break;
-
-#if defined(__NEW_DROP_DIALOG__)
-		case HEADER_CG_ITEM_DESTROY:
-			if (!ch->IsObserverMode())
-				ItemDestroy(ch, c_pData);
-			break;
-#endif
-
-		case HEADER_CG_ITEM_MOVE:
-			if (!ch->IsObserverMode())
-				ItemMove(ch, c_pData);
-			break;
-
-		case HEADER_CG_ITEM_PICKUP:
-			if (!ch->IsObserverMode())
-				ItemPickup(ch, c_pData);
-			break;
-
-		case HEADER_CG_ITEM_USE_TO_ITEM:
-			if (!ch->IsObserverMode())
-				ItemToItem(ch, c_pData);
-			break;
-
-		case HEADER_CG_ITEM_GIVE:
-			if (!ch->IsObserverMode())
-				ItemGive(ch, c_pData);
-			break;
-
-		case HEADER_CG_EXCHANGE:
-			if (!ch->IsObserverMode())
-				Exchange(ch, c_pData);
-			break;
-
-		case HEADER_CG_ATTACK:
-		case HEADER_CG_SHOOT:
-			if (!ch->IsObserverMode())
-			{
-				Attack(ch, bHeader, c_pData);
-			}
-			break;
-
-		case HEADER_CG_USE_SKILL:
-			if (!ch->IsObserverMode())
-				UseSkill(ch, c_pData);
-			break;
-
-#ifdef __OFFLINE_SHOP__
-		case HEADER_CG_OFFLINE_SHOP:
-		{
-			if ((iExtraLen = COfflineShop::ReceivePacket(ch, c_pData, m_iBufferLeft)) < 0) {
-				return -1;
-			}
-
-			break;
-		}
-#endif
-
-#ifdef __SHOP_SEARCH__
-		case HEADER_CG_SHOP_SEARCH_BY_NAME:
-			ShopSearchByName(ch, c_pData);
-			break;
-
-		case HEADER_CG_SHOP_SEARCH_BY_OPTION:
-			if ((iExtraLen = ShopSearchByOptions(ch, c_pData, m_iBufferLeft)) < 0)
-				return -1;
-			break;
-
-		case HEADER_CG_SHOP_SEARCH_BUY:
-			ShopSearchBuy(ch, c_pData);
-			break;
-
-		case HEADER_CG_SHOP_SEARCH_OWNER_MESSAGE:
-			ShopSearchOwnerMessage(ch, c_pData);
-			break;
-
-		case HEADER_CG_SHOP_SEARCH_REQUEST_SOLD_INFO:
-			ShopSearchRequestSoldInfo(ch, c_pData);
-			break;
-#endif
-
-#ifdef __GROWTH_PET_SYSTEM__
-		case HEADER_CG_PET_HATCH:
-			PetHatch(ch, c_pData);
-			break;
-
-		case HEADER_CG_PET_WINDOW:
-			PetWindow(ch, c_pData);
-			break;
-
-		case HEADER_CG_PET_WINDOW_TYPE:
-			PetWindowType(ch, c_pData);
-			break;
-
-		case HEADER_CG_PET_NAME_CHANGE:
-			PetNameChange(ch, c_pData);
-			break;
-
-		case HEADER_CG_PET_FEED:
-			PetFeed(ch, c_pData);
-			break;
-
-		case HEADER_CG_PET_DETERMINE:
-			PetDetermine(ch, c_pData);
-			break;
-
-		case HEADER_CG_PET_ATTR_CHANGE:
-			PetAttrChange(ch, c_pData);
-			break;
-
-		case HEADER_CG_PET_REVIVE:
-			PetRevive(ch, c_pData);
-			break;
-
-		case HEADER_CG_PET_LEARN_SKILL:
-			PetLearnSkill(ch, c_pData);
-			break;
-
-		case HEADER_CG_PET_SKILL_UPGRADE:
-			PetSkillUpgrade(ch, c_pData);
-			break;
-
-		case HEADER_CG_PET_DELETE_SKILL:
-			PetDeleteSkill(ch, c_pData);
-			break;
-
-		case HEADER_CG_PET_DELETE_ALL_SKILL:
-			PetDeleteAllSkill(ch, c_pData);
-			break;
-#endif
-
-		case HEADER_CG_QUICKSLOT_ADD:
-			QuickslotAdd(ch, c_pData);
-			break;
-
-		case HEADER_CG_QUICKSLOT_DEL:
-			QuickslotDelete(ch, c_pData);
-			break;
-
-		case HEADER_CG_QUICKSLOT_SWAP:
-			QuickslotSwap(ch, c_pData);
-			break;
-
-		case HEADER_CG_SHOP:
-			if ((iExtraLen = Shop(ch, c_pData, m_iBufferLeft)) < 0)
-				return -1;
-			break;
-
-		case HEADER_CG_MESSENGER:
-			if ((iExtraLen = Messenger(ch, c_pData, m_iBufferLeft)) < 0)
-				return -1;
-			break;
-
-		case HEADER_CG_ON_CLICK:
-			OnClick(ch, c_pData);
-			break;
-
-		case HEADER_CG_SYNC_POSITION:
-			if ((iExtraLen = SyncPosition(ch, c_pData, m_iBufferLeft)) < 0)
-				return -1;
-			break;
-
-		case HEADER_CG_ADD_FLY_TARGETING:
-		case HEADER_CG_FLY_TARGETING:
-			FlyTarget(ch, c_pData, bHeader);
-			break;
-
-		case HEADER_CG_SCRIPT_BUTTON:
-			ScriptButton(ch, c_pData);
-			break;
-
-			// SCRIPT_SELECT_ITEM
-		case HEADER_CG_SCRIPT_SELECT_ITEM:
-			ScriptSelectItem(ch, c_pData);
-			break;
-			// END_OF_SCRIPT_SELECT_ITEM
-
-		case HEADER_CG_SCRIPT_ANSWER:
-			ScriptAnswer(ch, c_pData);
-			break;
-
-#if defined(__GEM_SYSTEM__)
-		case HEADER_CG_SELECT_ITEM_EX:
-			SelectItemEx(ch, c_pData);
-			break;
-#endif
-
-#if defined(__QUEST_REQUEST_EVENT__)
-		case HEADER_CG_REQUEST_EVENT_QUEST:
-			RequestEventQuest(ch, c_pData);
-			break;
-#endif
-
-		case HEADER_CG_QUEST_INPUT_STRING:
-			QuestInputString(ch, c_pData);
-			break;
-
-#if defined(__OX_RENEWAL__)
-		case HEADER_CG_QUEST_INPUT_LONG_STRING:
-			QuestInputLongString(ch, c_pData);
-			break;
-#endif
-
-		case HEADER_CG_QUEST_CONFIRM:
-			QuestConfirm(ch, c_pData);
-			break;
-
-		case HEADER_CG_TARGET:
-			Target(ch, c_pData);
-			break;
-
-		case HEADER_CG_WARP:
-			Warp(ch, c_pData);
-			break;
-
-		case HEADER_CG_SAFEBOX_CHECKIN:
-			SafeboxCheckin(ch, c_pData);
-			break;
-
-		case HEADER_CG_SAFEBOX_CHECKOUT:
-			SafeboxCheckout(ch, c_pData, false);
-			break;
-
-		case HEADER_CG_SAFEBOX_ITEM_MOVE:
-			SafeboxItemMove(ch, c_pData);
-			break;
-
-		case HEADER_CG_MALL_CHECKOUT:
-			SafeboxCheckout(ch, c_pData, true);
-			break;
-
-		case HEADER_CG_PARTY_INVITE:
-			PartyInvite(ch, c_pData);
-			break;
-
-		case HEADER_CG_PARTY_REMOVE:
-			PartyRemove(ch, c_pData);
-			break;
-
-		case HEADER_CG_PARTY_INVITE_ANSWER:
-			PartyInviteAnswer(ch, c_pData);
-			break;
-
-		case HEADER_CG_PARTY_SET_STATE:
-			PartySetState(ch, c_pData);
-			break;
-
-		case HEADER_CG_PARTY_USE_SKILL:
-			PartyUseSkill(ch, c_pData);
-			break;
-
-		case HEADER_CG_PARTY_PARAMETER:
-			PartyParameter(ch, c_pData);
-			break;
-
-		case HEADER_CG_ANSWER_MAKE_GUILD:
-			AnswerMakeGuild(ch, c_pData);
-			break;
-
-		case HEADER_CG_GUILD:
-			if ((iExtraLen = Guild(ch, c_pData, m_iBufferLeft)) < 0)
-				return -1;
-			break;
-
-		case HEADER_CG_FISHING:
-			Fishing(ch, c_pData);
-			break;
-
-#if defined(__FISHING_GAME__)
-		case HEADER_CG_FISHING_GAME:
-			FishingGame(ch, c_pData);
-			break;
-#endif
-
-		case HEADER_CG_HACK:
-			Hack(ch, c_pData);
-			break;
-
-		case HEADER_CG_MYSHOP:
-			if ((iExtraLen = MyShop(ch, c_pData, m_iBufferLeft)) < 0)
-				return -1;
-			break;
-
-#if defined(__MYSHOP_DECO__)
-		case HEADER_CG_MYSHOP_DECO_STATE:
-			MyShopDecoState(ch, c_pData);
-			break;
-
-		case HEADER_CG_MYSHOP_DECO_ADD:
-			MyShopDecoAdd(ch, c_pData);
-			break;
-#endif
-
-		case HEADER_CG_REFINE:
-			Refine(ch, c_pData);
-			break;
-
-#if defined(__CUBE_RENEWAL__)
-		case HEADER_CG_CUBE:
-			Cube(ch, c_pData);
-			break;
-#endif
-
-		case HEADER_CG_CLIENT_VERSION:
-			Version(ch, c_pData);
-			break;
-
-#if defined(__DRAGON_SOUL_SYSTEM__)
-		case HEADER_CG_DRAGON_SOUL_REFINE:
-		{
-			TPacketCGDragonSoulRefine* p = reinterpret_cast <TPacketCGDragonSoulRefine*>((void*)c_pData);
-			switch (p->bSubType)
-			{
-				case DS_SUB_HEADER_CLOSE:
-					ch->DragonSoul_RefineWindow_Close();
-					break;
-
-				case DS_SUB_HEADER_DO_REFINE_GRADE:
-				{
-					DSManager::instance().DoRefineGrade(ch, p->ItemGrid);
-				}
-				break;
-
-				case DS_SUB_HEADER_DO_REFINE_STEP:
-				{
-					DSManager::instance().DoRefineStep(ch, p->ItemGrid);
-				}
-				break;
-
-				case DS_SUB_HEADER_DO_REFINE_STRENGTH:
-				{
-					DSManager::instance().DoRefineStrength(ch, p->ItemGrid);
-				}
-				break;
-
-#if defined(__DS_CHANGE_ATTR__)
-				case DS_SUB_HEADER_DO_CHANGE_ATTR:
-				{
-					DSManager::instance().DoChangeAttribute(ch, p->ItemGrid);
-				}
-				break;
-#endif
-			}
-		}
-		break;
-#endif
-
-#if defined(__SEND_TARGET_INFO__)
-		case HEADER_CG_TARGET_INFO:
-			TargetInfo(ch, c_pData);
-			break;
-#endif
-
-#if defined(__MOVE_COSTUME_ATTR__)
-		case HEADER_CG_ITEM_COMBINATION:
-			ItemCombination(ch, c_pData);
-			break;
-
-		case HEADER_CG_ITEM_COMBINATION_CANCEL:
-			ItemCombinationCancel(ch, c_pData);
-			break;
-#endif
-
-#if defined(__CHANGED_ATTR__)
-		case HEADER_CG_ITEM_SELECT_ATTR:
-			ItemSelectAttr(ch, c_pData);
-			break;
-#endif
-
-#if defined(__ACCE_COSTUME_SYSTEM__)
-		case HEADER_CG_ACCE_REFINE:
-			if ((iExtraLen = AcceRefine(ch, c_pData, m_iBufferLeft)) < 0)
-				return -1;
-			break;
-#endif
-
-#if defined(__AURA_COSTUME_SYSTEM__)
-		case HEADER_CG_AURA_REFINE:
-			if ((iExtraLen = AuraRefine(ch, c_pData, m_iBufferLeft)) < 0)
-				return -1;
-			break;
-#endif
-
-#if defined(__CHANGE_LOOK_SYSTEM__)
-		case HEADER_CG_CHANGE_LOOK:
-			ChangeLook(ch, c_pData);
-			break;
-#endif
-
-#if defined(__MINI_GAME_CATCH_KING__)
-		case HEADER_CG_MINI_GAME_CATCH_KING:
-			if ((iExtraLen = CMiniGameCatchKing::Process(ch, c_pData, m_iBufferLeft)) < 0)
-				return -1;
-			break;
-#endif
-
-#if defined(__SKILLBOOK_COMB_SYSTEM__)
-		case HEADER_CG_SKILLBOOK_COMB:
+		if (pkCCI)
 		{
-			TPacketCGSkillBookCombination* p = reinterpret_cast <TPacketCGSkillBookCombination*>((void*)c_pData);
-			SkillBookCombination(ch, p->CombItemGrid, p->bAction);
+			pkDesc = pkCCI->pkDesc;
+			if (pkDesc)
+				bLanguage = pkCCI->bLanguage;
 		}
-		break;
-#endif
-
-#if defined(__MAILBOX__)
-		case HEADER_CG_MAILBOX_WRITE:
-			MailboxWrite(ch, c_pData);
-			break;
-
-		case HEADER_CG_MAILBOX_WRITE_CONFIRM:
-			MailboxConfirm(ch, c_pData);
-			break;
-
-		case HEADER_CG_MAILBOX_PROCESS:
-			MailboxProcess(ch, c_pData);
-			break;
-#endif
-
-#if defined(__LOOT_FILTER_SYSTEM__)
-		case HEADER_CG_LOOT_FILTER:
-			LootFilter(ch, c_pData);
-			break;
-#endif
-
-#if defined(__MINI_GAME_RUMI__)
-		case HEADER_CG_MINI_GAME_RUMI:
-			MiniGameRumi(ch, c_pData);
-			break;
-#endif
-
-#if defined(__MINI_GAME_YUTNORI__)
-		case HEADER_CG_MINI_GAME_YUTNORI:
-			MiniGameYutnori(ch, c_pData);
-			break;
-#endif
-
-#if defined(__LUCKY_BOX__)
-		case HEADER_CG_LUCKY_BOX:
-			LuckyBox(ch, c_pData);
-			break;
-#endif
-
-#if defined(__GEM_SHOP__)
-		case HEADER_CG_GEM_SHOP:
-			GemShop(ch, c_pData);
-			break;
-#endif
-
-#if defined(__EXTEND_INVEN_SYSTEM__)
-		case HEADER_CG_EXTEND_INVEN:
-			ExtendInven(ch, c_pData);
-			break;
-#endif
-
-#if defined(__ATTR_6TH_7TH__)
-		case HEADER_CG_ATTR67_ADD:
-			Attr67Add(ch, c_pData);
-			break;
-#endif
-
-#if defined(__SNOWFLAKE_STICK_EVENT__)
-		case HEADER_CG_SNOWFLAKE_STICK_EVENT:
-			SnowflakeStickEvent(ch, c_pData);
-			break;
-#endif
-
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-		case HEADER_CG_REFINE_ELEMENT:
-			RefineElement(ch, c_pData);
-			break;
-#endif
-
-#if defined(__LEFT_SEAT__)
-		case HEADER_CG_LEFT_SEAT:
-			LeftSeat(ch, c_pData);
-			break;
-#endif
-
-#if defined(__SUMMER_EVENT_ROULETTE__)
-		case HEADER_CG_MINI_GAME_ROULETTE:
-			MiniGameRoulette(ch, c_pData);
-			break;
-#endif
-
-#if defined(__SUMMER_EVENT_ROULETTE__)
-		case HEADER_CG_FLOWER_EVENT:
-			FlowerEvent(ch, c_pData);
-			break;
-#endif
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-		case HEADER_CG_EXT_BATTLE_PASS_ACTION:
-			if ((iExtraLen = ReciveExtBattlePassActions(ch, c_pData, m_iBufferLeft)) < 0)
-				return -1;
-			break;
-			
-		case HEADER_CG_EXT_SEND_BP_PREMIUM_ITEM:
-			if ((iExtraLen = ReciveExtBattlePassPremiumItem(ch, c_pData, m_iBufferLeft)) < 0)
-				return -1;
-			break;
-#endif
 	}
-
-	return (iExtraLen);
-}
-
-#if defined(__LUCKY_BOX__)
-void CInputMain::LuckyBox(LPCHARACTER ch, const char* c_pData)
-{
-	const TPacketCGLuckyBox* c_pPacket = reinterpret_cast<const TPacketCGLuckyBox*>(c_pData);
-
-	switch (c_pPacket->bAction)
-	{
-		case ELUCKY_BOX_ACTION::LUCKY_BOX_ACTION_RETRY:
-			ch->LuckyBoxRetry();
-			break;
-		case ELUCKY_BOX_ACTION::LUCKY_BOX_ACTION_RECEIVE:
-			ch->LuckyBoxReceive();
-			break;
-		default:
-			sys_err("CInputMain::LuckyBox : Unknown action %d : %s", c_pPacket->bAction, ch->GetName());
-			return;
-	}
-}
-#endif
-
-#ifdef __SHOP_SEARCH__
-void CInputMain::ShopSearchByName(LPCHARACTER ch, const char* data)
-{
-	if (!ch || !ch->GetDesc())
-		return;
-
-	if (!ch->CheckShopSearchFlood())
-		return;
-
-	TPacketCGShopSearchByName* p = (TPacketCGShopSearchByName*)data;
-
-	const size_t nameLen = strnlen(p->itemName, sizeof(p->itemName));
-	if (nameLen == 0 || nameLen >= sizeof(p->itemName))
-		return;
-
-	// Prevent extremely expensive broad searches (e.g. "a")
-	if (nameLen < 2)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Search term is too short."));
-		return;
-	}
-
-	CShopSearchManager::PC_RequestSearch(ch, p->itemName, p->page, p->entryCountIdx, p->sortType);
-}
-
-int CInputMain::ShopSearchByOptions(LPCHARACTER ch, const char* data, size_t uiBytes)
-{
-	if (!ch || !ch->GetDesc())
-		return -1;
-
-	if (!ch->CheckShopSearchFlood())
-		return -1;
-
-	TPacketCGShopSearchByOptions* p = (TPacketCGShopSearchByOptions*)data;
-	// Hard upper bounds to avoid pathological packets.
-	if (p->options.typeFlagCount > 32 || p->options.specificVnumCount > 32)
-		return -1;
-	data += sizeof(TPacketCGShopSearchByOptions);
-	uiBytes -= sizeof(TPacketCGShopSearchByOptions);
-
-	if (uiBytes < sizeof(TShopSearchItemType) * p->options.typeFlagCount)
-		return -1;
-
-	TShopSearchItemType* itemTypeFlags = (TShopSearchItemType*)data;
-	data += sizeof(TShopSearchItemType) * p->options.typeFlagCount;
-	uiBytes -= sizeof(TShopSearchItemType) * p->options.typeFlagCount;
-
-	if (uiBytes < sizeof(DWORD) * p->options.specificVnumCount)
-		return -1;
-
-	CShopSearchManager::PC_RequestSearch(ch, &p->options, itemTypeFlags, (const DWORD*)data, p->page, p->entryCountIdx, p->sortType);
-
-	return sizeof(TShopSearchItemType) * p->options.typeFlagCount + sizeof(DWORD) * p->options.specificVnumCount;
-}
-
-void CInputMain::ShopSearchBuy(LPCHARACTER ch, const char* data)
-{
-	if (!ch || !ch->GetDesc())
-		return;
-
-	// Buying can also be spammed; keep it under control.
-	if (!ch->CheckShopSearchFlood())
-		return;
-
-	TPacketCGShopSearchBuy* p = (TPacketCGShopSearchBuy*)data;
-
-	CShopSearchManager::PC_RequestBuy(ch, p->itemID, p->itemVnum, p->itemPrice);
-}
-
-void CInputMain::ShopSearchOwnerMessage(LPCHARACTER ch, const char* data)
-{
-	if (!ch || !ch->GetDesc())
-		return;
-
-	if (!ch->CheckShopSearchFlood())
-		return;
-
-	TPacketCGShopSearchOwnerMessage* p = (TPacketCGShopSearchOwnerMessage*)data;
-
-	TPacketGCShopSearchOwnerMessage pack;
-	pack.header = HEADER_GC_SHOP_SEARCH_OWNER_MESSAGE;
-	memset(pack.ownerName, 0, sizeof(pack.ownerName));
-
-	if (LPCHARACTER tch = CHARACTER_MANAGER::instance().FindByPID(p->ownerID))
-		strlcpy(pack.ownerName, tch->GetName(), sizeof(pack.ownerName));
-	else if (CCI* pkCCI = P2P_MANAGER::instance().FindByPID(p->ownerID))
-		strlcpy(pack.ownerName, pkCCI->szName, sizeof(pack.ownerName));
 	else
 	{
-		std::unique_ptr<SQLMsg> pMsg(DBManager::instance().DirectQuery("SELECT name FROM player WHERE id = %u", p->ownerID));
-		if (MYSQL_ROW row = mysql_fetch_row(pMsg->Get()->pSQLResult))
-		{
-			strlcpy(pack.ownerName, row[0], sizeof(pack.ownerName));
-		}
+		bLanguage = pkChr->GetLanguage();
 	}
 
-	ch->GetDesc()->Packet(&pack, sizeof(pack));
-}
-
-void CInputMain::ShopSearchRequestSoldInfo(LPCHARACTER ch, const char* data)
-{
-	if (!ch || !ch->GetDesc())
-		return;
-
-	if (!ch->CheckShopSearchFlood())
-		return;
-
-	TPacketCGShopSearchRequestSoldInfo* p = (TPacketCGShopSearchRequestSoldInfo*)data;
-
-	CShopSearchManager::PC_RequestSoldInfo(ch, p->itemVnum);
+	GCWhisperDetails.bLanguage = bLanguage;
+	ch->GetDesc()->Packet(&GCWhisperDetails, sizeof(GCWhisperDetails));
 }
-#endif
 
 #ifdef __GROWTH_PET_SYSTEM__
 void CInputMain::PetHatch(LPCHARACTER ch, const char* c_pData)
@@ -5315,7 +4371,7 @@
 
 	if (!ch || !ch->GetDesc())
 		return;
-	
+
 	CGrowthPetManager::Instance().EggHatch(ch, p->name, p->eggPos);
 }
 
@@ -5376,7 +4432,7 @@
 	if (ch->GetActiveGrowthPet())
 		ch->GetActiveGrowthPet()->Feed(p);
 	else
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Activate your pet first."));
+		ch->ChatPacket(CHAT_TYPE_INFO, "Activate your pet first.");
 }
 
 void CInputMain::PetDetermine(LPCHARACTER ch, const char* c_pData)
@@ -5395,7 +4451,7 @@
 
 	if (!ch->GetActiveGrowthPet())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Activate your pet first."));
+		ch->ChatPacket(CHAT_TYPE_INFO, "Activate your pet first.");
 		return;
 	}
 
@@ -5467,7 +4523,7 @@
 
 	if (!ch->GetActiveGrowthPet())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Activate your pet first."));
+		ch->ChatPacket(CHAT_TYPE_INFO, "Activate your pet first.");
 		return;
 	}
 
@@ -5480,7 +4536,7 @@
 
 	if (!ch->GetActiveGrowthPet())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Activate your pet first."));
+		ch->ChatPacket(CHAT_TYPE_INFO, "Activate your pet first.");
 		return;
 	}
 
@@ -5503,7 +4559,7 @@
 
 	if (!ch->GetActiveGrowthPet())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Activate your pet first."));
+		ch->ChatPacket(CHAT_TYPE_INFO, "Activate your pet first.");
 		return;
 	}
 
@@ -5526,7 +4582,7 @@
 
 	if (!ch->GetActiveGrowthPet())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Activate your pet first."));
+		ch->ChatPacket(CHAT_TYPE_INFO, "Activate your pet first.");
 		return;
 	}
 
@@ -5565,6 +4621,427 @@
 }
 #endif
 
+int CInputMain::Analyze(LPDESC d, BYTE bHeader, const char* c_pData)
+{
+	LPCHARACTER ch;
+
+	if (!(ch = d->GetCharacter()))
+	{
+		sys_err("no character on desc");
+		d->SetPhase(PHASE_CLOSE);
+		return (0);
+	}
+
+	int iExtraLen = 0;
+
+	if (test_server && bHeader != HEADER_CG_MOVE)
+		sys_log(0, "CInputMain::Analyze() ==> Header [%d] ", bHeader);
+
+	switch (bHeader)
+	{
+	case HEADER_CG_PONG:
+		Pong(d);
+		break;
+
+	case HEADER_CG_TIME_SYNC:
+		Handshake(d, c_pData);
+		break;
+
+	case HEADER_CG_CHAT:
+		if (test_server)
+		{
+			char* pBuf = (char*)c_pData;
+			sys_log(0, "%s", pBuf + sizeof(TPacketCGChat));
+		}
+
+		if ((iExtraLen = Chat(ch, c_pData, m_iBufferLeft)) < 0)
+			return -1;
+
+		break;
+
+	case HEADER_CG_WHISPER:
+		if ((iExtraLen = Whisper(ch, c_pData, m_iBufferLeft)) < 0)
+			return -1;
+		break;
+
+	case HEADER_CG_MOVE:
+		Move(ch, c_pData);
+		break;
+
+	case HEADER_CG_CHARACTER_POSITION:
+		Position(ch, c_pData);
+		break;
+
+	case HEADER_CG_ITEM_USE:
+		if (!ch->IsObserverMode())
+			ItemUse(ch, c_pData);
+		break;
+
+	case HEADER_CG_ITEM_DROP:
+		if (!ch->IsObserverMode())
+		{
+			ItemDrop(ch, c_pData);
+		}
+		break;
+
+	case HEADER_CG_ITEM_DROP2:
+		if (!ch->IsObserverMode())
+			ItemDrop2(ch, c_pData);
+		break;
+
+#if defined(__NEW_DROP_DIALOG__)
+	case HEADER_CG_ITEM_DESTROY:
+		if (!ch->IsObserverMode())
+			ItemDestroy(ch, c_pData);
+		break;
+#endif
+
+	case HEADER_CG_ITEM_MOVE:
+		if (!ch->IsObserverMode())
+			ItemMove(ch, c_pData);
+		break;
+
+	case HEADER_CG_ITEM_PICKUP:
+		if (!ch->IsObserverMode())
+			ItemPickup(ch, c_pData);
+		break;
+
+	case HEADER_CG_ITEM_USE_TO_ITEM:
+		if (!ch->IsObserverMode())
+			ItemToItem(ch, c_pData);
+		break;
+
+	case HEADER_CG_ITEM_GIVE:
+		if (!ch->IsObserverMode())
+			ItemGive(ch, c_pData);
+		break;
+
+	case HEADER_CG_EXCHANGE:
+		if (!ch->IsObserverMode())
+			Exchange(ch, c_pData);
+		break;
+
+	case HEADER_CG_ATTACK:
+	case HEADER_CG_SHOOT:
+		if (!ch->IsObserverMode())
+		{
+			Attack(ch, bHeader, c_pData);
+		}
+		break;
+
+	case HEADER_CG_USE_SKILL:
+		if (!ch->IsObserverMode())
+			UseSkill(ch, c_pData);
+		break;
+
+#if defined(__SKILL_COLOR_SYSTEM__)
+	case HEADER_CG_SKILL_COLOR:
+		SetSkillColor(ch, c_pData);
+		break;
+#endif
+
+	case HEADER_CG_QUICKSLOT_ADD:
+		QuickslotAdd(ch, c_pData);
+		break;
+
+	case HEADER_CG_QUICKSLOT_DEL:
+		QuickslotDelete(ch, c_pData);
+		break;
+
+	case HEADER_CG_QUICKSLOT_SWAP:
+		QuickslotSwap(ch, c_pData);
+		break;
+
+	case HEADER_CG_SHOP:
+		if ((iExtraLen = Shop(ch, c_pData, m_iBufferLeft)) < 0)
+			return -1;
+		break;
+
+	case HEADER_CG_MESSENGER:
+		if ((iExtraLen = Messenger(ch, c_pData, m_iBufferLeft)) < 0)
+			return -1;
+		break;
+
+	case HEADER_CG_ON_CLICK:
+		OnClick(ch, c_pData);
+		break;
+
+	case HEADER_CG_SYNC_POSITION:
+		if ((iExtraLen = SyncPosition(ch, c_pData, m_iBufferLeft)) < 0)
+			return -1;
+		break;
+
+	case HEADER_CG_ADD_FLY_TARGETING:
+	case HEADER_CG_FLY_TARGETING:
+		FlyTarget(ch, c_pData, bHeader);
+		break;
+
+	case HEADER_CG_SCRIPT_BUTTON:
+		ScriptButton(ch, c_pData);
+		break;
+
+		// SCRIPT_SELECT_ITEM
+	case HEADER_CG_SCRIPT_SELECT_ITEM:
+		ScriptSelectItem(ch, c_pData);
+		break;
+		// END_OF_SCRIPT_SELECT_ITEM
+
+	case HEADER_CG_SCRIPT_ANSWER:
+		ScriptAnswer(ch, c_pData);
+		break;
+
+	case HEADER_CG_QUEST_INPUT_STRING:
+		QuestInputString(ch, c_pData);
+		break;
+
+	case HEADER_CG_QUEST_CONFIRM:
+		QuestConfirm(ch, c_pData);
+		break;
+
+	case HEADER_CG_TARGET:
+		Target(ch, c_pData);
+		break;
+
+	case HEADER_CG_WARP:
+		Warp(ch, c_pData);
+		break;
+
+	case HEADER_CG_SAFEBOX_CHECKIN:
+		SafeboxCheckin(ch, c_pData);
+		break;
+
+	case HEADER_CG_SAFEBOX_CHECKOUT:
+		SafeboxCheckout(ch, c_pData, false);
+		break;
+
+	case HEADER_CG_SAFEBOX_ITEM_MOVE:
+		SafeboxItemMove(ch, c_pData);
+		break;
+
+	case HEADER_CG_MALL_CHECKOUT:
+		SafeboxCheckout(ch, c_pData, true);
+		break;
+
+	case HEADER_CG_PARTY_INVITE:
+		PartyInvite(ch, c_pData);
+		break;
+
+	case HEADER_CG_PARTY_REMOVE:
+		PartyRemove(ch, c_pData);
+		break;
+
+	case HEADER_CG_PARTY_INVITE_ANSWER:
+		PartyInviteAnswer(ch, c_pData);
+		break;
+
+	case HEADER_CG_PARTY_SET_STATE:
+		PartySetState(ch, c_pData);
+		break;
+
+	case HEADER_CG_PARTY_USE_SKILL:
+		PartyUseSkill(ch, c_pData);
+		break;
+
+	case HEADER_CG_PARTY_PARAMETER:
+		PartyParameter(ch, c_pData);
+		break;
+
+	case HEADER_CG_ANSWER_MAKE_GUILD:
+		AnswerMakeGuild(ch, c_pData);
+		break;
+
+	case HEADER_CG_GUILD:
+		if ((iExtraLen = Guild(ch, c_pData, m_iBufferLeft)) < 0)
+			return -1;
+		break;
+
+	case HEADER_CG_FISHING:
+		Fishing(ch, c_pData);
+		break;
+
+	case HEADER_CG_HACK:
+		Hack(ch, c_pData);
+		break;
+
+	case HEADER_CG_MYSHOP:
+		if ((iExtraLen = MyShop(ch, c_pData, m_iBufferLeft)) < 0)
+			return -1;
+		break;
+
+#if defined(__MYSHOP_DECO__)
+	case HEADER_CG_MYSHOP_DECO:
+		MyShopDeco(ch, c_pData);
+		break;
+#endif
+
+	case HEADER_CG_REFINE:
+		Refine(ch, c_pData);
+		break;
+
+	case HEADER_CG_CLIENT_VERSION:
+		Version(ch, c_pData);
+		break;
+
+	case HEADER_CG_DRAGON_SOUL_REFINE:
+	{
+		TPacketCGDragonSoulRefine* p = reinterpret_cast <TPacketCGDragonSoulRefine*>((void*)c_pData);
+		switch (p->bSubType)
+		{
+		case DS_SUB_HEADER_CLOSE:
+			ch->DragonSoul_RefineWindow_Close();
+			break;
+
+		case DS_SUB_HEADER_DO_REFINE_GRADE:
+		{
+			DSManager::instance().DoRefineGrade(ch, p->ItemGrid);
+		}
+		break;
+
+		case DS_SUB_HEADER_DO_REFINE_STEP:
+		{
+			DSManager::instance().DoRefineStep(ch, p->ItemGrid);
+		}
+		break;
+
+		case DS_SUB_HEADER_DO_REFINE_STRENGTH:
+		{
+			DSManager::instance().DoRefineStrength(ch, p->ItemGrid);
+		}
+		break;
+
+		}
+	}
+	break;
+
+#if defined(__SEND_TARGET_INFO__)
+	case HEADER_CG_TARGET_INFO_LOAD:
+	{
+		TargetInfoLoad(ch, c_pData);
+	}
+	break;
+#endif
+
+#if defined(__ACCE_COSTUME_SYSTEM__)
+	case HEADER_CG_ACCE:
+		Acce(ch, c_pData);
+		break;
+#endif
+
+#if defined(__CHANGE_LOOK_SYSTEM__)
+	case HEADER_CG_CHANGE_LOOK:
+	{
+		ChangeLook(ch, c_pData);
+	}
+	break;
+#endif
+
+#if defined(__MINI_GAME_CATCH_KING__)
+	case HEADER_CG_MINI_GAME_CATCH_KING:
+		if ((iExtraLen = CMiniGameManager::instance().MiniGameCatchKing(ch, c_pData, m_iBufferLeft)) < 0)
+			return -1;
+		break;
+#endif
+
+#if defined(__PRIVATE_SHOP_SEARCH_SYSTEM__)
+	case HEADER_CG_SHOP_SEARCH:
+		if (!ch->IsObserverMode())
+			ShopSearch(ch, c_pData, false);
+		break;
+
+	case HEADER_CG_SHOP_SEARCH_SUB:
+		if (!ch->IsObserverMode())
+			ShopSearch(ch, c_pData, true);
+		break;
+
+	case HEADER_CG_SHOP_SEARCH_BUY:
+		if (!ch->IsObserverMode())
+			ShopSearchBuy(ch, c_pData);
+		break;
+#endif
+
+	case HEADER_CG_CHANGE_LANGUAGE:
+	{
+		TPacketChangeLanguage* p = reinterpret_cast <TPacketChangeLanguage*>((void*)c_pData);
+		ChangeLanguage(ch, p->bLanguage);
+	}
+	break;
+
+#if defined(__SKILLBOOK_COMB_SYSTEM__)
+	case HEADER_CG_SKILLBOOK_COMB:
+	{
+		TPacketCGSkillBookCombination* p = reinterpret_cast <TPacketCGSkillBookCombination*>((void*)c_pData);
+		SkillBookCombination(ch, p->CombItemGrid, p->bAction);
+	}
+	break;
+#endif
+
+#ifdef __EXTENDED_WHISPER_DETAILS__
+	case HEADER_CG_WHISPER_DETAILS:
+		WhisperDetails(ch, c_pData);
+		break;
+#endif
+
+#ifdef __GROWTH_PET_SYSTEM__
+	case HEADER_CG_PET_HATCH:
+		PetHatch(ch, c_pData);
+		break;
+
+	case HEADER_CG_PET_WINDOW:
+		PetWindow(ch, c_pData);
+		break;
+
+	case HEADER_CG_PET_WINDOW_TYPE:
+		PetWindowType(ch, c_pData);
+		break;
+
+	case HEADER_CG_PET_NAME_CHANGE:
+		PetNameChange(ch, c_pData);
+		break;
+
+	case HEADER_CG_PET_FEED:
+		PetFeed(ch, c_pData);
+		break;
+
+	case HEADER_CG_PET_DETERMINE:
+		PetDetermine(ch, c_pData);
+		break;
+
+	case HEADER_CG_PET_ATTR_CHANGE:
+		PetAttrChange(ch, c_pData);
+		break;
+
+	case HEADER_CG_PET_REVIVE:
+		PetRevive(ch, c_pData);
+		break;
+
+	case HEADER_CG_PET_LEARN_SKILL:
+		PetLearnSkill(ch, c_pData);
+		break;
+
+	case HEADER_CG_PET_SKILL_UPGRADE:
+		PetSkillUpgrade(ch, c_pData);
+		break;
+
+	case HEADER_CG_PET_DELETE_SKILL:
+		PetDeleteSkill(ch, c_pData);
+		break;
+
+	case HEADER_CG_PET_DELETE_ALL_SKILL:
+		PetDeleteAllSkill(ch, c_pData);
+		break;
+#endif
+#ifdef __AURA_SYSTEM__
+	case HEADER_CG_AURA:
+		if ((iExtraLen = Aura(ch, c_pData, m_iBufferLeft)) < 0)
+			return -1;
+		break;
+#endif
+
+	}
+
+	return (iExtraLen);
+}
+
 int CInputDead::Analyze(LPDESC d, BYTE bHeader, const char* c_pData)
 {
 	LPCHARACTER ch;
@@ -5579,33 +5056,100 @@
 
 	switch (bHeader)
 	{
-		case HEADER_CG_PONG:
-			Pong(d);
-			break;
+	case HEADER_CG_PONG:
+		Pong(d);
+		break;
 
-		case HEADER_CG_TIME_SYNC:
-			Handshake(d, c_pData);
-			break;
+	case HEADER_CG_TIME_SYNC:
+		Handshake(d, c_pData);
+		break;
 
-		case HEADER_CG_CHAT:
-			if ((iExtraLen = Chat(ch, c_pData, m_iBufferLeft)) < 0)
-				return -1;
+	case HEADER_CG_CHAT:
+		if ((iExtraLen = Chat(ch, c_pData, m_iBufferLeft)) < 0)
+			return -1;
 
-			break;
+		break;
 
-		case HEADER_CG_WHISPER:
-			if ((iExtraLen = Whisper(ch, c_pData, m_iBufferLeft)) < 0)
-				return -1;
+	case HEADER_CG_WHISPER:
+		if ((iExtraLen = Whisper(ch, c_pData, m_iBufferLeft)) < 0)
+			return -1;
 
-			break;
+		break;
 
-		case HEADER_CG_HACK:
-			Hack(ch, c_pData);
-			break;
+	case HEADER_CG_HACK:
+		Hack(ch, c_pData);
+		break;
 
-		default:
-			return (0);
+	default:
+		return (0);
 	}
 
 	return (iExtraLen);
 }
+
+#ifdef __AURA_SYSTEM__
+size_t GetAuraSubPacketLength(const EPacketCGAuraSubHeader& SubHeader)
+{
+	switch (SubHeader)
+	{
+	case AURA_SUBHEADER_CG_REFINE_CHECKIN:
+		return sizeof(TSubPacketCGAuraRefineCheckIn);
+	case AURA_SUBHEADER_CG_REFINE_CHECKOUT:
+		return sizeof(TSubPacketCGAuraRefineCheckOut);
+	case AURA_SUBHEADER_CG_REFINE_ACCEPT:
+		return sizeof(TSubPacketCGAuraRefineAccept);
+	case AURA_SUBHEADER_CG_REFINE_CANCEL:
+		return 0;
+	}
+
+	return 0;
+}
+
+int CInputMain::Aura(LPCHARACTER ch, const char* data, size_t uiBytes)
+{
+	if (uiBytes < sizeof(TPacketCGAura))
+		return -1;
+
+	const TPacketCGAura* pinfo = reinterpret_cast<const TPacketCGAura*>(data);
+	const char* c_pData = data + sizeof(TPacketCGAura);
+
+	uiBytes -= sizeof(TPacketCGAura);
+
+	const EPacketCGAuraSubHeader SubHeader = static_cast<EPacketCGAuraSubHeader>(pinfo->bSubHeader);
+	const size_t SubPacketLength = GetAuraSubPacketLength(SubHeader);
+	if (uiBytes < SubPacketLength)
+	{
+		sys_err("invalid aura subpacket length (sublen %d size %u buffer %u)", SubPacketLength, sizeof(TPacketCGAura), uiBytes);
+		return -1;
+	}
+
+	switch (SubHeader)
+	{
+		case AURA_SUBHEADER_CG_REFINE_CHECKIN:
+			{
+				const TSubPacketCGAuraRefineCheckIn* sp = reinterpret_cast<const TSubPacketCGAuraRefineCheckIn*>(c_pData);
+				ch->AuraRefineWindowCheckIn(sp->byAuraRefineWindowType, sp->AuraCell, sp->ItemCell);
+			}
+			return SubPacketLength;
+		case AURA_SUBHEADER_CG_REFINE_CHECKOUT:
+			{
+				const TSubPacketCGAuraRefineCheckOut* sp = reinterpret_cast<const TSubPacketCGAuraRefineCheckOut*>(c_pData);
+				ch->AuraRefineWindowCheckOut(sp->byAuraRefineWindowType, sp->AuraCell);
+			}
+			return SubPacketLength;
+		case AURA_SUBHEADER_CG_REFINE_ACCEPT:
+			{
+				const TSubPacketCGAuraRefineAccept* sp = reinterpret_cast<const TSubPacketCGAuraRefineAccept*>(c_pData);
+				ch->AuraRefineWindowAccept(sp->byAuraRefineWindowType);
+			}
+			return SubPacketLength;
+		case AURA_SUBHEADER_CG_REFINE_CANCEL:
+			{
+				ch->AuraRefineWindowClose();
+			}
+			return SubPacketLength;
+	}
+
+	return 0;
+}
+#endif
\ No newline at end of file
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/item.cpp final/server/server/home/metin2/Source/Server/game/src/item.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/item.cpp	2025-06-28 21:32:34.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/item.cpp	2022-04-27 12:40:29.000000000 +0000
@@ -30,28 +30,24 @@
 	m_pkExpireEvent(NULL),
 	m_pkAccessorySocketExpireEvent(NULL), m_pkOwnershipEvent(NULL), m_dwOwnershipPID(0), m_bSkipSave(false), m_isLocked(false),
 	m_dwMaskVnum(0), m_dwSIGVnum(0)
-#if defined(__CHANGE_LOOK_SYSTEM__)
-	, m_dwTransmutationVnum(0)
-#endif
-#if defined(__SET_ITEM__)
-	, m_bSetValue(0)
-#endif
 #if defined(__SOUL_BIND_SYSTEM__)
-	, m_lSealDate(E_SEAL_DATE_DEFAULT_TIMESTAMP)
-	, m_pkSealDateExpireEvent(NULL)
+	, m_lSoulbind(0), m_pkUnbindTimerExpireEvent(NULL)
+#endif
+#if defined(__CHANGE_LOOK_SYSTEM__)
+	, m_dwTransmutation(0)
 #endif
 #if defined(__SOUL_SYSTEM__)
-	, m_pkSoulTimerUseEvent(nullptr)
+	, m_pkSoulTimeUseEvent(NULL)
+#endif
+#if defined(__EXTENDED_BLEND_AFFECT__)
+	, m_pkBlendUseEvent(NULL)
 #endif
 {
 	memset(&m_alSockets, 0, sizeof(m_alSockets));
-	memset(&m_aAttr, 0, sizeof(m_aAttr));
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	memset(&m_RefineElement, 0, sizeof(m_RefineElement));
-#endif
 #if defined(__ITEM_APPLY_RANDOM__)
 	memset(&m_aApplyRandom, 0, sizeof(m_aApplyRandom));
 #endif
+	memset(&m_aAttr, 0, sizeof(m_aAttr));
 }
 
 CItem::~CItem()
@@ -65,24 +61,22 @@
 
 	m_bWindow = RESERVED_WINDOW;
 	m_pOwner = NULL;
+	m_dwID = 0;
 	m_bEquipped = false;
-	m_dwID = m_dwVID = m_dwCount = 0;
-	m_wCell = 0;
-	m_lFlag = 0;
+	m_dwVID = m_wCell = m_dwCount = m_lFlag = 0;
 	m_pProto = NULL;
 	m_bExchanging = false;
 	memset(&m_alSockets, 0, sizeof(m_alSockets));
-	memset(&m_aAttr, 0, sizeof(m_aAttr));
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	memset(&m_RefineElement, 0, sizeof(m_RefineElement));
-#endif
 #if defined(__ITEM_APPLY_RANDOM__)
 	memset(&m_aApplyRandom, 0, sizeof(m_aApplyRandom));
 #endif
-
+	memset(&m_aAttr, 0, sizeof(m_aAttr));
 #if defined(__SOUL_BIND_SYSTEM__)
-	m_lSealDate = 0;
-	m_pkSealDateExpireEvent = NULL;
+	m_lSoulbind = 0;
+	m_pkUnbindTimerExpireEvent = NULL;
+#endif
+#if defined(__CHANGE_LOOK_SYSTEM__)
+	m_dwTransmutation = 0;
 #endif
 
 	m_pkDestroyEvent = NULL;
@@ -91,11 +85,14 @@
 	m_pkUniqueExpireEvent = NULL;
 	m_pkTimerBasedOnWearExpireEvent = NULL;
 	m_pkRealTimeExpireEvent = NULL;
-
-	m_pkAccessorySocketExpireEvent = NULL;
 #if defined(__SOUL_SYSTEM__)
-	m_pkSoulTimerUseEvent = NULL;
+	m_pkSoulTimeUseEvent = NULL;
 #endif
+#if defined(__EXTENDED_BLEND_AFFECT__)
+	m_pkBlendUseEvent = NULL;
+#endif
+
+	m_pkAccessorySocketExpireEvent = NULL;
 
 	m_bSkipSave = false;
 	m_dwLastOwnerPID = 0;
@@ -110,10 +107,13 @@
 	event_cancel(&m_pkRealTimeExpireEvent);
 	event_cancel(&m_pkAccessorySocketExpireEvent);
 #if defined(__SOUL_BIND_SYSTEM__)
-	event_cancel(&m_pkSealDateExpireEvent);
+	event_cancel(&m_pkUnbindTimerExpireEvent);
 #endif
 #if defined(__SOUL_SYSTEM__)
-	event_cancel(&m_pkSoulTimerUseEvent);
+	event_cancel(&m_pkSoulTimeUseEvent);
+#endif
+#if defined(__EXTENDED_BLEND_AFFECT__)
+	event_cancel(&m_pkBlendUseEvent);
 #endif
 
 	CEntity::Destroy();
@@ -170,14 +170,12 @@
 	struct packet_item_ground_add pack;
 
 	pack.bHeader = HEADER_GC_ITEM_GROUND_ADD;
-	pack.lX = c_pos.x;
-	pack.lY = c_pos.y;
-	pack.lZ = c_pos.z;
-	pack.dwVID = m_dwVID;
+	pack.x = c_pos.x;
+	pack.y = c_pos.y;
+	pack.z = c_pos.z;
 	pack.dwVnum = GetVnum();
-#if defined(__SET_ITEM__)
-	pack.bSetValue = GetItemSetValue();
-#endif
+	pack.dwVID = m_dwVID;
+	// pack.count = m_dwCount;
 
 #if defined(__ITEM_DROP_RENEWAL__)
 	for (size_t i = 0; i < ITEM_SOCKET_MAX_NUM; ++i)
@@ -260,27 +258,23 @@
 
 	TPacketGCItemUpdate pack;
 
-	pack.bHeader = HEADER_GC_ITEM_UPDATE;
+	pack.header = HEADER_GC_ITEM_UPDATE;
 	pack.Cell = TItemPos(GetWindow(), m_wCell);
-	pack.dwCount = m_dwCount;
+	pack.count = m_dwCount;
 #if defined(__SOUL_BIND_SYSTEM__)
-	pack.lSealDate = m_lSealDate;
+	pack.soulbind = m_lSoulbind;
 #endif
-	for (int i = 0; i < ITEM_SOCKET_MAX_NUM; ++i)
-		pack.alSockets[i] = m_alSockets[i];
-	thecore_memcpy(pack.aAttr, GetAttributes(), sizeof(pack.aAttr));
 #if defined(__CHANGE_LOOK_SYSTEM__)
-	pack.dwTransmutationVnum = GetTransmutationVnum();
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	thecore_memcpy(&pack.RefineElement, GetRefineElement(), sizeof(pack.RefineElement));
+	pack.transmutation = m_dwTransmutation;
 #endif
+
+	for (int i = 0; i < ITEM_SOCKET_MAX_NUM; ++i)
+		pack.alSockets[i] = m_alSockets[i];
+
 #if defined(__ITEM_APPLY_RANDOM__)
 	thecore_memcpy(pack.aApplyRandom, GetRandomApplies(), sizeof(pack.aApplyRandom));
 #endif
-#if defined(__SET_ITEM__)
-	pack.bSetValue = GetItemSetValue();
-#endif
+	thecore_memcpy(pack.aAttr, GetAttributes(), sizeof(pack.aAttr));
 
 	sys_log(2, "UpdatePacket %s -> %s", GetName(), m_pOwner->GetName());
 	m_pOwner->GetDesc()->Packet(&pack, sizeof(pack));
@@ -288,10 +282,14 @@
 
 DWORD CItem::GetCount()
 {
-	if (GetType() == ITEM_ELK)
-		return MIN(m_dwCount, LONG_MAX);
+	if (GetType() == ITEM_ELK) return MIN(m_dwCount, LONG_MAX);
+#if defined(__CHEQUE_SYSTEM__)
+	else if (GetType() == ITEM_CHEQUE) return MIN(m_dwCount, LONG_MAX);
+#endif
 	else
-		return MIN(m_dwCount, ITEM_MAX_COUNT);
+	{
+		return MIN(m_dwCount, gMaxItemCount);
+	}
 }
 
 bool CItem::SetCount(DWORD count)
@@ -300,9 +298,15 @@
 	{
 		m_dwCount = MIN(count, LONG_MAX);
 	}
+#if defined(__CHEQUE_SYSTEM__)
+	else if (GetType() == ITEM_CHEQUE)
+	{
+		m_dwCount = MIN(count, LONG_MAX);
+	}
+#endif
 	else
 	{
-		m_dwCount = MIN(count, ITEM_MAX_COUNT);
+		m_dwCount = MIN(count, gMaxItemCount);
 	}
 
 	if (count == 0 && m_pOwner)
@@ -310,30 +314,21 @@
 		if (GetSubType() == USE_ABILITY_UP || GetSubType() == USE_POTION)
 		{
 			LPCHARACTER pOwner = GetOwner();
-			BYTE bWindow = GetWindow();
 			WORD wCell = GetCell();
 
 			RemoveFromCharacter();
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
 			if (!IsDragonSoul())
-#endif
 			{
 				LPITEM pItem = pOwner->FindSpecifyItem(GetVnum());
 
 				if (NULL != pItem)
 				{
-					if (bWindow == INVENTORY)
-						pOwner->ChainQuickslotItem(pItem, SLOT_TYPE_INVENTORY, wCell);
-					else if (bWindow == BELT_INVENTORY)
-						pOwner->SyncQuickslot(SLOT_TYPE_BELT_INVENTORY, wCell, WORD_MAX);
+					pOwner->ChainQuickslotItem(pItem, QUICKSLOT_TYPE_ITEM, wCell);
 				}
 				else
 				{
-					if (bWindow == INVENTORY)
-						pOwner->SyncQuickslot(SLOT_TYPE_INVENTORY, wCell, WORD_MAX);
-					else if (bWindow == BELT_INVENTORY)
-						pOwner->SyncQuickslot(SLOT_TYPE_BELT_INVENTORY, wCell, WORD_MAX);
+					pOwner->SyncQuickslot(QUICKSLOT_TYPE_ITEM, wCell, WORD_MAX);
 				}
 			}
 
@@ -341,12 +336,10 @@
 		}
 		else
 		{
-#if defined(__DRAGON_SOUL_SYSTEM__)
 			if (!IsDragonSoul())
-				m_pOwner->SyncQuickslot(SLOT_TYPE_INVENTORY, m_wCell, WORD_MAX);
-#else
-			m_pOwner->SyncQuickslot(SLOT_TYPE_INVENTORY, m_wCell, WORD_MAX);
-#endif
+			{
+				m_pOwner->SyncQuickslot(QUICKSLOT_TYPE_ITEM, m_wCell, WORD_MAX);
+			}
 			M2_DESTROY_ITEM(RemoveFromCharacter());
 		}
 
@@ -360,62 +353,14 @@
 }
 
 #if defined(__SOUL_BIND_SYSTEM__)
-bool CItem::CanSealItem() const
+void CItem::SetSoulBind(long sp)
 {
-	switch (GetType())
-	{
-		case ITEM_WEAPON:
-		{
-			switch (GetSubType())
-			{
-				case WEAPON_ARROW:
-				case WEAPON_MOUNT_SPEAR:
-#if defined(__QUIVER_SYSTEM__)
-				case WEAPON_QUIVER:
-#endif
-					//case WEAPON_BOUQUET:
-					return false;
-				default:
-					return true;
-			}
-		}
-
-		case ITEM_COSTUME:
-		{
-			switch (GetSubType())
-			{
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-				case COSTUME_MOUNT:
-#endif
-					return false;
-				default:
-					return true;
-			}
-		}
-
-		case ITEM_ARMOR:
-		case ITEM_BELT:
-			return true;
-
-#if defined(__DRAGON_SOUL_SYSTEM__) && defined(__DRAGON_SOUL_SEAL__)
-		case ITEM_DS:
-		{
-			const BYTE bGradeIdx = (GetVnum() / 1000) % 10;
-			if (bGradeIdx >= DRAGON_SOUL_GRADE_ANCIENT)
-				return true;
-
-			return false;
-		}
-#endif
-
-		default:
-			return false;
-	}
-
-	return false;
+	m_lSoulbind = sp;
+	UpdatePacket();
+	Save();
 }
 
-EVENTFUNC(SealDateExpireEvent)
+EVENTFUNC(unbind_timer_expire_event)
 {
 	const item_vid_event_info* info = reinterpret_cast<const item_vid_event_info*>(event->info);
 	if (!info)
@@ -425,42 +370,35 @@
 	if (!item)
 		return 0;
 
-	const time_t cur = get_global_time();
-	if (cur > item->GetSealDate())
+	const time_t current = get_global_time();
+	if (current > item->GetSealedTime())
 	{
-		item->SealItem(E_SEAL_DATE_DEFAULT_TIMESTAMP);
-		item->StopSealDateExpireTimerEvent();
+		item->SetSoulBind(0);
 		return 0;
 	}
 
 	return PASSES_PER_SEC(1);
 }
 
-void CItem::SealItem(long lSealDate)
+void CItem::StartUnbindTimerExpireEvent()
 {
-	m_lSealDate = lSealDate;
-	UpdatePacket();
-	Save();
-}
-
-void CItem::StartSealDateExpireTimerEvent()
-{
-	if (m_pkSealDateExpireEvent)
+	if (m_pkUnbindTimerExpireEvent)
 		return;
 
 	item_vid_event_info* info = AllocEventInfo<item_vid_event_info>();
 	info->item_vid = GetVID();
 
-	m_pkSealDateExpireEvent = event_create(SealDateExpireEvent, info, PASSES_PER_SEC(1));
-	sys_log(0, "SEAL_DATE_TIME_EXPIRE: StartSealDateExpireTimerEvent");
+	m_pkUnbindTimerExpireEvent = event_create(unbind_timer_expire_event, info, PASSES_PER_SEC(1));
+	sys_log(0, "UNBIND_TIME_EXPIRE: StartUnbindTimerExpireEvent");
 }
+#endif
 
-void CItem::StopSealDateExpireTimerEvent()
+#if defined(__CHANGE_LOOK_SYSTEM__)
+void CItem::SetTransmutation(DWORD dwVnum, bool bLog)
 {
-	if (m_pkSealDateExpireEvent)
-		event_cancel(&m_pkSealDateExpireEvent);
-
-	sys_log(0, "SEAL_DATE_TIME_EXPIRE: StopSealDateExpireTimerEvent");
+	m_dwTransmutation = dwVnum;
+	UpdatePacket();
+	Save();
 }
 #endif
 
@@ -469,15 +407,10 @@
 	if (!m_pOwner)
 	{
 		sys_err("Item::RemoveFromCharacter owner null");
-		return this;
+		return (this);
 	}
 
 	LPCHARACTER pOwner = m_pOwner;
-	if (!pOwner)
-	{
-		sys_err("Item::RemoveFromCharacter owner null");
-		return this;
-	}
 
 	if (m_bEquipped) // Ǿ°?
 	{
@@ -486,17 +419,12 @@
 
 		SetWindow(RESERVED_WINDOW);
 		Save();
-		return this;
+		return (this);
 	}
 	else
 	{
-		if (GetWindow() != SAFEBOX && GetWindow() != MALL
-#if defined(__ATTR_6TH_7TH__)
-			&& GetWindow() != NPC_STORAGE
-#endif
-			)
+		if (GetWindow() != SAFEBOX && GetWindow() != MALL)
 		{
-#if defined(__DRAGON_SOUL_SYSTEM__)
 			if (IsDragonSoul())
 			{
 				if (m_wCell >= DRAGON_SOUL_INVENTORY_MAX_NUM)
@@ -504,122 +432,104 @@
 				else
 					pOwner->SetItem(TItemPos(m_bWindow, m_wCell), NULL);
 			}
-			else if (GetWindow() == EQUIPMENT)
-#else
-			if (GetWindow() == EQUIPMENT)
-#endif
-			{
-				if (m_wCell >= EQUIPMENT_MAX_NUM)
-					sys_err("CItem::RemoveFromCharacter: pos >= EQUIPMENT_MAX_NUM");
-				else
-					pOwner->SetItem(TItemPos(m_bWindow, m_wCell), nullptr);
-			}
-			else if (GetWindow() == BELT_INVENTORY)
-			{
-				if (m_wCell >= BELT_INVENTORY_MAX_NUM)
-					sys_err("CItem::RemoveFromCharacter: pos >= BELT_INVENTORY_MAX_NUM");
-				else
-					pOwner->SetItem(TItemPos(m_bWindow, m_wCell), nullptr);
-			}
 			else
 			{
-				const TItemPos cell(INVENTORY, m_wCell);
+				TItemPos cell(INVENTORY, m_wCell);
 
-				if (cell.IsInventoryPosition() == false && cell.IsBeltInventoryPosition() == false) // ƴϸ ǰ?
+				if (false == cell.IsDefaultInventoryPosition() && false == cell.IsBeltInventoryPosition()
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+					&& false == cell.IsSkillBookInventoryPosition() && false == cell.IsUpgradeItemsInventoryPosition() && false == cell.IsStoneInventoryPosition() && false == cell.IsGiftBoxInventoryPosition()
+#endif
+					) // ƴϸ ǰ?
 				{
 					sys_err("CItem::RemoveFromCharacter: Invalid Item Position");
 				}
 				else
 				{
-					pOwner->SetItem(cell, nullptr);
+					pOwner->SetItem(cell, NULL);
 				}
 			}
 		}
 
-#if defined(__ATTR_6TH_7TH__)
-		else if (GetWindow() == NPC_STORAGE)
-			pOwner->SetItem(TItemPos(NPC_STORAGE, 0), nullptr);
-#endif
-
-		m_pOwner = nullptr;
+		m_pOwner = NULL;
 		m_wCell = 0;
 
 		SetWindow(RESERVED_WINDOW);
 		Save();
-		return this;
+		return (this);
 	}
 }
 
-bool CItem::AddToCharacter(LPCHARACTER ch, const TItemPos& Cell
 #if defined(__WJ_PICKUP_ITEM_EFFECT__)
-	, bool isHighLight
+bool CItem::AddToCharacter(LPCHARACTER ch, const TItemPos& Cell, bool isHighLight)
+#else
+bool CItem::AddToCharacter(LPCHARACTER ch, TItemPos Cell)
 #endif
-)
 {
 	assert(GetSectree() == NULL);
 	assert(m_pOwner == NULL);
 
-	BYTE bWindowType = Cell.window_type;
-	WORD wCell = Cell.cell;
+	WORD pos = Cell.cell;
+	BYTE window_type = Cell.window_type;
 
-	switch (bWindowType)
+	if (INVENTORY == window_type)
 	{
-		case INVENTORY:
+		if (m_wCell >= INVENTORY_MAX_NUM && BELT_INVENTORY_SLOT_START > m_wCell)
 		{
-#if defined(__EXTEND_INVEN_SYSTEM__)
-			if (m_wCell >= ch->GetExtendInvenMax())
-#else
-			if (m_wCell >= INVENTORY_MAX_NUM)
-#endif
-			{
-				sys_err("CItem::AddToCharacter: cell overflow: %s to %s cell %d", m_pProto->szName, ch->GetName(), m_wCell);
-				return false;
-			}
+			sys_err("CItem::AddToCharacter: cell overflow: %s to %s cell %d", m_pProto->szName, ch->GetName(), m_wCell);
+			return false;
 		}
-		break;
+	}
+	else if (DRAGON_SOUL_INVENTORY == window_type)
+	{
+		if (m_wCell >= DRAGON_SOUL_INVENTORY_MAX_NUM)
+		{
+			sys_err("CItem::AddToCharacter: cell overflow: %s to %s cell %d", m_pProto->szName, ch->GetName(), m_wCell);
+			return false;
+		}
+	}
+
+	if (ch->GetDesc())
+		m_dwLastOwnerPID = ch->GetPlayerID();
 
-		case EQUIPMENT:
+#if defined(__ACCE_COSTUME_SYSTEM__)
+	if ((GetType() == ITEM_COSTUME) && (GetSubType() == COSTUME_ACCE) && (GetSocket(ACCE_ABSORPTION_SOCKET) == 0))
+	{
+		long lVal = GetValue(ACCE_GRADE_VALUE_FIELD);
+		switch (lVal)
 		{
-			if (m_wCell >= EQUIPMENT_MAX_NUM)
-			{
-				sys_err("CItem::AddToCharacter: cell overflow: %s to %s cell %d", m_pProto->szName, ch->GetName(), m_wCell);
-				return false;
-			}
+		case 2:
+		{
+			lVal = ACCE_GRADE_2_ABS;
 		}
 		break;
-
-#if defined(__DRAGON_SOUL_SYSTEM__)
-		case DRAGON_SOUL_INVENTORY:
+		case 3:
 		{
-			if (m_wCell >= DRAGON_SOUL_INVENTORY_MAX_NUM)
-			{
-				sys_err("CItem::AddToCharacter: cell overflow: %s to %s cell %d", m_pProto->szName, ch->GetName(), m_wCell);
-				return false;
-			}
+			lVal = ACCE_GRADE_3_ABS;
 		}
 		break;
-#endif
-
-		case BELT_INVENTORY:
+		case 4:
 		{
-			if (m_wCell >= BELT_INVENTORY_SLOT_COUNT)
-			{
-				sys_err("CItem::AddToCharacter: cell overflow: %s to %s cell %d", m_pProto->szName, ch->GetName(), m_wCell);
-				return false;
-			}
+			lVal = number(ACCE_GRADE_4_ABS_MIN, ACCE_GRADE_4_ABS_MAX_COMB);
 		}
 		break;
-	}
+		default:
+		{
+			lVal = ACCE_GRADE_1_ABS;
+		}
+		break;
+		}
 
-	if (ch->GetDesc())
-		m_dwLastOwnerPID = ch->GetPlayerID();
+		SetSocket(ACCE_ABSORPTION_SOCKET, lVal);
+	}
+#endif
 
 	event_cancel(&m_pkDestroyEvent);
 
 #if defined(__WJ_PICKUP_ITEM_EFFECT__)
-	ch->SetItem(TItemPos(bWindowType, wCell), this, isHighLight);
+	ch->SetItem(TItemPos(window_type, pos), this, isHighLight);
 #else
-	ch->SetItem(TItemPos(bWindowType, wCell), this);
+	ch->SetItem(TItemPos(window_type, pos), this);
 #endif
 	m_pOwner = ch;
 
@@ -699,30 +609,30 @@
 	// Anti flag check
 	switch (ch->GetJob())
 	{
-		case JOB_WARRIOR:
-			if (GetAntiFlag() & ITEM_ANTIFLAG_WARRIOR)
-				return false;
-			break;
+	case JOB_WARRIOR:
+		if (GetAntiFlag() & ITEM_ANTIFLAG_WARRIOR)
+			return false;
+		break;
 
-		case JOB_ASSASSIN:
-			if (GetAntiFlag() & ITEM_ANTIFLAG_ASSASSIN)
-				return false;
-			break;
+	case JOB_ASSASSIN:
+		if (GetAntiFlag() & ITEM_ANTIFLAG_ASSASSIN)
+			return false;
+		break;
 
-		case JOB_SHAMAN:
-			if (GetAntiFlag() & ITEM_ANTIFLAG_SHAMAN)
-				return false;
-			break;
+	case JOB_SHAMAN:
+		if (GetAntiFlag() & ITEM_ANTIFLAG_SHAMAN)
+			return false;
+		break;
 
-		case JOB_SURA:
-			if (GetAntiFlag() & ITEM_ANTIFLAG_SURA)
-				return false;
-			break;
+	case JOB_SURA:
+		if (GetAntiFlag() & ITEM_ANTIFLAG_SURA)
+			return false;
+		break;
 
-		case JOB_WOLFMAN:
-			if (GetAntiFlag() & ITEM_ANTIFLAG_WOLFMAN)
-				return false;
-			break;
+	case JOB_WOLFMAN:
+		if (GetAntiFlag() & ITEM_ANTIFLAG_WOLFMAN)
+			return false;
+		break;
 
 	}
 
@@ -733,12 +643,7 @@
 {
 	// ڽ (ITEM_COSTUME) WearFlag  . (sub type ġ .   wear flag  ʿ䰡 ֳ..)
 	// ȥ(ITEM_DS, ITEM_SPECIAL_DS) SUB_TYPE . ű , Ʈ ITEM_TYPE  -_-
-	if ((0 == GetWearFlag() || ITEM_TOTEM == GetType()) && ITEM_COSTUME != GetType()
-#if defined(__DRAGON_SOUL_SYSTEM__)
-		&& ITEM_DS != GetType() && ITEM_SPECIAL_DS != GetType()
-#endif
-		&& ITEM_RING != GetType() && ITEM_BELT != GetType()
-		)
+	if ((0 == GetWearFlag() || ITEM_TOTEM == GetType()) && ITEM_COSTUME != GetType() && ITEM_DS != GetType() && ITEM_SPECIAL_DS != GetType() && ITEM_RING != GetType() && ITEM_BELT != GetType())
 		return -1;
 
 	// ȥ  WEAR ó  (WEAR ִ 32 ѵ ȥ ߰ϸ 32 Ѵ´.)
@@ -746,7 +651,6 @@
 	// ȥ  .
 	// return  , INVENTORY_MAX_NUM  ,
 	//  WearCell INVENTORY_MAX_NUM  return ϱ .
-#if defined(__DRAGON_SOUL_SYSTEM__)
 	if (GetType() == ITEM_DS || GetType() == ITEM_SPECIAL_DS)
 	{
 		if (iCandidateCell < 0)
@@ -763,35 +667,39 @@
 		}
 		return -1;
 	}
-#endif
 
 	if (GetType() == ITEM_COSTUME)
 	{
-		switch (GetSubType())
-		{
-			case COSTUME_BODY:
-				return WEAR_COSTUME_BODY;
-			case COSTUME_HAIR:
-				return WEAR_COSTUME_HAIR;
+		if (GetSubType() == COSTUME_BODY)
+			return WEAR_COSTUME_BODY;
+
+		if (GetSubType() == COSTUME_HAIR)
+			return WEAR_COSTUME_HAIR;
+
 #if defined(__MOUNT_COSTUME_SYSTEM__)
-			case COSTUME_MOUNT:
-				return WEAR_COSTUME_MOUNT;
+		if (GetSubType() == COSTUME_MOUNT)
+			return WEAR_COSTUME_MOUNT;
 #endif
+
 #if defined(__ACCE_COSTUME_SYSTEM__)
-			case COSTUME_ACCE:
-				return WEAR_COSTUME_ACCE;
+		if (GetSubType() == COSTUME_ACCE)
+			return WEAR_COSTUME_ACCE;
 #endif
+
 #if defined(__WEAPON_COSTUME_SYSTEM__)
-			case COSTUME_WEAPON:
-				return WEAR_COSTUME_WEAPON;
+		if (GetSubType() == COSTUME_WEAPON)
+			return WEAR_COSTUME_WEAPON;
 #endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-			case COSTUME_AURA:
-				return WEAR_COSTUME_AURA;
-#endif
-		}
 	}
-
+	else if (GetType() == ITEM_RING)
+	{
+		if (ch->GetWear(WEAR_RING1))
+			return WEAR_RING2;
+		else
+			return WEAR_RING1;
+	}
+	else if (GetType() == ITEM_BELT)
+		return WEAR_BELT;
 	else if (GetWearFlag() & WEARABLE_BODY)
 		return WEAR_BODY;
 	else if (GetWearFlag() & WEARABLE_HEAD)
@@ -802,10 +710,14 @@
 		return WEAR_WRIST;
 	else if (GetWearFlag() & WEARABLE_WEAPON)
 		return WEAR_WEAPON;
+	else if (GetWearFlag() & WEARABLE_SHIELD)
+		return WEAR_SHIELD;
 	else if (GetWearFlag() & WEARABLE_NECK)
 		return WEAR_NECK;
 	else if (GetWearFlag() & WEARABLE_EAR)
 		return WEAR_EAR;
+	else if (GetWearFlag() & WEARABLE_ARROW)
+		return WEAR_ARROW;
 	else if (GetWearFlag() & WEARABLE_UNIQUE)
 	{
 		if (ch->GetWear(WEAR_UNIQUE1))
@@ -813,36 +725,64 @@
 		else
 			return WEAR_UNIQUE1;
 	}
-	else if (GetWearFlag() & WEARABLE_SHIELD)
-		return WEAR_SHIELD;
-	else if (GetWearFlag() & WEARABLE_ARROW)
-		return WEAR_ARROW;
-	else if (GetType() == ITEM_BELT)
-		return WEAR_BELT;
 #if defined(__PENDANT_SYSTEM__)
-	else if (GetWearFlag() & WEARABLE_PENDANT)
+	else if (GetSubType() == ARMOR_PENDANT || GetWearFlag() & WEARABLE_PENDANT)
 		return WEAR_PENDANT;
 #endif
 #if defined(__GLOVE_SYSTEM__)
-	else if (GetWearFlag() & WEARABLE_GLOVE)
+	else if (GetSubType() == ARMOR_GLOVE || GetWearFlag() & WEARABLE_GLOVE)
 		return WEAR_GLOVE;
 #endif
 
+	//  Ʈ   ° ѹ   E .
+	else if (GetWearFlag() & WEARABLE_ABILITY)
+	{
+		if (!ch->GetWear(WEAR_ABILITY1))
+		{
+			return WEAR_ABILITY1;
+		}
+		else if (!ch->GetWear(WEAR_ABILITY2))
+		{
+			return WEAR_ABILITY2;
+		}
+		else if (!ch->GetWear(WEAR_ABILITY3))
+		{
+			return WEAR_ABILITY3;
+		}
+		else if (!ch->GetWear(WEAR_ABILITY4))
+		{
+			return WEAR_ABILITY4;
+		}
+		else if (!ch->GetWear(WEAR_ABILITY5))
+		{
+			return WEAR_ABILITY5;
+		}
+		else if (!ch->GetWear(WEAR_ABILITY6))
+		{
+			return WEAR_ABILITY6;
+		}
+		else if (!ch->GetWear(WEAR_ABILITY7))
+		{
+			return WEAR_ABILITY7;
+		}
+		else if (!ch->GetWear(WEAR_ABILITY8))
+		{
+			return WEAR_ABILITY8;
+		}
+		else
+		{
+			return -1;
+		}
+	}
 	return -1;
 }
 
-//#define __CHECK_MODIFY_POINTS_PERF__
-
 void CItem::ModifyPoints(bool bAdd)
 {
-#if defined(__CHECK_MODIFY_POINTS_PERF__)
-	auto _modify_s1 = std::chrono::steady_clock::now();
-#endif
-
-	BYTE bAccessoryGrade = 0;
+	int accessoryGrade;
 
 	//  ʸ  Ų.
-	if (!IsAccessoryForSocket())
+	if (false == IsAccessoryForSocket())
 	{
 #if defined(__QUIVER_SYSTEM__)
 		if ((m_pProto->bType == ITEM_WEAPON && m_pProto->bSubType != WEAPON_QUIVER) || m_pProto->bType == ITEM_ARMOR)
@@ -850,146 +790,197 @@
 		if (m_pProto->bType == ITEM_WEAPON || m_pProto->bType == ITEM_ARMOR)
 #endif
 		{
-#if defined(__CHECK_MODIFY_POINTS_PERF__)
-			auto _accessory_s1 = std::chrono::steady_clock::now();
-#endif
-			//  Ӽȭ Ǵ   ʴ´ (ARMOR_WRIST ARMOR_NECK ARMOR_EAR ARMOR_GLOVE)
-			for (BYTE bSocketIndex = 0; bSocketIndex < METIN_SOCKET_MAX_NUM; ++bSocketIndex)
+			for (int i = 0; i < ITEM_SOCKET_MAX_NUM; ++i)
 			{
-#if defined(__GLOVE_SYSTEM__)
-				if (m_pProto->bType == ITEM_ARMOR && m_pProto->bSubType == ARMOR_GLOVE)
-				{
-					const DWORD dwData = GetSocket(bSocketIndex);
-					if (dwData < 1000000)
-						continue;
-
-					const WORD wType = (dwData / 10000) % 1000;
-					if (wType == APPLY_NONE)
-						continue;
+				DWORD dwVnum;
 
-					const long lValue = dwData % 100;
-					m_pOwner->ApplyPoint(wType, (bAdd) ? lValue : -lValue);
-				}
-				else
-#endif
-				{
-					const DWORD dwVnum = GetSocket(bSocketIndex);
-					if (dwVnum <= 2)
-						continue;
+				if ((dwVnum = GetSocket(i)) <= 2)
+					continue;
 
-					const TItemTable* pItemTable = ITEM_MANAGER::instance().GetTable(dwVnum);
-					if (pItemTable == nullptr)
-					{
-						sys_err("cannot find table by vnum %lu", dwVnum);
-						continue;
-					}
+				TItemTable* p = ITEM_MANAGER::instance().GetTable(dwVnum);
+				if (!p)
+				{
+					sys_err("cannot find table by vnum %lu", dwVnum);
+					continue;
+				}
 
-					if (ITEM_METIN == pItemTable->bType
-#if defined(__GLOVE_SYSTEM__)
-						&& pItemTable->bSubType != METIN_SUNGMA
-#endif
-						)
+				if (ITEM_METIN == p->bType)
+				{
+					// m_pOwner->ApplyPoint(p->alValues[0], bAdd ? p->alValues[1] : -p->alValues[1]);
+					for (int i = 0; i < ITEM_APPLY_MAX_NUM; ++i)
 					{
-						for (BYTE bApplyIndex = 0; bApplyIndex < ITEM_APPLY_MAX_NUM; ++bApplyIndex)
-						{
-							if (pItemTable->aApplies[bApplyIndex].wType == APPLY_NONE)
-								continue;
+						if (p->aApplies[i].bType == APPLY_NONE)
+							continue;
 
-							if (pItemTable->aApplies[bApplyIndex].wType == APPLY_SKILL)
-								m_pOwner->ApplyPoint(pItemTable->aApplies[bApplyIndex].wType,
-									(bAdd) ? pItemTable->aApplies[bApplyIndex].lValue : pItemTable->aApplies[bApplyIndex].lValue ^ 0x00800000);
-							else
-								m_pOwner->ApplyPoint(pItemTable->aApplies[bApplyIndex].wType,
-									(bAdd) ? pItemTable->aApplies[bApplyIndex].lValue : -pItemTable->aApplies[bApplyIndex].lValue);
-						}
+						if (p->aApplies[i].bType == APPLY_SKILL)
+							m_pOwner->ApplyPoint(p->aApplies[i].bType, bAdd ? p->aApplies[i].lValue : p->aApplies[i].lValue ^ 0x00800000);
+						else
+							m_pOwner->ApplyPoint(p->aApplies[i].bType, bAdd ? p->aApplies[i].lValue : -p->aApplies[i].lValue);
 					}
 				}
 			}
-#if defined(__CHECK_MODIFY_POINTS_PERF__)
-			auto _accessory_e1 = std::chrono::steady_clock::now();
-			auto _accessory_d1 = std::chrono::duration_cast<std::chrono::nanoseconds>(_accessory_e1 - _accessory_s1).count();
-			m_pOwner->ChatPacket(CHAT_TYPE_INFO, "!IsAccessoryForSocket() took %lld nanoseconds.", static_cast<long long>(_accessory_d1));
-#endif
 		}
 
-		bAccessoryGrade = 0;
+		accessoryGrade = 0;
 	}
 	else
 	{
-		bAccessoryGrade = static_cast<BYTE>(MIN(GetAccessorySocketGrade(), ITEM_ACCESSORY_SOCKET_MAX_NUM));
+		accessoryGrade = MIN(GetAccessorySocketGrade(), ITEM_ACCESSORY_SOCKET_MAX_NUM);
 	}
 
-#if defined(__CHECK_MODIFY_POINTS_PERF__)
-	auto _apply_s1 = std::chrono::steady_clock::now();
+#if defined(__ACCE_COSTUME_SYSTEM__)
+	if (IsCostumeAcce() && GetSocket(ACCE_ABSORBED_SOCKET))
+	{
+		TItemTable* pkItemAbsorbed = ITEM_MANAGER::instance().GetTable(GetSocket(ACCE_ABSORBED_SOCKET));
+		if (pkItemAbsorbed)
+		{
+			if ((pkItemAbsorbed->bType == ITEM_ARMOR) && (pkItemAbsorbed->bSubType == ARMOR_BODY))
+			{
+				long lDefGrade = pkItemAbsorbed->alValues[1] + long(pkItemAbsorbed->alValues[5] * 2);
+				double dValue = lDefGrade * GetSocket(ACCE_ABSORPTION_SOCKET);
+				dValue = (double)dValue / 100;
+				dValue = (double)dValue + .5;
+				lDefGrade = (long)dValue;
+				if ((pkItemAbsorbed->alValues[1] > 0 && (lDefGrade <= 0)) || (pkItemAbsorbed->alValues[5] > 0 && (lDefGrade < 1)))
+					lDefGrade += 1;
+				else if ((pkItemAbsorbed->alValues[1] > 0) || (pkItemAbsorbed->alValues[5] > 0))
+					lDefGrade += 1;
+
+				m_pOwner->ApplyPoint(APPLY_DEF_GRADE_BONUS, bAdd ? lDefGrade : -lDefGrade);
+
+				long lDefMagicBonus = pkItemAbsorbed->alValues[0];
+				dValue = lDefMagicBonus * GetSocket(ACCE_ABSORPTION_SOCKET);
+				dValue = (double)dValue / 100;
+				dValue = (double)dValue + .5;
+				lDefMagicBonus = (long)dValue;
+				if ((pkItemAbsorbed->alValues[0] > 0) && (lDefMagicBonus < 1))
+					lDefMagicBonus += 1;
+				else if (pkItemAbsorbed->alValues[0] > 0)
+					lDefMagicBonus += 1;
+
+				m_pOwner->ApplyPoint(APPLY_MAGIC_DEF_GRADE, bAdd ? lDefMagicBonus : -lDefMagicBonus);
+			}
+			else if (pkItemAbsorbed->bType == ITEM_WEAPON)
+			{
+				long lAttGrade = pkItemAbsorbed->alValues[4] + pkItemAbsorbed->alValues[5];
+				if (pkItemAbsorbed->alValues[3] > pkItemAbsorbed->alValues[4])
+					lAttGrade = pkItemAbsorbed->alValues[3] + pkItemAbsorbed->alValues[5];
+
+				double dValue = lAttGrade * GetSocket(ACCE_ABSORPTION_SOCKET);
+				dValue = (double)dValue / 100;
+				dValue = (double)dValue + .5;
+				lAttGrade = (long)dValue;
+				if (((pkItemAbsorbed->alValues[3] > 0) && (lAttGrade < 1)) || ((pkItemAbsorbed->alValues[4] > 0) && (lAttGrade < 1)))
+					lAttGrade += 1;
+				else if ((pkItemAbsorbed->alValues[3] > 0) || (pkItemAbsorbed->alValues[4] > 0))
+					lAttGrade += 1;
+
+				m_pOwner->ApplyPoint(APPLY_ATT_GRADE_BONUS, bAdd ? lAttGrade : -lAttGrade);
+
+				long lAttMagicGrade = pkItemAbsorbed->alValues[2] + pkItemAbsorbed->alValues[5];
+				if (pkItemAbsorbed->alValues[1] > pkItemAbsorbed->alValues[2])
+					lAttMagicGrade = pkItemAbsorbed->alValues[1] + pkItemAbsorbed->alValues[5];
+
+				dValue = lAttMagicGrade * GetSocket(ACCE_ABSORPTION_SOCKET);
+				dValue = (double)dValue / 100;
+				dValue = (double)dValue + .5;
+				lAttMagicGrade = (long)dValue;
+				if (((pkItemAbsorbed->alValues[1] > 0) && (lAttMagicGrade < 1)) || ((pkItemAbsorbed->alValues[2] > 0) && (lAttMagicGrade < 1)))
+					lAttMagicGrade += 1;
+				else if ((pkItemAbsorbed->alValues[1] > 0) || (pkItemAbsorbed->alValues[2] > 0))
+					lAttMagicGrade += 1;
+
+				m_pOwner->ApplyPoint(APPLY_MAGIC_ATT_GRADE, bAdd ? lAttMagicGrade : -lAttMagicGrade);
+			}
+		}
+	}
 #endif
-	for (BYTE bApplyIndex = 0; bApplyIndex < ITEM_APPLY_MAX_NUM; ++bApplyIndex)
+
+	for (int i = 0; i < ITEM_APPLY_MAX_NUM; ++i)
 	{
-		if (m_pProto->aApplies[bApplyIndex].wType == APPLY_NONE)
+#if defined(__ACCE_COSTUME_SYSTEM__)
+		if (m_pProto->aApplies[i].bType == APPLY_NONE && !IsCostumeAcce())
+#else
+		if (m_pProto->aApplies[i].bType == APPLY_NONE)
+#endif
 			continue;
 
-		long lValue = m_pProto->aApplies[bApplyIndex].lValue;
-		if (m_pProto->aApplies[bApplyIndex].wType == APPLY_SKILL)
-		{
-			m_pOwner->ApplyPoint(m_pProto->aApplies[bApplyIndex].wType, bAdd ? lValue : lValue ^ 0x00800000);
-		}
-#if defined(__ITEM_APPLY_RANDOM__)
-		else if (m_pProto->aApplies[bApplyIndex].wType == APPLY_RANDOM && GetRandomApplyType(bApplyIndex))
-		{
-			const TPlayerItemAttribute& rItemApplyRandom = GetRandomApply(bApplyIndex);
-			lValue = rItemApplyRandom.lValue;
+		BYTE bType = m_pProto->aApplies[i].bType;
+		long lValue = m_pProto->aApplies[i].lValue;
 
-			if (rItemApplyRandom.wType == APPLY_SKILL)
-			{
-				m_pOwner->ApplyPoint(rItemApplyRandom.wType, bAdd ? lValue : lValue ^ 0x00800000);
-			}
-			else
+#if defined(__ACCE_COSTUME_SYSTEM__)
+		if (IsCostumeAcce())
+		{
+			TItemTable* pkItemAbsorbed = ITEM_MANAGER::instance().GetTable(GetSocket(ACCE_ABSORBED_SOCKET));
+			if (pkItemAbsorbed)
 			{
-				if (0 != bAccessoryGrade)
-					lValue += MAX(bAccessoryGrade, lValue * aiAccessorySocketEffectivePct[bAccessoryGrade] / 100);
+				if (pkItemAbsorbed->aApplies[i].bType == APPLY_NONE)
+					continue;
+
+				bType = pkItemAbsorbed->aApplies[i].bType;
+				lValue = pkItemAbsorbed->aApplies[i].lValue;
+				if (lValue < 0)
+					continue;
+
+				double dValue = lValue * GetSocket(ACCE_ABSORPTION_SOCKET);
+				dValue = (double)dValue / 100;
+				dValue = (double)dValue + .5;
+				lValue = (long)dValue;
+
+				if ((pkItemAbsorbed->aApplies[i].lValue > 0) && (lValue <= 0))
+					lValue += 1;
 
-				m_pOwner->ApplyPoint(rItemApplyRandom.wType, bAdd ? lValue : -lValue);
+				if (m_pProto->aApplies[i].bType == APPLY_SKILL)
+				{
+					m_pOwner->ApplyPoint(bType, bAdd ? lValue : lValue ^ 0x00800000);
+				}
+				else
+				{
+					if (0 != accessoryGrade)
+						lValue += MAX(accessoryGrade, lValue * aiAccessorySocketEffectivePct[accessoryGrade] / 100);
+
+					m_pOwner->ApplyPoint(bType, bAdd ? lValue : -lValue);
+				}
 			}
+			else
+				continue;
 		}
 #endif
+
+		if (m_pProto->aApplies[i].bType == APPLY_SKILL)
+		{
+			m_pOwner->ApplyPoint(m_pProto->aApplies[i].bType, bAdd ? lValue : lValue ^ 0x00800000);
+		}
 		else
 		{
-			if (0 != bAccessoryGrade)
-				lValue += MAX(bAccessoryGrade, lValue * aiAccessorySocketEffectivePct[bAccessoryGrade] / 100);
+			if (0 != accessoryGrade)
+				lValue += MAX(accessoryGrade, lValue * aiAccessorySocketEffectivePct[accessoryGrade] / 100);
 
-			m_pOwner->ApplyPoint(m_pProto->aApplies[bApplyIndex].wType, bAdd ? lValue : -lValue);
+			m_pOwner->ApplyPoint(m_pProto->aApplies[i].bType, bAdd ? lValue : -lValue);
 		}
 	}
 
-#if defined(__CHECK_MODIFY_POINTS_PERF__)
-	auto _apply_e1 = std::chrono::steady_clock::now();
-	auto _apply_d1 = std::chrono::duration_cast<std::chrono::nanoseconds>(_apply_e1 - _apply_s1).count();
-	m_pOwner->ChatPacket(CHAT_TYPE_INFO, "Item applies took %lld nanoseconds.", static_cast<long long>(_apply_d1));
-#endif
+#if defined(__ITEM_APPLY_RANDOM__)
+	for (int i = 0; i < ITEM_APPLY_MAX_NUM; ++i)
+	{
+		if (m_pProto->aApplies[i].bType == APPLY_RANDOM)
+		{
+			BYTE bType = GetRandomApply(i).bType;
+			short sValue = GetRandomApply(i).sValue;
 
-#if defined(__CHECK_MODIFY_POINTS_PERF__)
-	auto _acce_s1 = std::chrono::steady_clock::now();
-#endif
-#if defined(__ACCE_COSTUME_SYSTEM__)
-	if (m_pProto->bType == ITEM_COSTUME && m_pProto->bSubType == COSTUME_ACCE)
-		m_pOwner->ModifyAccePoints(this, bAdd);
-#endif
-#if defined(__CHECK_MODIFY_POINTS_PERF__)
-	auto _acce_e1 = std::chrono::steady_clock::now();
-	auto _acce_d1 = std::chrono::duration_cast<std::chrono::nanoseconds>(_acce_e1 - _acce_s1).count();
-	m_pOwner->ChatPacket(CHAT_TYPE_INFO, "ModifyAccePoints %lld nanoseconds.", static_cast<long long>(_acce_d1));
-#endif
-
-#if defined(__CHECK_MODIFY_POINTS_PERF__)
-	auto _aura_s1 = std::chrono::steady_clock::now();
-#endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-	if (m_pProto->bType == ITEM_COSTUME && m_pProto->bSubType == COSTUME_AURA)
-		m_pOwner->ModifyAuraPoints(this, bAdd);
-#endif
-#if defined(__CHECK_MODIFY_POINTS_PERF__)
-	auto _aura_e1 = std::chrono::steady_clock::now();
-	auto _aura_d1 = std::chrono::duration_cast<std::chrono::nanoseconds>(_aura_e1 - _aura_s1).count();
-	m_pOwner->ChatPacket(CHAT_TYPE_INFO, "ModifyAuraPoints %lld nanoseconds.", static_cast<long long>(_aura_d1));
+				if (bType == APPLY_SKILL)
+				{
+					m_pOwner->ApplyPoint(bType, bAdd ? sValue : sValue ^ 0x00800000);
+				}
+				else
+				{
+					if (0 != accessoryGrade)
+						sValue += MAX(accessoryGrade, sValue * aiAccessorySocketEffectivePct[accessoryGrade] / 100);
+
+					m_pOwner->ApplyPoint(bType, bAdd ? sValue : -sValue);
+				}
+		}
+	}
 #endif
 
 	// ʽ´ , ҷ , ູ ,   Ʈ 
@@ -1006,308 +997,281 @@
 	}
 	else
 	{
-#if defined(__CHECK_MODIFY_POINTS_PERF__)
-		auto _attr_s1 = std::chrono::steady_clock::now();
-#endif
-		for (BYTE bAttrIndex = 0; bAttrIndex < ITEM_ATTRIBUTE_MAX_NUM; ++bAttrIndex)
+		for (int i = 0; i < ITEM_ATTRIBUTE_MAX_NUM; ++i)
 		{
+			if (GetAttributeType(i))
+			{
+				const TPlayerItemAttribute& ia = GetAttribute(i);
 #if defined(__ACCE_COSTUME_SYSTEM__)
-			if (GetType() == ITEM_COSTUME && GetSubType() == COSTUME_ACCE)
-				break; // Modifying at @ ModifyAccePoints
-#endif
-
-#if defined(__AURA_COSTUME_SYSTEM__)
-			if (GetType() == ITEM_COSTUME && GetSubType() == COSTUME_AURA)
-				break; // Modifying at @ ModifyAuraPoints
-#endif
+				long sValue = ia.sValue;
 
-			if (GetAttributeType(bAttrIndex))
-			{
-				const TPlayerItemAttribute& rItemAttribute = GetAttribute(bAttrIndex);
-#if defined(__DRAGON_SOUL_SYSTEM__) && defined(__DS_SET__)
-				long lValue = rItemAttribute.lValue;
-				if (IsDragonSoul() && m_pOwner->FindAffect(AFFECT_DS_SET))
+				if (IsCostumeAcce())
 				{
-					if (bAttrIndex < DSManager::instance().GetApplyCount(GetVnum()))
-					{
-						lValue += DSManager::instance().GetBasicApplyValue(GetVnum(), rItemAttribute.wType, true);
-					}
-					else
-					{
-						lValue += DSManager::instance().GetAdditionalApplyValue(GetVnum(), rItemAttribute.wType, true);
-					}
+					double dValue = sValue * GetSocket(ACCE_ABSORPTION_SOCKET);
+					dValue = (double)dValue / 100;
+					dValue = (double)dValue + .5;
+					sValue = (long)dValue;
+					if ((ia.sValue > 0) && (sValue <= 0))
+						sValue += 1;
 				}
 
-				if (rItemAttribute.wType == APPLY_SKILL)
-					m_pOwner->ApplyPoint(rItemAttribute.wType, bAdd ? lValue : lValue ^ 0x00800000);
+				if (ia.bType == APPLY_SKILL)
+					m_pOwner->ApplyPoint(ia.bType, bAdd ? sValue : sValue ^ 0x00800000);
 				else
-					m_pOwner->ApplyPoint(rItemAttribute.wType, bAdd ? lValue : -lValue);
+					m_pOwner->ApplyPoint(ia.bType, bAdd ? sValue : -sValue);
 #else
-				if (rItemAttribute.wType == APPLY_SKILL)
-					m_pOwner->ApplyPoint(rItemAttribute.wType, bAdd ? rItemAttribute.lValue : rItemAttribute.lValue ^ 0x00800000);
+				if (ia.bType == APPLY_SKILL)
+					m_pOwner->ApplyPoint(ia.bType, bAdd ? ia.sValue : ia.sValue ^ 0x00800000);
 				else
-					m_pOwner->ApplyPoint(rItemAttribute.wType, bAdd ? rItemAttribute.lValue : -rItemAttribute.lValue);
+					m_pOwner->ApplyPoint(ia.bType, bAdd ? ia.sValue : -ia.sValue);
 #endif
 			}
 		}
-#if defined(__CHECK_MODIFY_POINTS_PERF__)
-		auto _attr_e1 = std::chrono::steady_clock::now();
-		auto _attr_d1 = std::chrono::duration_cast<std::chrono::nanoseconds>(_attr_e1 - _attr_s1).count();
-		m_pOwner->ChatPacket(CHAT_TYPE_INFO, "Item attributes took % lld nanoseconds.", static_cast<long long>(_attr_d1));
-#endif
 	}
 
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	if (m_pProto->bType == ITEM_WEAPON && GetRefineElementGrade() != 0)
-	{
-		const long lValue = static_cast<long>(GetRefineElementValue());
-		if (lValue > 0)
-			m_pOwner->ApplyPoint(GetRefineElementApplyType(), bAdd ? lValue : -lValue);
-
-		const long lBonusValue = static_cast<long>(GetRefineElementBonusValue());
-		if (lBonusValue > 0)
-			m_pOwner->ApplyPoint(APPLY_ATT_GRADE_BONUS, bAdd ? lBonusValue : -lBonusValue);
-	}
-#endif
-
 	switch (m_pProto->bType)
 	{
-		case ITEM_PICK:
-		case ITEM_ROD:
+	case ITEM_PICK:
+	case ITEM_ROD:
+	{
+		if (bAdd)
 		{
-			if (bAdd)
-			{
-				if (m_wCell == WEAR_WEAPON)
-					m_pOwner->SetPart(PART_WEAPON, GetVnum());
-			}
-			else
-			{
-				if (m_wCell == WEAR_WEAPON)
-					m_pOwner->SetPart(PART_WEAPON, m_pOwner->GetOriginalPart(PART_WEAPON));
-			}
+			if (m_wCell == INVENTORY_MAX_NUM + WEAR_WEAPON)
+				m_pOwner->SetPart(PART_WEAPON, GetVnum());
 		}
-		break;
-
-		case ITEM_WEAPON:
+		else
 		{
+			if (m_wCell == INVENTORY_MAX_NUM + WEAR_WEAPON)
+				m_pOwner->SetPart(PART_WEAPON, m_pOwner->GetOriginalPart(PART_WEAPON));
+		}
+	}
+	break;
+
+	case ITEM_WEAPON:
+	{
 #if defined(__WEAPON_COSTUME_SYSTEM__)
-			// ڽ body ԰ִٸ armor  Դ   ־  ָ  .
-			if (m_pOwner->GetWear(WEAR_COSTUME_WEAPON) != 0)
-			{
-#if defined(__HIDE_WEAPON_COSTUME_WITH_NO_MAIN_WEAPON__)
-				m_pOwner->SetPart(PART_WEAPON, m_pOwner->GetWear(WEAR_COSTUME_WEAPON)->GetVnum());
+		// ڽ body ԰ִٸ armor  Դ   ־  ָ  .
+		if (0 != m_pOwner->GetWear(WEAR_COSTUME_WEAPON))
+			return;
 #endif
-				return;
+
+		if (bAdd)
+		{
+			if (m_wCell == INVENTORY_MAX_NUM + WEAR_WEAPON)
+#if defined(__CHANGE_LOOK_SYSTEM__)
+			{
+				DWORD dwRes = GetTransmutation() != 0 ? GetTransmutation() : GetVnum();
+				m_pOwner->SetPart(PART_WEAPON, dwRes);
 			}
+#else
+				m_pOwner->SetPart(PART_WEAPON, GetVnum());
 #endif
+		}
+		else
+		{
+			if (m_wCell == INVENTORY_MAX_NUM + WEAR_WEAPON)
+				m_pOwner->SetPart(PART_WEAPON, m_pOwner->GetOriginalPart(PART_WEAPON));
+		}
+	}
+	break;
 
+	case ITEM_ARMOR:
+	{
+		// ڽ body ԰ִٸ armor  Դ   ־  ָ  .
+		if (0 != m_pOwner->GetWear(WEAR_COSTUME_BODY))
+			break;
+
+		if (GetSubType() == ARMOR_BODY || GetSubType() == ARMOR_HEAD || GetSubType() == ARMOR_FOOTS || GetSubType() == ARMOR_SHIELD)
+		{
 			if (bAdd)
 			{
+				if (GetProto()->bSubType == ARMOR_BODY)
 #if defined(__CHANGE_LOOK_SYSTEM__)
-				if (m_wCell == WEAR_WEAPON)
-					m_pOwner->SetPart(PART_WEAPON, (GetTransmutationVnum() != 0) ? GetTransmutationVnum() : GetVnum());
+				{
+					DWORD dwVnum = GetTransmutation() != 0 ? GetTransmutation() : GetVnum();
+
+					// NOTE: Allow the part to be shown if the transmutation item is not
+					// the same as the character's gender. In this case, only the
+					// original armor /costume model will be shown.
+					if (EChangeLookInfo::CHANGE_LOOK_CAN_EQUIP_MULTI_GENDER != FALSE)
+					{
+						if (GetTransmutation() != 0)
+						{
+							TItemTable* pItemTable = ITEM_MANAGER::instance().GetTable(dwVnum);
+							if (pItemTable)
+							{
+								bool bSexMatch = false;
+								if (IS_SET(pItemTable->GetAntiFlags(), ITEM_ANTIFLAG_MALE) && m_pOwner->IsFemale())
+									bSexMatch = true;
+								else if (IS_SET(pItemTable->GetAntiFlags(), ITEM_ANTIFLAG_FEMALE) && m_pOwner->IsMale())
+									bSexMatch = true;
+
+								if (!bSexMatch)
+									dwVnum = GetVnum();
+							}
+						}
+					}
+					m_pOwner->SetPart(PART_MAIN, dwVnum);
+				}
 #else
-				if (m_wCell == WEAR_WEAPON)
-					m_pOwner->SetPart(PART_WEAPON, GetVnum());
+					m_pOwner->SetPart(PART_MAIN, GetVnum());
 #endif
 			}
 			else
 			{
-				if (m_wCell == WEAR_WEAPON)
-					m_pOwner->SetPart(PART_WEAPON, m_pOwner->GetOriginalPart(PART_WEAPON));
+				if (GetProto()->bSubType == ARMOR_BODY)
+					m_pOwner->SetPart(PART_MAIN, m_pOwner->GetOriginalPart(PART_MAIN));
 			}
 		}
-		break;
+	}
+	break;
 
-		case ITEM_ARMOR:
+	// ڽ  Ծ  ĳ parts  .  Ÿϴ ߰..
+	case ITEM_COSTUME:
+	{
+		DWORD toSetValue = this->GetVnum();
+		EParts toSetPart = PART_MAX_NUM;
+
+		switch (GetSubType())
 		{
-#if defined(__COSTUME_SYSTEM__)
-			// ڽ body ԰ִٸ armor  Դ   ־  ָ  .
-			if (m_pOwner->GetWear(WEAR_COSTUME_BODY) != 0)
-				break;
-#endif
+			//  ڽ
+		case COSTUME_BODY:
+		{
+			toSetPart = PART_MAIN;
 
-			if (GetSubType() == ARMOR_BODY || GetSubType() == ARMOR_HEAD || GetSubType() == ARMOR_FOOTS || GetSubType() == ARMOR_SHIELD)
+			if (false == bAdd)
 			{
-				if (bAdd)
-				{
+				// ڽ      ԰ ־ٸ   look ,  ʾҴٸ default look
+				const CItem* pArmor = m_pOwner->GetWear(WEAR_BODY);
+				toSetValue = (NULL != pArmor) ? pArmor->GetVnum() : m_pOwner->GetOriginalPart(PART_MAIN);
 #if defined(__CHANGE_LOOK_SYSTEM__)
-					if (GetProto()->bSubType == ARMOR_BODY)
-						m_pOwner->SetPart(PART_MAIN, (GetTransmutationVnum() != 0) ? GetTransmutationVnum() : GetVnum());
-#else
-					if (GetProto()->bSubType == ARMOR_BODY)
-						m_pOwner->SetPart(PART_MAIN, GetVnum());
+				if (pArmor)
+					toSetValue = pArmor->GetTransmutation() != 0 ? pArmor->GetTransmutation() : pArmor->GetVnum();
 #endif
-				}
-				else
-				{
-					if (GetProto()->bSubType == ARMOR_BODY)
-						m_pOwner->SetPart(PART_MAIN, m_pOwner->GetOriginalPart(PART_MAIN));
-				}
 			}
+#if defined(__CHANGE_LOOK_SYSTEM__)
+			else
+				toSetValue = GetTransmutation() != 0 ? GetTransmutation() : GetVnum();
+#endif
 		}
 		break;
 
-#if defined(__COSTUME_SYSTEM__)
-		// ڽ  Ծ  ĳ parts  .  Ÿϴ ߰..
-		case ITEM_COSTUME:
+		//  ڽ
+		case COSTUME_HAIR:
 		{
-			DWORD dwToSetValue = GetVnum();
-			BYTE bSetPart = PART_MAX_NUM;
+			toSetPart = PART_HAIR;
 
-			switch (GetSubType())
-			{
-				//  ڽ
-				case COSTUME_BODY:
-				{
-					bSetPart = PART_MAIN;
-
-					if (!bAdd)
-					{
-						// ڽ      ԰ ־ٸ   look ,  ʾҴٸ default look
-						const CItem* pArmor = m_pOwner->GetWear(WEAR_BODY);
-#if defined(__CHANGE_LOOK_SYSTEM__)
-						if (pArmor)
-							dwToSetValue = (pArmor->GetTransmutationVnum() != 0) ? pArmor->GetTransmutationVnum() : pArmor->GetVnum();
-						else
-							dwToSetValue = m_pOwner->GetOriginalPart(PART_MAIN);
-#else
-						dwToSetValue = (pArmor != nullptr) ? pArmor->GetVnum() : m_pOwner->GetOriginalPart(PART_MAIN);
-#endif
-					}
-#if defined(__CHANGE_LOOK_SYSTEM__)
-					else
-						dwToSetValue = (GetTransmutationVnum() != 0) ? GetTransmutationVnum() : GetVnum();
-#endif
-				}
-				break;
-
-				//  ڽ
-				case COSTUME_HAIR:
-				{
-					bSetPart = PART_HAIR;
-
-					// ڽ  shape item proto value3 ϵ . Ư    (ARMOR_BODY) shape  value3 ־   value3 .
-					// [NOTE]   vnum   shape(value3)  ..  ý ׷ Ǿ...
+			// ڽ  shape item proto value3 ϵ . Ư    (ARMOR_BODY) shape  value3 ־   value3 .
+			// [NOTE]   vnum   shape(value3)  ..  ý ׷ Ǿ...
 #if defined(__CHANGE_LOOK_SYSTEM__)
-					const DWORD dwTransmutationVnum = GetTransmutationVnum();
-					if (dwTransmutationVnum != 0)
-					{
-						const TItemTable* pItemTable = ITEM_MANAGER::instance().GetTable(dwTransmutationVnum);
-						dwToSetValue = (pItemTable != nullptr) ? pItemTable->alValues[3] : GetValue(3);
-					}
-					else
-						dwToSetValue = (bAdd) ? GetValue(3) : 0;
+			DWORD dwTransmutation = GetTransmutation();
+			if (dwTransmutation != 0)
+			{
+				TItemTable* pItemTable = ITEM_MANAGER::instance().GetTable(dwTransmutation);
+				toSetValue = (pItemTable != NULL) ? pItemTable->alValues[3] : GetValue(3);
+			}
+			else
+				toSetValue = (true == bAdd) ? this->GetValue(3) : 0;
 #else
-					dwToSetValue = (bAdd) ? GetValue(3) : 0;
+			toSetValue = (true == bAdd) ? this->GetValue(3) : 0;
 #endif
-				}
-				break;
+		}
+		break;
 
 #if defined(__ACCE_COSTUME_SYSTEM__)
-				case COSTUME_ACCE:
-				{
-					bSetPart = PART_ACCE;
-					dwToSetValue = (bAdd) ? dwToSetValue : 0;
-				}
-				break;
+		case COSTUME_ACCE:
+		{
+			toSetValue -= 85000;
+			if (GetSocket(ACCE_ABSORPTION_SOCKET) >= ACCE_EFFECT_FROM_ABS)
+				toSetValue += 1500;
+
+			toSetValue = (bAdd == true) ? toSetValue : 0;
+			toSetPart = PART_ACCE;
+		}
+		break;
 #endif
 
 #if defined(__WEAPON_COSTUME_SYSTEM__)
-				case COSTUME_WEAPON:
-				{
-					bSetPart = PART_WEAPON;
+		case COSTUME_WEAPON:
+		{
+			toSetPart = PART_WEAPON;
 
-					if (!bAdd)
-					{
-						// ڽ      ԰ ־ٸ   look ,  ʾҴٸ default look
-						const CItem* pWeapon = m_pOwner->GetWear(WEAR_WEAPON);
+			if (false == bAdd)
+			{
+				// ڽ      ԰ ־ٸ   look ,  ʾҴٸ default look
+				const CItem* pWeapon = m_pOwner->GetWear(WEAR_WEAPON);
+				toSetValue = (NULL != pWeapon) ? pWeapon->GetVnum() : m_pOwner->GetOriginalPart(PART_WEAPON);
 #if defined(__CHANGE_LOOK_SYSTEM__)
-						if (pWeapon)
-							dwToSetValue = (pWeapon->GetTransmutationVnum() != 0) ? pWeapon->GetTransmutationVnum() : pWeapon->GetVnum();
-						else
-							dwToSetValue = 0;
-#else
-						dwToSetValue = (pWeapon != nullptr) ? pWeapon->GetVnum() : m_pOwner->GetOriginalPart(PART_WEAPON);
+				if (pWeapon)
+					toSetValue = pWeapon->GetTransmutation() != 0 ? pWeapon->GetTransmutation() : pWeapon->GetVnum();
 #endif
-					}
+			}
 #if defined(__CHANGE_LOOK_SYSTEM__)
-					else
-						dwToSetValue = (GetTransmutationVnum() != 0) ? GetTransmutationVnum() : GetVnum();
+			else
+				toSetValue = GetTransmutation() != 0 ? GetTransmutation() : GetVnum();
 #endif
-				}
-				break;
+		}
+		break;
 #endif
 
-#if defined(__AURA_COSTUME_SYSTEM__)
-				case COSTUME_AURA:
-				{
-					bSetPart = PART_AURA;
-					dwToSetValue = (bAdd) ? dwToSetValue : 0;
-				}
-				break;
-#endif
-			}
+		}
 
-			if (PART_MAX_NUM != bSetPart)
-			{
-				m_pOwner->SetPart(bSetPart, dwToSetValue);
-				m_pOwner->UpdatePacket();
-			}
+		if (PART_MAX_NUM != toSetPart)
+		{
+			m_pOwner->SetPart((BYTE)toSetPart, toSetValue);
+			m_pOwner->UpdatePacket();
 		}
-		break;
-#endif
+	}
+	break;
 
-		case ITEM_UNIQUE:
+	case ITEM_UNIQUE:
+	{
+		sys_log(0, "ITEM_UNIQUE Process");
+		if (0 != GetSIGVnum())
 		{
-			sys_log(0, "ITEM_UNIQUE Process");
-			if (GetSIGVnum() != 0)
-			{
-				sys_log(0, "ITEM_UNIQUE Contains SIGVnum %u", GetSIGVnum());
+			sys_log(0, "ITEM_UNIQUE Contains SIGVnum %d", GetSIGVnum());
 
-				const CSpecialItemGroup* pItemGroup = ITEM_MANAGER::instance().GetSpecialItemGroup(GetSIGVnum());
-				if (pItemGroup == nullptr)
-				{
-					sys_log(0, "ITEM_UNIQUE No pointer for item group?");
-					break;
-				}
+			const CSpecialItemGroup* pItemGroup = ITEM_MANAGER::instance().GetSpecialItemGroup(GetSIGVnum());
+			if (NULL == pItemGroup)
+			{
+				sys_log(0, "ITEM_UNIQUE No pointer for item group?");
+				break;
+			}
 
-				const DWORD dwAttrVnum = pItemGroup->GetAttrVnum(GetVnum());
-				const CSpecialAttrGroup* pAttrGroup = ITEM_MANAGER::instance().GetSpecialAttrGroup(dwAttrVnum);
-				if (pAttrGroup == nullptr)
-				{
-					sys_log(0, "ITEM_UNIQUE No pointer for attr group?");
-					break;
-				}
+			DWORD dwAttrVnum = pItemGroup->GetAttrVnum(GetVnum());
+			const CSpecialAttrGroup* pAttrGroup = ITEM_MANAGER::instance().GetSpecialAttrGroup(dwAttrVnum);
+			if (NULL == pAttrGroup)
+			{
+				sys_log(0, "ITEM_UNIQUE No pointer for attr group?");
+				break;
+			}
 
-				for (const CSpecialAttrInfo& it : pAttrGroup->m_vecAttrs)
-					m_pOwner->ApplyPoint(it.apply_type, bAdd ? it.apply_value : -it.apply_value);
+			for (itertype(pAttrGroup->m_vecAttrs) it = pAttrGroup->m_vecAttrs.begin(); it != pAttrGroup->m_vecAttrs.end(); it++)
+			{
+				m_pOwner->ApplyPoint(it->apply_type, bAdd ? it->apply_value : -it->apply_value);
 			}
 		}
-		break;
 	}
+	break;
 
-#if defined(__WEAPON_COSTUME_SYSTEM__)
-	if (m_pOwner->GetWear(WEAR_COSTUME_WEAPON) && !m_pOwner->GetWear(WEAR_WEAPON))
-		m_pOwner->SetPart(PART_WEAPON, 0);
-#endif
+	}
 }
 
 bool CItem::IsEquipable() const
 {
 	switch (this->GetType())
 	{
-		case ITEM_COSTUME:
-		case ITEM_ARMOR:
-		case ITEM_WEAPON:
-		case ITEM_ROD:
-		case ITEM_PICK:
-		case ITEM_UNIQUE:
-		case ITEM_DS:
-		case ITEM_SPECIAL_DS:
-		case ITEM_RING:
-		case ITEM_BELT:
-			return true;
+	case ITEM_COSTUME:
+	case ITEM_ARMOR:
+	case ITEM_WEAPON:
+	case ITEM_ROD:
+	case ITEM_PICK:
+	case ITEM_UNIQUE:
+	case ITEM_DS:
+	case ITEM_SPECIAL_DS:
+	case ITEM_RING:
+	case ITEM_BELT:
+		return true;
 	}
 
 	return false;
@@ -1318,12 +1282,11 @@
 {
 	if (!ch)
 	{
-		sys_err("EquipTo: null character");
+		sys_err("EquipTo: nil character");
 		return false;
 	}
 
 	// ȥ  index WEAR_MAX_NUM  ŭ.
-#if defined(__DRAGON_SOUL_SYSTEM__)
 	if (IsDragonSoul())
 	{
 		if (bWearCell < WEAR_MAX_NUM || bWearCell >= WEAR_MAX_NUM + DRAGON_SOUL_DECK_MAX_NUM * DS_SLOT_MAX)
@@ -1333,7 +1296,6 @@
 		}
 	}
 	else
-#endif
 	{
 		if (bWearCell >= WEAR_MAX_NUM)
 		{
@@ -1355,7 +1317,7 @@
 
 	m_pOwner = ch;
 	m_bEquipped = true;
-	m_wCell = bWearCell;
+	m_wCell = INVENTORY_MAX_NUM + bWearCell;
 
 	DWORD dwImmuneFlag = 0;
 
@@ -1369,16 +1331,14 @@
 
 	m_pOwner->SetImmuneFlag(dwImmuneFlag);
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
 	if (IsDragonSoul())
 	{
 		DSManager::instance().ActivateDragonSoul(this);
 #if defined(__DS_SET__)
-		m_pOwner->DragonSoul_SetBonus();
+		ch->DragonSoul_HandleSetBonus();
 #endif
 	}
 	else
-#endif
 	{
 		ModifyPoints(true);
 		StartUniqueExpireEvent();
@@ -1390,17 +1350,10 @@
 		// END_OF_ACCESSORY_REFINE
 	}
 
-	m_pOwner->BuffOnAttr_AddBuffsFromItem(this);
-
-#if defined(__SET_ITEM__)
-	if (IsCostume() || IsUnique())
-		m_pOwner->RefreshItemSetBonus();
-
-	if (GetItemSetValue())
-		m_pOwner->RefreshItemSetBonusByValue();
-#endif
+	ch->BuffOnAttr_AddBuffsFromItem(this);
 
 	m_pOwner->ComputeBattlePoints();
+
 	m_pOwner->UpdatePacket();
 
 	Save();
@@ -1410,7 +1363,7 @@
 
 bool CItem::Unequip()
 {
-	if (!m_pOwner || GetCell() > EQUIPMENT_MAX_NUM)
+	if (!m_pOwner || GetCell() < INVENTORY_MAX_NUM)
 	{
 		// ITEM_OWNER_INVALID_PTR_BUG
 		sys_err("%s %u m_pOwner %p, GetCell %d",
@@ -1419,7 +1372,7 @@
 		return false;
 	}
 
-	if (this != m_pOwner->GetWear(GetCell()))
+	if (this != m_pOwner->GetWear(GetCell() - INVENTORY_MAX_NUM))
 	{
 		sys_err("m_pOwner->GetWear() != this");
 		return false;
@@ -1429,16 +1382,14 @@
 	if (IsRideItem())
 		ClearMountAttributeAndAffect();
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
 	if (IsDragonSoul())
 	{
 		DSManager::instance().DeactivateDragonSoul(this);
 #if defined(__DS_SET__)
-		m_pOwner->DragonSoul_SetBonus();
+		m_pOwner->DragonSoul_HandleSetBonus();
 #endif
 	}
 	else
-#endif
 	{
 		ModifyPoints(false);
 	}
@@ -1453,9 +1404,11 @@
 	// END_OF_ACCESSORY_REFINE
 
 	m_pOwner->BuffOnAttr_RemoveBuffsFromItem(this);
-	m_pOwner->SetWear(GetCell(), nullptr);
+
+	m_pOwner->SetWear(GetCell() - INVENTORY_MAX_NUM, NULL);
 
 	DWORD dwImmuneFlag = 0;
+
 	for (int i = 0; i < WEAR_MAX_NUM; ++i)
 	{
 		if (m_pOwner->GetWear(i))
@@ -1463,20 +1416,14 @@
 			SET_BIT(dwImmuneFlag, m_pOwner->GetWear(i)->GetRealImmuneFlag());
 		}
 	}
-	m_pOwner->SetImmuneFlag(dwImmuneFlag);
 
-#if defined(__SET_ITEM__)
-	if (IsCostume() || IsUnique())
-		m_pOwner->RefreshItemSetBonus();
-
-	if (GetItemSetValue())
-		m_pOwner->RefreshItemSetBonusByValue();
-#endif
+	m_pOwner->SetImmuneFlag(dwImmuneFlag);
 
 	m_pOwner->ComputeBattlePoints();
+
 	m_pOwner->UpdatePacket();
 
-	m_pOwner = nullptr;
+	m_pOwner = NULL;
 	m_wCell = 0;
 	m_bEquipped = false;
 
@@ -1502,26 +1449,6 @@
 	ITEM_MANAGER::instance().DelayedSave(this);
 }
 
-#if defined(__MOVE_COSTUME_ATTR__)
-bool CItem::CanChangeCostumeAttr() const
-{
-	if (GetType() != ITEM_COSTUME)
-		return false;
-
-	switch (GetSubType())
-	{
-		case COSTUME_BODY:
-		case COSTUME_HAIR:
-#if defined(__WEAPON_COSTUME_SYSTEM__)
-		case COSTUME_WEAPON:
-#endif
-			return true;
-	}
-
-	return false;
-}
-#endif
-
 bool CItem::CreateSocket(BYTE bSlot, BYTE bGold)
 {
 	assert(bSlot < ITEM_SOCKET_MAX_NUM);
@@ -1563,13 +1490,13 @@
 {
 	if (IS_SET(GetFlag(), ITEM_FLAG_COUNT_PER_1GOLD))
 	{
-		if (GetProto()->dwShopSellPrice == 0)
+		if (GetProto()->dwGold == 0)
 			return GetCount();
 		else
-			return GetCount() / GetProto()->dwShopSellPrice;
+			return GetCount() / GetProto()->dwGold;
 	}
 	else
-		return GetProto()->dwShopSellPrice;
+		return GetProto()->dwGold;
 }
 
 int CItem::GetShopBuyPrice()
@@ -1577,11 +1504,6 @@
 	return GetProto()->dwShopBuyPrice;
 }
 
-int CItem::GetShopSellPrice()
-{
-	return GetProto()->dwShopSellPrice;
-}
-
 bool CItem::IsOwnership(LPCHARACTER ch)
 {
 	if (!m_pkOwnershipEvent)
@@ -1686,10 +1608,10 @@
 
 void CItem::AlterToSocketItem(int iSocketCount)
 {
-	if (iSocketCount >= METIN_SOCKET_MAX_NUM)
+	if (iSocketCount >= ITEM_SOCKET_MAX_NUM)
 	{
-		sys_log(0, "Invalid Socket Count %d, set to maximum", METIN_SOCKET_MAX_NUM);
-		iSocketCount = METIN_SOCKET_MAX_NUM;
+		sys_log(0, "Invalid Socket Count %d, set to maximum", ITEM_SOCKET_MAX_NUM);
+		iSocketCount = ITEM_SOCKET_MAX_NUM;
 	}
 
 	for (int i = 0; i < iSocketCount; ++i)
@@ -1713,59 +1635,29 @@
 
 	switch (GetType())
 	{
-		case ITEM_WEAPON:
-		{
-			iSecondPct = 20;
-			iThirdPct = 5;
-		}
+	case ITEM_WEAPON:
+		iSecondPct = 20;
+		iThirdPct = 5;
 		break;
-
-		case ITEM_ARMOR:
+	case ITEM_COSTUME:
+		iSecondPct = 30;
+		iThirdPct = 20;
+		break;
+	case ITEM_ARMOR:
+		if (GetSubType() == ARMOR_BODY)
 		{
-			if (GetSubType() == ARMOR_BODY)
-			{
-				iSecondPct = 10;
-				iThirdPct = 2;
-			}
-			else
-			{
-				iSecondPct = 10;
-				iThirdPct = 1;
-			}
+			iSecondPct = 10;
+			iThirdPct = 2;
 		}
-		break;
-
-#if defined(__MOVE_COSTUME_ATTR__)
-		case ITEM_COSTUME:
+		else
 		{
-			if (GetSubType() == COSTUME_BODY)
-			{
-				iSecondPct = 30;
-				iThirdPct = 10;
-			}
-			else if (GetSubType() == COSTUME_HAIR)
-			{
-				iSecondPct = 30;
-				iThirdPct = 10;
-			}
-#if defined(__WEAPON_COSTUME_SYSTEM__)
-			else if (GetSubType() == COSTUME_WEAPON)
-			{
-				iSecondPct = 30;
-				iThirdPct = 10;
-			}
-#endif
-			else
-			{
-				iSecondPct = 0;
-				iThirdPct = 0;
-			}
+			iSecondPct = 10;
+			iThirdPct = 1;
 		}
 		break;
-#endif
 
-		default:
-			return;
+	default:
+		return;
 	}
 
 	// 100% Ȯ  Ӽ ϳ
@@ -1791,15 +1683,16 @@
 	if (!p)
 		return 0;
 
-	int	rtn = 0;
+	int rtn = 0;
 	str_to_number(rtn, p + 1);
 
-	const char* locale_name = GetName();
+	const char* locale_name = GetLocaleName();
+
 	p = const_cast<char*>(strrchr(locale_name, '+'));
 
 	if (p)
 	{
-		int	locale_rtn = 0;
+		int locale_rtn = 0;
 		str_to_number(locale_rtn, p + 1);
 		if (locale_rtn != rtn)
 		{
@@ -1810,35 +1703,6 @@
 	return rtn;
 }
 
-#if defined(__LOOT_FILTER_SYSTEM__)
-long CItem::GetWearingLevelLimit() const
-{
-	if (m_pProto)
-	{
-		for (int i = 0; i < ITEM_LIMIT_MAX_NUM; ++i)
-			if (m_pProto->aLimits[i].bType == LIMIT_LEVEL)
-				return m_pProto->aLimits[i].lValue;
-	}
-
-	return 0;
-}
-
-bool CItem::IsHairDye() const
-{
-	switch (GetVnum())
-	{
-		case 70202:
-		case 70203:
-		case 70204:
-		case 70205:
-		case 70206:
-			return true;
-		default:
-			return false;
-	}
-}
-#endif
-
 bool CItem::IsPolymorphItem()
 {
 	return GetType() == ITEM_POLYMORPH;
@@ -1916,17 +1780,11 @@
 		pkItem->SetSocket(ITEM_SOCKET_REMAIN_SEC, 0);
 
 		// ϴ timer based on wear ȥ ð  Ǿٰ  ʴ´.
-#if defined(__DRAGON_SOUL_SYSTEM__)
 		if (pkItem->IsDragonSoul())
 		{
 			DSManager::instance().DeactivateDragonSoul(pkItem);
-#if defined(__DS_SET__)
-			if (pkItem->GetOwner())
-				pkItem->GetOwner()->DragonSoul_SetBonus();
-#endif
 		}
 		else
-#endif
 		{
 			ITEM_MANAGER::instance().RemoveItem(pkItem, "TIMER_BASED_ON_WEAR_EXPIRE");
 		}
@@ -1963,14 +1821,13 @@
 	if (current > item->GetSocket(0))
 	{
 #if defined(__CHANGE_LOOK_SYSTEM__)
-		LPCHARACTER owner = item->GetOwner();
-		if (owner)
+		if (item->isLocked())
 		{
-			CChangeLook* pChangeLook = owner->GetChangeLook();
-			if (pChangeLook)
-				pChangeLook->Clear();
+			if (LPCHARACTER ch = item->GetOwner())
+				ch->ClearChangeLookWindow();
 		}
 #endif
+
 #ifdef __GROWTH_PET_SYSTEM__
 		if (item->GetType() == ITEM_PET && item->GetSubType() == PET_UPBRINGING)
 		{
@@ -1981,31 +1838,21 @@
 			}
 		}
 
+
 		if (IS_SET(item->GetAntiFlag(), ITEM_ANTIFLAG_RT_REMOVE))
 		{
 			item->StopRealTimeExpireEvent();
 			return 0;
 		}
-
 #endif
 		ITEM_MANAGER::instance().RemoveItem(item, "REAL_TIME_EXPIRE");
+
 		return 0;
 	}
 
 	return PASSES_PER_SEC(1);
 }
 
-#if defined(__GROWTH_PET_SYSTEM__)
-void CItem::StopRealTimeExpireEvent()
-{
-	if (!m_pkRealTimeExpireEvent)
-		return;
-
-	event_cancel(&m_pkRealTimeExpireEvent);
-	m_pkRealTimeExpireEvent = nullptr;
-}
-#endif
-
 void CItem::StartRealTimeExpireEvent()
 {
 	if (m_pkRealTimeExpireEvent)
@@ -2026,6 +1873,118 @@
 		}
 	}
 }
+#ifdef __GROWTH_PET_SYSTEM__
+void CItem::StopRealTimeExpireEvent()
+{
+	if (!m_pkRealTimeExpireEvent)
+		return;
+
+	event_cancel(&m_pkRealTimeExpireEvent);
+	m_pkRealTimeExpireEvent = nullptr;
+}
+#endif
+#if defined(__SOUL_SYSTEM__)
+EVENTFUNC(soul_time_use_event)
+{
+	const item_vid_event_info* info = reinterpret_cast<const item_vid_event_info*>(event->info);
+
+	if (NULL == info)
+	{
+		sys_err("expire_event <Factor> Null pointer");
+		return 0;
+	}
+
+	const LPITEM item = ITEM_MANAGER::instance().FindByVID(info->item_vid);
+
+	if (NULL == item)
+		return 0;
+
+	item->SetSoulKeepTime();
+
+	int iSec = test_server ? 1 : 60;
+	return PASSES_PER_SEC(iSec);
+}
+
+void CItem::StartSoulTimeUseEvent()
+{
+	if (m_pkSoulTimeUseEvent)
+		return;
+
+	if (GetType() == ITEM_SOUL)
+	{
+		int iSec = test_server ? 1 : 60;
+		item_vid_event_info* info = AllocEventInfo<item_vid_event_info>();
+		info->item_vid = GetVID();
+		m_pkSoulTimeUseEvent = event_create(soul_time_use_event, info, PASSES_PER_SEC(iSec));
+
+		sys_log(0, "SOUL_TIME_USE: StartSoulTimeUseEvent");
+
+		return;
+	}
+}
+#endif
+
+#if defined(__EXTENDED_BLEND_AFFECT__)
+EVENTFUNC(blend_use_expire_event)
+{
+	item_event_info* info = dynamic_cast<item_event_info*>(event->info);
+
+	if (info == NULL)
+	{
+		sys_err("expire_event <Factor> Null pointer");
+		return 0;
+	}
+
+	LPITEM pkItem = info->item;
+	int remain_time = pkItem->GetSocket(2) - processing_time / passes_per_sec;
+	if (remain_time <= 0)
+	{
+		pkItem->SetSocket(2, 0);
+		pkItem->SetSocket(3, false);
+		pkItem->Lock(false);
+		ITEM_MANAGER::instance().RemoveItem(pkItem, "BLEND_USE_EXPIRE");
+		return 0;
+	}
+
+	pkItem->SetSocket(2, remain_time);
+	return PASSES_PER_SEC(MIN(1, remain_time));
+}
+
+void CItem::StartBlendExpireEvent()
+{
+	if (m_pkBlendUseEvent)
+		return;
+
+	if (IsRealTimeItem())
+		return;
+
+	if (!IsBlendItem())
+		return;
+
+	int iSec = GetSocket(2);
+
+	if (iSec >= 8640000)
+		return;
+
+	item_event_info* info = AllocEventInfo<item_event_info>();
+	info->item = this;
+
+	m_pkBlendUseEvent = event_create(blend_use_expire_event, info, PASSES_PER_SEC(1));
+}
+
+void CItem::StopBlendExpireEvent()
+{
+	if (!m_pkBlendUseEvent)
+		return;
+
+	int remain_time = GetSocket(2) - event_processing_time(m_pkBlendUseEvent) / passes_per_sec;
+
+	SetSocket(2, remain_time);
+	event_cancel(&m_pkBlendUseEvent);
+
+	ITEM_MANAGER::instance().SaveSingleItem(this);
+}
+#endif
 
 bool CItem::IsRealTimeItem()
 {
@@ -2034,7 +1993,7 @@
 
 	for (int i = 0; i < ITEM_LIMIT_MAX_NUM; i++)
 	{
-		if (LIMIT_REAL_TIME == GetProto()->aLimits[i].bType || LIMIT_REAL_TIME_START_FIRST_USE == GetProto()->aLimits[i].bType)
+		if (LIMIT_REAL_TIME == GetProto()->aLimits[i].bType)
 			return true;
 	}
 
@@ -2048,6 +2007,12 @@
 
 void CItem::StartUniqueExpireEvent()
 {
+	if (!m_pOwner)
+	{
+		// sys_err("Item::StartUniqueExpireEvent owner null");
+		return;
+	}
+
 #if defined(__MOUNT_COSTUME_SYSTEM__)
 	if (GetType() != ITEM_UNIQUE && !IsRideItem())
 		return;
@@ -2065,7 +2030,7 @@
 
 	// HARD CODING
 	if (GetVnum() == UNIQUE_ITEM_HIDE_ALIGNMENT_TITLE)
-		if (m_pOwner) m_pOwner->ShowAlignment(false);
+		m_pOwner->ShowAlignment(false);
 
 	int iSec = GetSocket(ITEM_SOCKET_UNIQUE_SAVE_TIME);
 
@@ -2089,7 +2054,7 @@
 	if (m_pkTimerBasedOnWearExpireEvent)
 		return;
 
-	// Ⱓ   ð   ʴ´
+	//Ⱓ   ð   ʴ´
 	if (IsRealTimeItem())
 		return;
 
@@ -2164,26 +2129,6 @@
 		(m_pProto->bType == ITEM_BELT); // 2013 2  ߰ 'Ʈ'   ȹ Ǽ  ý ״ ̿ڰ .
 }
 
-bool CItem::IsRemovableSocket()
-{
-	if (m_pProto->bType == ITEM_ARMOR)
-		return m_pProto->bSubType == ARMOR_BODY
-#if defined(__GLOVE_SYSTEM__)
-		|| m_pProto->bSubType == ARMOR_GLOVE
-#endif
-		;
-
-	if (m_pProto->bType == ITEM_WEAPON)
-		return !(m_pProto->bSubType == WEAPON_ARROW
-			|| m_pProto->bSubType == WEAPON_MOUNT_SPEAR
-#if defined(__QUIVER_SYSTEM__)
-			|| m_pProto->bSubType == WEAPON_QUIVER
-#endif
-			|| m_pProto->bSubType == WEAPON_BOUQUET);
-
-	return false;
-}
-
 void CItem::SetAccessorySocketGrade(int iGrade)
 {
 	SetSocket(0, MINMAX(0, iGrade, GetAccessorySocketMaxGrade()));
@@ -2206,7 +2151,7 @@
 	SetSocket(2, time);
 
 	if (test_server && GetOwner())
-		GetOwner()->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s    ð %d", LC_ITEM(GetVnum()), time));
+		GetOwner()->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s    ð %d"), GetLocaleName(), time);
 }
 
 EVENTFUNC(accessory_socket_expire_event)
@@ -2298,7 +2243,8 @@
 {
 	if (ITEM_UNIQUE == GetType() && UNIQUE_SPECIAL_RIDE == GetSubType())
 		return true;
-
+	if (ITEM_UNIQUE == GetType() && UNIQUE_SPECIAL_MOUNT_RIDE == GetSubType())
+		return true;
 #if defined(__MOUNT_COSTUME_SYSTEM__)
 	if (ITEM_COSTUME == GetType() && COSTUME_MOUNT == GetSubType())
 		return true;
@@ -2307,6 +2253,13 @@
 	return false;
 }
 
+bool CItem::IsRamadanRing()
+{
+	if (GetVnum() == UNIQUE_ITEM_RAMADAN_RING)
+		return true;
+	return false;
+}
+
 void CItem::ClearMountAttributeAndAffect()
 {
 	LPCHARACTER ch = GetOwner();
@@ -2322,6 +2275,52 @@
 	ch->PointChange(POINT_IQ, 0);
 }
 
+#if defined(__SOUL_SYSTEM__)
+void CItem::SetSoulKeepTime()
+{
+	if (GetType() != ITEM_SOUL)
+		return;
+
+	LPCHARACTER ch = GetOwner();
+	if (!ch)
+		return;
+
+	DWORD dwItemPlayTime = GetSocket(3);
+	DWORD dwMaxTime = GetLimitValue(1);
+	int iSoulAttacks = GetValue(2);
+
+	if (dwItemPlayTime < dwMaxTime)
+	{
+		dwItemPlayTime += 1;
+
+		DWORD dwUseData = (dwItemPlayTime * 10000) + iSoulAttacks;
+		SetSocket(2, dwUseData);
+		SetSocket(3, dwItemPlayTime);
+	}
+	else
+	{
+		event_cancel(&m_pkSoulTimeUseEvent);
+		return;
+	}
+}
+#endif
+
+// fixme
+// ̰  Ⱦ... ٵ Ȥó ; ܵ.
+// by rtsummit
+bool CItem::IsNewMountItem()
+{
+	switch (GetVnum())
+	{
+	case 76000: case 76001: case 76002: case 76003:
+	case 76004: case 76005: case 76006: case 76007:
+	case 76008: case 76009: case 76010: case 76011:
+	case 76012: case 76013: case 76014:
+		return true;
+	}
+	return false;
+}
+
 void CItem::SetAccessorySocketExpireEvent(LPEVENT pkEvent)
 {
 	m_pkAccessorySocketExpireEvent = pkEvent;
@@ -2335,7 +2334,7 @@
 
 		if (ch)
 		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s ִ  ϴ.", LC_ITEM(GetVnum())));
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("%s ִ  ϴ."), GetLocaleName());
 		}
 
 		ModifyPoints(false);
@@ -2388,12 +2387,6 @@
 		{ 50637, 14540, 16540, 17540 },
 		{ 50638, 14560, 16560, 17560 },
 		{ 50639, 14570, 16570, 0 },
-#if defined(__CONQUEROR_LEVEL__)
-		{ 50661, 14590, 16590, 17580 },
-		{ 50662, 14600, 16600, 17590 },
-		{ 50663, 14610, 16610, 17600 },
-		{ 50664, 14580, 16580, 17570 },
-#endif
 	};
 
 	DWORD item_type = (item->GetVnum() / 10) * 10;
@@ -2402,45 +2395,45 @@
 		const JewelAccessoryInfo& info = infos[i];
 		switch (item->GetSubType())
 		{
-			case ARMOR_WRIST:
-				if (info.wrist == item_type)
+		case ARMOR_WRIST:
+			if (info.wrist == item_type)
+			{
+				if (info.jewel == GetVnum())
 				{
-					if (info.jewel == GetVnum())
-					{
-						return true;
-					}
-					else
-					{
-						return false;
-					}
+					return true;
 				}
-				break;
-			case ARMOR_NECK:
-				if (info.neck == item_type)
+				else
 				{
-					if (info.jewel == GetVnum())
-					{
-						return true;
-					}
-					else
-					{
-						return false;
-					}
+					return false;
 				}
-				break;
-			case ARMOR_EAR:
-				if (info.ear == item_type)
+			}
+			break;
+		case ARMOR_NECK:
+			if (info.neck == item_type)
+			{
+				if (info.jewel == GetVnum())
 				{
-					if (info.jewel == GetVnum())
-					{
-						return true;
-					}
-					else
-					{
-						return false;
-					}
+					return true;
 				}
-				break;
+				else
+				{
+					return false;
+				}
+			}
+			break;
+		case ARMOR_EAR:
+			if (info.ear == item_type)
+			{
+				if (info.jewel == GetVnum())
+				{
+					return true;
+				}
+				else
+				{
+					return false;
+				}
+			}
+			break;
 		}
 	}
 	if (item->GetSubType() == ARMOR_WRIST)
@@ -2481,6 +2474,18 @@
 	return 50623 + type == GetVnum();
 }
 
+// PC_BANG_ITEM_ADD
+bool CItem::IsPCBangItem()
+{
+	for (int i = 0; i < ITEM_LIMIT_MAX_NUM; ++i)
+	{
+		if (m_pProto->aLimits[i].bType == LIMIT_PCBANG)
+			return true;
+	}
+	return false;
+}
+// END_PC_BANG_ITEM_ADD
+
 bool CItem::IsStackable()
 {
 	return (GetFlag() & ITEM_FLAG_STACKABLE) ? true : false;
@@ -2499,14 +2504,14 @@
 	return true;
 }
 
-POINT_VALUE CItem::FindApplyValue(POINT_TYPE wApplyType)
+long CItem::FindApplyValue(BYTE bApplyType)
 {
 	if (m_pProto == NULL)
 		return 0;
 
 	for (int i = 0; i < ITEM_APPLY_MAX_NUM; ++i)
 	{
-		if (m_pProto->aApplies[i].wType == wApplyType)
+		if (m_pProto->aApplies[i].bType == bApplyType)
 			return m_pProto->aApplies[i].lValue;
 	}
 
@@ -2519,14 +2524,14 @@
 	if (!IsCostumeMount())
 		return 0;
 
-	const DWORD dwMountVnum = FindApplyValue(APPLY_MOUNT);
-#if defined(__CHANGE_LOOK_SYSTEM__)
-	const DWORD c_dwTransmutationVnum = GetTransmutationVnum();
-	if (c_dwTransmutationVnum != 0)
-	{
-		TItemTable* pItemTable = ITEM_MANAGER::instance().GetTable(c_dwTransmutationVnum);
-		if (pItemTable)
-			return static_cast<DWORD>(pItemTable->FindApplyValue(APPLY_MOUNT));
+	DWORD dwMountVnum = FindApplyValue(APPLY_MOUNT);
+#if defined(__MOUNT_CHANGE_LOOK__)
+	DWORD dwChangeLook = GetTransmutation();
+	if (dwChangeLook > 0)
+	{
+		TItemTable* pItemProto = ITEM_MANAGER::instance().GetTable(dwChangeLook);
+		if (pItemProto)
+			dwMountVnum = pItemProto->FindApplyValue(APPLY_MOUNT);
 	}
 #endif
 	return dwMountVnum;
@@ -2573,8 +2578,8 @@
 
 	for (int i = 0; i < ITEM_ATTRIBUTE_MAX_NUM; ++i)
 	{
-		POINT_TYPE type = m_aAttr[i].wType;
-		POINT_VALUE value = m_aAttr[i].lValue;
+		int type = m_aAttr[i].bType;
+		int value = m_aAttr[i].sValue;
 
 		if (type)
 			LogManager::instance().ItemLog(i, type, value, GetID(), "INFO_ATTR", "", pszIP ? pszIP : "", GetOriginalVnum());
@@ -2593,28 +2598,27 @@
 	return 0;
 }
 
-int CItem::GetDurationLimit()
-{
-	for (int i = 0; i < ITEM_LIMIT_MAX_NUM; ++i)
-	{
-		if (this->m_pProto->aLimits[i].bType == LIMIT_DURATION)
-		{
-			return this->m_pProto->aLimits[i].lValue;
-		}
-	}
-	return 0;
-}
-
 bool CItem::OnAfterCreatedItem()
 {
 #if defined(__SOUL_SYSTEM__)
-	if (GetType() == ITEM_SOUL && GetLimitValue(1) != 0)
-		StartSoulTimerUseEvent();
+	if (GetType() == ITEM_SOUL)
+		StartSoulTimeUseEvent();
 #endif
 
 #if defined(__SOUL_BIND_SYSTEM__)
-	if (GetSealDate() > E_SEAL_DATE_DEFAULT_TIMESTAMP)
-		StartSealDateExpireTimerEvent();
+	if (GetSealedTime() > 0)
+		StartUnbindTimerExpireEvent();
+#endif
+
+#if defined(__EXTENDED_BLEND_AFFECT__) && defined(__ITEM_SOCKET5__)
+	if (IsBlendItem())
+	{
+		if (GetSocket(3) == true)
+		{
+			Lock(true);
+			StartBlendExpireEvent();
+		}
+	}
 #endif
 
 	//   ̶ ߴٸ,  Ŀ   ʾƵ ð Ǵ 
@@ -2630,7 +2634,6 @@
 	return true;
 }
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
 bool CItem::IsDragonSoul()
 {
 	return GetType() == ITEM_DS;
@@ -2688,6 +2691,65 @@
 	else
 		return 0;
 }
+
+#if defined(__EXTENDED_DSS_RECHARGE__)
+int CItem::GiveMoreTime_Extend(DWORD dwTime)
+{
+	if (IsDragonSoul())
+	{
+		int remain_sec = GetSocket(ITEM_SOCKET_REMAIN_SEC);
+
+		if (remain_sec >= MIN_INFINITE_DURATION)
+			return 0;
+
+		if (dwTime < 86400)
+			dwTime = 86400;
+
+		if ((dwTime + remain_sec) >= MIN_INFINITE_DURATION)
+			SetSocket(ITEM_SOCKET_REMAIN_SEC, MAX_INFINITE_DURATION);
+		else
+			SetSocket(ITEM_SOCKET_REMAIN_SEC, dwTime + remain_sec);
+
+		return dwTime;
+	}
+	else
+		return 0;
+}
+#endif
+
+#if defined(__EXTENDED_COSTUME_RECHARGE__)
+bool CItem::GiveInfiniteTime()
+{
+	if (IsCostume())
+	{
+		bool bExtendable = false;
+		for (int i = 0; i < ITEM_LIMIT_MAX_NUM; ++i)
+		{
+			long lLimitValue = GetLimitValue(i);
+			switch (GetLimitType(i))
+			{
+			case LIMIT_REAL_TIME:
+				if (lLimitValue < MIN_INFINITE_DURATION)
+					bExtendable = true;
+				break;
+			}
+		}
+
+		if (bExtendable)
+		{
+			int iRemainingSec = GetSocket(ITEM_SOCKET_REMAIN_SEC);
+
+			if (iRemainingSec > (get_global_time() + MIN_INFINITE_DURATION))
+				return false;
+
+			SetSocket(ITEM_SOCKET_REMAIN_SEC, MAX_INFINITE_DURATION);
+		}
+
+		return true;
+	}
+	else
+		return false;
+}
 #endif
 
 int CItem::GetDuration()
@@ -2728,11 +2790,11 @@
 		{
 			const TPlayerItemAttribute& ia = GetAttribute(i);
 
-			if (ia.wType == APPLY_IMMUNE_STUN && !IS_SET(dwImmuneFlag, IMMUNE_STUN))
+			if (ia.bType == APPLY_IMMUNE_STUN && !IS_SET(dwImmuneFlag, IMMUNE_STUN))
 				SET_BIT(dwImmuneFlag, IMMUNE_STUN);
-			else if (ia.wType == APPLY_IMMUNE_FALL && !IS_SET(dwImmuneFlag, IMMUNE_FALL))
+			else if (ia.bType == APPLY_IMMUNE_FALL && !IS_SET(dwImmuneFlag, IMMUNE_FALL))
 				SET_BIT(dwImmuneFlag, IMMUNE_FALL);
-			else if (ia.wType == APPLY_IMMUNE_SLOW && !IS_SET(dwImmuneFlag, IMMUNE_SLOW))
+			else if (ia.bType == APPLY_IMMUNE_SLOW && !IS_SET(dwImmuneFlag, IMMUNE_SLOW))
 				SET_BIT(dwImmuneFlag, IMMUNE_SLOW);
 		}
 	}
@@ -2740,269 +2802,291 @@
 	return dwImmuneFlag;
 }
 
-#if defined(__CHANGE_LOOK_SYSTEM__)
-void CItem::SetTransmutationVnum(DWORD blVnum)
-{
-	m_dwTransmutationVnum = blVnum;
-	Save();
-}
-
-DWORD CItem::GetTransmutationVnum() const
-{
-	return m_dwTransmutationVnum;
-}
-#endif
-
-#if defined(__SET_ITEM__)
-void CItem::SetItemSetValue(BYTE bSet)
+const char* CItem::GetLocaleName()
 {
-	m_bSetValue = bSet;
-	UpdatePacket();
-}
-
-BYTE CItem::GetItemSetValue() const
-{
-	return m_bSetValue;
-}
-#endif
-
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-void CItem::SetRefineElement(const TPlayerItemRefineElement* pTable)
-{
-	thecore_memcpy(&m_RefineElement, pTable, sizeof(m_RefineElement));
-
-	UpdatePacket();
-	Save();
-}
-
-void CItem::CopyElementTo(const LPITEM pItem)
-{
-	pItem->SetRefineElement(&m_RefineElement);
-}
-
-void CItem::UpgradeRefineElement(WORD wApplyType, BYTE bValue, BYTE bBonusValue)
-{
-	BYTE& bGrade = m_RefineElement.bGrade;
-	if (bGrade >= REFINE_ELEMENT_MAX)
-		return;
-
-	++bGrade;
-
-	m_RefineElement.abValue[bGrade - 1] = bValue;
-	m_RefineElement.abBonusValue[bGrade - 1] = bBonusValue;
-	m_RefineElement.wApplyType = wApplyType;
-
-	UpdatePacket();
-	Save();
-}
-
-void CItem::DowngradeRefineElement()
-{
-	BYTE& bGrade = m_RefineElement.bGrade;
-	if (bGrade == 0)
-		return;
-
-	--bGrade;
-
-	m_RefineElement.abValue[bGrade] = 0;
-	m_RefineElement.abBonusValue[bGrade] = 0;
-
-	if (bGrade == 0)
-		m_RefineElement.wApplyType = 0;
-
-	UpdatePacket();
-	Save();
-}
-
-void CItem::ChangeRefineElement(WORD wApplyType)
-{
-	m_RefineElement.wApplyType = wApplyType;
-
-	UpdatePacket();
-	Save();
-}
+#if defined(__ITEM_DROP_RENEWAL__)
+	static char szItemName[128];
+	memset(szItemName, 0, sizeof(szItemName));
 
-BYTE CItem::GetRefineElementValue() const
-{
-	const BYTE& bGrade = m_RefineElement.bGrade;
-	if (bGrade == 0)
-		return 0;
+	if (GetProto())
+	{
+		BYTE bLocale = GetOwner() ? GetOwner()->GetLanguage() : LOCALE_DEFAULT;
 
-	BYTE bValue = 0;
-	for (BYTE bPos = 0; bPos < REFINE_ELEMENT_MAX && bPos < bGrade; ++bPos)
-		bValue += m_RefineElement.abValue[bPos];
+		int len = 0;
+		switch (GetType())
+		{
+		case ITEM_POLYMORPH:
+		{
+			const DWORD dwMobVnum = GetSocket(0);
+			const CMob* pMob = CMobManager::instance().Get(dwMobVnum);
+			if (pMob)
+				len = snprintf(szItemName, sizeof(szItemName), "%s", LC_LOCALE_MOB_TEXT(dwMobVnum, bLocale));
+		}
+		break;
 
-	return bValue;
-}
+		case ITEM_SKILLBOOK:
+		case ITEM_SKILLFORGET:
+		{
+			const DWORD dwSkillVnum = (GetVnum() == ITEM_SKILLBOOK_VNUM || GetVnum() == ITEM_SKILLFORGET_VNUM) ? GetSocket(0) : 0;
+			const CSkillProto* pSkill = (dwSkillVnum != 0) ? CSkillManager::instance().Get(dwSkillVnum) : NULL;
+			if (pSkill)
+				len = snprintf(szItemName, sizeof(szItemName), "%s", LC_LOCALE_SKILL_TEXT(dwSkillVnum, bLocale));
+		}
+		break;
 
-BYTE CItem::GetRefineElementBonusValue() const
-{
-	const BYTE& bGrade = m_RefineElement.bGrade;
-	if (bGrade == 0)
-		return 0;
+		}
 
-	BYTE bValue = 0;
-	for (BYTE bPos = 0; bPos < REFINE_ELEMENT_MAX && bPos < bGrade; ++bPos)
-		bValue += m_RefineElement.abBonusValue[bPos];
+		len += snprintf(szItemName + len, sizeof(szItemName) - len, (len > 0) ? " %s" : "%s", LC_LOCALE_ITEM_TEXT(GetVnum(), bLocale));
+	}
 
-	return bValue;
-}
+	return szItemName;
+#else
+	BYTE bLocale = GetOwner() ? GetOwner()->GetLanguage() : LOCALE_DEFAULT;
+	return m_pProto ? LC_LOCALE_ITEM_TEXT(GetVnum(), bLocale) : NULL;
 #endif
-
-#if defined(__SOUL_SYSTEM__)
-EVENTFUNC(soul_timer_use_event)
-{
-	const item_vid_event_info* info = reinterpret_cast<const item_vid_event_info*>(event->info);
-	if (info == nullptr)
-		return 0;
-
-	LPITEM item = ITEM_MANAGER::instance().FindByVID(info->item_vid);
-	if (item == nullptr)
-		return 0;
-
-	long data = item->GetSocket(2);
-	if (data == 0)
-		data = item->GetValue(2);
-
-	long keep_time = data / 10000;
-	long max_time = item->GetLimitValue(1);
-	int min_time = 60;
-	long remain_count = data % 10000;
-
-	if (keep_time % min_time == 0 && keep_time > 0 && item->GetSocket(1) != TRUE)
-		if (const LPCHARACTER& ch = item->GetOwner())
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("[Soul System] Use %s to receive the effect.", LC_ITEM(item->GetVnum())));
-
-	if (keep_time >= max_time)
-		return 0;
-
-	auto new_data = ((keep_time + 1) * 10000) + remain_count;
-	item->SetSocket(2, new_data, false /* log */);
-
-	return PASSES_PER_SEC(test_server ? 1 : 60);
 }
 
-void CItem::StartSoulTimerUseEvent()
+const char* CItem::GetName()
 {
-	if (m_pkSoulTimerUseEvent)
-		return;
-
-	item_vid_event_info* info = AllocEventInfo<item_vid_event_info>();
-	info->item_vid = GetVID();
-	m_pkSoulTimerUseEvent = event_create(soul_timer_use_event, info, PASSES_PER_SEC(test_server ? 1 : 60));
+	return m_pProto ? LC_LOCALE_ITEM_TEXT(GetVnum(), LOCALE_DEFAULT) : NULL;
 }
 
-void CItem::ResetSoulTimerUseEvent()
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+bool CItem::IsSkillBook()
 {
-	if (m_pkSoulTimerUseEvent)
-		event_cancel(&m_pkSoulTimerUseEvent);
-
-	StartSoulTimerUseEvent();
+	return GetType() == ITEM_SKILLBOOK;
 }
-#endif
 
-#if defined(__GLOVE_SYSTEM__)
-DWORD CItem::GetRandomSungMaSocketValue(BYTE bType, int iRefineLevel, bool bMultiplier)
+bool CItem::IsUpgradeItem()
 {
-	/*
-	* NOTE : If you're planning to edit this function be very careful with its limitations.
-	* The maximum data size cannot be more than a `LONG_MAX` value and each parameter has to
-	* respect certain values.
-	*
-	* @param bType - Value5 of the Spirit Stone.
-	* @param iRefineLeveL - Level of the Spirit Stone.
-	* These parameters cannot be valued above 9!
-	*
-	* @param bMultiplier - Chance given to multiply the value of the bonus.
-	*
-	* Additional limitations to be respected:
-	*	- ApplyType < 999 !
-	*	- ApplyValue < 99 !
-	*
-	* Need Debugging?
-	*	. 2394230 APPLY_SUNGMA_STR		RefineLevel 4	Type 2	ApplyValue 30
-	*	. 2404230 APPLY_SUNGMA_HP		RefineLevel 4	Type 2	ApplyValue 30
-	*	. 2414230 APPLY_SUNGMA_MOVE		RefineLevel 4	Type 2	ApplyValue 30
-	*	. 2424230 APPLY_SUNGMA_IMMUNE	RefineLevel 4	Type 2	ApplyValue 30
-	*
-	* 20230511.Owsap
-	*/
-
-	if (bType >= 10 || iRefineLevel >= 10)
-	{
-		sys_err("CItem::GetRandomSungMaSocketValue:: bType %d (Value5) or iRefineLevel %d is too high to store in the socket data.", bType, iRefineLevel);
-		return 0;
-	}
-
-	std::vector<WORD> vApplyTypes
-	{
-		APPLY_SUNGMA_STR,
-		APPLY_SUNGMA_HP,
-		APPLY_SUNGMA_MOVE,
-		APPLY_SUNGMA_IMMUNE,
-	};
-
-	const BYTE bDefaultValues[] = { 1, 3, 6, 9, 15 };
-	WORD wApplyType = vApplyTypes[number(0, (vApplyTypes.size() - 1))];
-
-	// DUPLICATE_APPLY_TYPE_FIX
-	std::unordered_set<WORD> wRepeatedSet;
-	for (BYTE bSocketIndex = 0; bSocketIndex < ITEM_SOCKET_MAX_NUM; ++bSocketIndex)
-	{
-		const DWORD dwData = GetSocket(bSocketIndex);
-		if (dwData < 1000000)
-			continue;
-
-		const WORD wSocketApplyType = (dwData / 10000) % 1000;
-		if (std::find(vApplyTypes.begin(), vApplyTypes.end(), wSocketApplyType) != vApplyTypes.end())
-			wRepeatedSet.emplace(wSocketApplyType);
-	}
-
-	bool bCheckRepeat = true;
-	while (bCheckRepeat)
-	{
-		wApplyType = vApplyTypes[number(0, (vApplyTypes.size() - 1))];
-		if (wRepeatedSet.count(wApplyType) == 0)
-			bCheckRepeat = false;
-	}
-	// END_OF_DUPLICATE_APPLY_TYPE_FIX
-
-	long lValue = bDefaultValues[iRefineLevel];
-	if (lValue >= 100)
-	{
-		sys_err("CItem::GetRandomSungMaSocketValue:: ApplyValue %ld is too high to store in the socket data.", lValue);
-		return 0;
-	}
-
-	if (bMultiplier)
-		lValue *= 2;
-
-	DWORD dwData = (wApplyType * 10000) + (iRefineLevel * 1000) + (bType * 100) + lValue;
-	if (dwData >= LONG_MAX)
+	switch (GetVnum())
 	{
-		sys_err("CItem::GetRandomSungMaSocketValue:: Unsupported data!");
-		return 0;
+	case 30003:
+	case 30004:
+	case 30005:
+	case 30006:
+	case 30007:
+	case 30008:
+	case 30009:
+	case 30010:
+	case 30011:
+	case 30014:
+	case 30015:
+	case 30016:
+	case 30017:
+	case 30018:
+	case 30019:
+	case 30021:
+	case 30022:
+	case 30023:
+	case 30025:
+	case 30027:
+	case 30028:
+	case 30030:
+	case 30031:
+	case 30032:
+	case 30033:
+	case 30034:
+	case 30035:
+	case 30037:
+	case 30038:
+	case 30039:
+	case 30040:
+	case 30041:
+	case 30042:
+	case 30045:
+	case 30046:
+	case 30047:
+	case 30048:
+	case 30049:
+	case 30050:
+	case 30051:
+	case 30052:
+	case 30053:
+	case 30055:
+	case 30056:
+	case 30057:
+	case 30058:
+	case 30059:
+	case 30060:
+	case 30061:
+	case 30067:
+	case 30069:
+	case 30070:
+	case 30071:
+	case 30072:
+	case 30073:
+	case 30074:
+	case 30075:
+	case 30076:
+	case 30077:
+	case 30078:
+	case 30079:
+	case 30080:
+	case 30081:
+	case 30082:
+	case 30083:
+	case 30084:
+	case 30085:
+	case 30086:
+	case 30087:
+	case 30088:
+	case 30089:
+	case 30090:
+	case 30091:
+	case 30092:
+	case 30192:
+	case 30193:
+	case 30194:
+	case 30195:
+	case 30196:
+	case 30197:
+	case 30198:
+	case 30199:
+	case 30500:
+	case 30501:
+	case 30502:
+	case 30503:
+	case 30504:
+	case 30505:
+	case 30506:
+	case 30507:
+	case 30508:
+	case 30509:
+	case 30510:
+	case 30511:
+	case 30512:
+	case 30513:
+	case 30514:
+	case 30515:
+	case 30516:
+	case 30517:
+	case 30518:
+	case 30519:
+	case 30520:
+	case 30521:
+	case 30522:
+	case 30523:
+	case 30524:
+	case 30525:
+	case 30600:
+	case 30601:
+	case 30602:
+	case 30603:
+	case 30604:
+	case 30605:
+	case 30606:
+	case 30607:
+	case 30608:
+	case 30609:
+	case 30610:
+	case 30611:
+	case 30612:
+	case 30614:
+	case 30615:
+	case 30616:
+	case 30617:
+	case 30618:
+	case 30619:
+	case 27799:
+	case 27992:
+	case 27993:
+	case 27994:
+	case 27987:
+	case 33031:
+	case 33030:
+	case 33029:
+	case 30630:
+	case 30629:
+	case 30628:
+	case 30627:
+	case 30626:
+	case 30625:
+	case 30624:
+	case 30623:
+	case 70097:
+	case 70096:
+	case 70095:
+	case 70094:
+	case 70093:
+	case 70092:
+	case 70091:
+	case 70090:
+	case 70089:
+	case 70088:
+	case 70087:
+	case 70086:
+	case 85000:
+	case 70254:
+	case 70253:
+	case 70252:
+	case 70251:
+	case 51001:
+	case 50160:
+	case 50161:
+	case 50162:
+	case 50163:
+	case 50164:
+	case 50165:
+	case 50166:
+	case 50167:
+	case 50168:
+	case 50169:
+	case 50170:
+	case 50171:
+	case 50172:
+	case 50173:
+	case 50174:
+	case 50175:
+	case 50176:
+	case 50177:
+	case 50178:
+	case 50179:
+	case 30622:
+	case 30621:
+	case 30620:
+	case 30559:
+	case 30558:
+	case 30557:
+	case 30556:
+	case 30555:
+	case 30554:
+	case 30550:
+	case 30252:
+	case 30251:
+	case 30228:
+	case 30227:
+	case 30226:
+	case 30225:
+	case 30224:
+	case 30223:
+	case 30222:
+	case 30221:
+	case 30220:
+	case 30168:
+	case 30167:
+	case 30166:
+	case 30165:
+	case 27990:
+	case 71123:
+	case 71129:
+		return true;
 	}
 
-	return dwData;
-}
-#endif
-
-#ifdef __OFFLINE_SHOP__
-void CItem::CopySockets(std::array<int32_t, ITEM_SOCKET_MAX_NUM>& sockets)
-{
-	std::copy(std::begin(m_alSockets), std::end(m_alSockets), sockets.begin());
+	return false;
 }
 
-void CItem::CopyAttributes(std::array<TPlayerItemAttribute, ITEM_ATTRIBUTE_MAX_NUM>& attributes)
+bool CItem::IsStone()
 {
-	std::copy(std::begin(m_aAttr), std::end(m_aAttr), attributes.begin());
+	return GetType() == ITEM_METIN;
 }
 
-#if defined(__ITEM_APPLY_RANDOM__)
-void CItem::CopyApplyRandom(std::array<TPlayerItemAttribute, ITEM_APPLY_MAX_NUM>& ApplyRandom)
+bool CItem::IsGiftBox()
 {
-	std::copy(std::begin(m_aApplyRandom), std::end(m_aApplyRandom), ApplyRandom.begin());
-}
+#if defined(__GACHA_SYSTEM__)
+	return GetType() == ITEM_GIFTBOX || GetType() == ITEM_GACHA;
+#else
+	return GetType() == ITEM_GIFTBOX;
 #endif
+}
 #endif
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/item.h final/server/server/home/metin2/Source/Server/game/src/item.h
--- baseline/server/server/home/metin2/Source/Server/game/src/item.h	2026-02-18 18:19:52.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/item.h	2026-02-20 18:05:02.540676030 +0000
@@ -3,9 +3,6 @@
 
 #include "entity.h"
 #include "../common/VnumHelper.h"
-#if defined(__ITEM_APPLY_RANDOM__)
-#	include "item_apply_random_table.h"
-#endif
 
 class CItem : public CEntity
 {
@@ -15,15 +12,18 @@
 	virtual void EncodeRemovePacket(LPENTITY entity);
 
 public:
-	CItem(DWORD dwVnum = -1);
+	CItem(DWORD dwVnum);
 	virtual ~CItem();
 
 	int GetLevelLimit();
-	int GetDurationLimit();
 
 	bool CheckItemUseLevel(int nLevel);
-	POINT_VALUE FindApplyValue(POINT_TYPE wApplyType);
 
+	bool IsPCBangItem();
+
+	long FindApplyValue(BYTE bApplyType);
+
+	// bool IsStackable() { return (GetFlag() & ITEM_FLAG_STACKABLE) ? true : false; }
 	bool IsStackable();
 
 	void Initialize();
@@ -41,9 +41,9 @@
 	TItemTable const* GetProto() { return m_pProto; }
 
 	int GetGold();
-	int GetShopSellPrice();
 	int GetShopBuyPrice();
-	const char* GetName() { return m_pProto ? m_pProto->szLocaleName : NULL; }
+	const char* GetLocaleName();
+	const char* GetName(); /*{ return m_pProto ? m_pProto->szLocaleName : NULL; }*/
 	const char* GetBaseName() { return m_pProto ? m_pProto->szName : NULL; }
 	BYTE GetSize() { return m_pProto ? m_pProto->bSize : 0; }
 
@@ -74,6 +74,11 @@
 	BYTE GetLimitType(DWORD idx) const { return m_pProto ? m_pProto->aLimits[idx].bType : 0; }
 	long GetLimitValue(DWORD idx) const { return m_pProto ? m_pProto->aLimits[idx].lValue : 0; }
 
+#if defined(__CHANGE_LOOK_SYSTEM__)
+	DWORD GetTransmutation() const { return m_dwTransmutation; }
+	void SetTransmutation(DWORD dwVnum, bool bLog = false);
+#endif
+
 	bool IsSocketModifyingItem()
 	{
 		return GetType() == ITEM_USE && (GetSubType() == USE_PUT_INTO_BELT_SOCKET
@@ -112,7 +117,6 @@
 
 	// Armor
 	bool IsArmor() { return GetType() == ITEM_ARMOR; }
-	bool IsArmorType(BYTE bArmorType) { return GetType() == ITEM_ARMOR && GetSubType() == bArmorType; }
 	bool IsArmorBody() { return GetType() == ITEM_ARMOR && GetSubType() == ARMOR_BODY; }
 	bool IsHelmet() { return GetType() == ITEM_ARMOR && GetSubType() == ARMOR_HEAD; }
 	bool IsShield() { return GetType() == ITEM_ARMOR && GetSubType() == ARMOR_SHIELD; }
@@ -129,30 +133,43 @@
 	bool IsGlove() { return GetType() == ITEM_ARMOR && GetSubType() == ARMOR_GLOVE; }
 #endif
 	bool IsRing() { return GetType() == ITEM_RING; }
-	bool IsUnique() { return GetType() == ITEM_UNIQUE; }
 	bool IsCostume() { return GetType() == ITEM_COSTUME; }
 	bool IsCostumeHair() { return GetType() == ITEM_COSTUME && GetSubType() == COSTUME_HAIR; }
 	bool IsCostumeBody() { return GetType() == ITEM_COSTUME && GetSubType() == COSTUME_BODY; }
 #if defined(__MOUNT_COSTUME_SYSTEM__)
 	bool IsCostumeMount() { return GetType() == ITEM_COSTUME && GetSubType() == COSTUME_MOUNT; }
 #endif
-
+#ifdef __AURA_COSTUME_SYSTEM__
+	bool IsCostumeAura() { return GetType() == ITEM_COSTUME && GetSubType() == COSTUME_AURA; }
+#endif
+#if defined(__GROWTH_PET_SYSTEM__)
+	bool IsGrowthPet() { return GetType() == ITEM_PET && GetSubType() == PET_UPBRINGING; }
+#endif
 #if defined(__ACCE_COSTUME_SYSTEM__)
 	bool IsCostumeAcce() { return GetType() == ITEM_COSTUME && GetSubType() == COSTUME_ACCE; }
 	bool IsAcceReverseScroll() { return GetVnum() == 39046 || GetVnum() == 90000; }
 #endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-	bool IsCostumeAura() { return GetType() == ITEM_COSTUME && GetSubType() == COSTUME_AURA; }
-#endif
 #if defined(__WEAPON_COSTUME_SYSTEM__)
 	bool IsCostumeWeapon() { return GetType() == ITEM_COSTUME && GetSubType() == COSTUME_WEAPON; }
 #endif
-	bool IsPet() { return GetType() == ITEM_PET && (GetSubType() == PET_PAY || GetSubType() == PET_UPBRINGING); }
+#if defined(__COSTUME_ATTR_SYSTEM__)
+	bool IsCostumeModifyItem() { return GetType() == ITEM_USE && (GetSubType() == USE_CHANGE_COSTUME_ATTR || GetSubType() == USE_RESET_COSTUME_ATTR); }
+#endif
+	bool IsPet() { return GetType() == ITEM_PET && (GetSubType() == PET_PAY /*|| GetSubType() == PET_UPBRINGING*/); }
 #if defined(__EXPRESSING_EMOTIONS__)
 	bool IsEmotionPack() { return GetType() == ITEM_USE && GetSubType() == USE_EMOTION_PACK; }
 #endif
 	bool IsOldHair() { return GetVnum() >= 74001 && GetVnum() <= 75620; }
 
+#if defined(__EXTENDED_BLEND_AFFECT__)
+	bool IsBlendItem() { return GetType() == ITEM_BLEND; }
+	bool IsExtendedBlend(DWORD dwVnum) { return CItemVnumHelper::IsExtendedBlend(dwVnum); }
+#endif
+
+#if defined(__CHANGE_LOOK_SYSTEM__)
+	bool IsChangeLookReverseScroll() { return GetVnum() == 72325; }
+#endif
+
 	DWORD GetRealImmuneFlag();
 
 	long GetValue(DWORD idx);
@@ -161,13 +178,11 @@
 	WORD GetCell() { return m_wCell; }
 
 	LPITEM RemoveFromCharacter();
-
-	bool AddToCharacter(LPCHARACTER ch, const TItemPos& Cell
 #if defined(__WJ_PICKUP_ITEM_EFFECT__)
-		, bool isHighLight = true
+	bool AddToCharacter(LPCHARACTER ch, const TItemPos& Cell, bool isHighLight = true);
+#else
+	bool AddToCharacter(LPCHARACTER ch, TItemPos Cell);
 #endif
-	);
-
 	LPCHARACTER GetOwner() { return m_pOwner; }
 
 	LPITEM RemoveFromGround();
@@ -188,14 +203,7 @@
 	void SetExchanging(bool isOn = true);
 	bool IsExchanging() { return m_bExchanging; }
 
-#if defined(__MOVE_COSTUME_ATTR__)
-	bool CanChangeCostumeAttr() const;
-#endif
-
-#if defined(__LOOT_FILTER_SYSTEM__)
-	long GetWearingLevelLimit() const;
-	bool IsHairDye() const;
-#endif
+	bool IsTwohanded();
 
 	bool IsPolymorphItem();
 
@@ -203,7 +211,7 @@
 
 	bool CreateSocket(BYTE bSlot, BYTE bGold);
 	const long* GetSockets() { return &m_alSockets[0]; }
-	long GetSocket(int i) { return (i >= 0 && i < ITEM_SOCKET_MAX_NUM) ? m_alSockets[i] : 0; }
+	long GetSocket(int i) { return m_alSockets[i]; }
 
 	void SetSockets(const long* al);
 	void SetSocket(int i, long v, bool bLog = true);
@@ -212,35 +220,19 @@
 	bool AddSocket();
 
 	const TPlayerItemAttribute* GetAttributes() { return m_aAttr; }
-	const TPlayerItemAttribute& GetAttribute(BYTE bIndex) { return m_aAttr[bIndex]; }
-
-#if defined(__ITEM_APPLY_RANDOM__)
-	const TPlayerItemAttribute* GetRandomApplies() { return m_aApplyRandom; }
-	const TPlayerItemAttribute& GetRandomApply(BYTE bIndex) { return m_aApplyRandom[bIndex]; }
-
-	void GetRandomApplyTable(TPlayerItemAttribute* pApplyRandomTable, BYTE bGetType = CApplyRandomTable::GET_CURRENT);
-	void SetRandomApplies(const TPlayerItemAttribute* c_pApplyRandom);
-
-	POINT_TYPE GetRandomApplyType(BYTE bIndex) { return m_aApplyRandom[bIndex].wType; }
-	POINT_VALUE GetRandomApplyValue(BYTE bIndex) { return m_aApplyRandom[bIndex].lValue; }
-	BYTE GetRandomApplyPath(BYTE bIndex) { return m_aApplyRandom[bIndex].bPath; }
-#endif
+	const TPlayerItemAttribute& GetAttribute(int i) { return m_aAttr[i]; }
 
-#if defined(__GLOVE_SYSTEM__)
-	DWORD GetRandomSungMaSocketValue(BYTE bType, int iRefineLevel, bool bMultiplier);
-#endif
-
-	POINT_TYPE GetAttributeType(BYTE bIndex) { return m_aAttr[bIndex].wType; }
-	POINT_VALUE GetAttributeValue(BYTE bIndex) { return m_aAttr[bIndex].lValue; }
+	BYTE GetAttributeType(int i) { return m_aAttr[i].bType; }
+	short GetAttributeValue(int i) { return m_aAttr[i].sValue; }
 
 	void SetAttributes(const TPlayerItemAttribute* c_pAttribute);
 
-	int FindAttribute(POINT_TYPE wType);
+	int FindAttribute(BYTE bType);
 	bool RemoveAttributeAt(int index);
-	bool RemoveAttributeType(POINT_TYPE wType);
+	bool RemoveAttributeType(BYTE bType);
 
-	bool HasAttr(POINT_TYPE wApply);
-	bool HasRareAttr(POINT_TYPE wApply);
+	bool HasAttr(BYTE bApply);
+	bool HasRareAttr(BYTE bApply);
 
 	void SetDestroyEvent(LPEVENT pkEvent);
 	void StartDestroyEvent(int iSec = 300);
@@ -263,7 +255,6 @@
 	void AlterToSocketItem(int iSocketCount);
 
 	WORD GetRefineSet() { return m_pProto ? m_pProto->wRefineSet : 0; }
-	DWORD Get67AttrMaterial() { return m_pProto ? m_pProto->dw67AttrMaterial : 0; }
 
 	void StartUniqueExpireEvent();
 	void SetUniqueExpireEvent(LPEVENT pkEvent);
@@ -271,10 +262,19 @@
 	void StartTimerBasedOnWearExpireEvent();
 	void SetTimerBasedOnWearExpireEvent(LPEVENT pkEvent);
 
+#if defined(__SOUL_SYSTEM__)
+	void StartSoulTimeUseEvent();
+	void SetSoulKeepTime();
+#endif
+
+#if defined(__EXTENDED_BLEND_AFFECT__)
+	void StartBlendExpireEvent();
+	void StopBlendExpireEvent();
+#endif
+
 	void StartRealTimeExpireEvent();
-#if defined(__GROWTH_PET_SYSTEM__)
 	void StopRealTimeExpireEvent();
-#endif
+
 	bool IsRealTimeItem();
 	bool IsUsedTimeItem();
 
@@ -285,15 +285,11 @@
 	// ϴ REAL_TIME TIMER_BASED_ON_WEAR ۿ ؼ  .
 	int GetDuration();
 
-	BYTE GetAttributeCount();
+	int GetAttributeCount();
 	void ClearAttribute();
-	void ClearAllAttribute();
 	void ChangeAttribute(const int* aiChangeProb = NULL);
 	void AddAttribute();
-	void AddAttribute(POINT_TYPE dwType, POINT_VALUE llValue);
-#if defined(__CHANGED_ATTR__)
-	void GetSelectAttr(TPlayerItemAttribute(&arr)[ITEM_ATTRIBUTE_MAX_NUM]);
-#endif
+	void AddAttribute(BYTE bType, short sValue);
 
 	void ApplyAddon(int iAddonType);
 
@@ -303,7 +299,6 @@
 	// ACCESSORY_REFINE
 	// ׼    ߰
 	bool IsAccessoryForSocket();
-	bool IsRemovableSocket();
 
 	int GetAccessorySocketGrade();
 	int GetAccessorySocketMaxGrade();
@@ -323,12 +318,9 @@
 	// END_OF_ACCESSORY_REFINE
 
 	void CopyAttributeTo(LPITEM pItem);
-#if defined(__ITEM_APPLY_RANDOM__)
-	void CopyRandomAppliesTo(LPITEM pItem);
-#endif
 	void CopySocketTo(LPITEM pItem);
 
-	BYTE GetRareAttrCount();
+	int GetRareAttrCount();
 	bool AddRareAttribute();
 	bool ChangeRareAttribute();
 
@@ -337,68 +329,29 @@
 	void Lock(bool f) { m_isLocked = f; }
 	bool isLocked() const { return m_isLocked; }
 
-#if defined(__CHANGE_LOOK_SYSTEM__)
-	void SetTransmutationVnum(DWORD blVnum);
-	DWORD GetTransmutationVnum() const;
-#endif
-
-#if defined(__SET_ITEM__)
-	void SetItemSetValue(BYTE bSet);
-	BYTE GetItemSetValue() const;
-#endif
-
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-public:
-	void SetRefineElement(const TPlayerItemRefineElement* pTable);
-	void CopyElementTo(const LPITEM pItem);
-
-	void UpgradeRefineElement(WORD wApplyType, BYTE bValue, BYTE bBonus);
-	void DowngradeRefineElement();
-	void ChangeRefineElement(WORD wApplyType);
-
-	BYTE GetRefineElementGrade() const { return m_RefineElement.bGrade; }
-	WORD GetRefineElementApplyType() const { return m_RefineElement.wApplyType; }
-	BYTE GetRefineElementValue() const;
-	BYTE GetRefineElementBonusValue() const;
-
-	BYTE GetRefineElementValue(BYTE bGrade) const { return m_RefineElement.abValue[bGrade]; }
-	BYTE GetRefineElementBonusValue(BYTE bGrade) const { return m_RefineElement.abBonusValue[bGrade]; }
-
-	const TPlayerItemRefineElement* GetRefineElement() const { return &m_RefineElement; }
-private:
-	TPlayerItemRefineElement m_RefineElement;
-#endif
-
 private:
-	void SetAttribute(BYTE bIndex, POINT_TYPE wType, POINT_VALUE lValue);
-#if defined(__ITEM_APPLY_RANDOM__)
-	void SetRandomApply(BYTE bIndex, POINT_TYPE wType, POINT_VALUE lValue, BYTE bPath);
-#endif
+	void SetAttribute(int i, BYTE bType, short sValue);
 public:
-	void SetForceAttribute(BYTE bIndex, POINT_TYPE wType, POINT_VALUE lValue);
-#if defined(__ITEM_APPLY_RANDOM__)
-	void SetForceRandomApply(BYTE bIndex, POINT_TYPE wType, POINT_VALUE lValue, BYTE bPath);
-#endif
+	void SetForceAttribute(int i, BYTE bType, short sValue);
 
 protected:
 	bool EquipEx(bool is_equip);
 	bool Unequip();
 
-	void AddAttr(POINT_TYPE wApply, BYTE bLevel);
+	void AddAttr(BYTE bApply, BYTE bLevel);
 	void PutAttribute(const int* aiAttrPercentTable);
 	void PutAttributeWithLevel(BYTE bLevel);
 
-public:
+protected:
 	friend class CInputDB;
 	bool OnAfterCreatedItem(); //     Բ  (ε)  Ҹ Լ.
 
 public:
 	bool IsRideItem();
+	bool IsRamadanRing();
 
 	void ClearMountAttributeAndAffect();
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-	DWORD GetMountVnum();
-#endif
+	bool IsNewMountItem();
 
 	// Ͽ  ĳ ۰ , ȯ  ĳ  ٰ Ͽ,
 	//  ۿ, ȯ  ÷׸  ο ۵ ο  뿪 ҴϿ.
@@ -413,24 +366,28 @@
 	DWORD GetMaskVnum() { return m_dwMaskVnum; }
 	bool IsMaskedItem() { return m_dwMaskVnum != 0; }
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
 	// ȥ
 	bool IsDragonSoul();
+#if defined(__SPECIAL_INVENTORY_SYSTEM__)
+	bool IsSkillBook();
+	bool IsUpgradeItem();
+	bool IsStone();
+	bool IsGiftBox();
+#endif
 
 	int GiveMoreTime_Per(float fPercent);
 	int GiveMoreTime_Fix(DWORD dwTime);
+#if defined(__EXTENDED_DSS_RECHARGE__)
+	int GiveMoreTime_Extend(DWORD dwTime);
+#endif
+#if defined(__EXTENDED_COSTUME_RECHARGE__)
+	bool GiveInfiniteTime();
 #endif
 
 private:
 	TItemTable const* m_pProto; //  Ÿ
 
 	DWORD m_dwVnum;
-#if defined(__CHANGE_LOOK_SYSTEM__)
-	DWORD m_dwTransmutationVnum;
-#endif
-#if defined(__SET_ITEM__)
-	BYTE m_bSetValue;
-#endif
 	LPCHARACTER m_pOwner;
 
 	BYTE m_bWindow; //   ġ  
@@ -441,13 +398,13 @@
 	DWORD m_dwCount; // 
 	long m_lFlag; // ߰ flag
 	DWORD m_dwLastOwnerPID; //   ־  PID
+#if defined(__CHANGE_LOOK_SYSTEM__)
+	DWORD m_dwTransmutation;
+#endif
 
 	bool m_bExchanging; ///<  ȯ 
 
 	long m_alSockets[ITEM_SOCKET_MAX_NUM]; //  Ĺ
-#if defined(__ITEM_APPLY_RANDOM__)
-	TPlayerItemAttribute m_aApplyRandom[ITEM_APPLY_MAX_NUM];
-#endif
 	TPlayerItemAttribute m_aAttr[ITEM_ATTRIBUTE_MAX_NUM];
 
 	LPEVENT m_pkDestroyEvent;
@@ -456,6 +413,12 @@
 	LPEVENT m_pkTimerBasedOnWearExpireEvent;
 	LPEVENT m_pkRealTimeExpireEvent;
 	LPEVENT m_pkAccessorySocketExpireEvent;
+#if defined(__SOUL_SYSTEM__)
+	LPEVENT m_pkSoulTimeUseEvent;
+#endif
+#if defined(__EXTENDED_BLEND_AFFECT__)
+	LPEVENT m_pkBlendUseEvent;
+#endif
 	LPEVENT m_pkOwnershipEvent;
 
 	DWORD m_dwOwnershipPID;
@@ -469,26 +432,14 @@
 
 #if defined(__SOUL_BIND_SYSTEM__)
 public:
-	bool CanSealItem() const;
-
-	void SealItem(long lSealDate = U_SEAL_DATE_DEFAULT_TIMESTAMP);
-	bool IsSealed() const { return m_lSealDate != E_SEAL_DATE_DEFAULT_TIMESTAMP; }
-	long GetSealDate() const { return m_lSealDate; }
-
-	void StartSealDateExpireTimerEvent();
-	void StopSealDateExpireTimerEvent();
+	long GetSealedTime() const { return m_lSoulbind; }
+	void SetSoulBind(long sb = -1);
+	bool IsSealed() const { return m_lSoulbind != 0; }
+	void StartUnbindTimerExpireEvent();
 
 private:
-	long m_lSealDate;
-	LPEVENT m_pkSealDateExpireEvent;
-#endif
-
-#if defined(__SOUL_SYSTEM__)
-public:
-	void StartSoulTimerUseEvent();
-	void ResetSoulTimerUseEvent();
-private:
-	LPEVENT m_pkSoulTimerUseEvent;
+	long m_lSoulbind;
+	LPEVENT m_pkUnbindTimerExpireEvent;
 #endif
 
 public:
@@ -500,13 +451,16 @@
 	{
 		return m_dwSIGVnum;
 	}
-#ifdef __OFFLINE_SHOP__
+#ifdef __AURA_SYSTEM__
+private:
+	LPEVENT m_pkAuraBoostSocketExpireEvent;
+
 public:
-	void CopySockets(std::array<int32_t, ITEM_SOCKET_MAX_NUM>& sockets);
-	void CopyAttributes(std::array<TPlayerItemAttribute, ITEM_ATTRIBUTE_MAX_NUM>& attributes);
-#if defined(__ITEM_APPLY_RANDOM__)
-	void CopyApplyRandom(std::array<TPlayerItemAttribute, ITEM_APPLY_MAX_NUM>& ApplyRandom);
-#endif
+	bool	IsAuraBoosterForSocket();
+
+	void	StartAuraBoosterSocketExpireEvent();
+	void	StopAuraBoosterSocketExpireEvent();
+	void	SetAuraBoosterSocketExpireEvent(LPEVENT pkEvent);
 #endif
 };
 
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/item_attribute.cpp final/server/server/home/metin2/Source/Server/game/src/item_attribute.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/item_attribute.cpp	2024-12-28 03:09:36.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/item_attribute.cpp	2022-04-27 12:41:43.000000000 +0000
@@ -25,73 +25,73 @@
 		return ATTRIBUTE_SET_WEAPON;
 	}
 
+#if !defined(__COSTUME_SYSTEM__)
+	if (GetType() == ITEM_ARMOR || GetType() == ITEM_COSTUME)
+#else
 	if (GetType() == ITEM_ARMOR)
+#endif
 	{
 		switch (GetSubType())
 		{
-			case ARMOR_BODY:
-				//case COSTUME_BODY: // ڽ  Ϲ ʰ  Attribute Set ̿Ͽ Ӽ  (ARMOR_BODY == COSTUME_BODY)
-				return ATTRIBUTE_SET_BODY;
+		case ARMOR_BODY:
+		// case COSTUME_BODY: // ڽ  Ϲ ʰ  Attribute Set ̿Ͽ Ӽ  (ARMOR_BODY == COSTUME_BODY)
+			return ATTRIBUTE_SET_BODY;
 
-			case ARMOR_WRIST:
-				return ATTRIBUTE_SET_WRIST;
+		case ARMOR_WRIST:
+			return ATTRIBUTE_SET_WRIST;
 
-			case ARMOR_FOOTS:
-				return ATTRIBUTE_SET_FOOTS;
+		case ARMOR_FOOTS:
+			return ATTRIBUTE_SET_FOOTS;
 
-			case ARMOR_NECK:
-				return ATTRIBUTE_SET_NECK;
+		case ARMOR_NECK:
+			return ATTRIBUTE_SET_NECK;
 
-			case ARMOR_HEAD:
-				// case COSTUME_HAIR: // ڽ  Ϲ  ۰  Attribute Set ̿Ͽ Ӽ  (ARMOR_HEAD == COSTUME_HAIR)
-				return ATTRIBUTE_SET_HEAD;
+		case ARMOR_HEAD:
+		// case COSTUME_HAIR: // ڽ  Ϲ  ۰  Attribute Set ̿Ͽ Ӽ  (ARMOR_HEAD == COSTUME_HAIR)
+			return ATTRIBUTE_SET_HEAD;
 
-			case ARMOR_SHIELD:
-				return ATTRIBUTE_SET_SHIELD;
+		case ARMOR_SHIELD:
+			return ATTRIBUTE_SET_SHIELD;
 
-			case ARMOR_EAR:
-				return ATTRIBUTE_SET_EAR;
+		case ARMOR_EAR:
+			return ATTRIBUTE_SET_EAR;
 
 #if defined(__PENDANT_SYSTEM__)
-			case ARMOR_PENDANT:
-				return ATTRIBUTE_SET_PENDANT;
+		case ARMOR_PENDANT:
+			return ATTRIBUTE_SET_PENDANT;
 #endif
 
 #if defined(__GLOVE_SYSTEM__)
-			case ARMOR_GLOVE:
-				return ATTRIBUTE_SET_GLOVE;
+		case ARMOR_GLOVE:
+			return ATTRIBUTE_SET_GLOVE;
 #endif
 		}
 	}
+
 #if defined(__COSTUME_SYSTEM__)
-	else if (GetType() == ITEM_COSTUME)
+	if (GetType() == ITEM_COSTUME)
 	{
 		switch (GetSubType())
 		{
-			case COSTUME_BODY:
-				return ATTRIBUTE_SET_COSTUME_BODY;
+		case COSTUME_BODY:
+			return ATTRIBUTE_SET_COSTUME_BODY;
 
-			case COSTUME_HAIR:
-				return ATTRIBUTE_SET_COSTUME_HAIR;
+		case COSTUME_HAIR:
+			return ATTRIBUTE_SET_COSTUME_HAIR;
 
 #if defined(__MOUNT_COSTUME_SYSTEM__)
-			case COSTUME_MOUNT:
-				break;
+		case COSTUME_MOUNT:
+			break;
 #endif
 
 #if defined(__ACCE_COSTUME_SYSTEM__)
-			case COSTUME_ACCE:
-				break;
+		case COSTUME_ACCE:
+			break;
 #endif
 
 #if defined(__WEAPON_COSTUME_SYSTEM__)
-			case COSTUME_WEAPON:
-				return ATTRIBUTE_SET_COSTUME_WEAPON;
-#endif
-
-#if defined(__AURA_COSTUME_SYSTEM__)
-			case COSTUME_AURA:
-				break;
+		case COSTUME_WEAPON:
+			return ATTRIBUTE_SET_COSTUME_WEAPON;
 #endif
 		}
 	}
@@ -100,46 +100,47 @@
 	return -1;
 }
 
-bool CItem::HasAttr(POINT_TYPE wApply)
+bool CItem::HasAttr(BYTE bApply)
 {
 	for (int i = 0; i < ITEM_APPLY_MAX_NUM; ++i)
-		if (m_pProto->aApplies[i].wType == wApply)
+		if (m_pProto->aApplies[i].bType == bApply)
 			return true;
 
 	for (int i = 0; i < MAX_NORM_ATTR_NUM; ++i)
-		if (GetAttributeType(i) == wApply)
+		if (GetAttributeType(i) == bApply)
 			return true;
 
 	return false;
 }
 
-bool CItem::HasRareAttr(POINT_TYPE wType)
+bool CItem::HasRareAttr(BYTE bApply)
 {
 	for (int i = 0; i < MAX_RARE_ATTR_NUM; ++i)
-		if (GetAttributeType(i + MAX_NORM_ATTR_NUM) == wType)
+		if (GetAttributeType(i + 5) == bApply)
 			return true;
 
 	return false;
 }
 
-void CItem::AddAttribute(POINT_TYPE dwType, POINT_VALUE llValue)
+void CItem::AddAttribute(BYTE bApply, short sValue)
 {
-	if (HasAttr(dwType))
+	if (HasAttr(bApply))
 		return;
 
-	BYTE bIndex = GetAttributeCount();
-	if (bIndex >= MAX_NORM_ATTR_NUM)
+	int i = GetAttributeCount();
+
+	if (i >= MAX_NORM_ATTR_NUM)
 		sys_err("item attribute overflow!");
 	else
 	{
-		if (llValue)
-			SetAttribute(bIndex, dwType, llValue);
+		if (sValue)
+			SetAttribute(i, bApply, sValue);
 	}
 }
 
-void CItem::AddAttr(POINT_TYPE wApply, BYTE bLevel)
+void CItem::AddAttr(BYTE bApply, BYTE bLevel)
 {
-	if (HasAttr(wApply))
+	if (HasAttr(bApply))
 		return;
 
 	if (bLevel <= 0)
@@ -151,17 +152,18 @@
 		sys_err("item attribute overflow!");
 	else
 	{
-		const TItemAttrTable& r = g_map_itemAttr[wApply];
+		const TItemAttrTable& r = g_map_itemAttr[bApply];
 		long lVal = r.lValues[MIN(4, bLevel - 1)];
 
 		if (lVal)
-			SetAttribute(i, wApply, lVal);
+			SetAttribute(i, bApply, lVal);
 	}
 }
 
 void CItem::PutAttributeWithLevel(BYTE bLevel)
 {
-	const int iAttributeSet = GetAttributeSetIndex();
+	int iAttributeSet = GetAttributeSetIndex();
+
 	if (iAttributeSet < 0)
 		return;
 
@@ -234,7 +236,7 @@
 
 void CItem::ChangeAttribute(const int* aiChangeProb)
 {
-	const int iAttributeCount = GetAttributeCount();
+	int iAttributeCount = GetAttributeCount();
 
 	ClearAttribute();
 
@@ -281,36 +283,29 @@
 {
 	for (int i = 0; i < MAX_NORM_ATTR_NUM; ++i)
 	{
-		m_aAttr[i].wType = 0;
-		m_aAttr[i].lValue = 0;
+		m_aAttr[i].bType = 0;
+		m_aAttr[i].sValue = 0;
 	}
 }
 
-void CItem::ClearAllAttribute()
+int CItem::GetAttributeCount()
 {
-	for (int i = 0; i < ITEM_ATTRIBUTE_MAX_NUM; ++i)
-	{
-		m_aAttr[i].wType = 0;
-		m_aAttr[i].lValue = 0;
-	}
-}
+	int i;
 
-BYTE CItem::GetAttributeCount()
-{
-	BYTE bIndex = 0;
-	for (; bIndex < MAX_NORM_ATTR_NUM; ++bIndex)
+	for (i = 0; i < MAX_NORM_ATTR_NUM; ++i)
 	{
-		if (GetAttributeType(bIndex) == 0)
+		if (GetAttributeType(i) == 0)
 			break;
 	}
-	return bIndex;
+
+	return i;
 }
 
-int CItem::FindAttribute(POINT_TYPE wType)
+int CItem::FindAttribute(BYTE bType)
 {
 	for (int i = 0; i < MAX_NORM_ATTR_NUM; ++i)
 	{
-		if (GetAttributeType(i) == wType)
+		if (GetAttributeType(i) == bType)
 			return i;
 	}
 
@@ -331,9 +326,9 @@
 	return true;
 }
 
-bool CItem::RemoveAttributeType(POINT_TYPE wType)
+bool CItem::RemoveAttributeType(BYTE bType)
 {
-	int index = FindAttribute(wType);
+	int index = FindAttribute(bType);
 	return index != -1 && RemoveAttributeType(index);
 }
 
@@ -343,24 +338,22 @@
 	Save();
 }
 
-void CItem::SetAttribute(BYTE bIndex, POINT_TYPE wType, POINT_VALUE lValue)
+void CItem::SetAttribute(int i, BYTE bType, short sValue)
 {
-	assert(bIndex < MAX_NORM_ATTR_NUM);
-
-	m_aAttr[bIndex].wType = wType;
-	m_aAttr[bIndex].lValue = lValue;
+	assert(i < MAX_NORM_ATTR_NUM);
 
+	m_aAttr[i].bType = bType;
+	m_aAttr[i].sValue = sValue;
 	UpdatePacket();
 	Save();
 }
 
-void CItem::SetForceAttribute(BYTE bIndex, POINT_TYPE wType, POINT_VALUE lValue)
+void CItem::SetForceAttribute(int i, BYTE bType, short sValue)
 {
-	assert(bIndex < ITEM_ATTRIBUTE_MAX_NUM);
-
-	m_aAttr[bIndex].wType = wType;
-	m_aAttr[bIndex].lValue = lValue;
+	assert(i < ITEM_ATTRIBUTE_MAX_NUM);
 
+	m_aAttr[i].bType = bType;
+	m_aAttr[i].sValue = sValue;
 	UpdatePacket();
 	Save();
 }
@@ -370,20 +363,17 @@
 	pItem->SetAttributes(m_aAttr);
 }
 
-#if defined(__ITEM_APPLY_RANDOM__)
-void CItem::CopyRandomAppliesTo(LPITEM pItem)
+int CItem::GetRareAttrCount()
 {
-	pItem->SetRandomApplies(m_aApplyRandom);
-}
-#endif
+	int ret = 0;
 
-BYTE CItem::GetRareAttrCount()
-{
-	BYTE bCount = 0;
-	for (BYTE bIndex = ITEM_ATTRIBUTE_RARE_START; bIndex < ITEM_ATTRIBUTE_RARE_END; bIndex++)
-		if (m_aAttr[bIndex].wType != 0)
-			bCount++;
-	return bCount;
+	if (m_aAttr[5].bType != 0)
+		ret++;
+
+	if (m_aAttr[6].bType != 0)
+		ret++;
+
+	return ret;
 }
 
 bool CItem::ChangeRareAttribute()
@@ -391,12 +381,12 @@
 	if (GetRareAttrCount() == 0)
 		return false;
 
-	const int cnt = GetRareAttrCount();
+	int cnt = GetRareAttrCount();
 
 	for (int i = 0; i < cnt; ++i)
 	{
-		m_aAttr[i + ITEM_ATTRIBUTE_RARE_START].wType = 0;
-		m_aAttr[i + ITEM_ATTRIBUTE_RARE_START].lValue = 0;
+		m_aAttr[i + 5].bType = 0;
+		m_aAttr[i + 5].sValue = 0;
 	}
 
 	if (g_bAttrLog)
@@ -416,191 +406,69 @@
 bool CItem::AddRareAttribute()
 {
 	int count = GetRareAttrCount();
-	if (count >= ITEM_ATTRIBUTE_RARE_NUM)
+
+	if (count >= 2)
 		return false;
 
-	int pos = count + ITEM_ATTRIBUTE_RARE_START;
+	int pos = count + 5;
 	TPlayerItemAttribute& attr = m_aAttr[pos];
 
-	const int nAttrSet = GetAttributeSetIndex();
+	int nAttrSet = GetAttributeSetIndex();
 	std::vector<int> avail;
 
 	for (int i = 0; i < MAX_APPLY_NUM; ++i)
 	{
 		const TItemAttrTable& r = g_map_itemRare[i];
 
-		if (r.wApplyIndex != 0 && r.bMaxLevelBySet[nAttrSet] > 0 && HasRareAttr(i) != true)
+		if (r.dwApplyIndex != 0 && r.bMaxLevelBySet[nAttrSet] > 0 && HasRareAttr(i) != true)
 		{
-			avail.emplace_back(i);
+			avail.push_back(i);
 		}
 	}
 
-	if (avail.empty())
-	{
-		sys_err("Couldn't add a rare bonus - item_attr_rare has incorrect values!");
-		return false;
-	}
-
 	const TItemAttrTable& r = g_map_itemRare[avail[number(0, avail.size() - 1)]];
-	int nAttrLevel = number(1, ITEM_ATTRIBUTE_MAX_LEVEL);
+	int nAttrLevel = 5;
 
 	if (nAttrLevel > r.bMaxLevelBySet[nAttrSet])
 		nAttrLevel = r.bMaxLevelBySet[nAttrSet];
 
-	attr.wType = r.wApplyIndex;
-	attr.lValue = r.lValues[nAttrLevel - 1];
+	attr.bType = r.dwApplyIndex;
+	attr.sValue = r.lValues[nAttrLevel - 1];
 
 	UpdatePacket();
 
 	Save();
 
-	const char* pszIP = nullptr;
+	const char* pszIP = NULL;
 
 	if (GetOwner() && GetOwner()->GetDesc())
 		pszIP = GetOwner()->GetDesc()->GetHostName();
 
-	LogManager::instance().ItemLog(pos, attr.wType, attr.lValue, GetID(), "SET_RARE", "", pszIP ? pszIP : "", GetOriginalVnum());
-	return true;
-}
-
-#if defined(__CHANGED_ATTR__)
-#include "utils.h"
-void CItem::GetSelectAttr(TPlayerItemAttribute(&arr)[ITEM_ATTRIBUTE_MAX_NUM])
-{
-	auto __GetAttributeCount = [&arr]() -> BYTE
-	{
-		auto c = std::count_if(std::begin(arr), std::end(arr),
-			[](const TPlayerItemAttribute& _attr) { return _attr.wType != 0 && _attr.lValue != 0; });
-
-		return static_cast<BYTE>(c);
-	};
-
-	auto __HasAttr = [this, &arr](const DWORD dwApply) -> bool
-	{
-		if (m_pProto)
-		{
-			for (BYTE bIndex = 0; bIndex < ITEM_APPLY_MAX_NUM; ++bIndex)
-				if (m_pProto->aApplies[bIndex].wType == dwApply)
-					return true;
-		}
-
-		for (BYTE bIndex = 0; bIndex < MAX_NORM_ATTR_NUM; ++bIndex)
-			if (arr[bIndex].wType == dwApply)
-				return true;
-
-		return false;
-	};
-
-	auto __PutAttributeWithLevel = [this, &__HasAttr, &__GetAttributeCount, &arr](BYTE bLevel) -> void
-	{
-		const int iAttributeSet = GetAttributeSetIndex();
-
-		if (iAttributeSet < 0)
-			return;
-
-		if (bLevel > ITEM_ATTRIBUTE_MAX_LEVEL)
-			return;
-
-		std::vector<WORD> avail;
-
-		int total = 0;
-
-		for (WORD i = 0; i < MAX_APPLY_NUM; ++i)
-		{
-			const TItemAttrTable& r = g_map_itemAttr[i];
-
-			if (r.bMaxLevelBySet[iAttributeSet] && !__HasAttr(i))
-			{
-				avail.emplace_back(i);
-				total += r.dwProb;
-			}
-		}
-
-		unsigned int prob = number(1, total);
-		WORD attr_idx = APPLY_NONE;
-
-		for (size_t i = 0; i < avail.size(); ++i)
-		{
-			const TItemAttrTable& r = g_map_itemAttr[avail[i]];
-
-			if (prob <= r.dwProb)
-			{
-				attr_idx = avail[i];
-				break;
-			}
-
-			prob -= r.dwProb;
-		}
-
-		if (!attr_idx)
-		{
-			sys_err("Cannot put item attribute %d %d", iAttributeSet, bLevel);
-			return;
-		}
-
-		const TItemAttrTable& r = g_map_itemAttr[attr_idx];
-		if (bLevel > r.bMaxLevelBySet[iAttributeSet])
-			bLevel = r.bMaxLevelBySet[iAttributeSet];
-
-		const long lVal = r.lValues[MIN(4, bLevel - 1)];
-		arr[__GetAttributeCount()] = { attr_idx, lVal, 0 };
-	};
-
-	if (m_pProto && m_pProto->sAddonType)
-	{
-		long iSkillBonus = MINMAX(-30, static_cast<int>(gauss_random(0, 5) + 0.5f), 30);
-		long iNormalHitBonus = 0;
-		if (abs(iSkillBonus) <= 20)
-			iNormalHitBonus = -2 * iSkillBonus + abs(number(-8, 8) + number(-8, 8)) + number(1, 4);
-		else
-			iNormalHitBonus = -2 * iSkillBonus + number(1, 5);
-
-		arr[__GetAttributeCount()] = { APPLY_NORMAL_HIT_DAMAGE_BONUS, iNormalHitBonus, 0 };
-		arr[__GetAttributeCount()] = { APPLY_SKILL_DAMAGE_BONUS, iSkillBonus, 0 };
-	}
-
-	static constexpr BYTE aiAttrPercentTable[MAX_NORM_ATTR_NUM] = { 0, 10, 40, 35, 15 };
-	for (BYTE c = __GetAttributeCount(); c < GetAttributeCount(); c++)
-	{
-		int iAttrLevelPercent = number(1, 100);
-		BYTE i;
-
-		for (i = 0; i < MAX_NORM_ATTR_NUM; ++i)
-		{
-			if (iAttrLevelPercent <= aiAttrPercentTable[i])
-				break;
-
-			iAttrLevelPercent -= aiAttrPercentTable[i];
-		}
-
-		__PutAttributeWithLevel(i + 1);
-	}
+	if (g_bAttrLog)
+		LogManager::instance().ItemLog(pos, attr.bType, attr.sValue, GetID(), "SET_RARE", "", pszIP ? pszIP : "", GetOriginalVnum());
 
-	std::copy(std::begin(m_aAttr) + MAX_NORM_ATTR_NUM, std::end(m_aAttr), std::begin(arr) + MAX_NORM_ATTR_NUM);
+	return true;
 }
-#endif
 
 #if defined(__ITEM_APPLY_RANDOM__)
-void CItem::SetRandomApply(BYTE bIndex, POINT_TYPE wType, POINT_VALUE lValue, BYTE bPath)
+void CItem::SetRandomApply(uint8_t slot, uint8_t type, int32_t value, uint8_t path)
 {
-	assert(bIndex < ITEM_APPLY_MAX_NUM);
-
-	m_aApplyRandom[bIndex].wType = wType;
-	m_aApplyRandom[bIndex].lValue = lValue;
-	m_aApplyRandom[bIndex].bPath = bPath;
+	assert(slot < ITEM_APPLY_MAX_NUM);
 
+	m_aApplyRandom[slot].bType = type;
+	m_aApplyRandom[slot].sValue = value;
+	m_aApplyRandom[slot].bPath = path;
 	UpdatePacket();
 	Save();
 }
 
-void CItem::SetForceRandomApply(BYTE bIndex, POINT_TYPE wType, POINT_VALUE lValue, BYTE bPath)
+void CItem::SetForceRandomApply(uint8_t slot, uint8_t type, int32_t value, uint8_t path)
 {
-	assert(bIndex < ITEM_APPLY_MAX_NUM);
-
-	m_aApplyRandom[bIndex].wType = wType;
-	m_aApplyRandom[bIndex].lValue = lValue;
-	m_aApplyRandom[bIndex].bPath = bPath;
+	assert(slot < ITEM_APPLY_MAX_NUM);
 
+	m_aApplyRandom[slot].bType = type;
+	m_aApplyRandom[slot].sValue = value;
+	m_aApplyRandom[slot].bPath = path;
 	UpdatePacket();
 	Save();
 }
@@ -611,47 +479,30 @@
 	Save();
 }
 
-void CItem::GetRandomApplyTable(TPlayerItemAttribute* pApplyRandomTable, BYTE bGetType)
+TPlayerItemAttribute* CItem::GetNextRandomApplies()
 {
 	int iRefineLevel = GetRefineLevel();
 	const TItemTable* c_pItemProto = GetProto();
 	if (c_pItemProto == nullptr)
-		return;
-
-	switch (bGetType)
-	{
-		case CApplyRandomTable::GET_PREVIOUS:
-			--iRefineLevel;
-			break;
-
-		case CApplyRandomTable::GET_NEXT:
-			++iRefineLevel;
-			break;
-
-		case CApplyRandomTable::GET_CURRENT:
-		default:
-			break;
-	}
+		return nullptr;
 
 	if (iRefineLevel > ITEM_REFINE_MAX_LEVEL)
 		iRefineLevel = ITEM_REFINE_MAX_LEVEL;
+	else
+		++iRefineLevel;
 
-	if (iRefineLevel < 0)
-		iRefineLevel = 0;
-
-	memset(pApplyRandomTable, 0, sizeof(TPlayerItemAttribute) * ITEM_APPLY_MAX_NUM);
-
-	for (BYTE bApplyIndex = 0; bApplyIndex < ITEM_APPLY_MAX_NUM; ++bApplyIndex)
+	TPlayerItemAttribute* ApplyRandomTable = m_aApplyRandom;
+	for (uint8_t uiApplySlot = 0; uiApplySlot < ITEM_APPLY_MAX_NUM; ++uiApplySlot)
 	{
-		POINT_TYPE wApplyRandomType = c_pItemProto->aApplies[bApplyIndex].wType;
-		POINT_VALUE lApplyRandomValue = c_pItemProto->aApplies[bApplyIndex].lValue;
-
-		if (wApplyRandomType == APPLY_RANDOM)
+		auto ApplyRandomType = c_pItemProto->aApplies[uiApplySlot].bType;
+		auto ApplyRandomValue = c_pItemProto->aApplies[uiApplySlot].lValue;
+		if (ApplyRandomType == APPLY_RANDOM)
 		{
-			pApplyRandomTable[bApplyIndex].wType = m_aApplyRandom[bApplyIndex].wType;
-			pApplyRandomTable[bApplyIndex].lValue = ITEM_MANAGER::instance().GetApplyRandomValue(lApplyRandomValue, iRefineLevel, m_aApplyRandom[bApplyIndex].bPath, m_aApplyRandom[bApplyIndex].wType);
-			pApplyRandomTable[bApplyIndex].bPath = m_aApplyRandom[bApplyIndex].bPath;
+			ApplyRandomTable[uiApplySlot].bType = m_aApplyRandom[uiApplySlot].bType;
+			ApplyRandomTable[uiApplySlot].sValue = ITEM_MANAGER::instance().GetNextApplyRandomValue(ApplyRandomValue, iRefineLevel, m_aApplyRandom[uiApplySlot].bPath, m_aApplyRandom[uiApplySlot].bType);
+			ApplyRandomTable[uiApplySlot].bPath = m_aApplyRandom[uiApplySlot].bPath;
 		}
 	}
+	return ApplyRandomTable;
 }
 #endif
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/item_manager.cpp final/server/server/home/metin2/Source/Server/game/src/item_manager.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/item_manager.cpp	2025-06-27 01:16:04.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/item_manager.cpp	2022-04-27 12:42:10.000000000 +0000
@@ -11,7 +11,6 @@
 #include "priv_manager.h"
 #include "questmanager.h"
 #include "unique_item.h"
-#include "unique_mob.h"
 #include "safebox.h"
 #include "blend_item.h"
 #include "dev_log.h"
@@ -22,9 +21,6 @@
 #include "../../common/VnumHelper.h"
 #include "DragonSoul.h"
 #include "cube.h"
-#if defined(__SNOWFLAKE_STICK_EVENT__)
-#	include "xmas_event.h"
-#endif
 
 ITEM_MANAGER::ITEM_MANAGER()
 	: m_iTopOfTable(0), m_dwVIDCount(0), m_dwCurrentID(0)
@@ -34,9 +30,6 @@
 {
 	m_ItemIDRange.dwMin = m_ItemIDRange.dwMax = m_ItemIDRange.dwUsableItemIDMin = 0;
 	m_ItemIDSpareRange.dwMin = m_ItemIDSpareRange.dwMax = m_ItemIDSpareRange.dwUsableItemIDMin = 0;
-#if defined(__LUCKY_BOX__)
-	m_pLuckyBox = nullptr;
-#endif
 #if defined(__ITEM_APPLY_RANDOM__)
 	m_pApplyRandomTable = nullptr;
 #endif
@@ -49,21 +42,17 @@
 
 void ITEM_MANAGER::Destroy()
 {
-	ITEM_VID_MAP::iterator it = m_VIDMap.begin();
+	itertype(m_VIDMap) it = m_VIDMap.begin();
 	for (; it != m_VIDMap.end(); ++it)
 	{
+#ifdef M2_USE_POOL
+		pool_.Destroy(it->second);
+#else
 		M2_DELETE(it->second);
+#endif
 	}
 	m_VIDMap.clear();
 
-#if defined(__LUCKY_BOX__)
-	if (m_pLuckyBox)
-	{
-		delete m_pLuckyBox;
-		m_pLuckyBox = nullptr;
-	}
-#endif
-
 #if defined(__ITEM_APPLY_RANDOM__)
 	if (m_pApplyRandomTable)
 	{
@@ -71,27 +60,12 @@
 		m_pApplyRandomTable = nullptr;
 	}
 #endif
-
-#if defined(__GEM_SYSTEM__) && defined(__GEM_SHOP__)
-	if (!m_map_pGemShopItemGroup.empty())
-	{
-		GemShopItemGroupMap::iterator it = m_map_pGemShopItemGroup.begin();
-		for (; it != m_map_pGemShopItemGroup.end(); ++it)
-			M2_DELETE(it->second);
-		m_map_pGemShopItemGroup.clear();
-	}
-	m_mapGemShopAddSlotItemGroup.clear();
-#endif
-
-#if defined(__SET_ITEM__)
-	m_ItemSetValueMap.clear();
-	m_ItemSetItemMap.clear();
-#endif
 }
 
 void ITEM_MANAGER::GracefulShutdown()
 {
-	std::unordered_set<LPITEM>::iterator it = m_set_pkItemForDelayedSave.begin();
+	TR1_NS::unordered_set<LPITEM>::iterator it = m_set_pkItemForDelayedSave.begin();
+
 	while (it != m_set_pkItemForDelayedSave.end())
 		SaveSingleItem(*(it++));
 
@@ -125,15 +99,14 @@
 		if (m_vec_prototype[i].bType == ITEM_QUEST || IS_SET(m_vec_prototype[i].dwFlags, ITEM_FLAG_QUEST_USE | ITEM_FLAG_QUEST_USE_MULTIPLE))
 			quest::CQuestManager::instance().RegisterNPCVnum(m_vec_prototype[i].dwVnum);
 
-		// NOTE : Support for PET_PAY
-		if (m_vec_prototype[i].bType == ITEM_PET && m_vec_prototype[i].bSubType == PET_PAY)
+#if defined(__MOUNT_COSTUME_SYSTEM__)
+		if (m_vec_prototype[i].bType == ITEM_COSTUME && m_vec_prototype[i].bSubType == COSTUME_MOUNT)
 			quest::CQuestManager::instance().RegisterNPCVnum(m_vec_prototype[i].dwVnum);
+#endif
 
-#if defined(__FISHING_GAME__)
-		// Quest item support for fish.
-		if (m_vec_prototype[i].bType == ITEM_FISH && m_vec_prototype[i].bSubType == FISH_ALIVE)
+		// NOTE : Supprot for PET_PAY
+		if (m_vec_prototype[i].bType == ITEM_PET && m_vec_prototype[i].bSubType == PET_PAY)
 			quest::CQuestManager::instance().RegisterNPCVnum(m_vec_prototype[i].dwVnum);
-#endif
 
 		m_map_vid.insert(std::map<DWORD, TItemTable>::value_type(m_vec_prototype[i].dwVnum, m_vec_prototype[i]));
 		if (test_server)
@@ -194,7 +167,7 @@
 	return true;
 }
 
-LPITEM ITEM_MANAGER::CreateItem(DWORD vnum, DWORD count, DWORD id, bool bTryMagic, int iRarePct, bool bSkipSave, bool bSkilAddon)
+LPITEM ITEM_MANAGER::CreateItem(DWORD vnum, DWORD count, DWORD id, bool bTryMagic, int iRarePct, bool bSkipSave)
 {
 	if (0 == vnum)
 		return NULL;
@@ -245,19 +218,17 @@
 	if (m_map_pkItemByID.find(id) != m_map_pkItemByID.end())
 	{
 		item = m_map_pkItemByID[id];
-		if (item)
-		{
-			LPCHARACTER owner = item->GetOwner();
-			if (!owner)
-				sys_err("ITEM_ID_DUP: %u %s null owner", id, item->GetName());
-			else
-				sys_err("ITEM_ID_DUP: %u %s owner %p", id, item->GetName(), get_pointer(owner));
-		}
+		LPCHARACTER owner = item->GetOwner();
+		sys_err("ITEM_ID_DUP: %u %s owner %p", id, item->GetName(), get_pointer(owner));
 		return NULL;
 	}
 
 	//  ϳ Ҵϰ
+#ifdef M2_USE_POOL
+	item = pool_.Construct();
+#else
 	item = M2_NEW CItem(vnum);
+#endif
 
 	bool bIsNewItem = (0 == id);
 
@@ -266,14 +237,17 @@
 	item->SetProto(table);
 	item->SetMaskVnum(dwMaskVnum);
 
-#if defined(__SOUL_BIND_SYSTEM__)
-	if (bIsNewItem)
-		item->SealItem(E_SEAL_DATE_DEFAULT_TIMESTAMP);
+#if defined(__SOUL_SYSTEM__)
+	if (item->GetType() == ITEM_SOUL)
+		item->SetSocket(2, item->GetValue(2));
 #endif
 
 	if (item->GetType() == ITEM_ELK) //  ID ʿ 嵵 ʿ.
 		item->SetSkipSave(true);
-
+#if defined(__CHEQUE_SYSTEM__)
+	else if (item->GetType() == ITEM_CHEQUE)
+		item->SetSkipSave(true);
+#endif
 	// Unique ID 
 	else if (!bIsNewItem)
 	{
@@ -304,30 +278,44 @@
 
 	switch (item->GetVnum())
 	{
-		case ITEM_AUTO_HP_RECOVERY_S:
-		case ITEM_AUTO_HP_RECOVERY_M:
-		case ITEM_AUTO_HP_RECOVERY_L:
-		case ITEM_AUTO_HP_RECOVERY_X:
-		case ITEM_AUTO_SP_RECOVERY_S:
-		case ITEM_AUTO_SP_RECOVERY_M:
-		case ITEM_AUTO_SP_RECOVERY_L:
-		case ITEM_AUTO_SP_RECOVERY_X:
-		case REWARD_BOX_ITEM_AUTO_SP_RECOVERY_XS:
-		case REWARD_BOX_ITEM_AUTO_SP_RECOVERY_S:
-		case REWARD_BOX_ITEM_AUTO_HP_RECOVERY_XS:
-		case REWARD_BOX_ITEM_AUTO_HP_RECOVERY_S:
-			if (bIsNewItem)
-				item->SetSocket(2, item->GetValue(0), true);
-			else
-				item->SetSocket(2, item->GetValue(0), false);
-			break;
+	case ITEM_AUTO_HP_RECOVERY_S:
+	case ITEM_AUTO_HP_RECOVERY_M:
+	case ITEM_AUTO_HP_RECOVERY_L:
+	case ITEM_AUTO_HP_RECOVERY_X:
+	case ITEM_AUTO_SP_RECOVERY_S:
+	case ITEM_AUTO_SP_RECOVERY_M:
+	case ITEM_AUTO_SP_RECOVERY_L:
+	case ITEM_AUTO_SP_RECOVERY_X:
+	case REWARD_BOX_ITEM_AUTO_SP_RECOVERY_XS:
+	case REWARD_BOX_ITEM_AUTO_SP_RECOVERY_S:
+	case REWARD_BOX_ITEM_AUTO_HP_RECOVERY_XS:
+	case REWARD_BOX_ITEM_AUTO_HP_RECOVERY_S:
+	case FUCKING_BRAZIL_ITEM_AUTO_SP_RECOVERY_S:
+	case FUCKING_BRAZIL_ITEM_AUTO_HP_RECOVERY_S:
+		if (bIsNewItem)
+			item->SetSocket(2, item->GetValue(0), true);
+		else
+			item->SetSocket(2, item->GetValue(0), false);
+		break;
+#if defined(__ANTI_EXP_RING__)
+	case ITEM_ANTI_EXP_RING:
+		item->SetSocket(1, false);
+#endif
+#if defined(__EXTENDED_BLEND_AFFECT__)
+	case 51002:
+		item->SetSocket(1, false);
+#endif
 	}
 
 	if (item->GetType() == ITEM_ELK) //  ƹ ó ʿ 
 		;
+#if defined(__CHEQUE_SYSTEM__)
+	else if (item->GetType() == ITEM_CHEQUE)
+		;
+#endif
 	else if (item->IsStackable()) // ĥ  ִ  
 	{
-		count = MINMAX(1, count, ITEM_MAX_COUNT);
+		count = MINMAX(1, count, gMaxItemCount);
 
 		if (bTryMagic && count <= 1 && IS_SET(item->GetFlag(), ITEM_FLAG_MAKECOUNT))
 			count = item->GetValue(1);
@@ -335,24 +323,34 @@
 	else
 		count = 1;
 
+#if defined(__EXTENDED_BLEND_AFFECT__)
+	if (item->IsBlendItem() && count > 1)
+		count = 1;
+#endif
+
 	item->SetVID(++m_dwVIDCount);
 
 	if (bSkipSave == false)
 		m_VIDMap.insert(ITEM_VID_MAP::value_type(item->GetVID(), item));
 
 	if (item->GetID() != 0 && bSkipSave == false)
-		m_map_pkItemByID.insert(ItemMap::value_type(item->GetID(), item));
+		m_map_pkItemByID.insert(std::map<DWORD, LPITEM>::value_type(item->GetID(), item));
 
 	if (!item->SetCount(count))
 		return NULL;
 
 	item->SetSkipSave(false);
 
-	if (item->GetType() == ITEM_UNIQUE && item->GetValue(2) != 0)
-		item->StartUniqueExpireEvent();
 #if defined(__MOUNT_COSTUME_SYSTEM__)
-	else if (item->IsRideItem() && item->GetValue(2) != 0)
+	if (item->GetType() == ITEM_UNIQUE || item->IsRideItem() && item->GetValue(2) != 0)
+#else
+	if (item->GetType() == ITEM_UNIQUE && item->GetValue(2) != 0)
+#endif
 		item->StartUniqueExpireEvent();
+
+#if defined(__SOUL_SYSTEM__)
+	if (item->GetType() == ITEM_SOUL && item->GetLimitValue(1) != 0)
+		item->StartSoulTimeUseEvent();
 #endif
 
 	for (int i = 0; i < ITEM_LIMIT_MAX_NUM; i++)
@@ -396,12 +394,16 @@
 	}
 
 #if defined(__MINI_GAME_CATCH_KING__)
-	if (item->GetVnum() == ITEM_VNUM_CATCH_KING_PIECE || item->GetVnum() == ITEM_VNUM_CATCH_KING_PACK)
+	if (item->GetVnum() == 79603 || item->GetVnum() == 79604)
 	{
-		int iEndTime = quest::CQuestManager::instance().GetEventFlag("mini_game_catchking");
-		if (iEndTime)
+		if (quest::CQuestManager::instance().GetEventFlag("enable_catch_king_event"))
 		{
-			item->SetSocket(0, iEndTime);
+			int iEndTime = quest::CQuestManager::instance().GetEventFlag("catch_king_event_end_day");
+
+			if (iEndTime)
+			{
+				item->SetSocket(0, iEndTime);
+			}
 		}
 	}
 #endif
@@ -411,11 +413,6 @@
 		item->SetSocket(0, item->GetLimitValue(1));
 #endif
 
-#if defined(__SOUL_SYSTEM__)
-	if (item->GetType() == ITEM_SOUL)
-		item->StartSoulTimerUseEvent();
-#endif
-
 	if (id == 0) //     ó
 	{
 		// ߰Ǵ ʵϰ  ٸó
@@ -429,82 +426,20 @@
 		}
 
 #if defined(__ITEM_APPLY_RANDOM__)
-		for (BYTE bApplyIndex = 0; bApplyIndex < ITEM_APPLY_MAX_NUM; ++bApplyIndex)
+		for (uint8_t uiApplySlot = 0; uiApplySlot < ITEM_APPLY_MAX_NUM; ++uiApplySlot)
 		{
-			POINT_TYPE wApplyRandomType = table->aApplies[bApplyIndex].wType;
-			POINT_VALUE lApplyRandomValue = table->aApplies[bApplyIndex].lValue;
-			if (wApplyRandomType == APPLY_RANDOM)
+			auto ApplyRandomType = table->aApplies[uiApplySlot].bType;
+			auto ApplyRandomValue = table->aApplies[uiApplySlot].lValue;
+			if (ApplyRandomType == APPLY_RANDOM)
 			{
-				POINT_TYPE wApplyType = APPLY_NONE; POINT_VALUE lApplyValue = 0; BYTE bPath = 0;
-				if (GetApplyRandom(lApplyRandomValue, item->GetRefineLevel(), wApplyType, lApplyValue, bPath))
-					item->SetForceRandomApply(bApplyIndex, wApplyType, lApplyValue, bPath);
+				uint8_t uiApplyType = APPLY_NONE; int32_t iApplyValue = 0; uint8_t uiPath = 0;
+				if (GetApplyRandom(ApplyRandomValue, item->GetRefineLevel(), uiApplyType, iApplyValue, uiPath))
+					item->SetForceRandomApply(uiApplySlot, uiApplyType, iApplyValue, uiPath);
 			}
 		}
 #endif
 
-#if defined(__ITEM_APPLY_RANDOM__) && defined(__ITEM_VALUE10__)
-		if (item->GetType() == ITEM_WEAPON)
-		{
-			const DWORD dwMinMtkValRng = item->GetValue(ITEM_VALUE_MTK_MIN_INDEX);
-			const DWORD dwMaxMtkValRng = item->GetValue(ITEM_VALUE_MTK_MAX_INDEX);
-
-			if (dwMinMtkValRng && dwMaxMtkValRng)
-			{
-				DWORD dwMinValue, dwMaxValue;
-				DWORD dwRndMinValue, dwRndMaxValue;
-
-				dwMinValue = dwMinMtkValRng / ITEM_VALUE_MINMAX_RANDOM_DIVISION_VALUE;
-				dwMaxValue = dwMinMtkValRng % (ITEM_VALUE_MINMAX_RANDOM_DIVISION_VALUE / 100);
-				dwRndMinValue = number(dwMinValue, dwMaxValue);
-
-				dwMinValue = dwMaxMtkValRng / ITEM_VALUE_MINMAX_RANDOM_DIVISION_VALUE;
-				dwMaxValue = dwMaxMtkValRng % (ITEM_VALUE_MINMAX_RANDOM_DIVISION_VALUE / 100);
-				dwRndMaxValue = number(dwMinValue, dwMaxValue);
-
-				const DWORD dwValue = dwRndMinValue * ITEM_VALUE_MINMAX_RANDOM_DIVISION_VALUE + dwRndMaxValue;
-				item->SetSocket(ITEM_SOCKET_MTK_MINMAX_RANDOM, dwValue);
-			}
-
-			const DWORD dwMinAtkValRng = item->GetValue(ITEM_VALUE_ATK_MIN_INDEX);
-			const DWORD dwMaxAtkValRng = item->GetValue(ITEM_VALUE_ATK_MAX_INDEX);
-
-			if (dwMinAtkValRng && dwMaxAtkValRng)
-			{
-				DWORD dwMinValue, dwMaxValue;
-				DWORD dwRndMinValue, dwRndMaxValue;
-
-				dwMinValue = dwMinAtkValRng / ITEM_VALUE_MINMAX_RANDOM_DIVISION_VALUE;
-				dwMaxValue = dwMinAtkValRng % (ITEM_VALUE_MINMAX_RANDOM_DIVISION_VALUE / 100);
-				dwRndMinValue = number(dwMinValue, dwMaxValue);
-
-				dwMinValue = dwMaxAtkValRng / ITEM_VALUE_MINMAX_RANDOM_DIVISION_VALUE;
-				dwMaxValue = dwMaxAtkValRng % (ITEM_VALUE_MINMAX_RANDOM_DIVISION_VALUE / 100);
-				dwRndMaxValue = number(dwMinValue, dwMaxValue);
-
-				const DWORD dwValue = dwRndMinValue * ITEM_VALUE_MINMAX_RANDOM_DIVISION_VALUE + dwRndMaxValue;
-				item->SetSocket(ITEM_SOCKET_ATK_MINMAX_RANDOM, dwValue);
-			}
-		}
-		else if (item->GetType() == ITEM_ARMOR || item->GetType() == ITEM_BELT)
-		{
-			const DWORD dwDefValRng = item->GetValue(ITEM_VALUE_DEF_MIN_INDEX);
-
-			if (dwDefValRng)
-			{
-				DWORD dwMinValue, dwMaxValue;
-				DWORD dwRndMinValue;
-
-				dwMinValue = dwDefValRng / ITEM_VALUE_MINMAX_RANDOM_DIVISION_VALUE;
-				dwMaxValue = dwDefValRng % (ITEM_VALUE_MINMAX_RANDOM_DIVISION_VALUE / 100);
-				dwRndMinValue = number(dwMinValue, dwMaxValue);
-
-				const DWORD dwValue = dwRndMinValue * ITEM_VALUE_MINMAX_RANDOM_DIVISION_VALUE + dwRndMinValue;
-				item->SetSocket(ITEM_SOCKET_DEF_MINMAX_RANDOM, dwValue);
-			}
-		}
-#endif
-
-		if (table->sAddonType && !bSkilAddon)
+		if (table->sAddonType)
 		{
 			item->ApplyAddon(table->sAddonType);
 		}
@@ -542,7 +477,6 @@
 
 			item->SetSocket(0, dwSkillVnum);
 		}
-		/*
 		else if (ITEM_SKILLFORGET2_VNUM == vnum)
 		{
 			DWORD dwSkillVnum;
@@ -557,12 +491,11 @@
 
 			item->SetSocket(0, dwSkillVnum);
 		}
-		*/
 	}
 
 	if (item->GetType() == ITEM_QUEST)
 	{
-		for (auto it = m_map_pkQuestItemGroup.begin(); it != m_map_pkQuestItemGroup.end(); it++)
+		for (itertype(m_map_pkQuestItemGroup) it = m_map_pkQuestItemGroup.begin(); it != m_map_pkQuestItemGroup.end(); it++)
 		{
 			if (it->second->m_bType == CSpecialItemGroup::QUEST && it->second->Contains(vnum))
 			{
@@ -572,7 +505,7 @@
 	}
 	else if (item->GetType() == ITEM_UNIQUE)
 	{
-		for (auto it = m_map_pkSpecialItemGroup.begin(); it != m_map_pkSpecialItemGroup.end(); it++)
+		for (itertype(m_map_pkSpecialItemGroup) it = m_map_pkSpecialItemGroup.begin(); it != m_map_pkSpecialItemGroup.end(); it++)
 		{
 			if (it->second->m_bType == CSpecialItemGroup::SPECIAL && it->second->Contains(vnum))
 			{
@@ -580,42 +513,30 @@
 			}
 		}
 	}
-#if defined(__ACCE_COSTUME_SYSTEM__)
-	else if (item->IsCostumeAcce())
-	{
-		if (item->GetRefinedVnum() == 0)
-			item->SetSocket(ITEM_SOCKET_ACCE_DRAIN_VALUE, number(11, ACCE_MAX_DRAINRATE));
-	}
-#endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-	else if (item->GetType() == ITEM_COSTUME && item->GetSubType() == COSTUME_AURA)
-	{
-		const BYTE c_bGrade = item->GetOriginalVnum() % 10;
-		const BYTE c_bBaseLevel = GetAuraRefineInfo(c_bGrade, AURA_REFINE_INFO_LEVEL_MIN);
-		item->SetSocket(ITEM_SOCKET_AURA_LEVEL_VALUE, (1000 + c_bBaseLevel) * 100000);
-	}
-#endif
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
 	//  Ǵ ȥ ó.
 	if (item->IsDragonSoul() && 0 == id)
+	{
 		DSManager::instance().DragonSoulItemInitialize(item);
-#endif
+	}
 
 	return item;
 }
 
 void ITEM_MANAGER::DelayedSave(LPITEM item)
 {
-	if (item && item->GetID() != 0)
+	if (item->GetID() != 0)
 		m_set_pkItemForDelayedSave.insert(item);
 }
 
 void ITEM_MANAGER::FlushDelayedSave(LPITEM item)
 {
-	std::unordered_set<LPITEM>::iterator it = m_set_pkItemForDelayedSave.find(item);
+	TR1_NS::unordered_set<LPITEM>::iterator it = m_set_pkItemForDelayedSave.find(item);
+
 	if (it == m_set_pkItemForDelayedSave.end())
+	{
 		return;
+	}
 
 	m_set_pkItemForDelayedSave.erase(it);
 	SaveSingleItem(item);
@@ -623,11 +544,7 @@
 
 void ITEM_MANAGER::SaveSingleItem(LPITEM item)
 {
-	if (!item)
-		return;
-
-	const LPCHARACTER owner = item->GetOwner();
-	if (NULL == owner)
+	if (!item->GetOwner())
 	{
 		DWORD dwID = item->GetID();
 		DWORD dwOwnerID = item->GetLastOwnerPID();
@@ -640,144 +557,79 @@
 		return;
 	}
 
-	sys_log(1, "ITEM_SAVE %s:%d in %s window %d", item->GetName(), item->GetID(), owner->GetName(), item->GetWindow());
+	sys_log(1, "ITEM_SAVE %s:%d in %s window %d", item->GetName(), item->GetID(), item->GetOwner()->GetName(), item->GetWindow());
 
 	TPlayerItem t;
 
-	t.dwID = item->GetID();
-	t.bWindow = item->GetWindow();
-	t.wPos = item->GetCell();
-	t.dwVnum = item->GetOriginalVnum();
-	t.dwCount = item->GetCount();
-
-	switch (t.bWindow)
-	{
-		case SAFEBOX:
-		case MALL:
-			t.dwOwner = owner->GetDesc()->GetAccountTable().id;
-			break;
-		default:
-			t.dwOwner = owner->GetPlayerID();
+	t.id = item->GetID();
+	t.window = item->GetWindow();
+	switch (t.window)
+	{
+	case EQUIPMENT:
+		t.pos = item->GetCell() - INVENTORY_MAX_NUM;
+		break;
+	case INVENTORY:
+		if (BELT_INVENTORY_SLOT_START <= item->GetCell() && BELT_INVENTORY_SLOT_END > item->GetCell())
+		{
+			t.window = BELT_INVENTORY;
+			t.pos = item->GetCell() - BELT_INVENTORY_SLOT_START;
 			break;
+		}
+	default:
+		t.pos = item->GetCell();
+		break;
 	}
-
+	t.count = item->GetCount();
+	t.vnum = item->GetOriginalVnum();
 #if defined(__SOUL_BIND_SYSTEM__)
-	t.lSealDate = item->GetSealDate();
+	t.soulbind = item->GetSealedTime();
 #endif
-	thecore_memcpy(t.alSockets, item->GetSockets(), sizeof(t.alSockets));
-	thecore_memcpy(t.aAttr, item->GetAttributes(), sizeof(t.aAttr));
 #if defined(__CHANGE_LOOK_SYSTEM__)
-	t.dwTransmutationVnum = item->GetTransmutationVnum();
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	thecore_memcpy(&t.RefineElement, item->GetRefineElement(), sizeof(t.RefineElement));
-#endif
-#if defined(__ITEM_APPLY_RANDOM__)
-	thecore_memcpy(t.aApplyRandom, item->GetRandomApplies(), sizeof(t.aApplyRandom));
+	t.transmutation = item->GetTransmutation();
 #endif
-#if defined(__SET_ITEM__)
-	t.bSetValue = item->GetItemSetValue();
-#endif
-
-	db_clientdesc->DBPacketHeader(HEADER_GD_ITEM_SAVE, 0, sizeof(TPlayerItem));
-	db_clientdesc->Packet(&t, sizeof(TPlayerItem));
-}
 
-#ifdef __OFFLINE_SHOP__
-void ITEM_MANAGER::GetPlayerItem(LPITEM item, TPlayerItem* result)
-{
-	result->dwID = item->GetID();
-	result->bWindow = item->GetWindow();
-	TPlayerItem t;
-	switch (result->bWindow)
-	{
-		case EQUIPMENT:
-			result->wPos = item->GetCell() - INVENTORY_MAX_NUM;
-			break;
-		case INVENTORY:
-			if (BELT_INVENTORY_SLOT_START <= item->GetCell() && BELT_INVENTORY_SLOT_END > item->GetCell())
-			{
-				t.bWindow = BELT_INVENTORY;
-				t.wPos = item->GetCell() - BELT_INVENTORY_SLOT_START;
-				break;
-			}
-		default:
-			result->wPos = item->GetCell();
-			break;
-	}
-	result->dwCount = item->GetCount();
-	result->dwVnum = item->GetOriginalVnum();
-	if (item->GetOwner())
-	{
-		switch (result->bWindow)
-		{
-			case SAFEBOX:
-			case MALL:
-				result->dwOwner = item->GetOwner()->GetDesc()->GetAccountTable().id;
-				break;
-			default:
-				result->dwOwner = item->GetOwner()->GetPlayerID();
-				break;
-		}
-	}
-	else
+	switch (t.window)
 	{
-		result->dwOwner = 0;
+	case SAFEBOX:
+	case MALL:
+		t.owner = item->GetOwner()->GetDesc()->GetAccountTable().id;
+		break;
+	default:
+		t.owner = item->GetOwner()->GetPlayerID();
+		break;
 	}
-
-	thecore_memcpy(result->alSockets, item->GetSockets(), sizeof(result->alSockets));
+	thecore_memcpy(t.alSockets, item->GetSockets(), sizeof(t.alSockets));
 #if defined(__ITEM_APPLY_RANDOM__)
-	thecore_memcpy(result->aApplyRandom, item->GetRandomApplies(), sizeof(result->aApplyRandom));
+	thecore_memcpy(t.aApplyRandom, item->GetRandomApplies(), sizeof(t.aApplyRandom));
 #endif
-	thecore_memcpy(result->aAttr, item->GetAttributes(), sizeof(result->aAttr));
+	thecore_memcpy(t.aAttr, item->GetAttributes(), sizeof(t.aAttr));
 
-#if defined(__SOUL_BIND_SYSTEM__)
-	result->lSealDate = item->GetSealDate();
-#endif
-#if defined(__CHANGE_LOOK_SYSTEM__)
-	result->dwTransmutationVnum = item->GetTransmutationVnum();
-#endif
+	db_clientdesc->DBPacketHeader(HEADER_GD_ITEM_SAVE, 0, sizeof(TPlayerItem));
+	db_clientdesc->Packet(&t, sizeof(TPlayerItem));
 }
-#endif
 
 void ITEM_MANAGER::Update()
 {
-	std::unordered_set<LPITEM>::iterator it = m_set_pkItemForDelayedSave.begin();
-	std::unordered_set<LPITEM>::iterator this_it;
+	TR1_NS::unordered_set<LPITEM>::iterator it = m_set_pkItemForDelayedSave.begin();
+	TR1_NS::unordered_set<LPITEM>::iterator this_it;
 
 	while (it != m_set_pkItemForDelayedSave.end())
 	{
 		this_it = it++;
 		LPITEM item = *this_it;
 
-		if (NULL == item)
-		{
-			sys_err("NULL item, erasing from delayed save.");
-			m_set_pkItemForDelayedSave.erase(item);
-			continue;
-		}
-
-		if (FindByVID(item->GetVID()) == NULL)
-		{
-			sys_err("Invalid item, erasing from delayed save.");
-			m_set_pkItemForDelayedSave.erase(item);
-			continue;
-		}
-
 		// SLOW_QUERY ÷װ ִ  ÿ Ѵ.
 		if (item->GetOwner() && IS_SET(item->GetFlag(), ITEM_FLAG_SLOW_QUERY))
 			continue;
 
 		SaveSingleItem(item);
+
 		m_set_pkItemForDelayedSave.erase(this_it);
 	}
 }
 
 void ITEM_MANAGER::RemoveItem(LPITEM item, const char* c_pszReason)
 {
-	if (!item)
-		return;
-
 	LPCHARACTER o;
 
 	if ((o = item->GetOwner()))
@@ -799,11 +651,7 @@
 		// END_OF_SAFEBOX_TIME_LIMIT_ITEM_BUG_FIX
 		else
 		{
-			if (item->GetWindow() == INVENTORY)
-				o->SyncQuickslot(SLOT_TYPE_INVENTORY, item->GetCell(), WORD_MAX);
-			else if (item->GetWindow() == BELT_INVENTORY)
-				o->SyncQuickslot(SLOT_TYPE_BELT_INVENTORY, item->GetCell(), WORD_MAX);
-
+			o->SyncQuickslot(QUICKSLOT_TYPE_ITEM, item->GetCell(), WORD_MAX);
 			item->RemoveFromCharacter();
 		}
 	}
@@ -817,9 +665,6 @@
 void ITEM_MANAGER::DestroyItem(LPITEM item, const char* file, size_t line)
 #endif
 {
-	if (!item)
-		return;
-
 	if (item->GetSectree())
 		item->RemoveFromGround();
 
@@ -827,16 +672,17 @@
 	{
 		if (CHARACTER_MANAGER::instance().Find(item->GetOwner()->GetPlayerID()) != NULL)
 		{
-			sys_err("DestroyItem (%lu): GetOwner %s %s!!", item->GetID(), item->GetName(), item->GetOwner()->GetName());
+			sys_err("DestroyItem: GetOwner %s %s!!", item->GetName(), item->GetOwner()->GetName());
 			item->RemoveFromCharacter();
 		}
 		else
 		{
-			sys_err("DestroyItem (%lu): WTH! Invalid item owner. owner pointer : %p", item->GetID(), item->GetOwner());
+			sys_err("WTH! Invalid item owner. owner pointer : %p", item->GetOwner());
 		}
 	}
 
-	std::unordered_set<LPITEM>::iterator it = m_set_pkItemForDelayedSave.find(item);
+	TR1_NS::unordered_set<LPITEM>::iterator it = m_set_pkItemForDelayedSave.find(item);
+
 	if (it != m_set_pkItemForDelayedSave.end())
 		m_set_pkItemForDelayedSave.erase(it);
 
@@ -861,17 +707,20 @@
 
 	m_VIDMap.erase(item->GetVID());
 
+#ifdef M2_USE_POOL
+	pool_.Destroy(item);
+#else
 #ifndef DEBUG_ALLOC
 	M2_DELETE(item);
-	item = NULL;
 #else
 	M2_DELETE_EX(item, file, line);
 #endif
+#endif
 }
 
 LPITEM ITEM_MANAGER::Find(DWORD id)
 {
-	ItemMap::iterator it = m_map_pkItemByID.find(id);
+	itertype(m_map_pkItemByID) it = m_map_pkItemByID.find(id);
 	if (it == m_map_pkItemByID.end())
 		return NULL;
 	return it->second;
@@ -1085,9 +934,7 @@
 	if (NULL == pkChr || NULL == pkKiller)
 		return false;
 
-	BYTE bRank = pkChr->GetMobRank();
 	int iLevel = pkKiller->GetLevel();
-
 	iDeltaPercent = 100;
 
 	if (!pkChr->IsStone() && pkChr->GetMobRank() >= MOB_RANK_BOSS)
@@ -1095,10 +942,7 @@
 	else
 		iDeltaPercent = PERCENT_LVDELTA(pkKiller->GetLevel(), pkChr->GetLevel());
 
-	// LEVEL_105_DROP_RATE
-	if (iLevel >= 105)
-		iDeltaPercent = PERCENT_LVDELTA_BOSS(105, pkChr->GetLevel());
-	// END_LEVEL_105_DROP_RATE
+	BYTE bRank = pkChr->GetMobRank();
 
 	if (1 == number(1, 50000))
 		iDeltaPercent += 1000;
@@ -1108,45 +952,40 @@
 	sys_log(3, "CreateDropItem for level: %d rank: %u pct: %d", iLevel, bRank, iDeltaPercent);
 	iDeltaPercent = iDeltaPercent * CHARACTER_MANAGER::instance().GetMobItemRate(pkKiller) / 100;
 
-	int iDropBonus = CPrivManager::instance().GetPriv(pkKiller, PRIV_ITEM_DROP);
-
-	// ADD_PREMIUM
-	if (pkKiller->GetPremiumRemainSeconds(PREMIUM_ITEM) > 0)
-	{
-		iDropBonus += 50;
-		iDeltaPercent += (iDeltaPercent * 50) / 100;
-	}
-
 	if (pkKiller->GetPoint(POINT_MALL_ITEMBONUS) > 0)
-	{
-		iDropBonus += MIN(100, pkKiller->GetPoint(POINT_MALL_ITEMBONUS));
 		iDeltaPercent += iDeltaPercent * pkKiller->GetPoint(POINT_MALL_ITEMBONUS) / 100;
-	}
+
+	// ADD_PREMIUM
+	if (pkKiller->GetPremiumRemainSeconds(PREMIUM_ITEM) > 0 || //mall
+		pkKiller->IsEquipUniqueGroup(UNIQUE_GROUP_DOUBLE_ITEM)) //any kind of equipped gloves
+		iDeltaPercent += iDeltaPercent;
 	// END_OF_ADD_PREMIUM
 
-	// NOTE: Thief's Gloves now work like special rings.
-	/*
-	if (pkKiller->IsEquipUniqueGroup(UNIQUE_GROUP_DOUBLE_ITEM))
+	int bonus = 0;
+	if (pkKiller->IsEquipUniqueItem(UNIQUE_ITEM_DOUBLE_ITEM) && pkKiller->GetPremiumRemainSeconds(PREMIUM_ITEM) > 0)
 	{
-		iDropBonus += 50;
-		iDeltaPercent += (iDeltaPercent * 50) / 100;
+		// irremovable gloves + mall
+		bonus = 100;
+		if (test_server)
+			pkKiller->ChatPacket(CHAT_TYPE_INFO, "drop bonus + 100% (irremovable gloves + mall)");
 	}
-	*/
-
-	if (pkKiller->GetPoint(POINT_ITEM_DROP_BONUS) > 0)
+	else if (pkKiller->IsEquipUniqueItem(UNIQUE_ITEM_DOUBLE_ITEM) || (pkKiller->IsEquipUniqueGroup(UNIQUE_GROUP_DOUBLE_ITEM) && pkKiller->GetPremiumRemainSeconds(PREMIUM_ITEM) > 0))
 	{
-		iDropBonus += MIN(100, pkKiller->GetPoint(POINT_ITEM_DROP_BONUS));
-		iDeltaPercent += iDeltaPercent * pkKiller->GetPoint(POINT_ITEM_DROP_BONUS) / 100;
+		// irremovable gloves OR removable gloves + mall
+		bonus = 50;
+		if (test_server)
+			pkKiller->ChatPacket(CHAT_TYPE_INFO, "drop bonus + 100% (irremovable gloves OR removable gloves + mall)");
 	}
 
-	iRandRange = 4000000;
-	iRandRange = iRandRange * 100 / (100 + iDropBonus);
+	int itemDropBonus = MIN(100, pkKiller->GetPoint(POINT_ITEM_DROP_BONUS));
 
+	iRandRange = 4000000;
+	iRandRange = iRandRange * 100 / (100 + CPrivManager::instance().GetPriv(pkKiller, PRIV_ITEM_DROP) + bonus + itemDropBonus);
 	return true;
 }
 
 #if defined(__SEND_TARGET_INFO__)
-void ITEM_MANAGER::GetMonsterItemDropMap(LPCHARACTER pkChr, LPCHARACTER pkKiller, MonsterItemDropMap& rItemDropMap, bool& bDropMetinStone)
+void ITEM_MANAGER::GetMonsterItemDropMap(LPCHARACTER pkChr, LPCHARACTER pkKiller, MonsterItemDropMap& rMonsterItemDropMap)
 {
 	if (pkChr->IsPolymorphed() || pkChr->IsPC())
 		return;
@@ -1178,9 +1017,9 @@
 			if (!table)
 				continue;
 
-			MonsterItemDropMap::iterator it = rItemDropMap.find(dwVnum);
-			if (it == rItemDropMap.end())
-				rItemDropMap.insert(std::make_pair(dwVnum, 1));
+			MonsterItemDropMap::iterator it = rMonsterItemDropMap.find(dwVnum);
+			if (it == rMonsterItemDropMap.end())
+				rMonsterItemDropMap.insert(std::make_pair(dwVnum, 1));
 		}
 	}
 	// CommonDropItem
@@ -1197,9 +1036,9 @@
 			for (DWORD i = 0; i < v.size(); ++i)
 			{
 				DWORD dwVnum = v[i].dwVnum;
-				MonsterItemDropMap::iterator it = rItemDropMap.find(dwVnum);
-				if (it == rItemDropMap.end())
-					rItemDropMap.insert(std::make_pair(dwVnum, v[i].iCount));
+				MonsterItemDropMap::iterator it = rMonsterItemDropMap.find(dwVnum);
+				if (it == rMonsterItemDropMap.end())
+					rMonsterItemDropMap.insert(std::make_pair(dwVnum, v[i].iCount));
 			}
 		}
 	}
@@ -1218,9 +1057,9 @@
 			{
 				const SMobItemGroupInfo& info = pGroup->GetOne();
 				DWORD dwVnum = info.dwItemVnum;
-				MonsterItemDropMap::iterator it = rItemDropMap.find(dwVnum);
-				if (it == rItemDropMap.end())
-					rItemDropMap.insert(std::make_pair(dwVnum, info.iCount));
+				MonsterItemDropMap::iterator it = rMonsterItemDropMap.find(dwVnum);
+				if (it == rMonsterItemDropMap.end())
+					rMonsterItemDropMap.insert(std::make_pair(dwVnum, info.iCount));
 			}
 		}
 	}
@@ -1240,9 +1079,9 @@
 				for (DWORD i = 0; i < v.size(); i++)
 				{
 					DWORD dwVnum = v[i].dwVNum;
-					MonsterItemDropMap::iterator it = rItemDropMap.find(dwVnum);
-					if (it == rItemDropMap.end())
-						rItemDropMap.insert(std::make_pair(dwVnum, v[i].iCount));
+					MonsterItemDropMap::iterator it = rMonsterItemDropMap.find(dwVnum);
+					if (it == rMonsterItemDropMap.end())
+						rMonsterItemDropMap.insert(std::make_pair(dwVnum, v[i].iCount));
 				}
 			}
 		}
@@ -1264,9 +1103,9 @@
 				for (DWORD i = 0; i < v.size(); ++i)
 				{
 					DWORD dwVnum = v[i].dwVnum;
-					MonsterItemDropMap::iterator it = rItemDropMap.find(dwVnum);
-					if (it == rItemDropMap.end())
-						rItemDropMap.insert(std::make_pair(dwVnum, v[i].iCount));
+					MonsterItemDropMap::iterator it = rMonsterItemDropMap.find(dwVnum);
+					if (it == rMonsterItemDropMap.end())
+						rMonsterItemDropMap.insert(std::make_pair(dwVnum, v[i].iCount));
 				}
 			}
 		}
@@ -1274,27 +1113,29 @@
 	// GloveItemGroup
 	//////////////////////////////////////////////////////////////////////////////////////////////
 
-	if (bShowEtcItemDrop && pkChr->GetMobDropItemVnum())
+	if (bShowEtcItemDrop)
 	{
-		EtcItemDropProbMap::const_iterator it = m_map_dwEtcItemDropProb.find(pkChr->GetMobDropItemVnum());
-		if (it != m_map_dwEtcItemDropProb.end())
+		if (pkChr->GetMobDropItemVnum())
 		{
-			MonsterItemDropMap::iterator it = rItemDropMap.find(pkChr->GetMobDropItemVnum());
-			if (it == rItemDropMap.end())
-				rItemDropMap.insert(std::make_pair(pkChr->GetMobDropItemVnum(), 1));
+			EtcItemDropProbMap::const_iterator it = m_map_dwEtcItemDropProb.find(pkChr->GetMobDropItemVnum());
+			if (it != m_map_dwEtcItemDropProb.end())
+			{
+				MonsterItemDropMap::iterator it = rMonsterItemDropMap.find(pkChr->GetMobDropItemVnum());
+				if (it == rMonsterItemDropMap.end())
+					rMonsterItemDropMap.insert(std::make_pair(pkChr->GetMobDropItemVnum(), 1));
+			}
 		}
 	}
 
-	if (bShowDropMetinStone && pkChr->IsStone())
+	if (bShowDropMetinStone)
 	{
-		const DWORD dwMetinStoneVnum = pkChr->GetDropMetinStoneVnum();
-		if (dwMetinStoneVnum)
+		if (pkChr->IsStone())
 		{
-			MonsterItemDropMap::iterator it = rItemDropMap.find(dwMetinStoneVnum);
-			if (it == rItemDropMap.end())
+			if (pkChr->GetDropMetinStoneVnum())
 			{
-				//rItemDropMap.insert(std::make_pair(pkChr->GetDropMetinStoneVnum(), 1));
-				bDropMetinStone = true;
+				MonsterItemDropMap::iterator it = rMonsterItemDropMap.find(pkChr->GetDropMetinStoneVnum());
+				if (it == rMonsterItemDropMap.end())
+					rMonsterItemDropMap.insert(std::make_pair(pkChr->GetDropMetinStoneVnum(), 1));
 			}
 		}
 	}
@@ -1459,7 +1300,9 @@
 
 bool ITEM_MANAGER::CreateDropItem(LPCHARACTER pkChr, LPCHARACTER pkKiller, std::vector<LPITEM>& vec_item)
 {
-	const int iLevel = pkKiller->GetLevel();
+	bool drop_debug = (test_server && quest::CQuestManager::instance().GetEventFlag("drop_test"));
+
+	int iLevel = pkKiller->GetLevel();
 
 	int iDeltaPercent, iRandRange;
 	if (!GetDropPct(pkChr, pkKiller, iDeltaPercent, iRandRange))
@@ -1495,6 +1338,7 @@
 				if (c_rInfo.m_dwVnum == pkChr->GetPolymorphItemVnum())
 				{
 					item = CreateItem(c_rInfo.m_dwVnum, 1, 0, true);
+
 					if (item)
 						item->SetSocket(0, pkChr->GetRaceNum());
 				}
@@ -1502,31 +1346,57 @@
 			else
 				item = CreateItem(c_rInfo.m_dwVnum, 1, 0, true);
 
-			if (item)
-				vec_item.emplace_back(item);
+			if (item) vec_item.push_back(item);
 		}
 	}
 
+	if (drop_debug)
+	{
+		sys_log(0, "====== Drops ====== ##");
+		sys_log(0, "\t iDeltaPercent: %d ##", iDeltaPercent);
+		sys_log(0, "\t iRandRange: %d ##", iRandRange);
+	}
+
 	// Drop Item Group
 	{
-		const auto it = m_map_pkDropItemGroup.find(pkChr->GetRaceNum());
+		if (drop_debug)
+			sys_log(0, "> Drop item group ##");
+
+		itertype(m_map_pkDropItemGroup) it;
+		it = m_map_pkDropItemGroup.find(pkChr->GetRaceNum());
+
 		if (it != m_map_pkDropItemGroup.end())
 		{
-			const auto v = it->second->GetVector();
+			__typeof__(it->second->GetVector()) v = it->second->GetVector();
+
 			for (DWORD i = 0; i < v.size(); ++i)
 			{
-				const int iPercent = (v[i].dwPct * iDeltaPercent) / 100;
-				if (iPercent >= number(1, iRandRange))
+				int iPercent = (v[i].dwPct * iDeltaPercent) / 100;
+				int ciRand = number(1, iRandRange);
+
+				if (drop_debug)
+				{
+					const TItemTable* table = GetTable(v[i].dwVnum);
+					float realPercent = (float)iPercent / iRandRange * 100;
+
+					sys_log(0, "\t %s: %f%%. %s(iPct: %d, Rnd: %d) ##", table->szLocaleName, realPercent, (iPercent >= ciRand) ? "DROP! " : "", iPercent, ciRand);
+				}
+
+				if (iPercent >= ciRand)
 				{
 					item = CreateItem(v[i].dwVnum, v[i].iCount, 0, true);
+
 					if (item)
 					{
 						if (item->GetType() == ITEM_POLYMORPH)
 						{
 							if (item->GetVnum() == pkChr->GetPolymorphItemVnum())
+							{
 								item->SetSocket(0, pkChr->GetRaceNum());
+							}
 						}
-						vec_item.emplace_back(item);
+
+						vec_item.push_back(item);
 					}
 				}
 			}
@@ -1535,22 +1405,39 @@
 
 	// MobDropItem Group
 	{
-		const auto it = m_map_pkMobItemGroup.find(pkChr->GetRaceNum());
+		if (drop_debug)
+			sys_log(0, "> Mob item group ##");
+
+		itertype(m_map_pkMobItemGroup) it;
+		it = m_map_pkMobItemGroup.find(pkChr->GetRaceNum());
+
 		if (it != m_map_pkMobItemGroup.end())
 		{
-			const CMobItemGroup* pGroup = it->second;
+			CMobItemGroup* pGroup = it->second;
 
 			// MOB_DROP_ITEM_BUG_FIX
 			// 20050805.myevan.MobDropItem     CMobItemGroup::GetOne() ٽ  ߻ 
 			if (pGroup && !pGroup->IsEmpty())
 			{
-				const int iPercent = 40000 * iDeltaPercent / pGroup->GetKillPerDrop();
-				if (iPercent >= number(1, iRandRange))
+				int iPercent = 40000 * iDeltaPercent / pGroup->GetKillPerDrop();
+				int ciRand = number(1, iRandRange);
+
+				if (drop_debug)
+				{
+					float realPercent = (float)iPercent / iRandRange * 100;
+
+					sys_log(0, "\t All items: %f%%. %s(iPct: %d, Rnd: %d) ##", realPercent, (iPercent >= ciRand) ? "DROP ONE! " : "", iPercent, ciRand);
+				}
+
+				if (iPercent >= ciRand)
 				{
 					const SMobItemGroupInfo& info = pGroup->GetOne();
 					item = CreateItem(info.dwItemVnum, info.iCount, 0, true, info.iRarePct);
-					if (item)
-						vec_item.emplace_back(item);
+
+					if (item && drop_debug)
+						sys_log(0, "\t\t Dropped %s ##", item->GetName());
+
+					if (item) vec_item.push_back(item);
 				}
 			}
 			// END_OF_MOB_DROP_ITEM_BUG_FIX
@@ -1559,20 +1446,22 @@
 
 	// Level Item Group
 	{
-		const auto it = m_map_pkLevelItemGroup.find(pkChr->GetRaceNum());
+		itertype(m_map_pkLevelItemGroup) it;
+		it = m_map_pkLevelItemGroup.find(pkChr->GetRaceNum());
+
 		if (it != m_map_pkLevelItemGroup.end())
 		{
 			if (it->second->GetLevelLimit() <= (DWORD)iLevel)
 			{
-				const auto v = it->second->GetVector();
+				__typeof__(it->second->GetVector()) v = it->second->GetVector();
+
 				for (DWORD i = 0; i < v.size(); i++)
 				{
-					if (v[i].dwPct >= (DWORD)number(1, 1000000/*iRandRange*/))
+					if (v[i].dwPct >= (DWORD)number(1, 1000000 /* iRandRange */))
 					{
-						const DWORD dwVnum = v[i].dwVNum;
+						DWORD dwVnum = v[i].dwVNum;
 						item = CreateItem(dwVnum, v[i].iCount, 0, true);
-						if (item)
-							vec_item.emplace_back(item);
+						if (item) vec_item.push_back(item);
 					}
 				}
 			}
@@ -1584,19 +1473,22 @@
 		if (pkKiller->GetPremiumRemainSeconds(PREMIUM_ITEM) > 0 ||
 			pkKiller->IsEquipUniqueGroup(UNIQUE_GROUP_DOUBLE_ITEM))
 		{
-			const auto it = m_map_pkGloveItemGroup.find(pkChr->GetRaceNum());
+			itertype(m_map_pkGloveItemGroup) it;
+			it = m_map_pkGloveItemGroup.find(pkChr->GetRaceNum());
+
 			if (it != m_map_pkGloveItemGroup.end())
 			{
-				const auto v = it->second->GetVector();
+				__typeof__(it->second->GetVector()) v = it->second->GetVector();
+
 				for (DWORD i = 0; i < v.size(); ++i)
 				{
-					const int iPercent = (v[i].dwPct * iDeltaPercent) / 100;
+					int iPercent = (v[i].dwPct * iDeltaPercent) / 100;
+
 					if (iPercent >= number(1, iRandRange))
 					{
-						const DWORD dwVnum = v[i].dwVnum;
+						DWORD dwVnum = v[i].dwVnum;
 						item = CreateItem(dwVnum, v[i].iCount, 0, true);
-						if (item)
-							vec_item.emplace_back(item);
+						if (item) vec_item.push_back(item);
 					}
 				}
 			}
@@ -1606,29 +1498,59 @@
 	// 
 	if (pkChr->GetMobDropItemVnum())
 	{
-		const auto it = m_map_dwEtcItemDropProb.find(pkChr->GetMobDropItemVnum());
+		if (drop_debug)
+			sys_log(0, "> Etc item group ##");
+
+		itertype(m_map_dwEtcItemDropProb) it = m_map_dwEtcItemDropProb.find(pkChr->GetMobDropItemVnum());
+
 		if (it != m_map_dwEtcItemDropProb.end())
 		{
-			const int iPercent = (it->second * iDeltaPercent) / 100;
-			if (iPercent >= number(1, iRandRange))
+			int iPercent = (it->second * iDeltaPercent) / 100;
+			int ciRand = number(1, iRandRange);
+
+			if (drop_debug)
+			{
+				float realPercent = (float)iPercent / iRandRange * 100;
+
+				sys_log(0, "\t All items: %f%%. %s(iPct: %d, Rnd: %d) ##", realPercent, (iPercent >= ciRand) ? "DROP ONE! " : "", iPercent, ciRand);
+			}
+
+			if (iPercent >= ciRand)
 			{
 				item = CreateItem(pkChr->GetMobDropItemVnum(), 1, 0, true);
-				if (item)
-					vec_item.emplace_back(item);
+				if (item && drop_debug)
+					sys_log(0, "\t\t Dropped %s ##", item->GetName());
+
+				if (item) vec_item.push_back(item);
 			}
 		}
 	}
 
 	if (pkChr->IsStone())
 	{
+		if (drop_debug)
+			sys_log(0, "> METIN! Drop stones ##");
+
 		if (pkChr->GetDropMetinStoneVnum())
 		{
-			const int iPercent = (pkChr->GetDropMetinStonePct() * iDeltaPercent) * 400;
-			if (iPercent >= number(1, iRandRange))
+			int iPercent = (pkChr->GetDropMetinStonePct() * iDeltaPercent) * 400;
+			int ciRand = number(1, iRandRange);
+
+			if (drop_debug)
+			{
+				float realPercent = (float)iPercent / iRandRange * 100;
+
+				sys_log(0, "\t Chance: %f%%. %s(iPct: %d, Rnd: %d) ##", realPercent, (iPercent >= ciRand) ? "DROP ONE! " : "", iPercent, ciRand);
+			}
+
+			if (iPercent >= ciRand)
 			{
 				item = CreateItem(pkChr->GetDropMetinStoneVnum(), 1, 0, true);
-				if (item)
-					vec_item.emplace_back(item);
+
+				if (item && drop_debug)
+					sys_log(0, "\t\t Dropped %s ##", item->GetName());
+
+				if (item) vec_item.push_back(item);
 			}
 		}
 	}
@@ -1639,7 +1561,7 @@
 		sys_log(0, "EVENT HORSE_SKILL_BOOK_DROP");
 
 		if ((item = CreateItem(ITEM_HORSE_SKILL_TRAIN_BOOK, 1, 0, true)))
-			vec_item.emplace_back(item);
+			vec_item.push_back(item);
 	}
 
 	// NEW_SPIRIT_STONES
@@ -1678,7 +1600,7 @@
 
 		pdw[0] = 50001;
 		pdw[1] = 1;
-		pdw[2] = quest::CQuestManager::Instance().GetEventFlag("lotto_round");
+		pdw[2] = quest::CQuestManager::instance().GetEventFlag("lotto_round");
 
 		//    Ѵ
 		DBManager::instance().ReturnQuery(QID_LOTTO, pkKiller->GetPlayerID(), pdw,
@@ -1691,7 +1613,7 @@
 	//
 	CreateQuestDropItem(pkChr, pkKiller, vec_item, iDeltaPercent, iRandRange);
 
-	for (auto it = vec_item.begin(); it != vec_item.end(); ++it)
+	for (itertype(vec_item) it = vec_item.begin(); it != vec_item.end(); ++it)
 	{
 		LPITEM item = *it;
 		DBManager::instance().SendMoneyLog(MONEY_LOG_DROP, item->GetVnum(), item->GetCount());
@@ -1747,12 +1669,12 @@
 
 	switch (killer_levelStep)
 	{
-		case 0:
-			return gs_dropEvent_charStone.percent_lv01_10;
+	case 0:
+		return gs_dropEvent_charStone.percent_lv01_10;
 
-		case 1:
-		case 2:
-			return gs_dropEvent_charStone.percent_lv11_30;
+	case 1:
+	case 2:
+		return gs_dropEvent_charStone.percent_lv11_30;
 	}
 
 	return gs_dropEvent_charStone.percent_lv31_MX;
@@ -1979,10 +1901,20 @@
 	// END_OF_DROPEVENT_CHARSTONE
 	__DropEvent_RefineBox_DropItem(*pkKiller, *pkChr, *this, vec_item);
 
-#if defined(__XMAS_EVENT_2008__)
 	// ũ 縻
 	if (quest::CQuestManager::instance().GetEventFlag("xmas_sock"))
 	{
+		//const DWORD SOCK_ITEM_VNUM = 50010;
+		DWORD SOCK_ITEM_VNUM = 0;
+		if (LC_IsKorea() || LC_IsYMIR())
+		{
+			SOCK_ITEM_VNUM = (number(1, 100) <= 50) ? 50010 : 71111;
+		}
+		else
+		{
+			SOCK_ITEM_VNUM = 50010;
+		}
+
 		int iDropPerKill[MOB_RANK_MAX_NUM] =
 		{
 			2000,
@@ -2005,12 +1937,11 @@
 			sys_log(0, "SOCK DROP %d %d", iPercent, iRandRange);
 			if (iPercent >= number(1, iRandRange))
 			{
-				if ((item = CreateItem(ITEM_XMAS_SOCK, 1, 0, true)))
+				if ((item = CreateItem(SOCK_ITEM_VNUM, 1, 0, true)))
 					vec_item.push_back(item);
 			}
 		}
 	}
-#endif
 
 	//  
 	if (quest::CQuestManager::instance().GetEventFlag("drop_moon"))
@@ -2058,7 +1989,7 @@
 		}
 	}
 
-	// 
+	//
 	if (GetDropPerKillPct(100, g_iUseLocale ? 2000 : 800, iDeltaPercent, "2006_drop") >= number(1, iRandRange))
 	{
 		sys_log(0, " DROP EVENT ");
@@ -2070,7 +2001,7 @@
 
 	}
 
-	// +
+	//+
 	if (GetDropPerKillPct(100, g_iUseLocale ? 2000 : 800, iDeltaPercent, "2007_drop") >= number(1, iRandRange))
 	{
 		sys_log(0, " DROP EVENT ");
@@ -2103,7 +2034,6 @@
 			vec_item.push_back(item);
 	}
 
-#if defined(__2016_VALENTINE_EVENT__)
 	// ߷Ÿ  ̺Ʈ. OGE 䱸  event ּҰ 1 .(ٸ ̺Ʈ ϴ ״ .)
 	if (GetDropPerKillPct(1, g_iUseLocale ? 2000 : 800, iDeltaPercent, "valentine_drop") >= number(1, iRandRange))
 	{
@@ -2115,7 +2045,6 @@
 		if ((item = CreateItem(dwVnum, 1, 0, true)))
 			vec_item.push_back(item);
 	}
-#endif
 
 	// ̽ũ ̺Ʈ
 	if (GetDropPerKillPct(100, g_iUseLocale ? 2000 : 800, iDeltaPercent, "icecream_drop") >= number(1, iRandRange))
@@ -2126,31 +2055,34 @@
 			vec_item.push_back(item);
 	}
 
-#if defined(__XMAS_EVENT_2012__)
 	// new ũ ̺Ʈ
 	// 53002 : Ʊ  ȯ
-	if ((pkKiller->CountSpecifyItem(MOB_XMAS_REINDEER) > 0) || (pkKiller->CountSpecifyItem(MOB_XMAS_REINDEER_MALL) > 0))
+	if ((pkKiller->CountSpecifyItem(53002) > 0) && (GetDropPerKillPct(50, 100, iDeltaPercent, "new_xmas_event") >= number(1, iRandRange)))
 	{
-		if (GetDropPerKillPct(50, 100, iDeltaPercent, "new_xmas_event") >= number(1, iRandRange))
-			pkKiller->AutoGiveItem(ITEM_XMAS_SOCK, 1);
+		const static DWORD xmas_sock = 50010;
+		pkKiller->AutoGiveItem(xmas_sock, 1);
 	}
-#endif
 
-#if defined(__HALLOWEEN_EVENT_2014__)
+	if ((pkKiller->CountSpecifyItem(53007) > 0) && (GetDropPerKillPct(50, 100, iDeltaPercent, "new_xmas_event") >= number(1, iRandRange)))
+	{
+		const static DWORD xmas_sock = 50010;
+		pkKiller->AutoGiveItem(xmas_sock, 1);
+	}
+
+	//if (pkChr->GetLevel() >= 30 && (GetDropPerKillPct(50, 100, iDeltaPercent, "ds_drop") >= number(1, iRandRange)))
+	//{
+	//	const static DWORD dragon_soul_gemstone = 30270;
+	//	if ((item = CreateItem(dragon_soul_gemstone, 1, 0, true)))
+	//		vec_item.push_back(item);
+	//}
+
 	if (GetDropPerKillPct(100, g_iUseLocale ? 2000 : 800, iDeltaPercent, "halloween_drop") >= number(1, iRandRange))
 	{
-		if (pkChr->GetMobRank() >= MOB_RANK_BOSS || pkChr->IsStone())
-		{
-			if ((item = CreateItem(30322, 1, 0, true)))
-				vec_item.push_back(item);
-		}
-		else
-		{
-			if ((item = CreateItem(30321, 1, 0, true)))
-				vec_item.push_back(item);
-		}
+		const static DWORD halloween_item = 30321;
+
+		if ((item = CreateItem(halloween_item, 1, 0, true)))
+			vec_item.push_back(item);
 	}
-#endif
 
 	if (GetDropPerKillPct(100, g_iUseLocale ? 2000 : 800, iDeltaPercent, "ramadan_drop") >= number(1, iRandRange))
 	{
@@ -2160,14 +2092,13 @@
 			vec_item.push_back(item);
 	}
 
-#if defined(__EASTER_EVENT__)
 	if (GetDropPerKillPct(100, g_iUseLocale ? 2000 : 800, iDeltaPercent, "easter_drop") >= number(1, iRandRange))
 	{
 		const static DWORD easter_item_base = 50160;
+
 		if ((item = CreateItem(easter_item_base + number(0, 19), 1, 0, true)))
 			vec_item.push_back(item);
 	}
-#endif
 
 	//  ̺Ʈ
 	if (GetDropPerKillPct(100, g_iUseLocale ? 2000 : 800, iDeltaPercent, "football_drop") >= number(1, iRandRange))
@@ -2264,62 +2195,11 @@
 				vec_item.push_back(item);
 		}
 	}
-
-#if defined(__MINI_GAME_RUMI__) && defined(__OKEY_EVENT_FLAG_RENEWAL__)
-	if (GetDropPerKillPct(50, 100, iDeltaPercent, "mini_game_okey_drop") >= number(1, iRandRange))
-		CMiniGameRumi::UpdateQuestFlag(pkKiller);
-#endif
-
-#if defined(__MINI_GAME_CATCH_KING__) && defined(__CATCH_KING_EVENT_FLAG_RENEWAL__)
-	if (GetDropPerKillPct(50, 100, iDeltaPercent, "mini_game_catchking_drop") >= number(1, iRandRange))
-		CMiniGameCatchKing::UpdateQuestFlag(pkKiller);
-#endif
-
-#if defined(__MINI_GAME_YUTNORI__) && defined(__YUTNORI_EVENT_FLAG_RENEWAL__)
-	if (GetDropPerKillPct(50, 100, iDeltaPercent, "mini_game_yutnori_drop") >= number(1, iRandRange))
-		CMiniGameYutnori::UpdateQuestFlag(pkKiller);
-#endif
-
-#if defined(__SUMMER_EVENT_ROULETTE__)
-	if (pkKiller->FindAffect(AFFECT_LATE_SUMMER_EVENT_BUFF) || pkKiller->FindAffect(AFFECT_LATE_SUMMER_EVENT_PRIMIUM_BUFF))
-	{
-		int iDropMultiply[MOB_RANK_MAX_NUM] =
-		{
-			0, // MOB_RANK_PAWN,
-			0, // MOB_RANK_S_PAWN,
-			0, // MOB_RANK_KNIGHT,
-			5, // MOB_RANK_S_KNIGHT,
-			30, // MOB_RANK_BOSS,
-			50, // MOB_RANK_KING,
-		};
-
-		if (pkKiller->FindAffect(AFFECT_LATE_SUMMER_EVENT_PRIMIUM_BUFF))
-			iDropMultiply[pkChr->GetMobRank()] += 30;
-
-		if (GetDropPerKillPct(1000, 1500, iDeltaPercent, "e_late_summer_drop") >= number(1, iRandRange) * iDropMultiply[pkChr->GetMobRank()])
-		{
-			CMiniGameRoulette::UpdateQuestFlag(pkKiller);
-		}
-	}
-#endif
-
-#if defined(__SNOWFLAKE_STICK_EVENT__)
-	if (quest::CQuestManager::instance().GetEventFlag("snowflake_stick_event"))
-	{
-		if (GetDropPerKillPct(50, 100, iDeltaPercent, "snowflake_stick_drop") >= number(1, iRandRange))
-			CSnowflakeStickEvent::Reward(pkKiller);
-	}
-#endif
-
-#if defined(__FLOWER_EVENT__)
-	if (GetDropPerKillPct(50, 100, iDeltaPercent, "e_flower_drop") >= number(1, iRandRange))
-		CFlowerEvent::Reward(pkKiller);
-#endif
 }
 
 DWORD ITEM_MANAGER::GetRefineFromVnum(DWORD dwVnum)
 {
-	auto it = m_map_ItemRefineFrom.find(dwVnum);
+	itertype(m_map_ItemRefineFrom) it = m_map_ItemRefineFrom.find(dwVnum);
 	if (it != m_map_ItemRefineFrom.end())
 		return it->second;
 	return 0;
@@ -2327,7 +2207,7 @@
 
 const CSpecialItemGroup* ITEM_MANAGER::GetSpecialItemGroup(DWORD dwVnum)
 {
-	auto it = m_map_pkSpecialItemGroup.find(dwVnum);
+	itertype(m_map_pkSpecialItemGroup) it = m_map_pkSpecialItemGroup.find(dwVnum);
 	if (it != m_map_pkSpecialItemGroup.end())
 	{
 		return it->second;
@@ -2337,7 +2217,7 @@
 
 const CSpecialAttrGroup* ITEM_MANAGER::GetSpecialAttrGroup(DWORD dwVnum)
 {
-	auto it = m_map_pkSpecialAttrGroup.find(dwVnum);
+	itertype(m_map_pkSpecialAttrGroup) it = m_map_pkSpecialAttrGroup.find(dwVnum);
 	if (it != m_map_pkSpecialAttrGroup.end())
 	{
 		return it->second;
@@ -2360,28 +2240,20 @@
 //  char_item.cpp Ͽ ִ Լ TransformRefineItem ״ 
 void ITEM_MANAGER::CopyAllAttrTo(LPITEM pkOldItem, LPITEM pkNewItem)
 {
-#if defined(__SOUL_SYSTEM__)
-	if (pkOldItem == nullptr || pkNewItem == nullptr)
-		return;
-
-	if (pkOldItem->GetType() == ITEM_SOUL)
-		return;
-#endif
-
 	// ACCESSORY_REFINE
 	if (pkOldItem->IsAccessoryForSocket())
 	{
-		for (int i = 0; i < METIN_SOCKET_MAX_NUM; ++i)
+		for (int i = 0; i < ITEM_SOCKET_MAX_NUM; ++i)
 		{
 			pkNewItem->SetSocket(i, pkOldItem->GetSocket(i));
 		}
-		//pkNewItem->StartAccessorySocketExpireEvent();
+		// pkNewItem->StartAccessorySocketExpireEvent();
 	}
 	// END_OF_ACCESSORY_REFINE
 	else
 	{
 		// ⼭  ڵ û 
-		for (int i = 0; i < METIN_SOCKET_MAX_NUM; ++i)
+		for (int i = 0; i < ITEM_SOCKET_MAX_NUM; ++i)
 		{
 			if (!pkOldItem->GetSocket(i))
 				break;
@@ -2392,91 +2264,23 @@
 		//  
 		int slot = 0;
 
-		for (int i = 0; i < METIN_SOCKET_MAX_NUM; ++i)
+		for (int i = 0; i < ITEM_SOCKET_MAX_NUM; ++i)
 		{
 			long socket = pkOldItem->GetSocket(i);
 			const int ITEM_BROKEN_METIN_VNUM = 28960; // ̰  Ȱ  3 ֳ... ϳ سФФ  н ȫ Ҳ
 			if (socket > 2 && socket != ITEM_BROKEN_METIN_VNUM)
 				pkNewItem->SetSocket(slot++, socket);
 		}
-	}
 
-#if defined(__ITEM_SOCKET6__)
-	for (int i = METIN_SOCKET_MAX_NUM; i < ITEM_SOCKET_MAX_NUM; ++i)
-		pkNewItem->SetSocket(i, pkOldItem->GetSocket(i));
-#endif
+	}
 
 	//   
 	pkOldItem->CopyAttributeTo(pkNewItem);
-
 #if defined(__CHANGE_LOOK_SYSTEM__)
-	pkNewItem->SetTransmutationVnum(pkOldItem->GetTransmutationVnum());
+	// NOTE: On official you lose the transmutation.
+	pkNewItem->SetTransmutation(0/*pkOldItem->GetTransmutation()*/, false);
 #endif
-
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	pkNewItem->SetRefineElement(pkOldItem->GetRefineElement());
-#endif
-
-#if defined(__SET_ITEM__)
-	pkNewItem->SetItemSetValue(pkOldItem->GetItemSetValue());
-#endif
-}
-
-#if defined(__LUCKY_BOX__)
-CLuckyBoxGroup::CLuckyBoxGroup(int iPrice, BYTE bMaxTryCount) :
-	m_iPrice(iPrice),
-	m_bMaxTryCount(bMaxTryCount)
-{}
-
-int CLuckyBoxGroup::GetPrice() const
-{
-	return m_iPrice;
-}
-
-BYTE CLuckyBoxGroup::GetMaxTryCount() const
-{
-	return m_bMaxTryCount;
-}
-
-void CLuckyBoxGroup::AddItem(DWORD dwBoxVNum, DWORD dwVNum, BYTE bCount)
-{
-	m_ItemsVec[dwBoxVNum].push_back({ dwVNum, bCount });
-}
-
-bool CLuckyBoxGroup::ContainsItems(DWORD dwBoxVNum) const
-{
-	auto it = m_ItemsVec.find(dwBoxVNum);
-	if (it != m_ItemsVec.end() && !it->second.empty())
-		return true;
-	return false;
-}
-
-const CLuckyBoxGroup::SLuckyBoxItemInfo& CLuckyBoxGroup::GetRandomItem(DWORD dwBoxVNum) const
-{
-	const std::size_t nIndex = number(0, GetItemCount(dwBoxVNum) - 1);
-	return m_ItemsVec.at(dwBoxVNum).at(nIndex);
-}
-
-std::size_t CLuckyBoxGroup::GetItemCount(DWORD dwBoxVNum) const
-{
-	return (ContainsItems(dwBoxVNum) ? m_ItemsVec.at(dwBoxVNum).size() : 0);
-}
+#if defined(__ITEM_APPLY_RANDOM__)
+	pkNewItem->SetRandomApplies(pkOldItem->GetNextRandomApplies());
 #endif
-
-#if defined(__GEM_SHOP__)
-const CGemShopItemGroup* ITEM_MANAGER::GetGemShopItemGroup(const BYTE c_bRow)
-{
-	GemShopItemGroupMap::iterator it = m_map_pGemShopItemGroup.find(c_bRow);
-	if (it != m_map_pGemShopItemGroup.end())
-		return it->second;
-	return nullptr;
-}
-
-BYTE ITEM_MANAGER::GetGemShopAddSlotItemCount(const BYTE c_bSlotIndex) const
-{
-	GemShopAddSlotItemGroupMap::const_iterator it = m_mapGemShopAddSlotItemGroup.find(c_bSlotIndex);
-	if (it != m_mapGemShopAddSlotItemGroup.end())
-		return it->second;
-	return 0;
 }
-#endif
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/main.cpp final/server/server/home/metin2/Source/Server/game/src/main.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/main.cpp	2025-06-28 21:33:22.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/main.cpp	2021-06-22 11:16:29.000000000 +0000
@@ -58,58 +58,49 @@
 #include "auth_brazil.h"
 #include "DragonLair.h"
 #include "skill_power.h"
+#include "SpeedServer.h"
 #include "DragonSoul.h"
-#if defined(__CUBE_RENEWAL__)
-#	include "cube.h"
-#endif
+#include <boost/bind.hpp>
 #ifndef __WIN32__
-#	include "limit_time.h"
+#include "limit_time.h"
 #endif
 
 //#define __FILEMONITOR__
 
 #if defined (__FreeBSD__) && defined(__FILEMONITOR__)
-#	include "FileMonitor_FreeBSD.h"
+#include "FileMonitor_FreeBSD.h"
 #endif
 
-#if defined(__MT_THUNDER_DUNGEON__)
-#	include "mt_thunder_dungeon.h"
-#endif
-#if defined(__DAWNMIST_DUNGEON__)
-#	include "dawnmist_dungeon.h"
+#if defined(__GUILD_DRAGONLAIR__)
+#include "MeleyLair.h"
 #endif
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-#	include "guild_dragonlair.h"
+
+#if defined(__TEMPLE_OCHAO__)
+#include "TempleOchao.h"
 #endif
-#if defined(__DEFENSE_WAVE__)
-#	include "defense_wave.h"
+
+#if defined(__MINI_GAME_CATCH_KING__)
+#include "minigame.h"
 #endif
 
 //#ifndef __WIN32__
 //#include <gtest/gtest.h>
 //#endif
+#ifdef __GROWTH_PET_SYSTEM__
+#include "growth_pet.h"
+#endif
 
 #ifdef USE_STACKTRACE
 #include <execinfo.h>
 #endif
 
-#include "check_server.h"
-#ifdef ENABLE_QUEEN_NETHIS
-#include "SnakeLair.h"
-#endif
-
-#if defined(__OFFLINE_SHOP__)
-#include "OfflineShop.h"
-#endif
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-#include "battlepass_manager.h"
-#endif
-
-#ifdef __GROWTH_PET_SYSTEM__
-#include "growth_pet.h"
+// 쿡 ׽Ʈ  ׻ Ű üũ
+#ifdef _WIN32
+//#define _USE_SERVER_KEY_
 #endif
+#include "check_server.h"
 
+extern void WriteVersion();
 //extern const char * _malloc_options;
 #if defined(__FreeBSD__) && defined(DEBUG_ALLOC)
 extern void (*_malloc_message)(const char* p1, const char* p2, const char* p3, const char* p4);
@@ -166,6 +157,8 @@
 int g_shutdown_core_pulse;
 bool g_bShutdown = false;
 
+extern int speed_server;
+
 extern void CancelReloadSpamEvent();
 
 void ContinueOnFatalError()
@@ -199,9 +192,9 @@
 	{
 		sys_err("ShutdownOnFatalError!!!!!!!!!!");
 		{
-			SendNotice(LC_STRING(" ġ  ߻Ͽ ڵ õ˴ϴ."));
-			SendNotice(LC_STRING("10 ڵ  Ǹ,"));
-			SendNotice(LC_STRING("5 Ŀ  ϽǼ ֽϴ."));
+			SendNotice(LC_TEXT(" ġ  ߻Ͽ ڵ õ˴ϴ."));
+			SendNotice(LC_TEXT("10 ڵ  Ǹ,"));
+			SendNotice(LC_TEXT("5 Ŀ  ϽǼ ֽϴ."));
 		}
 
 		g_bShutdown = true;
@@ -260,6 +253,13 @@
 	// 1ʸ
 	if (!(pulse % ht->passes_per_sec))
 	{
+#ifdef ENABLE_LIMIT_TIME
+		if ((unsigned)get_global_time() >= GLOBAL_LIMIT_TIME)
+		{
+			g_bShutdown = true;
+		}
+#endif
+
 		if (g_bAuthServer && LC_IsBrazil() && !test_server)
 			auth_brazil_log();
 
@@ -276,7 +276,8 @@
 
 		{
 			int count = 0;
-			auto it = g_sim.begin();
+			itertype(g_sim) it = g_sim.begin();
+
 			while (it != g_sim.end())
 			{
 				if (!it->second->IsCheck())
@@ -326,16 +327,12 @@
 	{
 		ITEM_MANAGER::instance().Update();
 		DESC_MANAGER::instance().UpdateLocalUserCount();
-
-#if defined(__MINI_GAME_RUMI__) || defined(__MINI_GAME_YUTNORI__) || defined(__MINI_GAME_CATCH_KING__)
-		CInGameEventManager::Instance().UpdateInGameEvent();
-#endif
 	}
 
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	if (!(pulse % (passes_per_sec * 1)))
+#if defined(__MINI_GAME_CATCH_KING__)
+	if (!(pulse % (passes_per_sec)))
 	{
-		CBattlePassManager::instance().CheckBattlePassTimes();
+		CMiniGameManager::instance().MiniGameCatchKingCheckEnd();
 	}
 #endif
 
@@ -344,11 +341,7 @@
 	DBManager::instance().Process();
 	AccountDB::instance().Process();
 	CPVPManager::instance().Process();
-#ifdef __OFFLINE_SHOP__
-	if (!g_bAuthServer) {
-		COfflineShop::Process();
-	}
-#endif
+
 	if (g_bShutdown)
 	{
 		if (thecore_pulse() > g_shutdown_disconnect_pulse)
@@ -369,6 +362,77 @@
 	}
 }
 
+static bool g_isInvalidServer = false;
+
+bool Metin2Server_IsInvalid()
+{
+	return g_isInvalidServer;
+}
+
+void Metin2Server_Check()
+{
+#ifdef _USE_SERVER_KEY_
+	if (false == CheckServer::CheckIp(g_szPublicIP))
+	{
+#ifdef _WIN32
+		fprintf(stderr, "check ip failed\n");
+#endif
+		g_isInvalidServer = true;
+	}
+	return;
+#endif
+
+	if (LC_IsEurope() || test_server)
+		return;
+
+	//  ip
+	if (strncmp(g_szPublicIP, "189.112.1", 9) == 0)
+	{
+		return;
+	}
+
+	// ĳ ip
+	if (strncmp(g_szPublicIP, "74.200.6", 8) == 0)
+	{
+		return;
+	}
+
+	static const size_t CheckServerListSize = 1;
+	static const char* CheckServerList[] = { "160.20.145.230" };
+	static const int CheckServerPort = 7120;
+
+	socket_t sockConnector = INVALID_SOCKET;
+
+	for (size_t i = 0; i < CheckServerListSize; i++)
+	{
+		sockConnector = socket_connect(CheckServerList[i], CheckServerPort);
+
+		if (0 < sockConnector)
+			break;
+	}
+
+	if (0 > sockConnector)
+	{
+		if (true != LC_IsEurope()) //    ϸ   
+			g_isInvalidServer = true;
+
+		return;
+	}
+
+	char buf[256] = { 0, };
+
+	socket_read(sockConnector, buf, sizeof(buf) - 1);
+
+	sys_log(0, "recv[%s]", buf);
+
+	if (strncmp(buf, "OK", 2) == 0)
+		g_isInvalidServer = false;
+	else if (strncmp(buf, "CK", 2) == 0)
+		g_isInvalidServer = true;
+
+	socket_close(sockConnector);
+}
+
 static void CleanUpForEarlyExit()
 {
 	CancelReloadSpamEvent();
@@ -376,8 +440,6 @@
 
 int main(int argc, char** argv)
 {
-	//_CrtSetReportMode(_CRT_ASSERT, _CRTDBG_MODE_DEBUG);
-
 #ifdef DEBUG_ALLOC
 	DebugAllocator::StaticSetUp();
 #endif
@@ -397,11 +459,8 @@
 	*/
 
 	ilInit(); // DevIL Initialize
-#ifndef __WIN32__
-	mkdir("log", S_IRWXU);
-#else
-	_mkdir("log");
-#endif
+
+	WriteVersion();
 
 	SECTREE_MANAGER sectree_manager;
 	CHARACTER_MANAGER char_manager;
@@ -417,7 +476,7 @@
 	AccountDB account_db;
 
 	LogManager log_manager;
-	CMessengerManager messenger_manager;
+	MessengerManager messenger_manager;
 	P2P_MANAGER p2p_manager;
 	CGuildManager guild_manager;
 	CGuildMarkManager mark_manager;
@@ -448,38 +507,20 @@
 	SpamManager spam_mgr;
 	CThreeWayWar threeway_war;
 	CDragonLairManager dl_manager;
-#if defined(__MT_THUNDER_DUNGEON__)
-	CMTThunderDungeon mt_thunder_dungeon;
-#endif
-#if defined(__DAWNMIST_DUNGEON__)
-	CDawnMistDungeon dawnmist_dungeon;
-#endif
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-	CGuildDragonLairManager guild_dragonlair_mgr;
-#endif
-#if defined(__DEFENSE_WAVE__)
-	CDefenseWaveManager dw_manager;
-#endif
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
+	CSpeedServerManager SSManager;
 	DSManager dsManager;
-#endif
-#if defined(__CUBE_RENEWAL__)
-	CCubeManager CubeManager;
-#endif
-#if defined(__INGAME_EVENT_MANAGER__)
-	CInGameEventManager ingame_event_manager;
-#endif
-#if defined(__SUMMER_EVENT_ROULETTE__)
-	CRouletteManager roulette_manager;
-#endif
-
+	
 #ifdef __GROWTH_PET_SYSTEM__
 	CGrowthPetManager growth_pet_manager;
 #endif
 
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	CBattlePassManager battlepass_manager;
+#if defined(__GUILD_DRAGONLAIR__)
+	MeleyLair::CMgr MeleyLair_manager;
+#endif
+
+#if defined(__TEMPLE_OCHAO__)
+	TempleOchao::CMgr TempleOchao_manager;
 #endif
 
 	if (!start(argc, argv))
@@ -488,42 +529,50 @@
 		return 0;
 	}
 
-#ifdef ENABLE_QUEEN_NETHIS
-	SnakeLair::CSnk SnakeLair_manager;
-#endif
-
 	quest::CQuestManager quest_manager;
+
 	if (!quest_manager.Initialize())
 	{
 		CleanUpForEarlyExit();
 		return 0;
 	}
 
-	messenger_manager.Initialize();
-	guild_manager.Initialize();
+	MessengerManager::instance().Initialize();
+	CGuildManager::instance().Initialize();
 	fishing::Initialize();
 	OXEvent_manager.Initialize();
+	if (speed_server)
+		CSpeedServerManager::instance().Initialize();
 
-#if defined(__CUBE_RENEWAL__)
-	CubeManager.Initialize();
-#else
 	Cube_init();
-#endif
-
-#ifdef ENABLE_QUEEN_NETHIS
-	SnakeLair_manager.Initialize();
-#endif
-
 	Blend_Item_init();
 	ani_init();
 	PanamaLoad();
 
+#if defined(__MINI_GAME_CATCH_KING__)
+	CMiniGameManager MiniGameManager;
+#endif
+
+	//Metin2Server_Check();
+
+#if defined(__WIN32__) && defined(_USE_SERVER_KEY_)
+	if (CheckServer::IsFail())
+		return 1;
+#endif
+
 	if (g_bTrafficProfileOn)
 		TrafficProfiler::instance().Initialize(TRAFFIC_PROFILE_FLUSH_CYCLE, "ProfileLog");
 
 	// if game server
 	if (!g_bAuthServer)
 	{
+#if defined(__GUILD_DRAGONLAIR__)
+		MeleyLair_manager.Initialize();
+#endif
+
+#if defined(__TEMPLE_OCHAO__)
+		TempleOchao_manager.Initialize();
+#endif
 	}
 
 	// Client PackageCrypt
@@ -567,16 +616,16 @@
 		} while (1);
 	}
 
-#if defined(__OFFLINE_SHOP__)
-	sys_log(0, "<shutdown> Destroying COfflineShop...");
-	COfflineShop::DestroyAll();
-#endif
-
 	sys_log(0, "<shutdown> Destroying CArenaManager...");
 	arena_manager.Destroy();
 	sys_log(0, "<shutdown> Destroying COXEventManager...");
 	OXEvent_manager.Destroy();
 
+#if defined(__MINI_GAME_CATCH_KING__)
+	sys_log(0, "<shutdown> Destroying CMiniGameManager...");
+	MiniGameManager.Destroy();
+#endif
+
 	sys_log(0, "<shutdown> Disabling signal timer...");
 	signal_timer_disable();
 
@@ -603,18 +652,16 @@
 	sys_log(0, "<shutdown> Destroying building::CManager...");
 	building_manager.Destroy();
 
-	sys_log(0, "<shutdown> Flushing TrafficProfiler...");
-	trafficProfiler.Flush();
-
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-	sys_log(0, "<shutdown> Destroying CGuildDragonLairManager...");
-	guild_dragonlair_mgr.Destroy();
+	if (!g_bAuthServer)
+	{
+#if defined(__GUILD_DRAGONLAIR__)
+		sys_log(0, "<shutdown> Destroying MeleyLair_manager.");
+		MeleyLair_manager.Destroy();
 #endif
+	}
 
-#if defined(__MT_THUNDER_DUNGEON__)
-	sys_log(0, "<shutdown> Destroying CMTThunderDungeon...");
-	mt_thunder_dungeon.Destroy();
-#endif
+	sys_log(0, "<shutdown> Flushing TrafficProfiler...");
+	trafficProfiler.Flush();
 
 	destroy();
 
@@ -647,6 +694,13 @@
 	_malloc_message = WriteMallocMessage;
 #endif
 
+#ifdef ENABLE_LIMIT_TIME
+	if ((unsigned)get_global_time() >= GLOBAL_LIMIT_TIME)
+	{
+		return 0;
+	}
+#endif
+
 	//TCHAR tszArg[] = { "npverltI" };
 	//while ((ch = getopt(argc, argv, tszArg)) != -1)
 	while (false /*(ch = getopt(argc, argv, "npverltI")) != -1*/)
@@ -655,77 +709,66 @@
 
 		switch (ch)
 		{
-			case 'I': // IP
-				strlcpy(g_szPublicIP, argv[optind], sizeof(g_szPublicIP));
+		case 'I': // IP
+			strlcpy(g_szPublicIP, argv[optind], sizeof(g_szPublicIP));
 
-				printf("IP %s\n", g_szPublicIP);
+			printf("IP %s\n", g_szPublicIP);
 
-				optind++;
-				optreset = 1;
-				break;
+			optind++;
+			optreset = 1;
+			break;
 
-#if defined(__PROXY_IP__)
-			case 'P': // Proxy
-				g_stProxyIP = argv[optind];
+		case 'p': // port
+			mother_port = static_cast<WORD>(strtol(argv[optind], &ep, 10));
 
-				printf("PROXY_IP %s\n", g_stProxyIP.c_str());
+			if (mother_port <= 1024)
+			{
+				usage();
+				return 0;
+			}
 
-				optind++;
-				optreset = 1;
-				break;
-#endif
+			printf("port %d\n", mother_port);
 
-			case 'p': // port
-				mother_port = static_cast<WORD>(strtol(argv[optind], &ep, 10));
+			optind++;
+			optreset = 1;
+			break;
 
-				if (mother_port <= 1024)
-				{
-					usage();
-					return 0;
-				}
+		case 'l':
+		{
+			long l = strtol(argv[optind], &ep, 10);
 
-				printf("port %d\n", mother_port);
+			log_set_level(l);
 
-				optind++;
-				optreset = 1;
-				break;
+			optind++;
+			optreset = 1;
+		}
+		break;
 
-			case 'l':
+		// LOCALE_SERVICE
+		case 'n':
+		{
+			if (optind < argc)
 			{
-				long l = strtol(argv[optind], &ep, 10);
-
-				log_set_level(l);
-
-				optind++;
+				st_localeServiceName = argv[optind++];
 				optreset = 1;
 			}
-			break;
+		}
+		break;
+		// END_OF_LOCALE_SERVICE
 
-			// LOCALE_SERVICE
-			case 'n':
-			{
-				if (optind < argc)
-				{
-					st_localeServiceName = argv[optind++];
-					optreset = 1;
-				}
-			}
+		case 'v': // verbose
+			bVerbose = true;
 			break;
-			// END_OF_LOCALE_SERVICE
-
-			case 'v': // verbose
-				bVerbose = true;
-				break;
 
-			case 'r':
-				g_bNoRegen = true;
-				break;
+		case 'r':
+			g_bNoRegen = true;
+			break;
 
-				// TRAFFIC_PROFILER
-			case 't':
-				g_bTrafficProfileOn = true;
-				break;
-				// END_OF_TRAFFIC_PROFILER
+			// TRAFFIC_PROFILER
+		case 't':
+			g_bTrafficProfileOn = true;
+			break;
+			// END_OF_TRAFFIC_PROFILER
 		}
 	}
 
@@ -733,6 +776,8 @@
 	config_init(st_localeServiceName);
 	// END_OF_LOCALE_SERVICE
 
+	thecore_check(g_szPublicIP);
+
 #ifdef __WIN32__
 	// In Windows dev mode, "verbose" option is [on] by default.
 	bVerbose = true;
@@ -845,10 +890,6 @@
 #endif
 	socket_close(p2p_socket);
 
-#ifdef ENABLE_QUEEN_NETHIS
-	sys_log(0, "<shutdown> Destroying SnakeLair_manager.");
-#endif
-
 	sys_log(0, "<shutdown> fdwatch_delete()...");
 	fdwatch_delete(main_fdw);
 
@@ -926,17 +967,24 @@
 		memset(&s_dwProfiler[0], 0, sizeof(s_dwProfiler));
 	}
 
+#ifdef _USE_SERVER_KEY_
+	if (Metin2Server_IsInvalid() && 0 == (thecore_random() % 7146))
+	{
+		return 0; // shutdown
+	}
+#endif
+
 #ifdef __WIN32__
 	if (_kbhit())
 	{
 		int c = _getch();
 		switch (c)
 		{
-			case 0x1b: // Esc
-				return 0; // shutdown
-				break;
-			default:
-				break;
+		case 0x1b: // Esc
+			return 0; // shutdown
+			break;
+		default:
+			break;
 		}
 	}
 #endif
@@ -1000,57 +1048,57 @@
 
 		switch (iRet)
 		{
-			case FDW_READ:
-				if (db_clientdesc == d)
-				{
-					int size = d->ProcessInput();
+		case FDW_READ:
+			if (db_clientdesc == d)
+			{
+				int size = d->ProcessInput();
 
-					if (size)
-						sys_log(1, "DB_BYTES_READ: %d", size);
+				if (size)
+					sys_log(1, "DB_BYTES_READ: %d", size);
 
-					if (size < 0)
-					{
-						d->SetPhase(PHASE_CLOSE);
-					}
-				}
-				else if (d->ProcessInput() < 0)
+				if (size < 0)
 				{
 					d->SetPhase(PHASE_CLOSE);
 				}
-				break;
-
-			case FDW_WRITE:
-				if (db_clientdesc == d)
-				{
-					int buf_size = buffer_size(d->GetOutputBuffer());
-					int sock_buf_size = fdwatch_get_buffer_size(fdw, d->GetSocket());
+			}
+			else if (d->ProcessInput() < 0)
+			{
+				d->SetPhase(PHASE_CLOSE);
+			}
+			break;
 
-					int ret = d->ProcessOutput();
+		case FDW_WRITE:
+			if (db_clientdesc == d)
+			{
+				int buf_size = buffer_size(d->GetOutputBuffer());
+				int sock_buf_size = fdwatch_get_buffer_size(fdw, d->GetSocket());
 
-					if (ret < 0)
-					{
-						d->SetPhase(PHASE_CLOSE);
-					}
+				int ret = d->ProcessOutput();
 
-					if (buf_size)
-						sys_log(1, "DB_BYTES_WRITE: size %d sock_buf %d ret %d", buf_size, sock_buf_size, ret);
-				}
-				else if (d->ProcessOutput() < 0)
+				if (ret < 0)
 				{
 					d->SetPhase(PHASE_CLOSE);
 				}
-				break;
 
-			case FDW_EOF:
+				if (buf_size)
+					sys_log(1, "DB_BYTES_WRITE: size %d sock_buf %d ret %d", buf_size, sock_buf_size, ret);
+			}
+			else if (d->ProcessOutput() < 0)
 			{
 				d->SetPhase(PHASE_CLOSE);
 			}
 			break;
 
-			default:
-				sys_err("fdwatch_check_event returned unknown %d", iRet);
-				d->SetPhase(PHASE_CLOSE);
-				break;
+		case FDW_EOF:
+		{
+			d->SetPhase(PHASE_CLOSE);
+		}
+		break;
+
+		default:
+			sys_err("fdwatch_check_event returned unknown %d", iRet);
+			d->SetPhase(PHASE_CLOSE);
+			break;
 		}
 	}
 
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/mob_manager.cpp final/server/server/home/metin2/Source/Server/game/src/mob_manager.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/mob_manager.cpp	2025-06-11 07:13:28.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/mob_manager.cpp	2021-06-22 11:19:36.000000000 +0000
@@ -26,26 +26,6 @@
 {
 }
 
-bool CMob::IsNPC(BYTE bCharType)
-{
-	switch (bCharType)
-	{
-		case CHAR_TYPE_NPC:
-		case CHAR_TYPE_WARP:
-		case CHAR_TYPE_GOTO:
-		case CHAR_TYPE_HORSE:
-//#if defined(__GROWTH_PET_SYSTEM__)
-		case CHAR_TYPE_PET:
-//#endif
-		case CHAR_TYPE_PET_PAY:
-		//case CHAR_TYPE_SHOP:
-		//case CHAR_TYPE_OBJECT:
-			return true;
-		default:
-			return false;
-	}
-}
-
 void CMob::AddSkillSplash(int iIndex, DWORD dwTiming, DWORD dwHitDistance)
 {
 	if (iIndex >= MOB_SKILL_MAX_NUM || iIndex < 0)
@@ -96,10 +76,10 @@
 			if (pkMob->m_table.Skills[j].dwVnum)
 				++SkillCount;
 
-		sys_log(0, "MOB: #%-5d %-30s LEVEL %d HP %u DEF %u EXP %u DROP_ITEM_VNUM %u SKILL_COUNT %d",
+		sys_log(0, "MOB: #%-5d %-30s LEVEL %u HP %lld DEF %u EXP %u DROP_ITEM_VNUM %u SKILL_COUNT %d",
 			t->dwVnum, t->szLocaleName, t->bLevel, t->dwMaxHP, t->wDef, t->dwExp, t->dwDropItemVnum, SkillCount);
 
-		if (CMob::IsNPC(t->bType))
+		if (CMobVnumHelper::IsNPCType(t->bType) || t->bType == CHAR_TYPE_WARP || t->bType == CHAR_TYPE_GOTO || t->bType == CHAR_TYPE_PET_PAY || t->bType == CHAR_TYPE_PET)
 			CHARACTER_MANAGER::instance().RegisterRaceNum(t->dwVnum);
 
 		quest::CQuestManager::instance().RegisterNPCVnum(t->dwVnum);
@@ -264,26 +244,13 @@
 	return it->second;
 }
 
-bool CMobManager::LoadGroupGroup(const char* c_pszFileName
-#if defined(__EXTENDED_RELOAD__)
-	, bool bReload
-#endif
-)
+bool CMobManager::LoadGroupGroup(const char* c_pszFileName)
 {
 	CTextFileLoader loader;
 
 	if (!loader.Load(c_pszFileName))
 		return false;
 
-#if defined(__EXTENDED_RELOAD__)
-	if (bReload)
-	{
-		for (auto it : m_map_pkMobGroupGroup)
-			M2_DELETE(it.second);
-		m_map_pkMobGroupGroup.clear();
-	}
-#endif
-
 	std::string stName;
 
 	for (DWORD i = 0; i < loader.GetChildNodeCount(); ++i)
@@ -338,26 +305,15 @@
 	return true;
 }
 
-bool CMobManager::LoadGroup(const char* c_pszFileName
-#if defined(__EXTENDED_RELOAD__)
-	, bool bReload
-#endif
-)
+bool CMobManager::LoadGroup(const char* c_pszFileName)
 {
 	CTextFileLoader loader;
+
 	if (!loader.Load(c_pszFileName))
 		return false;
 
-#if defined(__EXTENDED_RELOAD__)
-	if (bReload)
-	{
-		for (auto it : m_map_pkMobGroup)
-			M2_DELETE(it.second);
-		m_map_pkMobGroup.clear();
-	}
-#endif
-
 	std::string stName;
+
 	for (DWORD i = 0; i < loader.GetChildNodeCount(); ++i)
 	{
 		loader.SetChildNode(i);
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/packet.h final/server/server/home/metin2/Source/Server/game/src/packet.h
--- baseline/server/server/home/metin2/Source/Server/game/src/packet.h	2026-02-17 15:26:50.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/packet.h	2022-04-27 12:45:09.000000000 +0000
@@ -30,7 +30,7 @@
 #endif
 
 	//HEADER_CG_UNUSED = 22,
-	//HEADER_CG_UNUSED = 23,
+	HEADER_CG_PLAYER_PIN_CODE = 23,
 	//HEADER_CG_UNUSED = 24,
 	//HEADER_CG_UNUSED = 25,
 
@@ -40,32 +40,23 @@
 	HEADER_CG_SCRIPT_ANSWER = 29,
 	HEADER_CG_QUEST_INPUT_STRING = 30,
 	HEADER_CG_QUEST_CONFIRM = 31,
-#if defined(__OX_RENEWAL__)
-	HEADER_CG_QUEST_INPUT_LONG_STRING = 32,
-#endif
-#if defined(__OFFLINE_SHOP__)
-	HEADER_CG_OFFLINE_SHOP = 33,
-#endif
-	//HEADER_CG_UNUSED = 34,
 
-#ifdef __GROWTH_PET_SYSTEM__
-	HEADER_CG_PET_HATCH = 35,
-	HEADER_CG_PET_WINDOW_TYPE = 36,
-	HEADER_CG_PET_WINDOW = 37,
-	HEADER_CG_PET_NAME_CHANGE = 38,
-	HEADER_CG_PET_FEED = 39,
-	HEADER_CG_PET_DETERMINE = 40,
-	HEADER_CG_PET_ATTR_CHANGE = 41,
-	HEADER_CG_PET_REVIVE = 42,
-	HEADER_CG_PET_LEARN_SKILL = 43,
-	HEADER_CG_PET_SKILL_UPGRADE = 44,
-	HEADER_CG_PET_DELETE_SKILL = 45,
-	HEADER_CG_PET_DELETE_ALL_SKILL = 46,
-#endif
-
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	HEADER_CG_EXTEND_INVEN = 47,
-#endif
+	//HEADER_CG_UNUSED = 32,
+	//HEADER_CG_UNUSED = 33,
+	//HEADER_CG_UNUSED = 34,
+	//HEADER_CG_UNUSED = 35,
+	//HEADER_CG_UNUSED = 36,
+	//HEADER_CG_UNUSED = 37,
+	//HEADER_CG_UNUSED = 38,
+	//HEADER_CG_UNUSED = 39,
+	//HEADER_CG_UNUSED = 40,
+	//HEADER_CG_UNUSED = 41,
+	//HEADER_CG_UNUSED = 42,
+	//HEADER_CG_UNUSED = 43,
+	//HEADER_CG_UNUSED = 44,
+	//HEADER_CG_UNUSED = 45,
+	//HEADER_CG_UNUSED = 46,
+	//HEADER_CG_UNUSED = 47,
 	//HEADER_CG_UNUSED = 48,
 	//HEADER_CG_UNUSED = 49,
 
@@ -76,23 +67,27 @@
 	HEADER_CG_SHOOT = 54,
 	HEADER_CG_MYSHOP = 55,
 #if defined(__MYSHOP_DECO__)
-	HEADER_CG_MYSHOP_DECO_STATE = 56,
-	HEADER_CG_MYSHOP_DECO_ADD = 57,
+	HEADER_CG_MYSHOP_DECO = 56,
+#endif
+#if defined(__SKILL_COLOR_SYSTEM__)
+	HEADER_CG_SKILL_COLOR = 57,
 #endif
 	//HEADER_CG_UNUSED = 58,
 
 #if defined(__SEND_TARGET_INFO__)
-	HEADER_CG_TARGET_INFO = 59,
+	HEADER_CG_TARGET_INFO_LOAD = 59,
 #endif
 	HEADER_CG_ITEM_USE_TO_ITEM = 60,
 	HEADER_CG_TARGET = 61,
 
 	//HEADER_CG_UNUSED = 62,
 	//HEADER_CG_UNUSED = 63,
+
 	HEADER_CG_TEXT = 64, // @  ۵Ǹ ؽƮ ĽѴ.
 	HEADER_CG_WARP = 65,
 	HEADER_CG_SCRIPT_BUTTON = 66,
 	HEADER_CG_MESSENGER = 67,
+
 	//HEADER_CG_UNUSED = 68,
 
 	HEADER_CG_MALL_CHECKOUT = 69,
@@ -106,20 +101,23 @@
 	HEADER_CG_PARTY_USE_SKILL = 76,
 	HEADER_CG_SAFEBOX_ITEM_MOVE = 77,
 	HEADER_CG_PARTY_PARAMETER = 78,
+
 	//HEADER_CG_UNUSED = 79,
 
 	HEADER_CG_GUILD = 80,
 	HEADER_CG_ANSWER_MAKE_GUILD = 81,
 	HEADER_CG_FISHING = 82,
 	HEADER_CG_ITEM_GIVE = 83,
-#ifdef __SHOP_SEARCH__
-	HEADER_CG_SHOP_SEARCH_BY_NAME = 84,
-	HEADER_CG_SHOP_SEARCH_BY_OPTION = 85,
-	HEADER_CG_SHOP_SEARCH_BUY = 86,
-	HEADER_CG_SHOP_SEARCH_OWNER_MESSAGE = 87,
-	HEADER_CG_SHOP_SEARCH_REQUEST_SOLD_INFO = 88,
-#endif
+
+	//HEADER_CG_UNUSED = 84,
+	//HEADER_CG_UNUSED = 85,
+	//HEADER_CG_UNUSED = 86,
+	//HEADER_CG_UNUSED = 87,
+	//HEADER_CG_UNUSED = 88,
+	//HEADER_CG_UNUSED = 89,
+
 	HEADER_CG_EMPIRE = 90,
+
 	//HEADER_CG_UNUSED = 91,
 	//HEADER_CG_UNUSED = 92,
 	//HEADER_CG_UNUSED = 93,
@@ -127,9 +125,8 @@
 	//HEADER_CG_UNUSED = 95,
 
 	HEADER_CG_REFINE = 96,
-#if defined(__CUBE_RENEWAL__)
-	HEADER_CG_CUBE = 97,
-#endif
+
+	//HEADER_CG_UNUSED = 97,
 	//HEADER_CG_UNUSED = 98,
 	//HEADER_CG_UNUSED = 99,
 
@@ -154,28 +151,26 @@
 	HEADER_CG_SCRIPT_SELECT_ITEM = 114,
 	// END_OF_SCRIPT_SELECT_ITEM
 
-#if defined(__GEM_SYSTEM__)
-	HEADER_CG_SELECT_ITEM_EX = 115,
-#endif
+	//HEADER_CG_UNUSED = 115,
+
+	HEADER_CG_WHISPER_DETAILS = 116,
 
-	//HEADER_CG_UNUSED = 116,
 	//HEADER_CG_UNUSED = 117,
-	//HEADER_CG_UNUSED = 118,
-	//HEADER_CG_UNUSED = 119,
-#if defined(__QUEST_REQUEST_EVENT__)
-	HEADER_CG_REQUEST_EVENT_QUEST = 120,
-#endif
-#if defined(__LEFT_SEAT__)
-	HEADER_CG_LEFT_SEAT = 121,
-#endif
-	//HEADER_CG_UNUSED = 122,
-	//HEADER_CG_UNUSED = 123,
-	//HEADER_CG_UNUSED = 124,
-	//HEADER_CG_UNUSED = 125,
-	//HEADER_CG_UNUSED = 126,
-	//HEADER_CG_UNUSED = 127,
-	//HEADER_CG_UNUSED = 128,
-	//HEADER_CG_UNUSED = 129,
+
+#ifdef __GROWTH_PET_SYSTEM__
+	HEADER_CG_PET_HATCH = 118,
+	HEADER_CG_PET_WINDOW_TYPE = 119,
+	HEADER_CG_PET_WINDOW = 120,
+	HEADER_CG_PET_NAME_CHANGE = 121,
+	HEADER_CG_PET_FEED = 122,
+	HEADER_CG_PET_DETERMINE = 123,
+	HEADER_CG_PET_ATTR_CHANGE = 124,
+	HEADER_CG_PET_REVIVE = 125,
+	HEADER_CG_PET_LEARN_SKILL = 126,
+	HEADER_CG_PET_SKILL_UPGRADE = 127,
+	HEADER_CG_PET_DELETE_SKILL = 128,
+	HEADER_CG_PET_DELETE_ALL_SKILL = 129,
+#endif
 	//HEADER_CG_UNUSED = 130,
 	//HEADER_CG_UNUSED = 131,
 	//HEADER_CG_UNUSED = 132,
@@ -191,12 +186,8 @@
 	//HEADER_CG_UNUSED = 142,
 	//HEADER_CG_UNUSED = 143,
 	//HEADER_CG_UNUSED = 144,
-#if defined(__FISHING_GAME__)
-	HEADER_CG_FISHING_GAME = 145,
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	HEADER_CG_REFINE_ELEMENT = 146,
-#endif
+	//HEADER_CG_UNUSED = 145,
+	//HEADER_CG_UNUSED = 146,
 	//HEADER_CG_UNUSED = 147,
 	//HEADER_CG_UNUSED = 148,
 	//HEADER_CG_UNUSED = 149,
@@ -221,12 +212,8 @@
 	//HEADER_CG_UNUSED = 166,
 	//HEADER_CG_UNUSED = 167,
 	//HEADER_CG_UNUSED = 168,
-#if defined(__ATTR_6TH_7TH__)
-	HEADER_CG_ATTR67_ADD = 169,
-#endif
-#if defined(__SNOWFLAKE_STICK_EVENT__)
-	HEADER_CG_SNOWFLAKE_STICK_EVENT = 170,
-#endif
+	//HEADER_CG_UNUSED = 169,
+	//HEADER_CG_UNUSED = 170,
 	//HEADER_CG_UNUSED = 171,
 	//HEADER_CG_UNUSED = 172,
 	//HEADER_CG_UNUSED = 173,
@@ -237,23 +224,13 @@
 	//HEADER_CG_UNUSED = 178,
 	//HEADER_CG_UNUSED = 179,
 	//HEADER_CG_UNUSED = 180,
-#if defined(__MINI_GAME_RUMI__)
-	HEADER_CG_MINI_GAME_RUMI = 181,
-#endif
-#if defined(__MINI_GAME_YUTNORI__)
-	HEADER_CG_MINI_GAME_YUTNORI = 182,
-#endif
-#if defined(__GEM_SHOP__)
-	HEADER_CG_GEM_SHOP = 183,
-#endif
+	//HEADER_CG_UNUSED = 181,
+	//HEADER_CG_UNUSED = 182,
+	//HEADER_CG_UNUSED = 183,
 	//HEADER_CG_UNUSED = 184,
 	//HEADER_CG_UNUSED = 185,
-#if defined(__SUMMER_EVENT_ROULETTE__)
-	HEADER_CG_MINI_GAME_ROULETTE = 186,
-#endif
-#if defined(__FLOWER_EVENT__)
-	HEADER_CG_FLOWER_EVENT = 187,
-#endif
+	//HEADER_CG_UNUSED = 186,
+	//HEADER_CG_UNUSED = 187,
 	//HEADER_CG_UNUSED = 188,
 	//HEADER_CG_UNUSED = 189,
 	//HEADER_CG_UNUSED = 190,
@@ -266,12 +243,12 @@
 	//HEADER_CG_UNUSED = 197,
 	//HEADER_CG_UNUSED = 198,
 	//HEADER_CG_UNUSED = 199,
-	//HEADER_CG_UNUSED = 200,
 
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	HEADER_CG_EXT_BATTLE_PASS_ACTION = 201,
-	HEADER_CG_EXT_SEND_BP_PREMIUM_ITEM = 202,
-#endif
+	//HEADER_CG_ROULETTE = 200,
+	//HEADER_CG_UNUSED = 201,
+
+	//
+	//HEADER_CG_UNUSED = 202,
 
 	// NOTE : ̷ XXX  ̰ Packet  . ̷ ڵϰ  Ѿ.
 	// enum   ϴ. ƴ namepsace  ϴ..
@@ -280,32 +257,32 @@
 	//HEADER_CG_HS_ACK = 203,
 	//HEADER_CG_XTRAP_ACK = 204,
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
 	HEADER_CG_DRAGON_SOUL_REFINE = 205,
-#endif
 	HEADER_CG_STATE_CHECKER = 206,
 
-	//HEADER_CG_UNUSED = 207,
-#if defined(__LUCKY_BOX__)
-	HEADER_CG_LUCKY_BOX = 208,
-#endif
+	HEADER_CG_PHASE = 207,
+	//HEADER_CG_UNUSED = 208,
+	//HEADER_CG_UNUSED = 209,
 	//HEADER_CG_UNUSED = 210,
 #if defined(__ACCE_COSTUME_SYSTEM__)
-	HEADER_CG_ACCE_REFINE = 211,
+	HEADER_CG_ACCE = 211,
 #endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-	HEADER_CG_AURA_REFINE = 212,
+	//HEADER_CG_UNUSED = 212,
+#if defined(__CHANGE_LOOK_SYSTEM__)
+	HEADER_CG_CHANGE_LOOK = 213,
 #endif
-	//HEADER_CG_UNUSED = 213,
 	//HEADER_CG_UNUSED = 214,
 #if defined(__MAILBOX__)
 	HEADER_CG_MAILBOX_WRITE = 215,
 	HEADER_CG_MAILBOX_WRITE_CONFIRM = 216,
 	HEADER_CG_MAILBOX_PROCESS = 217,
 #endif
-#if defined(__MOVE_COSTUME_ATTR__)
-	HEADER_CG_ITEM_COMBINATION = 218,
-	HEADER_CG_ITEM_COMBINATION_CANCEL = 219,
+	//HEADER_CG_UNUSED = 218,
+	//HEADER_CG_UNUSED = 219,
+#if defined(__PRIVATESHOP_SEARCH_SYSTEM__)
+	HEADER_CG_PRIVATESHOP_SEARCH = 220,
+	HEADER_CG_PRIVATESHOP_SEARCH_CLOSE = 221,
+	HEADER_CG_PRIVATESHOP_SEARCH_BUY_ITEM = 222,
 #endif
 	//HEADER_CG_UNUSED = 223,
 	//HEADER_CG_UNUSED = 224,
@@ -313,21 +290,15 @@
 #if defined(__MINI_GAME_CATCH_KING__)
 	HEADER_CG_MINI_GAME_CATCH_KING = 226,
 #endif
-#if defined(__CHANGED_ATTR__)
-	HEADER_CG_ITEM_SELECT_ATTR = 227,
-#endif
-#if defined(__CHANGE_LOOK_SYSTEM__)
-	HEADER_CG_CHANGE_LOOK = 228,
-#endif
+	//HEADER_CG_UNUSED = 227,
+	//HEADER_CG_UNUSED = 228,
 	//HEADER_CG_UNUSED = 229,
-	//HEADER_CG_UNUSED = 230,
+	HEADER_CG_CHANGE_LANGUAGE = 230,
 	//HEADER_CG_UNUSED = 231,
 	//HEADER_CG_UNUSED = 232,
 	//HEADER_CG_UNUSED = 233,
 	//HEADER_CG_UNUSED = 234,
-#if defined(__LOOT_FILTER_SYSTEM__)
-	HEADER_CG_LOOT_FILTER = 235,
-#endif
+	//HEADER_CG_UNUSED = 235,
 	//HEADER_CG_UNUSED = 236,
 	//HEADER_CG_UNUSED = 237,
 	//HEADER_CG_UNUSED = 238,
@@ -368,7 +339,7 @@
 	HEADER_GC_CHARACTER_DELETE_SUCCESS = 10,
 	HEADER_GC_CHARACTER_DELETE_WRONG_SOCIAL_ID = 11,
 
-	//HEADER_GC_UNUSED = 12,
+	//HEADER_CG_UNUSED = 12,
 	HEADER_GC_STUN = 13,
 	HEADER_GC_DEAD = 14,
 
@@ -383,7 +354,7 @@
 	HEADER_GC_ITEM_USE = 22,
 	HEADER_GC_ITEM_DROP = 23,
 
-	//HEADER_GC_UNUSED = 24,
+	//HEADER_CG_UNUSED = 24,
 	HEADER_GC_ITEM_UPDATE = 25,
 	HEADER_GC_ITEM_GROUND_ADD = 26,
 	HEADER_GC_ITEM_GROUND_DEL = 27,
@@ -401,7 +372,7 @@
 	//HEADER_GC_UNUSED = 35,
 
 	HEADER_GC_MOTION = 36,
-	HEADER_GC_EMOTE = 37,
+	//HEADER_GC_UNUSED = 37,
 
 	HEADER_GC_SHOP = 38,
 	HEADER_GC_SHOP_SIGN = 39,
@@ -415,19 +386,11 @@
 	HEADER_GC_SCRIPT = 45,
 	HEADER_GC_QUEST_CONFIRM = 46,
 
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	HEADER_GC_EXTEND_INVEN = 47,
-	HEADER_GC_EXTEND_INVEN_ITEM_USE = 48,
-#endif
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-	HEADER_GC_GUILD_DRAGONLAIR = 49,
-#endif
-#if defined(__CLIENT_TIMER__)
-	HEADER_GC_CLIENT_TIMER = 50,
-#endif
-#if defined(__OFFLINE_SHOP__)
-	HEADER_GC_OFFLINE_SHOP = 51,
-#endif
+	//HEADER_GC_UNUSED = 47,
+	//HEADER_GC_UNUSED = 48,
+	//HEADER_GC_UNUSED = 49,
+	//HEADER_GC_UNUSED = 50,
+	//HEADER_GC_UNUSED = 51,
 	//HEADER_GC_UNUSED = 52,
 	//HEADER_GC_UNUSED = 53,
 	//HEADER_GC_UNUSED = 54,
@@ -465,7 +428,9 @@
 	HEADER_GC_QUEST_INFO = 81,
 	HEADER_GC_REQUEST_MAKE_GUILD = 82,
 	HEADER_GC_PARTY_PARAMETER = 83,
-	//HEADER_GC_UNUSED = 84,
+#if defined(__WJ_SHOW_PARTY_ON_MINIMAP__)
+	HEADER_GC_PARTY_POSITION_INFO = 84,
+#endif
 
 	HEADER_GC_SAFEBOX_SET = 85,
 	HEADER_GC_SAFEBOX_DEL = 86,
@@ -480,12 +445,10 @@
 	HEADER_GC_PARTY_UNLINK = 92,
 	//HEADER_GC_UNUSED = 93,
 	//HEADER_GC_UNUSED = 94,
-	//HEADER_GC_UNUSED = 95,
-	//HEADER_GC_UNUSED = 96,
-#if defined(__CUBE_RENEWAL__)
-	HEADER_GC_CUBE = 97,
-#endif
-	//HEADER_GC_UNUSED = 98,
+	HEADER_GC_REFINE_INFORMATION_OLD = 95,
+	//HEADER_GC_OBSERVER_ADD = 96,
+	//HEADER_GC_OBSERVER_REMOVE = 97,
+	//HEADER_GC_OBSERVER_MOVE = 98,
 	HEADER_GC_VIEW_EQUIP = 99,
 
 	HEADER_GC_MARK_BLOCK = 100,
@@ -496,7 +459,7 @@
 	//HEADER_GC_SLOW_TIMER = 105,
 	HEADER_GC_TIME = 106,
 	HEADER_GC_CHANGE_NAME = 107,
-	//HEADER_GC_UNUSED = 108,
+	HEADER_GC_PLAYER_PIN_CODE = 108,
 	//HEADER_GC_UNUSED = 109,
 
 	HEADER_GC_DUNGEON = 110,
@@ -513,7 +476,7 @@
 	HEADER_GC_LOGIN_KEY = 118,
 
 	HEADER_GC_REFINE_INFORMATION = 119,
-	//HEADER_GC_UNUSED = 120,
+	//HEADER_GC_CHARACTER_ADD2 = 120,
 	HEADER_GC_CHANNEL = 121,
 
 	HEADER_GC_MALL_OPEN = 122,
@@ -546,17 +509,14 @@
 	HEADER_GC_MAIN_CHARACTER4_BGM_VOL = 138,
 	// END_OF_SUPPORT_BGM
 
+	//HEADER_GC_UNUSED = 139,
 	//HEADER_GC_UNUSED = 140,
 	//HEADER_GC_UNUSED = 141,
 	//HEADER_GC_UNUSED = 142,
 	//HEADER_GC_UNUSED = 143,
 	//HEADER_GC_UNUSED = 144,
-#if defined(__FISHING_GAME__)
-	HEADER_GC_FISHING_GAME = 145,
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	HEADER_GC_REFINE_ELEMENT = 146,
-#endif
+	//HEADER_GC_UNUSED = 145,
+	//HEADER_GC_UNUSED = 146,
 	//HEADER_GC_UNUSED = 147,
 	//HEADER_GC_UNUSED = 148,
 	//HEADER_GC_UNUSED = 149,
@@ -569,17 +529,30 @@
 	HEADER_GC_HYBRIDCRYPT_SDB = 153, // SDB means Supplmentary Data Blocks
 	// HYBRID CRYPT
 
-#ifdef __SHOP_SEARCH__
-	HEADER_GC_SHOP_SEARCH_RESULT = 164,
-	HEADER_GC_SHOP_SEARCH_BUY_RESULT = 165,
-	HEADER_GC_SHOP_SEARCH_OWNER_MESSAGE = 166,
-	HEADER_GC_SHOP_SEARCH_SOLD_INFO = 167,
-	HEADER_GC_ENTITY = 168,
+	//HEADER_CG_UNUSED = 154,
+	//HEADER_GC_UNUSED = 155,
+#if defined(__PRIVATESHOP_SEARCH_SYSTEM__)
+	HEADER_GC_PRIVATESHOP_SEARCH = 156,
+	HEADER_GC_PRIVATESHOP_SEARCH_OPEN = 157,
 #endif
-	//HEADER_GC_UNUSED = 169,
-#if defined(__SNOWFLAKE_STICK_EVENT__)
-	HEADER_GC_SNOWFLAKE_STICK_EVENT = 170,
+
+	HEADER_GC_WHISPER_DETAILS = 157,
+	
+#ifdef __GROWTH_PET_SYSTEM__
+	HEADER_GC_PET = 158,
+	HEADER_GC_PET_SET = 159,
+	HEADER_GC_PET_SET_EXCHANGE = 160,
+	HEADER_GC_PET_DEL = 161,
+	HEADER_GC_PET_SUMMON = 162,
+	HEADER_GC_PET_POINT_CHANGE = 163,
+	HEADER_GC_PET_NAME_CHANGE_RESULT = 164,
+	HEADER_GC_PET_DETERMINE_RESULT = 165,
+	HEADER_GC_PET_ATTR_CHANGE_RESULT = 166,
+	HEADER_GC_PET_SKILL_UPDATE = 167,
+	HEADER_GC_PET_SKILL_COOLTIME = 168,
 #endif
+	//HEADER_GC_UNUSED = 169,
+	//HEADER_GC_UNUSED = 170,
 	//HEADER_GC_UNUSED = 171,
 	//HEADER_GC_UNUSED = 172,
 	//HEADER_GC_UNUSED = 173,
@@ -590,44 +563,34 @@
 	//HEADER_GC_UNUSED = 178,
 	//HEADER_GC_UNUSED = 179,
 	//HEADER_GC_UNUSED = 180,
-#if defined(__MINI_GAME_RUMI__)
-	HEADER_GC_MINI_GAME_RUMI = 181,
-#endif
-#if defined(__MINI_GAME_YUTNORI__)
-	HEADER_GC_MINI_GAME_YUTNORI = 182,
-#endif
+	//HEADER_GC_UNUSED = 181,
+	//HEADER_GC_UNUSED = 182,
 	//HEADER_GC_UNUSED = 183,
 	//HEADER_GC_UNUSED = 184,
 	//HEADER_GC_UNUSED = 185,
-#if defined(__SUMMER_EVENT_ROULETTE__)
-	HEADER_GC_MINI_GAME_ROULETTE = 186,
-#endif
-#if defined(__FLOWER_EVENT__)
-	HEADER_GC_FLOWER_EVENT = 187,
-#endif
-
-#ifdef __GROWTH_PET_SYSTEM__
-	HEADER_GC_PET = 188,
-	HEADER_GC_PET_SET = 189,
-	HEADER_GC_PET_SET_EXCHANGE = 190,
-	HEADER_GC_PET_DEL = 191,
-	HEADER_GC_PET_SUMMON = 192,
-	HEADER_GC_PET_POINT_CHANGE = 193,
-	HEADER_GC_PET_NAME_CHANGE_RESULT = 194,
-	HEADER_GC_PET_DETERMINE_RESULT = 195,
-	HEADER_GC_PET_ATTR_CHANGE_RESULT = 196,
-	HEADER_GC_PET_SKILL_UPDATE = 197,
-	HEADER_GC_PET_SKILL_COOLTIME = 198,
-#endif
-
+	//HEADER_GC_UNUSED = 186,
+	//HEADER_GC_UNUSED = 187,
+	//HEADER_GC_UNUSED = 188,
+	//HEADER_GC_UNUSED = 189,
+	HEADER_GC_HWID = 190,
+	//HEADER_GC_UNUSED = 191,
+	//HEADER_GC_UNUSED = 192,
+	//HEADER_GC_UNUSED = 193,
+	//HEADER_GC_UNUSED = 194,
+	//HEADER_GC_UNUSED = 195,
+	//HEADER_GC_UNUSED = 196,
+	//HEADER_GC_UNUSED = 197,
+	//HEADER_GC_UNUSED = 198,
 	//HEADER_GC_UNUSED = 199,
-	//HEADER_GC_UNUSED = 200,
 
-#if defined(__GEM_SHOP__)
-	HEADER_GC_GEM_SHOP = 201,
-	HEADER_GC_GEM_SHOP_PROCESS = 202,
-#endif
+	// ROULETTE
+	HEADER_GC_ROULETTE = 200,
+	// END_ROULETTE
+
+	//HEADER_GC_UNUSED = 201,
+	//HEADER_GC_UNUSED = 202,
 	//HEADER_GC_UNUSED = 203,
+
 	//HEADER_GC_UNUSED = 204,
 	//HEADER_GC_UNUSED = 205,
 	//HEADER_GC_UNUSED = 206,
@@ -638,19 +601,18 @@
 	HEADER_GC_DRAGON_SOUL_REFINE = 209,
 	HEADER_GC_RESPOND_CHANNELSTATUS = 210,
 
+	//HEADER_GC_UNUSED = 211,
 	//HEADER_GC_UNUSED = 212,
 	//HEADER_GC_UNUSED = 213,
+	//HEADER_GC_UNUSED = 214,
 #if defined(__ACCE_COSTUME_SYSTEM__)
-	HEADER_GC_ACCE_REFINE = 214,
+	HEADER_GC_ACCE = 215,
 #endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-	HEADER_GC_AURA_REFINE = 215,
-#endif
-	//HEADER_GC_UNUSED = 216,
-#if defined(__LUCKY_BOX__)
-	HEADER_GC_LUCKY_BOX = 217,
+	HEADER_GC_REQUEST_CHANGE_LANGUAGE = 216,
+	//HEADER_GC_UNUSED = 217,
+#if defined(__CHANGE_LOOK_SYSTEM__)
+	HEADER_GC_CHANGE_LOOK = 218,
 #endif
-	//HEADER_GC_UNUSED = 218,
 	//HEADER_GC_UNUSED = 219,
 	//HEADER_GC_UNUSED = 220,
 #if defined(__MAILBOX__)
@@ -661,39 +623,28 @@
 	HEADER_GC_MAILBOX_UNREAD = 225,
 #endif
 	//HEADER_GC_UNUSED = 226,
-#if defined(__CHANGED_ATTR__)
-	HEADER_GC_ITEM_SELECT_ATTR = 227,
-#endif
-#if defined(__CHANGE_LOOK_SYSTEM__)
-	HEADER_GC_CHANGE_LOOK_SET = 228,
-	HEADER_GC_CHANGE_LOOK_DEL = 229,
-	HEADER_GC_CHANGE_LOOK_FREE_SET = 230,
-	HEADER_GC_CHANGE_LOOK_FREE_DEL = 231,
-#endif
+	//HEADER_GC_UNUSED = 227,
+	//HEADER_GC_UNUSED = 228,
+	//HEADER_GC_UNUSED = 229,
+	//HEADER_GC_UNUSED = 230,
+	//HEADER_GC_UNUSED = 231,
 	//HEADER_GC_UNUSED = 232,
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	HEADER_GC_EXT_BATTLE_PASS_OPEN = 233,
-	HEADER_GC_EXT_BATTLE_PASS_GENERAL_INFO = 234,
-	HEADER_GC_EXT_BATTLE_PASS_MISSION_INFO = 235,
-	HEADER_GC_EXT_BATTLE_PASS_MISSION_UPDATE = 236,
-	HEADER_GC_EXT_BATTLE_PASS_SEND_RANKING = 237,
-#endif
-
+	//HEADER_GC_UNUSED = 233,
+	//HEADER_GC_UNUSED = 234,
+	//HEADER_GC_UNUSED = 235,
+	//HEADER_GC_UNUSED = 236,
+	//HEADER_GC_UNUSED = 237,
 #if defined(__MINI_GAME_CATCH_KING__)
 	HEADER_GC_MINI_GAME_CATCH_KING = 238,
 #endif
+
 	//HEADER_GC_UNUSED = 239,
-#if defined(__RANKING_SYSTEM__)
-	HEADER_GC_RANKING = 240,
-#endif
+	//HEADER_GC_UNUSED = 240,
 	//HEADER_GC_UNUSED = 241,
 	//HEADER_GC_UNUSED = 242,
 	//HEADER_GC_UNUSED = 243,
 	//HEADER_GC_UNUSED = 244,
-#if defined(__LOOT_FILTER_SYSTEM__)
-	HEADER_GC_LOOT_FILTER = 245,
-#endif
+	//HEADER_GC_UNUSED = 245,
 	//HEADER_GC_UNUSED = 246,
 	//HEADER_GC_UNUSED = 247,
 	//HEADER_GC_UNUSED = 248,
@@ -702,8 +653,7 @@
 	HEADER_GC_KEY_AGREEMENT_COMPLETED = 250, // 250
 	HEADER_GC_KEY_AGREEMENT = 251, // 251
 #endif
-	HEADER_GC_HANDSHAKE_OK = 252, // 252 (0xfc)
-	HEADER_GC_TIME_SYNC = 252, // legacy alias (handshake ok)
+	HEADER_GC_TIME_SYNC = 252, // 252
 	HEADER_GC_PHASE = 253, // 253
 	HEADER_GC_BINDUDP = 254, // 254
 	HEADER_GC_HANDSHAKE = 255, // 255
@@ -727,10 +677,8 @@
 	//HEADER_GG_UNUSED = 14,
 	HEADER_GG_GUILD_WAR_ZONE_MAP_INDEX = 15,
 	HEADER_GG_TRANSFER = 16,
-#if defined(__XMAS_EVENT_2008__)
 	HEADER_GG_XMAS_WARP_SANTA = 17,
 	HEADER_GG_XMAS_WARP_SANTA_REPLY = 18,
-#endif
 	HEADER_GG_RELOAD_CRC_LIST = 19,
 	HEADER_GG_LOGIN_PING = 20,
 	HEADER_GG_CHECK_CLIENT_VERSION = 21,
@@ -746,10 +694,7 @@
 	HEADER_GG_MESSENGER_BLOCK_ADD = 30,
 	HEADER_GG_MESSENGER_BLOCK_REMOVE = 31,
 #endif
-#if defined(__OFFLINE_SHOP__)
-	HEADER_GG_OFFLINE_SHOP = 33,
-	HEADER_GG_UPDATE_SELL_HISTORY = 34,
-#endif
+	HEADER_GG_LOCALE_NOTICE = 32,
 };
 
 #pragma pack(1)
@@ -768,6 +713,7 @@
 	BYTE bEmpire;
 	long lMapIndex;
 	BYTE bChannel;
+	BYTE bLanguage;
 } TPacketGGLogin;
 
 typedef struct SPacketGGLogout
@@ -788,9 +734,14 @@
 	BYTE bHeader;
 	long lSize;
 	char szArg[CHAT_MAX_LEN + 1];
-	bool bBigFont;
 } TPacketGGNotice;
 
+typedef struct SPacketGGBigNotice
+{
+	BYTE bHeader;
+	long lSize;
+} TPacketGGBigNotice;
+
 typedef struct SPacketGGMonarchNotice
 {
 	BYTE bHeader;
@@ -863,12 +814,8 @@
 #if defined(__MESSENGER_BLOCK_SYSTEM__)
 	char szName[CHARACTER_NAME_MAX_LEN + 1];
 #endif
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-	char szCountry[COUNTRY_NAME_MAX_LEN + 1];
-#endif
 } TPacketGGShout;
 
-#if defined(__XMAS_EVENT_2008__)
 typedef struct SPacketGGXmasWarpSanta
 {
 	BYTE bHeader;
@@ -881,7 +828,6 @@
 	BYTE bHeader;
 	BYTE bChannel;
 } TPacketGGXmasWarpSantaReply;
-#endif
 
 typedef struct SPacketGGMessenger
 {
@@ -976,9 +922,8 @@
 	char login[LOGIN_MAX_LEN + 1];
 	char passwd[PASSWD_MAX_LEN + 1];
 	DWORD adwClientKey[4];
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-	char country[COUNTRY_NAME_MAX_LEN + 1];
-#endif
+	char hwid[HWID_MAX_NUM + 1];
+	BYTE bLanguage;
 } TPacketCGLogin3;
 
 typedef struct packet_login_key
@@ -991,9 +936,6 @@
 {
 	BYTE header;
 	BYTE index;
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-	char country[COUNTRY_NAME_MAX_LEN + 1];
-#endif
 } TPacketCGPlayerSelect;
 
 typedef struct command_player_delete
@@ -1014,6 +956,7 @@
 	BYTE Int;
 	BYTE Str;
 	BYTE Dex;
+	char pin[PIN_CODE_LENGTH + 1];
 } TPacketCGPlayerCreate;
 
 typedef struct command_player_create_success
@@ -1248,14 +1191,6 @@
 	char msg[64 + 1];
 } TPacketCGQuestInputString;
 
-#if defined(__OX_RENEWAL__)
-typedef struct command_quest_input_long_string
-{
-	BYTE header;
-	char msg[128 + 1];
-} TPacketCGQuestInputLongString;
-#endif
-
 typedef struct command_quest_confirm
 {
 	BYTE header;
@@ -1269,7 +1204,7 @@
 typedef struct packet_quest_confirm
 {
 	BYTE header;
-	char msg[128 + 1];
+	char msg[64 + 1];
 	long timeout;
 	DWORD requestPID;
 } TPacketGCQuestConfirm;
@@ -1311,6 +1246,17 @@
 	WORD port;
 } TPacketGCBindUDP;
 
+enum
+{
+	LOGIN_FAILURE_ALREADY = 1,
+	LOGIN_FAILURE_ID_NOT_EXIST = 2,
+	LOGIN_FAILURE_WRONG_PASS = 3,
+	LOGIN_FAILURE_FALSE = 4,
+	LOGIN_FAILURE_NOT_TESTOR = 5,
+	LOGIN_FAILURE_NOT_TEST_TIME = 6,
+	LOGIN_FAILURE_FULL = 7
+};
+
 typedef struct packet_login_success
 {
 	BYTE bHeader;
@@ -1330,38 +1276,6 @@
 	BOOL bState;
 } TPacketGCAuthSuccess;
 
-enum ELoginFailure
-{
-	LOGIN_FAILURE_NONE,
-	LOGIN_FAILURE_ALREADY,
-	LOGIN_FAILURE_NOID,
-	LOGIN_FAILURE_WRONGPWD,
-	LOGIN_FAILURE_FULL,
-	LOGIN_FAILURE_SHUTDOWN,
-	LOGIN_FAILURE_REPAIR,
-	LOGIN_FAILURE_BLOCK,
-	LOGIN_FAILURE_WRONGMAT,
-	LOGIN_FAILURE_QUIT,
-	LOGIN_FAILURE_BESAMEKEY,
-	LOGIN_FAILURE_NOTAVAIL,
-	LOGIN_FAILURE_BLKLOGIN,
-	LOGIN_FAILURE_WEBBLK,
-	LOGIN_FAILURE_BADSCLID,
-	LOGIN_FAILURE_AGELIMIT,
-	LOGIN_FAILURE_CONFIRM,
-	LOGIN_FAILURE_INACTIVE,
-	LOGIN_FAILURE_UNMIGRATION,
-	LOGIN_FAILURE_MPROCESSING,
-	LOGIN_FAILURE_LOCKED,
-	LOGIN_FAILURE_BACKENDERR,
-	LOGIN_FAILURE_INTEGRTING,
-	LOGIN_FAILURE_COUNTRYERR,
-	LOGIN_FAILURE_IOVATION,
-	LOGIN_FAILURE_TNTERR,
-	LOGIN_FAILURE_SERVER_CLOSED,
-	LOGIN_FAILURE_SERVER_GRADE,
-};
-
 typedef struct packet_login_failure
 {
 	BYTE header;
@@ -1392,7 +1306,6 @@
 #if defined(__ACCE_COSTUME_SYSTEM__)
 	CHR_EQUIPPART_ACCE,
 #endif
-	CHR_EQUIPPART_AURA,
 
 	CHR_EQUIPPART_NUM,
 };
@@ -1414,14 +1327,11 @@
 
 	BYTE bType;
 	WORD wRaceNum;
-#if defined(__RACE_SWAP__)
-	DWORD dwEventRaceNum;
-#endif
 	BYTE bMovingSpeed;
 	BYTE bAttackSpeed;
 
 	BYTE bStateFlag;
-	DWORD dwAffectFlag[3]; // ȿ
+	DWORD dwAffectFlag[2]; // ȿ
 } TPacketGCCharacterAdd;
 
 typedef struct packet_char_additional_info
@@ -1429,45 +1339,65 @@
 	BYTE header;
 	DWORD dwVID;
 	char name[CHARACTER_NAME_MAX_LEN + 1];
-	DWORD adwPart[CHR_EQUIPPART_NUM];
+	WORD awPart[CHR_EQUIPPART_NUM];
 	BYTE bEmpire;
 	DWORD dwGuildID;
 	DWORD dwLevel;
 #if defined(__CONQUEROR_LEVEL__)
 	DWORD dwConquerorLevel;
 #endif
-	short sAlignment; // ġ
+	short sAlignment;
 	BYTE bPKMode;
 	DWORD dwMountVnum;
 #if defined(__QUIVER_SYSTEM__)
 	DWORD dwArrow;
 #endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	WORD wRefineElementAffectType;
-#endif
 #if defined(__GUILD_LEADER_GRADE_NAME__)
 	BYTE bGuildLeaderGrade;
 #endif
-#ifdef __GROWTH_PET_SYSTEM__
-	BYTE bCharacterSize;
+#if defined(__GENDER_ALIGNMENT__)
+	BYTE bJob;
+#endif
+#if defined(__SKILL_COLOR_SYSTEM__)
+	DWORD dwSkillColor[ESkillColorLength::MAX_SKILL_COUNT + ESkillColorLength::MAX_BUFF_COUNT][ESkillColorLength::MAX_EFFECT_COUNT];
 #endif
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-	char szCountry[COUNTRY_NAME_MAX_LEN + 1];
+	BYTE bLanguage;
+#ifdef __GROWTH_PET_SYSTEM__
+	BYTE	bCharacterSize;
 #endif
 } TPacketGCCharacterAdditionalInfo;
 
-typedef struct packet_update_char
+/*
+typedef struct packet_update_char_old
 {
 	BYTE header;
 	DWORD dwVID;
 
-	DWORD adwPart[CHR_EQUIPPART_NUM];
+	WORD awPart[CHR_EQUIPPART_NUM];
+	BYTE bMovingSpeed;
+	BYTE bAttackSpeed;
+
+	BYTE bStateFlag;
+	DWORD dwAffectFlag[2];
+
+	DWORD dwGuildID;
+	short sAlignment;
+	BYTE bPKMode;
+	DWORD dwMountVnum;
+} TPacketGCCharacterUpdateOld;
+*/
+
+typedef struct packet_update_char
+{
+	BYTE header;
+	DWORD dwVID;
 
+	WORD awPart[CHR_EQUIPPART_NUM];
 	BYTE bMovingSpeed;
 	BYTE bAttackSpeed;
 
 	BYTE bStateFlag;
-	DWORD dwAffectFlag[3];
+	DWORD dwAffectFlag[2];
 
 	DWORD dwGuildID;
 	short sAlignment;
@@ -1480,15 +1410,14 @@
 #if defined(__QUIVER_SYSTEM__)
 	DWORD dwArrow;
 #endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	WORD wRefineElementAffectType;
-#endif
 #if defined(__GUILD_LEADER_GRADE_NAME__)
 	BYTE bGuildLeaderGrade;
 #endif
-#if defined(__LEFT_SEAT__)
-	bool bLeftSeat;
+	//WORD wRaceNum;
+#if defined(__SKILL_COLOR_SYSTEM__)
+	DWORD dwSkillColor[ESkillColorLength::MAX_SKILL_COUNT + ESkillColorLength::MAX_BUFF_COUNT][ESkillColorLength::MAX_EFFECT_COUNT];
 #endif
+	BYTE bLanguage;
 } TPacketGCCharacterUpdate;
 
 typedef struct packet_del_char
@@ -1504,15 +1433,6 @@
 	BYTE type;
 	DWORD id;
 	BYTE bEmpire;
-#if defined(__LOCALE_CLIENT__)
-	bool bCanFormat;
-#endif
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-	char szCountry[COUNTRY_NAME_MAX_LEN + 1];
-#endif
-#if defined(__LOCALE_CLIENT__)
-	packet_chat() : bCanFormat(true) {}
-#endif
 } TPacketGCChat;
 
 typedef struct packet_whisper //  Ŷ
@@ -1521,15 +1441,6 @@
 	WORD wSize;
 	BYTE bType;
 	char szNameFrom[CHARACTER_NAME_MAX_LEN + 1];
-#if defined(__LOCALE_CLIENT__)
-	bool bCanFormat;
-#endif
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-	char szCountry[COUNTRY_NAME_MAX_LEN + 1];
-#endif
-#if defined(__LOCALE_CLIENT__)
-	packet_whisper() : bCanFormat(true) {}
-#endif
 } TPacketGCWhisper;
 
 typedef struct packet_main_character
@@ -1582,8 +1493,8 @@
 
 typedef struct packet_points
 {
-	BYTE bHeader;
-	POINT_VALUE lPoints[POINT_MAX_NUM];
+	BYTE header;
+	long long points[POINT_MAX_NUM];
 } TPacketGCPoints;
 
 typedef struct packet_skill_level
@@ -1594,11 +1505,11 @@
 
 typedef struct packet_point_change
 {
-	BYTE bHeader;
+	int header;
 	DWORD dwVID;
-	POINT_TYPE wType;
-	POINT_VALUE lAmount;
-	POINT_VALUE lValue;
+	BYTE type;
+	long long amount;
+	long long value;
 } TPacketGCPointChange;
 
 typedef struct packet_stun
@@ -1611,59 +1522,44 @@
 {
 	BYTE header;
 	DWORD vid;
-	BYTE dialog_type;
-	long map_index;
-	packet_dead() : dialog_type(DEAD_DIALOG_NORMAL), map_index(0) {}
 } TPacketGCDead;
 
-typedef struct packet_item_set_empty
+struct TPacketGCItemDelDeprecated
 {
-	BYTE bHeader;
+	BYTE header;
 	TItemPos Cell;
-	DWORD dwVnum;
-	DWORD dwCount;
-	long alSockets[ITEM_SOCKET_MAX_NUM];
-	TPlayerItemAttribute aAttr[ITEM_ATTRIBUTE_MAX_NUM];
+	DWORD vnum;
+	WORD count;
 #if defined(__CHANGE_LOOK_SYSTEM__)
-	DWORD dwTransmutationVnum;
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	TPlayerItemRefineElement RefineElement;
+	DWORD transmutation;
 #endif
+	long alSockets[ITEM_SOCKET_MAX_NUM];
 #if defined(__ITEM_APPLY_RANDOM__)
 	TPlayerItemAttribute aApplyRandom[ITEM_APPLY_MAX_NUM];
 #endif
-#if defined(__SET_ITEM__)
-	BYTE bSetValue;
-#endif
-} TPacketGCItemSetEmpty;
+	TPlayerItemAttribute aAttr[ITEM_ATTRIBUTE_MAX_NUM];
+};
 
 typedef struct packet_item_set
 {
-	BYTE bHeader;
+	BYTE header;
 	TItemPos Cell;
-	DWORD dwVnum;
-	DWORD dwCount;
-	DWORD dwFlags;
-	DWORD dwAntiFlags;
-	bool bHighLight;
+	DWORD vnum;
+	WORD count;
 #if defined(__SOUL_BIND_SYSTEM__)
-	long lSealDate;
+	long soulbind;
 #endif
-	long alSockets[ITEM_SOCKET_MAX_NUM];
-	TPlayerItemAttribute aAttr[ITEM_ATTRIBUTE_MAX_NUM];
 #if defined(__CHANGE_LOOK_SYSTEM__)
-	DWORD dwTransmutationVnum;
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	TPlayerItemRefineElement RefineElement;
+	DWORD transmutation;
 #endif
+	DWORD flags;
+	DWORD anti_flags;
+	bool highlight;
+	long alSockets[ITEM_SOCKET_MAX_NUM];
 #if defined(__ITEM_APPLY_RANDOM__)
 	TPlayerItemAttribute aApplyRandom[ITEM_APPLY_MAX_NUM];
 #endif
-#if defined(__SET_ITEM__)
-	BYTE bSetValue;
-#endif
+	TPlayerItemAttribute aAttr[ITEM_ATTRIBUTE_MAX_NUM];
 } TPacketGCItemSet;
 
 typedef struct packet_item_del
@@ -1690,26 +1586,20 @@
 
 typedef struct packet_item_update
 {
-	BYTE bHeader;
+	BYTE header;
 	TItemPos Cell;
-	DWORD dwCount;
+	WORD count;
 #if defined(__SOUL_BIND_SYSTEM__)
-	long lSealDate;
+	long soulbind;
 #endif
-	long alSockets[ITEM_SOCKET_MAX_NUM];
-	TPlayerItemAttribute aAttr[ITEM_ATTRIBUTE_MAX_NUM];
 #if defined(__CHANGE_LOOK_SYSTEM__)
-	DWORD dwTransmutationVnum;
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	TPlayerItemRefineElement RefineElement;
+	DWORD transmutation;
 #endif
+	long alSockets[ITEM_SOCKET_MAX_NUM];
 #if defined(__ITEM_APPLY_RANDOM__)
 	TPlayerItemAttribute aApplyRandom[ITEM_APPLY_MAX_NUM];
 #endif
-#if defined(__SET_ITEM__)
-	BYTE bSetValue;
-#endif
+	TPlayerItemAttribute aAttr[ITEM_ATTRIBUTE_MAX_NUM];
 } TPacketGCItemUpdate;
 
 typedef struct packet_item_ground_add
@@ -1723,16 +1613,12 @@
 #endif
 
 	BYTE bHeader;
-	long lX, lY, lZ;
+	long x, y, z;
 	DWORD dwVID;
 	DWORD dwVnum;
-#if defined(__SET_ITEM__)
-	BYTE bSetValue;
-#endif
-
 #if defined(__ITEM_DROP_RENEWAL__)
-	long alSockets[ITEM_SOCKET_MAX_NUM];
-	TPlayerItemAttribute aAttrs[ITEM_ATTRIBUTE_MAX_NUM];
+	long alSockets[ITEM_SOCKET_MAX_NUM]; // 3
+	TPlayerItemAttribute aAttrs[ITEM_ATTRIBUTE_MAX_NUM]; // 7
 #endif
 } TPacketGCItemGroundAdd;
 
@@ -1779,102 +1665,68 @@
 
 enum EPacketShopSubHeaders
 {
-	SHOP_SUBHEADER_GC_NONE,
 	SHOP_SUBHEADER_GC_START,
 	SHOP_SUBHEADER_GC_END,
 	SHOP_SUBHEADER_GC_UPDATE_ITEM,
 	SHOP_SUBHEADER_GC_UPDATE_PRICE,
 	SHOP_SUBHEADER_GC_OK,
 	SHOP_SUBHEADER_GC_NOT_ENOUGH_MONEY,
+#if defined(__CHEQUE_SYSTEM__)
+	SHOP_SUBHEADER_GC_NOT_ENOUGH_CHEQUE,
+#endif
 	SHOP_SUBHEADER_GC_SOLDOUT,
 	SHOP_SUBHEADER_GC_INVENTORY_FULL,
 	SHOP_SUBHEADER_GC_INVALID_POS,
 	SHOP_SUBHEADER_GC_SOLD_OUT,
 	SHOP_SUBHEADER_GC_START_EX,
 	SHOP_SUBHEADER_GC_NOT_ENOUGH_MONEY_EX,
-	SHOP_SUBHEADER_GC_NOT_ENOUGH_BP,
-	SHOP_SUBHEADER_GC_EXCEED_LIMIT_TODAY,
-#if defined(__MYSHOP_DECO__)
-	SHOP_SUBHEADER_GC_MYPRIV_SHOP_OPEN,
+#if defined(__CHEQUE_SYSTEM__)
+	SHOP_SUBHEADER_GC_NOT_ENOUGH_CHEQUE_EX,
 #endif
-	SHOP_SUBHEADER_GC_NOT_ENOUGH_10TH_COIN,
-	SHOP_SUBHEADER_GC_LIMITED_PURCHASE_OVER,
-	SHOP_SUBHEADER_GC_LIMITED_DATA_LOADING,
-	SHOP_SUBHEADER_GC_UNK_19,
-	SHOP_SUBHEADER_GC_UNK_20,
-	SHOP_SUBHEADER_GC_UNK_21,
-	SHOP_SUBHEADER_GC_NOT_ENOUGH_MEDAL_OF_HONOR,
-	SHOP_SUBHEADER_GC_NOT_ENOUGH_GUILD_LEVEL,
-	SHOP_SUBHEADER_GC_NOT_ENOUGH_BNW,
 #if defined(__SHOPEX_RENEWAL__)
 	SHOP_SUBHEADER_GC_NOT_ENOUGH_ITEM,
+	SHOP_SUBHEADER_GC_NOT_ENOUGH_EXP,
 #endif
 };
 
 struct packet_shop_item
 {
-	DWORD dwVnum;
-	DWORD dwCount;
-	DWORD dwPrice;
+	DWORD vnum;
+	DWORD price;
 #if defined(__CHEQUE_SYSTEM__)
-	DWORD dwCheque;
+	DWORD price_cheque;
 #endif
-	BYTE bDisplayPos;
-	long alSockets[ITEM_SOCKET_MAX_NUM];
-	TPlayerItemAttribute aAttr[ITEM_ATTRIBUTE_MAX_NUM];
+	WORD count;
 #if defined(__CHANGE_LOOK_SYSTEM__)
-	DWORD dwTransmutationVnum;
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	TPlayerItemRefineElement RefineElement;
+	DWORD transmutation;
 #endif
+	BYTE display_pos;
+	long alSockets[ITEM_SOCKET_MAX_NUM];
 #if defined(__ITEM_APPLY_RANDOM__)
 	TPlayerItemAttribute aApplyRandom[ITEM_APPLY_MAX_NUM];
 #endif
-#if defined(__SET_ITEM__)
-	BYTE bSetValue;
-#endif
+	TPlayerItemAttribute aAttr[ITEM_ATTRIBUTE_MAX_NUM];
 #if defined(__SHOPEX_RENEWAL__)
-	BYTE bPriceType;
-	DWORD dwPriceVnum;
-#endif
+	DWORD price_type = 1;
+	DWORD price_vnum = 0;
 	packet_shop_item()
 	{
-#if defined(__CHEQUE_SYSTEM__)
-		dwCheque = 0;
-#endif
 		memset(&alSockets, 0, sizeof(alSockets));
-		memset(&aAttr, 0, sizeof(aAttr));
-#if defined(__CHANGE_LOOK_SYSTEM__)
-		dwTransmutationVnum = 0;
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-		memset(&RefineElement, 0, sizeof(RefineElement));
-#endif
 #if defined(__ITEM_APPLY_RANDOM__)
 		memset(&aApplyRandom, 0, sizeof(aApplyRandom));
 #endif
-#if defined(__SET_ITEM__)
-		bSetValue = 0;
-#endif
-#if defined(__SHOPEX_RENEWAL__)
-		bPriceType = SHOP_COIN_TYPE_GOLD;
-		dwPriceVnum = 0;
-#endif
+		memset(&aAttr, 0, sizeof(aAttr));
 	}
+#endif
 };
 
 typedef struct packet_shop_start
 {
 	DWORD owner_vid;
+	struct packet_shop_item	items[SHOP_HOST_ITEM_MAX_NUM];
 #if defined(__MYSHOP_DECO__)
 	BYTE shop_tab_count;
 #endif
-#if defined(__MYSHOP_EXPANSION__)
-	struct packet_shop_item items[SHOP_HOST_ITEM_MAX];
-#else
-	struct packet_shop_item items[SHOP_HOST_ITEM_MAX_NUM];
-#endif
 } TPacketGCShopStart;
 
 typedef struct packet_shop_start_ex //  TSubPacketShopTab* shop_tabs  .
@@ -1899,7 +1751,7 @@
 {
 	int iPrice;
 #if defined(__CHEQUE_SYSTEM__)
-	int iCheque;
+	int iPriceCheque;
 #endif
 } TPacketGCShopUpdatePrice;
 
@@ -1910,7 +1762,7 @@
 	BYTE subheader;
 } TPacketGCShop;
 
-typedef struct packet_exchange
+struct packet_exchange
 {
 	BYTE header;
 	BYTE sub_header;
@@ -1920,20 +1772,14 @@
 	DWORD arg3; // count
 	TItemPos arg4;
 	long alSockets[ITEM_SOCKET_MAX_NUM];
-	TPlayerItemAttribute aAttr[ITEM_ATTRIBUTE_MAX_NUM];
-#if defined(__CHANGE_LOOK_SYSTEM__)
-	DWORD dwTransmutationVnum;
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	TPlayerItemRefineElement RefineElement;
-#endif
 #if defined(__ITEM_APPLY_RANDOM__)
 	TPlayerItemAttribute aApplyRandom[ITEM_APPLY_MAX_NUM];
 #endif
-#if defined(__SET_ITEM__)
-	BYTE bSetItem;
+	TPlayerItemAttribute aAttr[ITEM_ATTRIBUTE_MAX_NUM];
+#if defined(__CHANGE_LOOK_SYSTEM__)
+	DWORD dwTransmutation;
 #endif
-} TPacketGCExchange;
+};
 
 enum EPacketTradeSubHeaders
 {
@@ -2094,48 +1940,31 @@
 	BYTE header;
 	DWORD dwVID;
 	BYTE bHPPercent;
-#if defined(__VIEW_TARGET_HP__) || defined(__DEFENSE_WAVE__)
-	int iMinHP;
-	int iMaxHP;
-	bool bAlliance;
+#if defined(__VIEW_TARGET_DECIMAL_HP__)
+	int64_t iMinHP;
+	int64_t iMaxHP;
 #endif
 #if defined(__ELEMENT_SYSTEM__)
 	BYTE bElement[MOB_ELEMENT_MAX_NUM];
 #endif
-	packet_target() : dwVID(0), bHPPercent(0)
-	{
-#if defined(__VIEW_TARGET_HP__) || defined(__DEFENSE_WAVE__)
-		iMinHP = 0;
-		iMaxHP = 0;
-		bAlliance = false;
-#endif
-#if defined(__ELEMENT_SYSTEM__)
-		memset(&bElement, 0, sizeof(bElement));
-#endif
-	}
 } TPacketGCTarget;
 
 #if defined(__SEND_TARGET_INFO__)
-typedef struct SPacketGCTargetDropInfo
-{
-	DWORD dwVnum;
-	BYTE bCount;
-} TPacketGCTargetDropInfo;
-
-typedef struct SPacketGCTargetInfo
+typedef struct packet_target_info
 {
 	BYTE bHeader;
-	WORD wSize;
-	DWORD dwRaceVnum;
+	BYTE bIndex;
 	DWORD dwVID;
-	bool bDropMetinStone;
+	DWORD dwRaceVnum;
+	DWORD dwVnum;
+	WORD wCount;
 } TPacketGCTargetInfo;
 
-typedef struct SPacketCGTargetInfo
+typedef struct packet_target_info_load
 {
-	BYTE bHeader;
+	BYTE header;
 	DWORD dwVID;
-} TPacketCGTargetInfo;
+} TPacketCGTargetInfoLoad;
 #endif
 
 typedef struct packet_warp
@@ -2158,109 +1987,163 @@
 	WORD size;
 	WORD index;
 #if defined(__QUEST_RENEWAL__)
-	BYTE type;
-	bool is_confirmed;
+	WORD c_index;
 #endif
 	BYTE flag;
 };
 
-typedef struct command_safebox_checkout
-{
-	BYTE bHeader;
-	BYTE bSafePos;
-	TItemPos ItemPos;
-} TPacketCGSafeboxCheckout;
-
-typedef struct command_safebox_checkin
-{
-	BYTE bHeader;
-	BYTE bSafePos;
-	TItemPos ItemPos;
-} TPacketCGSafeboxCheckin;
-
-///////////////////////////////////////////////////////////////////////////////////
-// Messenger
-
-enum EMessengerConnectedState
-{
-	MESSENGER_CONNECTED_STATE_OFFLINE,
-	MESSENGER_CONNECTED_STATE_ONLINE
-};
-
-enum EGCMessengerSubHeader
+enum
 {
-	MESSENGER_SUBHEADER_GC_LIST,
-	MESSENGER_SUBHEADER_GC_LOGIN,
-	MESSENGER_SUBHEADER_GC_LOGOUT,
-	MESSENGER_SUBHEADER_GC_INVITE,
-#if defined(__MESSENGER_BLOCK_SYSTEM__)
-	MESSENGER_SUBHEADER_GC_BLOCK_LIST,
-	MESSENGER_SUBHEADER_GC_BLOCK_LOGIN,
-	MESSENGER_SUBHEADER_GC_BLOCK_LOGOUT,
-#endif
 #if defined(__MESSENGER_GM__)
 	MESSENGER_SUBHEADER_GC_GM_LIST,
 	MESSENGER_SUBHEADER_GC_GM_LOGIN,
 	MESSENGER_SUBHEADER_GC_GM_LOGOUT,
 #endif
+#if defined(__MESSENGER_BLOCK_SYSTEM__)
+	MESSENGER_SUBHEADER_GC_BLOCK_LIST,
+	MESSENGER_SUBHEADER_GC_BLOCK_LOGIN,
+	MESSENGER_SUBHEADER_GC_BLOCK_LOGOUT,
+	MESSENGER_SUBHEADER_GC_BLOCK_INVITE, //not used
+#endif
+	MESSENGER_SUBHEADER_GC_LIST,
+	MESSENGER_SUBHEADER_GC_LOGIN,
+	MESSENGER_SUBHEADER_GC_LOGOUT,
+	MESSENGER_SUBHEADER_GC_INVITE,
 };
 
 typedef struct packet_messenger
 {
-	BYTE bHeader;
-	WORD wSize;
-	BYTE bSubHeader;
+	BYTE header;
+	WORD size;
+	BYTE subheader;
 } TPacketGCMessenger;
 
-typedef struct packet_messenger_list
+typedef struct packet_messenger_guild_list
 {
-	packet_messenger_list() :
-		bConnected(MESSENGER_CONNECTED_STATE_OFFLINE)
-#if defined(__MESSENGER_DETAILS__)
-		, dwLastPlayTime(0)
-#endif
-	{
-	}
-	BYTE bConnected;
-	char szName[CHARACTER_NAME_MAX_LEN + 1];
-#if defined(__MESSENGER_DETAILS__)
-	DWORD dwLastPlayTime;
-#if defined(__MULTI_LANGUAGE_SYSTEM__)
-	char szCountry[COUNTRY_NAME_MAX_LEN + 1]{};
+	BYTE connected;
+	BYTE length;
+	//char login[LOGIN_MAX_LEN+1];
+} TPacketGCMessengerGuildList;
+
+typedef struct packet_messenger_guild_login
+{
+	BYTE length;
+	//char login[LOGIN_MAX_LEN+1];
+} TPacketGCMessengerGuildLogin;
+
+typedef struct packet_messenger_guild_logout
+{
+	BYTE length;
+	//char login[LOGIN_MAX_LEN+1];
+} TPacketGCMessengerGuildLogout;
+
+typedef struct packet_messenger_list_offline
+{
+	BYTE connected; // always 0
+	BYTE length;
+} TPacketGCMessengerListOffline;
+
+typedef struct packet_messenger_list_online
+{
+	BYTE connected; // always 1
+	BYTE length;
+} TPacketGCMessengerListOnline;
+
+#if defined(__MESSENGER_GM__)
+typedef struct packet_messenger_gm_list_offline
+{
+	BYTE connected; // always 0
+	BYTE length;
+} TPacketGCMessengerGMListOffline;
+
+typedef struct packet_messenger_gm_list_online
+{
+	BYTE connected; // always 1
+	BYTE length;
+} TPacketGCMessengerGMListOnline;
 #endif
+
+#if defined(__MESSENGER_BLOCK_SYSTEM__)
+typedef struct packet_messenger_block_list_offline
+{
+	BYTE connected; // always 0
+	BYTE length;
+} TPacketGCMessengerBlockListOffline;
+
+typedef struct packet_messenger_block_list_online
+{
+	BYTE connected; // always 1
+	BYTE length;
+} TPacketGCMessengerBlockListOnline;
 #endif
-} TPacketGCMessengerList;
 
-enum ECGMessengerSubHeader
+enum
 {
-	MESSENGER_SUBHEADER_CG_ADD_BY_VID,
-	MESSENGER_SUBHEADER_CG_ADD_BY_NAME,
-	MESSENGER_SUBHEADER_CG_REMOVE,
 #if defined(__MESSENGER_BLOCK_SYSTEM__)
 	MESSENGER_SUBHEADER_CG_BLOCK_ADD_BY_VID,
 	MESSENGER_SUBHEADER_CG_BLOCK_ADD_BY_NAME,
 	MESSENGER_SUBHEADER_CG_BLOCK_REMOVE,
 #endif
+	MESSENGER_SUBHEADER_CG_ADD_BY_VID,
+	MESSENGER_SUBHEADER_CG_ADD_BY_NAME,
+	MESSENGER_SUBHEADER_CG_REMOVE,
+	MESSENGER_SUBHEADER_CG_INVITE_ANSWER,
 };
 
 typedef struct command_messenger
 {
-	BYTE bHeader;
-	BYTE bSubHeader;
+	BYTE header;
+	BYTE subheader;
 } TPacketCGMessenger;
 
 typedef struct command_messenger_add_by_vid
 {
-	DWORD dwVID;
+	DWORD vid;
 } TPacketCGMessengerAddByVID;
 
+typedef struct command_messenger_add_by_name
+{
+	BYTE length;
+	//char login[LOGIN_MAX_LEN+1];
+} TPacketCGMessengerAddByName;
+
+typedef struct command_messenger_remove
+{
+	char login[LOGIN_MAX_LEN + 1];
+	//DWORD account;
+} TPacketCGMessengerRemove;
+
 #if defined(__MESSENGER_BLOCK_SYSTEM__)
 typedef struct command_messenger_add_block_by_vid
 {
-	DWORD dwVID;
+	DWORD vid;
 } TPacketCGMessengerAddBlockByVID;
+
+typedef struct command_messenger_add_block_by_name
+{
+	BYTE length;
+} TPacketCGMessengerAddBlockByName;
+
+typedef struct command_messenger_remove_block
+{
+	char login[LOGIN_MAX_LEN + 1];
+} TPacketCGMessengerRemoveBlock;
 #endif
 
+typedef struct command_safebox_checkout
+{
+	BYTE bHeader;
+	BYTE bSafePos;
+	TItemPos ItemPos;
+} TPacketCGSafeboxCheckout;
+
+typedef struct command_safebox_checkin
+{
+	BYTE bHeader;
+	BYTE bSafePos;
+	TItemPos ItemPos;
+} TPacketCGSafeboxCheckin;
+
 ///////////////////////////////////////////////////////////////////////////////////
 // Party
 typedef struct command_party_parameter
@@ -2275,6 +2158,22 @@
 	BYTE bDistributeMode;
 } TPacketGCPartyParameter;
 
+#if defined(__WJ_SHOW_PARTY_ON_MINIMAP__)
+struct TPartyPosition
+{
+	DWORD dwPID;
+	long lX;
+	long lY;
+	float fRot;
+};
+
+typedef struct SPacketGCPartyPosition
+{
+	BYTE bHeader;
+	WORD wSize;
+} TPacketGCPartyPosition;
+#endif
+
 typedef struct packet_party_add
 {
 	BYTE header;
@@ -2282,8 +2181,6 @@
 	char name[CHARACTER_NAME_MAX_LEN + 1];
 #if defined(__WJ_SHOW_PARTY_ON_MINIMAP__)
 	long mapIdx;
-#endif
-#if defined(__PARTY_CHANNEL_FIX__)
 	BYTE channel;
 #endif
 } TPacketGCPartyAdd;
@@ -2314,10 +2211,6 @@
 	BYTE role;
 	BYTE percent_hp;
 	short affects[7];
-#if defined(__WJ_SHOW_PARTY_ON_MINIMAP__)
-	long x;
-	long y;
-#endif
 } TPacketGCPartyUpdate;
 
 typedef struct packet_party_remove
@@ -2333,12 +2226,17 @@
 	DWORD vid;
 #if defined(__WJ_SHOW_PARTY_ON_MINIMAP__)
 	long mapIdx;
-#endif
-#if defined(__PARTY_CHANNEL_FIX__)
 	BYTE channel;
 #endif
 } TPacketGCPartyLink;
 
+typedef struct packet_party_unlink
+{
+	BYTE header;
+	DWORD pid;
+	DWORD vid;
+} TPacketGCPartyUnlink;
+
 typedef struct command_party_remove
 {
 	BYTE header;
@@ -2586,39 +2484,6 @@
 	FISHING_SUBHEADER_GC_FISH,
 };
 
-#if defined(__FISHING_GAME__)
-enum EFishingGameSubHeader
-{
-	FISHING_GAME_SUBHEADER_OPEN,
-	FISHING_GAME_SUBHEADER_GOAL,
-	FISHING_GAME_SUBHEADER_QUIT,
-};
-
-enum EFishingGameMisc
-{
-	FISHING_GAME_DURATION = 15,
-};
-
-typedef struct SPacketGCFishingGame
-{
-	SPacketGCFishingGame(const BYTE bSubHeader, const BYTE bLevel = 0) :
-		bHeader(HEADER_GC_FISHING_GAME),
-		bSubHeader(bSubHeader),
-		bLevel(bLevel)
-	{}
-	BYTE bHeader;
-	BYTE bSubHeader;
-	BYTE bLevel;
-} TPacketGCFishingGame;
-
-typedef struct SPacketCGFishingGame
-{
-	BYTE bHeader;
-	BYTE bSubHeader;
-	BYTE bGoals;
-} TPacketCGFishingGame;
-#endif
-
 typedef struct command_give_item
 {
 	BYTE byHeader;
@@ -2667,29 +2532,16 @@
 {
 	BYTE bHeader;
 	char szSign[SHOP_SIGN_MAX_LEN + 1];
-	BYTE bCount; // Count of TShopItemTable
+	WORD wCount;
 } TPacketCGMyShop;
 
 #if defined(__MYSHOP_DECO__)
-typedef struct SPacketGCMyPrivShopOpen
-{
-	BYTE bHeader;
-	bool bCashItem;
-	BYTE bTabCount;
-} TPacketGCMyPrivShopOpen;
-
-typedef struct SPacketCGMyShopDecoState
-{
-	BYTE bHeader;
-	BYTE bState;
-} TPacketCGMyShopDecoState;
-
-typedef struct SPacketCGMyShopDecoAdd
+typedef struct SPacketCGMyShopDeco
 {
 	BYTE bHeader;
 	BYTE bType;
 	DWORD dwPolyVnum;
-} TPacketCGMyShopDecoAdd;
+} TPacketCGMyShopDeco;
 #endif
 
 typedef struct SPacketGCTime
@@ -2741,9 +2593,6 @@
 	int cost; // ҿ 
 	int prob; // Ȯ
 	TRefineMaterial materials[REFINE_MATERIAL_MAX_NUM];
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	TPlayerItemRefineElement RefineElement;
-#endif
 #if defined(__ITEM_APPLY_RANDOM__)
 	TPlayerItemAttribute aApplyRandom[ITEM_APPLY_MAX_NUM];
 #endif
@@ -2765,24 +2614,11 @@
 	// array of TNPCPosition
 } TPacketGCNPCPosition;
 
-enum ESpecialEffectType
-{
-	SE_TYPE_NORMAL,
-	SE_TYPE_POSITION,
-};
-
 typedef struct SPacketGCSpecialEffect
 {
-	BYTE bHeader;
-	BYTE bEffectNum;
-	DWORD dwVID;
-	BYTE bEffectType;
-	long xEffectPos, yEffectPos;
-	SPacketGCSpecialEffect()
-		: bEffectType(SE_TYPE_NORMAL)
-		, xEffectPos(0)
-		, yEffectPos(0)
-	{}
+	BYTE header;
+	BYTE type;
+	DWORD vid;
 } TPacketGCSpecialEffect;
 
 typedef struct SPacketCGChangeName
@@ -2819,32 +2655,17 @@
 	BYTE channel;
 } TPacketGCChannel;
 
-typedef struct SEquipmentItemSet
-{
-	DWORD dwVnum;
-	BYTE bCount;
-	long alSockets[ITEM_SOCKET_MAX_NUM];
-	TPlayerItemAttribute aAttr[ITEM_ATTRIBUTE_MAX_NUM];
-#if defined(__CHANGE_LOOK_SYSTEM__)
-	DWORD dwTransmutationVnum;
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	TPlayerItemRefineElement RefineElement;
-#endif
-#if defined(__ITEM_APPLY_RANDOM__)
-	TPlayerItemAttribute aApplyRandom[ITEM_APPLY_MAX_NUM];
-#endif
-#if defined(__SET_ITEM__)
-	BYTE bSetValue;
-#endif
-} TEquipmentItemSet;
-
 typedef struct pakcet_view_equip
 {
-	BYTE bHeader;
-	DWORD dwVID;
-	TEquipmentItemSet Equips[WEAR_MAX_NUM];
-} TPacketGCViewEquip;
+	BYTE header;
+	DWORD vid;
+	struct {
+		DWORD vnum;
+		WORD count;
+		long alSockets[ITEM_SOCKET_MAX_NUM];
+		TPlayerItemAttribute aAttr[ITEM_ATTRIBUTE_MAX_NUM];
+	} equips[WEAR_MAX_NUM];
+} TPacketViewEquip;
 
 typedef struct
 {
@@ -2874,6 +2695,9 @@
 	BYTE bHeader;
 	long lID;
 	long lX, lY;
+#if defined(__PRIVATESHOP_SEARCH_SYSTEM__)
+	bool bIsShopSearch;
+#endif
 } TPacketGCTargetUpdate;
 
 typedef struct
@@ -2892,7 +2716,7 @@
 {
 	BYTE bHeader;
 	DWORD dwType;
-	POINT_TYPE wApplyOn;
+	BYTE bApplyOn;
 } TPacketGCAffectRemove;
 
 typedef struct packet_lover_info
@@ -2926,15 +2750,6 @@
 } TPacketCGScriptSelectItem;
 // END_OF_SCRIPT_SELECT_ITEM
 
-#if defined(__GEM_SHOP__)
-typedef struct command_select_item_ex
-{
-	BYTE bHeader;
-	DWORD dwItemPos;
-	BYTE bType;
-} TPacketCGSelectItemEx;
-#endif
-
 typedef struct packet_damage_info
 {
 	BYTE header;
@@ -3095,7 +2910,6 @@
 	char effect_file[MAX_EFFECT_FILE_NAME];
 } TPacketGCSpecificEffect;
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
 // ȥ
 enum EDragonSoulRefineWindowRefineType
 {
@@ -3118,10 +2932,6 @@
 	DS_SUB_HEADER_REFINE_FAIL_NOT_ENOUGH_MATERIAL,
 	DS_SUB_HEADER_REFINE_FAIL_TOO_MUCH_MATERIAL,
 	DS_SUB_HEADER_REFINE_SUCCEED,
-#if defined(__DS_CHANGE_ATTR__)
-	DS_SUB_HEADER_OPEN_CHANGE_ATTR,
-	DS_SUB_HEADER_DO_CHANGE_ATTR,
-#endif
 };
 
 typedef struct SPacketCGDragonSoulRefine
@@ -3141,7 +2951,6 @@
 	BYTE bSubType;
 	TItemPos Pos;
 } TPacketGCDragonSoulRefine;
-#endif
 
 typedef struct SPacketCGStateCheck
 {
@@ -3159,179 +2968,75 @@
 } TPacketGCStateCheck;
 
 #if defined(__ACCE_COSTUME_SYSTEM__)
-enum ESubHeaderGCAcceRefine
-{
-	ACCE_REFINE_SUBHEADER_GC_CLOSE,
-	ACCE_REFINE_SUBHEADER_GC_OPEN,
-	ACCE_REFINE_SUBHEADER_GC_SET_ITEM,
-	ACCE_REFINE_SUBHEADER_GC_CLEAR_SLOT,
-	ACCE_REFINE_SUBHEADER_GC_CLEAR_ALL,
-	ACCE_REFINE_SUBHEADER_GC_CLEAR_RIGHT
-};
-
-typedef struct SSubPacketGCAcceRefineOpenClose
-{
-	BYTE bType;
-	bool bServerClose;
-} TSubPacketGCAcceRefineOpenClose;
-
-typedef struct SSubPacketGCAcceRefineSetItem
-{
-	TItemPos AttachedPos;
-	TItemPos SelectedPos;
-	TItemData Item;
-} TSubPacketGCAcceRefineSetItem;
-
-typedef struct SSubPacketGCAcceRefineClearSlot
-{
-	BYTE bSlotIndex;
-} TSubPacketGCAcceRefineClearSlot;
-
-enum ESubHeaderCGAcceRefine
+enum
 {
-	ACCE_REFINE_SUBHEADER_CG_CHECKIN,
-	ACCE_REFINE_SUBHEADER_CG_CHECKOUT,
-	ACCE_REFINE_SUBHEADER_CG_ACCEPT,
-	ACCE_REFINE_SUBHEADER_CG_CANCEL
+	ACCE_SUBHEADER_GC_OPEN = 0,
+	ACCE_SUBHEADER_GC_CLOSE,
+	ACCE_SUBHEADER_GC_ADDED,
+	ACCE_SUBHEADER_GC_REMOVED,
+	ACCE_SUBHEADER_CG_REFINED,
+	ACCE_SUBHEADER_CG_CLOSE = 0,
+	ACCE_SUBHEADER_CG_ADD,
+	ACCE_SUBHEADER_CG_REMOVE,
+	ACCE_SUBHEADER_CG_REFINE,
 };
 
-typedef struct SSubPacketCGAcceRefineCheckIn
+typedef struct SPacketAcce
 {
-	TItemPos AttachedPos;
-	TItemPos SelectedPos;
-	BYTE bType;
-} TSubPacketCGAcceRefineCheckIn;
-
-typedef struct SSubPacketCGAcceRefineCheckOut
-{
-	TItemPos SelectedPos;
-	BYTE bType;
-} TSubPacketCGAcceRefineCheckOut;
-
-typedef struct SSubPacketCGAcceRefineAccept
-{
-	BYTE bType;
-} TSubPacketCGAcceRefineAccept;
-
-typedef struct SPacketGCAcceRefine
-{
-	SPacketGCAcceRefine() : bHeader(HEADER_GC_ACCE_REFINE) {}
-	BYTE bHeader;
-	WORD wSize;
-	BYTE bSubHeader;
-} TPacketGCAcceRefine;
-
-typedef struct SPacketCGAcceRefine
-{
-	BYTE bHeader;
-	WORD wSize;
-	BYTE bSubHeader;
-} TPacketCGAcceRefine;
+	BYTE header;
+	BYTE subheader;
+	bool bWindow;
+	DWORD dwPrice;
+	BYTE bPos;
+	TItemPos tPos;
+	DWORD dwItemVnum;
+	DWORD dwMinAbs;
+	DWORD dwMaxAbs;
+} TPacketAcce;
 #endif
 
-#if defined(__AURA_COSTUME_SYSTEM__)
-enum ESubHeaderGCAuraRefine
-{
-	AURA_REFINE_SUBHEADER_GC_CLOSE,
-	AURA_REFINE_SUBHEADER_GC_OPEN,
-	AURA_REFINE_SUBHEADER_GC_SET_ITEM,
-	AURA_REFINE_SUBHEADER_GC_CLEAR_SLOT,
-	AURA_REFINE_SUBHEADER_GC_CLEAR_ALL,
-	AURA_REFINE_SUBHEADER_GC_INFO
-};
-
-typedef struct SSubPacketGCAuraRefineOpenClose
-{
-	BYTE bType;
-	bool bServerClose;
-} TSubPacketGCAuraRefineOpenClose;
-
-typedef struct SSubPacketGCAuraRefineSetItem
-{
-	TItemPos AttachedPos;
-	TItemPos SelectedPos;
-	TItemData Item;
-} TSubPacketGCAuraRefineSetItem;
-
-typedef struct SSubPacketGCAuraRefineClearSlot
-{
-	BYTE bSlotIndex;
-} TSubPacketGCAuraRefineClearSlot;
-
-typedef struct SSubPacketGCAuraRefineInfo
-{
-	BYTE bInfoType;
-	BYTE bInfoLevel;
-	BYTE bInfoExpPercent;
-} TSubPacketGCAuraRefineInfo;
-
-enum ESubHeaderCGAuraRefine
+#if defined(__CHANGE_LOOK_SYSTEM__)
+enum EChangeLookSubHeader
 {
-	AURA_REFINE_SUBHEADER_CG_CHECKIN,
-	AURA_REFINE_SUBHEADER_CG_CHECKOUT,
-	AURA_REFINE_SUBHEADER_CG_ACCEPT,
-	AURA_REFINE_SUBHEADER_CG_CANCEL
+	SUBHEADER_CHANGE_LOOK_OPEN = 0,
+	SUBHEADER_CHANGE_LOOK_CLOSE,
+	SUBHEADER_CHANGE_LOOK_ADD,
+	SUBHEADER_CHANGE_LOOK_REMOVE,
+	SUBHEADER_CHANGE_LOOK_REFINE,
 };
 
-typedef struct SSubPacketCGAuraRefineCheckIn
-{
-	TItemPos AttachedPos;
-	TItemPos SelectedPos;
-	BYTE bType;
-} TSubPacketCGAuraRefineCheckIn;
-
-typedef struct SSubPacketCGAuraRefineCheckOut
+typedef struct SPacketChangeLook
 {
-	TItemPos SelectedPos;
-	BYTE bType;
-} TSubPacketCGAuraRefineCheckOut;
-
-typedef struct SSubPacketCGAuraRefineAccept
-{
-	BYTE bType;
-} TSubPacketCGAuraRefineAccept;
-
-typedef struct SPacketGCAuraRefine
-{
-	SPacketGCAuraRefine() : bHeader(HEADER_GC_AURA_REFINE) {}
 	BYTE bHeader;
-	WORD wSize;
 	BYTE bSubHeader;
-} TPacketGCAuraRefine;
+	DWORD dwCost;
+	BYTE bPos;
+	TItemPos tPos;
+} TPacketChangeLook;
+#endif
 
-typedef struct SPacketCGAuraRefine
+#if defined(__SKILL_COLOR_SYSTEM__)
+typedef struct packet_skill_color
 {
 	BYTE bHeader;
-	WORD wSize;
-	BYTE bSubHeader;
-} TPacketCGAuraRefine;
+	BYTE bSkillSlot;
+	DWORD dwCol1;
+	DWORD dwCol2;
+	DWORD dwCol3;
+	DWORD dwCol4;
+	DWORD dwCol5;
+} TPacketCGSkillColor;
 #endif
 
 #if defined(__MINI_GAME_CATCH_KING__)
-enum EMiniGameCatchKingCGSubHeader
+enum
 {
-	CATCHKING_CG_START,
-	CATCHKING_CG_CLICK_HAND,
-	CATCHKING_CG_CLICK_CARD,
-	CATCHKING_CG_REWARD,
-#if defined(__CATCH_KING_EVENT_FLAG_RENEWAL__)
-	CATCHKING_CG_REQUEST_QUEST_FLAG,
-#endif
-};
-
-enum EMiniGameCatchKingGCSubHeader
-{
-	CATCHKING_GC_START,
-	CATCHKING_GC_SET_CARD,
-	CATCHKING_GC_RESULT_FIELD,
-	CATCHKING_GC_SET_END_CARD,
-	CATCHKING_GC_REWARD,
-#if defined(__CATCH_KING_EVENT_FLAG_RENEWAL__)
-	CATCHKING_GC_SET_CARD_PIECE_FLAG,
-	CATCHKING_GC_SET_CARD_FLAG,
-	CATCHKING_GC_SET_QUEST_FLAG,
-	CATCHKING_GC_NO_MORE_GAIN,
-#endif
+	SUBHEADER_GC_CATCH_KING_EVENT_INFO,
+	SUBHEADER_GC_CATCH_KING_START,
+	SUBHEADER_GC_CATCH_KING_SET_CARD,
+	SUBHEADER_GC_CATCH_KING_RESULT_FIELD,
+	SUBHEADER_GC_CATCH_KING_SET_END_CARD,
+	SUBHEADER_GC_CATCH_KING_REWARD
 };
 
 typedef struct SCatchKingCard
@@ -3350,7 +3055,7 @@
 typedef struct SPacketCGMiniGameCatchKing
 {
 	BYTE bHeader;
-	BYTE bSubHeader;
+	BYTE bSubheader;
 	BYTE bSubArgument;
 } TPacketCGMiniGameCatchKing;
 
@@ -3358,7 +3063,7 @@
 {
 	BYTE bHeader;
 	WORD wSize;
-	BYTE bSubHeader;
+	BYTE bSubheader;
 } TPacketGCMiniGameCatchKing;
 
 typedef struct SPacketGCMiniGameCatchKingResult
@@ -3378,895 +3083,114 @@
 	BYTE bCardPos;
 	BYTE bCardValue;
 } TPacketGCMiniGameCatchKingSetEndCard;
-
-#if defined(__CATCH_KING_EVENT_FLAG_RENEWAL__)
-typedef struct SPacketGCMiniGameCatchKingQuestFlag
-{
-	WORD wPieceCount, wPackCount;
-	SPacketGCMiniGameCatchKingQuestFlag(WORD wPieceCount, WORD wPackCount) :
-		wPieceCount(wPieceCount), wPackCount(wPackCount) {}
-} TPacketGCMiniGameCatchKingQuestFlag;
-#endif
 #endif
 
-#if defined(__SKILLBOOK_COMB_SYSTEM__)
-typedef struct SPacketCGSkillBookCombination
+#if defined(__PRIVATESHOP_SEARCH_SYSTEM__)
+typedef struct command_privateshop_searchcg
 {
-	BYTE bHeader;
-	BYTE bAction;
-	TItemPos CombItemGrid[SKILLBOOK_COMB_SLOT_MAX];
-} TPacketCGSkillBookCombination;
-#endif
-
-#if defined(__CHANGE_LOOK_SYSTEM__)
-enum class EPacketCGChangeLookSubHeader : BYTE
-{
-	ITEM_CHECK_IN,
-	ITEM_CHECK_OUT,
-	FREE_ITEM_CHECK_IN,
-	FREE_ITEM_CHECK_OUT,
-	ACCEPT,
-	CANCEL
-};
-
-typedef struct packet_set_changelook
-{
-	BYTE bHeader;
-	WORD wCell;
-	BYTE bSlotIndex;
-} TPacketGCChangeLookSet;
-
-typedef struct packet_changelook_del
-{
-	BYTE bHeader;
-	WORD wCell;
-	BYTE bSlotIndex;
-} TPacketGCChangeLookDel;
-
-typedef struct command_changelook
-{
-	BYTE bHeader;
-	BYTE bSubHeader;
-	BYTE bSlotIndex;
-	TItemPos ItemPos;
-} TPacketCGChangeLook;
+	BYTE header;
+	BYTE bJob;
+	BYTE bMaskType;
+	int iMaskSub;
+	int iMinRefine;
+	int iMaxRefine;
+	int iMinLevel;
+	int iMaxLevel;
+	int iMinGold;
+	int iMaxGold;
+	char szItemName[ITEM_NAME_MAX_LEN + 1];
+#if defined(__CHEQUE_SYSTEM__)
+	int iMinCheque;
+	int iMaxCheque;
 #endif
+} TPacketCGPrivateShopSearch;
 
-#if defined(__MAILBOX__)
-typedef struct packet_mailbox_process
-{
-	BYTE bHeader;
-	BYTE bSubHeader;
-	BYTE bArg1;
-	BYTE bArg2;
-} TPacketMailboxProcess;
-
-typedef struct packet_mailbox_process_all
-{
-	BYTE Index;
-} TPacketGCMailboxProcessAll;
-
-typedef struct packet_mailbox
-{
-	BYTE bHeader;
-	WORD wSize;
-} TPacketGCMailBox;
-
-typedef struct packet_mailbox_write
+typedef struct command_privateshopsearch_item
 {
-	BYTE bHeader;
-	char szName[CHARACTER_NAME_MAX_LEN + 1];
-	char szTitle[25 + 1];
-	char szMessage[100 + 1];
-	TItemPos pos;
-	int iYang;
-	int iWon;
-} TPacketCGMailboxWrite;
+	packet_shop_item item;
+	char szSellerName[CHARACTER_NAME_MAX_LEN + 1];
+	DWORD dwShopPID;
+} TPacketGCPrivateShopSearchItem;
 
-typedef struct packet_mailbox_write_confirm
+typedef struct command_privateshop_searchgc
 {
-	BYTE bHeader;
-	char szName[CHARACTER_NAME_MAX_LEN + 1];
-} TPacketCGMailboxWriteConfirm;
-#endif
+	BYTE header;
+	WORD size;
+} TPacketGCPrivateShopSearch;
 
-#if defined(__RANKING_SYSTEM__)
-typedef struct SPacketGCRanking
+typedef struct command_privateshop_searchopengc
 {
-	BYTE bHeader;
-	WORD wSize;
-	BYTE bType;
-	BYTE bCategory;
-} TPacketGCRanking;
-#endif
+	BYTE header;
+} TPacketGCPrivateShopSearchOpen;
 
-#if defined(__MOVE_COSTUME_ATTR__)
-typedef struct packet_cg_item_combination
+typedef struct command_privateshop_closecg
 {
-	BYTE Header;
-	short MediumIndex;
-	short BaseIndex;
-	short MaterialIndex;
-} TPacketCGItemCombination;
+	BYTE header;
+} TPacketCGPrivateShopSearchClose;
 
-typedef struct packet_cg_item_combination_cancel
+typedef struct command_privateshop_buy_item
 {
-	BYTE Header;
-} TPacketCGItemCombinationCancel;
+	BYTE header;
+	BYTE bPos;
+	DWORD dwShopPID;
+} TPacketCGPrivateShopSearchBuyItem;
 #endif
 
-#if defined(__CHANGED_ATTR__)
-typedef struct packet_gc_item_select_attr
+typedef struct SPacketGGLocaleNotice
 {
 	BYTE bHeader;
-	TItemPos pItemPos;
-	TPlayerItemAttribute aAttr[ITEM_ATTRIBUTE_MAX_NUM];
-} TPacketGCItemSelectAttr;
+	bool bBigFont;
+	char szNotice[MAX_QUEST_NOTICE_ARGS + 1][CHAT_MAX_LEN + 1];
+} TPacketGGLocaleNotice;
 
-typedef struct packet_cg_item_select_attr
+typedef struct SPacketChangeLanguage
 {
 	BYTE bHeader;
-	bool bNew;
-	TItemPos pItemPos;
-} TPacketCGItemSelectAttr;
-#endif
+	BYTE bLanguage;
+} TPacketChangeLanguage;
 
-#if defined(__LOOT_FILTER_SYSTEM__)
-typedef struct SPacketCGLootFilter
+typedef struct SPacketCGWhisperDetails
 {
 	BYTE header;
-	BYTE settings[ELootFilter::LOOT_FILTER_SETTINGS_MAX];
-} TPacketCGLootFilter;
+	char name[CHARACTER_NAME_MAX_LEN + 1];
+} TPacketCGWhisperDetails;
 
-typedef struct SPacketGCLootFilter
+typedef struct SPacketGCWhisperDetails
 {
 	BYTE header;
-	bool enable;
-	DWORD vid;
-} TPacketGCLootFilter;
-#endif
-
-#if defined(__MINI_GAME_RUMI__)
-enum EMiniGameRumiCGSubHeader
-{
-	RUMI_CG_SUBHEADER_END,
-	RUMI_CG_SUBHEADER_START,
-	RUMI_CG_SUBHEADER_DECK_CARD_CLICK,
-	RUMI_CG_SUBHEADER_HAND_CARD_CLICK,
-	RUMI_CG_SUBHEADER_FIELD_CARD_CLICK,
-#if defined(__OKEY_EVENT_FLAG_RENEWAL__)
-	RUMI_CG_SUBHEADER_REQUEST_QUEST_FLAG,
-#endif
-};
-
-enum EMiniGameRumiGCSubHeader
-{
-	RUMI_GC_SUBHEADER_END,
-	RUMI_GC_SUBHEADER_START,
-	RUMI_GC_SUBHEADER_SET_DECK,
-	RUMI_GC_SUBHEADER_SET_SCORE,
-	RUMI_GC_SUBHEADER_MOVE_CARD,
-#if defined(__OKEY_EVENT_FLAG_RENEWAL__)
-	RUMI_GC_SUBHEADER_SET_CARD_PIECE_FLAG,
-	RUMI_GC_SUBHEADER_SET_CARD_FLAG,
-	RUMI_GC_SUBHEADER_SET_QUEST_FLAG,
-	RUMI_GC_SUBHEADER_NO_MORE_GAIN,
-#endif
-};
+	char name[CHARACTER_NAME_MAX_LEN + 1];
+	BYTE bLanguage;
+} TPacketGCWhisperDetails;
 
-typedef struct SPacketCGMiniGameRumi
+typedef struct SPacketCGCharacterPinCode
 {
 	BYTE bHeader;
-	BYTE bSubHeader;
-	BOOL bUseCard;
 	BYTE bIndex;
-} TPacketCGMiniGameRumi;
-
-typedef struct SPacketGCMiniGameRumiSetDeck
-{
-	BYTE bDeckCount;
-	SPacketGCMiniGameRumiSetDeck(BYTE bDeckCount) : bDeckCount(bDeckCount) {}
-} TPacketGCMiniGameRumiSetDeck;
-
-typedef struct SPacketGCMiniGameRumiMoveCard
-{
-	BYTE bSrcPos, bSrcIndex, bSrcColor, bSrcNumber;
-	BYTE bDstPos, bDstIndex, bDstColor, bDstNumber;
-	SPacketGCMiniGameRumiMoveCard() :
-		bSrcPos(0), bSrcIndex(0), bSrcColor(0), bSrcNumber(0),
-		bDstPos(0), bDstIndex(0), bDstColor(0), bDstNumber(0) {}
-} TPacketGCMiniGameRumiMoveCard;
-
-typedef struct SPacketGCMiniGameRumiSetScore
-{
-	WORD wScore, wTotalScore;
-	SPacketGCMiniGameRumiSetScore(WORD wScore, WORD wTotalScore) :
-		wScore(wScore), wTotalScore(wTotalScore) {}
-} TPacketGCMiniGameRumiSetScore;
+	char szPinCode[PIN_CODE_LENGTH + 1];
+} TPacketCGCharacterPinCode;
 
-#if defined(__OKEY_EVENT_FLAG_RENEWAL__)
-typedef struct SPacketGCMiniGameRumiQuestFlag
-{
-	WORD wCardPieceCount, wCardCount;
-	SPacketGCMiniGameRumiQuestFlag(WORD wCardPieceCount, WORD wCardCount) :
-		wCardPieceCount(wCardPieceCount), wCardCount(wCardCount) {}
-} TPacketGCMiniGameRumiQuestFlag;
-#endif
-
-typedef struct SPacketGCMiniGameRumi
+typedef struct SPacketGCCharacterPinCode
 {
 	BYTE bHeader;
-	WORD wSize;
-	BYTE bSubHeader;
-} TPacketGCMiniGameRumi;
-#endif
+	bool bValid;
+} TPacketGCCharacterPinCode;
 
-#if defined(__LUCKY_BOX__)
-enum ELUCKY_BOX_ACTION
-{
-	LUCKY_BOX_ACTION_RETRY,
-	LUCKY_BOX_ACTION_RECEIVE,
-};
-
-typedef struct SPacketCGLuckyBox
+#if defined(__SKILLBOOK_COMB_SYSTEM__)
+typedef struct SPacketCGSkillBookCombination
 {
 	BYTE bHeader;
 	BYTE bAction;
-} TPacketCGLuckyBox;
-
-typedef struct SPacketGCLuckyBox
-{
-	BYTE bHeader;
-	DWORD dwVNum;
-	BYTE bCount;
-	int iNeedMoney;
-	WORD wSlotIndex;
-} TPacketGCLuckyBox;
-#endif
-
-#if defined(__ATTR_6TH_7TH__)
-enum EAttr67AddSubHeader
-{
-	SUBHEADER_CG_ATTR67_ADD_CLOSE,
-	SUBHEADER_CG_ATTR67_ADD_OPEN,
-	SUBHEADER_CG_ATTR67_ADD_REGIST,
-};
-
-typedef struct SPacketCGAttr67Add
-{
-	BYTE byHeader;
-	BYTE bySubHeader;
-	TAttr67AddData Attr67AddData;
-} TPacketCGAttr67Add;
-#endif
-
-#if defined(__GEM_SHOP__)
-enum EGemShopSubHeader : BYTE
-{
-	SUBHEADER_GEM_SHOP_CLOSE,
-	SUBHEADER_GEM_SHOP_OPEN,
-	SUBHEADER_GEM_SHOP_BUY,
-	SUBHEADER_GEM_SHOP_SLOT_ADD,
-	SUBHEADER_GEM_SHOP_REFRESH,
-	SUBHEADER_GEM_SHOP_MAX,
-};
-
-typedef struct SPacketGCGemShop
-{
-	BYTE bHeader;
-	WORD wSize;
-} TPacketGCGemShop;
-
-typedef struct SPacketGCGemShopProcess
-{
-	SPacketGCGemShopProcess(const BYTE c_bSubHeader) :
-		bHeader(HEADER_GC_GEM_SHOP_PROCESS),
-		bSubHeader(c_bSubHeader),
-		bSlotIndex(GEM_SHOP_SLOT_COUNT),
-		bEnable(false)
-	{}
-	BYTE bHeader;
-	BYTE bSubHeader;
-	BYTE bSlotIndex;
-	bool bEnable;
-} TPacketGCGemShopProcess;
-
-typedef struct command_gem_shop
-{
-	BYTE bHeader;
-	BYTE bSubHeader;
-	BYTE bSlotIndex;
-} TPacketCGGemShop;
-#endif
-
-#if defined(__EXTEND_INVEN_SYSTEM__)
-typedef struct SPacketCGExtendInven
-{
-	BYTE bHeader;
-	bool bUpgrade;
-	BYTE bIndex;
-} TPacketCGExtendInven;
-
-typedef struct SPacketGCExtendInven
-{
-	BYTE bHeader;
-	BYTE bStage;
-	WORD wMaxNum;
-} TPacketGCExtendInven;
-
-typedef struct SPacketGCExtendInvenItemUse
-{
-	BYTE bHeader;
-	BYTE bMsgResult;
-	BYTE bEnoughCount;
-} TPacketGCExtendInvenItemUse;
-#endif
-
-#if defined(__CLIENT_TIMER__)
-enum EClientTimerSubHeader
-{
-	CLIENT_TIMER_SUBHEADER_GC_SET,
-	CLIENT_TIMER_SUBHEADER_GC_DELETE
-};
-
-enum EClientTimer
-{
-	ECLIENT_TIMER_END_TIME,
-	ECLIENT_TIMER_ALARM_SECOND,
-	ECLIENT_TIMER_MAX
-};
-
-typedef struct SPacketGCClientTimer
-{
-	SPacketGCClientTimer(const BYTE _bSubHeader)
-		: bHeader(HEADER_GC_CLIENT_TIMER), bSubHeader(_bSubHeader)
-	{
-		memset(&dwData, 0, sizeof(dwData));
-	};
-	BYTE bHeader;
-	BYTE bSubHeader;
-	DWORD dwData[ECLIENT_TIMER_MAX];
-} TPacketGCClientTimer;
-#endif
-
-enum EEmoteSubHeader
-{
-	SUBHEADER_EMOTE_ADD,
-	SUBHEADER_EMOTE_CLEAR,
-	SUBHEADER_EMOTE_MOTION,
-	SUBHEADER_EMOTE_ICON,
-};
-
-typedef struct SPacketGCEmote
-{
-	SPacketGCEmote() : bHeader(HEADER_GC_EMOTE) {}
-	BYTE bHeader;
-	BYTE bSubHeader;
-	DWORD dwEmoteVnum;
-	DWORD dwDuration;
-	DWORD dwMainVID, dwTargetVID;
-} TPacketGCEmote;
-
-#if defined(__CUBE_RENEWAL__)
-enum ECubeSubHeader
-{
-	SUBHEADER_GC_CUBE_OPEN = 0,
-	SUBHEADER_GC_CUBE_CLOSE,
-	SUBHEADER_GC_CUBE_RESULT,
-
-	SUBHEADER_CG_CUBE_CLOSE = 0,
-	SUBHEADER_CG_CUBE_MAKE,
-};
-
-typedef struct SPacketGCCube
-{
-	BYTE bHeader;
-	BYTE bSubHeader;
-	DWORD dwNPCVnum;
-	BOOL bSuccess;
-	DWORD dwFileCrc;
-} TPacketGCCube;
-
-typedef struct SPacketCGCube
-{
-	BYTE bHeader;
-	BYTE bSubHeader;
-	UINT iCubeIndex;
-	UINT iQuantity;
-	INT iImproveItemPos;
-	DWORD dwFileCrc;
-} TPacketCGCube;
-#endif
-
-#if defined(__SNOWFLAKE_STICK_EVENT__)
-enum ESubPacketGCSnowflakeStickEvent
-{
-	SNOWFLAKE_STICK_EVENT_GC_SUBHEADER_EVENT_INFO,
-	SNOWFLAKE_STICK_EVENT_GC_SUBHEADER_ADD_SNOW_BALL,
-	SNOWFLAKE_STICK_EVENT_GC_SUBHEADER_ADD_TREE_BRANCH,
-	SNOWFLAKE_STICK_EVENT_GC_SUBHEADER_MESSAGE_SNOW_BALL_MAX,
-	SNOWFLAKE_STICK_EVENT_GC_SUBHEADER_MESSAGE_TREE_BRANCH_MAX,
-	SNOWFLAKE_STICK_EVENT_GC_SUBHEADER_EXCHANGE_STICK_SUCCESS,
-	SNOWFLAKE_STICK_EVENT_GC_SUBHEADER_EXCHANGE_PET_SUCCESS,
-	SNOWFLAKE_STICK_EVENT_GC_SUBHEADER_EXCHANGE_MOUNT_SUCCESS,
-	SNOWFLAKE_STICK_EVENT_GC_SUBHEADER_MESSAGE_USE_STICK_FAILED,
-	SNOWFLAKE_STICK_EVENT_GC_SUBHEADER_MESSAGE_GET_RANK_BUFF,
-	SNOWFLAKE_STICK_EVENT_GC_SUBHEADER_MESSAGE_GET_SNOWFLAKE_BUFF,
-	SNOWFLAKE_STICK_EVENT_GC_SUBHEADER_ENABLE,
-};
-
-enum ESnowflakeStickEventQuestFlagType
-{
-	SNOWFLAKE_STICK_EVENT_QUEST_FLAG_SNOW_BALL,
-	SNOWFLAKE_STICK_EVENT_QUEST_FLAG_TREE_BRANCH,
-	SNOWFLAKE_STICK_EVENT_QUEST_FLAG_EXCHANGE_STICK,
-	SNOWFLAKE_STICK_EVENT_QUEST_FLAG_EXCHANGE_STICK_COOLDOWN,
-	SNOWFLAKE_STICK_EVENT_QUEST_FLAG_EXCHANGE_PET,
-	SNOWFLAKE_STICK_EVENT_QUEST_FLAG_EXCHANGE_MOUNT,
-	SNOWFLAKE_STICK_EVENT_QUEST_FLAG_USE_STICK_COOLDOWN,
-	SNOWFLAKE_STICK_EVENT_QUEST_FLAG_MAX_NUM,
-};
-
-typedef struct SPacketGCSnowflakeStickEvent
-{
-	BYTE bHeader;
-	BYTE bSubHeader;
-	DWORD dwValue[SNOWFLAKE_STICK_EVENT_QUEST_FLAG_MAX_NUM];
-	SPacketGCSnowflakeStickEvent(const BYTE c_bSubHeader)
-		: bHeader(HEADER_GC_SNOWFLAKE_STICK_EVENT), bSubHeader(c_bSubHeader)
-	{;
-		memset(&dwValue, 0, sizeof(dwValue));
-	}
-} TPacketGCSnowflakeStickEvent;
-
-enum ESubPacketCGSnowflakeStickEvent
-{
-	SNOWFLAKE_STICK_EVENT_CG_SUBHEADER_REQUEST_INFO,
-	SNOWFLAKE_STICK_EVENT_CG_SUBHEADER_EXCHANGE_STICK,
-	SNOWFLAKE_STICK_EVENT_CG_SUBHEADER_EXCHANGE_PET,
-	SNOWFLAKE_STICK_EVENT_CG_SUBHEADER_EXCHANGE_MOUNT
-};
-
-typedef struct SPacketCGSnowflakeStickEvent
-{
-	BYTE bHeader;
-	BYTE bSubHeader;
-} TPacketCGSnowflakeStickEvent;
-#endif
-
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-enum EPacketGCRefineElement
-{
-	REFINE_ELEMENT_GC_OPEN,
-	REFINE_ELEMENT_GC_RESULT
-};
-
-enum EPacketCGRefineElement
-{
-	REFINE_ELEMENT_CG_CLOSE,
-	REFINE_ELEMENT_CG_REFINE,
-};
-
-typedef struct SPacketGCRefineElement
-{
-	BYTE bHeader;
-	BYTE bSubHeader;
-	BYTE bRefineType;
-	BYTE bResult;
-	TItemPos SrcPos;
-	TItemPos DestPos;
-} TPacketGCRefineElement;
-
-typedef struct SPacketCGRefineElement
-{
-	BYTE bHeader;
-	BYTE bSubHeader;
-	WORD wChangeElement;
-} TPacketCGRefineElement;
-#endif
-
-#if defined(__MINI_GAME_YUTNORI__)
-enum EMiniGameYutnoriGCSubHeader
-{
-	YUTNORI_GC_SUBHEADER_START,
-	YUTNORI_GC_SUBHEADER_STOP,
-	YUTNORI_GC_SUBHEADER_SET_PROB,
-	YUTNORI_GC_SUBHEADER_THROW,
-	YUTNORI_GC_SUBHEADER_MOVE,
-	YUTNORI_GC_SUBHEADER_AVAILABLE_AREA,
-	YUTNORI_GC_SUBHEADER_PUSH_CATCH_YUT,
-	YUTNORI_GC_SUBHEADER_SET_SCORE,
-	YUTNORI_GC_SUBHEADER_SET_REMAIN_COUNT,
-	YUTNORI_GC_SUBHEADER_PUSH_NEXT_TURN,
-#if defined(__YUTNORI_EVENT_FLAG_RENEWAL__)
-	YUTNORI_GC_SUBHEADER_SET_YUT_PIECE_FLAG,
-	YUTNORI_GC_SUBHEADER_SET_YUT_BOARD_FLAG,
-	YUTNORI_GC_SUBHEADER_SET_QUEST_FLAG,
-	YUTNORI_GC_SUBHEADER_NO_MORE_GAIN,
-#endif
-};
-
-enum EMiniGameYutnoriCGSubHeader
-{
-	YUTNORI_CG_SUBHEADER_START,
-	YUTNORI_CG_SUBHEADER_GIVEUP,
-	YUTNORI_CG_SUBHEADER_SET_PROB,
-	YUTNORI_CG_SUBHEADER_CLICK_CHAR,
-	YUTNORI_CG_SUBHEADER_THROW,
-	YUTNORI_CG_SUBHEADER_MOVE,
-	YUTNORI_CG_SUBHEADER_REQUEST_COM_ACTION,
-	YUTNORI_CG_SUBHEADER_REWARD,
-#if defined(__YUTNORI_EVENT_FLAG_RENEWAL__)
-	YUTNORI_CG_SUBHEADER_REQUEST_QUEST_FLAG,
-#endif
-};
-
-typedef struct SPacketCGMiniGameYutnori
-{
-	BYTE bHeader;
-	BYTE bSubHeader;
-	BYTE bArgument;
-} TPacketCGMiniGameYutnori;
-
-typedef struct SPacketGCMiniGameYutnori
-{
-	BYTE bHeader;
-	WORD wSize;
-	BYTE bSubHeader;
-} TPacketGCMiniGameYutnori;
-
-typedef struct SPacketGCMiniGameYutnoriSetProb
-{
-	BYTE bProbIndex;
-	SPacketGCMiniGameYutnoriSetProb(BYTE bProbIndex)
-		: bProbIndex(bProbIndex) {}
-} TPacketGCMiniGameYutnoriSetProb;
-
-typedef struct SPacketGCMiniGameYutnoriThrow
-{
-	bool bPC;
-	BYTE bYut;
-	SPacketGCMiniGameYutnoriThrow(bool bPC, BYTE bYut)
-		: bPC(bPC), bYut(bYut) {}
-} TPacketGCMiniGameYutnoriThrow;
-
-typedef struct SPacketGCMiniGameYutnoriMove
-{
-	bool bPC;
-	BYTE bUnitIndex;
-	bool bIsCatch;
-	BYTE bStartIndex;
-	BYTE bDestIndex;
-	SPacketGCMiniGameYutnoriMove(bool bPC, BYTE bUnitIndex, bool bIsCatch, BYTE bStartIndex, BYTE bDestIndex)
-		: bPC(bPC), bUnitIndex(bUnitIndex), bIsCatch(bIsCatch), bStartIndex(bStartIndex), bDestIndex(bDestIndex) {}
-} TPacketGCMiniGameYutnoriMove;
-
-typedef struct SPacketGCMiniGameYutnoriAvailableArea
-{
-	BYTE bPlayerIndex;
-	BYTE bAvailableIndex;
-	SPacketGCMiniGameYutnoriAvailableArea(BYTE bPlayerIndex, BYTE bAvailableIndex)
-		: bPlayerIndex(bPlayerIndex), bAvailableIndex(bAvailableIndex) {}
-} TPacketGCMiniGameYutnoriAvailableArea;
-
-typedef struct SPacketGCMiniGameYutnoriPushCatchYut
-{
-	bool bPC;
-	BYTE bUnitIndex;
-	SPacketGCMiniGameYutnoriPushCatchYut(bool bPC, BYTE bUnitIndex)
-		: bPC(bPC), bUnitIndex(bUnitIndex) {}
-} TPacketGCMiniGameYutnoriPushCatchYut;
-
-typedef struct SPacketGCMiniGameYutnoriSetScore
-{
-	WORD wScore;
-	SPacketGCMiniGameYutnoriSetScore(WORD wScore)
-		: wScore(wScore) {}
-} TPacketGCMiniGameYutnoriSetScore;
-
-typedef struct SPacketGCMiniGameYutnoriSetRemainCount
-{
-	BYTE bRemainCount;
-	SPacketGCMiniGameYutnoriSetRemainCount(BYTE bRemainCount)
-		: bRemainCount(bRemainCount) {}
-} TPacketGCMiniGameYutnoriSetRemainCount;
-
-typedef struct SPacketGCMiniGameYutnoriPushNextTurn
-{
-	bool bPC;
-	BYTE bState;
-	SPacketGCMiniGameYutnoriPushNextTurn(bool bPC, BYTE bState)
-		: bPC(bPC), bState(bState) {}
-} TPacketGCMiniGameYutnoriPushNextTurn;
-
-#if defined(__YUTNORI_EVENT_FLAG_RENEWAL__)
-typedef struct SPacketGCMiniGameYutnoriQuestFlag
-{
-	WORD wYutPieceCount;
-	WORD wYutBoardCount;
-	SPacketGCMiniGameYutnoriQuestFlag(WORD wYutPieceCount, WORD wYutBoardCount)
-		: wYutPieceCount(wYutPieceCount), wYutBoardCount(wYutBoardCount) {}
-} TPacketGCMiniGameYutnoriQuestFlag;
-#endif
-#endif
-
-#if defined(__QUEST_REQUEST_EVENT__)
-typedef struct SPacketCGRequestEventQuest
-{
-	BYTE bHeader;
-	char szEventQuest[64 + 1];
-} TPacketCGRequestEventQuest;
-#endif
-
-#if defined(__LEFT_SEAT__)
-enum ELeftSeatCGSubHeader
-{
-	LEFT_SEAT_SET_WAIT_TIME_INDEX,
-	LEFT_SEAT_SET_LOGOUT_TIME_INDEX,
-	LEFT_SEAT_DISABLE_LOGOUT_STATE,
-};
-
-typedef struct SPacketCGLeftSeat
-{
-	BYTE bHeader;
-	BYTE bSubHeader;
-	BYTE bIndex;
-} TPacketCGLeftSeat;
-#endif
-
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-enum EGuildDragonLairType
-{
-	GUILD_DRAGONLAIR_TYPE_RED,
-	GUILD_DRAGONLAIR_TYPE_BLUE,
-	GUILD_DRAGONLAIR_TYPE_GREEN,
-	GUILD_DRAGONLAIR_TYPE_MAX_NUM
-};
-
-enum EGuildDragonLairSubHeader
-{
-	GUILD_DRAGONLAIR_GC_SUBHEADER_RANKING,
-#if defined(__GUILD_DRAGONLAIR_PARTY_SYSTEM__)
-	GUILD_DRAGONLAIR_GC_SUBHEADER_1ST_GUILD_TEXT,
-	GUILD_DRAGONLAIR_GC_SUBHEADER_START,
-	GUILD_DRAGONLAIR_GC_SUBHEADER_SUCCESS,
-#endif
-};
-
-typedef struct SPacketGCGuildDragonLair
-{
-	BYTE bHeader;
-	WORD wSize;
-	BYTE bSubHeader;
-	BYTE bType;
-#if defined(__GUILD_DRAGONLAIR_PARTY_SYSTEM__)
-	DWORD dwFirstRankingTime;
-#endif
-} TPacketGCGuildDragonLair;
-
-typedef struct SPacketGCGuildDragonLairRanking
-{
-	BYTE bType;
-	DWORD dwGuildID;
-	char szGuildName[GUILD_NAME_MAX_LEN + 1];
-	BYTE bMemberCount;
-	DWORD dwTime;
-} TPacketGCGuildDragonLairRanking;
-#endif
-
-#if defined(__SUMMER_EVENT_ROULETTE__)
-enum EPacketGCMiniGameRouletteSubHeader
-{
-	ROULETTE_GC_OPEN,
-	ROULETTE_GC_START,
-	ROULETTE_GC_REQUEST,
-	ROULETTE_GC_END,
-	ROULETTE_GC_CLOSE
-};
-
-enum EPacketCGMiniGameRouletteSubHeader
-{
-	ROULETTE_CG_START,
-	ROULETTE_CG_REQUEST,
-	ROULETTE_CG_END,
-	ROULETTE_CG_CLOSE
-};
-
-typedef struct SPacketGCMiniGameRoulette
-{
-	BYTE bHeader;
-	BYTE bSubHeader;
-	BYTE bResult;
-	DWORD dwExpireTime;
-	struct
-	{
-		DWORD dwVnum;
-		BYTE bCount;
-	} ItemData[ROULETTE_ITEM_MAX];
-} TPacketGCMiniGameRoulette;
-
-typedef struct SPacketCGMiniGameRoulette
-{
-	BYTE bHeader;
-	BYTE bSubHeader;
-} TPacketCGMiniGameRoulette;
-#endif
-
-#if defined(__FLOWER_EVENT__)
-enum EPacketGCFlowerEvent
-{
-	FLOWER_EVENT_SUBHEADER_GC_INFO_ALL,
-	FLOWER_EVENT_SUBHEADER_GC_GET_INFO,
-	FLOWER_EVENT_SUBHEADER_GC_UPDATE_INFO,
-};
-
-typedef struct SPacketGCFlowerEvent
-{
-	BYTE bHeader;
-	BYTE bSubHeader;
-	BYTE bChatType;
-	BYTE bShootType;
-	int aiShootCount[SHOOT_TYPE_MAX + 1];
-	SPacketGCFlowerEvent()
-		: bHeader(HEADER_GC_FLOWER_EVENT)
-		, bSubHeader(FLOWER_EVENT_SUBHEADER_GC_INFO_ALL)
-		, bChatType(FLOWER_EVENT_CHAT_TYPE_MAX)
-		, bShootType(SHOOT_TYPE_MAX)
-	{
-		memset(&aiShootCount, 0, sizeof(aiShootCount));
-	}
-} TPacketGCFlowerEvent;
-
-enum EPacketCGFlowerEvent
-{
-	FLOWER_EVENT_SUBHEADER_CG_INFO_ALL,
-	FLOWER_EVENT_SUBHEADER_CG_EXCHANGE
-};
-
-typedef struct SPacketCGFlowerEvent
-{
-	BYTE bHeader;
-	BYTE bSubHeader;
-	BYTE bShootType;
-	BYTE bExchangeKey;
-}TPacketCGFlowerEvent;
-#endif
-
-#if defined(__OFFLINE_SHOP__)
-typedef struct SPacketGGUpdateSellHistory {
-	BYTE		bHeader;
-	DWORD		pid;
-	TMySellHistory	sellItem;
-} TPacketGGUpdateSellHistory;
-#endif
-
-#ifdef __SHOP_SEARCH__
-typedef struct SPacketCGShopSearchByName {
-	BYTE	header;
-	char	itemName[ITEM_NAME_MAX_LEN + 1];
-	WORD	page;
-	BYTE	entryCountIdx;
-	BYTE	sortType;
-} TPacketCGShopSearchByName;
-
-typedef struct SPacketCGShopSearchByOptions {
-	BYTE	header;
-	TShopSearchOptions	options;
-	WORD	page;
-	BYTE	entryCountIdx;
-	BYTE	sortType;
-} TPacketCGShopSearchByOptions;
-
-typedef struct SPacketGCShopSearchResult {
-	BYTE	header;
-	WORD	size;
-	WORD	itemCount;
-	WORD	maxPageNum;
-} TPacketGCShopSearchResult;
-typedef struct SPacketCGShopSearchBuy {
-	BYTE	header;
-	TOfflineItemID	itemID;
-	DWORD	itemVnum;
-	int64_t	itemPrice;
-
-} TPacketCGShopSearchBuy;
-
-typedef struct SPacketGCShopSearchBuyResult {
-	BYTE	header;
-	BYTE	result;
-} TPacketGCShopSearchBuyResult;
-
-typedef struct SPacketCGShopSearchOwnerMessage {
-	BYTE	header;
-	DWORD	ownerID;
-} TPacketCGShopSearchOwnerMessage;
-
-typedef struct SPacketGCShopSearchOwnerMessage {
-	BYTE	header;
-	char	ownerName[CHARACTER_NAME_MAX_LEN + 1];
-} TPacketGCShopSearchOwnerMessage;
-
-typedef struct SPacketCGShopSearchRequestSoldInfo {
-	BYTE	header;
-	DWORD	itemVnum;
-} TPacketCGShopSearchRequestSoldInfo;
-
-typedef struct SPacketGCShopSearchSoldInfo {
-	BYTE	header;
-	WORD	size;
-	bool	results;
-} TPacketGCShopSearchSoldInfo;
-
-using TPacketGCEntity = struct SPacketGCEntity
-{
-	BYTE bHeader;
-	WORD wSize;
-};
-using TPacketEntityInfo = struct SPacketEntityInfo
-{
-	DWORD dwVID;
-	DWORD dwRaceVNum;
-	WORD wPart[CHR_EQUIPPART_NUM];
-	LONG xPos, yPos;
-};
+	TItemPos CombItemGrid[SKILLBOOK_COMB_SLOT_MAX];
+} TPacketCGSkillBookCombination;
 #endif
 
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-typedef struct SPacketCGExtBattlePassAction
-{
-	BYTE bHeader;
-	BYTE bAction;
-} TPacketCGExtBattlePassAction;
-
-typedef struct SPacketCGExtBattlePassSendPremiumItem
-{
-	BYTE bHeader;
-	int iSlotIndex;
-} TPacketCGExtBattlePassSendPremiumItem;
-
-typedef struct SPacketGCExtBattlePassOpen
-{
-	BYTE bHeader;
-} TPacketGCExtBattlePassOpen;
-
-typedef struct SPacketGCExtBattlePassGeneralInfo
+typedef struct SPacketGCHWID
 {
 	BYTE bHeader;
-	BYTE bBattlePassType;
-	char	szSeasonName[64+1];
-	DWORD dwBattlePassID;
-	DWORD dwBattlePassStartTime;
-	DWORD dwBattlePassEndTime;
-} TPacketGCExtBattlePassGeneralInfo;
+	BYTE bStatus;
+	BYTE bVerifiedPIN[PLAYER_PER_ACCOUNT];
+} TPacketGCHWID;
 
-typedef struct SPacketGCExtBattlePassMissionInfo
-{
-	BYTE bHeader;
-	WORD wSize;
-	WORD wRewardSize;
-	BYTE bBattlePassType;
-	DWORD dwBattlePassID;
-} TPacketGCExtBattlePassMissionInfo;
-
-typedef struct SPacketGCExtBattlePassMissionUpdate
-{
-	BYTE bHeader;
-	BYTE bBattlePassType;
-	BYTE bMissionIndex;
-	BYTE bMissionType;
-	DWORD dwNewProgress;
-} TPacketGCExtBattlePassMissionUpdate;
-
-typedef struct SPacketGCExtBattlePassRanking
-{
-	BYTE bHeader;
-	char	szPlayerName[CHARACTER_NAME_MAX_LEN + 1];
-	BYTE bBattlePassType;
-	BYTE	bBattlePassID;
-	DWORD	dwStartTime;
-	DWORD	dwEndTime;
-} TPacketGCExtBattlePassRanking;
-#endif
 
 #ifdef __GROWTH_PET_SYSTEM__
 enum EGrowthPetPoints
@@ -4476,5 +3400,42 @@
 } TPacketCGPetNameChange;
 #endif
 
+#if defined(__MAILBOX__)
+typedef struct packet_mailbox_process
+{
+	BYTE bHeader;
+	BYTE bSubHeader;
+	BYTE bArg1;
+	BYTE bArg2;
+} TPacketMailboxProcess;
+
+typedef struct packet_mailbox_process_all
+{
+	BYTE Index;
+} TPacketGCMailboxProcessAll;
+
+typedef struct packet_mailbox
+{
+	BYTE bHeader;
+	WORD wSize;
+} TPacketGCMailBox;
+
+typedef struct packet_mailbox_write
+{
+	BYTE bHeader;
+	char szName[CHARACTER_NAME_MAX_LEN + 1];
+	char szTitle[25 + 1];
+	char szMessage[100 + 1];
+	TItemPos pos;
+	int iYang;
+	int iWon;
+} TPacketCGMailboxWrite;
+
+typedef struct packet_mailbox_write_confirm
+{
+	BYTE bHeader;
+	char szName[CHARACTER_NAME_MAX_LEN + 1];
+} TPacketCGMailboxWriteConfirm;
+#endif
 #pragma pack()
 #endif // __INC_PACKET_H__
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/packet_info.cpp final/server/server/home/metin2/Source/Server/game/src/packet_info.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/packet_info.cpp	2025-06-28 21:35:26.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/packet_info.cpp	2022-04-27 12:47:58.000000000 +0000
@@ -2,9 +2,7 @@
 #include "../../common/stl.h"
 #include "constants.h"
 #include "packet_info.h"
-#if defined(__OFFLINE_SHOP__)
-	#include "OfflineShop.h"
-#endif
+
 CPacketInfo::CPacketInfo()
 	: m_pCurrentPacket(NULL), m_dwStartTime(0)
 {
@@ -12,7 +10,7 @@
 
 CPacketInfo::~CPacketInfo()
 {
-	auto it = m_pPacketMap.begin();
+	itertype(m_pPacketMap) it = m_pPacketMap.begin();
 	for (; it != m_pPacketMap.end(); ++it)
 	{
 		M2_DELETE(it->second);
@@ -139,6 +137,7 @@
 {
 	Set(HEADER_CG_TEXT, sizeof(TPacketCGText), "Text", false);
 	Set(HEADER_CG_HANDSHAKE, sizeof(TPacketCGHandshake), "Handshake", false);
+	Set(HEADER_CG_PHASE, sizeof(TPacketCGPhase), "Phase", true);
 	Set(HEADER_CG_TIME_SYNC, sizeof(TPacketCGHandshake), "TimeSync", true);
 	Set(HEADER_CG_MARK_LOGIN, sizeof(TPacketCGMarkLogin), "MarkLogin", false);
 	Set(HEADER_CG_MARK_IDXLIST, sizeof(TPacketCGMarkIDXList), "MarkIdxList", false);
@@ -181,14 +180,8 @@
 	Set(HEADER_CG_EXCHANGE, sizeof(TPacketCGExchange), "Exchange", true);
 	Set(HEADER_CG_CHARACTER_POSITION, sizeof(TPacketCGPosition), "Position", true);
 	Set(HEADER_CG_SCRIPT_ANSWER, sizeof(TPacketCGScriptAnswer), "ScriptAnswer", true);
-#if defined(__GEM_SYSTEM__)
-	Set(HEADER_CG_SELECT_ITEM_EX, sizeof(TPacketCGSelectItemEx), "SelectItemEx", true);
-#endif
 	Set(HEADER_CG_SCRIPT_BUTTON, sizeof(TPacketCGScriptButton), "ScriptButton", true);
 	Set(HEADER_CG_QUEST_INPUT_STRING, sizeof(TPacketCGQuestInputString), "QuestInputString", true);
-#if defined(__OX_RENEWAL__)
-	Set(HEADER_CG_QUEST_INPUT_LONG_STRING, sizeof(TPacketCGQuestInputLongString), "QuestInputLongString", true);
-#endif
 	Set(HEADER_CG_QUEST_CONFIRM, sizeof(TPacketCGQuestConfirm), "QuestConfirm", true);
 
 	Set(HEADER_CG_MOVE, sizeof(TPacketCGMove), "Move", true);
@@ -222,21 +215,14 @@
 	Set(HEADER_CG_ANSWER_MAKE_GUILD, sizeof(TPacketCGAnswerMakeGuild), "AnswerMakeGuild", true);
 
 	Set(HEADER_CG_FISHING, sizeof(TPacketCGFishing), "Fishing", true);
-#if defined(__FISHING_GAME__)
-	Set(HEADER_CG_FISHING_GAME, sizeof(TPacketCGFishingGame), "FishingGame", true);
-#endif
 	Set(HEADER_CG_ITEM_GIVE, sizeof(TPacketCGGiveItem), "ItemGive", true);
 	Set(HEADER_CG_HACK, sizeof(TPacketCGHack), "Hack", true);
 	Set(HEADER_CG_MYSHOP, sizeof(TPacketCGMyShop), "MyShop", true);
 #if defined(__MYSHOP_DECO__)
-	Set(HEADER_CG_MYSHOP_DECO_STATE, sizeof(TPacketCGMyShopDecoState), "MyShopDecoState", true);
-	Set(HEADER_CG_MYSHOP_DECO_ADD, sizeof(TPacketCGMyShopDecoAdd), "MyShopDecoAdd", true);
+	Set(HEADER_CG_MYSHOP_DECO, sizeof(TPacketCGMyShopDeco), "MyShopDeco", true);
 #endif
 
 	Set(HEADER_CG_REFINE, sizeof(TPacketCGRefine), "Refine", true);
-#if defined(__CUBE_RENEWAL__)
-	Set(HEADER_CG_CUBE, sizeof(TPacketCGCube), "Cube", true);
-#endif
 	Set(HEADER_CG_CHANGE_NAME, sizeof(TPacketCGChangeName), "ChangeName", true);
 
 	Set(HEADER_CG_CLIENT_VERSION, sizeof(TPacketCGClientVersion), "Version", true);
@@ -246,89 +232,39 @@
 
 	Set(HEADER_CG_SCRIPT_SELECT_ITEM, sizeof(TPacketCGScriptSelectItem), "ScriptSelectItem", true);
 
-#if defined(__DRAGON_SOUL_SYSTEM__)
 	Set(HEADER_CG_DRAGON_SOUL_REFINE, sizeof(TPacketCGDragonSoulRefine), "DragonSoulRefine", false);
-#endif
 	Set(HEADER_CG_STATE_CHECKER, sizeof(BYTE), "ServerStateCheck", false);
-#if defined(__OFFLINE_SHOP__)
-	Set(HEADER_CG_OFFLINE_SHOP, sizeof(net_offline_shop::CG_packet), "OfflineShop", true);
-#endif
-#ifdef __SHOP_SEARCH__
-	Set(HEADER_CG_SHOP_SEARCH_BY_NAME, sizeof(TPacketCGShopSearchByName), "ShopSearchByName", true);
-	Set(HEADER_CG_SHOP_SEARCH_BY_OPTION, sizeof(TPacketCGShopSearchByOptions), "ShopSearchByOption", true);
-	Set(HEADER_CG_SHOP_SEARCH_BUY, sizeof(TPacketCGShopSearchBuy), "ShopSearchBuy", true);
-	Set(HEADER_CG_SHOP_SEARCH_OWNER_MESSAGE, sizeof(TPacketCGShopSearchOwnerMessage), "ShopSearchOwnerMessage", true);
-	Set(HEADER_CG_SHOP_SEARCH_REQUEST_SOLD_INFO, sizeof(TPacketCGShopSearchRequestSoldInfo), "ShopSearchRequestSoldInfo", true);
-#endif
-#if defined(__MOVE_COSTUME_ATTR__)
-	Set(HEADER_CG_ITEM_COMBINATION, sizeof(TPacketCGItemCombination), "ItemCombination", true);
-	Set(HEADER_CG_ITEM_COMBINATION_CANCEL, sizeof(TPacketCGItemCombinationCancel), "ItemCombinationCancel", true);
-#endif
-#if defined(__CHANGED_ATTR__)
-	Set(HEADER_CG_ITEM_SELECT_ATTR, sizeof(TPacketCGItemSelectAttr), "ItemSelectAttr", true);
-#endif
+
 #if defined(__ACCE_COSTUME_SYSTEM__)
-	Set(HEADER_CG_ACCE_REFINE, sizeof(TPacketCGAcceRefine), "AcceRefine", true);
+	Set(HEADER_CG_ACCE, sizeof(TPacketAcce), "Acce", true);
 #endif
 #if defined(__CHANGE_LOOK_SYSTEM__)
-	Set(HEADER_CG_CHANGE_LOOK, sizeof(TPacketCGChangeLook), "ChangeLook", true);
+	Set(HEADER_CG_CHANGE_LOOK, sizeof(TPacketChangeLook), "ChangeLook", true);
 #endif
+
 #if defined(__SEND_TARGET_INFO__)
-	Set(HEADER_CG_TARGET_INFO, sizeof(TPacketCGTargetInfo), "TargetInfo", true);
-#endif
-#if defined(__MINI_GAME_RUMI__)
-	Set(HEADER_CG_MINI_GAME_RUMI, sizeof(TPacketCGMiniGameRumi), "MiniGameRumi", true);
+	Set(HEADER_CG_TARGET_INFO_LOAD, sizeof(TPacketCGTargetInfoLoad), "TargetInfoLoad", true);
 #endif
-#if defined(__MINI_GAME_YUTNORI__)
-	Set(HEADER_CG_MINI_GAME_YUTNORI, sizeof(TPacketCGMiniGameYutnori), "MiniGameYutnori", true);
+#if defined(__SKILL_COLOR_SYSTEM__)
+	Set(HEADER_CG_SKILL_COLOR, sizeof(TPacketCGSkillColor), "ChangeSkillColor", true);
 #endif
+
 #if defined(__MINI_GAME_CATCH_KING__)
 	Set(HEADER_CG_MINI_GAME_CATCH_KING, sizeof(TPacketCGMiniGameCatchKing), "MiniGameCatchKing", true);
 #endif
+
+#if defined(__PRIVATESHOP_SEARCH_SYSTEM__)
+	Set(HEADER_CG_PRIVATESHOP_SEARCH, sizeof(TPacketCGPrivateShopSearch), "PrivateShopSearch", true);
+	Set(HEADER_CG_PRIVATESHOP_SEARCH_CLOSE, sizeof(TPacketCGPrivateShopSearchClose), "PrivateShopSearchClose", true);
+	Set(HEADER_CG_PRIVATESHOP_SEARCH_BUY_ITEM, sizeof(TPacketCGPrivateShopSearchBuyItem), "PrivateShopSearchBuyItem", true);
+#endif
+
+	Set(HEADER_CG_CHANGE_LANGUAGE, sizeof(TPacketChangeLanguage), "ChangeLanguage", true);
+	Set(HEADER_CG_PLAYER_PIN_CODE, sizeof(TPacketCGCharacterPinCode), "PinCode", true);
+
 #if defined(__SKILLBOOK_COMB_SYSTEM__)
 	Set(HEADER_CG_SKILLBOOK_COMB, sizeof(TPacketCGSkillBookCombination), "SkillBookCombination", true);
 #endif
-#if defined(__MAILBOX__)
-	Set(HEADER_CG_MAILBOX_WRITE, sizeof(TPacketCGMailboxWrite), "MailboxWrite", true);
-	Set(HEADER_CG_MAILBOX_WRITE_CONFIRM, sizeof(TPacketCGMailboxWriteConfirm), "MailboxConfirm", true);
-	Set(HEADER_CG_MAILBOX_PROCESS, sizeof(TPacketMailboxProcess), "MailboxProcess", true);
-#endif
-#if defined(__LOOT_FILTER_SYSTEM__)
-	Set(HEADER_CG_LOOT_FILTER, sizeof(TPacketCGLootFilter), "LootFilter", true);
-#endif
-#if defined(__LUCKY_BOX__)
-	Set(HEADER_CG_LUCKY_BOX, sizeof(TPacketCGLuckyBox), "LuckyBox", true);
-#endif
-#if defined(__ATTR_6TH_7TH__)
-	Set(HEADER_CG_ATTR67_ADD, sizeof(TPacketCGAttr67Add), "Attr67Add", true);
-#endif
-#if defined(__GEM_SHOP__)
-	Set(HEADER_CG_GEM_SHOP, sizeof(TPacketCGGemShop), "GemShop", true);
-#endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-	Set(HEADER_CG_AURA_REFINE, sizeof(TPacketCGAuraRefine), "AuraRefine", true);
-#endif
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	Set(HEADER_CG_EXTEND_INVEN, sizeof(TPacketCGExtendInven), "ExtendInven", true);
-#endif
-#if defined(__SNOWFLAKE_STICK_EVENT__)
-	Set(HEADER_CG_SNOWFLAKE_STICK_EVENT, sizeof(TPacketCGSnowflakeStickEvent), "SnowflakeStickEvent", true);
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	Set(HEADER_CG_REFINE_ELEMENT, sizeof(TPacketCGRefineElement), "RefineElement", true);
-#endif
-#if defined(__QUEST_REQUEST_EVENT__)
-	Set(HEADER_CG_REQUEST_EVENT_QUEST, sizeof(TPacketCGRequestEventQuest), "RequestEventQuest", true);
-#endif
-#if defined(__LEFT_SEAT__)
-	Set(HEADER_CG_LEFT_SEAT, sizeof(TPacketCGLeftSeat), "LeftSeat", true);
-#endif
-#if defined(__SUMMER_EVENT_ROULETTE__)
-	Set(HEADER_CG_MINI_GAME_ROULETTE, sizeof(TPacketCGMiniGameRoulette), "MiniGameRoulette", true);
-#endif
-#if defined(__FLOWER_EVENT__)
-	Set(HEADER_CG_FLOWER_EVENT, sizeof(TPacketCGFlowerEvent), "FlowerEvent", true);
-#endif
 #ifdef __GROWTH_PET_SYSTEM__
 	Set(HEADER_CG_PET_HATCH, sizeof(TPacketCGPetHatch), "PetHatch", true);
 	Set(HEADER_CG_PET_WINDOW, sizeof(TPacketCGPetWindow), "PetWindow", true);
@@ -344,9 +280,12 @@
 	Set(HEADER_CG_PET_DELETE_SKILL, sizeof(TPacketCGPetDeleteSkill), "PetDeleteSkill", true);
 	Set(HEADER_CG_PET_DELETE_ALL_SKILL, sizeof(TPacketCGPetDeleteAllSkill), "PetDeleteAllSkill", true);
 #endif
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	Set(HEADER_CG_EXT_BATTLE_PASS_ACTION, sizeof(TPacketCGExtBattlePassAction), "ReciveExtBattlePassActions", true);
-	Set(HEADER_CG_EXT_SEND_BP_PREMIUM_ITEM, sizeof(TPacketCGExtBattlePassSendPremiumItem), "ReciveExtBattlePassPremiumItem", true);
+	Set(HEADER_CG_WHISPER_DETAILS, sizeof(TPacketCGWhisperDetails), "WhisperDetails", true);
+
+#if defined(__MAILBOX__)
+	Set(HEADER_CG_MAILBOX_WRITE, sizeof(TPacketCGMailboxWrite), "MailboxWrite", true);
+	Set(HEADER_CG_MAILBOX_WRITE_CONFIRM, sizeof(TPacketCGMailboxWriteConfirm), "MailboxConfirm", true);
+	Set(HEADER_CG_MAILBOX_PROCESS, sizeof(TPacketMailboxProcess), "MailboxProcess", true);
 #endif
 }
 
@@ -377,10 +316,8 @@
 	Set(HEADER_GG_WARP_CHARACTER, sizeof(TPacketGGWarpCharacter), "WarpCharacter", false);
 	Set(HEADER_GG_GUILD_WAR_ZONE_MAP_INDEX, sizeof(TPacketGGGuildWarMapIndex), "GuildWarMapIndex", false);
 	Set(HEADER_GG_TRANSFER, sizeof(TPacketGGTransfer), "Transfer", false);
-#if defined(__XMAS_EVENT_2008__)
 	Set(HEADER_GG_XMAS_WARP_SANTA, sizeof(TPacketGGXmasWarpSanta), "XmasWarpSanta", false);
 	Set(HEADER_GG_XMAS_WARP_SANTA_REPLY, sizeof(TPacketGGXmasWarpSantaReply), "XmasWarpSantaReply", false);
-#endif
 	Set(HEADER_GG_RELOAD_CRC_LIST, sizeof(BYTE), "ReloadCRCList", false);
 	Set(HEADER_GG_CHECK_CLIENT_VERSION, sizeof(BYTE), "CheckClientVersion", false);
 	Set(HEADER_GG_LOGIN_PING, sizeof(TPacketGGLoginPing), "LoginPing", false);
@@ -390,14 +327,12 @@
 	// END_OF_BLOCK_CHAT
 	Set(HEADER_GG_SIEGE, sizeof(TPacketGGSiege), "Siege", false);
 
+	Set(HEADER_GG_BIG_NOTICE, sizeof(TPacketGGBigNotice), "BigNotice", false);
 	Set(HEADER_GG_MONARCH_NOTICE, sizeof(TPacketGGMonarchNotice), "MonarchNotice", false);
 	Set(HEADER_GG_MONARCH_TRANSFER, sizeof(TPacketMonarchGGTransfer), "MonarchTransfer", false);
 	Set(HEADER_GG_PCBANG_UPDATE, sizeof(TPacketPCBangUpdate), "PCBangUpdate", false);
 	Set(HEADER_GG_CHECK_AWAKENESS, sizeof(TPacketGGCheckAwakeness), "CheckAwakeness", false);
-#if defined(__OFFLINE_SHOP__)
-	Set(HEADER_GG_OFFLINE_SHOP, sizeof(net_offline_shop::GG_packet), "OfflineShop", false);
-	Set(HEADER_GG_UPDATE_SELL_HISTORY, sizeof(TPacketGGUpdateSellHistory), "UpdateSellHistory", false);
-#endif
+	Set(HEADER_GG_LOCALE_NOTICE, sizeof(TPacketGGLocaleNotice), "LocaleNotice", false);
 }
 
 CPacketInfoGG::~CPacketInfoGG()
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/questlua_dungeon.cpp final/server/server/home/metin2/Source/Server/game/src/questlua_dungeon.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/questlua_dungeon.cpp	2025-06-28 03:53:14.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/questlua_dungeon.cpp	2021-06-22 11:29:34.000000000 +0000
@@ -24,8 +24,9 @@
 
 template <class Func> Func CDungeon::ForEachMember(Func f)
 {
-	auto it = m_set_pkCharacter.begin();
-	for (; it != m_set_pkCharacter.end(); ++it)
+	itertype(m_set_pkCharacter) it;
+
+	for (it = m_set_pkCharacter.begin(); it != m_set_pkCharacter.end(); ++it)
 	{
 		sys_log(0, "Dungeon ForEachMember %s", (*it)->GetName());
 		f(*it);
@@ -40,53 +41,24 @@
 	//
 	int dungeon_notice(lua_State* L)
 	{
-		if (!lua_isstring(L, 1))
-			return 0;
-
-		CQuestManager& q = CQuestManager::instance();
-		LPDUNGEON pDungeon = q.GetCurrentDungeon();
-
-		if (pDungeon)
-			pDungeon->Notice(lua_tostring(L, 1));
-
-		return 0;
-	}
-
-	int dungeon_mission_msg(lua_State* L)
-	{
-		if (!lua_isstring(L, 1))
-			return 0;
-
 		CQuestManager& q = CQuestManager::instance();
 		LPDUNGEON pDungeon = q.GetCurrentDungeon();
 
 		if (pDungeon)
-			pDungeon->MissionMessage(lua_tostring(L, 1));
-
-		return 0;
-	}
-
-	int dungeon_sub_mission_msg(lua_State* L)
-	{
-		if (!lua_isstring(L, 1))
-			return 0;
-
-		CQuestManager& q = CQuestManager::instance();
-		LPDUNGEON pDungeon = q.GetCurrentDungeon();
-
-		if (pDungeon)
-			pDungeon->SubMissionMessage(lua_tostring(L, 1));
-
-		return 0;
-	}
-
-	int dungeon_clear_mission_msg(lua_State* L)
-	{
-		CQuestManager& q = CQuestManager::instance();
-		LPDUNGEON pDungeon = q.GetCurrentDungeon();
-
-		if (pDungeon)
-			pDungeon->MissionMessage("");
+		{
+			pDungeon->Notice(
+				lua_tostring(L, 1),
+				lua_tostring(L, 2),
+				lua_tostring(L, 3),
+				lua_tostring(L, 4),
+				lua_tostring(L, 5),
+				lua_tostring(L, 6),
+				lua_tostring(L, 7),
+				lua_tostring(L, 8),
+				lua_tostring(L, 9),
+				lua_tostring(L, 10)
+			);
+		}
 
 		return 0;
 	}
@@ -157,120 +129,6 @@
 		return 1;
 	}
 
-#if defined(__DUNGEON_RENEWAL__)
-	int dungeon_set_flag_for_map_index(lua_State* L)
-	{
-		if (!lua_isstring(L, 1) || !lua_isnumber(L, 2) || !lua_isnumber(L, 3))
-		{
-			sys_err("invalid args");
-			return 0;
-		}
-
-		DWORD dwMapIndex = (DWORD)lua_tonumber(L, 3);
-		if (dwMapIndex)
-		{
-			LPDUNGEON pDungeon = CDungeonManager::instance().FindByMapIndex(dwMapIndex);
-			if (pDungeon)
-			{
-				const char* sz = lua_tostring(L, 1);
-				int value = lua_tonumber(L, 2);
-				pDungeon->SetFlag(sz, value);
-			}
-			else
-			{
-				sys_err("no dungeon !!!");
-				return 0;
-			}
-		}
-
-		return 0;
-	}
-
-	int dungeon_spawn_mob_for_map_index(lua_State* L)
-	{
-		// vnum x, y
-		if (!lua_isnumber(L, 1) || !lua_isnumber(L, 2) || !lua_isnumber(L, 3) || !lua_isnumber(L, 4))
-		{
-			sys_err("invalid argument");
-			return 0;
-		}
-
-		const long lMapIndex = static_cast<long>(lua_tonumber(L, 4));
-		const LPDUNGEON pDungeon = CDungeonManager::Instance().FindByMapIndex(lMapIndex);
-		if (pDungeon == nullptr)
-		{
-			sys_err("no dungeon");
-			return 0;
-		}
-
-		const DWORD dwVnum = static_cast<DWORD>(lua_tonumber(L, 1));
-		const long lPosX = static_cast<long>(lua_tonumber(L, 2));
-		const long lPosY = static_cast<long>(lua_tonumber(L, 3));
-
-		const LPCHARACTER pChar = pDungeon->SpawnMob(dwVnum, lPosX, lPosY);
-		if (pChar == nullptr)
-		{
-			sys_err("failed to spawn mob %d at %ld, %ld map index %ld", dwVnum, lPosX, lPosY, lMapIndex);
-			return 0;
-		}
-
-		return 0;
-	}
-
-	int dungeon_party_notice(lua_State* L)
-	{
-		if (!lua_isstring(L, 1))
-			return 0;
-
-		CQuestManager& rQmgr = CQuestManager::instance();
-		const LPDUNGEON pDungeon = rQmgr.GetCurrentDungeon();
-		if (pDungeon == nullptr)
-			return 0;
-
-		SendPartyNotice(pDungeon->GetParty(), lua_tostring(L, 1));
-		return 0;
-	}
-
-	int dungeon_syschat(lua_State* L)
-	{
-		if (!lua_isstring(L, 1))
-			return 0;
-
-		CQuestManager& rQmgr = CQuestManager::instance();
-		const LPDUNGEON pDungeon = rQmgr.GetCurrentDungeon();
-		if (pDungeon == nullptr)
-			return 0;
-
-		FPartyChat f(CHAT_TYPE_INFO, lua_tostring(L, 1));
-		pDungeon->ForEachMember(f);
-		return 0;
-	}
-
-	int dungeon_set_quest_flag2_all_near(lua_State* L)
-	{
-		if (!lua_isstring(L, 1) || !lua_isstring(L, 2) || !lua_isnumber(L, 3) || !lua_isnumber(L, 4))
-			sys_err("Invalid Argument");
-
-		CQuestManager& q = CQuestManager::Instance();
-		LPCHARACTER ch = q.GetCurrentCharacterPtr();
-		if (NULL == ch)
-			return 0;
-
-		FSetQuestFlagToNearMembers f;
-		f.flagname = string(lua_tostring(L, 1)) + "." + lua_tostring(L, 2);
-		f.value = (int)rint(lua_tonumber(L, 3));
-		f.x = ch->GetX();
-		f.y = ch->GetY();
-		f.dist = (int)lua_tonumber(L, 4);
-
-		LPDUNGEON pDungeon = q.GetCurrentDungeon();
-		if (pDungeon)
-			pDungeon->ForEachMember(f);
-
-		return 0;
-	}
-#endif
-
 	int dungeon_get_flag_from_map_index(lua_State* L)
 	{
 		if (!lua_isstring(L, 1) || !lua_isnumber(L, 2))
@@ -295,7 +153,7 @@
 		}
 		else
 		{
-			lua_pushnumber(L, 0);
+			lua_pushboolean(L, 0);
 		}
 		return 1;
 	}
@@ -520,62 +378,48 @@
 		return 0;
 	}
 
-#if defined(__DUNGEON_RENEWAL__)
-	int dungeon_create(lua_State* L)
+	//< 2018.12.30.Owsap - JumpPartyWithOppLeader Jump 2 parties to dungeon
+	int dungeon_jump_party_with_opp_leader(lua_State* L)
 	{
-		if (!lua_isnumber(L, 1))
+		// map_index, xA, yA, xB, yB, opponent_leader_pid
+		if (lua_gettop(L) < 6 || !lua_isnumber(L, 1) || !lua_isnumber(L, 2) || !lua_isnumber(L, 3) || !lua_isnumber(L, 4) || !lua_isnumber(L, 5) || !lua_isnumber(L, 6))
 		{
-			sys_err("invalid argument");
-			lua_pushnumber(L, 0);
-			return 1;
-		}
-
-		const long lMapIndex = (long)lua_tonumber(L, 1);
-		const LPDUNGEON pDungeon = CDungeonManager::instance().Create(lMapIndex);
-		if (pDungeon == nullptr)
-		{
-			sys_err("cannot create dungeon %d", lMapIndex);
-			lua_pushnumber(L, 0);
-			return 1;
-		}
-
-		CQuestManager& rQmgr = CQuestManager::instance();
-		LPCHARACTER pChar = rQmgr.GetCurrentCharacterPtr();
-		if (pChar->GetParty() == nullptr)
-		{
-			sys_err("cannot go to dungeon alone.");
-			lua_pushnumber(L, 0);
-			return 1;
+			sys_err("not enough argument");
+			return 0;
 		}
 
-		pDungeon->SetParty(pChar->GetParty());
+		long lMapIndex = (long)lua_tonumber(L, 1);
+		long dwOppLeaderPID = (long)lua_tonumber(L, 6);
 
-		lua_pushnumber(L, pDungeon->GetMapIndex());
-		return 1;
-	}
+		LPDUNGEON pDungeon = CDungeonManager::instance().Create(lMapIndex);
 
-	int dungeon_destroy(lua_State* L)
-	{
-		if (!lua_isnumber(L, 1))
+		if (!pDungeon)
 		{
-			sys_err("invalid argument");
-			lua_pushnumber(L, 0);
-			return 1;
+			sys_err("cannot create dungeon %d", lMapIndex);
+			return 0;
 		}
 
-		const long lMapIndex = (long)lua_tonumber(L, 1);
-		CQuestManager& rQmgr = CQuestManager::instance();
-		const LPDUNGEON pDungeon = CDungeonManager::Instance().FindByMapIndex(lMapIndex);
-		if (pDungeon == nullptr)
+		LPCHARACTER ch = CQuestManager::instance().GetCurrentCharacterPtr();
+		LPCHARACTER tch = CHARACTER_MANAGER::instance().FindByPID(dwOppLeaderPID);
+
+		if (ch != NULL && tch != NULL)
 		{
-			sys_err("no dungeon");
-			return 0;
+			if (ch->GetParty() != NULL && tch->GetParty() != NULL)
+			{
+				// JumpParties (party, map_index, x, y, JumpSingleParty : false)
+				pDungeon->JumpParty(ch->GetParty(), ch->GetMapIndex(), (int)lua_tonumber(L, 2), (int)lua_tonumber(L, 3), false); // not single
+				pDungeon->JumpParty(tch->GetParty(), tch->GetMapIndex(), (int)lua_tonumber(L, 4), (int)lua_tonumber(L, 5), false); // not single
+			}
+			else
+			{
+				sys_err("%s and %s cannot go to dungeon alone.", ch->GetName(), tch->GetName());
+				return 0;
+			}
 		}
 
-		pDungeon->Destroy();
 		return 0;
 	}
-#endif
+	//>
 
 	int dungeon_jump_all(lua_State* L)
 	{
@@ -715,7 +559,7 @@
 		LPDUNGEON pDungeon = q.GetCurrentDungeon();
 
 		if (pDungeon)
-			pDungeon->UniqueSetMaxHP(lua_tostring(L, 1), lua_tonumber(L, 2));
+			pDungeon->UniqueSetMaxHP(lua_tostring(L, 1), (int64_t)lua_tonumber(L, 2));
 
 		return 0;
 	}
@@ -729,7 +573,7 @@
 		LPDUNGEON pDungeon = q.GetCurrentDungeon();
 
 		if (pDungeon)
-			pDungeon->UniqueSetHP(lua_tostring(L, 1), lua_tonumber(L, 2));
+			pDungeon->UniqueSetHP(lua_tostring(L, 1), (int64_t)lua_tonumber(L, 2));
 
 		return 0;
 	}
@@ -743,7 +587,7 @@
 		LPDUNGEON pDungeon = q.GetCurrentDungeon();
 
 		if (pDungeon)
-			pDungeon->UniqueSetDefGrade(lua_tostring(L, 1), lua_tonumber(L, 2));
+			pDungeon->UniqueSetDefGrade(lua_tostring(L, 1), (int)lua_tonumber(L, 2));
 
 		return 0;
 	}
@@ -820,14 +664,11 @@
 			if (true == ent->IsType(ENTITY_CHARACTER))
 			{
 				LPCHARACTER pChar = static_cast<LPCHARACTER>(ent);
+
 				if (pChar == ExceptChar)
 					return;
 
-				if ((true == pChar->IsMonster() || true == pChar->IsStone())
-#if defined(__PET_SYSTEM__)
-					&& !pChar->IsPet()
-#endif
-					)
+				if (!pChar->IsPet() && !pChar->IsGrowthPet() && (true == pChar->IsMonster() || true == pChar->IsStone()))
 				{
 					if (x1 <= pChar->GetX() && pChar->GetX() <= x2 && y1 <= pChar->GetY() && pChar->GetY() <= y2)
 					{
@@ -1005,7 +846,7 @@
 
 		if (pDungeon)
 		{
-			lua_pushnumber(L, pDungeon->GetUniqueVID(lua_tostring(L, 1)));
+			lua_pushnumber(L, pDungeon->GetUniqueVid(lua_tostring(L, 1)));
 			return 1;
 		}
 
@@ -1249,7 +1090,7 @@
 					struct ::packet_script packet_script;
 					TEMP_BUFFER buf;
 
-					for (CDungeon::ItemGroup::const_iterator it = item_group->begin(); it != item_group->end(); ++it)
+					for (CDungeon::ItemGroup::const_iterator it = item_group->begin(); it != item_group->end(); it++)
 					{
 						if (ch->CountSpecifyItem(it->first) >= it->second)
 						{
@@ -1287,7 +1128,7 @@
 		}
 
 		CQuestManager& q = CQuestManager::instance();
-		LPDUNGEON pDungeon = q.GetCurrentDungeon();
+		CDungeon* pDungeon = q.GetCurrentDungeon();
 
 		if (!pDungeon)
 		{
@@ -1336,7 +1177,7 @@
 
 				if (ch->IsPC())
 				{
-					for (CDungeon::ItemGroup::const_iterator it = item_group->begin(); it != item_group->end(); ++it)
+					for (CDungeon::ItemGroup::const_iterator it = item_group->begin(); it != item_group->end(); it++)
 					{
 						if (ch->CountSpecifyItem(it->first) >= it->second)
 						{
@@ -1358,7 +1199,7 @@
 		}
 
 		CQuestManager& q = CQuestManager::instance();
-		LPDUNGEON pDungeon = q.GetCurrentDungeon();
+		CDungeon* pDungeon = q.GetCurrentDungeon();
 
 		if (!pDungeon)
 		{
@@ -1401,7 +1242,7 @@
 
 				if (ch->IsPC())
 				{
-					for (CDungeon::ItemGroup::const_iterator it = item_group->begin(); it != item_group->end(); ++it)
+					for (CDungeon::ItemGroup::const_iterator it = item_group->begin(); it != item_group->end(); it++)
 					{
 						if (ch->CountSpecifyItem(it->first) >= it->second)
 						{
@@ -1423,7 +1264,7 @@
 		}
 
 		CQuestManager& q = CQuestManager::instance();
-		LPDUNGEON pDungeon = q.GetCurrentDungeon();
+		CDungeon* pDungeon = q.GetCurrentDungeon();
 
 		if (!pDungeon)
 		{
@@ -1638,83 +1479,189 @@
 		return 0;
 	}
 
-#if defined(__CLIENT_TIMER__)
-	struct FSendClientTimer
+#if defined(__DUNGEON_INFO_SYSTEM__)
+	int dungeon_update_rank(lua_State* L)
 	{
-		FSendClientTimer(const DWORD bSubHeader, const DWORD dwEndTime = 0, const DWORD dwAlarmSec = 0)
-			: m_bSubHeader(bSubHeader), m_dwEndTime(dwEndTime), m_dwAlarmSec(dwAlarmSec)
-		{}
-		void operator() (const LPCHARACTER pChar)
+		// DungeonMapIndex, FinishTime, HighestDamage
+		if (!lua_isnumber(L, 1) || !lua_isnumber(L, 2) || !lua_isnumber(L, 3))
+		{
+			sys_err("Invalid argument");
+			return 0;
+		}
+
+		LPCHARACTER ch = CQuestManager::instance().GetCurrentCharacterPtr();
+		DWORD pid = ch->GetPlayerID();
+
+		int map_index = int(lua_tonumber(L, 1));
+		int complete = 1;
+		int time = int(lua_tonumber(L, 2));
+		int damage = int(lua_tonumber(L, 3));
+
+		if (map_index <= 0 || time <= 0 || damage <= 0)
 		{
-			if (pChar != nullptr)
-				pChar->SendClientTimer(m_bSubHeader, m_dwEndTime, m_dwAlarmSec);
+			sys_err("Invalid ranking values");
+			return 0;
 		}
-		BYTE m_bSubHeader;
-		DWORD m_dwEndTime, m_dwAlarmSec;
-	};
 
-	/*
-	* Usage: d.setct(end_time, alarm_sec)
-	* Function: Clears the client timer for all members.
-	* @arg1 - end_time : should be in a timestamp format (time + (duration))
-	* @arg2 - alarm sec : triggers the alarm color with then alarm secs.
-	*/
-	int dungeon_set_client_timer(lua_State* L)
+		char szQuery[1024];
+		snprintf(szQuery, sizeof(szQuery), "SELECT id FROM dungeon_ranking%s WHERE pid = '%u' AND dungeon_index = '%d'", get_table_postfix(), pid, map_index);
+		std::unique_ptr<SQLMsg> pMsg(DBManager::instance().DirectQuery(szQuery));
+		if (pMsg->Get()->uiNumRows > 0)
+		{
+			snprintf(szQuery, sizeof(szQuery), "UPDATE dungeon_ranking%s SET "
+				"completed = completed + '%d', "
+				"time = '%d', "
+				"damage = '%d' "
+				"WHERE pid = '%u' AND dungeon_index = '%d'", get_table_postfix(), complete, time, damage, pid, map_index);
+			SQLMsg* msg = DBManager::instance().DirectQuery(szQuery);
+			M2_DELETE(msg);
+		}
+		else
+		{
+			snprintf(szQuery, sizeof(szQuery), "INSERT INTO dungeon_ranking%s (pid, dungeon_index, completed, time, damage) "
+				"VALUES ('%u', '%d', '%d', '%d', '%d')", get_table_postfix(), pid, map_index, complete, time, damage);
+			SQLMsg* msg = DBManager::instance().DirectQuery(szQuery);
+			M2_DELETE(msg);
+		}
+
+		return 1;
+	}
+
+	int dungeon_get_rank(lua_State* L)
 	{
-		if (!lua_isnumber(L, 1))
+		// DungeonMapIndex, RankingType (Completed|FinishTime|HighestDamage)
+		if (!lua_tonumber(L, 1) || !lua_tonumber(L, 2))
 		{
-			sys_err("Invalid Argument");
+			sys_err("Invalid argument");
 			return 0;
 		}
 
-		DWORD dwEndTime = lua_tonumber(L, 1);
-		DWORD dwAlarmTime = lua_isnumber(L, 2) ? lua_tonumber(L, 2) : 0;
+		LPCHARACTER ch = CQuestManager::instance().GetCurrentCharacterPtr();
 
-		FSendClientTimer ClientTimer(CLIENT_TIMER_SUBHEADER_GC_SET, dwEndTime, dwAlarmTime);
+		int map_index = int(lua_tonumber(L, 1));
+		BYTE rank_type = int(lua_tonumber(L, 2));
+		int limit = 100;
 
-		CQuestManager& rQmgr = CQuestManager::instance();
-		const LPDUNGEON pDungeon = rQmgr.GetCurrentDungeon();
-		if (pDungeon)
-			pDungeon->ForEachMember(ClientTimer);
+		if (map_index <= 0 || rank_type <= 0)
+		{
+			sys_err("Invalid rank arguments");
+			return 0;
+		}
 
-		return 0;
-	}
+		const char* szRankType = "";
+		const char* szOrderBy = "";
+		if (rank_type == 1)
+		{
+			szRankType = "completed";
+			szOrderBy = "DESC";
+		}
+		else if (rank_type == 2)
+		{
+			szRankType = "time";
+			szOrderBy = "ASC";
+		}
+		else if (rank_type == 3)
+		{
+			szRankType = "damage";
+			szOrderBy = "DESC";
+		}
 
-	/*
-	* Usage: d.clearct()
-	* Function: Clears the client timer for all members.
-	*/
-	int dungeon_clear_client_timer(lua_State* L)
-	{
-		FSendClientTimer ClientTimer(CLIENT_TIMER_SUBHEADER_GC_DELETE);
-		CQuestManager& rQmgr = CQuestManager::instance();
-		const LPDUNGEON pDungeon = rQmgr.GetCurrentDungeon();
-		if (pDungeon)
-			pDungeon->ForEachMember(ClientTimer);
+		char szQuery[1024];
+		snprintf(szQuery, sizeof(szQuery), "SELECT "
+			"d.pid AS pid, "
+			"p.name AS name, "
+			"p.level AS level, "
+			"d.completed AS completed, "
+			"d.time AS time, "
+			"d.damage AS damage "
+			"FROM dungeon_ranking%s AS d "
+			"INNER JOIN player%s AS p "
+			"ON d.pid = p.id "
+			"WHERE dungeon_index = '%d' "
+			"ORDER BY d.%s %s LIMIT %d", get_table_postfix(), get_table_postfix(), map_index, szRankType, szOrderBy, limit);
+		std::unique_ptr<SQLMsg> pMsg(DBManager::instance().DirectQuery(szQuery));
 
-		return 0;
+		if (pMsg->Get()->uiNumRows > 0)
+		{
+			ch->ChatPacket(CHAT_TYPE_COMMAND, "CleanDungeonRanking");
+
+			for (int i = 0; i < pMsg->Get()->uiNumRows; ++i)
+			{
+				MYSQL_ROW row = mysql_fetch_row(pMsg->Get()->pSQLResult);
+
+				DWORD pid = 0;
+				str_to_number(pid, row[0]); // pid
+
+				const char* name = row[1]; // name
+
+				int level = 0;
+				str_to_number(level, row[2]); // level
+
+				int points = 0;
+				if (rank_type == 1)
+					str_to_number(points, row[3]); // completed
+				else if (rank_type == 2)
+					str_to_number(points, row[4]); // time
+				else if (rank_type == 3)
+					str_to_number(points, row[5]); // damage
+
+				if (pid == ch->GetPlayerID())
+					ch->ChatPacket(CHAT_TYPE_COMMAND, "UpdateMyDungeonRanking %d %s %d %d", (i + 1), name, level, points);
+
+				ch->ChatPacket(CHAT_TYPE_COMMAND, "UpdateDungeonRanking %s %d %d", name, level, points);
+			}
+		}
+		else
+			// no results
+			return 0;
+
+		return 1;
 	}
-#endif
 
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	int dungeon_battlepass_update_progress(lua_State* L)
+	int dungeon_get_my_rank(lua_State* L)
 	{
-		CQuestManager & q = CQuestManager::instance();
+		// DungeonMapIndex, RankingType (Completed|FinishTime|HighestDamage)
+		if (!lua_tonumber(L, 1) || !lua_tonumber(L, 2))
+		{
+			sys_err("Invalid argument");
+			return 0;
+		}
+
+		LPCHARACTER ch = CQuestManager::instance().GetCurrentCharacterPtr();
+		DWORD pid = ch->GetPlayerID();
+
+		int map_index = int(lua_tonumber(L, 1));
+		BYTE rank_type = int(lua_tonumber(L, 2));
 
-		FDungeonUpdateAllBattlepassProcess f;
-		
-		if (!lua_isnumber(L, 1)) {
-			sys_err("arg1 must be number (dungeon_index)");
+		if (map_index <= 0 || rank_type <= 0)
+		{
+			sys_err("Invalid rank arguments");
 			return 0;
 		}
-		
-		f.dungeon_index = (int)lua_tonumber(L, 1);
 
-		LPDUNGEON pDungeon = q.GetCurrentDungeon();
-		
-		if (pDungeon)
-			pDungeon->ForEachMember(f);
-		return 0;
+		char szQuery[1024];
+		snprintf(szQuery, sizeof(szQuery), "SELECT "
+			"completed, time, damage FROM dungeon_ranking%s WHERE pid = '%u' AND dungeon_index = '%d'", get_table_postfix(), pid, map_index);
+		std::unique_ptr<SQLMsg> pMsg(DBManager::instance().DirectQuery(szQuery));
+
+		if (pMsg->Get()->uiNumRows > 0)
+		{
+			MYSQL_ROW row = mysql_fetch_row(pMsg->Get()->pSQLResult);
+
+			int points = 0;
+			if (rank_type == 1)
+				str_to_number(points, row[0]); // completed
+			else if (rank_type == 2)
+				str_to_number(points, row[1]); // time
+			else if (rank_type == 3)
+				str_to_number(points, row[2]); // damage
+
+			lua_pushnumber(L, points);
+		}
+		else
+			lua_pushnumber(L, 0);
+
+		return 1;
 	}
 #endif
 
@@ -1761,6 +1708,7 @@
 			{ "warp_all", dungeon_warp_all },
 			{ "new_jump_all", dungeon_new_jump_all },
 			{ "new_jump_party", dungeon_new_jump_party },
+			{ "jump_party_with_opp_leader", dungeon_jump_party_with_opp_leader },
 			{ "new_jump", dungeon_new_jump },
 			{ "regen_file", dungeon_regen_file },
 			{ "set_regen_file", dungeon_set_regen_file },
@@ -1778,29 +1726,17 @@
 			{ "select", dungeon_select },
 			{ "find", dungeon_find },
 			{ "notice", dungeon_notice },
-			{ "mission_msg", dungeon_mission_msg },
-			{ "sub_mission_msg", dungeon_sub_mission_msg },
-			{ "clear_mission_msg", dungeon_clear_mission_msg },
 			{ "setqf", dungeon_set_quest_flag },
 			{ "all_near_to", dungeon_all_near_to },
 			{ "set_warp_location", dungeon_set_warp_location },
 			{ "setqf2", dungeon_set_quest_flag2 },
-#if defined(__DUNGEON_RENEWAL__)
-			{ "create", dungeon_create },
-			{ "destroy", dungeon_destroy },
-			{ "setf_for_map_index", dungeon_set_flag_for_map_index },
-			{ "spawn_for_map_index", dungeon_spawn_mob_for_map_index },
-			{ "party_notice", dungeon_party_notice },
-			{ "syschat", dungeon_syschat },
-			{ "setqf2_all_near", dungeon_set_quest_flag2_all_near },
-#endif
-#if defined(__CLIENT_TIMER__)
-			{ "setct", dungeon_set_client_timer },
-			{ "clearct", dungeon_clear_client_timer },
-#endif
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-			{ "battlepass_update_progress", dungeon_battlepass_update_progress },
+
+#if defined(__DUNGEON_INFO_SYSTEM__)
+			{ "update_rank", dungeon_update_rank },
+			{ "get_rank", dungeon_get_rank },
+			{ "get_my_rank", dungeon_get_my_rank },
 #endif
+
 			{ NULL, NULL }
 		};
 
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/questlua_game.cpp final/server/server/home/metin2/Source/Server/game/src/questlua_game.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/questlua_game.cpp	2024-12-28 03:09:38.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/questlua_game.cpp	2022-04-27 12:48:24.000000000 +0000
@@ -11,22 +11,18 @@
 #include "config.h"
 
 #if defined(__DICE_SYSTEM__)
-#	include "party.h"
+#include "party.h"
 #endif
 
-#if defined(__SUMMER_EVENT_ROULETTE__)
-#	include "minigame_roulette.h"
-#endif
-
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-#	include "db.h"
+#if defined(__MINI_GAME_CATCH_KING__)
+#include "minigame.h"
 #endif
 
 #undef sys_err
 #ifndef __WIN32__
-#	define sys_err(fmt, args...) quest::CQuestManager::instance().QuestError(__FUNCTION__, __LINE__, fmt, ##args)
+#define sys_err(fmt, args...) quest::CQuestManager::instance().QuestError(__FUNCTION__, __LINE__, fmt, ##args)
 #else
-#	define sys_err(fmt, ...) quest::CQuestManager::instance().QuestError(__FUNCTION__, __LINE__, fmt, __VA_ARGS__)
+#define sys_err(fmt, ...) quest::CQuestManager::instance().QuestError(__FUNCTION__, __LINE__, fmt, __VA_ARGS__)
 #endif
 
 extern ACMD(do_in_game_mall);
@@ -143,31 +139,21 @@
 		LPITEM item = NULL;
 		switch (lua_gettop(L))
 		{
-			case 1:
-				item = ITEM_MANAGER::instance().CreateItem((DWORD)lua_tonumber(L, 1));
-				break;
-			case 2:
-			case 3:
-				item = ITEM_MANAGER::instance().CreateItem((DWORD)lua_tonumber(L, 1), (int)lua_tonumber(L, 2));
-				break;
-			default:
-				return 0;
+		case 1:
+			item = ITEM_MANAGER::instance().CreateItem((DWORD)lua_tonumber(L, 1));
+			break;
+		case 2:
+		case 3:
+			item = ITEM_MANAGER::instance().CreateItem((DWORD)lua_tonumber(L, 1), (int)lua_tonumber(L, 2));
+			break;
+		default:
+			return 0;
 		}
 
 		if (item == NULL)
-			return 0;
-
-#if defined(__PET_SYSTEM__) && defined(__PET_LOOT__)
-		if (ch->GetPetSystem() && ch->GetPetSystem()->LootItem(item))
 		{
-			ch->AutoGiveItem(item, true, true
-#if defined(__WJ_PICKUP_ITEM_EFFECT__)
-				, true
-#endif
-			);
 			return 0;
 		}
-#endif
 
 		if (lua_isnumber(L, 3))
 		{
@@ -200,15 +186,15 @@
 		LPITEM item = NULL;
 		switch (lua_gettop(L))
 		{
-			case 1:
-				item = ITEM_MANAGER::instance().CreateItem((DWORD)lua_tonumber(L, 1));
-				break;
-			case 2:
-			case 3:
-				item = ITEM_MANAGER::instance().CreateItem((DWORD)lua_tonumber(L, 1), (int)lua_tonumber(L, 2));
-				break;
-			default:
-				return 0;
+		case 1:
+			item = ITEM_MANAGER::instance().CreateItem((DWORD)lua_tonumber(L, 1));
+			break;
+		case 2:
+		case 3:
+			item = ITEM_MANAGER::instance().CreateItem((DWORD)lua_tonumber(L, 1), (int)lua_tonumber(L, 2));
+			break;
+		default:
+			return 0;
 		}
 
 		if (item == NULL)
@@ -217,21 +203,11 @@
 		}
 
 		LPCHARACTER ch = CQuestManager::instance().GetCurrentCharacterPtr();
-
-		FPartyDropDiceRoll f(item, ch);
-		f.Process(NULL);
-
-#if defined(__PET_SYSTEM__) && defined(__PET_LOOT__)
-		if ((f.GetItemOwner() == ch) && (ch->GetPetSystem() && ch->GetPetSystem()->LootItem(item)))
+		if (ch->GetParty())
 		{
-			ch->AutoGiveItem(item, true, true
-#if defined(__WJ_PICKUP_ITEM_EFFECT__)
-				, true
-#endif
-			);
-			return 0;
+			FPartyDropDiceRoll f(item, ch);
+			f.Process(NULL);
 		}
-#endif
 
 		if (lua_isnumber(L, 3))
 		{
@@ -270,52 +246,46 @@
 		return 0;
 	}
 
-#if defined(__MINI_GAME_RUMI__)
-	int game_get_minigame_rumi_score(lua_State* L)
+#if defined(__GEM_MARKET_SYSTEM__)
+	int game_open_gem_c(lua_State*)
 	{
-		bool bTotal = lua_toboolean(L, 1);
-		CMiniGameRumi::GetScoreTable(L, bTotal);
-		return 1;
+		CQuestManager& q = CQuestManager::instance();
+		LPCHARACTER ch = q.GetCurrentCharacterPtr();
+		ch->ChatPacket(CHAT_TYPE_COMMAND, "OpenGuiGem");
+		return 0;
 	}
 
-	int game_get_minigame_rumi_my_score(lua_State* L)
+	int game_open_gem_m(lua_State*)
 	{
-		LPCHARACTER pChar = CQuestManager::instance().GetCurrentCharacterPtr();
-		bool bTotal = lua_toboolean(L, 1);
-		lua_pushnumber(L, pChar ? CMiniGameRumi::GetMyScoreValue(L, pChar->GetPlayerID(), bTotal) : 0);
-		return 1;
-	}
-#endif
+		CQuestManager& q = CQuestManager::instance();
+		LPCHARACTER ch = q.GetCurrentCharacterPtr();
 
-#if defined(__MINI_GAME_YUTNORI__)
-	int game_get_minigame_yutnori_score(lua_State* L)
-	{
-		bool bTotal = lua_toboolean(L, 1);
-		CMiniGameYutnori::GetScoreTable(L, bTotal);
-		return 1;
-	}
+		if (ch->CheckItemsFull() == false)
+		{
+			//ch->SetGemState("gem_refresh_time", init_gemTime() + (60*60*5));
+			ch->UpdateItemsGemMarker();
+			ch->InfoGemMarker();
+			ch->StartCheckTimeMarket();
+		}
+		else
+		{
+			ch->InfoGemMarker();
+			ch->StartCheckTimeMarket();
+		}
 
-	int game_get_minigame_yutnori_my_score(lua_State* L)
-	{
-		LPCHARACTER pChar = CQuestManager::instance().GetCurrentCharacterPtr();
-		bool bTotal = lua_toboolean(L, 1);
-		lua_pushnumber(L, pChar ? CMiniGameYutnori::GetMyScoreValue(L, pChar->GetPlayerID(), bTotal) : 0);
-		return 1;
+		ch->ChatPacket(CHAT_TYPE_COMMAND, "OpenGuiGemMarket");
+
+		return 0;
 	}
 #endif
 
 #if defined(__MINI_GAME_CATCH_KING__)
-	int game_get_catchking_score(lua_State* L)
+	int mini_game_catch_king_get_score(lua_State* L)
 	{
-		const bool c_bTotal = lua_toboolean(L, 1);
-		CMiniGameCatchKing::GetScore(L, c_bTotal);
-		return 1;
-	}
+		DWORD dwArg = (DWORD)lua_tonumber(L, 1);
+		bool isTotal = dwArg ? true : false;
 
-	int game_get_catchking_myscore(lua_State* L)
-	{
-		LPCHARACTER ch = CQuestManager::instance().GetCurrentCharacterPtr();
-		lua_pushnumber(L, CMiniGameCatchKing::GetMyScore(ch));
+		CMiniGameManager::instance().MiniGameCatchKingGetScore(L, isTotal);
 		return 1;
 	}
 #endif
@@ -339,17 +309,6 @@
 		return 1;
 	}
 
-#if defined(__MOVE_COSTUME_ATTR__)
-	int game_open_item_comb(lua_State* L)
-	{
-		const LPCHARACTER ch = CQuestManager::instance().GetCurrentCharacterPtr();
-		if (ch)
-			ch->OpenItemComb();
-
-		return 0;
-	}
-#endif
-
 #if defined(__MAILBOX__)
 	int game_open_mailbox(lua_State* L)
 	{
@@ -379,188 +338,6 @@
 	}
 #endif
 
-#if defined(__ACCE_COSTUME_SYSTEM__)
-	int game_open_acce_refine(lua_State* L)
-	{
-		const LPCHARACTER pChar = CQuestManager::instance().GetCurrentCharacterPtr();
-		if (pChar == nullptr)
-			return 0;
-
-		if (lua_isnumber(L, 1))
-		{
-			const BYTE bType = static_cast<BYTE>(lua_tonumber(L, 1));
-			pChar->AcceRefineWindowOpen(CQuestManager::instance().GetCurrentNPCCharacterPtr(), bType);
-		}
-		return 0;
-	}
-#endif
-
-#if defined(__AURA_COSTUME_SYSTEM__)
-	int game_open_aura_refine(lua_State* L)
-	{
-		const LPCHARACTER pChar = CQuestManager::instance().GetCurrentCharacterPtr();
-		if (pChar == nullptr)
-			return 0;
-
-		if (lua_isnumber(L, 1))
-		{
-			const BYTE bType = static_cast<BYTE>(lua_tonumber(L, 1));
-			pChar->OpenAuraRefineWindow(CQuestManager::instance().GetCurrentNPCCharacterPtr(), bType);
-		}
-
-		return 0;
-	}
-#endif
-
-#if defined(__CHANGE_LOOK_SYSTEM__)
-	int game_open_changelook(lua_State* L)
-	{
-		const LPCHARACTER pChar = CQuestManager::instance().GetCurrentCharacterPtr();
-		if (pChar == nullptr)
-			return 0;
-
-		if (lua_isnumber(L, 1))
-		{
-			const BYTE bType = static_cast<BYTE>(lua_tonumber(L, 1));
-			CChangeLook::Open(pChar, bType);
-		}
-		return 0;
-	}
-#endif
-
-#if defined(__RANKING_SYSTEM__)
-	int game_open_ranking(lua_State* L)
-	{
-		if (lua_isnumber(L, 1) && lua_isnumber(L, 2))
-		{
-			const LPCHARACTER c_lpCh = CQuestManager::instance().GetCurrentCharacterPtr();
-			const BYTE c_bType = lua_tonumber(L, 1);
-			const BYTE c_bCategory = lua_tonumber(L, 2);
-			CRanking::Open(c_lpCh, c_bType, c_bCategory);
-		}
-		return 0;
-	}
-#endif
-
-#if defined(__GEM_SHOP__)
-	int game_open_gem_shop(lua_State* L)
-	{
-#if defined(__CONQUEROR_LEVEL__)
-		bool bSpecial = lua_isboolean(L, 1) ? lua_toboolean(L, 1) : false;
-		CGemShop::Open(CQuestManager::instance().GetCurrentCharacterPtr(), bSpecial);
-#else
-		CGemShop::Open(CQuestManager::instance().GetCurrentCharacterPtr());
-#endif
-		return 0;
-	}
-#endif
-
-#if defined(__CUBE_RENEWAL__)
-	int game_open_cube(lua_State* L)
-	{
-		CCubeManager::Instance().OpenCube(CQuestManager::instance().GetCurrentCharacterPtr());
-		return 0;
-	}
-#endif
-
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-	int game_open_guild_dragonlair_ranking(lua_State* L)
-	{
-		if (!lua_isnumber(L, 1) && !lua_isnumber(L, 2))
-		{
-			sys_err("QUEST: Wrong argument");
-			return 0;
-		}
-
-		BYTE bType = static_cast<BYTE>(lua_tonumber(L, 1));
-		DWORD dwLimit = static_cast<DWORD>(lua_tonumber(L, 2));
-
-		const LPCHARACTER pCharacter = CQuestManager::instance().GetCurrentCharacterPtr();
-		if (pCharacter == NULL || pCharacter->GetDesc() == NULL)
-			return 0;
-
-		char szQuery[1024];
-		snprintf(szQuery, sizeof(szQuery), "SELECT"
-			" `ranking`.`type`,"
-			" `guild`.`id`,"
-			" `guild`.`name`,"
-			" `ranking`.`member_count`,"
-			" `ranking`.`time`"
-			" FROM `guild_dragonlair_ranking%s` AS `ranking`"
-			" JOIN `guild%s` AS `guild` ON `ranking`.`guild_id` = `guild`.`id`"
-			" WHERE `ranking`.`type` = %u"
-			" ORDER BY `ranking`.`time` ASC LIMIT %u;"
-			, get_table_postfix()
-			, get_table_postfix()
-			, bType
-			, dwLimit
-		);
-
-		std::unique_ptr<SQLMsg> pMsg(DBManager::instance().DirectQuery(szQuery));
-		if (pMsg->uiSQLErrno)
-			return 0;
-
-		TEMP_BUFFER TempBuffer;
-		MYSQL_ROW RowData;
-
-		while ((RowData = mysql_fetch_row(pMsg->Get()->pSQLResult)))
-		{
-			BYTE bIndex = 0;
-			TPacketGCGuildDragonLairRanking DataTable;
-
-			str_to_number(DataTable.bType, RowData[bIndex++]);
-			str_to_number(DataTable.dwGuildID, RowData[bIndex++]);
-			strlcpy(DataTable.szGuildName, RowData[bIndex++], sizeof(DataTable.szGuildName));
-			str_to_number(DataTable.bMemberCount, RowData[bIndex++]);
-			str_to_number(DataTable.dwTime, RowData[bIndex++]);
-
-			TempBuffer.write(&DataTable, sizeof(DataTable));
-		}
-
-		TPacketGCGuildDragonLair Packet;
-		Packet.bHeader = HEADER_GC_GUILD_DRAGONLAIR;
-		Packet.bSubHeader = GUILD_DRAGONLAIR_GC_SUBHEADER_RANKING;
-		Packet.wSize = sizeof(Packet) + TempBuffer.size();
-		Packet.bType = bType;
-		if (TempBuffer.size())
-		{
-			pCharacter->GetDesc()->BufferedPacket(&Packet, sizeof(Packet));
-			pCharacter->GetDesc()->Packet(TempBuffer.read_peek(), TempBuffer.size());
-		}
-		else
-			pCharacter->GetDesc()->Packet(&Packet, sizeof(Packet));
-
-		return 0;
-	}
-#endif
-
-#if defined(__SUMMER_EVENT_ROULETTE__)
-	int game_open_minigame_roulette(lua_State* L)
-	{
-		const LPCHARACTER pNPC = CQuestManager::instance().GetCurrentNPCCharacterPtr();
-		const LPCHARACTER pChar = CQuestManager::instance().GetCurrentCharacterPtr();
-		if (lua_isnumber(L, 1) && (pNPC && pChar))
-		{
-			const BYTE bType = static_cast<BYTE>(lua_tonumber(L, 1));
-			CMiniGameRoulette::Open(pNPC, pChar, bType);
-		}
-		return 0;
-	}
-
-	int game_get_minigame_roulette_score(lua_State* L)
-	{
-		CMiniGameRoulette::GetScoreTable(L);
-		return 1;
-	}
-
-	int game_get_minigame_roulette_my_score(lua_State* L)
-	{
-		LPCHARACTER pChar = CQuestManager::instance().GetCurrentCharacterPtr();
-		lua_pushnumber(L, pChar ? CMiniGameRoulette::GetMyScoreValue(L, pChar->GetPlayerID()) : 0);
-		return 1;
-	}
-#endif
-
 	void RegisterGameFunctionTable()
 	{
 		luaL_reg game_functions[] =
@@ -574,56 +351,23 @@
 			{ "set_event_flag", game_set_event_flag },
 			{ "drop_item", game_drop_item },
 			{ "drop_item_with_ownership", game_drop_item_with_ownership },
+			{ "open_web_mall", game_web_mall },
 #if defined(__DICE_SYSTEM__)
 			{ "drop_item_with_ownership_and_dice", game_drop_item_with_ownership_and_dice },
 #endif
-			{ "open_web_mall", game_web_mall },
-#if defined(__MINI_GAME_RUMI__)
-			{ "get_minigame_rumi_score", game_get_minigame_rumi_score },
-			{ "get_minigame_rumi_my_score", game_get_minigame_rumi_my_score },
-#endif
-#if defined(__MINI_GAME_YUTNORI__)
-			{ "get_minigame_yutnori_score", game_get_minigame_yutnori_score },
-			{ "get_minigame_yutnori_my_score", game_get_minigame_yutnori_my_score },
+#if defined(__GEM_MARKET_SYSTEM__)
+			{ "open_gem", game_open_gem_c },
+			{ "open_gem_market", game_open_gem_m },
 #endif
 #if defined(__MINI_GAME_CATCH_KING__)
-			{ "get_catchking_score", game_get_catchking_score },
-			{ "get_catchking_myscore", game_get_catchking_myscore },
+			{ "mini_game_catch_king_get_score", mini_game_catch_king_get_score },
 #endif
 			{ "get_config", game_get_config },
-#if defined(__MOVE_COSTUME_ATTR__)
-			{ "open_item_comb", game_open_item_comb },
-#endif
 #if defined(__MAILBOX__)
 			{ "open_mailbox", game_open_mailbox },
 			{ "send_gm_mail", game_send_gm_mail },
 #endif
-#if defined(__ACCE_COSTUME_SYSTEM__)
-			{ "open_acce_refine", game_open_acce_refine },
-#endif
-#if defined(__AURA_COSTUME_SYSTEM__)
-			{ "open_aura_refine", game_open_aura_refine },
-#endif
-#if defined(__CHANGE_LOOK_SYSTEM__)
-			{ "open_changelook", game_open_changelook },
-#endif
-#if defined(__RANKING_SYSTEM__)
-			{ "open_ranking", game_open_ranking },
-#endif
-#if defined(__GEM_SHOP__)
-			{ "open_gem_shop", game_open_gem_shop },
-#endif
-#if defined(__CUBE_RENEWAL__)
-			{ "open_cube", game_open_cube },
-#endif
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-			{ "open_guild_dragonlair_ranking", game_open_guild_dragonlair_ranking },
-#endif
-#if defined(__SUMMER_EVENT_ROULETTE__)
-			{ "open_minigame_roulette", game_open_minigame_roulette },
-			{ "get_minigame_roulette_score", game_get_minigame_roulette_score },
-			{ "get_minigame_roulette_my_score", game_get_minigame_roulette_my_score },
-#endif
+
 			{ NULL, NULL }
 		};
 
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/questlua_global.cpp final/server/server/home/metin2/Source/Server/game/src/questlua_global.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/questlua_global.cpp	2024-12-28 03:09:38.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/questlua_global.cpp	2022-04-27 12:49:11.000000000 +0000
@@ -38,7 +38,28 @@
 {
 	int _get_locale(lua_State* L)
 	{
-		lua_pushstring(L, g_stLocale.c_str());
+		LPCHARACTER ch = CQuestManager::instance().GetCurrentCharacterPtr();
+		lua_pushstring(L, ch ? get_locale(ch->GetLanguage()) : get_locale(LOCALE_DEFAULT));
+		return 1;
+	}
+
+	int _locale_quest(lua_State* L)
+	{
+		if (lua_isnumber(L, 1))
+		{
+			LPCHARACTER ch = CQuestManager::instance().GetCurrentCharacterPtr();
+			if (ch)
+			{
+				char szBuf[1024 + 1] = {};
+				snprintf(szBuf, sizeof(szBuf), "%s ", LC_LOCALE_QUEST_TEXT(lua_tonumber(L, 1), ch->GetLanguage()));
+				lua_pushstring(L, szBuf);
+			}
+			else
+				lua_pushstring(L, "");
+		}
+		else
+			lua_pushstring(L, "");
+
 		return 1;
 	}
 
@@ -297,6 +318,12 @@
 		return 1;
 	}
 
+	int _is_speed_server(lua_State* L)
+	{
+		lua_pushboolean(L, speed_server);
+		return 1;
+	}
+
 	int _raw_script(lua_State* L)
 	{
 		if (test_server)
@@ -554,7 +581,7 @@
 				if (found)
 					os << ", ";
 
-				os << c_apszPrivNames[type] << " : " <<
+				os << LC_TEXT(c_apszPrivNames[type]) << " : " <<
 					pkPrivEmpireData->m_value << "%" << " (" <<
 					((pkPrivEmpireData->m_end_time_sec - get_global_time()) / 3600.0f) << " hours)" << endl;
 				found = true;
@@ -597,7 +624,7 @@
 				if (found)
 					os << ", ";
 
-				os << c_apszPrivNames[type] << " : " << pPrivGuildData->value << "%"
+				os << LC_TEXT(c_apszPrivNames[type]) << " : " << pPrivGuildData->value << "%"
 					<< " (" << ((pPrivGuildData->end_time_sec - get_global_time()) / 3600.0f) << " hours)" << endl;
 				found = true;
 			}
@@ -649,13 +676,18 @@
 		{
 			DWORD dwVnum = (DWORD)lua_tonumber(L, 1);
 			TItemTable* pTable = ITEM_MANAGER::instance().GetTable(dwVnum);
+
 			if (pTable)
-				lua_pushstring(L, pTable->szLocaleName);
+			{
+				LPCHARACTER ch = CQuestManager::instance().GetCurrentCharacterPtr();
+				lua_pushstring(L, LC_LOCALE_ITEM_TEXT(dwVnum, ch ? ch->GetLanguage() : LOCALE_DEFAULT));
+			}
 			else
 				lua_pushstring(L, "");
 		}
 		else
 			lua_pushstring(L, "");
+
 		return 1;
 	}
 
@@ -667,7 +699,10 @@
 			const CMob* pkMob = CMobManager::instance().Get(dwVnum);
 
 			if (pkMob)
-				lua_pushstring(L, pkMob->m_table.szLocaleName);
+			{
+				LPCHARACTER ch = CQuestManager::instance().GetCurrentCharacterPtr();
+				lua_pushstring(L, LC_LOCALE_MOB_TEXT(dwVnum, ch ? ch->GetLanguage() : LOCALE_DEFAULT));
+			}
 			else
 				lua_pushstring(L, "");
 		}
@@ -694,6 +729,21 @@
 		return 1;
 	}
 
+	int _skill_name(lua_State* L)
+	{
+		if (lua_isnumber(L, 1))
+		{
+			DWORD dwVnum = (DWORD)lua_tonumber(L, 1);
+
+			LPCHARACTER ch = CQuestManager::instance().GetCurrentCharacterPtr();
+			lua_pushstring(L, LC_LOCALE_SKILL_TEXT(dwVnum, ch ? ch->GetLanguage() : LOCALE_DEFAULT));
+		}
+		else
+			lua_pushstring(L, "");
+
+		return 1;
+	}
+
 	int _get_global_time(lua_State* L)
 	{
 		lua_pushnumber(L, get_global_time());
@@ -882,20 +932,50 @@
 
 	int _notice_all(lua_State* L)
 	{
+		if (lua_gettop(L) > MAX_QUEST_NOTICE_ARGS + 1)
+		{
+			sys_err("QUEST invalid argument.");
+			return 0;
+		}
+
+		char szNoticeBuf[MAX_QUEST_NOTICE_ARGS + 1][CHAT_MAX_LEN + 1];
+		int iLen;
+		for (int i = 0; i < (MAX_QUEST_NOTICE_ARGS + 1); i++)
+		{
+			iLen = snprintf(szNoticeBuf[i], sizeof(szNoticeBuf[i]), "%s", lua_tostring(L, 1 + i));
+
+			if (iLen < 0 || iLen >= (int)sizeof(szNoticeBuf[i]))
+				iLen = sizeof(szNoticeBuf[i]) - 1;
+		}
+
+		TPacketGGLocaleNotice GGPacket;
+		GGPacket.bHeader = HEADER_GG_LOCALE_NOTICE;
+		GGPacket.bBigFont = false;
+		for (int i = 0; i < (MAX_QUEST_NOTICE_ARGS + 1); i++)
+			strlcpy(GGPacket.szNotice[i], szNoticeBuf[i], sizeof(GGPacket.szNotice[i]));
+		P2P_MANAGER::instance().Send(&GGPacket, sizeof(TPacketGGLocaleNotice));
+
+		SendLocaleNotice(szNoticeBuf[0], false, szNoticeBuf[1], szNoticeBuf[2], szNoticeBuf[3], szNoticeBuf[4], szNoticeBuf[5]);
+
+		return 1;
+	}
+
+	int _big_notice_all(lua_State* L)
+	{
 		ostringstream s;
 		combine_lua_string(L, s);
 
-		TPacketGGNotice p;
-		p.bHeader = HEADER_GG_NOTICE;
+		TPacketGGBigNotice p;
+		p.bHeader = HEADER_GG_BIG_NOTICE;
 		p.lSize = strlen(s.str().c_str()) + 1;
 
 		TEMP_BUFFER buf;
 		buf.write(&p, sizeof(p));
 		buf.write(s.str().c_str(), p.lSize);
 
-		P2P_MANAGER::instance().Send(buf.read_peek(), buf.size()); // HEADER_GG_NOTICE
+		P2P_MANAGER::instance().Send(buf.read_peek(), buf.size()); // HEADER_GG_BIG_NOTICE
 
-		SendNotice(s.str().c_str());
+		SendBigNotice(s.str().c_str());
 		return 1;
 	}
 
@@ -964,7 +1044,7 @@
 
 		event_create(warp_all_to_village_event, info, PASSES_PER_SEC(iSec));
 
-		SendNoticeMap(LC_STRING("   ̵˴ϴ."), iMapIndex, false);
+		SendNoticeMap("   ̵˴ϴ.", iMapIndex, false);
 
 		return 0;
 	}
@@ -1019,11 +1099,7 @@
 			{
 				LPCHARACTER ch = (LPCHARACTER)ent;
 
-				if (!ch->IsPC()
-#if defined(__PET_SYSTEM__)
-					&& !ch->IsPet()
-#endif
-					)
+				if (!ch->IsPC() && !ch->IsPet() && !ch->IsGrowthPet())
 					ch->Dead();
 			}
 		}
@@ -1186,34 +1262,16 @@
 
 	int _notice_in_map(lua_State* L)
 	{
-		const LPCHARACTER pChar = CQuestManager::instance().GetCurrentCharacterPtr();
-		if (NULL != pChar)
-			SendNoticeMap(lua_tostring(L, 1), pChar->GetMapIndex(), lua_toboolean(L, 2));
+		if (lua_isboolean(L, 2) == false)
+		{
+			sys_err("QUEST invalid 2 argument, must be boolean.");
+			return 0;
+		}
 
-		return 0;
-	}
+		const LPCHARACTER c_pChar = CQuestManager::instance().GetCurrentCharacterPtr();
+		if (c_pChar != nullptr)
+			SendNoticeMap(lua_tostring(L, 1), c_pChar->GetMapIndex(), lua_toboolean(L, 2) /* bBigFont */);
 
-	int _mission_msg(lua_State* L)
-	{
-		ostringstream s;
-		combine_lua_string(L, s);
-		CQuestManager::Instance().GetCurrentCharacterPtr()->ChatPacket(CHAT_TYPE_MISSION, "%s", s.str().c_str());
-		return 0;
-	}
-
-	int _sub_mission_msg(lua_State* L)
-	{
-		ostringstream s;
-		combine_lua_string(L, s);
-		CQuestManager::Instance().GetCurrentCharacterPtr()->ChatPacket(CHAT_TYPE_SUB_MISSION, "%s", s.str().c_str());
-		return 0;
-	}
-	
-	int _clear_mission_msg(lua_State* L)
-	{
-		ostringstream s;
-		combine_lua_string(L, s);
-		CQuestManager::Instance().GetCurrentCharacterPtr()->ChatPacket(CHAT_TYPE_MISSION, "");
 		return 0;
 	}
 
@@ -1236,17 +1294,14 @@
 
 		void operator () (LPENTITY ent)
 		{
-			if (ent->IsType(ENTITY_CHARACTER))
+			if (true == ent->IsType(ENTITY_CHARACTER))
 			{
 				LPCHARACTER pChar = static_cast<LPCHARACTER>(ent);
+
 				if (pChar == ExceptChar)
 					return;
 
-				if ((true == pChar->IsMonster() || true == pChar->IsStone())
-#if defined(__PET_SYSTEM__)
-					&& !pChar->IsPet()
-#endif
-					)
+				if (!pChar->IsPet() && (true == pChar->IsMonster() || true == pChar->IsStone()))
 				{
 					if (x1 <= pChar->GetX() && pChar->GetX() <= x2 && y1 <= pChar->GetY() && pChar->GetY() <= y2)
 					{
@@ -1363,7 +1418,7 @@
 			return 0;
 		}
 
-		const CSpecialItemGroup* pItemGroup = ITEM_MANAGER::Instance().GetSpecialItemGroup((DWORD)lua_tonumber(L, 1));
+		const CSpecialItemGroup* pItemGroup = ITEM_MANAGER::instance().GetSpecialItemGroup((DWORD)lua_tonumber(L, 1));
 
 		if (!pItemGroup)
 		{
@@ -1453,51 +1508,85 @@
 		return 0;
 	}
 
-#if defined(__MINI_GAME_RUMI__) || defined(__MINI_GAME_YUTNORI__) || defined(__MINI_GAME_CATCH_KING__)
-	int _show_special_item_group(lua_State* L)
+	// #if defined(__TEMPLE_OCHAO__)
+	struct FMobCounter
 	{
-		if (!lua_isnumber(L, 1))
+		int nCount;
+		DWORD iSpecificVnum;
+
+		FMobCounter(DWORD specificVnum)
 		{
-			sys_err("invalid argument");
-			return 0;
+			iSpecificVnum = specificVnum;
+			nCount = 0;
 		}
 
-		const CSpecialItemGroup* pItemGroup = ITEM_MANAGER::instance().GetSpecialItemGroup((DWORD)lua_tonumber(L, 1));
-
-		if (!pItemGroup)
+		void operator () (LPENTITY ent)
 		{
-			sys_err("cannot find special item group %d", (DWORD)lua_tonumber(L, 1));
-			return 0;
-		}
+			if (ent->IsType(ENTITY_CHARACTER))
+			{
+				LPCHARACTER pChar = static_cast<LPCHARACTER>(ent);
 
-		int index = 1;
-		int count = pItemGroup->GetGroupSize();
+				if (iSpecificVnum)
+				{
+					if (pChar->GetRaceNum() == iSpecificVnum)
+						nCount++;
 
-		lua_newtable(L);
-		for (int i = 0; i < count; i++)
+					return;
+				}
+			}
+		}
+	};
+
+	int _find_boss_by_vnum(lua_State* L)
+	{
+		if (!lua_isnumber(L, 1))
 		{
-			lua_newtable(L);
+			sys_err("invalid argument");
+			lua_pushnumber(L, 0);
+			return 1;
+		}
 
-			lua_pushnumber(L, pItemGroup->GetVnum(i));
-			lua_rawseti(L, -2, 1);
+		DWORD boss = (DWORD)lua_tonumber(L, 1);
 
-			lua_pushnumber(L, pItemGroup->GetCount(i));
-			lua_rawseti(L, -2, 2);
+		LPCHARACTER ch = CQuestManager::instance().GetCurrentCharacterPtr();
+		LPSECTREE_MAP pSectree = SECTREE_MANAGER::instance().GetMap(ch->GetMapIndex());
 
-			if (lua_isnumber(L, 2))
-			{
-				if ((i + 1) % (int)lua_tonumber(L, 2) == 0)
-					lua_pushnumber(L, i + 1);
-				else
-					lua_pushnumber(L, 0);
-				lua_rawseti(L, -2, 3);
-			}
+		if (pSectree == NULL)
+		{
+			lua_pushnumber(L, 0);
+			return 1;
+		}
 
-			lua_rawseti(L, -2, index++);
+		FMobCounter f(boss);
+		pSectree->for_each(f);
+
+		if (boss)
+		{
+			lua_pushnumber(L, f.nCount);
+			return 1;
 		}
 
+		lua_pushnumber(L, 0);
 		return 1;
 	}
+	// #endif
+
+#if defined(__12ZI_NOTICE__)
+	int _notice_mission(lua_State* L)
+	{
+		ostringstream s;
+		combine_lua_string(L, s);
+		CQuestManager::Instance().GetCurrentCharacterPtr()->ChatPacket(CHAT_TYPE_MISSION, "%s", s.str().c_str());
+		return 0;
+	}
+
+	int _notice_sub_mission(lua_State* L)
+	{
+		ostringstream s;
+		combine_lua_string(L, s);
+		CQuestManager::Instance().GetCurrentCharacterPtr()->ChatPacket(CHAT_TYPE_SUB_MISSION, "%s", s.str().c_str());
+		return 0;
+	}
 #endif
 
 	void RegisterGlobalFunctionTable(lua_State* L)
@@ -1530,6 +1619,7 @@
 			{ "cleartimer", _clear_named_timer },
 			{ "getnpcid", _getnpcid },
 			{ "is_test_server", _is_test_server },
+			{ "is_speed_server", _is_speed_server },
 			{ "raw_script", _raw_script },
 			{ "number", _number },
 
@@ -1572,10 +1662,8 @@
 			{ "notice", _notice },
 			{ "big_notice", _big_notice },
 			{ "notice_all", _notice_all },
+			{ "big_notice_all", _big_notice_all },
 			{ "notice_in_map", _notice_in_map },
-			{ "mission_msg", _mission_msg },
-			{ "sub_mission_msg", _sub_mission_msg },
-			{ "clear_mission_msg", _clear_mission_msg },
 			{ "warp_all_to_village", _warp_all_to_village },
 			{ "warp_to_village", _warp_to_village },
 			{ "say_in_map", _say_in_map },
@@ -1590,9 +1678,17 @@
 			{ "get_special_item_group", _get_special_item_group },
 			{ "add_restart_city_pos", _add_restart_city_pos },
 			{ "set_quest_flag_in_area", _set_quest_flag_in_area },
-#if defined(__MINI_GAME_RUMI__) || defined(__MINI_GAME_YUTNORI__) || defined(__MINI_GAME_CATCH_KING__)
-			{ "show_special_item_group", _show_special_item_group },
+			{ "find_boss_by_vnum", _find_boss_by_vnum },
+
+#if defined(__12ZI_NOTICE__)
+			{ "notice_mission", _notice_mission },
+			{ "notice_sub_mission", _notice_sub_mission },
 #endif
+
+			{ "LC", _get_locale },
+			{ "locale_quest", _locale_quest },
+			{ "skill_name", _skill_name },
+
 			{ NULL, NULL }
 		};
 
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/safebox.cpp final/server/server/home/metin2/Source/Server/game/src/safebox.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/safebox.cpp	2026-02-17 17:38:00.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/safebox.cpp	2022-04-27 12:49:22.000000000 +0000
@@ -1,369 +1,338 @@
-#include "stdafx.h"
-#include "../../libgame/include/grid.h"
-#include "constants.h"
-#include "safebox.h"
-#include "packet.h"
-#include "char.h"
-#include "desc_client.h"
-#include "item.h"
-#include "item_manager.h"
-#include "config.h"
-
-CSafebox::CSafebox(LPCHARACTER pkChrOwner, int iSize, DWORD dwGold) : m_pkChrOwner(pkChrOwner), m_iSize(iSize), m_lGold(dwGold)
-{
-	assert(m_pkChrOwner != NULL);
-	memset(m_pkItems, 0, sizeof(m_pkItems));
-
-	if (m_iSize)
-		m_pkGrid = M2_NEW CGrid(5, m_iSize);
-	else
-		m_pkGrid = NULL;
-
-	m_bWindowMode = SAFEBOX;
-}
-
-CSafebox::~CSafebox()
-{
-	__Destroy();
-}
-
-void CSafebox::SetWindowMode(BYTE bMode)
-{
-	m_bWindowMode = bMode;
-}
-
-void CSafebox::__Destroy()
-{
-	for (int i = 0; i < SAFEBOX_MAX_NUM; ++i)
-	{
-		if (m_pkItems[i])
-		{
-			m_pkItems[i]->SetSkipSave(true);
-			ITEM_MANAGER::instance().FlushDelayedSave(m_pkItems[i]);
-
-			M2_DESTROY_ITEM(m_pkItems[i]->RemoveFromCharacter());
-			m_pkItems[i] = NULL;
-		}
-	}
-
-#ifdef __GROWTH_PET_SYSTEM__
-	if (m_growthPetMap.size())
-	{
-		auto it = m_growthPetMap.begin();
-
-		while (it != m_growthPetMap.end())
-		{
-			LPGROWTH_PET pPet = it->second;
-
-			pPet->Save();
-
-			// Remove from the player pet pool
-			m_pkChrOwner->DeleteGrowthPet(pPet->GetPetID());
-
-			// Increase the iterator before deleting pet pointer
-			++it;
-
-			// Remove from the global pet pool
-			CGrowthPetManager::Instance().DeleteGrowthPet(pPet->GetPetID());
-		}
-
-		m_growthPetMap.clear();
-	}
-#endif
-
-	if (m_pkGrid)
-	{
-		M2_DELETE(m_pkGrid);
-		m_pkGrid = NULL;
-	}
-}
-
-bool CSafebox::Add(DWORD dwPos, LPITEM pkItem)
-{
-	if (!IsValidPosition(dwPos))
-	{
-		sys_err("SAFEBOX: item on wrong position at %d (size of grid = %d)", dwPos, m_pkGrid->GetSize());
-		return false;
-	}
-
-	pkItem->SetWindow(m_bWindowMode);
-	pkItem->SetCell(m_pkChrOwner, dwPos);
-	pkItem->Save(); //  Save ҷ Ѵ.
-	ITEM_MANAGER::instance().FlushDelayedSave(pkItem);
-
-	m_pkGrid->Put(dwPos, 1, pkItem->GetSize());
-	m_pkItems[dwPos] = pkItem;
-
-	TPacketGCItemSet pack;
-
-	pack.bHeader = m_bWindowMode == SAFEBOX ? HEADER_GC_SAFEBOX_SET : HEADER_GC_MALL_SET;
-	pack.Cell = TItemPos(m_bWindowMode, dwPos);
-	pack.dwVnum = pkItem->GetVnum();
-	pack.dwCount = pkItem->GetCount();
-	pack.dwFlags = pkItem->GetFlag();
-	pack.dwAntiFlags = pkItem->GetAntiFlag();
-#if defined(__SOUL_BIND_SYSTEM__)
-	pack.lSealDate = pkItem->GetSealDate();
-#endif
-	thecore_memcpy(pack.alSockets, pkItem->GetSockets(), sizeof(pack.alSockets));
-	thecore_memcpy(pack.aAttr, pkItem->GetAttributes(), sizeof(pack.aAttr));
-#if defined(__CHANGE_LOOK_SYSTEM__)
-	pack.dwTransmutationVnum = pkItem->GetTransmutationVnum();
-#endif
-#if defined(__REFINE_ELEMENT_SYSTEM__)
-	thecore_memcpy(&pack.RefineElement, pkItem->GetRefineElement(), sizeof(pack.RefineElement));
-#endif
-#if defined(__ITEM_APPLY_RANDOM__)
-	thecore_memcpy(pack.aApplyRandom, pkItem->GetRandomApplies(), sizeof(pack.aApplyRandom));
-#endif
-#if defined(__SET_ITEM__)
-	pack.bSetValue = pkItem->GetItemSetValue();
-#endif
-
-	m_pkChrOwner->GetDesc()->Packet(&pack, sizeof(pack));
-	sys_log(1, "SAFEBOX: ADD %s %s count %d", m_pkChrOwner->GetName(), pkItem->GetName(), pkItem->GetCount());
-	return true;
-}
-
-LPITEM CSafebox::Get(DWORD dwPos)
-{
-	if (dwPos >= m_pkGrid->GetSize())
-		return NULL;
-
-	return m_pkItems[dwPos];
-}
-
-LPITEM CSafebox::Remove(DWORD dwPos)
-{
-	LPITEM pkItem = Get(dwPos);
-
-	if (!pkItem)
-		return NULL;
-
-	if (!m_pkGrid)
-		sys_err("Safebox::Remove : nil grid");
-	else
-		m_pkGrid->Get(dwPos, 1, pkItem->GetSize());
-
-	pkItem->RemoveFromCharacter();
-
-	m_pkItems[dwPos] = NULL;
-
-	TPacketGCItemDel pack;
-
-	pack.header = m_bWindowMode == SAFEBOX ? HEADER_GC_SAFEBOX_DEL : HEADER_GC_MALL_DEL;
-	pack.pos = dwPos;
-
-	m_pkChrOwner->GetDesc()->Packet(&pack, sizeof(pack));
-	sys_log(1, "SAFEBOX: REMOVE %s %s count %d", m_pkChrOwner->GetName(), pkItem->GetName(), pkItem->GetCount());
-	return pkItem;
-}
-
-void CSafebox::Save()
-{
-	TSafeboxTable t;
-
-	memset(&t, 0, sizeof(TSafeboxTable));
-
-	t.dwID = m_pkChrOwner->GetDesc()->GetAccountTable().id;
-	t.dwGold = m_lGold;
-
-	db_clientdesc->DBPacket(HEADER_GD_SAFEBOX_SAVE, 0, &t, sizeof(TSafeboxTable));
-	sys_log(1, "SAFEBOX: SAVE %s", m_pkChrOwner->GetName());
-}
-
-bool CSafebox::IsEmpty(DWORD dwPos, BYTE bSize)
-{
-	if (!m_pkGrid)
-		return false;
-
-	return m_pkGrid->IsEmpty(dwPos, 1, bSize);
-}
-
-void CSafebox::ChangeSize(int iSize)
-{
-	//   ں ũ   д.
-	if (m_iSize >= iSize)
-		return;
-
-	m_iSize = iSize;
-
-	CGrid* pkOldGrid = m_pkGrid;
-
-	if (pkOldGrid)
-	{
-		m_pkGrid = M2_NEW CGrid(pkOldGrid, 5, m_iSize);
-		M2_DELETE(pkOldGrid);
-	}
-	else
-		m_pkGrid = M2_NEW CGrid(5, m_iSize);
-}
-
-LPITEM CSafebox::GetItem(BYTE bCell)
-{
-	if (bCell >= 5 * m_iSize)
-	{
-		sys_err("CHARACTER::GetItem: invalid item cell %d", bCell);
-		return NULL;
-	}
-
-	return m_pkItems[bCell];
-}
-
-bool CSafebox::MoveItem(BYTE bCell, BYTE bDestCell, WORD count)
-{
-	LPITEM item;
-
-	int max_position = 5 * m_iSize;
-
-	if (bCell >= max_position || bDestCell >= max_position)
-		return false;
-
-	if (!(item = GetItem(bCell)))
-		return false;
-
-	if (item->IsExchanging())
-		return false;
-
-	if (item->isLocked())
-		return false;
-
-	if (item->GetCount() < count)
-		return false;
-
-	{
-		LPITEM item2;
-
-		if ((item2 = GetItem(bDestCell)) && item != item2 && item2->IsStackable() &&
-			!IS_SET(item2->GetAntiFlag(), ITEM_ANTIFLAG_STACK) &&
-			item2->GetVnum() == item->GetVnum()) // ĥ  ִ  
-		{
-			for (int i = 0; i < ITEM_SOCKET_MAX_NUM; ++i)
-				if (item2->GetSocket(i) != item->GetSocket(i))
-					return false;
-
-			if (count == 0)
-				count = item->GetCount();
-
-			count = MIN(ITEM_MAX_COUNT - item2->GetCount(), count);
-
-			if (item->GetCount() >= count)
-				Remove(bCell);
-
-			item->SetCount(item->GetCount() - count);
-			item2->SetCount(item2->GetCount() + count);
-
-			sys_log(1, "SAFEBOX: STACK %s %d -> %d %s count %d", m_pkChrOwner->GetName(), bCell, bDestCell, item2->GetName(), item2->GetCount());
-			return true;
-		}
-
-		if (!IsEmpty(bDestCell, item->GetSize()))
-			return false;
-
-		// Split stacks safely: only allow splitting stackable items into an empty cell.
-		if (count != 0 && count < item->GetCount())
-		{
-			if (!item->IsStackable() || IS_SET(item->GetAntiFlag(), ITEM_ANTIFLAG_STACK) || item->GetSize() != 1)
-				return false;
-
-			LPITEM newItem = ITEM_MANAGER::instance().CreateItem(item->GetVnum(), count, 0, false);
-			if (!newItem)
-				return false;
-
-			ITEM_MANAGER::instance().CopyAllAttrTo(item, newItem);
-
-			item->SetCount(item->GetCount() - count);
-			item->Save();
-			ITEM_MANAGER::instance().FlushDelayedSave(item);
-
-			Add(bDestCell, newItem);
-			sys_log(1, "SAFEBOX: SPLIT %s %d -> %d %s count %d", m_pkChrOwner->GetName(), bCell, bDestCell, newItem->GetName(), newItem->GetCount());
-			return true;
-		}
-
-		m_pkGrid->Get(bCell, 1, item->GetSize());
-
-		if (!m_pkGrid->Put(bDestCell, 1, item->GetSize()))
-		{
-			m_pkGrid->Put(bCell, 1, item->GetSize());
-			return false;
-		}
-		else
-		{
-			m_pkGrid->Get(bDestCell, 1, item->GetSize());
-			m_pkGrid->Put(bCell, 1, item->GetSize());
-		}
-
-		sys_log(1, "SAFEBOX: MOVE %s %d -> %d %s count %d", m_pkChrOwner->GetName(), bCell, bDestCell, item->GetName(), item->GetCount());
-
-		Remove(bCell);
-		Add(bDestCell, item);
-	}
-
-	return true;
-}
-
-bool CSafebox::IsValidPosition(DWORD dwPos)
-{
-	if (!m_pkGrid)
-		return false;
-
-	if (dwPos >= m_pkGrid->GetSize())
-		return false;
-
-	return true;
-}
-
-#ifdef __GROWTH_PET_SYSTEM__
-void CSafebox::LoadPet(DWORD dwCount, TGrowthPet* pPets)
-{
-	for (int i = 0; i < dwCount; ++i, ++pPets)
-	{
-		LPGROWTH_PET pPet = CGrowthPetManager::Instance().CreateGrowthPet(m_pkChrOwner, pPets->dwID);
-		if (pPet)
-		{
-			pPet->SetGrowthPetProto(pPets);
-			m_pkChrOwner->SetGrowthPet(pPet);
-
-			AddPet(pPet);
-		}
-	}
-}
-
-/*
-	Add pet to the safebox map whenever upbringing/bag item is moved
-	to safebox.
-*/
-void CSafebox::AddPet(LPGROWTH_PET pPet)
-{
-	auto it = m_growthPetMap.find(pPet->GetPetID());
-
-	if (it != m_growthPetMap.end())
-		m_growthPetMap.erase(it);
-
-	pPet->SetState(STATE_SAFEBOX);
-	pPet->Save();
-	m_growthPetMap.emplace(pPet->GetPetID(), pPet);
-}
-
-/*
-	Remove pet from the safebox map whenever upbringing/bag item is moved
-	out of the safebox.
-*/
-bool CSafebox::RemovePet(LPITEM pSummonItem)
-{
-	auto it = m_growthPetMap.find(pSummonItem->GetSocket(2));
-
-	if (it == m_growthPetMap.end())
-		return false;
-
-	LPGROWTH_PET pPet = it->second;
-
-	BYTE bState = (pSummonItem->GetSubType() == PET_UPBRINGING) ? STATE_UPBRINGING : STATE_BAG;
-	pPet->SetState(bState);
-	pPet->Save();
-
-	m_growthPetMap.erase(it);
-	return true;
-}
-#endif
+#include "stdafx.h"
+#include "../../libgame/include/grid.h"
+#include "constants.h"
+#include "safebox.h"
+#include "packet.h"
+#include "char.h"
+#include "desc_client.h"
+#include "item.h"
+#include "item_manager.h"
+#include "config.h"
+
+CSafebox::CSafebox(LPCHARACTER pkChrOwner, int iSize, DWORD dwGold) : m_pkChrOwner(pkChrOwner), m_iSize(iSize), m_lGold(dwGold)
+{
+	assert(m_pkChrOwner != NULL);
+	memset(m_pkItems, 0, sizeof(m_pkItems));
+
+	if (m_iSize)
+		m_pkGrid = M2_NEW CGrid(5, m_iSize);
+	else
+		m_pkGrid = NULL;
+
+	m_bWindowMode = SAFEBOX;
+}
+
+CSafebox::~CSafebox()
+{
+	__Destroy();
+}
+
+void CSafebox::SetWindowMode(BYTE bMode)
+{
+	m_bWindowMode = bMode;
+}
+
+void CSafebox::__Destroy()
+{
+	for (int i = 0; i < SAFEBOX_MAX_NUM; ++i)
+	{
+		if (m_pkItems[i])
+		{
+			m_pkItems[i]->SetSkipSave(true);
+			ITEM_MANAGER::instance().FlushDelayedSave(m_pkItems[i]);
+
+			M2_DESTROY_ITEM(m_pkItems[i]->RemoveFromCharacter());
+			m_pkItems[i] = NULL;
+		}
+	}
+#ifdef __GROWTH_PET_SYSTEM__
+	if (m_growthPetMap.size())
+	{
+		auto it = m_growthPetMap.begin();
+
+		while (it != m_growthPetMap.end())
+		{
+			LPGROWTH_PET pPet = it->second;
+
+			pPet->Save();
+
+			// Remove from the player pet pool
+			m_pkChrOwner->DeleteGrowthPet(pPet->GetPetID());
+
+			// Increase the iterator before deleting pet pointer
+			++it;
+
+			// Remove from the global pet pool
+			CGrowthPetManager::Instance().DeleteGrowthPet(pPet->GetPetID());
+		}
+
+		m_growthPetMap.clear();
+	}
+#endif
+	if (m_pkGrid)
+	{
+		M2_DELETE(m_pkGrid);
+		m_pkGrid = NULL;
+	}
+}
+
+bool CSafebox::Add(DWORD dwPos, LPITEM pkItem)
+{
+	if (!IsValidPosition(dwPos))
+	{
+		sys_err("SAFEBOX: item on wrong position at %d (size of grid = %d)", dwPos, m_pkGrid->GetSize());
+		return false;
+	}
+
+	pkItem->SetWindow(m_bWindowMode);
+	pkItem->SetCell(m_pkChrOwner, dwPos);
+	pkItem->Save(); //  Save ҷ Ѵ.
+	ITEM_MANAGER::instance().FlushDelayedSave(pkItem);
+
+	m_pkGrid->Put(dwPos, 1, pkItem->GetSize());
+	m_pkItems[dwPos] = pkItem;
+
+	TPacketGCItemSet pack;
+
+	pack.header = m_bWindowMode == SAFEBOX ? HEADER_GC_SAFEBOX_SET : HEADER_GC_MALL_SET;
+	pack.Cell = TItemPos(m_bWindowMode, dwPos);
+	pack.vnum = pkItem->GetVnum();
+	pack.count = pkItem->GetCount();
+#if defined(__SOUL_BIND_SYSTEM__)
+	pack.soulbind = pkItem->GetSealedTime();
+#endif
+#if defined(__CHANGE_LOOK_SYSTEM__)
+	pack.transmutation = pkItem->GetTransmutation();
+#endif
+
+	pack.flags = pkItem->GetFlag();
+	pack.anti_flags = pkItem->GetAntiFlag();
+	thecore_memcpy(pack.alSockets, pkItem->GetSockets(), sizeof(pack.alSockets));
+#if defined(__ITEM_APPLY_RANDOM__)
+	thecore_memcpy(pack.aApplyRandom, pkItem->GetRandomApplies(), sizeof(pack.aApplyRandom));
+#endif
+	thecore_memcpy(pack.aAttr, pkItem->GetAttributes(), sizeof(pack.aAttr));
+
+	m_pkChrOwner->GetDesc()->Packet(&pack, sizeof(pack));
+	sys_log(1, "SAFEBOX: ADD %s %s count %d", m_pkChrOwner->GetName(), pkItem->GetName(), pkItem->GetCount());
+	return true;
+}
+
+LPITEM CSafebox::Get(DWORD dwPos)
+{
+	if (dwPos >= m_pkGrid->GetSize())
+		return NULL;
+
+	return m_pkItems[dwPos];
+}
+
+LPITEM CSafebox::Remove(DWORD dwPos)
+{
+	LPITEM pkItem = Get(dwPos);
+
+	if (!pkItem)
+		return NULL;
+
+	if (!m_pkGrid)
+		sys_err("Safebox::Remove : nil grid");
+	else
+		m_pkGrid->Get(dwPos, 1, pkItem->GetSize());
+
+	pkItem->RemoveFromCharacter();
+
+	m_pkItems[dwPos] = NULL;
+
+	TPacketGCItemDel pack;
+
+	pack.header = m_bWindowMode == SAFEBOX ? HEADER_GC_SAFEBOX_DEL : HEADER_GC_MALL_DEL;
+	pack.pos = dwPos;
+
+	m_pkChrOwner->GetDesc()->Packet(&pack, sizeof(pack));
+	sys_log(1, "SAFEBOX: REMOVE %s %s count %d", m_pkChrOwner->GetName(), pkItem->GetName(), pkItem->GetCount());
+	return pkItem;
+}
+
+void CSafebox::Save()
+{
+	TSafeboxTable t;
+
+	memset(&t, 0, sizeof(TSafeboxTable));
+
+	t.dwID = m_pkChrOwner->GetDesc()->GetAccountTable().id;
+	t.dwGold = m_lGold;
+
+	db_clientdesc->DBPacket(HEADER_GD_SAFEBOX_SAVE, 0, &t, sizeof(TSafeboxTable));
+	sys_log(1, "SAFEBOX: SAVE %s", m_pkChrOwner->GetName());
+}
+
+bool CSafebox::IsEmpty(DWORD dwPos, BYTE bSize)
+{
+	if (!m_pkGrid)
+		return false;
+
+	return m_pkGrid->IsEmpty(dwPos, 1, bSize);
+}
+
+void CSafebox::ChangeSize(int iSize)
+{
+	//   ں ũ   д.
+	if (m_iSize >= iSize)
+		return;
+
+	m_iSize = iSize;
+
+	CGrid* pkOldGrid = m_pkGrid;
+
+	if (pkOldGrid)
+	{
+		m_pkGrid = M2_NEW CGrid(pkOldGrid, 5, m_iSize);
+		delete pkOldGrid;
+	}
+	else
+		m_pkGrid = M2_NEW CGrid(5, m_iSize);
+}
+
+LPITEM CSafebox::GetItem(BYTE bCell)
+{
+	if (bCell >= 5 * m_iSize)
+	{
+		sys_err("CHARACTER::GetItem: invalid item cell %d", bCell);
+		return NULL;
+	}
+
+	return m_pkItems[bCell];
+}
+
+bool CSafebox::MoveItem(BYTE bCell, BYTE bDestCell, WORD count)
+{
+	LPITEM item;
+
+	int max_position = 5 * m_iSize;
+
+	if (bCell >= max_position || bDestCell >= max_position)
+		return false;
+
+	if (!(item = GetItem(bCell)))
+		return false;
+
+	if (item->IsExchanging())
+		return false;
+
+	if (item->GetCount() < count)
+		return false;
+
+	{
+		LPITEM item2;
+
+		if ((item2 = GetItem(bDestCell)) && item != item2 && item2->IsStackable() &&
+			!IS_SET(item2->GetAntiFlag(), ITEM_ANTIFLAG_STACK) &&
+			item2->GetVnum() == item->GetVnum()) // ĥ  ִ  
+		{
+			for (int i = 0; i < ITEM_SOCKET_MAX_NUM; ++i)
+				if (item2->GetSocket(i) != item->GetSocket(i))
+					return false;
+
+			if (count == 0)
+				count = item->GetCount();
+
+			count = MIN(gMaxItemCount - item2->GetCount(), count);
+
+			if (item->GetCount() >= count)
+				Remove(bCell);
+
+			item->SetCount(item->GetCount() - count);
+			item2->SetCount(item2->GetCount() + count);
+
+			sys_log(1, "SAFEBOX: STACK %s %d -> %d %s count %d", m_pkChrOwner->GetName(), bCell, bDestCell, item2->GetName(), item2->GetCount());
+			return true;
+		}
+
+		if (!IsEmpty(bDestCell, item->GetSize()))
+			return false;
+
+		m_pkGrid->Get(bCell, 1, item->GetSize());
+
+		if (!m_pkGrid->Put(bDestCell, 1, item->GetSize()))
+		{
+			m_pkGrid->Put(bCell, 1, item->GetSize());
+			return false;
+		}
+		else
+		{
+			m_pkGrid->Get(bDestCell, 1, item->GetSize());
+			m_pkGrid->Put(bCell, 1, item->GetSize());
+		}
+
+		sys_log(1, "SAFEBOX: MOVE %s %d -> %d %s count %d", m_pkChrOwner->GetName(), bCell, bDestCell, item->GetName(), item->GetCount());
+
+		Remove(bCell);
+		Add(bDestCell, item);
+	}
+
+	return true;
+}
+
+bool CSafebox::IsValidPosition(DWORD dwPos)
+{
+	if (!m_pkGrid)
+		return false;
+
+	if (dwPos >= m_pkGrid->GetSize())
+		return false;
+
+	return true;
+}
+
+#ifdef __GROWTH_PET_SYSTEM__
+void CSafebox::LoadPet(DWORD dwCount, TGrowthPet* pPets)
+{
+	for (int i = 0; i < dwCount; ++i, ++pPets)
+	{
+		LPGROWTH_PET pPet = CGrowthPetManager::Instance().CreateGrowthPet(m_pkChrOwner, pPets->dwID);
+		if (pPet)
+		{
+			pPet->SetGrowthPetProto(pPets);
+			m_pkChrOwner->SetGrowthPet(pPet);
+
+			AddPet(pPet);
+		}
+	}
+}
+
+/*
+	Add pet to the safebox map whenever upbringing/bag item is moved
+	to safebox.
+*/
+void CSafebox::AddPet(LPGROWTH_PET pPet)
+{
+	auto it = m_growthPetMap.find(pPet->GetPetID());
+
+	if (it != m_growthPetMap.end())
+		m_growthPetMap.erase(it);
+
+	pPet->SetState(STATE_SAFEBOX);
+	pPet->Save();
+	m_growthPetMap.emplace(pPet->GetPetID(), pPet);
+}
+
+/*
+	Remove pet from the safebox map whenever upbringing/bag item is moved
+	out of the safebox.
+*/
+bool CSafebox::RemovePet(LPITEM pSummonItem)
+{
+	auto it = m_growthPetMap.find(pSummonItem->GetSocket(2));
+
+	if (it == m_growthPetMap.end())
+		return false;
+
+	LPGROWTH_PET pPet = it->second;
+
+	BYTE bState = (pSummonItem->GetSubType() == PET_UPBRINGING) ? STATE_UPBRINGING : STATE_BAG;
+	pPet->SetState(bState);
+	pPet->Save();
+
+	m_growthPetMap.erase(it);
+	return true;
+}
+#endif
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/safebox.h final/server/server/home/metin2/Source/Server/game/src/safebox.h
--- baseline/server/server/home/metin2/Source/Server/game/src/safebox.h	2025-06-28 21:40:20.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/safebox.h	2021-08-31 14:04:46.000000000 +0000
@@ -1,50 +1,53 @@
-#ifndef __INC_SAFEBOX_H__
-#define __INC_SAFEBOX_H__
-#ifdef __GROWTH_PET_SYSTEM__
-#include "growth_pet.h"
-#endif
-class CHARACTER;
-class CItem;
-class CGrid;
-
-class CSafebox
-{
-public:
-	CSafebox(LPCHARACTER pkChrOwner, int iSize, DWORD dwGold);
-	~CSafebox();
-
-	bool Add(DWORD dwPos, LPITEM pkItem);
-	LPITEM Get(DWORD dwPos);
-	LPITEM Remove(DWORD dwPos);
-	void ChangeSize(int iSize);
-
-	bool MoveItem(BYTE bCell, BYTE bDestCell, WORD count);
-	LPITEM GetItem(BYTE bCell);
-
-	void Save();
-
-	bool IsEmpty(DWORD dwPos, BYTE bSize);
-	bool IsValidPosition(DWORD dwPos);
-
-	void SetWindowMode(BYTE bWindowMode);
-#ifdef __GROWTH_PET_SYSTEM__
-	void		LoadPet(DWORD dwCount, TGrowthPet* pPets);
-	void		AddPet(LPGROWTH_PET pPet);
-	bool		RemovePet(LPITEM pSummonItem);
-#endif
-protected:
-	void __Destroy();
-
-	LPCHARACTER m_pkChrOwner;
-	LPITEM m_pkItems[SAFEBOX_MAX_NUM];
-	CGrid* m_pkGrid;
-	int m_iSize;
-	long m_lGold;
-
-	BYTE m_bWindowMode;
-#ifdef __GROWTH_PET_SYSTEM__
-	CGrowthPetManager::TGrowthPetMap	m_growthPetMap;
-#endif
-};
-
-#endif // __INC_SAFEBOX_H__
+#ifndef __INC_SAFEBOX_H__
+#define __INC_SAFEBOX_H__
+
+#ifdef __GROWTH_PET_SYSTEM__
+#include "growth_pet.h"
+#endif
+
+class CHARACTER;
+class CItem;
+class CGrid;
+
+class CSafebox
+{
+public:
+	CSafebox(LPCHARACTER pkChrOwner, int iSize, DWORD dwGold);
+	~CSafebox();
+
+	bool Add(DWORD dwPos, LPITEM pkItem);
+	LPITEM Get(DWORD dwPos);
+	LPITEM Remove(DWORD dwPos);
+	void ChangeSize(int iSize);
+
+	bool MoveItem(BYTE bCell, BYTE bDestCell, WORD count);
+	LPITEM GetItem(BYTE bCell);
+
+	void Save();
+
+	bool IsEmpty(DWORD dwPos, BYTE bSize);
+	bool IsValidPosition(DWORD dwPos);
+
+	void SetWindowMode(BYTE bWindowMode);
+#ifdef __GROWTH_PET_SYSTEM__
+	void		LoadPet(DWORD dwCount, TGrowthPet* pPets);
+	void		AddPet(LPGROWTH_PET pPet);
+	bool		RemovePet(LPITEM pSummonItem);
+#endif
+
+protected:
+	void __Destroy();
+
+	LPCHARACTER m_pkChrOwner;
+	LPITEM m_pkItems[SAFEBOX_MAX_NUM];
+	CGrid* m_pkGrid;
+	int m_iSize;
+	long m_lGold;
+
+	BYTE m_bWindowMode;
+#ifdef __GROWTH_PET_SYSTEM__
+	CGrowthPetManager::TGrowthPetMap	m_growthPetMap;
+#endif
+};
+
+#endif // __INC_SAFEBOX_H__
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/sectree_manager.cpp final/server/server/home/metin2/Source/Server/game/src/sectree_manager.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/sectree_manager.cpp	2024-12-28 03:09:38.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/sectree_manager.cpp	2021-06-22 11:30:53.000000000 +0000
@@ -1066,6 +1066,7 @@
 		return;
 
 	LPSECTREE_MAP pkMapSectree = GetMap(lMapIndex);
+
 	if (!pkMapSectree)
 		return;
 
@@ -1085,9 +1086,12 @@
 
 TAreaMap& SECTREE_MANAGER::GetDungeonArea(long lMapIndex)
 {
-	auto it = m_map_pkArea.find(lMapIndex);
+	itertype(m_map_pkArea) it = m_map_pkArea.find(lMapIndex);
+
 	if (it == m_map_pkArea.end())
+	{
 		return m_map_pkArea[-1]; // ӽ÷  Area 
+	}
 
 	return it->second;
 }
@@ -1111,7 +1115,9 @@
 	TNPCPosition np;
 
 	// TODO m_mapNPCPosition[lMapIndex]  ּ
-	for (auto it = m_mapNPCPosition[lMapIndex].begin(); it != m_mapNPCPosition[lMapIndex].end(); ++it)
+	itertype(m_mapNPCPosition[lMapIndex]) it;
+
+	for (it = m_mapNPCPosition[lMapIndex].begin(); it != m_mapNPCPosition[lMapIndex].end(); ++it)
 	{
 		np.bType = it->bType;
 		strlcpy(np.name, it->name, sizeof(np.name));
@@ -1485,16 +1491,13 @@
 {
 	void operator() (LPENTITY ent)
 	{
-		if (ent->IsType(ENTITY_CHARACTER))
+		if (ent->IsType(ENTITY_CHARACTER) == true)
 		{
-			LPCHARACTER ch = (LPCHARACTER)ent;
-			if (ch->IsMonster() && !ch->IsRaceFlag(RACE_FLAG_DECO)
-#if defined(__PET_SYSTEM__)
-				&& !ch->IsPet()
-#endif
-				)
+			LPCHARACTER lpChar = (LPCHARACTER)ent;
+
+			if (lpChar->IsMonster() == true && !lpChar->IsPet() && !lpChar->IsGrowthPet())
 			{
-				M2_DESTROY_CHARACTER(ch);
+				M2_DESTROY_CHARACTER(lpChar);
 			}
 		}
 	}
@@ -1507,6 +1510,7 @@
 	if (sectree != NULL)
 	{
 		struct FPurgeMonsters f;
+
 		sectree->for_each(f);
 	}
 }
@@ -1515,12 +1519,13 @@
 {
 	void operator() (LPENTITY ent)
 	{
-		if (ent->IsType(ENTITY_CHARACTER))
+		if (ent->IsType(ENTITY_CHARACTER) == true)
 		{
-			LPCHARACTER ch = (LPCHARACTER)ent;
-			if (ch->IsStone())
+			LPCHARACTER lpChar = (LPCHARACTER)ent;
+
+			if (lpChar->IsStone() == true)
 			{
-				M2_DESTROY_CHARACTER(ch);
+				M2_DESTROY_CHARACTER(lpChar);
 			}
 		}
 	}
@@ -1533,6 +1538,7 @@
 	if (sectree != NULL)
 	{
 		struct FPurgeStones f;
+
 		sectree->for_each(f);
 	}
 }
@@ -1541,16 +1547,13 @@
 {
 	void operator() (LPENTITY ent)
 	{
-		if (ent->IsType(ENTITY_CHARACTER))
+		if (ent->IsType(ENTITY_CHARACTER) == true)
 		{
-			LPCHARACTER ch = (LPCHARACTER)ent;
-			if (ch->IsNPC() && !ch->IsRaceFlag(RACE_FLAG_DECO)
-#if defined(__PET_SYSTEM__)
-				&& !ch->IsPet()
-#endif
-				)
+			LPCHARACTER lpChar = (LPCHARACTER)ent;
+
+			if (lpChar->IsNPC() == true && !lpChar->IsPet() && !lpChar->IsGrowthPet())
 			{
-				M2_DESTROY_CHARACTER(ch);
+				M2_DESTROY_CHARACTER(lpChar);
 			}
 		}
 	}
@@ -1563,6 +1566,7 @@
 	if (sectree != NULL)
 	{
 		struct FPurgeNPCs f;
+
 		sectree->for_each(f);
 	}
 }
@@ -1573,12 +1577,13 @@
 
 	void operator() (LPENTITY ent)
 	{
-		if (ent->IsType(ENTITY_CHARACTER))
+		if (ent->IsType(ENTITY_CHARACTER) == true)
 		{
-			LPCHARACTER ch = (LPCHARACTER)ent;
-			if (ch->IsMonster() || ch->IsStone())
+			LPCHARACTER lpChar = (LPCHARACTER)ent;
+
+			if (lpChar->IsMonster() == true)
 			{
-				m_map_Monsters[ch->GetVID()] = ch->GetVID();
+				m_map_Monsters[lpChar->GetVID()] = lpChar->GetVID();
 			}
 		}
 	}
@@ -1591,6 +1596,7 @@
 	if (sectree != NULL)
 	{
 		struct FCountMonsters f;
+
 		sectree->for_each(f);
 
 		return f.m_map_Monsters.size();
@@ -1604,30 +1610,52 @@
 	DWORD SpecifiedVnum;
 	size_t cnt;
 
+#if defined(__GUILD_DRAGONLAIR__)
+	bool bForceVnum;
+
+	FCountSpecifiedMonster(DWORD id, bool force) : SpecifiedVnum(id), cnt(0), bForceVnum(force) {}
+#else
 	FCountSpecifiedMonster(DWORD id) : SpecifiedVnum(id), cnt(0) {}
+#endif
 
 	void operator() (LPENTITY ent)
 	{
-		if (ent->IsType(ENTITY_CHARACTER))
+		if (true == ent->IsType(ENTITY_CHARACTER))
 		{
-			LPCHARACTER ch = static_cast<LPCHARACTER>(ent);
+			LPCHARACTER pChar = static_cast<LPCHARACTER>(ent);
 
-			if (ch->IsMonster() || ch->IsStone())
+			if (true == pChar->IsStone())
 			{
-				if (ch->GetMobTable().dwVnum == SpecifiedVnum)
+				if (pChar->GetMobTable().dwVnum == SpecifiedVnum)
 					cnt++;
 			}
+#if defined(__GUILD_DRAGONLAIR__)
+			else if ((bForceVnum) && (pChar->IsNPC()))
+			{
+				if (pChar->GetMobTable().dwVnum == SpecifiedVnum)
+					cnt++;
+			}
+#endif
 		}
 	}
 };
 
+#if defined(__GUILD_DRAGONLAIR__)
+size_t SECTREE_MANAGER::GetMonsterCountInMap(long lMapIndex, DWORD dwVnum, bool bForceVnum)
+#else
 size_t SECTREE_MANAGER::GetMonsterCountInMap(long lMapIndex, DWORD dwVnum)
+#endif
 {
 	LPSECTREE_MAP sectree = SECTREE_MANAGER::instance().GetMap(lMapIndex);
 
 	if (NULL != sectree)
 	{
+#if defined(__GUILD_DRAGONLAIR__)
+		struct FCountSpecifiedMonster f(dwVnum, bForceVnum);
+#else
 		struct FCountSpecifiedMonster f(dwVnum);
+#endif
+
 		sectree->for_each(f);
 
 		return f.cnt;
@@ -1674,151 +1702,3 @@
 
 	m_restart_city_pos.insert(std::make_pair(iMapIndex, SRestartCityPos(iEmpire, iX, iY, iZ)));
 }
-
-#if defined(__CONQUEROR_LEVEL__)
-bool SECTREE_MANAGER::LoadNewWorldMapIndexFile(const char* c_pszListFileName)
-{
-	FILE* pFile = fopen(c_pszListFileName, "r");
-	if (pFile == nullptr)
-		return false;
-
-	m_map_sNewWorldMap.clear();
-
-	char szLine[256];
-	while (fgets(szLine, 256, pFile))
-	{
-		char* szEndline = strrchr(szLine, '\n');
-		if (!szEndline)
-			continue;
-
-		*szEndline = '\0';
-
-		if (!strncmp(szLine, "//", 2) || *szLine == '#')
-			continue;
-
-		int iMapIndex = 0;
-		struct SSungMaWill Data = { 0 };
-
-		sscanf(szLine, "%d %d %d %d %d %d",
-			&iMapIndex,
-			&Data.iSungmaStr, &Data.iSungmaHp, &Data.iSungmaMove, &Data.iSungmaImmune,
-			&Data.iHitPct
-		);
-
-		m_map_sNewWorldMap.emplace(iMapIndex, Data);
-	}
-
-	fclose(pFile);
-	return true;
-}
-
-bool SECTREE_MANAGER::IsNewWorldMapIndex(int iMapIndex) const
-{
-	if (iMapIndex >= 10000)
-		iMapIndex /= 10000;
-
-	NewWorldMapIndex::const_iterator it = m_map_sNewWorldMap.find(iMapIndex);
-	return it != m_map_sNewWorldMap.end() ? true : false;
-}
-
-BYTE SECTREE_MANAGER::GetNewWorldSungMa(int iMapIndex, POINT_TYPE wPointType) const
-{
-	if (iMapIndex >= 10000)
-		iMapIndex /= 10000;
-
-	NewWorldMapIndex::const_iterator it = m_map_sNewWorldMap.find(iMapIndex);
-	if (it == m_map_sNewWorldMap.end())
-		return 0;
-
-	switch (wPointType)
-	{
-		case POINT_SUNGMA_STR:
-			return it->second.iSungmaStr;
-		case POINT_SUNGMA_HP:
-			return it->second.iSungmaHp;
-		case POINT_SUNGMA_MOVE:
-			return it->second.iSungmaMove;
-		case POINT_SUNGMA_IMMUNE:
-			return it->second.iSungmaImmune;
-		case POINT_HIT_PCT:
-			return it->second.iHitPct;
-		default:
-			return 0;
-	}
-
-	return 0;
-}
-#endif
-
-bool SECTREE_MANAGER::LoadBlockFilterMapIndexFile(const BYTE bType)
-{
-	char szListFileName[256] = {};
-	switch (bType)
-	{
-		case MOUNT_BLOCK_MAP_INDEX:
-			snprintf(szListFileName, sizeof(szListFileName),
-				"%s/mount_block_index.txt", LocaleService_GetMapPath().c_str());
-			break;
-
-		case PET_BLOCK_MAP_INDEX:
-			snprintf(szListFileName, sizeof(szListFileName),
-				"%s/pet_block_index.txt", LocaleService_GetMapPath().c_str());
-			break;
-
-		default:
-			sys_err("Unknown map index block filter type %d", bType);
-			return false;
-	}
-
-	FILE* pFile = fopen(szListFileName, "r");
-	if (pFile == nullptr)
-		return false;
-
-	m_map_vBlockFilterMapIndex[bType].clear();
-
-	char szLine[256 + 1];
-	while (fgets(szLine, 256, pFile))
-	{
-		char* szEndline = strrchr(szLine, '\n');
-		if (!szEndline)
-			continue;
-
-		*szEndline = '\0';
-
-		if (!strncmp(szLine, "//", 2) || *szLine == '#')
-			continue;
-
-		int iIndex = 0;
-		int bPrivateMap = 0;
-
-		sscanf(szLine, "%d %d", &iIndex, &bPrivateMap);
-
-		m_map_vBlockFilterMapIndex[bType].emplace_back(std::make_pair(iIndex, bPrivateMap));
-	}
-
-	fclose(pFile);
-	return true;
-}
-
-bool SECTREE_MANAGER::IsBlockFilterMapIndex(const BYTE bType, int iMapIndex)
-{
-	BOOL bPrivateMap = FALSE;
-
-	if (iMapIndex >= 10000)
-	{
-		iMapIndex /= 10000;
-		bPrivateMap = TRUE;
-	}
-
-	const auto& it = m_map_vBlockFilterMapIndex.find(bType);
-	if (it == m_map_vBlockFilterMapIndex.end())
-		return false;
-
-	const auto& vec = std::find_if(it->second.begin(), it->second.end(),
-		[iMapIndex](const std::pair<int, int>& element) {
-			return element.first == iMapIndex;
-		}
-	);
-
-	return (vec != it->second.end()) && (vec->second == bPrivateMap);
-}
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/shop_manager.cpp final/server/server/home/metin2/Source/Server/game/src/shop_manager.cpp
--- baseline/server/server/home/metin2/Source/Server/game/src/shop_manager.cpp	2025-06-29 16:41:14.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/shop_manager.cpp	2022-04-27 12:50:00.000000000 +0000
@@ -22,9 +22,15 @@
 #include "shop_manager.h"
 #include "group_text_parse_tree.h"
 #include "shopEx.h"
+#include <boost/algorithm/string/predicate.hpp>
 #include "shop_manager.h"
 #include <cctype>
 
+#if defined(__PRIVATESHOP_SEARCH_SYSTEM__)
+#	include "unique_item.h"
+#	include "target.h"
+#endif
+
 CShopManager::CShopManager()
 {
 }
@@ -54,8 +60,8 @@
 		m_map_pkShop.insert(TShopMap::value_type(table->dwVnum, shop));
 		m_map_pkShopByNPCVnum.insert(TShopMap::value_type(table->dwNPCVnum, shop));
 	}
-
 	char szShopTableExFileName[256];
+
 	snprintf(szShopTableExFileName, sizeof(szShopTableExFileName),
 		"%s/shop_table_ex.txt", LocaleService_GetBasePath().c_str());
 
@@ -65,7 +71,7 @@
 void CShopManager::Destroy()
 {
 	TShopMap::iterator it = m_map_pkShop.begin();
-	std::unordered_set<decltype(m_map_pkShop)::value_type::second_type> collector; // avoid delete duplicate objects(unique key)
+	boost::unordered_set<decltype(m_map_pkShop)::value_type::second_type> collector; // avoid delete duplicate objects(unique key)
 	while (it != m_map_pkShop.end())
 	{
 		//delete it->second;
@@ -105,11 +111,6 @@
 //  ŷ 
 bool CShopManager::StartShopping(LPCHARACTER pkChr, LPCHARACTER pkChrShopKeeper, int iShopVnum)
 {
-#if defined(__QUEST_EVENT_BUY_SELL__)
-	if (pkChr->GetShop())
-		return false;
-#endif
-
 	if (pkChr->GetShopOwner() == pkChrShopKeeper)
 		return false;
 
@@ -117,30 +118,28 @@
 	if (pkChrShopKeeper->IsPC())
 		return false;
 
+	// PREVENT_TRADE_WINDOW
+	if (pkChr->PreventTradeWindow(WND_SHOPOWNER, true/*except*/))
+	{
+		pkChr->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("ٸ ŷâ ¿ ŷ Ҽ  ϴ."));
+		return false;
+	}
+	// END_PREVENT_TRADE_WINDOW
+	
 #ifdef __GROWTH_PET_SYSTEM__
-	/*
 	if (pkChr->GetActiveGrowthPet())
 	{
 		pkChr->ChatPacket(CHAT_TYPE_INFO, "You cannot open a private shop whilst summoning your pet.");
 		return false;
 	}
-	*/
 	
 	if (pkChr->GetPetWindowType() == PET_WINDOW_ATTR_CHANGE || pkChr->GetPetWindowType() == PET_WINDOW_PRIMIUM_FEEDSTUFF)
 	{
-		pkChr->ChatPacket(CHAT_TYPE_INFO, LC_STRING("While modifying your pet's stats, you cannot trade, sell items, use the storeroom etc."));
+		pkChr->ChatPacket(CHAT_TYPE_INFO, "While modifying your pet's stats, you cannot trade, sell items, use the storeroom etc.");
 		return false;
 	}
 #endif
 
-	// PREVENT_TRADE_WINDOW
-	if (pkChr->PreventTradeWindow(WND_SHOPOWNER, true/*except*/))
-	{
-		pkChr->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ٸ ŷâ ¿ ŷ Ҽ  ϴ."));
-		return false;
-	}
-	// END_PREVENT_TRADE_WINDOW
-
 	long distance = DISTANCE_APPROX(pkChr->GetX() - pkChrShopKeeper->GetX(), pkChr->GetY() - pkChrShopKeeper->GetY());
 
 	if (distance >= SHOP_MAX_DISTANCE)
@@ -183,14 +182,14 @@
 	return it->second;
 }
 
-LPSHOP CShopManager::CreatePCShop(LPCHARACTER ch, TShopItemTable* pTable, BYTE bItemCount)
+LPSHOP CShopManager::CreatePCShop(LPCHARACTER ch, TShopItemTable* pTable, WORD wItemCount)
 {
 	if (FindPCShop(ch->GetVID()))
 		return NULL;
 
 	LPSHOP pkShop = M2_NEW CShop;
 	pkShop->SetPCShop(ch);
-	pkShop->SetShopItems(pTable, bItemCount);
+	pkShop->SetShopItems(pTable, wItemCount);
 
 	m_map_pkShopByPC.insert(TShopMap::value_type(ch->GetVID(), pkShop));
 	return pkShop;
@@ -238,11 +237,12 @@
 
 	if (DISTANCE_APPROX(ch->GetX() - ch->GetShopOwner()->GetX(), ch->GetY() - ch->GetShopOwner()->GetY()) > 2000)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" Ÿ ʹ ־    ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" Ÿ ʹ ־    ϴ."));
 		return;
 	}
 
 	CShop* pkShop = ch->GetShop();
+
 	if (!pkShop)
 		return;
 
@@ -280,7 +280,7 @@
 
 	if (DISTANCE_APPROX(ch->GetX() - ch->GetShopOwner()->GetX(), ch->GetY() - ch->GetShopOwner()->GetY()) > 2000)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING(" Ÿ ʹ ־    ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT(" Ÿ ʹ ־    ϴ."));
 		return;
 	}
 
@@ -291,22 +291,19 @@
 
 	if (item->IsEquipped() == true)
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("   Ǹ  ϴ."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("   Ǹ  ϴ."));
 		return;
 	}
 
 	if (true == item->isLocked())
+	{
 		return;
-
-#ifdef __GROWTH_PET_SYSTEM__
-	if (item->IsPet())
-		return;
-#endif
+	}
 
 #if defined(__SOUL_BIND_SYSTEM__)
 	if (item->IsSealed())
 	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot sell a soulbound item."));
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("You cannot trade sealed items."));
 		return;
 	}
 #endif
@@ -314,63 +311,51 @@
 	if (IS_SET(item->GetAntiFlag(), ITEM_ANTIFLAG_SELL))
 		return;
 
-	DWORD dwPrice;
+	uint64_t iPrice;
 
 	if (wCount == 0 || wCount > item->GetCount())
 		wCount = item->GetCount();
 
-	dwPrice = item->GetShopSellPrice();
+	iPrice = item->GetShopBuyPrice();
 
 	if (IS_SET(item->GetFlag(), ITEM_FLAG_COUNT_PER_1GOLD))
 	{
-		if (dwPrice == 0)
-			dwPrice = wCount;
+		if (iPrice == 0)
+			iPrice = wCount;
 		else
-			dwPrice = wCount / dwPrice;
+			iPrice = wCount / iPrice;
 	}
 	else
-		dwPrice *= wCount;
+		iPrice *= wCount;
 
-	dwPrice /= 5;
+	iPrice /= 5;
 
 	//  
 	DWORD dwTax = 0;
 	int iVal = 3;
 
-	dwTax = dwPrice * iVal / 100;
-	dwPrice -= dwTax;
+	dwTax = iPrice * iVal / 100;
+	iPrice -= dwTax;
 
 	if (test_server)
 		sys_log(0, "Sell Item price id %d %s itemid %d", ch->GetPlayerID(), ch->GetName(), item->GetID());
 
-	const int64_t nTotalMoney = static_cast<int64_t>(ch->GetGold()) + static_cast<int64_t>(dwPrice);
-	if (GOLD_MAX <= nTotalMoney)
+	const uint64_t nTotalMoney = static_cast<uint64_t>(ch->GetGold()) + static_cast<uint64_t>(iPrice);
+
+	if (g_MaxGold <= nTotalMoney)
 	{
-		sys_err("[OVERFLOW_GOLD] id %u name %s gold %d", ch->GetPlayerID(), ch->GetName(), ch->GetGold());
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("20 ʰϿ ǰ ȼ ϴ."));
+		sys_err("[OVERFLOW_GOLD] id %u name %s gold %lld", ch->GetPlayerID(), ch->GetName(), ch->GetGold());
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("20 ʰϿ ǰ ȼ ϴ."));
 		return;
 	}
 
 	// 20050802.myevan. Ǹ α׿  ID ߰
-	sys_log(0, "SHOP: SELL: %s item name: %s(x%d):%u price: %u", ch->GetName(), item->GetName(), wCount, item->GetID(), dwPrice);
-
-#ifdef ENABLE_EXTENDED_BATTLE_PASS
-	ch->UpdateExtBattlePassMissionProgress(BP_ITEM_SELL, wCount, item->GetVnum());
-#endif
+	sys_log(0, "SHOP: SELL: %s item name: %s(x%d):%u price: %llu", ch->GetName(), item->GetName(), wCount, item->GetID(), iPrice);
 
 	if (iVal > 0)
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ǹűݾ %d %%   Ե˴ϴ", iVal));
-
-	DBManager::instance().SendMoneyLog(MONEY_LOG_SHOP, item->GetVnum(), dwPrice);
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("Ǹűݾ %d %%   Ե˴ϴ"), iVal);
 
-#if defined(__QUEST_EVENT_BUY_SELL__)
-	CShop* pkShop = ch->GetShop();
-	if (pkShop)
-	{
-		ch->SetQuestNPCID(ch->GetShopOwner() ? ch->GetShopOwner()->GetVID() : 0);
-		quest::CQuestManager::instance().SellItem(ch->GetPlayerID(), pkShop->GetNPCVnum(), item);
-	}
-#endif
+	DBManager::instance().SendMoneyLog(MONEY_LOG_SHOP, item->GetVnum(), iPrice);
 
 	if (wCount == item->GetCount())
 		ITEM_MANAGER::instance().RemoveItem(item, "SELL");
@@ -380,7 +365,7 @@
 	//  ý :  ¡
 	CMonarch::instance().SendtoDBAddMoney(dwTax, ch->GetEmpire(), ch);
 
-	ch->PointChange(POINT_GOLD, dwPrice, false);
+	ch->PointChange(POINT_GOLD, iPrice, false);
 }
 
 bool CompareShopItemName(const SShopItemTable& lhs, const SShopItemTable& rhs)
@@ -412,15 +397,6 @@
 }
 #endif
 
-static bool iequals(const std::string& a, const std::string& b)
-{
-	return std::equal(a.begin(), a.end(),
-		b.begin(), b.end(),
-		[](char a, char b) {
-			return tolower(a) == tolower(b);
-		});
-}
-
 bool ConvertToShopItemTable(IN CGroupNode* pNode, OUT TShopTableEx& shopTable)
 {
 	if (!pNode->GetValue("vnum", 0, shopTable.dwVnum))
@@ -447,11 +423,11 @@
 		stCoinType = "Gold";
 	}
 
-	if (iequals(stCoinType, "Gold"))
+	if (boost::iequals(stCoinType, "Gold"))
 	{
 		shopTable.coinType = SHOP_COIN_TYPE_GOLD;
 	}
-	else if (iequals(stCoinType, "SecondaryCoin"))
+	else if (boost::iequals(stCoinType, "SecondaryCoin"))
 	{
 		shopTable.coinType = SHOP_COIN_TYPE_SECONDARY_COIN;
 	}
@@ -469,7 +445,7 @@
 	}
 
 	size_t itemGroupSize = pItemGroup->GetRowCount();
-	std::vector<TShopItemTable> shopItems(itemGroupSize);
+	std::vector <TShopItemTable> shopItems(itemGroupSize);
 	if (itemGroupSize >= SHOP_HOST_ITEM_MAX_NUM)
 	{
 		sys_err("count(%d) of rows of group items of group %s must be smaller than %d", itemGroupSize, pNode->GetNodeName().c_str(), SHOP_HOST_ITEM_MAX_NUM);
@@ -483,34 +459,22 @@
 			sys_err("row(%d) of group items of group %s does not have vnum column", i, pNode->GetNodeName().c_str());
 			return false;
 		}
-
 		if (!pItemGroup->GetValue(i, "count", shopItems[i].count))
 		{
 			sys_err("row(%d) of group items of group %s does not have count column", i, pNode->GetNodeName().c_str());
 			return false;
 		}
-
 		if (!pItemGroup->GetValue(i, "price", shopItems[i].price))
 		{
 			sys_err("row(%d) of group items of group %s does not have price column", i, pNode->GetNodeName().c_str());
 			return false;
 		}
-
-		// NOTE : Set the item price to the default item proto shop buy price.
-		if (shopItems[i].price == 0)
-		{
-			TItemTable* itemTable = ITEM_MANAGER::instance().GetTable(shopItems[i].vnum);
-			if (itemTable != NULL)
-				shopItems[i].price = itemTable->dwShopBuyPrice * shopItems[i].count;
-		}
-
 #if defined(__SHOPEX_RENEWAL__)
-		if (shopItems[i].bPriceType >= SHOP_COIN_MAX_TYPE)
+		if (shopItems[i].price_type >= EX_MAX || shopItems[i].price_type < EX_GOLD)
 		{
 			sys_err("row(%d) of group items of group %s price_type is wrong!", i, pNode->GetNodeName().c_str());
 			return false;
 		}
-
 		char getval[20];
 		for (int j = 0; j < ITEM_SOCKET_MAX_NUM; j++)
 		{
@@ -521,40 +485,57 @@
 				return false;
 			}
 		}
-
-		if (pItemGroup->GetValue(i, "price_type", shopItems[i].bPriceType) &&
-			pItemGroup->GetValue(i, "price_vnum", shopItems[i].dwPriceVnum) &&
-			shopItems[i].bPriceType == SHOP_COIN_TYPE_ITEM)
+		for (int j = 0; j < ITEM_ATTRIBUTE_MAX_NUM; j++)
 		{
-			if (!ITEM_MANAGER::instance().GetTable(shopItems[i].dwPriceVnum))
+			snprintf(getval, sizeof(getval), "attr_type%d", j);
+			if (!pItemGroup->GetValue(i, getval, shopItems[i].aAttr[j].bType))
+			{
+				sys_err("row(%d) stage %d of group items of group %s does not have attr_type column", i, j, pNode->GetNodeName().c_str());
+				return false;
+			}
+			snprintf(getval, sizeof(getval), "attr_value%d", j);
+			if (!pItemGroup->GetValue(i, getval, shopItems[i].aAttr[j].sValue))
 			{
-				sys_err("CANNOT GET ITEM PROTO %d", shopItems[i].dwPriceVnum);
+				sys_err("row(%d) stage %d of group items of group %s does not have attr_value column", i, j, pNode->GetNodeName().c_str());
+				return false;
+			}
+		}
+		if (pItemGroup->GetValue(i, "price_type", shopItems[i].price_type) && pItemGroup->GetValue(i, "price_vnum", shopItems[i].price_vnum) && shopItems[i].price_type == 3)
+		{
+			if (!ITEM_MANAGER::instance().GetTable(shopItems[i].price_vnum))
+			{
+				sys_err("NOT GET ITEM PROTO %d", shopItems[i].price_vnum);
 				return false;
 			}
 		}
 #endif
 	}
-
 	std::string stSort;
 	if (!pNode->GetValue("sort", 0, stSort))
+	{
 		stSort = "None";
+	}
 
-	if (iequals(stSort, "Asc"))
+	if (boost::iequals(stSort, "Asc"))
+	{
 		std::sort(shopItems.begin(), shopItems.end(), CompareShopItemName);
-	else if (iequals(stSort, "Desc"))
+	}
+	else if (boost::iequals(stSort, "Desc"))
+	{
 		std::sort(shopItems.rbegin(), shopItems.rend(), CompareShopItemName);
+	}
 #if defined(__SHOPEX_RENEWAL__)
-	else if (iequals(stSort, "Vnum"))
-		std::sort(shopItems.rbegin(), shopItems.rend(), CompareShopItemVnum);
-	else if (iequals(stSort, "Price"))
+	else if (boost::iequals(stSort, "Vnum"))
+		std::sort(shopItems.begin(), shopItems.end(), CompareShopItemVnum);
+	else if (boost::iequals(stSort, "Price"))
 		std::sort(shopItems.begin(), shopItems.end(), CompareShopItemPrice);
-	else if (iequals(stSort, "Name"))
+	else if (boost::iequals(stSort, "Name"))
 		std::sort(shopItems.begin(), shopItems.end(), CompareShopItemName);
-	else if (iequals(stSort, "Type"))
+	else if (boost::iequals(stSort, "Type"))
 		std::sort(shopItems.begin(), shopItems.end(), CompareShopItemType);
 #endif
 
-	CGrid grid = CGrid(CShop::SHOP_GRID_WIDTH, CShop::SHOP_GRID_HEIGHT);
+	CGrid grid = CGrid(5, 9);
 	int iPos;
 
 	memset(&shopTable.items[0], 0, sizeof(shopTable.items));
@@ -574,7 +555,7 @@
 		shopTable.items[iPos] = shopItems[i];
 	}
 
-	shopTable.bItemCount = shopItems.size();
+	shopTable.wItemCount = shopItems.size();
 	return true;
 }
 
@@ -606,7 +587,7 @@
 
 #if defined(__SHOPEX_RENEWAL__)
 	{
-		std::unordered_set<CShop*> v;
+		boost::unordered_set<CShop*> v;
 		// include unordered_set
 		auto ExDelete = [&v](TShopMap& c)
 		{
@@ -705,3 +686,210 @@
 
 	return true;
 }
+
+#if defined(__PRIVATESHOP_SEARCH_SYSTEM__)
+void CShopManager::ShopSearchProcess(LPCHARACTER ch, const TPacketCGPrivateShopSearch * p)
+{
+	if (ch == NULL || ch->GetDesc() == NULL || p == NULL)
+		return;
+
+	if (ch->PreventTradeWindow(WND_SHOPSEARCH, true/*except*/))
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("SHOP_SEARCH_CLOSE_TABS"));
+		return;
+	}
+
+	TEMP_BUFFER buf;
+
+	for (std::map<DWORD, CShop*>::const_iterator it = m_map_pkShopByPC.begin(); it != m_map_pkShopByPC.end(); ++it)
+	{
+		CShop* tShopTable = it->second;
+		if (tShopTable == NULL)
+			continue;
+
+		LPCHARACTER GetOwner = tShopTable->GetShopOwner();
+		if (GetOwner == NULL || ch == GetOwner)
+			continue;
+
+		const std::vector<CShop::SHOP_ITEM>& vItemVec = tShopTable->GetItemVector();
+		for (std::vector<CShop::SHOP_ITEM>::const_iterator ShopIter = vItemVec.begin(); ShopIter != vItemVec.end(); ++ShopIter)
+		{
+			LPITEM item = ShopIter->pkItem;
+			if (item == NULL)
+				continue;
+
+			/* First n character equals(case insensitive) */
+			if (strncasecmp(item->GetName(), p->szItemName, strlen(p->szItemName)))
+				continue;
+
+			if ((p->iMinRefine <= item->GetRefineLevel() && p->iMaxRefine >= item->GetRefineLevel()) == false)
+				continue;
+
+			if ((p->iMinLevel <= item->GetLevelLimit() && p->iMaxLevel >= item->GetLevelLimit()) == false)
+				continue;
+
+			if ((p->iMinGold <= ShopIter->price && p->iMaxGold >= ShopIter->price) == false)
+				continue;
+
+#if defined(__CHEQUE_SYSTEM__)
+			if ((p->iMinCheque <= ShopIter->price_cheque && p->iMaxCheque >= ShopIter->price_cheque) == false)
+				continue;
+#endif
+
+			if (p->bMaskType != ITEM_NONE && p->bMaskType != item->GetType()) // ITEM_NONE: All Categories
+				continue;
+
+			if (p->iMaskSub != -1 && p->iMaskSub != item->GetSubType()) // -1: No SubType Check
+				continue;
+
+			switch (p->bJob)
+			{
+			case JOB_WARRIOR:
+				if (item->GetAntiFlag() & ITEM_ANTIFLAG_WARRIOR)
+					continue;
+				break;
+
+			case JOB_ASSASSIN:
+				if (item->GetAntiFlag() & ITEM_ANTIFLAG_ASSASSIN)
+					continue;
+				break;
+
+			case JOB_SHAMAN:
+				if (item->GetAntiFlag() & ITEM_ANTIFLAG_SHAMAN)
+					continue;
+				break;
+
+			case JOB_SURA:
+				if (item->GetAntiFlag() & ITEM_ANTIFLAG_SURA)
+					continue;
+				break;
+
+#if defined(__WOLFMAN_CHARACTER__)
+			case JOB_WOLFMAN:
+				if (item->GetAntiFlag() & ITEM_ANTIFLAG_WOLFMAN)
+					continue;
+				break;
+#endif
+			}
+
+			TPacketGCPrivateShopSearchItem pack2;
+			pack2.item.vnum = ShopIter->vnum;
+			pack2.item.price = ShopIter->price;
+#if defined(__CHEQUE_SYSTEM__)
+			pack2.item.price_cheque = ShopIter->price_cheque;
+#endif
+			pack2.item.count = ShopIter->count;
+#if defined(__CHANGE_LOOK_SYSTEM__)
+			pack2.item.transmutation = item->GetTransmutation();
+#endif
+			pack2.item.display_pos = static_cast<BYTE>(std::distance(vItemVec.begin(), ShopIter));
+			pack2.dwShopPID = GetOwner->GetPlayerID();
+			std::memcpy(&pack2.szSellerName, GetOwner->GetName(), sizeof(pack2.szSellerName));
+			std::memcpy(&pack2.item.alSockets, item->GetSockets(), sizeof(pack2.item.alSockets));
+#if defined(__ITEM_APPLY_RANDOM__)
+			std::memcpy(&pack2.item.aApplyRandom, item->GetRandomApplies(), sizeof(pack2.item.aApplyRandom));
+#endif
+			std::memcpy(&pack2.item.aAttr, item->GetAttributes(), sizeof(pack2.item.aAttr));
+			buf.write(&pack2, sizeof(pack2));
+		}
+	}
+
+	if (buf.size() <= 0)
+		return;
+
+	TPacketGCPrivateShopSearch pack;
+	pack.header = HEADER_GC_PRIVATESHOP_SEARCH;
+	pack.size = static_cast<WORD>(sizeof(pack) + buf.size());
+	ch->GetDesc()->BufferedPacket(&pack, sizeof(pack));
+	ch->GetDesc()->Packet(buf.read_peek(), buf.size());
+}
+
+void CShopManager::ShopSearchBuy(LPCHARACTER ch, const TPacketCGPrivateShopSearchBuyItem * p)
+{
+	if (ch == NULL || ch->GetDesc() == NULL || p == NULL)
+		return;
+
+	if (ch->PreventTradeWindow(WND_SHOPSEARCH, true/*except*/))
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("SHOP_SEARCH_CLOSE_TABS"));
+		return;
+	}
+
+	LPCHARACTER ShopCH = CHARACTER_MANAGER::instance().FindByPID(p->dwShopPID);
+	if (ShopCH == NULL)
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("SHOP_SEARCH_NO_SHOP"));
+		return;
+	}
+
+	if (ch == ShopCH) // what?
+		return;
+
+	CShop* pkShop = ShopCH->GetMyShop();
+	if (pkShop == NULL || pkShop->IsPCShop() == false)
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("SHOP_SEARCH_NO_SHOP"));
+		return;
+	}
+
+	const BYTE bState = ch->GetPrivateShopSearchState();
+	switch (bState)
+	{
+	case SHOP_SEARCH_LOOKING:
+	{
+		if (ch->CountSpecifyItem(PRIVATESHOP_SEARCH_LOOKING_GLASS) == 0)
+		{
+			const TItemTable* GlassTable = ITEM_MANAGER::instance().GetTable(PRIVATESHOP_SEARCH_LOOKING_GLASS);
+			if (GlassTable)
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("SHOP_SEARCH_WHERE_IS_ITEM"), GlassTable->szLocaleName);
+			return;
+		}
+		if (ch->GetMapIndex() != ShopCH->GetMapIndex())
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("SHOP_SEARCH_SAMEMAP_ERR"));
+			return;
+		}
+
+		const DWORD dwSellerVID(ShopCH->GetVID());
+		if (CTargetManager::instance().GetTargetInfo(ch->GetPlayerID(), TARGET_TYPE_VID_SHOP_SEARCH, dwSellerVID))
+			CTargetManager::instance().DeleteTarget(ch->GetPlayerID(), SHOP_SEARCH_INDEX, "__SHOPSEARCH_TARGET__");
+
+		CTargetManager::Instance().CreateTarget(ch->GetPlayerID(), SHOP_SEARCH_INDEX, "__SHOPSEARCH_TARGET__", TARGET_TYPE_VID_SHOP_SEARCH, dwSellerVID, 0, ch->GetMapIndex(), "Shop Search", 1);
+
+		if (CTargetManager::instance().GetTargetInfo(ch->GetPlayerID(), TARGET_TYPE_VID_SHOP_SEARCH, dwSellerVID))
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("SHOP_SEARCH_SUCCESS_TARGET"));
+		break;
+	}
+
+	case SHOP_SEARCH_TRADING:
+	{
+		if (ch->CountSpecifyItem(PRIVATESHOP_SEARCH_TRADING_GLASS) == 0)
+		{
+			const TItemTable* GlassTable = ITEM_MANAGER::instance().GetTable(PRIVATESHOP_SEARCH_TRADING_GLASS);
+			if (GlassTable)
+				ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("SHOP_SEARCH_WHERE_IS_ITEM"), GlassTable->szLocaleName);
+			return;
+		}
+
+		ch->SetMyShopTime();
+		int ret = pkShop->Buy(ch, p->bPos, true);
+
+		if (SHOP_SUBHEADER_GC_OK != ret)
+		{
+			TPacketGCShop pack;
+			pack.header = HEADER_GC_SHOP;
+			pack.subheader = static_cast<BYTE>(ret);
+			pack.size = sizeof(TPacketGCShop);
+			ch->GetDesc()->Packet(&pack, sizeof(pack));
+		}
+		else
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_TEXT("SHOP_SEARCH_OK"));
+
+		break;
+	}
+	default:
+		sys_err("ShopSearchBuy ch(%s) wrong state(%d)", ch->GetName(), bState);
+		break;
+	}
+}
+#endif
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/typedef.h final/server/server/home/metin2/Source/Server/game/src/typedef.h
--- baseline/server/server/home/metin2/Source/Server/game/src/typedef.h	2025-06-28 21:42:40.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/typedef.h	2021-06-22 11:31:34.000000000 +0000
@@ -30,7 +30,7 @@
 #endif
 typedef std::vector<LPCHARACTER> CHARACTER_VECTOR;
 typedef std::list<LPCHARACTER> CHARACTER_LIST;
-typedef std::unordered_set<LPCHARACTER> CHARACTER_SET;
+typedef TR1_NS::unordered_set<LPCHARACTER> CHARACTER_SET;
 
 class CItem;
 #ifdef USE_DEBUG_PTR
@@ -39,13 +39,6 @@
 typedef CItem* LPITEM;
 #endif
 
-class CAffect;
-#ifdef USE_DEBUG_PTR
-typedef DebugPtr<CAffect> LPAFFECT;
-#else
-typedef CAffect* LPAFFECT;
-#endif
-
 namespace building {
 	class CObject;
 #ifdef USE_DEBUG_PTR
@@ -65,7 +58,7 @@
 typedef CEntity* LPENTITY;
 #endif
 typedef std::vector<LPENTITY> ENTITY_VECTOR;
-typedef std::unordered_set<LPENTITY> ENTITY_SET;
+typedef TR1_NS::unordered_set<LPENTITY> ENTITY_SET;
 
 class SECTREE;
 #ifdef USE_DEBUG_PTR
@@ -89,18 +82,6 @@
 typedef CDungeon* LPDUNGEON;
 #endif
 
-#if defined(__DEFENSE_WAVE__)
-class CDefenseWave;
-#ifdef USE_DEBUG_PTR
-typedef DebugPtr<CDefenseWave> LPDEFENSE_WAVE;
-#else
-typedef CDefenseWave* LPDEFENSE_WAVE;
-#endif
-#endif
-
-class CGuild;
-typedef CGuild* LPGUILD;
-
 class CParty;
 #ifdef USE_DEBUG_PTR
 typedef DebugPtr<CParty> LPPARTY;
@@ -108,10 +89,8 @@
 typedef CParty* LPPARTY;
 #endif
 
-#ifdef __GROWTH_PET_SYSTEM__
 class CGrowthPet;
 typedef CGrowthPet* LPGROWTH_PET;
-#endif
 
 typedef struct pixel_position_s
 {
diff -ruN baseline/server/server/home/metin2/Source/Server/game/src/unique_item.h final/server/server/home/metin2/Source/Server/game/src/unique_item.h
--- baseline/server/server/home/metin2/Source/Server/game/src/unique_item.h	2025-06-17 01:25:18.000000000 +0000
+++ final/server/server/home/metin2/Source/Server/game/src/unique_item.h	2022-04-27 12:50:14.000000000 +0000
@@ -1,32 +1,51 @@
 #ifndef __INC_UNIQUE_ITEM_H__
 #define __INC_UNIQUE_ITEM_H__
 
-enum EUniqueItemGroup
+enum
 {
-	//UNIQUE_GROUP_RING_OF_EXP = 10000,
-	UNIQUE_GROUP_DOUBLE_ITEM = 10002,
-	UNIQUE_GROUP_EMOTION_MASK = 10004, //  
-	UNIQUE_GROUP_MARRIAGE_FASTER_LOVE_POINT = 10008,
-	UNIQUE_GROUP_FISH_MIND = 10009, // 
-	UNIQUE_GROUP_PARTY_BONUS_EXP = 10010,
-	UNIQUE_GROUP_AUTO_LOOT = 10011, // 3 
-	UNIQUE_GROUP_LARGE_SAFEBOX = 10021, // âȮ
 	UNIQUE_GROUP_LUCKY_GOLD = 10024,
+	UNIQUE_GROUP_AUTOLOOT = 10011,
+	UNIQUE_GROUP_RING_OF_EXP = 10000,
+	UNIQUE_GROUP_FISH_MIND = 10009,
+	UNIQUE_GROUP_LARGE_SAFEBOX = 10021,
+	UNIQUE_GROUP_DOUBLE_ITEM = 10002,
 	UNIQUE_GROUP_RING_OF_LANGUAGE = 10025,
+
 	UNIQUE_GROUP_SPECIAL_RIDE = 10030,
-	UNIQUE_GROUP_WARP_RING = 10031,
+	UNIQUE_GROUP_DRAGON_HEART = 10053,
 
-	UNIQUE_GROUP_PARTY_BONUS_EXP_100 = 10042,
-};
+	UNIQUE_ITEM_TEARDROP_OF_GODNESS = 70012,
+	UNIQUE_ITEM_RING_OF_LANGUAGE = 70006,
+	UNIQUE_ITEM_RING_OF_LANGUAGE_SAMPLE = 70047,
+	UNIQUE_ITEM_WHITE_FLAG = 70008,
+	UNIQUE_ITEM_TREASURE_BOX = 70009,
+	UNIQUE_ITEM_CAPE_OF_COURAGE = 70038,
+	UNIQUE_ITEM_HALF_STAMINA = 70040,
 
-enum EItem
-{
-	ITEM_XMAS_SOCK = 50010,
-	ITEM_WHITE_FLAG = 70008,
+	UNIQUE_ITEM_HIDE_ALIGNMENT_TITLE = 70048,
+	UNIQUE_ITEM_SKIP_ITEM_DROP_PENALTY = 70049,
+	UNIQUE_ITEM_FASTER_ALIGNMENT_UP_BY_TIME = 70050,
+	UNIQUE_ITEM_FASTER_ALIGNMENT_UP_BY_KILL = 70051,
+
+	UNIQUE_ITEM_NO_BAD_LUCK_EFFECT = 70052,
+
+	UNIQUE_ITEM_LARBOR_MEDAL = 70004,
+	UNIQUE_ITEM_DOUBLE_EXP = 70005,
+	UNIQUE_ITEM_DOUBLE_ITEM = 70043,
+
+	UNIQUE_ITEM_PARTY_BONUS_EXP = 70003,
+	UNIQUE_ITEM_PARTY_BONUS_EXP_MALL = 71012,
+	UNIQUE_ITEM_PARTY_BONUS_EXP_GIFT = 76011,
 
 	ITEM_GIVE_STAT_RESET_COUNT_VNUM = 70014,
 	ITEM_SKILLFORGET_VNUM = 70037,
-	//ITEM_SKILLFORGET2_VNUM = 70055, // 7, 8 ų 
+	ITEM_SKILLFORGET2_VNUM = 70055, // 7, 8 ų 
+
+	UNIQUE_ITEM_FISH_MIND = 71008, // 
+	UNIQUE_ITEM_SAFEBOX_EXPAND = 71009, // âȮ
+	UNIQUE_ITEM_AUTOLOOT_GOLD = 71010, // 3 
+	UNIQUE_ITEM_EMOTION_MASK = 71011, //  
+	UNIQUE_ITEM_EMOTION_MASK2 = 71033, //  
 
 	ITEM_NEW_YEAR_GREETING_VNUM = 50023,
 
@@ -48,13 +67,25 @@
 	ITEM_REVIVE_HORSE_3 = 50059,
 	ITEM_HORSE_SKILL_TRAIN_BOOK = 50060,
 
+	//UNIQUE_ITEM_MARRIAGE_FASTER_LOVE_POINT = 71068,
+	UNIQUE_ITEM_MARRIAGE_PENETRATE_BONUS = 71069,
+	UNIQUE_ITEM_MARRIAGE_EXP_BONUS = 71070,
+	UNIQUE_ITEM_MARRIAGE_CRITICAL_BONUS = 71071,
+	UNIQUE_ITEM_MARRIAGE_TRANSFER_DAMAGE = 71072,
+	UNIQUE_ITEM_MARRIAGE_ATTACK_BONUS = 71073,
+	UNIQUE_ITEM_MARRIAGE_DEFENSE_BONUS = 71074,
+
 	ITEM_MARRIAGE_RING = 70302,
 
 	ITEM_SKILLBOOK_VNUM = 50300,
+
 	ITEM_MINING_SKILL_TRAIN_BOOK = 50600,
 
 	ITEM_PRISM = 71113,
-	ITEM_PRISM_MALL = 39035,
+
+#if defined(__ANTI_EXP_RING__)
+	ITEM_ANTI_EXP_RING = 72501,
+#endif
 
 	ITEM_AUTO_HP_RECOVERY_S = 72723,
 	ITEM_AUTO_HP_RECOVERY_M = 72724,
@@ -65,272 +96,38 @@
 	ITEM_AUTO_SP_RECOVERY_M = 72728,
 	ITEM_AUTO_SP_RECOVERY_L = 72729,
 	ITEM_AUTO_SP_RECOVERY_X = 72730,
+	ITEM_RAMADAN_CANDY = 50183,
+	UNIQUE_ITEM_RAMADAN_RING = 71135,
+	ITEM_NOG_POCKET = 50216,
 
 	REWARD_BOX_ITEM_AUTO_SP_RECOVERY_XS = 76004,
 	REWARD_BOX_ITEM_AUTO_SP_RECOVERY_S = 76005,
 
-	REWARD_BOX_ITEM_AUTO_HP_RECOVERY_XS = 76022,
 	REWARD_BOX_ITEM_AUTO_HP_RECOVERY_S = 76021,
+	REWARD_BOX_ITEM_AUTO_HP_RECOVERY_XS = 76022,
 
-	ITEM_RAMADAN_CANDY = 50183,
-	ITEM_NOG_POCKET = 50216,
+	FUCKING_BRAZIL_ITEM_AUTO_SP_RECOVERY_S = 79013,
+	FUCKING_BRAZIL_ITEM_AUTO_HP_RECOVERY_S = 79012,
+
+	REWARD_BOX_UNIQUE_ITEM_CAPE_OF_COURAGE = 76007,
 
 	// ȥ  Ȯ ִ 
 	DRAGON_SOUL_EXTRACTOR_GROUP = 10600,
 	//  ִ 
 	DRAGON_HEART_EXTRACTOR_GROUP = 10601,
 	// ȥ   ִ .
-	ITEM_DRAGON_HEART_VNUM = 100000,
+	DRAGON_HEART_VNUM = 100000,
 
-	ITEM_RESEARCHERS_ELIXIR = 39023,
-	ITEM_RESEARCHERS_ELIXIR_GIFT = 71035,
-	ITEM_RESEARCHERS_ELIXIR_MALL = 76020,
-
-#if defined(__SOUL_BIND_SYSTEM__)
-	ITEM_SCROLL_BINDING = 50263,
-	ITEM_SCROLL_UNBINDING = 50264,
-#if defined(__UN_SEAL_SCROLL_PLUS__)
-	ITEM_SCROLL_UNBINDING_MALL = 50262,
-#endif
+#if defined(__PRIVATESHOP_SEARCH_SYSTEM__)
+	PRIVATESHOP_SEARCH_LOOKING_GLASS = 60004,
+	PRIVATESHOP_SEARCH_TRADING_GLASS = 60005,
 #endif
 #if defined(__MYSHOP_DECO__)
-	ITEM_KASHMIR_BUNDLE = 71221,
+	KASHMIR_BUNDLE = 71221, // NOTE: Simular to the SilkBundle (71049), the item will be removed when the REAL_TIME expires.
 #endif
 #if defined(__MAILBOX__)
-	ITEM_MOBILE_MAILBOX = 72340,
-#endif
-#if defined(__ACCE_COSTUME_SYSTEM__)
-	ITEM_ACCE_REVERSAL = 90000,
-	ITEM_ACCE_REVERSAL_MALL = 39046,
-#endif
-#if defined(__CHANGE_LOOK_SYSTEM__)
-	ITEM_CHANGE_LOOK_REVERSAL = 72325,
-	ITEM_CHANGE_LOOK_TICKET_1 = 72326,
-	ITEM_CHANGE_LOOK_TICKET_2 = 72341,
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-	ITEM_CHANGE_LOOK_MOUNT_REVERSAL = 72343,
-	ITEM_CHANGE_LOOK_MOUNT_TICKET = 72344,
-#endif
-#endif
-#if defined(__EXTEND_INVEN_SYSTEM__)
-	ITEM_EXTEND_INVEN_TICKET = 72319,
-	ITEM_EXTEND_INVEN_TICKET_MALL = 72320,
-#endif
-#if defined(__SET_ITEM__)
-	ITEM_SET_CLEAR_SCROLL = 39115,
-#endif
-#if defined(__EASTER_EVENT__)
-	ITEM_MAGIC_EASTER_EGG = 71150,
-#endif
-#if defined(__ELEMENTAL_DUNGEON__)
-	ITEM_PRIMAL_FORCE_MEDAL = 39113,
-	ITEM_PRIMAL_FORCE_RING = 39114,
-	ITEM_ELEMENTAL_DEFENSE_POTION = 39118,
-	ITEM_PRIMAL_FORCE_RING_MALL = 39116,
-#endif
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-	ITEM_GUILD_DRAGONLAIR_POTION = 27126,
-	ITEM_GUILD_DRAGONLAIR_RING = 30341,
+	MOBILE_MAILBOX = 72340,
 #endif
 };
 
-enum EUniqueItemVnum
-{
-	UNIQUE_ITEM_TEARDROP_OF_GODNESS = 70012,
-	UNIQUE_ITEM_HALF_STAMINA = 70040,
-	UNIQUE_ITEM_HIDE_ALIGNMENT_TITLE = 70048,
-	UNIQUE_ITEM_SKIP_ITEM_DROP_PENALTY = 70049,
-	UNIQUE_ITEM_FASTER_ALIGNMENT_UP_BY_TIME = 70050,
-	UNIQUE_ITEM_FASTER_ALIGNMENT_UP_BY_KILL = 70051,
-	UNIQUE_ITEM_ANTI_EXP = 76051,
-	UNIQUE_ITEM_NO_BAD_LUCK_EFFECT = 70052,
-	UNIQUE_ITEM_LARBOR_MEDAL = 70004,
-
-	//UNIQUE_ITEM_MARRIAGE_FASTER_LOVE_POINT = 71068,
-	UNIQUE_ITEM_MARRIAGE_PENETRATE_BONUS = 71069,
-	UNIQUE_ITEM_MARRIAGE_EXP_BONUS = 71070,
-	UNIQUE_ITEM_MARRIAGE_CRITICAL_BONUS = 71071,
-	UNIQUE_ITEM_MARRIAGE_TRANSFER_DAMAGE = 71072,
-	UNIQUE_ITEM_MARRIAGE_ATTACK_BONUS = 71073,
-	UNIQUE_ITEM_MARRIAGE_DEFENSE_BONUS = 71074,
-};
-
-enum EItemVnum
-{
-	ITEM_VNUM_ADDITIONAL_EQUIPMENT_PAGE_ACTIVATION = 76055,
-	ITEM_VNUM_ADDITIONAL_EQUIPMENT_PAGE_ACTIVATION_SELF = 38306,
-	ITEM_VNUM_AMETHYST = 50632,
-	ITEM_VNUM_AMETHYST_BRACELET_0 = 14180,
-	ITEM_VNUM_AMETHYST_EARRINGS_0 = 17180,
-	ITEM_VNUM_AMETHYST_NECKLACE_0 = 16180,
-	ITEM_VNUM_ARMED_HORSE_BOOK = 50052,
-#if defined(__AURA_COSTUME_SYSTEM__)
-	ITEM_VNUM_AURA_CLEAR = 89999,
-#endif
-	ITEM_VNUM_BEWITCH_ITEM = 71051,
-	ITEM_VNUM_BLACK_CRYSTAL = 50662,
-	ITEM_VNUM_BLACK_CRYSTAL_BRACELET_0 = 14600,
-	ITEM_VNUM_BLACK_CRYSTAL_EARRINGS_0 = 17590,
-	ITEM_VNUM_BLACK_CRYSTAL_NECKLACE_0 = 16600,
-	ITEM_VNUM_BLESS_ITEM = 71052,
-#if defined(__MINI_GAME_CATCH_KING__)
-	ITEM_VNUM_CATCH_KING_PIECE = 79603,
-	ITEM_VNUM_CATCH_KING_PACK = 79604,
-#endif
-	ITEM_VNUM_COPPER = 50624,
-	ITEM_VNUM_COPPER_BRACELET_0 = 14020,
-	ITEM_VNUM_COPPER_EARRINGS_0 = 17020,
-	ITEM_VNUM_COPPER_NECKLACE_0 = 16020,
-	ITEM_VNUM_CRYSTAL = 50631,
-	ITEM_VNUM_CRYSTAL_BRACELET_0 = 14160,
-	ITEM_VNUM_CRYSTAL_EARRINGS_0 = 17160,
-	ITEM_VNUM_CRYSTAL_NECKLACE_0 = 16160,
-	ITEM_VNUM_EBONY = 50628,
-	ITEM_VNUM_EBONY_BRACELET_0 = 14100,
-	ITEM_VNUM_EBONY_EARRINGS_0 = 17100,
-	ITEM_VNUM_EBONY_NECKLACE_0 = 16100,
-	ITEM_VNUM_EMERALD = 50637,
-	ITEM_VNUM_EMERALD_BRACELET_0 = 14540,
-	ITEM_VNUM_EMERALD_EARRINGS_0 = 17540,
-	ITEM_VNUM_EMERALD_NECKLACE_0 = 16540,
-	ITEM_VNUM_FOOTBALL = 50096,
-	ITEM_VNUM_FOSSIL_WOOD = 50623,
-	ITEM_VNUM_GARNET = 50636,
-	ITEM_VNUM_GARNET_BRACELET_0 = 14520,
-	ITEM_VNUM_GARNET_EARRINGS_0 = 17520,
-	ITEM_VNUM_GARNET_NECKLACE_0 = 16520,
-	ITEM_VNUM_GEM_BAG = 70608,
-	ITEM_VNUM_GEM_BAG_REWARD = 70611,
-#if defined(__GEM_CONVERTER__)
-	ITEM_VNUM_GEM_CONVERTER = 50935,
-	ITEM_VNUM_GEM_STONE = 50926,
-#endif
-	ITEM_VNUM_GOLD = 50626,
-	ITEM_VNUM_GOLDEN_LAND_RESET = 72758,
-	ITEM_VNUM_GOLDEN_LAND_TREE_FRUIT_BOX = 83075,
-	ITEM_VNUM_GOLDEN_LAND_YELLOW_FRUIT_BOX = 83076,
-	ITEM_VNUM_GOLD_BRACELET_0 = 14060,
-	ITEM_VNUM_GOLD_EARRINGS_0 = 17060,
-	ITEM_VNUM_GOLD_NECKLACE_0 = 16060,
-	ITEM_VNUM_GREEN_MAGIC = 71151,
-	ITEM_VNUM_GREEN_MAGIC_GIFT = 76023,
-	ITEM_VNUM_GREEN_STRENGTH = 71152,
-	ITEM_VNUM_GREEN_STRENGTH_GIFT = 76024,
-	ITEM_VNUM_GUILD_BATTLE_MOVE_AREA_SCROLL = 79021,
-	ITEM_VNUM_GUILD_BATTLE_REQUEST_SCROLL = 79022,
-	ITEM_VNUM_GUILD_BATTLE_REWARD_BOX_HIGH = 50220,
-	ITEM_VNUM_GUILD_BATTLE_REWARD_BOX_LOW = 50218,
-	ITEM_VNUM_GUILD_BATTLE_REWARD_BOX_MEDIUM = 50219,
-	ITEM_VNUM_GUILD_BATTLE_REWARD_BOX_OPEN_KEY = 50221,
-	ITEM_VNUM_HEAVENS_TEAR = 50633,
-	ITEM_VNUM_HEAVENS_TEAR_BRACELET_0 = 14200,
-	ITEM_VNUM_HEAVENS_TEAR_EARRINGS_0 = 17200,
-	ITEM_VNUM_HEAVENS_TEAR_NECKLACE_0 = 16200,
-	ITEM_VNUM_HORSE_PICTURE = 50051,
-	ITEM_VNUM_ICECREAM_SCOOP = 50279,
-	ITEM_VNUM_IRON = 50664,
-	ITEM_VNUM_IRON_BRACELET_0 = 14580,
-	ITEM_VNUM_IRON_DRAGON_BLESS_L = 79028,
-	ITEM_VNUM_IRON_DRAGON_BLESS_M = 79027,
-	ITEM_VNUM_IRON_DRAGON_BLESS_S = 79026,
-	ITEM_VNUM_IRON_EARRINGS_0 = 17570,
-	ITEM_VNUM_IRON_NECKLACE_0 = 16580,
-	ITEM_VNUM_JADE = 50627,
-	ITEM_VNUM_JADE_BRACELET_0 = 14080,
-	ITEM_VNUM_JADE_EARRINGS_0 = 17080,
-	ITEM_VNUM_JADE_NECKLACE_0 = 16080,
-	ITEM_VNUM_LOOTING = 72756,
-	ITEM_VNUM_MILITARY_HORSE_BOOK = 50053,
-	ITEM_VNUM_MINE_TOWER_SKILL_GUARD = 72757,
-	ITEM_VNUM_MORION = 50663,
-	ITEM_VNUM_MORION_BRACELET_0 = 14610,
-	ITEM_VNUM_MORION_EARRINGS_0 = 17600,
-	ITEM_VNUM_MORION_NECKLACE_0 = 16610,
-	ITEM_VNUM_MOUNT_UPGRADE_SYSTEM_FEED = 50048,
-	ITEM_VNUM_OLYMPIC_BRACELET_0 = 11978,
-	ITEM_VNUM_PEARL = 50629,
-	ITEM_VNUM_PEARL_BRACELET_0 = 14120,
-	ITEM_VNUM_PEARL_EARRINGS_0 = 17120,
-	ITEM_VNUM_PEARL_NECKLACE_0 = 16120,
-	ITEM_VNUM_PLUS_BEAD = 72327,
-	ITEM_VNUM_PLUS_BEAD_ANTI_GIVE = 72329,
-	ITEM_VNUM_PREMIUM_PRIVATE_SHOP_AFFECT = 72355,
-	ITEM_VNUM_PREMIUM_PRIVATE_SHOP_AFFECT_ONEDAY = 72356,
-	ITEM_VNUM_PYRITE = 50661,
-	ITEM_VNUM_PYRITE_BRACELET_0 = 14590,
-	ITEM_VNUM_PYRITE_EARRINGS_0 = 17580,
-	ITEM_VNUM_PYRITE_NECKLACE_0 = 16590,
-	ITEM_VNUM_RAMADAN_BREAD = 30315,
-	ITEM_VNUM_RAMADAN_BREAD_BUNDLE = 30317,
-	ITEM_VNUM_RAMADAN_CANDY = 50183,
-	ITEM_VNUM_RAMADAN_FIG = 30318,
-	ITEM_VNUM_RUBY = 50635,
-	ITEM_VNUM_RUBY_BRACELET_0 = 14500,
-	ITEM_VNUM_RUBY_EARRINGSE_0 = 17500,
-	ITEM_VNUM_RUBY_NECKLACE_0 = 16500,
-#if defined(__MINI_GAME_RUMI__)
-	ITEM_VNUM_RUMI_CARD_PIECE = 79505,
-	ITEM_VNUM_RUMI_CARD_PACK = 79506,
-#endif
-	ITEM_VNUM_SAPPHIRE = 50638,
-	ITEM_VNUM_SAPPHIRE_BRACELET_0 = 14560,
-	ITEM_VNUM_SAPPHIRE_EARRINGS_0 = 17560,
-	ITEM_VNUM_SAPPHIRE_NECKLACE_0 = 16560,
-	ITEM_VNUM_SCROLL_OF_CORRECTION = 71109,
-	ITEM_VNUM_SILVER = 50625,
-	ITEM_VNUM_SILVER_BRACELET_0 = 14040,
-	ITEM_VNUM_SILVER_EARRINGS_0 = 17040,
-	ITEM_VNUM_SILVER_NECKLACE_0 = 16040,
-#if defined(__SNOWFLAKE_STICK_EVENT__)
-	ITEM_VNUM_SNOWFLAKE_STICK = 70612,
-	ITEM_VNUM_SNOWFLAKE_STICK_EVENT_MOUNT = 70614,
-	ITEM_VNUM_SNOWFLAKE_STICK_EVENT_PET = 70615,
-#endif
-	ITEM_VNUM_SOUL_CRYSTAL = 50634,
-	ITEM_VNUM_SOUL_CRYSTAL_BRACELET_0 = 14220,
-	ITEM_VNUM_SOUL_CRYSTAL_EARRINGS_0 = 17220,
-	ITEM_VNUM_SOUL_CRYSTAL_NECKLACE_0 = 16220,
-	ITEM_VNUM_SPORTS_MATCH_APPOINT = 70609,
-	ITEM_VNUM_SPORTS_MATCH_CHEER = 70610,
-	ITEM_VNUM_TOURMALINE = 50639,
-	ITEM_VNUM_TOURMALINE_BRACELET_0 = 14570,
-	ITEM_VNUM_TOURMALINE_NECKLACE_0 = 16570,
-	ITEM_VNUM_TREASURE_HUNT_MASTER_BOX = 70619,
-	ITEM_VNUM_TREASURE_HUNT_MASTER_KEY = 70618,
-	ITEM_VNUM_TREASURE_ISLAND_TICKET = 70617,
-	ITEM_VNUM_UNLIMITED_ENTER_CZ_DUNGEON = 72328,
-	ITEM_VNUM_UPGRADE_HORSE_BOOK = 50049,
-	ITEM_VNUM_VALENTINE_CHOCOLATE = 50025,
-	ITEM_VNUM_VALENTINE_ROSE = 50024,
-	ITEM_VNUM_VALENTINE_WRAP_CHOCOLATE = 50098,
-	ITEM_VNUM_VALENTINE_WRAP_ROSE = 50097,
-	ITEM_VNUM_WHITE_DRAGON_BLESS_L = 79025,
-	ITEM_VNUM_WHITE_DRAGON_BLESS_M = 79024,
-	ITEM_VNUM_WHITE_DRAGON_BLESS_S = 79023,
-	ITEM_VNUM_WHITE_GOLD = 50630,
-	ITEM_VNUM_WHITE_GOLD_BRACELET_0 = 14140,
-	ITEM_VNUM_WHITE_GOLD_EARRINGS_0 = 17140,
-	ITEM_VNUM_WHITE_GOLD_NECKLACE_0 = 16140,
-	ITEM_VNUM_WOOD_BRACELET_0 = 14000,
-	ITEM_VNUM_WOOD_BRACELET_4_OTHER_NUMBER = 62187,
-	ITEM_VNUM_WOOD_BRACELET_5_OTHER_NUMBER = 62188,
-	ITEM_VNUM_WOOD_BRACELET_6_OTHER_NUMBER = 62189,
-	ITEM_VNUM_WOOD_EARRINGS_0 = 17000,
-	ITEM_VNUM_WOOD_EARRINGS_4_OTHER_NUMBER = 62196,
-	ITEM_VNUM_WOOD_EARRINGS_5_OTHER_NUMBER = 62197,
-	ITEM_VNUM_WOOD_EARRINGS_6_OTHER_NUMBER = 62198,
-	ITEM_VNUM_WOOD_NECKLACE_0 = 16000,
-	ITEM_VNUM_WOOD_NECKLACE_4_OTHER_NUMBER = 62193,
-	ITEM_VNUM_WOOD_NECKLACE_5_OTHER_NUMBER = 62194,
-	ITEM_VNUM_WOOD_NECKLACE_6_OTHER_NUMBER = 62195,
-	ITEM_VNUM_WORLDCUP_BOX = 70604,
-	ITEM_VNUM_WORLDCUP_EMBLEM = 70607,
-	ITEM_VNUM_WORLDCUP_SOCCER_BALL_PET = 53342,
-	ITEM_VNUM_WORLDCUP_TROPHY = 70606,
-#if defined(__MINI_GAME_YUTNORI__)
-	ITEM_VNUM_YUT_PIECE = 79507,
-	ITEM_VNUM_YUT_BOARD = 79508,
-#endif
-	ITEM_VNUM_ZEN_BEAN = 70102,
-};
 #endif /* __INC_UNIQUE_ITEM_H__ */
diff -ruN baseline/sql.sql final/sql.sql
--- baseline/sql.sql	2026-02-20 18:01:47.535343854 +0000
+++ final/sql.sql	2026-02-20 18:08:47.723376470 +0000
@@ -352,7 +352,7 @@
 --
 
 /*!40000 ALTER TABLE `innodb_index_stats` DISABLE KEYS */;
-INSERT  IGNORE INTO `innodb_index_stats` VALUES ('mysql','component','PRIMARY','2026-02-17 14:16:31','n_diff_pfx01',0,1,'component_id'),('mysql','component','PRIMARY','2026-02-17 14:16:31','n_leaf_pages',1,NULL,'Number of leaf pages in the index'),('mysql','component','PRIMARY','2026-02-17 14:16:31','size',1,NULL,'Number of pages in the index'),('player','growth_pet','PRIMARY','2026-02-17 15:04:36','n_diff_pfx01',0,1,'id'),('player','growth_pet','PRIMARY','2026-02-17 15:04:36','n_leaf_pages',1,NULL,'Number of leaf pages in the index'),('player','growth_pet','PRIMARY','2026-02-17 15:04:36','size',1,NULL,'Number of pages in the index'),('player','growth_pet','idx_owner_id','2026-02-17 15:04:36','n_diff_pfx01',0,1,'owner_id'),('player','growth_pet','idx_owner_id','2026-02-17 15:04:36','n_diff_pfx02',0,1,'owner_id,id'),('player','growth_pet','idx_owner_id','2026-02-17 15:04:36','n_leaf_pages',1,NULL,'Number of leaf pages in the index'),('player','growth_pet','idx_owner_id','2026-02-17 15:04:36','size',1,NULL,'Number of pages in the index'),('sys','sys_config','PRIMARY','2026-02-17 14:16:31','n_diff_pfx01',6,1,'variable'),('sys','sys_config','PRIMARY','2026-02-17 14:16:31','n_leaf_pages',1,NULL,'Number of leaf pages in the index'),('sys','sys_config','PRIMARY','2026-02-17 14:16:31','size',1,NULL,'Number of pages in the index');
+INSERT  IGNORE INTO `innodb_index_stats` VALUES ('mysql','component','PRIMARY','2026-02-17 14:16:31','n_diff_pfx01',0,1,'component_id'),('mysql','component','PRIMARY','2026-02-17 14:16:31','n_leaf_pages',1,NULL,'Number of leaf pages in the index'),('mysql','component','PRIMARY','2026-02-17 14:16:31','size',1,NULL,'Number of pages in the index'),('sys','sys_config','PRIMARY','2026-02-17 14:16:31','n_diff_pfx01',6,1,'variable'),('sys','sys_config','PRIMARY','2026-02-17 14:16:31','n_leaf_pages',1,NULL,'Number of leaf pages in the index'),('sys','sys_config','PRIMARY','2026-02-17 14:16:31','size',1,NULL,'Number of pages in the index');
 /*!40000 ALTER TABLE `innodb_index_stats` ENABLE KEYS */;
 
 --
@@ -360,7 +360,7 @@
 --
 
 /*!40000 ALTER TABLE `innodb_table_stats` DISABLE KEYS */;
-INSERT  IGNORE INTO `innodb_table_stats` VALUES ('mysql','component','2026-02-17 14:16:31',0,1,0),('player','growth_pet','2026-02-17 15:04:36',0,1,1),('sys','sys_config','2026-02-17 14:16:31',6,1,0);
+INSERT  IGNORE INTO `innodb_table_stats` VALUES ('mysql','component','2026-02-17 14:16:31',0,1,0),('sys','sys_config','2026-02-17 14:16:31',6,1,0);
 /*!40000 ALTER TABLE `innodb_table_stats` ENABLE KEYS */;
 
 --
@@ -2421,89 +2421,7 @@
 /*!40000 ALTER TABLE `gem_shop_port` ENABLE KEYS */;
 UNLOCK TABLES;
 
---
--- Table structure for table `growth_pet`
---
-
-DROP TABLE IF EXISTS `growth_pet`;
-/*!40101 SET @saved_cs_client     = @@character_set_client */;
-/*!50503 SET character_set_client = utf8mb4 */;
-CREATE TABLE `growth_pet` (
-  `id` int NOT NULL,
-  `owner_id` int NOT NULL,
-  `vnum` int NOT NULL,
-  `state` enum('UPBRINGING','BAG','SAFEBOX') NOT NULL DEFAULT 'UPBRINGING',
-  `name` varchar(20) DEFAULT NULL,
-  `size` tinyint NOT NULL DEFAULT '0',
-  `level` int NOT NULL DEFAULT '1',
-  `level_step` tinyint NOT NULL DEFAULT '0',
-  `evolution` tinyint NOT NULL DEFAULT '1',
-  `type` tinyint DEFAULT NULL,
-  `hp` int NOT NULL DEFAULT '0',
-  `sp` int NOT NULL DEFAULT '0',
-  `def` int NOT NULL DEFAULT '0',
-  `hp_apply` tinyint NOT NULL DEFAULT '0',
-  `sp_apply` tinyint NOT NULL DEFAULT '0',
-  `def_apply` tinyint NOT NULL DEFAULT '0',
-  `age_apply` tinyint NOT NULL DEFAULT '0',
-  `skill_level` blob,
-  `exp` int NOT NULL DEFAULT '0',
-  `item_exp` int NOT NULL DEFAULT '0',
-  `birthday` datetime DEFAULT NULL,
-  `end_time` int NOT NULL DEFAULT '0',
-  `max_time` int NOT NULL DEFAULT '0',
-  PRIMARY KEY (`id`),
-  KEY `idx_owner_id` (`owner_id`)
-) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
-/*!40101 SET character_set_client = @saved_cs_client */;
-
---
--- Dumping data for table `growth_pet`
---
-
-LOCK TABLES `growth_pet` WRITE;
-/*!40000 ALTER TABLE `growth_pet` DISABLE KEYS */;
-/*!40000 ALTER TABLE `growth_pet` ENABLE KEYS */;
-UNLOCK TABLES;
-
---
--- Table structure for table `growth_pet_skill_proto`
---
-
-DROP TABLE IF EXISTS `growth_pet_skill_proto`;
-/*!40101 SET @saved_cs_client     = @@character_set_client */;
-/*!50503 SET character_set_client = utf8mb4 */;
-CREATE TABLE `growth_pet_skill_proto` (
-  `dwPetVnum` int NOT NULL,
-  `dwSkillVnum` int NOT NULL,
-  `szName` varchar(32) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci NOT NULL,
-  `bType` enum('PASSIVE','AUTO') CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci NOT NULL,
-  `dwCooldown` int NOT NULL,
-  `setAffectFlag` enum('JIJOONG_WARRIOR','JIJOONG_SURA','JIJOONG_ASSASSIN','JIJOONG_SHAMAN','JIJOONG_WOLFMAN','PACHEON','BANYA','CHEONRYEONG','CHOEHOENBIMU','HEAL','STEALHP','STEALMP','BLOCK','REFLECT_MELEE','GOLD_DROP','BOW_DISTANCE','INVINCIBILITY','REMOVAL','POTION','MOB_BONUS','EXP','HP_RECOVER','FEATHER','STONE','BOSS','RESIST_SKILL','RESIST_DAMAGE') CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
-  `szPointOn` enum('RESIST_WARRIOR','RESIST_SURA','RESIST_ASSASSIN','RESIST_SHAMAN','RESIST_WOLFMAN','RESIST_MAGIC_REDUCTION','MELEE_MAGIC_ATT_BONUS_PER','ATTBONUS_MONSTER','PENETRATE_PCT','CASTING_SPEED','BOW_DISTANCE','STEAL_SP','STEAL_HP','KILL_HP_RECOVERY','BLOCK','REFLECT_MELEE','GOLD_DOUBLE_BONUS','EXP_DOUBLE_BONUS','POTION_BONUS','STONE_BONUS','BOSS_BONUS','RESIST_SKILL','RESIST_HIT') CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci DEFAULT NULL,
-  `szPointPoly1` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci NOT NULL,
-  `szPointPoly2` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci NOT NULL,
-  `szPointPoly3` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci NOT NULL,
-  `szPointPoly4` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci NOT NULL,
-  `szPointPoly5` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci NOT NULL,
-  `szPointPoly6` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci NOT NULL,
-  `szPointPoly7` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci NOT NULL,
-  `szPointPoly8` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci NOT NULL,
-  `szActivatePctPoly` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci NOT NULL,
-  `szDurationPoly` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_general_ci NOT NULL,
-  PRIMARY KEY (`dwPetVnum`,`dwSkillVnum`) USING BTREE
-) ENGINE=MyISAM DEFAULT CHARSET=utf8mb3 ROW_FORMAT=DYNAMIC;
-/*!40101 SET character_set_client = @saved_cs_client */;
 
---
--- Dumping data for table `growth_pet_skill_proto`
---
-
-LOCK TABLES `growth_pet_skill_proto` WRITE;
-/*!40000 ALTER TABLE `growth_pet_skill_proto` DISABLE KEYS */;
-INSERT INTO `growth_pet_skill_proto` VALUES (55701,1,'Resistance (Warrior)','PASSIVE',0,'JIJOONG_WARRIOR','RESIST_WARRIOR','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.455 + lv*0.1625)','1 + (k*0.455 + lv*0.1625)','1 + (k*0.455 + lv*0.1625)','1 + (k*0.455 + lv*0.1625)','0','0'),(55701,2,'Resistance (Sura)','PASSIVE',0,'JIJOONG_SURA','RESIST_SURA','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.455 + lv*0.1625)','1 + (k*0.455 + lv*0.1625)','1 + (k*0.455 + lv*0.1625)','1 + (k*0.455 + lv*0.1625)','0','0'),(55701,3,'Resistance (Ninja)','PASSIVE',0,'JIJOONG_ASSASSIN','RESIST_ASSASSIN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55701,4,'Resistance (Shaman)','PASSIVE',0,'JIJOONG_SHAMAN','RESIST_SHAMAN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55701,5,'Resistance (Lycan)','PASSIVE',0,'JIJOONG_WOLFMAN','RESIST_WOLFMAN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55701,6,'Berserker','PASSIVE',0,'PACHEON','MELEE_MAGIC_ATT_BONUS_PER','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55701,7,'Anti-Magic','PASSIVE',0,'BANYA','RESIST_MAGIC_REDUCTION','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','0','0'),(55701,8,'Haste','PASSIVE',0,'CHEONRYEONG','CASTING_SPEED','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55701,9,'Drill','PASSIVE',0,'CHOEHOENBIMU','PENETRATE_PCT','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','0','0'),(55701,10,'Restoration','AUTO',360,'HEAL','','706.6 + (k*222.579 + lv*79.4925)','706.6 + (k*222.579 + lv*79.4925)','706.6 + (k*222.579 + lv*79.4925)','706.6 + (k*222.579 + lv*79.4925)','706.6 + (k*222.579 + lv*79.4925)','706.6 + (k*222.579 + lv*79.4925)','706.6 + (k*222.579 + lv*79.4925)','706.6 + (k*222.579 + lv*79.4925)','30+ (k*0.455 + lv*0.1625)','0'),(55701,11,'Vampirism','PASSIVE',0,'STEALHP','STEAL_HP','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','0','0'),(55701,12,'Spiritualism','PASSIVE',0,'STEALMP','STEAL_SP','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','0','0'),(55701,13,'Bulwark','PASSIVE',0,'BLOCK','BLOCK','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55701,14,'Reflection','PASSIVE',0,'REFLECT_MELEE','REFLECT_MELEE','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55701,15,'Yang Drop','PASSIVE',0,'GOLD_DROP','GOLD_DOUBLE_BONUS','10.6 + (k*3.339 + lv*1.1925)','10.8 + (k*3.402 + lv*1.215)','10.8 + (k*3.402 + lv*1.215)','11.2 + (k*3.528 + lv*1.26)','11.2 + (k*3.528 + lv*1.26)','11.6 + (k*3.654 + lv*1.305)','11.6 + (k*3.654 + lv*1.305)','11.6 + (k*3.654 + lv*1.305)','0','0'),(55701,16,'Range','PASSIVE',0,'BOW_DISTANCE','BOW_DISTANCE','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55701,17,'Immortal','AUTO',450,'INVINCIBILITY','','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','300+ (k*0.455 + lv*0.1625)','0'),(55701,18,'Panacea','AUTO',360,'REMOVAL','','0','0','0','0','0','0','0','0','30+ (k*0.455 + lv*0.1625)','0'),(55701,19,'Master Brewer','PASSIVE',0,'POTION','POTION_BONUS','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55701,20,'Monster Hunter','PASSIVE',0,'MOB_BONUS','ATTBONUS_MONSTER','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55701,21,'Eagle Eyes','PASSIVE',0,'EXP','EXP_DOUBLE_BONUS','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55701,22,'Life Drain','PASSIVE',0,'HP_RECOVER','KILL_HP_RECOVERY','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','0','0'),(55701,23,'Light as a Feather','AUTO',10,'FEATHER','','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','44+ (k*0.455 + lv*0.1625)','50 + (k*2.8 + lv*1)'),(55702,1,'Resistance (Warrior)','PASSIVE',0,'JIJOONG_WARRIOR','RESIST_WARRIOR','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55702,2,'Resistance (Sura)','PASSIVE',0,'JIJOONG_SURA','RESIST_SURA','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55702,3,'Resistance (Ninja)','PASSIVE',0,'JIJOONG_ASSASSIN','RESIST_ASSASSIN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55702,4,'Resistance (Shaman)','PASSIVE',0,'JIJOONG_SHAMAN','RESIST_SHAMAN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55702,5,'Resistance (Lycan)','PASSIVE',0,'JIJOONG_WOLFMAN','RESIST_WOLFMAN','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.455 + lv*0.1625)','1 + (k*0.455 + lv*0.1625)','1 + (k*0.455 + lv*0.1625)','1 + (k*0.455 + lv*0.1625)','0','0'),(55702,6,'Berserker','PASSIVE',0,'PACHEON','MELEE_MAGIC_ATT_BONUS_PER','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55702,7,'Anti-Magic','PASSIVE',0,'BANYA','RESIST_MAGIC_REDUCTION','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','0','0'),(55702,8,'Haste','PASSIVE',0,'CHEONRYEONG','CASTING_SPEED','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55702,9,'Drill','PASSIVE',0,'CHOEHOENBIMU','PENETRATE_PCT','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','0','0'),(55702,10,'Restoration','AUTO',360,'HEAL','','706.6 + (k*222.579 + lv*79.4925)','706.6 + (k*222.579 + lv*79.4925)','706.6 + (k*222.579 + lv*79.4925)','706.6 + (k*222.579 + lv*79.4925)','706.6 + (k*222.579 + lv*79.4925)','706.6 + (k*222.579 + lv*79.4925)','706.6 + (k*222.579 + lv*79.4925)','706.6 + (k*222.579 + lv*79.4925)','30+ (k*0.455 + lv*0.1625)','0'),(55702,11,'Vampirism','PASSIVE',0,'STEALHP','STEAL_HP','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','0','0'),(55702,12,'Spiritualism','PASSIVE',0,'STEALMP','STEAL_SP','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','0','0'),(55702,13,'Bulwark','PASSIVE',0,'BLOCK','BLOCK','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55702,14,'Reflection','PASSIVE',0,'REFLECT_MELEE','REFLECT_MELEE','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55702,15,'Yang Drop','PASSIVE',0,'GOLD_DROP','GOLD_DOUBLE_BONUS','10.6 + (k*3.339 + lv*1.1925)','10.8 + (k*3.402 + lv*1.215)','10.8 + (k*3.402 + lv*1.215)','11.2 + (k*3.528 + lv*1.26)','11.2 + (k*3.528 + lv*1.26)','11.6 + (k*3.654 + lv*1.305)','11.6 + (k*3.654 + lv*1.305)','11.6 + (k*3.654 + lv*1.305)','0','0'),(55702,16,'Range','PASSIVE',0,'BOW_DISTANCE','BOW_DISTANCE','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55702,17,'Immortal','AUTO',450,'INVINCIBILITY','','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','300+ (k*0.455 + lv*0.1625)','0'),(55702,18,'Panacea','AUTO',360,'REMOVAL','','0','0','0','0','0','0','0','0','30+ (k*0.455 + lv*0.1625)','0'),(55702,19,'Master Brewer','PASSIVE',0,'POTION','POTION_BONUS','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55702,20,'Monster Hunter','PASSIVE',0,'MOB_BONUS','ATTBONUS_MONSTER','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55702,21,'Eagle Eyes','PASSIVE',0,'EXP','EXP_DOUBLE_BONUS','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55702,22,'Life Drain','PASSIVE',0,'HP_RECOVER','KILL_HP_RECOVERY','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','0','0'),(55702,23,'Light as a Feather','AUTO',180,'FEATHER','','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','44+ (k*0.455 + lv*0.1625)','50 + (k*2.8 + lv*1)'),(55703,1,'Resistance (Warrior)','PASSIVE',0,'JIJOONG_WARRIOR','RESIST_WARRIOR','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55703,2,'Resistance (Sura)','PASSIVE',0,'JIJOONG_SURA','RESIST_SURA','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55703,3,'Resistance (Ninja)','PASSIVE',0,'JIJOONG_ASSASSIN','RESIST_ASSASSIN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55703,4,'Resistance (Shaman)','PASSIVE',0,'JIJOONG_SHAMAN','RESIST_SHAMAN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55703,5,'Resistance (Lycan)','PASSIVE',0,'JIJOONG_WOLFMAN','RESIST_WOLFMAN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55703,6,'Berserker','PASSIVE',0,'PACHEON','MELEE_MAGIC_ATT_BONUS_PER','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55703,7,'Anti-Magic','PASSIVE',0,'BANYA','RESIST_MAGIC_REDUCTION','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','0','0'),(55703,8,'Haste','PASSIVE',0,'CHEONRYEONG','CASTING_SPEED','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','0','0'),(55703,9,'Drill','PASSIVE',0,'CHOEHOENBIMU','PENETRATE_PCT','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55703,10,'Restoration','AUTO',360,'HEAL','','713.3 + (k*224.689 + lv*80.2463)','713.3 + (k*224.689 + lv*80.2463)','720 + (k*226.8 + lv*81)','720 + (k*226.8 + lv*81)','733.3 + (k*230.99 + lv*82.4963)','720 + (k*226.8 + lv*81)','733.3 + (k*230.99 + lv*82.4963)','720 + (k*226.8 + lv*81)','70+ (k*0.455 + lv*0.1625)','0'),(55703,11,'Vampirism','PASSIVE',0,'STEALHP','STEAL_HP','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55703,12,'Spiritualism','PASSIVE',0,'STEALMP','STEAL_SP','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55703,13,'Bulwark','PASSIVE',0,'BLOCK','BLOCK','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55703,14,'Reflection','PASSIVE',0,'REFLECT_MELEE','REFLECT_MELEE','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55703,15,'Yang Drop','PASSIVE',0,'GOLD_DROP','GOLD_DOUBLE_BONUS','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','0','0'),(55703,16,'Range','PASSIVE',0,'BOW_DISTANCE','BOW_DISTANCE','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55703,17,'Immortal','AUTO',450,'INVINCIBILITY','','10 + (k*0.63 + lv*0.225)','10 + (k*0.63 + lv*0.225)','10 + (k*0.665 + lv*0.2375)','10 + (k*0.665 + lv*0.2375)','10 + (k*0.7 + lv*0.25)','10 + (k*0.7 + lv*0.25)','10 + (k*0.7 + lv*0.25)','10 + (k*0.7 + lv*0.25)','300+ (k*0.455 + lv*0.1625)','0'),(55703,18,'Panacea','AUTO',360,'REMOVAL','','0','0','0','0','0','0','0','0','70+ (k*0.455 + lv*0.1625)','0'),(55703,19,'Master Brewer','PASSIVE',0,'POTION','POTION_BONUS','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55703,20,'Monster Hunter','PASSIVE',0,'MOB_BONUS','ATTBONUS_MONSTER','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','0','0'),(55703,21,'Eagle Eyes','PASSIVE',0,'EXP','EXP_DOUBLE_BONUS','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','0','0'),(55703,22,'Life Drain','PASSIVE',0,'HP_RECOVER','KILL_HP_RECOVERY','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55703,23,'Light as a Feather','AUTO',180,'FEATHER','','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','44+ (k*0.455 + lv*0.1625)','50 + (k*2.8 + lv*1)'),(55704,1,'Resistance (Warrior)','PASSIVE',0,'JIJOONG_WARRIOR','RESIST_WARRIOR','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55704,2,'Resistance (Sura)','PASSIVE',0,'JIJOONG_SURA','RESIST_SURA','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55704,3,'Resistance (Ninja)','PASSIVE',0,'JIJOONG_ASSASSIN','RESIST_ASSASSIN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55704,4,'Resistance (Shaman)','PASSIVE',0,'JIJOONG_SHAMAN','RESIST_SHAMAN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55704,5,'Resistance (Lycan)','PASSIVE',0,'JIJOONG_WOLFMAN','RESIST_WOLFMAN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55704,6,'Berserker','PASSIVE',0,'PACHEON','MELEE_MAGIC_ATT_BONUS_PER','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55704,7,'Anti-Magic','PASSIVE',0,'BANYA','RESIST_MAGIC_REDUCTION','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','0','0'),(55704,8,'Haste','PASSIVE',0,'CHEONRYEONG','CASTING_SPEED','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','0','0'),(55704,9,'Drill','PASSIVE',0,'CHOEHOENBIMU','PENETRATE_PCT','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55704,10,'Restoration','AUTO',360,'HEAL','','713.3 + (k*224.689 + lv*80.2463)','713.3 + (k*224.689 + lv*80.2463)','720 + (k*226.8 + lv*81)','720 + (k*226.8 + lv*81)','733.3 + (k*230.99 + lv*82.4963)','720 + (k*226.8 + lv*81)','733.3 + (k*230.99 + lv*82.4963)','720 + (k*226.8 + lv*81)','70+ (k*0.455 + lv*0.1625)','0'),(55704,11,'Vampirism','PASSIVE',0,'STEALHP','STEAL_HP','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55704,12,'Spiritualism','PASSIVE',0,'STEALMP','STEAL_SP','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55704,13,'Bulwark','PASSIVE',0,'BLOCK','BLOCK','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55704,14,'Reflection','PASSIVE',0,'REFLECT_MELEE','REFLECT_MELEE','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55704,15,'Yang Drop','PASSIVE',0,'GOLD_DROP','GOLD_DOUBLE_BONUS','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','0','0'),(55704,16,'Range','PASSIVE',0,'BOW_DISTANCE','BOW_DISTANCE','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55704,17,'Immortal','AUTO',450,'INVINCIBILITY','','10 + (k*0.63 + lv*0.225)','10 + (k*0.63 + lv*0.225)','10 + (k*0.665 + lv*0.2375)','10 + (k*0.665 + lv*0.2375)','10 + (k*0.7 + lv*0.25)','10 + (k*0.7 + lv*0.25)','10 + (k*0.7 + lv*0.25)','10 + (k*0.7 + lv*0.25)','300+ (k*0.455 + lv*0.1625)','0'),(55704,18,'Panacea','AUTO',360,'REMOVAL','','0','0','0','0','0','0','0','0','70+ (k*0.455 + lv*0.1625)','0'),(55704,19,'Master Brewer','PASSIVE',0,'POTION','POTION_BONUS','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55704,20,'Monster Hunter','PASSIVE',0,'MOB_BONUS','ATTBONUS_MONSTER','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','0','0'),(55704,21,'Eagle Eyes','PASSIVE',0,'EXP','EXP_DOUBLE_BONUS','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','0','0'),(55704,22,'Life Drain','PASSIVE',0,'HP_RECOVER','KILL_HP_RECOVERY','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55704,23,'Light as a Feather','AUTO',180,'FEATHER','','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','44+ (k*0.455 + lv*0.1625)','50 + (k*2.8 + lv*1)'),(55705,1,'Resistance (Warrior)','PASSIVE',0,'JIJOONG_WARRIOR','RESIST_WARRIOR','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55705,2,'Resistance (Sura)','PASSIVE',0,'JIJOONG_SURA','RESIST_SURA','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55705,3,'Resistance (Ninja)','PASSIVE',0,'JIJOONG_ASSASSIN','RESIST_ASSASSIN','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.455 + lv*0.1625)','1 + (k*0.455 + lv*0.1625)','1 + (k*0.455 + lv*0.1625)','1 + (k*0.455 + lv*0.1625)','0','0'),(55705,4,'Resistance (Shaman)','PASSIVE',0,'JIJOONG_SHAMAN','RESIST_SHAMAN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55705,5,'Resistance (Lycan)','PASSIVE',0,'JIJOONG_WOLFMAN','RESIST_WOLFMAN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55705,6,'Berserker','PASSIVE',0,'PACHEON','MELEE_MAGIC_ATT_BONUS_PER','1 + (k*0.35 + lv*0.125)','1 + (k*0.35 + lv*0.125)','1 + (k*0.35 + lv*0.125)','1 + (k*0.35 + lv*0.125)','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','0','0'),(55705,7,'Anti-Magic','PASSIVE',0,'BANYA','RESIST_MAGIC_REDUCTION','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55705,8,'Haste','PASSIVE',0,'CHEONRYEONG','CASTING_SPEED','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','0','0'),(55705,9,'Drill','PASSIVE',0,'CHOEHOENBIMU','PENETRATE_PCT','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55705,10,'Restoration','AUTO',360,'HEAL','','713.3 + (k*224.689 + lv*80.2463)','713.3 + (k*224.689 + lv*80.2463)','720 + (k*226.8 + lv*81)','720 + (k*226.8 + lv*81)','733.3 + (k*230.99 + lv*82.4963)','733.3 + (k*230.99 + lv*82.4963)','733.3 + (k*230.99 + lv*82.4963)','733.3 + (k*230.99 + lv*82.4963)','50+ (k*0.455 + lv*0.1625)','0'),(55705,11,'Vampirism','PASSIVE',0,'STEALHP','STEAL_HP','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55705,12,'Spiritualism','PASSIVE',0,'STEALMP','STEAL_SP','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55705,13,'Bulwark','PASSIVE',0,'BLOCK','BLOCK','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55705,14,'Reflection','PASSIVE',0,'REFLECT_MELEE','REFLECT_MELEE','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55705,15,'Yang Drop','PASSIVE',0,'GOLD_DROP','GOLD_DOUBLE_BONUS','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','0','0'),(55705,16,'Range','PASSIVE',0,'BOW_DISTANCE','BOW_DISTANCE','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55705,17,'Immortal','AUTO',450,'INVINCIBILITY','','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','300+ (k*0.455 + lv*0.1625)','0'),(55705,18,'Panacea','AUTO',360,'REMOVAL','','0','0','0','0','0','0','0','0','50+ (k*0.455 + lv*0.1625)','0'),(55705,19,'Master Brewer','PASSIVE',0,'POTION','POTION_BONUS','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55705,20,'Monster Hunter','PASSIVE',0,'MOB_BONUS','ATTBONUS_MONSTER','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55705,21,'Eagle Eyes','PASSIVE',0,'EXP','EXP_DOUBLE_BONUS','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','0','0'),(55705,22,'Life Drain','PASSIVE',0,'HP_RECOVER','KILL_HP_RECOVERY','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55705,23,'Light as a Feather','AUTO',180,'FEATHER','','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','0','50 + (k*2.8 + lv*1)'),(55706,1,'Resistance (Warrior)','PASSIVE',0,'JIJOONG_WARRIOR','RESIST_WARRIOR','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55706,2,'Resistance (Sura)','PASSIVE',0,'JIJOONG_SURA','RESIST_SURA','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55706,3,'Resistance (Ninja)','PASSIVE',0,'JIJOONG_ASSASSIN','RESIST_ASSASSIN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55706,4,'Resistance (Shaman)','PASSIVE',0,'JIJOONG_SHAMAN','RESIST_SHAMAN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55706,5,'Resistance (Lycan)','PASSIVE',0,'JIJOONG_WOLFMAN','RESIST_WOLFMAN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55706,6,'Berserker','PASSIVE',0,'PACHEON','MELEE_MAGIC_ATT_BONUS_PER','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55706,7,'Anti-Magic','PASSIVE',0,'BANYA','RESIST_MAGIC_REDUCTION','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','0','0'),(55706,8,'Haste','PASSIVE',0,'CHEONRYEONG','CASTING_SPEED','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','0','0'),(55706,9,'Drill','PASSIVE',0,'CHOEHOENBIMU','PENETRATE_PCT','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55706,10,'Restoration','AUTO',360,'HEAL','','713.3 + (k*224.689 + lv*80.2463)','713.3 + (k*224.689 + lv*80.2463)','720 + (k*226.8 + lv*81)','720 + (k*226.8 + lv*81)','733.3 + (k*230.99 + lv*82.4963)','720 + (k*226.8 + lv*81)','733.3 + (k*230.99 + lv*82.4963)','720 + (k*226.8 + lv*81)','70+ (k*0.455 + lv*0.1625)','0'),(55706,11,'Vampirism','PASSIVE',0,'STEALHP','STEAL_HP','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55706,12,'Spiritualism','PASSIVE',0,'STEALMP','STEAL_SP','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55706,13,'Bulwark','PASSIVE',0,'BLOCK','BLOCK','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55706,14,'Reflection','PASSIVE',0,'REFLECT_MELEE','REFLECT_MELEE','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55706,15,'Yang Drop','PASSIVE',0,'GOLD_DROP','GOLD_DOUBLE_BONUS','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','0','0'),(55706,16,'Range','PASSIVE',0,'BOW_DISTANCE','BOW_DISTANCE','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55706,17,'Immortal','AUTO',450,'INVINCIBILITY','','10 + (k*0.63 + lv*0.225)','10 + (k*0.63 + lv*0.225)','10 + (k*0.665 + lv*0.2375)','10 + (k*0.665 + lv*0.2375)','10 + (k*0.7 + lv*0.25)','10 + (k*0.7 + lv*0.25)','10 + (k*0.7 + lv*0.25)','10 + (k*0.7 + lv*0.25)','300+ (k*0.455 + lv*0.1625)','0'),(55706,18,'Panacea','AUTO',360,'REMOVAL','','0','0','0','0','0','0','0','0','70+ (k*0.455 + lv*0.1625)','0'),(55706,19,'Master Brewer','PASSIVE',0,'POTION','POTION_BONUS','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55706,20,'Monster Hunter','PASSIVE',0,'MOB_BONUS','ATTBONUS_MONSTER','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','0','0'),(55706,21,'Eagle Eyes','PASSIVE',0,'EXP','EXP_DOUBLE_BONUS','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','0','0'),(55706,22,'Life Drain','PASSIVE',0,'HP_RECOVER','KILL_HP_RECOVERY','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55706,23,'Light as a Feather','AUTO',180,'FEATHER','','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','44+ (k*0.455 + lv*0.1625)','50 + (k*2.8 + lv*1)'),(55707,1,'Resistance (Warrior)','PASSIVE',0,'JIJOONG_WARRIOR','RESIST_WARRIOR','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55707,2,'Resistance (Sura)','PASSIVE',0,'JIJOONG_SURA','RESIST_SURA','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55707,3,'Resistance (Ninja)','PASSIVE',0,'JIJOONG_ASSASSIN','RESIST_ASSASSIN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55707,4,'Resistance (Shaman)','PASSIVE',0,'JIJOONG_SHAMAN','RESIST_SHAMAN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55707,5,'Resistance (Lycan)','PASSIVE',0,'JIJOONG_WOLFMAN','RESIST_WOLFMAN','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.455 + lv*0.1625)','1 + (k*0.455 + lv*0.1625)','1 + (k*0.455 + lv*0.1625)','1 + (k*0.455 + lv*0.1625)','0','0'),(55707,6,'Berserker','PASSIVE',0,'PACHEON','MELEE_MAGIC_ATT_BONUS_PER','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55707,7,'Anti-Magic','PASSIVE',0,'BANYA','RESIST_MAGIC_REDUCTION','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55707,8,'Haste','PASSIVE',0,'CHEONRYEONG','CASTING_SPEED','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','0','0'),(55707,9,'Drill','PASSIVE',0,'CHOEHOENBIMU','PENETRATE_PCT','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55707,10,'Restoration','AUTO',360,'HEAL','','713.3 + (k*224.689 + lv*80.2463)','713.3 + (k*224.689 + lv*80.2463)','720 + (k*226.8 + lv*81)','720 + (k*226.8 + lv*81)','733.3 + (k*230.99 + lv*82.4963)','733.3 + (k*230.99 + lv*82.4963)','733.3 + (k*230.99 + lv*82.4963)','733.3 + (k*230.99 + lv*82.4963)','50+ (k*0.455 + lv*0.1625)','0'),(55707,11,'Vampirism','PASSIVE',0,'STEALHP','STEAL_HP','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55707,12,'Spiritualism','PASSIVE',0,'STEALMP','STEAL_SP','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55707,13,'Bulwark','PASSIVE',0,'BLOCK','BLOCK','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55707,14,'Reflection','PASSIVE',0,'REFLECT_MELEE','REFLECT_MELEE','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55707,15,'Yang Drop','PASSIVE',0,'GOLD_DROP','GOLD_DOUBLE_BONUS','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','0','0'),(55707,16,'Range','PASSIVE',0,'BOW_DISTANCE','BOW_DISTANCE','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55707,17,'Immortal','AUTO',450,'INVINCIBILITY','','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','300+ (k*0.455 + lv*0.1625)','0'),(55707,18,'Panacea','AUTO',360,'REMOVAL','','0','0','0','0','0','0','0','0','50+ (k*0.455 + lv*0.1625)','0'),(55707,19,'Master Brewer','PASSIVE',0,'POTION','POTION_BONUS','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55707,20,'Monster Hunter','PASSIVE',0,'MOB_BONUS','ATTBONUS_MONSTER','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55707,21,'Eagle Eyes','PASSIVE',0,'EXP','EXP_DOUBLE_BONUS','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','0','0'),(55707,22,'Life Drain','PASSIVE',0,'HP_RECOVER','KILL_HP_RECOVERY','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55707,23,'Light as a Feather','AUTO',180,'FEATHER','','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','0','50 + (k*2.8 + lv*1)'),(55708,1,'Resistance (Warrior)','PASSIVE',0,'JIJOONG_WARRIOR','RESIST_WARRIOR','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55708,2,'Resistance (Sura)','PASSIVE',0,'JIJOONG_SURA','RESIST_SURA','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55708,3,'Resistance (Ninja)','PASSIVE',0,'JIJOONG_ASSASSIN','RESIST_ASSASSIN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55708,4,'Resistance (Shaman)','PASSIVE',0,'JIJOONG_SHAMAN','RESIST_SHAMAN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55708,5,'Resistance (Lycan)','PASSIVE',0,'JIJOONG_WOLFMAN','RESIST_WOLFMAN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55708,6,'Berserker','PASSIVE',0,'PACHEON','MELEE_MAGIC_ATT_BONUS_PER','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55708,7,'Anti-Magic','PASSIVE',0,'BANYA','RESIST_MAGIC_REDUCTION','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','0','0'),(55708,8,'Haste','PASSIVE',0,'CHEONRYEONG','CASTING_SPEED','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','0','0'),(55708,9,'Drill','PASSIVE',0,'CHOEHOENBIMU','PENETRATE_PCT','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55708,10,'Restoration','AUTO',360,'HEAL','','713.3 + (k*224.689 + lv*80.2463)','713.3 + (k*224.689 + lv*80.2463)','720 + (k*226.8 + lv*81)','720 + (k*226.8 + lv*81)','733.3 + (k*230.99 + lv*82.4963)','720 + (k*226.8 + lv*81)','733.3 + (k*230.99 + lv*82.4963)','720 + (k*226.8 + lv*81)','70+ (k*0.455 + lv*0.1625)','0'),(55708,11,'Vampirism','PASSIVE',0,'STEALHP','STEAL_HP','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55708,12,'Spiritualism','PASSIVE',0,'STEALMP','STEAL_SP','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55708,13,'Bulwark','PASSIVE',0,'BLOCK','BLOCK','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55708,14,'Reflection','PASSIVE',0,'REFLECT_MELEE','REFLECT_MELEE','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55708,15,'Yang Drop','PASSIVE',0,'GOLD_DROP','GOLD_DOUBLE_BONUS','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','0','0'),(55708,16,'Range','PASSIVE',0,'BOW_DISTANCE','BOW_DISTANCE','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55708,17,'Immortal','AUTO',450,'INVINCIBILITY','','10 + (k*0.63 + lv*0.225)','10 + (k*0.63 + lv*0.225)','10 + (k*0.665 + lv*0.2375)','10 + (k*0.665 + lv*0.2375)','10 + (k*0.7 + lv*0.25)','10 + (k*0.7 + lv*0.25)','10 + (k*0.7 + lv*0.25)','10 + (k*0.7 + lv*0.25)','300+ (k*0.455 + lv*0.1625)','0'),(55708,18,'Panacea','AUTO',360,'REMOVAL','','0','0','0','0','0','0','0','0','70+ (k*0.455 + lv*0.1625)','0'),(55708,19,'Master Brewer','PASSIVE',0,'POTION','POTION_BONUS','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55708,20,'Monster Hunter','PASSIVE',0,'MOB_BONUS','ATTBONUS_MONSTER','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','0','0'),(55708,21,'Eagle Eyes','PASSIVE',0,'EXP','EXP_DOUBLE_BONUS','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','0','0'),(55708,22,'Life Drain','PASSIVE',0,'HP_RECOVER','KILL_HP_RECOVERY','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55708,23,'Light as a Feather','AUTO',180,'FEATHER','','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','44+ (k*0.455 + lv*0.1625)','50 + (k*2.8 + lv*1)'),(55709,1,'Resistance (Warrior)','PASSIVE',0,'JIJOONG_WARRIOR','RESIST_WARRIOR','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55709,2,'Resistance (Sura)','PASSIVE',0,'JIJOONG_SURA','RESIST_SURA','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55709,3,'Resistance (Ninja)','PASSIVE',0,'JIJOONG_ASSASSIN','RESIST_ASSASSIN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55709,4,'Resistance (Shaman)','PASSIVE',0,'JIJOONG_SHAMAN','RESIST_SHAMAN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55709,5,'Resistance (Lycan)','PASSIVE',0,'JIJOONG_WOLFMAN','RESIST_WOLFMAN','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.455 + lv*0.1625)','1 + (k*0.455 + lv*0.1625)','1 + (k*0.455 + lv*0.1625)','1 + (k*0.455 + lv*0.1625)','0','0'),(55709,6,'Berserker','PASSIVE',0,'PACHEON','MELEE_MAGIC_ATT_BONUS_PER','1 + (k*0.35 + lv*0.125)','1 + (k*0.35 + lv*0.125)','1 + (k*0.35 + lv*0.125)','1 + (k*0.35 + lv*0.125)','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','0','0'),(55709,7,'Anti-Magic','PASSIVE',0,'BANYA','RESIST_MAGIC_REDUCTION','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55709,8,'Haste','PASSIVE',0,'CHEONRYEONG','CASTING_SPEED','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','0','0'),(55709,9,'Drill','PASSIVE',0,'CHOEHOENBIMU','PENETRATE_PCT','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55709,10,'Restoration','AUTO',480,'HEAL','','700 + (k*220.5 + lv*78.75)','700 + (k*220.5 + lv*78.75)','700 + (k*220.5 + lv*78.75)','700 + (k*220.5 + lv*78.75)','700 + (k*220.5 + lv*78.75)','700 + (k*220.5 + lv*78.75)','700 + (k*220.5 + lv*78.75)','700 + (k*220.5 + lv*78.75)','58','0'),(55709,11,'Vampirism','PASSIVE',0,'STEALHP','STEAL_HP','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55709,12,'Spiritualism','PASSIVE',0,'STEALMP','STEAL_SP','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55709,13,'Bulwark','PASSIVE',0,'BLOCK','BLOCK','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55709,14,'Reflection','PASSIVE',0,'REFLECT_MELEE','REFLECT_MELEE','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','0','0'),(55709,15,'Yang Drop','PASSIVE',0,'GOLD_DROP','GOLD_DOUBLE_BONUS','10.8 + (k*3.402 + lv*1.215)','10.8 + (k*3.402 + lv*1.215)','11.2 + (k*3.528 + lv*1.26)','11.2 + (k*3.528 + lv*1.26)','11.6 + (k*3.654 + lv*1.305)','11.6 + (k*3.654 + lv*1.305)','11.6 + (k*3.654 + lv*1.305)','11.6 + (k*3.654 + lv*1.305)','0','0'),(55709,16,'Range','PASSIVE',0,'BOW_DISTANCE','BOW_DISTANCE','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','0','0'),(55709,17,'Immortal','AUTO',600,'INVINCIBILITY','','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','53','0'),(55709,18,'Panacea','AUTO',480,'REMOVAL','','0','0','0','0','0','0','0','0','41','0'),(55709,19,'Master Brewer','PASSIVE',0,'POTION','POTION_BONUS','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55709,20,'Monster Hunter','PASSIVE',0,'MOB_BONUS','ATTBONUS_MONSTER','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55709,21,'Eagle Eyes','PASSIVE',0,'EXP','EXP_DOUBLE_BONUS','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','0','0'),(55709,22,'Life Drain','PASSIVE',0,'HP_RECOVER','KILL_HP_RECOVERY','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','0','0'),(55709,23,'Light as a Feather','AUTO',180,'FEATHER','','187.5 + (k*6.5625 + lv*2.34375)','187.5 + (k*6.5625 + lv*2.34375)','287.5 + (k*10.0625 + lv*3.59375)','287.5 + (k*10.0625 + lv*3.59375)','287.5 + (k*10.0625 + lv*3.59375)','387.5 + (k*13.5625 + lv*4.84375)','387.5 + (k*13.5625 + lv*4.84375)','387.5 + (k*13.5625 + lv*4.84375)','44+ (k*0.455 + lv*0.1625)','50 + (k*2.8 + lv*1)'),(55710,1,'Resistance (Warrior)','PASSIVE',0,'JIJOONG_WARRIOR','RESIST_WARRIOR','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55710,2,'Resistance (Sura)','PASSIVE',0,'JIJOONG_SURA','RESIST_SURA','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55710,3,'Resistance (Ninja)','PASSIVE',0,'JIJOONG_ASSASSIN','RESIST_ASSASSIN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55710,4,'Resistance (Shaman)','PASSIVE',0,'JIJOONG_SHAMAN','RESIST_SHAMAN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55710,5,'Resistance (Lycan)','PASSIVE',0,'JIJOONG_WOLFMAN','RESIST_WOLFMAN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55710,6,'Berserker','PASSIVE',0,'PACHEON','MELEE_MAGIC_ATT_BONUS_PER','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55710,7,'Anti-Magic','PASSIVE',0,'BANYA','RESIST_MAGIC_REDUCTION','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','0','0'),(55710,8,'Haste','PASSIVE',0,'CHEONRYEONG','CASTING_SPEED','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','0','0'),(55710,9,'Drill','PASSIVE',0,'CHOEHOENBIMU','PENETRATE_PCT','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55710,10,'Restoration','AUTO',360,'HEAL','','713.3 + (k*224.689 + lv*80.2463)','713.3 + (k*224.689 + lv*80.2463)','720 + (k*226.8 + lv*81)','720 + (k*226.8 + lv*81)','733.3 + (k*230.99 + lv*82.4963)','720 + (k*226.8 + lv*81)','733.3 + (k*230.99 + lv*82.4963)','720 + (k*226.8 + lv*81)','70+ (k*0.455 + lv*0.1625)','0'),(55710,11,'Vampirism','PASSIVE',0,'STEALHP','STEAL_HP','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55710,12,'Spiritualism','PASSIVE',0,'STEALMP','STEAL_SP','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55710,13,'Bulwark','PASSIVE',0,'BLOCK','BLOCK','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55710,14,'Reflection','PASSIVE',0,'REFLECT_MELEE','REFLECT_MELEE','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55710,15,'Yang Drop','PASSIVE',0,'GOLD_DROP','GOLD_DOUBLE_BONUS','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','10.6 + (k*3.339 + lv*1.1925)','0','0'),(55710,16,'Range','PASSIVE',0,'BOW_DISTANCE','BOW_DISTANCE','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55710,17,'Immortal','AUTO',450,'INVINCIBILITY','','10 + (k*0.63 + lv*0.225)','10 + (k*0.63 + lv*0.225)','10 + (k*0.665 + lv*0.2375)','10 + (k*0.665 + lv*0.2375)','10 + (k*0.7 + lv*0.25)','10 + (k*0.7 + lv*0.25)','10 + (k*0.7 + lv*0.25)','10 + (k*0.7 + lv*0.25)','300+ (k*0.455 + lv*0.1625)','0'),(55710,18,'Panacea','AUTO',360,'REMOVAL','','0','0','0','0','0','0','0','0','70+ (k*0.455 + lv*0.1625)','0'),(55710,19,'Master Brewer','PASSIVE',0,'POTION','POTION_BONUS','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55710,20,'Monster Hunter','PASSIVE',0,'MOB_BONUS','ATTBONUS_MONSTER','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','1 + (k*0.525 + lv*0.1775)','0','0'),(55710,21,'Eagle Eyes','PASSIVE',0,'EXP','EXP_DOUBLE_BONUS','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','1 + (k*0.900 + lv*0.2505)','0','0'),(55710,22,'Life Drain','PASSIVE',0,'HP_RECOVER','KILL_HP_RECOVERY','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55710,23,'Light as a Feather','AUTO',180,'FEATHER','','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','150 + (k*5.25 + lv*1.875)','44+ (k*0.455 + lv*0.1625)','50 + (k*2.8 + lv*1)'),(55711,1,'Resistance (Warrior)','PASSIVE',0,'JIJOONG_WARRIOR','RESIST_WARRIOR','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55711,2,'Resistance (Sura)','PASSIVE',0,'JIJOONG_SURA','RESIST_SURA','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55711,3,'Resistance (Ninja)','PASSIVE',0,'JIJOONG_ASSASSIN','RESIST_ASSASSIN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55711,4,'Resistance (Shaman)','PASSIVE',0,'JIJOONG_SHAMAN','RESIST_SHAMAN','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55711,5,'Resistance (Lycan)','PASSIVE',0,'JIJOONG_WOLFMAN','RESIST_WOLFMAN','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.455 + lv*0.1625)','1 + (k*0.455 + lv*0.1625)','1 + (k*0.455 + lv*0.1625)','1 + (k*0.455 + lv*0.1625)','0','0'),(55711,6,'Berserker','PASSIVE',0,'PACHEON','MELEE_MAGIC_ATT_BONUS_PER','1 + (k*0.35 + lv*0.125)','1 + (k*0.35 + lv*0.125)','1 + (k*0.35 + lv*0.125)','1 + (k*0.35 + lv*0.125)','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','1 + (k*0.42 + lv*0.15)','0','0'),(55711,7,'Anti-Magic','PASSIVE',0,'BANYA','RESIST_MAGIC_REDUCTION','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','300+ (k*0.455 + lv*0.1625)','0'),(55711,8,'Haste','PASSIVE',0,'CHEONRYEONG','CASTING_SPEED','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','1 + (k*0.595 + lv*0.2125)','30+ (k*0.455 + lv*0.1625)','0'),(55711,9,'Drill','PASSIVE',0,'CHOEHOENBIMU','PENETRATE_PCT','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55711,10,'Restoration','AUTO',480,'HEAL','','700 + (k*220.5 + lv*78.75)','700 + (k*220.5 + lv*78.75)','700 + (k*220.5 + lv*78.75)','700 + (k*220.5 + lv*78.75)','700 + (k*220.5 + lv*78.75)','700 + (k*220.5 + lv*78.75)','700 + (k*220.5 + lv*78.75)','700 + (k*220.5 + lv*78.75)','0','0'),(55711,11,'Vampirism','PASSIVE',0,'STEALHP','STEAL_HP','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55711,12,'Spiritualism','PASSIVE',0,'STEALMP','STEAL_SP','1 + (k*0.21 + lv*0.075)','1 + (k*0.21 + lv*0.075)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55711,13,'Bulwark','PASSIVE',0,'BLOCK','BLOCK','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','1 + (k*0.385 + lv*0.1375)','0','0'),(55711,14,'Reflection','PASSIVE',0,'REFLECT_MELEE','REFLECT_MELEE','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','0','0'),(55711,15,'Yang Drop','PASSIVE',0,'GOLD_DROP','GOLD_DOUBLE_BONUS','10.8 + (k*3.402 + lv*1.215)','10.8 + (k*3.402 + lv*1.215)','11.2 + (k*3.528 + lv*1.26)','11.2 + (k*3.528 + lv*1.26)','11.6 + (k*3.654 + lv*1.305)','11.6 + (k*3.654 + lv*1.305)','11.6 + (k*3.654 + lv*1.305)','11.6 + (k*3.654 + lv*1.305)','0','0'),(55711,16,'Range','PASSIVE',0,'BOW_DISTANCE','BOW_DISTANCE','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','0','0'),(55711,17,'Immortal','AUTO',600,'INVINCIBILITY','','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','10 + (k*0.595 + lv*0.2125)','53','0'),(55711,18,'Panacea','AUTO',480,'REMOVAL','','0','0','0','0','0','0','0','0','41','0'),(55711,19,'Master Brewer','PASSIVE',0,'POTION','POTION_BONUS','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','1 + (k*0.315 + lv*0.1125)','0','0'),(55711,20,'Monster Hunter','PASSIVE',0,'MOB_BONUS','ATTBONUS_MONSTER','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','1 + (k*0.245 + lv*0.0875)','0','0'),(55711,21,'Eagle Eyes','PASSIVE',0,'EXP','EXP_DOUBLE_BONUS','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','0','0'),(55711,22,'Life Drain','PASSIVE',0,'HP_RECOVER','KILL_HP_RECOVERY','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','1 + (k*0.175 + lv*0.0625)','0','0'),(55711,23,'Light as a Feather','AUTO',180,'FEATHER','','187.5 + (k*6.5625 + lv*2.34375)','187.5 + (k*6.5625 + lv*2.34375)','287.5 + (k*10.0625 + lv*3.59375)','287.5 + (k*10.0625 + lv*3.59375)','287.5 + (k*10.0625 + lv*3.59375)','387.5 + (k*13.5625 + lv*4.84375)','387.5 + (k*13.5625 + lv*4.84375)','387.5 + (k*13.5625 + lv*4.84375)','44+ (k*0.455 + lv*0.1625)','50 + (k*2.8 + lv*1)');
-/*!40000 ALTER TABLE `growth_pet_skill_proto` ENABLE KEYS */;
-UNLOCK TABLES;
 
 --
 -- Table structure for table `guild`
@@ -4435,7 +4353,7 @@
 
 LOCK TABLES `skill_proto` WRITE;
 /*!40000 ALTER TABLE `skill_proto` DISABLE KEYS */;
-INSERT INTO `skill_proto` VALUES (1,_binary '￬\',1,1,1,0,'HP','-(1.1*atk+(0.5*atk+1.5*str)*k)','40+100*k','','','12','-(1.1*atk+(0.5*atk+1.5*str)*k)','','ATTACK,USE_MELEE_DAMAGE','','NONE','','','','','','','40+100*k',0,0,'MELEE',5,'1',0,200),(2,_binary '\ȹ\ǳ\',1,1,1,0,'HP','-(3*atk+(0.8*atk+str*5+dex*3+con)*k)','50+130*k','','','15','-(3*atk+(0.8*atk+str*5+dex*3+con)*k)','','ATTACK,USE_MELEE_DAMAGE','','NONE','','','','','','','50+130*k',0,0,'MELEE',12,'1',0,200),(3,_binary '\ȥ',1,1,1,0,'ATT_SPEED','50*k','50+140*k','60+90*k','','63+90*k','50*k','','SELFONLY','JEONGWIHON','MOV_SPEED','20*k','60+90*k','','','','','50+140*k',0,0,'NORMAL',1,'1',0,0),(4,_binary '˰\',1,1,1,0,'ATT_GRADE','(100+str+lv*3)*k','100+200*k','30+50*k','','33+50*k','(100+str+lv*3)*k','','SELFONLY','GEOMGYEONG','NONE','','','','','','','100+200*k',0,0,'NORMAL',1,'1',0,0),(5,_binary 'źȯ\',1,1,1,0,'HP','-(2*atk+(atk+dex*3+str*7+con)*k)','60+120*k','','','12','-(2*atk+(atk+dex*3+str*7+con)*k)','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH','','MOV_SPEED','150','3','','','','','60+120*k',0,0,'MELEE',4,'1',0,200),(6,_binary '\\\\\\',1,1,1,0,'HP','-(3*atk+(atk+1.5*str)*k)*1.07','300+150*k','','','60','-(3*atk+(atk+1.5*str)*k)*1.07','','ATTACK,USE_MELEE_DAMAGE','','NONE','','','','','','','300+150*k',0,0,'MELEE',5,'1',0,0),(16,_binary '\\',1,1,1,0,'HP','-(2.3*atk+(4*atk+str*4+con)*k)','60+120*k','','','15','-(2.3*atk+(4*atk+str*4+con)*k)','','ATTACK,USE_MELEE_DAMAGE','','NONE','','','','','','','60+120*k',0,0,'MELEE',4,'1',0,100),(17,_binary 'ݻ\Ÿ\',1,1,1,0,'HP','-(2.3*atk+(3*atk+str*4+con*3)*k)','60+150*k','','','15','-(2.3*atk+(3*atk+str*4+con*3)*k)','','ATTACK,USE_MELEE_DAMAGE','','NONE','','','','','','','60+150*k',0,0,'MELEE',8,'1',0,200),(18,_binary '\',1,1,1,0,'HP','-(2*atk+(2*atk+2*dex+2*con+str*4)*k)','50+140*k','','','25','-(2*atk+(2*atk+2*dex+2*con+str*4)*k)','','ATTACK,USE_MELEE_DAMAGE,SELFONLY,SPLASH,ATTACK_STUN','','NONE','100+k*1000/6','2','','','','','50+140*k',0,0,'MELEE',10,'1',0,400),(19,_binary 'õ\\\',1,1,1,0,'DEF_GRADE','(200+str*0.2+con*0.5)*k','80+220*k','60+90*k','','63+90*k','(200+str*0.2+con*0.5)*k','','SELFONLY','CHEONGEUN','MOV_SPEED','-(1+9*k)','60+90*k','','','','','80+220*k',0,0,'NORMAL',1,'1',0,0),(20,_binary '\ǳ',1,1,1,0,'HP','-(2*atk+(atk+dex*3+str*5+con)*k)','40+120*k','','','20','-(2*atk+(atk+dex*3+str*5+con)*k)','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH','','NONE','','','','','','','40+120*k',0,0,'MELEE',10,'1',1200,200),(21,_binary '˵',1,1,1,0,'HP','-(2*atk+(2*atk+2*dex+2*con+str*4)*k)*1.1','300+180*k','','','60','-(2*atk+(2*atk+2*dex+2*con+str*4)*k)*1.1','','ATTACK,USE_MELEE_DAMAGE','','NONE','','','','','','','300+180*k',0,0,'MELEE',10,'1',0,400),(31,_binary 'Ͻ',2,1,1,0,'HP','-(atk+(1.2*atk+number(500,700)+dex*4+str*4)*k)','40+160*k','','','15','-(atk+(1.2*atk+number(500,700)+dex*4+str*4)*k)','','ATTACK,USE_MELEE_DAMAGE','','NONE','','','','','','','40+160*k',0,0,'MELEE',6,'1',0,0),(32,_binary 'ý\ź',2,1,1,0,'HP','-(atk+(1.6*atk+number(200,300)+dex*7+str*7)*k)','40+160*k','','','20','-(atk+(1.6*atk+number(200,300)+dex*7+str*7)*k)','','ATTACK,USE_MELEE_DAMAGE','','NONE','','','','','','','40+160*k',0,0,'MELEE',6,'1',800,0),(33,_binary '\\\',2,1,1,0,'HP','-(2*atk+(0.5*atk+dex*9+str*7)*k)','50+140*k','','','25','-(2*atk+(0.5*atk+dex*9+str*7)*k)','','ATTACK,USE_MELEE_DAMAGE,ATTACK_POISON','','NONE','40*k','','','','','','50+140*k',0,0,'MELEE',12,'1',0,0),(34,_binary '\',2,1,1,0,'NONE','','30+60*k','15+30*k','','60','','','SELFONLY','EUNHYUNG','NONE','','','','','','','30+60*k',0,0,'NORMAL',1,'1',0,0),(35,_binary '\\',2,1,1,0,'HP','-(lv*2+(atk+str*3+dex*18)*k)','40+130*k','','','25','-(lv*2+(atk+str*3+dex*18)*k)','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_POISON','','NONE','60*k','5+25*k','','','','','40+130*k',0,0,'MELEE',12,'1',800,200),(36,_binary '\漶\',2,1,1,0,'HP','-((lv*2+(atk+str*3+dex*18)*k)*1.1)','300+180*k','','','60','-((lv*2+(atk+str*3+dex*18)*k)*1.1)','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_POISON','','NONE','60*k','5+25*k','','','','','300+180*k',0,0,'MELEE',6,'1',800,300),(46,_binary '\',2,1,1,0,'HP','-(atk+0.2*atk*floor(2+k*6)+(0.8*atk+dex*8*ar+iq*2)*k)','40+160*k','','','10','-(atk+0.2*atk*floor(2+k*6)+(0.8*atk+dex*8*ar+iq*2)*k)','','ATTACK,USE_ARROW_DAMAGE,KNOCKBACK','','NONE','','','','','','','40+160*k',0,0,'RANGE',1,'1',2500,0),(47,_binary 'ݼ',2,1,1,0,'HP','-(atk+(1.7*atk+dex*5+str)*k)','30+150*k','','','15','-(atk+(1.7*atk+dex*5+str)*k)','','ATTACK,SPLASH,USE_ARROW_DAMAGE,ATTACK_SLOW','','NONE','50+dex*6*k','1+iq*0.4*k*0.1','','','','','30+150*k',0,0,'RANGE',8,'0.6',2500,200),(48,_binary 'ȭ\\',2,1,1,0,'HP','-(1.5*atk+(2.6*atk+0.9*iq+number(100,300))*k)','30+160*k','','','15','-(1.5*atk+(2.6*atk+0.9*iq+number(100,300))*k)','','ATTACK,SPLASH,USE_ARROW_DAMAGE,ATTACK_FIRE_CONT','','NONE','lv+5*iq*k','(350+iq*4*k)/10','','','','','30+160*k',0,0,'RANGE',12,'1',2500,300),(49,_binary '\',2,1,1,0,'MOV_SPEED','60*k','60+220*k','3+(90*k)/10','','4+8*k','60*k','','SELFONLY','GYEONGGONG','NONE','(Lv*2+(3*dex+number(100,300))+str*2+iq*2)*k)','','','','','','60+220*k',0,0,'NORMAL',1,'1',0,200),(50,_binary '\\',2,1,1,0,'HP','-(atk+(1.4*atk+number(100,200)+dex*7+str*4+iq*4)*k)','40+160*k','','','18','-(atk+(1.4*atk+number(100,200)+dex*7+str*4+iq*4)*k)','','ATTACK,SPLASH,USE_ARROW_DAMAGE,CRUSH,ATTACK_POISON','','NONE','(50+dex*6*k)/10','15+30*k','','','','','40+160*k',0,0,'RANGE',12,'1',2500,600),(51,_binary 'ź',2,1,1,0,'HP','-((atk+(1.2*atk+number(100,200)+dex*6+str*3+iq*3)*k)*1.2)','200+200*k','1+iq*0.4*k*0.1','','60','-((atk+(1.2*atk+number(100,200)+dex*6+str*3+iq*3)*k)*1.2)','','ATTACK,SPLASH,USE_ARROW_DAMAGE,CRUSH,ATTACK_POISON','','NONE','(50+dex*6*k)/10','15+30*k','','','','','200+200*k',0,0,'RANGE',5,'1',0,400),(61,_binary '\\\',3,1,1,0,'HP','-(atk+2*lv+iq*2+(2*atk+str*4+iq*14)*k)','30+140*k','','','10','-(atk+2*lv+iq*2+(2*atk+str*4+iq*14)*k)','','ATTACK,USE_MELEE_DAMAGE,PENETRATE','','NONE','1+k*9','','','','','','30+140*k',0,0,'MELEE',4,'1',0,0),(62,_binary '\\\\',3,1,1,0,'HP','-(1.1*atk+2*lv+iq*2+(1.5*atk+str+iq*12)*k)','50+150*k','','','15','-(1.1*atk+2*lv+iq*2+(1.5*atk+str+iq*12)*k)','','ATTACK,USE_MELEE_DAMAGE,SELFONLY,SPLASH,IGNORE_TARGET_RATING','','NONE','1+k*9','','','','','','50+150*k',0,0,'MELEE',12,'1',0,500),(63,_binary 'Ͱ\',3,1,1,0,'ATT_GRADE','(3*iq+2*lv)*k','20+240*k','50+100*k','2+23*k','0','(3*iq+2*lv)*k','','SELFONLY,TOGGLE','GWIGUM','HIT_HP_RECOVER','10*k','50+100*k','','','','','20+240*k',0,0,'NORMAL',1,'1',0,0),(64,_binary '\\',3,1,1,0,'DODGE','1+29*k','60+120*k','60+100*k','','100','1+29*k','','SELFONLY','TERROR','NONE','','','','','','','60+120*k',0,0,'NORMAL',1,'1',0,0),(65,_binary 'ָ',3,1,1,0,'DEF_GRADE','(iq+30)*k','70+170*k','30+120*k','','33+140*k','(iq+30)*k','','SELFONLY','JUMAGAP','REFLECT_MELEE','(iq/4+10)*k','30+120*k','','','','','70+170*k',0,0,'NORMAL',1,'1',0,0),(66,_binary '\Ĺ',3,1,1,0,'HP','-(40+5*lv+2*iq+(10*iq+7*mwep+number(50,1))*ar*k)','30+120*k','','','12','-(40+5*lv+2*iq+(10*iq+7*mwep+number(50,1))*ar*k)','','ATTACK,COMPUTE_MAGIC_DAMAGE,SPLASH,REMOVE_GOOD_AFFECT','','NONE','10+40*k','7+23*k','','','','','30+120*k',0,0,'NORMAL',5,'1',1800,200),(76,_binary '\',3,1,1,0,'HP','-(40+5*lv+2*iq+(13*iq+6*mwep+number(50,1))*ar*k)','30+140*k','','','7','-(40+5*lv+2*iq+(13*iq+6*mwep+number(50,1))*ar*k)','','ATTACK,COMPUTE_MAGIC_DAMAGE,SPLASH','','NONE','','','','','','','30+140*k',0,0,'MAGIC',5,'1',1500,200),(77,_binary 'ȭ\',3,1,1,0,'HP','-(5*lv+2*iq+(10*iq+6*mwep+str*4+con*2+number(180,2))*k)','60+140*k','','','12','-(5*lv+2*iq+(10*iq+6*mwep+str*4+con*2+number(180,2))*k)','','ATTACK,SELFONLY,COMPUTE_MAGIC_DAMAGE,SPLASH','','NONE','','','','','','','60+140*k',0,0,'MAGIC',15,'0.8',0,500),(78,_binary '',3,1,1,0,'HP','-(30+2*lv+2*iq+(7*iq+6*mwep+number(200,5))*ar*k)','20+30*k','40+30*k','5+40*k','43+30*k','-(30+2*lv+2*iq+(7*iq+6*mwep+number(200,5))*ar*k)','','ATTACK,COMPUTE_MAGIC_DAMAGE,SPLASH,TOGGLE','','NONE','','','','','','','20+30*k',0,0,'MAGIC',1,'1',800,100),(79,_binary '\\ż\ȣ',3,1,1,0,'DEF_GRADE','(0.5*iq+15)*k','20+30*k','60+120*k','5+10*k','63+120*k','(0.5*iq+15)*k','','SELFONLY,TOGGLE','MANASHIELD','MANASHIELD','100-((iq*0.84)*k)','60+120*k','','','','','20+30*k',0,0,'MAGIC',1,'1',0,0),(80,_binary '\\Ӹ\',3,1,1,0,'HP','-(40+2*lv+2*iq+(2*con+2*dex+13*iq+6*mwep+number(180,2))*ar*k)','40+120*k','','','12','-(40+2*lv+2*iq+(2*con+2*dex+13*iq+6*mwep+number(180,2))*ar*k)','','ATTACK,COMPUTE_MAGIC_DAMAGE,SPLASH,ATTACK_SLOW','','NONE','333+300*k','10+10*k','','','','','40+120*k',0,0,'MAGIC',9,'1',1200,400),(81,_binary 'ȯ\',3,1,1,0,'HP','-(120+6*lv+(5*con+5*dex+29*iq+9*mwep)*ar*k)','80+220*k','','','24','-(120+6*lv+(5*con+5*dex+29*iq+9*mwep)*ar*k)','','ATTACK,COMPUTE_MAGIC_DAMAGE,SPLASH','','NONE','','','','','','','80+220*k',0,0,'MAGIC',9,'1',1500,200),(91,_binary '\\ĺ\',4,1,1,0,'HP','-(70+5*lv+(18*iq+str*7+5*mwep+50)*ar*k)','30+200*k','','','9','-(70+5*lv+(18*iq+str*7+5*mwep+50)*ar*k)','','ATTACK,COMPUTE_MAGIC_DAMAGE,SPLASH,ATTACK_SLOW','','NONE','3+iq*7*k','1+dex*0.4*k*0.1','','','','','30+200*k',0,0,'MAGIC',5,'1',1800,400),(92,_binary '\\Ļ\',4,1,1,0,'HP','-(60+5*lv+(16*iq+dex*6+6*mwep+120)*ar*k)','50+280*k','','','10','-(60+5*lv+(16*iq+dex*6+6*mwep+120)*ar*k)','','ATTACK,ATTACK_FIRE_CONT,KNOCKBACK','','NONE','lv+5*iq*k','(100+iq*5*k)/10','','','','','50+280*k',0,0,'MAGIC',10,'1',800,0),(93,_binary '\з\\',4,1,1,0,'HP','-(70+3*lv+(20*iq+str*3+10*mwep+100)*ar*k)','70+380*k','','','12','-(70+3*lv+(20*iq+str*3+10*mwep+100)*ar*k)','','ATTACK,SPLASH,ATTACK_FIRE_CONT','','NONE','lv+5*iq*k','(100+iq*5*k)/10','','','','','70+380*k',0,0,'MAGIC',15,'1',2500,500),(94,_binary 'ȣ\',4,1,1,0,'RESIST_NORMAL','((iq*0.3+5)*(2*k+0.5)+(dex*0.3))/(k+2.3)','40+190*k','50+80*k','','10','((iq*0.3+5)*(2*k+0.5)+(dex*0.3))/(k+2.3)','','PARTY','HOSIN','NONE','','','','','','','40+190*k',0,0,'NORMAL',1,'1',2000,0),(95,_binary 'ݻ\',4,1,1,0,'REFLECT_MELEE','5+(iq*0.2+str*0.1)*k','60+120*(k+k)','60+200*k','','10','5+(iq*0.2+str*0.1)*k','','PARTY','BOHO','NONE','','','','','','','60+120*(k+k)',0,0,'NORMAL',1,'1',2000,0),(96,_binary '\õ\',4,1,1,0,'CRITICAL','(iq*0.3+5)*(2*k)/(k+3)','50+180*k','60+100*k','','10','(iq*0.3+5)*(2*k)/(k+3)','','PARTY','GICHEON','NONE','','','','','','','50+180*k',0,0,'NORMAL',1,'1',2000,0),(106,_binary '\',4,1,1,0,'HP','-(60+5*lv+(8*iq+dex*2+8*mwep+number(iq*5,iq*15))*ar*k)','30+200*k','','','8','-(60+5*lv+(8*iq+dex*2+8*mwep+number(iq*5,iq*15))*ar*k)','','ATTACK,SPLASH','','NONE','','','','','','','30+200*k',0,0,'MAGIC',5,'1',1800,400),(107,_binary '\',4,1,1,0,'HP','-(40+4*lv+(13*iq+str*2+10*mwep+number(iq*5,iq*16))*ar*k)','50+300*k','','','10','-(40+4*lv+(13*iq+str*2+10*mwep+number(iq*5,iq*16))*ar*k)','','ATTACK,SPLASH,ATTACK_STUN','','NONE','30+70*2*k','1+str*0.2*k*0.1','','','','','50+300*k',0,0,'MAGIC',15,'1',1500,400),(108,_binary '\ڰ\',4,1,1,0,'HP','-(50+5*lv+(8*iq+str*2+8*mwep+number(1,800))*ar*k)*(1-chain*0.13)','40+200*k','','','9','-(50+5*lv+(8*iq+str*2+8*mwep+number(1,800))*ar*k)*(1-chain*0.13)','','ATTACK,SPLASH,ATTACK_SLOW','','NONE','80+iq*5*k','1+str*0.4*k*0.1','','','','','40+200*k',0,0,'MAGIC',7,'1',2500,100),(109,_binary '\\',4,1,1,0,'HP','150+5*lv+(10*iq+6*mwep+number(600,800))*(k+0.15)','40+250*k','','','10','150+5*lv+(10*iq+6*mwep+number(600,800))*(k+0.15)','','REMOVE_BAD_AFFECT,PARTY','','NONE','20+80*k','0','','','','','40+250*k',0,0,'NORMAL',1,'1',1000,0),(110,_binary '\\\',4,1,1,0,'MOV_SPEED','(dex*0.2)+35*k','60+120*k','60+100*k','','10','(dex*0.2)+35*k','','PARTY','KWAESOK','CASTING_SPEED','3+33*k','60+100*k','','','','','60+120*k',0,0,'NORMAL',1,'1',2000,0),(111,_binary '\¼',4,1,1,0,'ATT_GRADE','3+(iq*0.2+str*0.1+11)*k','60+150*k','60+100*k','','10','3+(iq*0.2+str*0.1+11)*k','','PARTY','JEUNGRYEOK','NONE','','','','','','','60+150*k',0,0,'NORMAL',1,'1',2000,0),(121,_binary '\\ַ\',0,1,40,0,'NONE','','','','','','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(122,_binary '\\',0,1,2,0,'NONE','','','','','','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(124,_binary 'ä',0,1,40,0,'NONE','','','','','','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(125,_binary '\',0,1,40,0,'NONE','','','10+1000*k','','','','','','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(126,_binary 'ż\\',0,1,20,0,'NONE','','','','','','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(127,_binary 'õ\',0,1,20,0,'NONE','','','','','','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(128,_binary '\\',0,1,20,0,'NONE','','','','','','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(129,_binary 'а',0,1,40,0,'NONE','','','','','','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(130,_binary '¸',0,1,1,0,'NONE','','','','','','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(131,_binary '\ȯ',0,1,10,0,'NONE','','','','','','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(132,_binary 'AutoAttack',0,0,0,0,'NONE','','','','','','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(133,_binary 'RoleProficiency',0,1,40,0,'NONE','','','','','','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(134,_binary 'InSight',0,1,40,0,'NONE','','','','','','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(137,_binary '',5,1,1,50,'HP','-(atk+(2*atk*k))','60+80*k','','','5-(4*k)','-(atk+(2*atk*k))','','ATTACK,USE_MELEE_DAMAGE,CRUSH','','NONE','','','','','','','60+80*k',0,0,'MELEE',10,'1',300,0),(138,_binary '\',5,1,1,52,'HP','-(2.4*(200+1.5*lv)+(3*200*k))','60+120*k','','','15','-(2.4*(200+1.5*lv)+(3*200*k))','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH_LONG','','MOV_SPEED','50','5','','','','','60+120*k',0,0,'MELEE',6,'1',400,100),(139,_binary 'Ż\\',5,1,1,55,'HP','-(2*(200+1.5*lv)+(3*200*k))','60+160*k','','','20','-(2*(200+1.5*lv)+(3*200*k))','','ATTACK,USE_MELEE_DAMAGE,SELFONLY,SPLASH,CRUSH','','NONE','','','','','','','60+160*k',0,0,'MELEE',12,'1',400,250),(140,_binary '(Ȱ)',5,1,1,50,'HP','-(atk+(2*atk*k))','60+80*k','','','10','-(atk+(2*atk*k))','','ATTACK,USE_ARROW_DAMAGE,CRUSH','','NONE','','','','','','','60+80*k',0,0,'RANGE',5,'1',2500,0),(151,_binary '\\',0,1,7,0,'NONE','','','','','','','','','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(152,_binary '\\\\\',0,1,7,0,'MAX_HP','maxhp*0.2*k','150+150*k','300','','600','maxhp*0.2*k','','','','NONE','','','','','','','150+150*k',0,0,'NORMAL',0,'1',0,0),(153,_binary '\\\\ູ',0,1,7,0,'MAX_SP','maxsp*0.2*k','150+150*k','300','','600','maxsp*0.2*k','','','','NONE','','','','','','','150+150*k',0,0,'NORMAL',0,'1',0,0),(154,_binary '\ְ',0,1,7,0,'DEF_GRADE','odef*0.1*k','150+150*k','180','','480','odef*0.1*k','','','','NONE','','','','','','','150+150*k',0,0,'NORMAL',0,'1',0,0),(155,_binary '\ȭ',0,1,7,0,'MOV_SPEED','15*k','150+150*k','180','','480','15*k','','','','ATT_SPEED','15*k','180','','','','','150+150*k',0,0,'NORMAL',0,'1',0,0),(156,_binary '\\Ǻг\',0,1,7,0,'CRITICAL','50*k','150+150*k','180','','480','50*k','','','','NONE','','','','','','','150+150*k',0,0,'NORMAL',0,'1',0,0),(157,_binary 'ֹ',0,1,7,0,'CASTING_SPEED','50*k','150+150*k','180','','480','50*k','','','','NONE','','','','','','','150+150*k',0,0,'NORMAL',0,'1',0,0),(158,_binary '\\̵',0,1,3,0,'NONE','','','','','','','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(159,_binary 'ǹ',0,1,5,0,'NONE','','','','','','','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(160,_binary '\ȭ',0,1,5,0,'NONE','3*k','80-12*k','300','','','3*k','','SELFONLY','','NONE','','','','','','','80-12*k',0,0,'NORMAL',0,'1',0,0),(161,_binary 'ǹ',0,1,2,0,'NONE','','50','','','','','','','','NONE','','','','','','','50',0,0,'NORMAL',0,'1',0,0),(162,_binary '̵',0,1,2,0,'NONE','','20','','','','','','','','NONE','','','','','','','20',0,0,'NORMAL',0,'1',0,0),(170,_binary '\\',7,1,1,0,'HP','-(1.1*atk+(0.3*atk+1.5*str)*k)','40+100*k','','','12','-(1.1*atk+(0.3*atk+1.5*str)*k)','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_BLEEDING','','NONE','60*k','5+25*k','','','','','40+100*k',0,0,'MELEE',5,'1',300,200),(171,_binary '\ǳ',7,1,1,0,'HP','-(2*atk+(atk+dex*3+str*5+con)*k)','40+120*k','','','20','-(2*atk+(atk+dex*3+str*5+con)*k)','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_STUN,KNOCKBACK','','NONE','30+70*2*k','2','','','','','40+120*k',0,0,'MELEE',10,'1',1000,200),(172,_binary '\\',7,1,1,0,'HP','-(atk+(1.6*atk+200+dex*7+str*7)*k)','40+100*k','','','12','-(atk+(1.6*atk+200+dex*7+str*7)*k)','','ATTACK,USE_MELEE_DAMAGE','','NONE','','','','','','','40+100*k',0,0,'MELEE',5,'1',800,100),(173,_binary '\ļ\',7,1,1,0,'HP','-(3*atk+(0.8*atk+str*6+dex*2+con)*k)','40+100*k','','','12','-(3*atk+(0.8*atk+str*6+dex*2+con)*k)','','ATTACK,USE_MELEE_DAMAGE','','DEF_GRADE','-30*k','5','','','','','40+100*k',0,0,'MELEE',10,'1',800,100),(174,_binary '\',7,1,1,0,'ATT_GRADE','7+(4*iq+13)*k','20+240*k','45+60*k','2+23*k','10+10*k','7+(4*iq+13)*k','','SELFONLY,TOGGLE','RED_POSSESSION','PENETRATE','1+((iq*0.4)*k)*0.24','45+60*k','RED_POSSESSION','','','','20+240*k',0,0,'NORMAL',1,'1',0,0),(175,_binary 'û\',7,1,1,0,'ATT_SPEED','20*k','80+220*k','200','','300','20*k','','PARTY','BLUE_POSSESSION','DODGE','1+10*k','200','','','','','80+220*k',0,0,'NORMAL',1,'1',1000,0),(176,_binary '\ǴϽ',1,1,1,0,'HP','-(3*atk+(0.9*atk+number(1,1000)+str*5+dex*3+lv)*k)','200+200*k','','','35+20*k','-(3*atk+(0.9*atk+number(1,1000)+str*5+dex*3+lv)*k)','','ATTACK,USE_MELEE_DAMAGE,DISABLE_BY_POINT_UP','','HIT_PCT','0.4*k+(32*k/2)','20*k','','','','','200+200*k',0,0,'MELEE',8,'1',0,200),(177,_binary 'ϱǥ',2,1,1,0,'HP','-(atk+(1.7*atk+number(1,1000)+dex*6+lv*5)*k)','200+200*k','','','35+20*k','-(atk+(1.7*atk+number(1,1000)+dex*6+lv*5)*k)','','ATTACK,USE_MELEE_DAMAGE,SPLASH,DISABLE_BY_POINT_UP','','HIT_PCT','0.4*k+(32*k/2)','20*k','','','','','200+200*k',0,0,'MELEE',10,'1',2000,200),(178,_binary 'ǳ\\\',2,1,1,0,'HP','-(1.9*atk+(2.6*atk+number(1,1000))*k)','200+200*k','','','35+20*k','-(1.9*atk+(2.6*atk+number(1,1000))*k)','','ATTACK,SPLASH,USE_ARROW_DAMAGE,DISABLE_BY_POINT_UP','','HIT_PCT','0.4*k+(32*k/2)','20*k','','','','','200+200*k',0,0,'RANGE',8,'1',2500,200),(179,_binary 'Ǳ\',3,1,1,0,'HP','-(1.9*atk+(2.6*atk+number(1,1000))*k)','200+200*k','','','35+20*k','-(1.9*atk+(2.6*atk+number(1,1000))*k)','','ATTACK,USE_MELEE_DAMAGE,DISABLE_BY_POINT_UP','','HIT_PCT','0.4*k+(32*k/2)','20*k','','','','','200+200*k',0,0,'MELEE',4,'1',0,0),(180,_binary '\渶Ǳ\',3,1,1,0,'HP','-(120+6*lv+(5*con+5*dex+30*iq+number(1,1)+9*mwep)*ar*k)','200+200*k','','','35+20*k','-(120+6*lv+(5*con+5*dex+30*iq+number(1,1)+9*mwep)*ar*k)','','ATTACK,COMPUTE_MAGIC_DAMAGE,SPLASH,DISABLE_BY_POINT_UP','','HIT_PCT','0.4*k+(32*k/2)','20*k','','','','','200+200*k',0,0,'MAGIC',5,'1',2000,200),(181,_binary '\\׿',4,1,1,0,'HP','-(120+6*lv+(5*con+5*dex+30*iq+number(1,1)+9*mwep)*ar*k)','200+200*k','','','35+20*k','-(120+6*lv+(5*con+5*dex+30*iq+number(1,1)+9*mwep)*ar*k)','','ATTACK,SPLASH,ATTACK_FIRE_CONT,DISABLE_BY_POINT_UP','','HIT_PCT','0.4*k+(32*k/2)','20*k','','','','','200+200*k',0,0,'MAGIC',5,'1',2000,500),(182,_binary 'õ\',4,1,1,0,'NONE','0.4*k+(18*k)','200+200*k','50+(8*k)','','386+(80*k)','0.4*k+(18*k)','','DISABLE_BY_POINT_UP,PARTY','','NONE','4*k','','','','','','200+200*k',0,0,'NORMAL',1,'1',2000,0),(183,_binary '̸ǳ\',7,1,1,0,'HP','-(1.8*atk+(atk+dex*6+number(1,1000)+str*3+lv)*k)','200+200*k','','','35+20*k','-(1.8*atk+(atk+dex*6+number(1,1000)+str*3+lv)*k)','','ATTACK,USE_MELEE_DAMAGE,DISABLE_BY_POINT_UP','','HIT_PCT','0.4*k+(32*k/2)','20*k','','','','','200+200*k',0,0,'MELEE',8,'1',0,200),(221,_binary '\ȹ\ǳ\\\\\',6,1,1,0,'NONE','24*k','','','','','24*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(222,_binary 'Ͻ\\\\',6,1,1,0,'NONE','24*k','','','','','24*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(223,_binary '\\\\\\\',6,1,1,0,'NONE','24*k','','','','','24*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(224,_binary '\\Ļ\\\\\',6,1,1,0,'NONE','24*k','','','','','24*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(225,_binary '\\\\\\',6,1,1,0,'NONE','24*k','','','','','24*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(226,_binary 'ȭ\\\\\\',6,1,1,0,'NONE','24*k','','','','','24*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(227,_binary '\\\\\',6,1,1,0,'NONE','24*k','','','','','24*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(228,_binary '\\\\\',6,1,1,0,'NONE','24*k','','','','','24*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(229,_binary '\ǳ\\\\',6,1,1,0,'NONE','24*k','','','','','24*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(236,_binary '\ȹ\ǳ찭ȭ',6,1,1,0,'NONE','16*k','','','','','16*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(237,_binary 'Ͻȭ',6,1,1,0,'NONE','16*k','','','','','16*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(238,_binary '\\\ȭ',6,1,1,0,'NONE','16*k','','','','','16*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(239,_binary '\\Ļ갭ȭ',6,1,1,0,'NONE','16*k','','','','','16*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(240,_binary '\\ȭ',6,1,1,0,'NONE','16*k','','','','','16*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(241,_binary 'ȭ\İȭ',6,1,1,0,'NONE','16*k','','','','','16*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(242,_binary 'ɰȭ',6,1,1,0,'NONE','16*k','','','','','16*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(243,_binary '\ȭ',6,1,1,0,'NONE','16*k','','','','','16*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(244,_binary '\ǳȭ',6,1,1,0,'NONE','16*k','','','','','16*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(246,_binary 'hit',0,1,40,0,'NONE','0.4*k+(32*k/2)','','','','','0.4*k+(32*k/2)','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(256,_binary 'CRUSH200ų',0,1,1,0,'HP','-5*k*atk','','','','2','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH','','NONE','','','','','','','',0,0,'MELEE',0,'1',0,300),(257,_binary 'Ϲݹ350ų',0,1,1,0,'HP','-5*k*atk','','','','5','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','NONE','','','','','','','',0,0,'MELEE',0,'1',0,525),(258,_binary 'CRUSH300ų',0,1,1,0,'HP','-5*k*atk','','','','7','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH','','NONE','','','','','','','',0,0,'MELEE',0,'1',0,450),(259,_binary 'Ϲݹ200ų',0,1,1,0,'HP','-5*k*atk','','','','9','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','NONE','','','','','','','',0,0,'MELEE',0,'1',0,300),(260,_binary 'CURSH400ų',0,1,1,0,'HP','-5*k*atk','','','','10','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH','','NONE','','','','','','','',0,0,'MELEE',0,'1',0,600),(261,_binary '250ų',0,1,1,0,'HP','-5*k*atk','','','','9','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_POISON','','NONE','80','','','','','','',0,0,'MELEE',0,'1',0,375),(262,_binary 'SLOW300ų',0,1,1,0,'HP','-5*k*atk','','','','12','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','MOV_SPEED','-20','10','','','','','',0,0,'MELEE',0,'1',0,450),(263,_binary 'SLOW4000ų',0,1,1,0,'HP','-5*k*atk','','','','12','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','MOV_SPEED','-70','3','SLOW','','','','',0,0,'MELEE',0,'1',2000,6000),(264,_binary 'THUNDERų',0,1,1,0,'HP','-maxhp*k','','','','12','-maxhp*k','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH','','NONE','','','','','','','',0,0,'MELEE',0,'1',0,500),(265,_binary 'HEAL4000ų',0,1,1,0,'HP','0.1*maxhp*k','','','','5','0.1*maxhp*k','','PARTY','','NONE','','','','','','','',0,0,'NORMAL',1,'1',3000,0),(266,_binary 'ATTACK_SLOW',0,1,1,0,'NONE','','','','','','','','SELFONLY,SPLASH','','NONE','','','','','','','',0,0,'NORMAL',1,'1',0,3000),(267,_binary 'Ϲ\0ų',0,1,1,0,'HP','-5*k*atk','','','','10','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE','','NONE','','','','','','','',0,0,'MELEE',1,'1',0,0),(268,_binary 'CRUSH0ų',0,1,1,0,'HP','-5*k*atk','','','','10','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,CRUSH','','NONE','','','','','','','',0,0,'MELEE',1,'1',0,0),(269,_binary 'STUN200',0,1,1,0,'HP','-5*k*atk','','','','10','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_STUN','','NONE','1000','3','','','','','',0,0,'MELEE',0,'1',0,300),(270,_binary 'normal_range_attack_confustion',0,1,1,0,'HP','-5*k*atk','','','','5','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','NONE','80*k','','','','','','',0,0,'MELEE',0,'1',0,525),(271,_binary 'knockback_hp_absorb',0,1,1,0,'HP','-5*k*atk','','','','7','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,HP_ABSORB,CRUSH','','NONE','10','','','','','','',0,0,'MELEE',0,'1',0,350),(272,_binary 'knockback_bleeding',0,1,1,0,'HP','-5*k*atk','','','','7','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH,ATTACK_BLEEDING','','NONE','100','','','','','','',0,0,'MELEE',0,'1',0,350),(273,_binary 'wide_area_damage_stun',0,1,1,0,'HP','-maxhp*k','','','','12','-maxhp*k','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_STUN,CRUSH','','NONE','1000','4','','','','','',0,0,'MELEE',0,'1',0,500),(274,_binary 'wide_area_damage_sungma_str',0,1,1,0,'SUNGMA_STR','-40*k','','10','','12','-40*k','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH','','HP','-maxhp*k','0','','','','','',0,0,'MELEE',0,'1',1000,300),(275,_binary 'splash400_bleeding',0,1,1,0,'HP','-5*k*atk','','','','7','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_BLEEDING','','NONE','30','','','','','','',0,0,'MELEE',0,'1',0,400),(276,_binary 'stun300',0,1,1,0,'HP','-5*k*atk','','','','7','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_STUN','','NONE','200','3','','','','','',0,0,'MELEE',0,'1',0,300),(277,_binary 'splash400_poison',0,1,1,0,'HP','-5*k*atk','','','','5','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_POISON','','NONE','10','','','','','','',0,0,'MELEE',0,'1',0,400),(278,_binary 'stun400',0,1,1,0,'HP','-5*k*atk','','','','7','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_STUN','','NONE','200','3','','','','','',0,0,'MELEE',0,'1',0,400),(279,_binary 'maze_keingnoll_boss_skill3',0,1,1,0,'HP','-5*k*atk','','','','20','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,HP_ABSORB','','NONE','50','','','','','','',0,0,'NORMAL',0,'1',0,400),(280,_binary 'posion_damage_sungma_move',0,1,1,1,'HP','-5*k*atk','','','','9','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_POISON','','NONE','80','','','','','','',0,0,'MELEE',0,'1',0,375),(281,_binary 'crush_damage_sungma_str',0,1,1,1,'HP','-5*k*atk','','','','17','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','SUNGMA_STR','-20','10','','','','','',0,0,'MELEE',0,'1',0,375),(282,_binary 'shackle_damage',0,1,1,1,'HP','-5*k*atk','','','','25','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','MOV_SPEED','0','3','','','','','',0,0,'MELEE',0,'1',0,450),(283,_binary 'white_dragon_skill0',0,1,1,0,'HP','-5*k*atk','','','','24','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','NONE','0','0','','','','','',0,0,'MELEE',0,'1',0,300),(284,_binary 'white_dragon_skill2',0,1,1,0,'HP','-5*k*atk','','','','45','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH','','NONE','50','','','','','','',0,0,'MELEE',0,'1',0,900),(285,_binary 'ڵ\(̼\)',8,1,1,0,'MOUNT_UPGRADE_NIMBLE','(4+(horselv*skilllv/100))*(skilllv/3)','','3+(skilllv*(horselv*0.4))/20','','180','(4+(horselv*skilllv/100))*(skilllv/3)','','SELFONLY','','MOV_SPEED','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(286,_binary '\\\ġ',8,1,1,0,'MALL_EXPBONUS','((horselv*skilllv/100)+1.5)+(skilllv/8)','','','','','((horselv*skilllv/100)+1.5)+(skilllv/8)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(287,_binary 'ǳ(\)',8,1,1,0,'MOUNT_UPGRADE_SPEED','(5+(horselv*skilllv/600))*(skilllv/5)','','3+(skilllv*(horselv*0.4))/20','','180','(5+(horselv*skilllv/600))*(skilllv/5)','','SELFONLY','','ATT_SPEED','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(288,_binary '\',8,1,1,0,'NONE','(horselv*(skilllv*number(5,10)))/40*skilllv','','1+(skilllv*(horselv*0.3))/20','','300','(horselv*(skilllv*number(5,10)))/40*skilllv','','','','NONE','(horselv*(skilllv*10))/40*skilllv','','','','','','',0,0,'NORMAL',0,'1',1000,0),(289,_binary '',8,1,1,0,'NONE','','','(horselv*(skilllv*0.3))/60','','600','','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(290,_binary '˹\̹ߵ',8,1,1,0,'MOUNT_UPGRADE_NO_KNOCKBACK','','','3+(skilllv*(horselv*0.5))/20','','180','','','','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(291,_binary '԰\\ΰ',8,1,1,0,'ATTBONUS_HUMAN','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(292,_binary '԰\Ե',8,1,1,0,'ATTBONUS_ANIMAL','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(293,_binary '԰\Կ\\',8,1,1,0,'ATTBONUS_ORC','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(294,_binary '԰\Թб',8,1,1,0,'ATTBONUS_MILGYO','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(295,_binary '԰\Ծ𵥵\',8,1,1,0,'ATTBONUS_UNDEAD','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(296,_binary '԰\ԾǸ',8,1,1,0,'ATTBONUS_DEVIL','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(297,_binary '԰\Խ\\\',8,1,1,0,'ATTBONUS_CZ','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(298,_binary '԰\Ի縷',8,1,1,0,'ATTBONUS_DESERT','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(299,_binary '԰\԰\\\',8,1,1,0,'ATTBONUS_INSECT','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(300,_binary '԰\Ը\\\\\',8,1,1,0,'ATTBONUS_MONSTER','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(301,_binary 'ž\\θ\Ʈȿ\\',8,1,1,0,'NONE','k*(skilllv/(140-horselv))','','','','','k*(skilllv/(140-horselv))','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(302,_binary '\\\\(\)',8,1,1,0,'ATTBONUS_WARRIOR','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(303,_binary '\\\\(ڰ)',8,1,1,0,'ATTBONUS_ASSASSIN','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(304,_binary '\\\\(\\)',8,1,1,0,'ATTBONUS_SURA','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(305,_binary '\\\\(\)',8,1,1,0,'ATTBONUS_SHAMAN','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(306,_binary '\\\\(\\)',8,1,1,0,'ATTBONUS_WOLF','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(307,_binary '\\',8,1,1,0,'MOUNT_UPGRADE_SUNGMA_STR','3+(horselv*skilllv)*(skilllv/500)','','3+(skilllv*(horselv*0.4))/20','','180','3+(horselv*skilllv)*(skilllv/500)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(308,_binary 'ǽ\ü',8,1,1,0,'MOUNT_UPGRADE_SUNGMA_HP','3+(horselv*skilllv)*(skilllv/500)','','3+(skilllv*(horselv*0.4))/20','','180','3+(horselv*skilllv)*(skilllv/500)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(309,_binary '\\׷\',8,1,1,0,'MOUNT_UPGRADE_SUNGMA_MOVE','3+(horselv*skilllv)*(skilllv/500)','','3+(skilllv*(horselv*0.4))/20','','180','3+(horselv*skilllv)*(skilllv/500)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(310,_binary '\\',8,1,1,0,'MOUNT_UPGRADE_SUNGMA_IMMUNE','3+(horselv*skilllv)*(skilllv/500)','','3+(skilllv*(horselv*0.4))/20','','180','3+(horselv*skilllv)*(skilllv/500)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(311,_binary '\\',8,1,1,0,'HIT_PCT','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(312,_binary '\ʻ\\(ų1)',0,1,1,0,'HP','-5*k*atk','','','','7','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,HP_ABSORB','','NONE','20','','','','','','',0,0,'MELEE',1,'1',0,400),(313,_binary '\ʻ\\(ų2)',0,1,1,0,'HP','-15*k*atk','','','','23','-15*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','NONE','','','','','','','',0,0,'MELEE',1,'1',0,1000),(314,_binary '\ʻ\\(ų2)',0,1,1,0,'HP','-5*k*atk','','','','18','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH,ATTACK_BLEEDING','','NONE','30','','','','','','',0,0,'MELEE',0,'1',0,400),(315,_binary '\ʻ\\(ų1)',0,1,1,0,'HP','-5*k*atk','','','','30','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,HP_ABSORB','','NONE','10','','','','','','',0,0,'MELEE',1,'1',0,400),(316,_binary '\ʻ\\(ų2)',0,1,1,0,'HP','-5*k*atk','','','','47','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','NONE','','','','','','','',0,0,'MELEE',1,'1',0,1000),(317,_binary '\\ʻ\\(ų1)',0,1,1,0,'HP','-5*k*atk','','','','7','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_STUN','','NONE','1000','3','','','','','',0,0,'MELEE',1,'1',0,400),(318,_binary '\\ʻ\\(ų2)',0,1,1,0,'HP','-5*k*atk','','','','15','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH','','NONE','','','','','','','',0,0,'MELEE',1,'1',0,400),(319,_binary '\(ų1)',0,1,1,0,'HP','-5*k*atk','','','','6','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','NONE','','','','','','','',0,0,'MELEE',1,'1',0,300),(320,_binary '\(ų2)',0,1,1,0,'HP','-5*k*atk','','','','31','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','NONE','','','','','','','',0,0,'MELEE',0,'1',0,300),(321,_binary '\(ų3)',0,1,1,0,'HP','-5*k*atk','','','','14','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_BLEEDING','','NONE','100','','','','','','',0,0,'MELEE',0,'1',0,1000),(322,_binary 'change_equipment_page',0,0,0,0,'NONE','','','','','3','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(329,_binary '\\(ų1)',0,1,1,0,'HP','-5*k*atk','','','','12','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH','','NONE','','','','','','','',0,0,'MELEE',0,'1',0,1500),(330,_binary '\\(ų2)',0,1,1,0,'HP','-5*k*atk','','','','33','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','NONE','100','','','','','','',0,0,'MELEE',0,'1',0,1200),(331,_binary '\\(ų3)',0,1,1,0,'HP','-5*k*atk','','','','20','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH','','NONE','','','','','','','',0,0,'MELEE',0,'1',0,1500),(332,_binary 'Ƽ\\(ų1)',0,1,1,0,'HP','-5*k*atk','','','','12','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH,ATTACK_POISON','','NONE','10','31','','','','','',0,0,'MELEE',0,'1',0,500),(333,_binary 'Ƽ\\(ų2)',0,1,1,0,'HP','-5*k*atk','','','','17','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_STUN,CRUSH','','NONE','20','3','','','','','',0,0,'MELEE',0,'1',0,300),(334,_binary 'Ƽ\\(ų3)',0,1,1,0,'HP','-5*k*atk','','','','26','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_STUN','','NONE','','','','','','','',0,0,'MELEE',0,'1',0,600);
+INSERT INTO `skill_proto` VALUES (1,_binary '￬\',1,1,1,0,'HP','-(1.1*atk+(0.5*atk+1.5*str)*k)','40+100*k','','','12','-(1.1*atk+(0.5*atk+1.5*str)*k)','','ATTACK,USE_MELEE_DAMAGE','','NONE','','','','','','','40+100*k',0,0,'MELEE',5,'1',0,200),(2,_binary '\ȹ\ǳ\',1,1,1,0,'HP','-(3*atk+(0.8*atk+str*5+dex*3+con)*k)','50+130*k','','','15','-(3*atk+(0.8*atk+str*5+dex*3+con)*k)','','ATTACK,USE_MELEE_DAMAGE','','NONE','','','','','','','50+130*k',0,0,'MELEE',12,'1',0,200),(3,_binary '\ȥ',1,1,1,0,'ATT_SPEED','50*k','50+140*k','60+90*k','','63+90*k','50*k','','SELFONLY','JEONGWIHON','MOV_SPEED','20*k','60+90*k','','','','','50+140*k',0,0,'NORMAL',1,'1',0,0),(4,_binary '˰\',1,1,1,0,'ATT_GRADE','(100+str+lv*3)*k','100+200*k','30+50*k','','33+50*k','(100+str+lv*3)*k','','SELFONLY','GEOMGYEONG','NONE','','','','','','','100+200*k',0,0,'NORMAL',1,'1',0,0),(5,_binary 'źȯ\',1,1,1,0,'HP','-(2*atk+(atk+dex*3+str*7+con)*k)','60+120*k','','','12','-(2*atk+(atk+dex*3+str*7+con)*k)','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH','','MOV_SPEED','150','3','','','','','60+120*k',0,0,'MELEE',4,'1',0,200),(6,_binary '\\\\\\',1,1,1,0,'HP','-(3*atk+(atk+1.5*str)*k)*1.07','300+150*k','','','60','-(3*atk+(atk+1.5*str)*k)*1.07','','ATTACK,USE_MELEE_DAMAGE','','NONE','','','','','','','300+150*k',0,0,'MELEE',5,'1',0,0),(16,_binary '\\',1,1,1,0,'HP','-(2.3*atk+(4*atk+str*4+con)*k)','60+120*k','','','15','-(2.3*atk+(4*atk+str*4+con)*k)','','ATTACK,USE_MELEE_DAMAGE','','NONE','','','','','','','60+120*k',0,0,'MELEE',4,'1',0,100),(17,_binary 'ݻ\Ÿ\',1,1,1,0,'HP','-(2.3*atk+(3*atk+str*4+con*3)*k)','60+150*k','','','15','-(2.3*atk+(3*atk+str*4+con*3)*k)','','ATTACK,USE_MELEE_DAMAGE','','NONE','','','','','','','60+150*k',0,0,'MELEE',8,'1',0,200),(18,_binary '\',1,1,1,0,'HP','-(2*atk+(2*atk+2*dex+2*con+str*4)*k)','50+140*k','','','25','-(2*atk+(2*atk+2*dex+2*con+str*4)*k)','','ATTACK,USE_MELEE_DAMAGE,SELFONLY,SPLASH,ATTACK_STUN','','NONE','100+k*1000/6','2','','','','','50+140*k',0,0,'MELEE',10,'1',0,400),(19,_binary 'õ\\\',1,1,1,0,'DEF_GRADE','(200+str*0.2+con*0.5)*k','80+220*k','60+90*k','','63+90*k','(200+str*0.2+con*0.5)*k','','SELFONLY','CHEONGEUN','MOV_SPEED','-(1+9*k)','60+90*k','','','','','80+220*k',0,0,'NORMAL',1,'1',0,0),(20,_binary '\ǳ',1,1,1,0,'HP','-(2*atk+(atk+dex*3+str*5+con)*k)','40+120*k','','','20','-(2*atk+(atk+dex*3+str*5+con)*k)','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH','','NONE','','','','','','','40+120*k',0,0,'MELEE',10,'1',1200,200),(21,_binary '˵',1,1,1,0,'HP','-(2*atk+(2*atk+2*dex+2*con+str*4)*k)*1.1','300+180*k','','','60','-(2*atk+(2*atk+2*dex+2*con+str*4)*k)*1.1','','ATTACK,USE_MELEE_DAMAGE','','NONE','','','','','','','300+180*k',0,0,'MELEE',10,'1',0,400),(31,_binary 'Ͻ',2,1,1,0,'HP','-(atk+(1.2*atk+number(500,700)+dex*4+str*4)*k)','40+160*k','','','15','-(atk+(1.2*atk+number(500,700)+dex*4+str*4)*k)','','ATTACK,USE_MELEE_DAMAGE','','NONE','','','','','','','40+160*k',0,0,'MELEE',6,'1',0,0),(32,_binary 'ý\ź',2,1,1,0,'HP','-(atk+(1.6*atk+number(200,300)+dex*7+str*7)*k)','40+160*k','','','20','-(atk+(1.6*atk+number(200,300)+dex*7+str*7)*k)','','ATTACK,USE_MELEE_DAMAGE','','NONE','','','','','','','40+160*k',0,0,'MELEE',6,'1',800,0),(33,_binary '\\\',2,1,1,0,'HP','-(2*atk+(0.5*atk+dex*9+str*7)*k)','50+140*k','','','25','-(2*atk+(0.5*atk+dex*9+str*7)*k)','','ATTACK,USE_MELEE_DAMAGE,ATTACK_POISON','','NONE','40*k','','','','','','50+140*k',0,0,'MELEE',12,'1',0,0),(34,_binary '\',2,1,1,0,'NONE','','30+60*k','15+30*k','','60','','','SELFONLY','EUNHYUNG','NONE','','','','','','','30+60*k',0,0,'NORMAL',1,'1',0,0),(35,_binary '\\',2,1,1,0,'HP','-(lv*2+(atk+str*3+dex*18)*k)','40+130*k','','','25','-(lv*2+(atk+str*3+dex*18)*k)','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_POISON','','NONE','60*k','5+25*k','','','','','40+130*k',0,0,'MELEE',12,'1',800,200),(36,_binary '\漶\',2,1,1,0,'HP','-((lv*2+(atk+str*3+dex*18)*k)*1.1)','300+180*k','','','60','-((lv*2+(atk+str*3+dex*18)*k)*1.1)','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_POISON','','NONE','60*k','5+25*k','','','','','300+180*k',0,0,'MELEE',6,'1',800,300),(46,_binary '\',2,1,1,0,'HP','-(atk+0.2*atk*floor(2+k*6)+(0.8*atk+dex*8*ar+iq*2)*k)','40+160*k','','','10','-(atk+0.2*atk*floor(2+k*6)+(0.8*atk+dex*8*ar+iq*2)*k)','','ATTACK,USE_ARROW_DAMAGE,KNOCKBACK','','NONE','','','','','','','40+160*k',0,0,'RANGE',1,'1',2500,0),(47,_binary 'ݼ',2,1,1,0,'HP','-(atk+(1.7*atk+dex*5+str)*k)','30+150*k','','','15','-(atk+(1.7*atk+dex*5+str)*k)','','ATTACK,SPLASH,USE_ARROW_DAMAGE,ATTACK_SLOW','','NONE','50+dex*6*k','1+iq*0.4*k*0.1','','','','','30+150*k',0,0,'RANGE',8,'0.6',2500,200),(48,_binary 'ȭ\\',2,1,1,0,'HP','-(1.5*atk+(2.6*atk+0.9*iq+number(100,300))*k)','30+160*k','','','15','-(1.5*atk+(2.6*atk+0.9*iq+number(100,300))*k)','','ATTACK,SPLASH,USE_ARROW_DAMAGE,ATTACK_FIRE_CONT','','NONE','lv+5*iq*k','(350+iq*4*k)/10','','','','','30+160*k',0,0,'RANGE',12,'1',2500,300),(49,_binary '\',2,1,1,0,'MOV_SPEED','60*k','60+220*k','3+(90*k)/10','','4+8*k','60*k','','SELFONLY','GYEONGGONG','NONE','(Lv*2+(3*dex+number(100,300))+str*2+iq*2)*k)','','','','','','60+220*k',0,0,'NORMAL',1,'1',0,200),(50,_binary '\\',2,1,1,0,'HP','-(atk+(1.4*atk+number(100,200)+dex*7+str*4+iq*4)*k)','40+160*k','','','18','-(atk+(1.4*atk+number(100,200)+dex*7+str*4+iq*4)*k)','','ATTACK,SPLASH,USE_ARROW_DAMAGE,CRUSH,ATTACK_POISON','','NONE','(50+dex*6*k)/10','15+30*k','','','','','40+160*k',0,0,'RANGE',12,'1',2500,600),(51,_binary 'ź',2,1,1,0,'HP','-((atk+(1.2*atk+number(100,200)+dex*6+str*3+iq*3)*k)*1.2)','200+200*k','1+iq*0.4*k*0.1','','60','-((atk+(1.2*atk+number(100,200)+dex*6+str*3+iq*3)*k)*1.2)','','ATTACK,SPLASH,USE_ARROW_DAMAGE,CRUSH,ATTACK_POISON','','NONE','(50+dex*6*k)/10','15+30*k','','','','','200+200*k',0,0,'RANGE',5,'1',0,400),(61,_binary '\\\',3,1,1,0,'HP','-(atk+2*lv+iq*2+(2*atk+str*4+iq*14)*k)','30+140*k','','','10','-(atk+2*lv+iq*2+(2*atk+str*4+iq*14)*k)','','ATTACK,USE_MELEE_DAMAGE,PENETRATE','','NONE','1+k*9','','','','','','30+140*k',0,0,'MELEE',4,'1',0,0),(62,_binary '\\\\',3,1,1,0,'HP','-(1.1*atk+2*lv+iq*2+(1.5*atk+str+iq*12)*k)','50+150*k','','','15','-(1.1*atk+2*lv+iq*2+(1.5*atk+str+iq*12)*k)','','ATTACK,USE_MELEE_DAMAGE,SELFONLY,SPLASH,IGNORE_TARGET_RATING','','NONE','1+k*9','','','','','','50+150*k',0,0,'MELEE',12,'1',0,500),(63,_binary 'Ͱ\',3,1,1,0,'ATT_GRADE','(3*iq+2*lv)*k','20+240*k','50+100*k','2+23*k','0','(3*iq+2*lv)*k','','SELFONLY,TOGGLE','GWIGUM','HIT_HP_RECOVER','10*k','50+100*k','','','','','20+240*k',0,0,'NORMAL',1,'1',0,0),(64,_binary '\\',3,1,1,0,'DODGE','1+29*k','60+120*k','60+100*k','','100','1+29*k','','SELFONLY','TERROR','NONE','','','','','','','60+120*k',0,0,'NORMAL',1,'1',0,0),(65,_binary 'ָ',3,1,1,0,'DEF_GRADE','(iq+30)*k','70+170*k','30+120*k','','33+140*k','(iq+30)*k','','SELFONLY','JUMAGAP','REFLECT_MELEE','(iq/4+10)*k','30+120*k','','','','','70+170*k',0,0,'NORMAL',1,'1',0,0),(66,_binary '\Ĺ',3,1,1,0,'HP','-(40+5*lv+2*iq+(10*iq+7*mwep+number(50,1))*ar*k)','30+120*k','','','12','-(40+5*lv+2*iq+(10*iq+7*mwep+number(50,1))*ar*k)','','ATTACK,COMPUTE_MAGIC_DAMAGE,SPLASH,REMOVE_GOOD_AFFECT','','NONE','10+40*k','7+23*k','','','','','30+120*k',0,0,'NORMAL',5,'1',1800,200),(76,_binary '\',3,1,1,0,'HP','-(40+5*lv+2*iq+(13*iq+6*mwep+number(50,1))*ar*k)','30+140*k','','','7','-(40+5*lv+2*iq+(13*iq+6*mwep+number(50,1))*ar*k)','','ATTACK,COMPUTE_MAGIC_DAMAGE,SPLASH','','NONE','','','','','','','30+140*k',0,0,'MAGIC',5,'1',1500,200),(77,_binary 'ȭ\',3,1,1,0,'HP','-(5*lv+2*iq+(10*iq+6*mwep+str*4+con*2+number(180,2))*k)','60+140*k','','','12','-(5*lv+2*iq+(10*iq+6*mwep+str*4+con*2+number(180,2))*k)','','ATTACK,SELFONLY,COMPUTE_MAGIC_DAMAGE,SPLASH','','NONE','','','','','','','60+140*k',0,0,'MAGIC',15,'0.8',0,500),(78,_binary '',3,1,1,0,'HP','-(30+2*lv+2*iq+(7*iq+6*mwep+number(200,5))*ar*k)','20+30*k','40+30*k','5+40*k','43+30*k','-(30+2*lv+2*iq+(7*iq+6*mwep+number(200,5))*ar*k)','','ATTACK,COMPUTE_MAGIC_DAMAGE,SPLASH,TOGGLE','','NONE','','','','','','','20+30*k',0,0,'MAGIC',1,'1',800,100),(79,_binary '\\ż\ȣ',3,1,1,0,'DEF_GRADE','(0.5*iq+15)*k','20+30*k','60+120*k','5+10*k','63+120*k','(0.5*iq+15)*k','','SELFONLY,TOGGLE','MANASHIELD','MANASHIELD','100-((iq*0.84)*k)','60+120*k','','','','','20+30*k',0,0,'MAGIC',1,'1',0,0),(80,_binary '\\Ӹ\',3,1,1,0,'HP','-(40+2*lv+2*iq+(2*con+2*dex+13*iq+6*mwep+number(180,2))*ar*k)','40+120*k','','','12','-(40+2*lv+2*iq+(2*con+2*dex+13*iq+6*mwep+number(180,2))*ar*k)','','ATTACK,COMPUTE_MAGIC_DAMAGE,SPLASH,ATTACK_SLOW','','NONE','333+300*k','10+10*k','','','','','40+120*k',0,0,'MAGIC',9,'1',1200,400),(81,_binary 'ȯ\',3,1,1,0,'HP','-(120+6*lv+(5*con+5*dex+29*iq+9*mwep)*ar*k)','80+220*k','','','24','-(120+6*lv+(5*con+5*dex+29*iq+9*mwep)*ar*k)','','ATTACK,COMPUTE_MAGIC_DAMAGE,SPLASH','','NONE','','','','','','','80+220*k',0,0,'MAGIC',9,'1',1500,200),(91,_binary '\\ĺ\',4,1,1,0,'HP','-(70+5*lv+(18*iq+str*7+5*mwep+50)*ar*k)','30+200*k','','','9','-(70+5*lv+(18*iq+str*7+5*mwep+50)*ar*k)','','ATTACK,COMPUTE_MAGIC_DAMAGE,SPLASH,ATTACK_SLOW','','NONE','3+iq*7*k','1+dex*0.4*k*0.1','','','','','30+200*k',0,0,'MAGIC',5,'1',1800,400),(92,_binary '\\Ļ\',4,1,1,0,'HP','-(60+5*lv+(16*iq+dex*6+6*mwep+120)*ar*k)','50+280*k','','','10','-(60+5*lv+(16*iq+dex*6+6*mwep+120)*ar*k)','','ATTACK,ATTACK_FIRE_CONT,KNOCKBACK','','NONE','lv+5*iq*k','(100+iq*5*k)/10','','','','','50+280*k',0,0,'MAGIC',10,'1',800,0),(93,_binary '\з\\',4,1,1,0,'HP','-(70+3*lv+(20*iq+str*3+10*mwep+100)*ar*k)','70+380*k','','','12','-(70+3*lv+(20*iq+str*3+10*mwep+100)*ar*k)','','ATTACK,SPLASH,ATTACK_FIRE_CONT','','NONE','lv+5*iq*k','(100+iq*5*k)/10','','','','','70+380*k',0,0,'MAGIC',15,'1',2500,500),(94,_binary 'ȣ\',4,1,1,0,'RESIST_NORMAL','((iq*0.3+5)*(2*k+0.5)+(dex*0.3))/(k+2.3)','40+190*k','50+80*k','','10','((iq*0.3+5)*(2*k+0.5)+(dex*0.3))/(k+2.3)','','PARTY','HOSIN','NONE','','','','','','','40+190*k',0,0,'NORMAL',1,'1',2000,0),(95,_binary 'ݻ\',4,1,1,0,'REFLECT_MELEE','5+(iq*0.2+str*0.1)*k','60+120*(k+k)','60+200*k','','10','5+(iq*0.2+str*0.1)*k','','PARTY','BOHO','NONE','','','','','','','60+120*(k+k)',0,0,'NORMAL',1,'1',2000,0),(96,_binary '\õ\',4,1,1,0,'CRITICAL','(iq*0.3+5)*(2*k)/(k+3)','50+180*k','60+100*k','','10','(iq*0.3+5)*(2*k)/(k+3)','','PARTY','GICHEON','NONE','','','','','','','50+180*k',0,0,'NORMAL',1,'1',2000,0),(106,_binary '\',4,1,1,0,'HP','-(60+5*lv+(8*iq+dex*2+8*mwep+number(iq*5,iq*15))*ar*k)','30+200*k','','','8','-(60+5*lv+(8*iq+dex*2+8*mwep+number(iq*5,iq*15))*ar*k)','','ATTACK,SPLASH','','NONE','','','','','','','30+200*k',0,0,'MAGIC',5,'1',1800,400),(107,_binary '\',4,1,1,0,'HP','-(40+4*lv+(13*iq+str*2+10*mwep+number(iq*5,iq*16))*ar*k)','50+300*k','','','10','-(40+4*lv+(13*iq+str*2+10*mwep+number(iq*5,iq*16))*ar*k)','','ATTACK,SPLASH,ATTACK_STUN','','NONE','30+70*2*k','1+str*0.2*k*0.1','','','','','50+300*k',0,0,'MAGIC',15,'1',1500,400),(108,_binary '\ڰ\',4,1,1,0,'HP','-(50+5*lv+(8*iq+str*2+8*mwep+number(1,800))*ar*k)*(1-chain*0.13)','40+200*k','','','9','-(50+5*lv+(8*iq+str*2+8*mwep+number(1,800))*ar*k)*(1-chain*0.13)','','ATTACK,SPLASH,ATTACK_SLOW','','NONE','80+iq*5*k','1+str*0.4*k*0.1','','','','','40+200*k',0,0,'MAGIC',7,'1',2500,100),(109,_binary '\\',4,1,1,0,'HP','150+5*lv+(10*iq+6*mwep+number(600,800))*(k+0.15)','40+250*k','','','10','150+5*lv+(10*iq+6*mwep+number(600,800))*(k+0.15)','','REMOVE_BAD_AFFECT,PARTY','','NONE','20+80*k','0','','','','','40+250*k',0,0,'NORMAL',1,'1',1000,0),(110,_binary '\\\',4,1,1,0,'MOV_SPEED','(dex*0.2)+35*k','60+120*k','60+100*k','','10','(dex*0.2)+35*k','','PARTY','KWAESOK','CASTING_SPEED','3+33*k','60+100*k','','','','','60+120*k',0,0,'NORMAL',1,'1',2000,0),(111,_binary '\¼',4,1,1,0,'ATT_GRADE','3+(iq*0.2+str*0.1+11)*k','60+150*k','60+100*k','','10','3+(iq*0.2+str*0.1+11)*k','','PARTY','JEUNGRYEOK','NONE','','','','','','','60+150*k',0,0,'NORMAL',1,'1',2000,0),(121,_binary '\\ַ\',0,1,40,0,'NONE','','','','','','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(122,_binary '\\',0,1,2,0,'NONE','','','','','','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(124,_binary 'ä',0,1,40,0,'NONE','','','','','','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(125,_binary '\',0,1,40,0,'NONE','','','10+1000*k','','','','','','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(126,_binary 'ż\\',0,1,20,0,'NONE','','','','','','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(127,_binary 'õ\',0,1,20,0,'NONE','','','','','','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(128,_binary '\\',0,1,20,0,'NONE','','','','','','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(129,_binary 'а',0,1,40,0,'NONE','','','','','','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(130,_binary '¸',0,1,1,0,'NONE','','','','','','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(131,_binary '\ȯ',0,1,10,0,'NONE','','','','','','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(132,_binary 'AutoAttack',0,0,0,0,'NONE','','','','','','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(133,_binary 'RoleProficiency',0,1,40,0,'NONE','','','','','','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(134,_binary 'InSight',0,1,40,0,'NONE','','','','','','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(137,_binary '',5,1,1,50,'HP','-(atk+(2*atk*k))','60+80*k','','','5-(4*k)','-(atk+(2*atk*k))','','ATTACK,USE_MELEE_DAMAGE,CRUSH','','NONE','','','','','','','60+80*k',0,0,'MELEE',10,'1',300,0),(138,_binary '\',5,1,1,52,'HP','-(2.4*(200+1.5*lv)+(3*200*k))','60+120*k','','','15','-(2.4*(200+1.5*lv)+(3*200*k))','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH_LONG','','MOV_SPEED','50','5','','','','','60+120*k',0,0,'MELEE',6,'1',400,100),(139,_binary 'Ż\\',5,1,1,55,'HP','-(2*(200+1.5*lv)+(3*200*k))','60+160*k','','','20','-(2*(200+1.5*lv)+(3*200*k))','','ATTACK,USE_MELEE_DAMAGE,SELFONLY,SPLASH,CRUSH','','NONE','','','','','','','60+160*k',0,0,'MELEE',12,'1',400,250),(140,_binary '(Ȱ)',5,1,1,50,'HP','-(atk+(2*atk*k))','60+80*k','','','10','-(atk+(2*atk*k))','','ATTACK,USE_ARROW_DAMAGE,CRUSH','','NONE','','','','','','','60+80*k',0,0,'RANGE',5,'1',2500,0),(151,_binary '\\',0,1,7,0,'NONE','','','','','','','','','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(152,_binary '\\\\\',0,1,7,0,'MAX_HP','maxhp*0.2*k','150+150*k','300','','600','maxhp*0.2*k','','','','NONE','','','','','','','150+150*k',0,0,'NORMAL',0,'1',0,0),(153,_binary '\\\\ູ',0,1,7,0,'MAX_SP','maxsp*0.2*k','150+150*k','300','','600','maxsp*0.2*k','','','','NONE','','','','','','','150+150*k',0,0,'NORMAL',0,'1',0,0),(154,_binary '\ְ',0,1,7,0,'DEF_GRADE','odef*0.1*k','150+150*k','180','','480','odef*0.1*k','','','','NONE','','','','','','','150+150*k',0,0,'NORMAL',0,'1',0,0),(155,_binary '\ȭ',0,1,7,0,'MOV_SPEED','15*k','150+150*k','180','','480','15*k','','','','ATT_SPEED','15*k','180','','','','','150+150*k',0,0,'NORMAL',0,'1',0,0),(156,_binary '\\Ǻг\',0,1,7,0,'CRITICAL','50*k','150+150*k','180','','480','50*k','','','','NONE','','','','','','','150+150*k',0,0,'NORMAL',0,'1',0,0),(157,_binary 'ֹ',0,1,7,0,'CASTING_SPEED','50*k','150+150*k','180','','480','50*k','','','','NONE','','','','','','','150+150*k',0,0,'NORMAL',0,'1',0,0),(158,_binary '\\̵',0,1,3,0,'NONE','','','','','','','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(159,_binary 'ǹ',0,1,5,0,'NONE','','','','','','','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(160,_binary '\ȭ',0,1,5,0,'NONE','3*k','80-12*k','300','','','3*k','','SELFONLY','','NONE','','','','','','','80-12*k',0,0,'NORMAL',0,'1',0,0),(161,_binary 'ǹ',0,1,2,0,'NONE','','50','','','','','','','','NONE','','','','','','','50',0,0,'NORMAL',0,'1',0,0),(162,_binary '̵',0,1,2,0,'NONE','','20','','','','','','','','NONE','','','','','','','20',0,0,'NORMAL',0,'1',0,0),(170,_binary '\\',7,1,1,0,'HP','-(1.1*atk+(0.3*atk+1.5*str)*k)','40+100*k','','','12','-(1.1*atk+(0.3*atk+1.5*str)*k)','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_BLEEDING','','NONE','60*k','5+25*k','','','','','40+100*k',0,0,'MELEE',5,'1',300,200),(171,_binary '\ǳ',7,1,1,0,'HP','-(2*atk+(atk+dex*3+str*5+con)*k)','40+120*k','','','20','-(2*atk+(atk+dex*3+str*5+con)*k)','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_STUN,KNOCKBACK','','NONE','30+70*2*k','2','','','','','40+120*k',0,0,'MELEE',10,'1',1000,200),(172,_binary '\\',7,1,1,0,'HP','-(atk+(1.6*atk+200+dex*7+str*7)*k)','40+100*k','','','12','-(atk+(1.6*atk+200+dex*7+str*7)*k)','','ATTACK,USE_MELEE_DAMAGE','','NONE','','','','','','','40+100*k',0,0,'MELEE',5,'1',800,100),(173,_binary '\ļ\',7,1,1,0,'HP','-(3*atk+(0.8*atk+str*6+dex*2+con)*k)','40+100*k','','','12','-(3*atk+(0.8*atk+str*6+dex*2+con)*k)','','ATTACK,USE_MELEE_DAMAGE','','DEF_GRADE','-30*k','5','','','','','40+100*k',0,0,'MELEE',10,'1',800,100),(174,_binary '\',7,1,1,0,'ATT_GRADE','7+(4*iq+13)*k','20+240*k','45+60*k','2+23*k','10+10*k','7+(4*iq+13)*k','','SELFONLY,TOGGLE','RED_POSSESSION','PENETRATE','1+((iq*0.4)*k)*0.24','45+60*k','RED_POSSESSION','','','','20+240*k',0,0,'NORMAL',1,'1',0,0),(175,_binary 'û\',7,1,1,0,'ATT_SPEED','20*k','80+220*k','200','','300','20*k','','PARTY','BLUE_POSSESSION','DODGE','1+10*k','200','','','','','80+220*k',0,0,'NORMAL',1,'1',1000,0),(176,_binary '\ǴϽ',1,1,1,0,'HP','-(3*atk+(0.9*atk+number(1,1000)+str*5+dex*3+lv)*k)','200+200*k','','','35+20*k','-(3*atk+(0.9*atk+number(1,1000)+str*5+dex*3+lv)*k)','','ATTACK,USE_MELEE_DAMAGE,DISABLE_BY_POINT_UP','','HIT_PCT','0.4*k+(32*k/2)','20*k','','','','','200+200*k',0,0,'MELEE',8,'1',0,200),(177,_binary 'ϱǥ',2,1,1,0,'HP','-(atk+(1.7*atk+number(1,1000)+dex*6+lv*5)*k)','200+200*k','','','35+20*k','-(atk+(1.7*atk+number(1,1000)+dex*6+lv*5)*k)','','ATTACK,USE_MELEE_DAMAGE,SPLASH,DISABLE_BY_POINT_UP','','HIT_PCT','0.4*k+(32*k/2)','20*k','','','','','200+200*k',0,0,'MELEE',10,'1',2000,200),(178,_binary 'ǳ\\\',2,1,1,0,'HP','-(1.9*atk+(2.6*atk+number(1,1000))*k)','200+200*k','','','35+20*k','-(1.9*atk+(2.6*atk+number(1,1000))*k)','','ATTACK,SPLASH,USE_ARROW_DAMAGE,DISABLE_BY_POINT_UP','','HIT_PCT','0.4*k+(32*k/2)','20*k','','','','','200+200*k',0,0,'RANGE',8,'1',2500,200),(179,_binary 'Ǳ\',3,1,1,0,'HP','-(1.9*atk+(2.6*atk+number(1,1000))*k)','200+200*k','','','35+20*k','-(1.9*atk+(2.6*atk+number(1,1000))*k)','','ATTACK,USE_MELEE_DAMAGE,DISABLE_BY_POINT_UP','','HIT_PCT','0.4*k+(32*k/2)','20*k','','','','','200+200*k',0,0,'MELEE',4,'1',0,0),(180,_binary '\渶Ǳ\',3,1,1,0,'HP','-(120+6*lv+(5*con+5*dex+30*iq+number(1,1)+9*mwep)*ar*k)','200+200*k','','','35+20*k','-(120+6*lv+(5*con+5*dex+30*iq+number(1,1)+9*mwep)*ar*k)','','ATTACK,COMPUTE_MAGIC_DAMAGE,SPLASH,DISABLE_BY_POINT_UP','','HIT_PCT','0.4*k+(32*k/2)','20*k','','','','','200+200*k',0,0,'MAGIC',5,'1',2000,200),(181,_binary '\\׿',4,1,1,0,'HP','-(120+6*lv+(5*con+5*dex+30*iq+number(1,1)+9*mwep)*ar*k)','200+200*k','','','35+20*k','-(120+6*lv+(5*con+5*dex+30*iq+number(1,1)+9*mwep)*ar*k)','','ATTACK,SPLASH,ATTACK_FIRE_CONT,DISABLE_BY_POINT_UP','','HIT_PCT','0.4*k+(32*k/2)','20*k','','','','','200+200*k',0,0,'MAGIC',5,'1',2000,500),(182,_binary 'õ\',4,1,1,0,'NONE','0.4*k+(18*k)','200+200*k','50+(8*k)','','386+(80*k)','0.4*k+(18*k)','','DISABLE_BY_POINT_UP,PARTY','','NONE','4*k','','','','','','200+200*k',0,0,'NORMAL',1,'1',2000,0),(183,_binary '̸ǳ\',7,1,1,0,'HP','-(1.8*atk+(atk+dex*6+number(1,1000)+str*3+lv)*k)','200+200*k','','','35+20*k','-(1.8*atk+(atk+dex*6+number(1,1000)+str*3+lv)*k)','','ATTACK,USE_MELEE_DAMAGE,DISABLE_BY_POINT_UP','','HIT_PCT','0.4*k+(32*k/2)','20*k','','','','','200+200*k',0,0,'MELEE',8,'1',0,200),(221,_binary '\ȹ\ǳ\\\\\',6,1,1,0,'NONE','24*k','','','','','24*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(222,_binary 'Ͻ\\\\',6,1,1,0,'NONE','24*k','','','','','24*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(223,_binary '\\\\\\\',6,1,1,0,'NONE','24*k','','','','','24*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(224,_binary '\\Ļ\\\\\',6,1,1,0,'NONE','24*k','','','','','24*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(225,_binary '\\\\\\',6,1,1,0,'NONE','24*k','','','','','24*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(226,_binary 'ȭ\\\\\\',6,1,1,0,'NONE','24*k','','','','','24*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(227,_binary '\\\\\',6,1,1,0,'NONE','24*k','','','','','24*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(228,_binary '\\\\\',6,1,1,0,'NONE','24*k','','','','','24*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(229,_binary '\ǳ\\\\',6,1,1,0,'NONE','24*k','','','','','24*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(236,_binary '\ȹ\ǳ찭ȭ',6,1,1,0,'NONE','16*k','','','','','16*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(237,_binary 'Ͻȭ',6,1,1,0,'NONE','16*k','','','','','16*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(238,_binary '\\\ȭ',6,1,1,0,'NONE','16*k','','','','','16*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(239,_binary '\\Ļ갭ȭ',6,1,1,0,'NONE','16*k','','','','','16*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(240,_binary '\\ȭ',6,1,1,0,'NONE','16*k','','','','','16*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(241,_binary 'ȭ\İȭ',6,1,1,0,'NONE','16*k','','','','','16*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(242,_binary 'ɰȭ',6,1,1,0,'NONE','16*k','','','','','16*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(243,_binary '\ȭ',6,1,1,0,'NONE','16*k','','','','','16*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(244,_binary '\ǳȭ',6,1,1,0,'NONE','16*k','','','','','16*k','','','','NONE','','','','','','','',0,0,'NORMAL',1,'1',1000,0),(246,_binary 'hit',0,1,40,0,'NONE','0.4*k+(32*k/2)','','','','','0.4*k+(32*k/2)','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(256,_binary 'CRUSH200ų',0,1,1,0,'HP','-5*k*atk','','','','2','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH','','NONE','','','','','','','',0,0,'MELEE',0,'1',0,300),(257,_binary 'Ϲݹ350ų',0,1,1,0,'HP','-5*k*atk','','','','5','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','NONE','','','','','','','',0,0,'MELEE',0,'1',0,525),(258,_binary 'CRUSH300ų',0,1,1,0,'HP','-5*k*atk','','','','7','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH','','NONE','','','','','','','',0,0,'MELEE',0,'1',0,450),(259,_binary 'Ϲݹ200ų',0,1,1,0,'HP','-5*k*atk','','','','9','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','NONE','','','','','','','',0,0,'MELEE',0,'1',0,300),(260,_binary 'CURSH400ų',0,1,1,0,'HP','-5*k*atk','','','','10','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH','','NONE','','','','','','','',0,0,'MELEE',0,'1',0,600),(261,_binary '250ų',0,1,1,0,'HP','-5*k*atk','','','','9','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_POISON','','NONE','80','','','','','','',0,0,'MELEE',0,'1',0,375),(262,_binary 'SLOW300ų',0,1,1,0,'HP','-5*k*atk','','','','12','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','MOV_SPEED','-20','10','','','','','',0,0,'MELEE',0,'1',0,450),(263,_binary 'SLOW4000ų',0,1,1,0,'HP','-5*k*atk','','','','12','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','MOV_SPEED','-70','3','SLOW','','','','',0,0,'MELEE',0,'1',2000,6000),(264,_binary 'THUNDERų',0,1,1,0,'HP','-maxhp*k','','','','12','-maxhp*k','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH','','NONE','','','','','','','',0,0,'MELEE',0,'1',0,500),(265,_binary 'HEAL4000ų',0,1,1,0,'HP','0.1*maxhp*k','','','','5','0.1*maxhp*k','','PARTY','','NONE','','','','','','','',0,0,'NORMAL',1,'1',3000,0),(266,_binary 'ATTACK_SLOW',0,1,1,0,'NONE','','','','','','','','SELFONLY,SPLASH','','NONE','','','','','','','',0,0,'NORMAL',1,'1',0,3000),(267,_binary 'Ϲ\0ų',0,1,1,0,'HP','-5*k*atk','','','','10','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE','','NONE','','','','','','','',0,0,'MELEE',1,'1',0,0),(268,_binary 'CRUSH0ų',0,1,1,0,'HP','-5*k*atk','','','','10','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,CRUSH','','NONE','','','','','','','',0,0,'MELEE',1,'1',0,0),(269,_binary 'STUN200',0,1,1,0,'HP','-5*k*atk','','','','10','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_STUN','','NONE','1000','3','','','','','',0,0,'MELEE',0,'1',0,300),(270,_binary 'normal_range_attack_confustion',0,1,1,0,'HP','-5*k*atk','','','','5','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','NONE','80*k','','','','','','',0,0,'MELEE',0,'1',0,525),(271,_binary 'knockback_hp_absorb',0,1,1,0,'HP','-5*k*atk','','','','7','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,HP_ABSORB,CRUSH','','NONE','10','','','','','','',0,0,'MELEE',0,'1',0,350),(272,_binary 'knockback_bleeding',0,1,1,0,'HP','-5*k*atk','','','','7','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH,ATTACK_BLEEDING','','NONE','100','','','','','','',0,0,'MELEE',0,'1',0,350),(273,_binary 'wide_area_damage_stun',0,1,1,0,'HP','-maxhp*k','','','','12','-maxhp*k','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_STUN,CRUSH','','NONE','1000','4','','','','','',0,0,'MELEE',0,'1',0,500),(274,_binary 'wide_area_damage_sungma_str',0,1,1,0,'SUNGMA_STR','-40*k','','10','','12','-40*k','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH','','HP','-maxhp*k','0','','','','','',0,0,'MELEE',0,'1',1000,300),(275,_binary 'splash400_bleeding',0,1,1,0,'HP','-5*k*atk','','','','7','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_BLEEDING','','NONE','30','','','','','','',0,0,'MELEE',0,'1',0,400),(276,_binary 'stun300',0,1,1,0,'HP','-5*k*atk','','','','7','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_STUN','','NONE','200','3','','','','','',0,0,'MELEE',0,'1',0,300),(277,_binary 'splash400_poison',0,1,1,0,'HP','-5*k*atk','','','','5','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_POISON','','NONE','10','','','','','','',0,0,'MELEE',0,'1',0,400),(278,_binary 'stun400',0,1,1,0,'HP','-5*k*atk','','','','7','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_STUN','','NONE','200','3','','','','','',0,0,'MELEE',0,'1',0,400),(279,_binary 'maze_keingnoll_boss_skill3',0,1,1,0,'HP','-5*k*atk','','','','20','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,HP_ABSORB','','NONE','50','','','','','','',0,0,'NORMAL',0,'1',0,400),(280,_binary 'posion_damage_sungma_move',0,1,1,1,'HP','-5*k*atk','','','','9','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_POISON','','NONE','80','','','','','','',0,0,'MELEE',0,'1',0,375),(281,_binary 'crush_damage_sungma_str',0,1,1,1,'HP','-5*k*atk','','','','17','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','SUNGMA_STR','-20','10','','','','','',0,0,'MELEE',0,'1',0,375),(282,_binary 'shackle_damage',0,1,1,1,'HP','-5*k*atk','','','','25','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','MOV_SPEED','0','3','','','','','',0,0,'MELEE',0,'1',0,450),(283,_binary 'white_dragon_skill0',0,1,1,0,'HP','-5*k*atk','','','','24','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','NONE','0','0','','','','','',0,0,'MELEE',0,'1',0,300),(284,_binary 'white_dragon_skill2',0,1,1,0,'HP','-5*k*atk','','','','45','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH','','NONE','50','','','','','','',0,0,'MELEE',0,'1',0,900),(285,_binary 'ڵ\(̼\)',8,1,1,0,'MOUNT_UPGRADE_NIMBLE','(4+(horselv*skilllv/100))*(skilllv/3)','','3+(skilllv*(horselv*0.4))/20','','180','(4+(horselv*skilllv/100))*(skilllv/3)','','SELFONLY','','MOV_SPEED','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(286,_binary '\\\ġ',8,1,1,0,'MALL_EXPBONUS','((horselv*skilllv/100)+1.5)+(skilllv/8)','','','','','((horselv*skilllv/100)+1.5)+(skilllv/8)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(287,_binary 'ǳ(\)',8,1,1,0,'MOUNT_UPGRADE_SPEED','(5+(horselv*skilllv/600))*(skilllv/5)','','3+(skilllv*(horselv*0.4))/20','','180','(5+(horselv*skilllv/600))*(skilllv/5)','','SELFONLY','','ATT_SPEED','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(288,_binary '\',8,1,1,0,'NONE','(horselv*(skilllv*number(5,10)))/40*skilllv','','1+(skilllv*(horselv*0.3))/20','','300','(horselv*(skilllv*number(5,10)))/40*skilllv','','','','NONE','(horselv*(skilllv*10))/40*skilllv','','','','','','',0,0,'NORMAL',0,'1',1000,0),(289,_binary '',8,1,1,0,'NONE','','','(horselv*(skilllv*0.3))/60','','600','','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(290,_binary '˹\̹ߵ',8,1,1,0,'MOUNT_UPGRADE_NO_KNOCKBACK','','','3+(skilllv*(horselv*0.5))/20','','180','','','','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(291,_binary '԰\\ΰ',8,1,1,0,'ATTBONUS_HUMAN','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(292,_binary '԰\Ե',8,1,1,0,'ATTBONUS_ANIMAL','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(293,_binary '԰\Կ\\',8,1,1,0,'ATTBONUS_ORC','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(294,_binary '԰\Թб',8,1,1,0,'ATTBONUS_MILGYO','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(295,_binary '԰\Ծ𵥵\',8,1,1,0,'ATTBONUS_UNDEAD','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(296,_binary '԰\ԾǸ',8,1,1,0,'ATTBONUS_DEVIL','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(297,_binary '԰\Խ\\\',8,1,1,0,'ATTBONUS_CZ','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(298,_binary '԰\Ի縷',8,1,1,0,'ATTBONUS_DESERT','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(299,_binary '԰\԰\\\',8,1,1,0,'ATTBONUS_INSECT','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(300,_binary '԰\Ը\\\\\',8,1,1,0,'ATTBONUS_MONSTER','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(301,_binary 'ž\\θ\Ʈȿ\\',8,1,1,0,'NONE','k*(skilllv/(140-horselv))','','','','','k*(skilllv/(140-horselv))','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(302,_binary '\\\\(\)',8,1,1,0,'ATTBONUS_WARRIOR','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(303,_binary '\\\\(ڰ)',8,1,1,0,'ATTBONUS_ASSASSIN','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(304,_binary '\\\\(\\)',8,1,1,0,'ATTBONUS_SURA','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(305,_binary '\\\\(\)',8,1,1,0,'ATTBONUS_SHAMAN','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(306,_binary '\\\\(\\)',8,1,1,0,'ATTBONUS_WOLF','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(307,_binary '\\',8,1,1,0,'MOUNT_UPGRADE_SUNGMA_STR','3+(horselv*skilllv)*(skilllv/500)','','3+(skilllv*(horselv*0.4))/20','','180','3+(horselv*skilllv)*(skilllv/500)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(308,_binary 'ǽ\ü',8,1,1,0,'MOUNT_UPGRADE_SUNGMA_HP','3+(horselv*skilllv)*(skilllv/500)','','3+(skilllv*(horselv*0.4))/20','','180','3+(horselv*skilllv)*(skilllv/500)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(309,_binary '\\׷\',8,1,1,0,'MOUNT_UPGRADE_SUNGMA_MOVE','3+(horselv*skilllv)*(skilllv/500)','','3+(skilllv*(horselv*0.4))/20','','180','3+(horselv*skilllv)*(skilllv/500)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(310,_binary '\\',8,1,1,0,'MOUNT_UPGRADE_SUNGMA_IMMUNE','3+(horselv*skilllv)*(skilllv/500)','','3+(skilllv*(horselv*0.4))/20','','180','3+(horselv*skilllv)*(skilllv/500)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(311,_binary '\\',8,1,1,0,'HIT_PCT','1+(skilllv*horselv/100)','','','','','1+(skilllv*horselv/100)','','SELFONLY','','NONE','','','','','','','',0,0,'NORMAL',0,'1',1000,0),(312,_binary '\ʻ\\(ų1)',0,1,1,0,'HP','-5*k*atk','','','','7','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,HP_ABSORB','','NONE','20','','','','','','',0,0,'MELEE',1,'1',0,400),(313,_binary '\ʻ\\(ų2)',0,1,1,0,'HP','-15*k*atk','','','','23','-15*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','NONE','','','','','','','',0,0,'MELEE',1,'1',0,1000),(314,_binary '\ʻ\\(ų2)',0,1,1,0,'HP','-5*k*atk','','','','18','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH,ATTACK_BLEEDING','','NONE','30','','','','','','',0,0,'MELEE',0,'1',0,400),(315,_binary '\ʻ\\(ų1)',0,1,1,0,'HP','-5*k*atk','','','','30','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,HP_ABSORB','','NONE','10','','','','','','',0,0,'MELEE',1,'1',0,400),(316,_binary '\ʻ\\(ų2)',0,1,1,0,'HP','-5*k*atk','','','','47','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','NONE','','','','','','','',0,0,'MELEE',1,'1',0,1000),(317,_binary '\\ʻ\\(ų1)',0,1,1,0,'HP','-5*k*atk','','','','7','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_STUN','','NONE','1000','3','','','','','',0,0,'MELEE',1,'1',0,400),(318,_binary '\\ʻ\\(ų2)',0,1,1,0,'HP','-5*k*atk','','','','15','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH','','NONE','','','','','','','',0,0,'MELEE',1,'1',0,400),(319,_binary '\(ų1)',0,1,1,0,'HP','-5*k*atk','','','','6','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','NONE','','','','','','','',0,0,'MELEE',1,'1',0,300),(320,_binary '\(ų2)',0,1,1,0,'HP','-5*k*atk','','','','31','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','NONE','','','','','','','',0,0,'MELEE',0,'1',0,300),(321,_binary '\(ų3)',0,1,1,0,'HP','-5*k*atk','','','','14','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_BLEEDING','','NONE','100','','','','','','',0,0,'MELEE',0,'1',0,1000),(322,_binary 'change_equipment_page',0,0,0,0,'NONE','','','','','3','','','DISABLE_BY_POINT_UP','','NONE','','','','','','','',0,0,'NORMAL',0,'1',0,0),(329,_binary '\\(ų1)',0,1,1,0,'HP','-5*k*atk','','','','12','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH','','NONE','','','','','','','',0,0,'MELEE',0,'1',0,1500),(330,_binary '\\(ų2)',0,1,1,0,'HP','-5*k*atk','','','','33','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH','','NONE','100','','','','','','',0,0,'MELEE',0,'1',0,1200),(331,_binary '\\(ų3)',0,1,1,0,'HP','-5*k*atk','','','','20','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH','','NONE','','','','','','','',0,0,'MELEE',0,'1',0,1500),(332,_binary 'Ƽ\\(ų1)',0,1,1,0,'HP','-5*k*atk','','','','12','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,CRUSH,ATTACK_POISON','','NONE','10','31','','','','','',0,0,'MELEE',0,'1',0,500),(333,_binary 'Ƽ\\(ų2)',0,1,1,0,'HP','-5*k*atk','','','','17','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_STUN,CRUSH','','NONE','20','3','','','','','',0,0,'MELEE',0,'1',0,300),(334,_binary 'Ƽ\\(ų3)',0,1,1,0,'HP','-5*k*atk','','','','26','-5*k*atk','','ATTACK,USE_MELEE_DAMAGE,SPLASH,ATTACK_STUN','','NONE','','','','','','','',0,0,'MELEE',0,'1',0,600);
 /*!40000 ALTER TABLE `skill_proto` ENABLE KEYS */;
 UNLOCK TABLES;
 
@@ -4481,3 +4399,362 @@
 /*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;
 
 -- Dump completed on 2026-02-18 22:00:45
+
+--
+-- Growth Pet System (clean install)
+--
+
+/*
+ Navicat MySQL Data Transfer
+
+ Source Server         : Dev_locale
+ Source Server Type    : MySQL
+ Source Server Version : 80027
+ Source Host           : 127.0.0.1:3306
+ Source Schema         : player
+
+ Target Server Type    : MySQL
+ Target Server Version : 80027
+ File Encoding         : 65001
+
+ Date: 16/04/2022 10:56:57
+*/
+
+SET NAMES utf8mb4;
+SET FOREIGN_KEY_CHECKS = 0;
+
+-- ----------------------------
+-- Table structure for growth_pet
+-- ----------------------------
+DROP TABLE IF EXISTS `growth_pet`;
+CREATE TABLE `growth_pet`  (
+  `id` int(0) NOT NULL,
+  `owner_id` int(0) NOT NULL,
+  `vnum` int(0) NOT NULL,
+  `state` enum('UPBRINGING','BAG','SAFEBOX') CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL DEFAULT 'UPBRINGING',
+  `name` varchar(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NULL DEFAULT NULL,
+  `size` tinyint(0) NOT NULL,
+  `level` int(0) NULL DEFAULT 1,
+  `level_step` tinyint(1) NULL DEFAULT 0,
+  `evolution` tinyint(1) NULL DEFAULT 1,
+  `type` tinyint(1) NULL DEFAULT NULL,
+  `hp` int(0) NULL DEFAULT 0,
+  `sp` int(0) NULL DEFAULT 0,
+  `def` int(0) NULL DEFAULT 0,
+  `hp_apply` tinyint(0) NULL DEFAULT 0,
+  `sp_apply` tinyint(0) NULL DEFAULT 0,
+  `def_apply` tinyint(0) NULL DEFAULT 0,
+  `age_apply` tinyint(0) NULL DEFAULT 0,
+  `skill_level` tinyblob NULL,
+  `exp` int(0) NULL DEFAULT NULL,
+  `item_exp` int(0) NULL DEFAULT NULL,
+  `birthday` datetime(0) NULL DEFAULT NULL,
+  `end_time` int(0) NULL DEFAULT 0,
+  `max_time` int(0) NULL DEFAULT NULL,
+  PRIMARY KEY (`id`) USING BTREE
+) ENGINE = MyISAM AUTO_INCREMENT = 1 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_0900_ai_ci ROW_FORMAT = Dynamic;
+
+SET FOREIGN_KEY_CHECKS = 1;
+
+/*
+ Navicat MySQL Data Transfer
+
+ Source Server         : Dev_locale
+ Source Server Type    : MySQL
+ Source Server Version : 80027
+ Source Host           : 127.0.0.1:3306
+ Source Schema         : player
+
+ Target Server Type    : MySQL
+ Target Server Version : 80027
+ File Encoding         : 65001
+
+ Date: 16/04/2022 10:56:57
+*/
+
+SET NAMES utf8mb4;
+SET FOREIGN_KEY_CHECKS = 0;
+
+-- ----------------------------
+-- Table structure for growth_pet_skill_proto
+-- ----------------------------
+DROP TABLE IF EXISTS `growth_pet_skill_proto`;
+CREATE TABLE `growth_pet_skill_proto`  (
+  `dwPetVnum` int(11) NOT NULL,
+  `dwSkillVnum` int(11) NOT NULL,
+  `szName` varchar(32) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+  `bType` enum('PASSIVE','AUTO') CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+  `dwCooldown` int(3) NOT NULL,
+  `setAffectFlag` enum('JIJOONG_WARRIOR','JIJOONG_SURA','JIJOONG_ASSASSIN','JIJOONG_SHAMAN','JIJOONG_WOLFMAN','PACHEON','BANYA','CHEONRYEONG','CHOEHOENBIMU','HEAL','STEALHP','STEALMP','BLOCK','REFLECT_MELEE','GOLD_DROP','BOW_DISTANCE','INVINCIBILITY','REMOVAL','POTION','MOB_BONUS','EXP','HP_RECOVER','FEATHER','') CHARACTER SET utf8 COLLATE utf8_general_ci DEFAULT NULL,
+  `szPointOn` enum('RESIST_WARRIOR','RESIST_SURA','RESIST_ASSASSIN','RESIST_SHAMAN','RESIST_WOLFMAN','RESIST_MAGIC_REDUCTION','MELEE_MAGIC_ATT_BONUS_PER','ATTBONUS_MONSTER','PENETRATE_PCT','CASTING_SPEED','BOW_DISTANCE','STEAL_SP','STEAL_HP','KILL_HP_RECOVERY','BLOCK','REFLECT_MELEE','GOLD_DOUBLE_BONUS','EXP_DOUBLE_BONUS','POTION_BONUS') CHARACTER SET utf8 COLLATE utf8_general_ci DEFAULT NULL,
+  `szPointPoly1` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+  `szPointPoly2` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+  `szPointPoly3` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+  `szPointPoly4` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+  `szPointPoly5` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+  `szPointPoly6` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+  `szPointPoly7` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+  `szPointPoly8` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+  `szActivatePctPoly` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+  `szDurationPoly` varchar(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+  PRIMARY KEY (`dwPetVnum`, `dwSkillVnum`) USING BTREE
+) ENGINE = MyISAM CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Dynamic;
+
+-- ----------------------------
+-- Records of growth_pet_skill_proto
+-- ----------------------------
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 1, 'Resistance (Warrior)', 'PASSIVE', 0, 'JIJOONG_WARRIOR', 'RESIST_WARRIOR', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 2, 'Resistance (Sura)', 'PASSIVE', 0, 'JIJOONG_SURA', 'RESIST_SURA', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 3, 'Resistance (Ninja)', 'PASSIVE', 0, 'JIJOONG_ASSASSIN', 'RESIST_ASSASSIN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 4, 'Resistance (Shaman)', 'PASSIVE', 0, 'JIJOONG_SHAMAN', 'RESIST_SHAMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 5, 'Resistance (Lycan)', 'PASSIVE', 0, 'JIJOONG_WOLFMAN', 'RESIST_WOLFMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 6, 'Berserker', 'PASSIVE', 0, 'PACHEON', 'MELEE_MAGIC_ATT_BONUS_PER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 7, 'Anti-Magic', 'PASSIVE', 0, 'BANYA', 'RESIST_MAGIC_REDUCTION', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 8, 'Haste', 'PASSIVE', 0, 'CHEONRYEONG', 'CASTING_SPEED', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 9, 'Drill', 'PASSIVE', 0, 'CHOEHOENBIMU', 'PENETRATE_PCT', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 10, 'Restoration', 'AUTO', 480, 'HEAL', '', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '58', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 11, 'Vampirism', 'PASSIVE', 0, 'STEALHP', 'STEAL_HP', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 12, 'Spiritualism', 'PASSIVE', 0, 'STEALMP', 'STEAL_SP', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 13, 'Bulwark', 'PASSIVE', 0, 'BLOCK', 'BLOCK', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 14, 'Reflection', 'PASSIVE', 0, 'REFLECT_MELEE', 'REFLECT_MELEE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 15, 'Yang Drop', 'PASSIVE', 0, 'GOLD_DROP', 'GOLD_DOUBLE_BONUS', '10.6 + (k*3.339 + lv*1.1925)', '10.8 + (k*3.402 + lv*1.215)', '10.8 + (k*3.402 + lv*1.215)', '11.2 + (k*3.528 + lv*1.26)', '11.2 + (k*3.528 + lv*1.26)', '11.6 + (k*3.654 + lv*1.305)', '11.6 + (k*3.654 + lv*1.305)', '11.6 + (k*3.654 + lv*1.305)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 16, 'Range', 'PASSIVE', 0, 'BOW_DISTANCE', 'BOW_DISTANCE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 17, 'Immortal', 'AUTO', 600, 'INVINCIBILITY', '', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '53', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 18, 'Panacea', 'AUTO', 480, 'REMOVAL', '', '0', '0', '0', '0', '0', '0', '0', '0', '41', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 19, 'Master Brewer', 'PASSIVE', 0, 'POTION', 'POTION_BONUS', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 20, 'Monster Hunter', 'PASSIVE', 0, 'MOB_BONUS', 'ATTBONUS_MONSTER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 21, 'Eagle Eyes', 'PASSIVE', 0, 'EXP', 'EXP_DOUBLE_BONUS', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 22, 'Life Drain', 'PASSIVE', 0, 'HP_RECOVER', 'KILL_HP_RECOVERY', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55701, 23, 'Light as a Feather', 'AUTO', 10, 'FEATHER', '', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '44+ (k*0.455 + lv*0.1625)', '50 + (k*2.8 + lv*1)');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 1, 'Resistance (Warrior)', 'PASSIVE', 0, 'JIJOONG_WARRIOR', 'RESIST_WARRIOR', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 2, 'Resistance (Sura)', 'PASSIVE', 0, 'JIJOONG_SURA', 'RESIST_SURA', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 3, 'Resistance (Ninja)', 'PASSIVE', 0, 'JIJOONG_ASSASSIN', 'RESIST_ASSASSIN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 4, 'Resistance (Shaman)', 'PASSIVE', 0, 'JIJOONG_SHAMAN', 'RESIST_SHAMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 5, 'Resistance (Lycan)', 'PASSIVE', 0, 'JIJOONG_WOLFMAN', 'RESIST_WOLFMAN', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 6, 'Berserker', 'PASSIVE', 0, 'PACHEON', 'MELEE_MAGIC_ATT_BONUS_PER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 7, 'Anti-Magic', 'PASSIVE', 0, 'BANYA', 'RESIST_MAGIC_REDUCTION', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 8, 'Haste', 'PASSIVE', 0, 'CHEONRYEONG', 'CASTING_SPEED', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 9, 'Drill', 'PASSIVE', 0, 'CHOEHOENBIMU', 'PENETRATE_PCT', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 10, 'Restoration', 'AUTO', 480, 'HEAL', '', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '58', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 11, 'Vampirism', 'PASSIVE', 0, 'STEALHP', 'STEAL_HP', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 12, 'Spiritualism', 'PASSIVE', 0, 'STEALMP', 'STEAL_SP', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 13, 'Bulwark', 'PASSIVE', 0, 'BLOCK', 'BLOCK', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 14, 'Reflection', 'PASSIVE', 0, 'REFLECT_MELEE', 'REFLECT_MELEE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 15, 'Yang Drop', 'PASSIVE', 0, 'GOLD_DROP', 'GOLD_DOUBLE_BONUS', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 16, 'Range', 'PASSIVE', 0, 'BOW_DISTANCE', 'BOW_DISTANCE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 17, 'Immortal', 'AUTO', 600, 'INVINCIBILITY', '', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '10 + (k*0.665 + lv*0.2375)', '10 + (k*0.665 + lv*0.2375)', '10 + (k*0.665 + lv*0.2375)', '10 + (k*0.665 + lv*0.2375)', '53', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 18, 'Panacea', 'AUTO', 480, 'REMOVAL', '', '0', '0', '0', '0', '0', '0', '0', '0', '41', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 19, 'Master Brewer', 'PASSIVE', 0, 'POTION', 'POTION_BONUS', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 20, 'Monster Hunter', 'PASSIVE', 0, 'MOB_BONUS', 'ATTBONUS_MONSTER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 21, 'Eagle Eyes', 'PASSIVE', 0, 'EXP', 'EXP_DOUBLE_BONUS', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 22, 'Life Drain', 'PASSIVE', 0, 'HP_RECOVER', 'KILL_HP_RECOVERY', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55702, 23, 'Light as a Feather', 'AUTO', 180, 'FEATHER', '', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '44+ (k*0.455 + lv*0.1625)', '50 + (k*2.8 + lv*1)');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 1, 'Resistance (Warrior)', 'PASSIVE', 0, 'JIJOONG_WARRIOR', 'RESIST_WARRIOR', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 2, 'Resistance (Sura)', 'PASSIVE', 0, 'JIJOONG_SURA', 'RESIST_SURA', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 3, 'Resistance (Ninja)', 'PASSIVE', 0, 'JIJOONG_ASSASSIN', 'RESIST_ASSASSIN', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 4, 'Resistance (Shaman)', 'PASSIVE', 0, 'JIJOONG_SHAMAN', 'RESIST_SHAMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 5, 'Resistance (Lycan)', 'PASSIVE', 0, 'JIJOONG_WOLFMAN', 'RESIST_WOLFMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 6, 'Berserker', 'PASSIVE', 0, 'PACHEON', 'MELEE_MAGIC_ATT_BONUS_PER', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 7, 'Anti-Magic', 'PASSIVE', 0, 'BANYA', 'RESIST_MAGIC_REDUCTION', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 8, 'Haste', 'PASSIVE', 0, 'CHEONRYEONG', 'CASTING_SPEED', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 9, 'Drill', 'PASSIVE', 0, 'CHOEHOENBIMU', 'PENETRATE_PCT', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 10, 'Restoration', 'AUTO', 480, 'HEAL', '', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '58', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 11, 'Vampirism', 'PASSIVE', 0, 'STEALHP', 'STEAL_HP', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 12, 'Spiritualism', 'PASSIVE', 0, 'STEALMP', 'STEAL_SP', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 13, 'Bulwark', 'PASSIVE', 0, 'BLOCK', 'BLOCK', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 14, 'Reflection', 'PASSIVE', 0, 'REFLECT_MELEE', 'REFLECT_MELEE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 15, 'Yang Drop', 'PASSIVE', 0, 'GOLD_DROP', 'GOLD_DOUBLE_BONUS', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 16, 'Range', 'PASSIVE', 0, 'BOW_DISTANCE', 'BOW_DISTANCE', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 17, 'Immortal', 'AUTO', 600, 'INVINCIBILITY', '', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '53', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 18, 'Panacea', 'AUTO', 480, 'REMOVAL', '', '0', '0', '0', '0', '0', '0', '0', '0', '41', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 19, 'Master Brewer', 'PASSIVE', 0, 'POTION', 'POTION_BONUS', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 20, 'Monster Hunter', 'PASSIVE', 0, 'MOB_BONUS', 'ATTBONUS_MONSTER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 21, 'Eagle Eyes', 'PASSIVE', 0, 'EXP', 'EXP_DOUBLE_BONUS', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 22, 'Life Drain', 'PASSIVE', 0, 'HP_RECOVER', 'KILL_HP_RECOVERY', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55703, 23, 'Light as a Feather', 'AUTO', 180, 'FEATHER', '', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '44+ (k*0.455 + lv*0.1625)', '50 + (k*2.8 + lv*1)');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 1, 'Resistance (Warrior)', 'PASSIVE', 0, 'JIJOONG_WARRIOR', 'RESIST_WARRIOR', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 2, 'Resistance (Sura)', 'PASSIVE', 0, 'JIJOONG_SURA', 'RESIST_SURA', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 3, 'Resistance (Ninja)', 'PASSIVE', 0, 'JIJOONG_ASSASSIN', 'RESIST_ASSASSIN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 4, 'Resistance (Shaman)', 'PASSIVE', 0, 'JIJOONG_SHAMAN', 'RESIST_SHAMAN', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 5, 'Resistance (Lycan)', 'PASSIVE', 0, 'JIJOONG_WOLFMAN', 'RESIST_WOLFMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 6, 'Berserker', 'PASSIVE', 0, 'PACHEON', 'MELEE_MAGIC_ATT_BONUS_PER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 7, 'Anti-Magic', 'PASSIVE', 0, 'BANYA', 'RESIST_MAGIC_REDUCTION', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 8, 'Haste', 'PASSIVE', 0, 'CHEONRYEONG', 'CASTING_SPEED', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 9, 'Drill', 'PASSIVE', 0, 'CHOEHOENBIMU', 'PENETRATE_PCT', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 10, 'Restoration', 'AUTO', 480, 'HEAL', '', '713.3 + (k*224.689 + lv*80.2463)', '713.3 + (k*224.689 + lv*80.2463)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '733.3 + (k*230.99 + lv*82.4963)', '733.3 + (k*230.99 + lv*82.4963)', '733.3 + (k*230.99 + lv*82.4963)', '733.3 + (k*230.99 + lv*82.4963)', '58', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 11, 'Vampirism', 'PASSIVE', 0, 'STEALHP', 'STEAL_HP', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 12, 'Spiritualism', 'PASSIVE', 0, 'STEALMP', 'STEAL_SP', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 13, 'Bulwark', 'PASSIVE', 0, 'BLOCK', 'BLOCK', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 14, 'Reflection', 'PASSIVE', 0, 'REFLECT_MELEE', 'REFLECT_MELEE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 15, 'Yang Drop', 'PASSIVE', 0, 'GOLD_DROP', 'GOLD_DOUBLE_BONUS', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 16, 'Range', 'PASSIVE', 0, 'BOW_DISTANCE', 'BOW_DISTANCE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 17, 'Immortal', 'AUTO', 600, 'INVINCIBILITY', '', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '53', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 18, 'Panacea', 'AUTO', 480, 'REMOVAL', '', '0', '0', '0', '0', '0', '0', '0', '0', '41', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 19, 'Master Brewer', 'PASSIVE', 0, 'POTION', 'POTION_BONUS', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 20, 'Monster Hunter', 'PASSIVE', 0, 'MOB_BONUS', 'ATTBONUS_MONSTER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 21, 'Eagle Eyes', 'PASSIVE', 0, 'EXP', 'EXP_DOUBLE_BONUS', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 22, 'Life Drain', 'PASSIVE', 0, 'HP_RECOVER', 'KILL_HP_RECOVERY', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55704, 23, 'Light as a Feather', 'AUTO', 180, 'FEATHER', '', '162.5 + (k*5.6875 + lv*2.03125)', '162.5 + (k*5.6875 + lv*2.03125)', '262.5 + (k*9.1875 + lv*3.28125)', '262.5 + (k*9.1875 + lv*3.28125)', '337.5 + (k*11.8125 + lv*4.21875)', '337.5 + (k*11.8125 + lv*4.21875)', '387.5 + (k*13.5625 + lv*4.84375)', '387.5 + (k*13.5625 + lv*4.84375)', '44+ (k*0.455 + lv*0.1625)', '50 + (k*2.8 + lv*1)');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 1, 'Resistance (Warrior)', 'PASSIVE', 0, 'JIJOONG_WARRIOR', 'RESIST_WARRIOR', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 2, 'Resistance (Sura)', 'PASSIVE', 0, 'JIJOONG_SURA', 'RESIST_SURA', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 3, 'Resistance (Ninja)', 'PASSIVE', 0, 'JIJOONG_ASSASSIN', 'RESIST_ASSASSIN', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 4, 'Resistance (Shaman)', 'PASSIVE', 0, 'JIJOONG_SHAMAN', 'RESIST_SHAMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 5, 'Resistance (Lycan)', 'PASSIVE', 0, 'JIJOONG_WOLFMAN', 'RESIST_WOLFMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 6, 'Berserker', 'PASSIVE', 0, 'PACHEON', 'MELEE_MAGIC_ATT_BONUS_PER', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 7, 'Anti-Magic', 'PASSIVE', 0, 'BANYA', 'RESIST_MAGIC_REDUCTION', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 8, 'Haste', 'PASSIVE', 0, 'CHEONRYEONG', 'CASTING_SPEED', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 9, 'Drill', 'PASSIVE', 0, 'CHOEHOENBIMU', 'PENETRATE_PCT', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 10, 'Restoration', 'AUTO', 480, 'HEAL', '', '713.3 + (k*224.689 + lv*80.2463)', '713.3 + (k*224.689 + lv*80.2463)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '733.3 + (k*230.99 + lv*82.4963)', '733.3 + (k*230.99 + lv*82.4963)', '733.3 + (k*230.99 + lv*82.4963)', '733.3 + (k*230.99 + lv*82.4963)', '58', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 11, 'Vampirism', 'PASSIVE', 0, 'STEALHP', 'STEAL_HP', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 12, 'Spiritualism', 'PASSIVE', 0, 'STEALMP', 'STEAL_SP', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 13, 'Bulwark', 'PASSIVE', 0, 'BLOCK', 'BLOCK', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 14, 'Reflection', 'PASSIVE', 0, 'REFLECT_MELEE', 'REFLECT_MELEE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 15, 'Yang Drop', 'PASSIVE', 0, 'GOLD_DROP', 'GOLD_DOUBLE_BONUS', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 16, 'Range', 'PASSIVE', 0, 'BOW_DISTANCE', 'BOW_DISTANCE', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 17, 'Immortal', 'AUTO', 600, 'INVINCIBILITY', '', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '53', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 18, 'Panacea', 'AUTO', 480, 'REMOVAL', '', '0', '0', '0', '0', '0', '0', '0', '0', '41', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 19, 'Master Brewer', 'PASSIVE', 0, 'POTION', 'POTION_BONUS', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 20, 'Monster Hunter', 'PASSIVE', 0, 'MOB_BONUS', 'ATTBONUS_MONSTER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 21, 'Eagle Eyes', 'PASSIVE', 0, 'EXP', 'EXP_DOUBLE_BONUS', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 22, 'Life Drain', 'PASSIVE', 0, 'HP_RECOVER', 'KILL_HP_RECOVERY', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55705, 23, 'Light as a Feather', 'AUTO', 180, 'FEATHER', '', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '44+ (k*0.455 + lv*0.1625)', '50 + (k*2.8 + lv*1)');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 1, 'Resistance (Warrior)', 'PASSIVE', 0, 'JIJOONG_WARRIOR', 'RESIST_WARRIOR', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 2, 'Resistance (Sura)', 'PASSIVE', 0, 'JIJOONG_SURA', 'RESIST_SURA', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 3, 'Resistance (Ninja)', 'PASSIVE', 0, 'JIJOONG_ASSASSIN', 'RESIST_ASSASSIN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 4, 'Resistance (Shaman)', 'PASSIVE', 0, 'JIJOONG_SHAMAN', 'RESIST_SHAMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 5, 'Resistance (Lycan)', 'PASSIVE', 0, 'JIJOONG_WOLFMAN', 'RESIST_WOLFMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 6, 'Berserker', 'PASSIVE', 0, 'PACHEON', 'MELEE_MAGIC_ATT_BONUS_PER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 7, 'Anti-Magic', 'PASSIVE', 0, 'BANYA', 'RESIST_MAGIC_REDUCTION', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 8, 'Haste', 'PASSIVE', 0, 'CHEONRYEONG', 'CASTING_SPEED', '1 + (k*0.63 + lv*0.225)', '1 + (k*0.63 + lv*0.225)', '1 + (k*0.665 + lv*0.2375)', '1 + (k*0.665 + lv*0.2375)', '1 + (k*0.735 + lv*0.2625)', '1 + (k*0.735 + lv*0.2625)', '1 + (k*0.735 + lv*0.2625)', '1 + (k*0.735 + lv*0.2625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 9, 'Drill', 'PASSIVE', 0, 'CHOEHOENBIMU', 'PENETRATE_PCT', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 10, 'Restoration', 'AUTO', 480, 'HEAL', '', '713.3 + (k*224.689 + lv*80.2463)', '713.3 + (k*224.689 + lv*80.2463)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '733.3 + (k*230.99 + lv*82.4963)', '733.3 + (k*230.99 + lv*82.4963)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '58', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 11, 'Vampirism', 'PASSIVE', 0, 'STEALHP', 'STEAL_HP', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 12, 'Spiritualism', 'PASSIVE', 0, 'STEALMP', 'STEAL_SP', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 13, 'Bulwark', 'PASSIVE', 0, 'BLOCK', 'BLOCK', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.49 + lv*0.175)', '1 + (k*0.49 + lv*0.175)', '1 + (k*0.49 + lv*0.175)', '1 + (k*0.49 + lv*0.175)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 14, 'Reflection', 'PASSIVE', 0, 'REFLECT_MELEE', 'REFLECT_MELEE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 15, 'Yang Drop', 'PASSIVE', 0, 'GOLD_DROP', 'GOLD_DOUBLE_BONUS', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 16, 'Range', 'PASSIVE', 0, 'BOW_DISTANCE', 'BOW_DISTANCE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 17, 'Immortal', 'AUTO', 600, 'INVINCIBILITY', '', '10 + (k*0.63 + lv*0.225)', '10 + (k*0.63 + lv*0.225)', '10 + (k*0.665 + lv*0.2375)', '10 + (k*0.665 + lv*0.2375)', '10 + (k*0.7 + lv*0.25)', '10 + (k*0.7 + lv*0.25)', '10 + (k*0.7 + lv*0.25)', '10 + (k*0.7 + lv*0.25)', '53', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 18, 'Panacea', 'AUTO', 480, 'REMOVAL', '', '0', '0', '0', '0', '0', '0', '0', '0', '41', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 19, 'Master Brewer', 'PASSIVE', 0, 'POTION', 'POTION_BONUS', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 20, 'Monster Hunter', 'PASSIVE', 0, 'MOB_BONUS', 'ATTBONUS_MONSTER', '1 + (k*0.28 + lv*0.1)', '1 + (k*0.28 + lv*0.1)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 21, 'Eagle Eyes', 'PASSIVE', 0, 'EXP', 'EXP_DOUBLE_BONUS', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 22, 'Life Drain', 'PASSIVE', 0, 'HP_RECOVER', 'KILL_HP_RECOVERY', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55706, 23, 'Light as a Feather', 'AUTO', 180, 'FEATHER', '', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '44+ (k*0.455 + lv*0.1625)', '50 + (k*2.8 + lv*1)');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 1, 'Resistance (Warrior)', 'PASSIVE', 0, 'JIJOONG_WARRIOR', 'RESIST_WARRIOR', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 2, 'Resistance (Sura)', 'PASSIVE', 0, 'JIJOONG_SURA', 'RESIST_SURA', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 3, 'Resistance (Ninja)', 'PASSIVE', 0, 'JIJOONG_ASSASSIN', 'RESIST_ASSASSIN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 4, 'Resistance (Shaman)', 'PASSIVE', 0, 'JIJOONG_SHAMAN', 'RESIST_SHAMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 5, 'Resistance (Lycan)', 'PASSIVE', 0, 'JIJOONG_WOLFMAN', 'RESIST_WOLFMAN', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 6, 'Berserker', 'PASSIVE', 0, 'PACHEON', 'MELEE_MAGIC_ATT_BONUS_PER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 7, 'Anti-Magic', 'PASSIVE', 0, 'BANYA', 'RESIST_MAGIC_REDUCTION', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 8, 'Haste', 'PASSIVE', 0, 'CHEONRYEONG', 'CASTING_SPEED', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 9, 'Drill', 'PASSIVE', 0, 'CHOEHOENBIMU', 'PENETRATE_PCT', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 10, 'Restoration', 'AUTO', 480, 'HEAL', '', '706.6 + (k*222.579 + lv*79.4925)', '706.6 + (k*222.579 + lv*79.4925)', '713.3 + (k*224.689 + lv*80.2463)', '713.3 + (k*224.689 + lv*80.2463)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '58', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 11, 'Vampirism', 'PASSIVE', 0, 'STEALHP', 'STEAL_HP', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 12, 'Spiritualism', 'PASSIVE', 0, 'STEALMP', 'STEAL_SP', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 13, 'Bulwark', 'PASSIVE', 0, 'BLOCK', 'BLOCK', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 14, 'Reflection', 'PASSIVE', 0, 'REFLECT_MELEE', 'REFLECT_MELEE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 15, 'Yang Drop', 'PASSIVE', 0, 'GOLD_DROP', 'GOLD_DOUBLE_BONUS', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 16, 'Range', 'PASSIVE', 0, 'BOW_DISTANCE', 'BOW_DISTANCE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 17, 'Immortal', 'AUTO', 600, 'INVINCIBILITY', '', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.63 + lv*0.225)', '10 + (k*0.63 + lv*0.225)', '10 + (k*0.665 + lv*0.2375)', '10 + (k*0.665 + lv*0.2375)', '10 + (k*0.665 + lv*0.2375)', '10 + (k*0.665 + lv*0.2375)', '53', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 18, 'Panacea', 'AUTO', 480, 'REMOVAL', '', '0', '0', '0', '0', '0', '0', '0', '0', '41', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 19, 'Master Brewer', 'PASSIVE', 0, 'POTION', 'POTION_BONUS', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 20, 'Monster Hunter', 'PASSIVE', 0, 'MOB_BONUS', 'ATTBONUS_MONSTER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 21, 'Eagle Eyes', 'PASSIVE', 0, 'EXP', 'EXP_DOUBLE_BONUS', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 22, 'Life Drain', 'PASSIVE', 0, 'HP_RECOVER', 'KILL_HP_RECOVERY', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55707, 23, 'Light as a Feather', 'AUTO', 180, 'FEATHER', '', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '44+ (k*0.455 + lv*0.1625)', '50 + (k*2.8 + lv*1)');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 1, 'Resistance (Warrior)', 'PASSIVE', 0, 'JIJOONG_WARRIOR', 'RESIST_WARRIOR', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 2, 'Resistance (Sura)', 'PASSIVE', 0, 'JIJOONG_SURA', 'RESIST_SURA', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 3, 'Resistance (Ninja)', 'PASSIVE', 0, 'JIJOONG_ASSASSIN', 'RESIST_ASSASSIN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 4, 'Resistance (Shaman)', 'PASSIVE', 0, 'JIJOONG_SHAMAN', 'RESIST_SHAMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 5, 'Resistance (Lycan)', 'PASSIVE', 0, 'JIJOONG_WOLFMAN', 'RESIST_WOLFMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 6, 'Berserker', 'PASSIVE', 0, 'PACHEON', 'MELEE_MAGIC_ATT_BONUS_PER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.525 + lv*0.1875)', '1 + (k*0.525 + lv*0.1875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 7, 'Anti-Magic', 'PASSIVE', 0, 'BANYA', 'RESIST_MAGIC_REDUCTION', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 8, 'Haste', 'PASSIVE', 0, 'CHEONRYEONG', 'CASTING_SPEED', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 9, 'Drill', 'PASSIVE', 0, 'CHOEHOENBIMU', 'PENETRATE_PCT', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 10, 'Restoration', 'AUTO', 480, 'HEAL', '', '713.3 + (k*224.689 + lv*80.2463)', '713.3 + (k*224.689 + lv*80.2463)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '58', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 11, 'Vampirism', 'PASSIVE', 0, 'STEALHP', 'STEAL_HP', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 12, 'Spiritualism', 'PASSIVE', 0, 'STEALMP', 'STEAL_SP', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 13, 'Bulwark', 'PASSIVE', 0, 'BLOCK', 'BLOCK', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 14, 'Reflection', 'PASSIVE', 0, 'REFLECT_MELEE', 'REFLECT_MELEE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 15, 'Yang Drop', 'PASSIVE', 0, 'GOLD_DROP', 'GOLD_DOUBLE_BONUS', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 16, 'Range', 'PASSIVE', 0, 'BOW_DISTANCE', 'BOW_DISTANCE', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 17, 'Immortal', 'AUTO', 600, 'INVINCIBILITY', '', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '53', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 18, 'Panacea', 'AUTO', 480, 'REMOVAL', '', '0', '0', '0', '0', '0', '0', '0', '0', '41', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 19, 'Master Brewer', 'PASSIVE', 0, 'POTION', 'POTION_BONUS', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 20, 'Monster Hunter', 'PASSIVE', 0, 'MOB_BONUS', 'ATTBONUS_MONSTER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 21, 'Eagle Eyes', 'PASSIVE', 0, 'EXP', 'EXP_DOUBLE_BONUS', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 22, 'Life Drain', 'PASSIVE', 0, 'HP_RECOVER', 'KILL_HP_RECOVERY', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55708, 23, 'Light as a Feather', 'AUTO', 180, 'FEATHER', '', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '44+ (k*0.455 + lv*0.1625)', '50 + (k*2.8 + lv*1)');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 1, 'Resistance (Warrior)', 'PASSIVE', 0, 'JIJOONG_WARRIOR', 'RESIST_WARRIOR', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 2, 'Resistance (Sura)', 'PASSIVE', 0, 'JIJOONG_SURA', 'RESIST_SURA', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 3, 'Resistance (Ninja)', 'PASSIVE', 0, 'JIJOONG_ASSASSIN', 'RESIST_ASSASSIN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 4, 'Resistance (Shaman)', 'PASSIVE', 0, 'JIJOONG_SHAMAN', 'RESIST_SHAMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 5, 'Resistance (Lycan)', 'PASSIVE', 0, 'JIJOONG_WOLFMAN', 'RESIST_WOLFMAN', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 6, 'Berserker', 'PASSIVE', 0, 'PACHEON', 'MELEE_MAGIC_ATT_BONUS_PER', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 7, 'Anti-Magic', 'PASSIVE', 0, 'BANYA', 'RESIST_MAGIC_REDUCTION', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 8, 'Haste', 'PASSIVE', 0, 'CHEONRYEONG', 'CASTING_SPEED', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 9, 'Drill', 'PASSIVE', 0, 'CHOEHOENBIMU', 'PENETRATE_PCT', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 10, 'Restoration', 'AUTO', 480, 'HEAL', '', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '58', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 11, 'Vampirism', 'PASSIVE', 0, 'STEALHP', 'STEAL_HP', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 12, 'Spiritualism', 'PASSIVE', 0, 'STEALMP', 'STEAL_SP', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 13, 'Bulwark', 'PASSIVE', 0, 'BLOCK', 'BLOCK', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 14, 'Reflection', 'PASSIVE', 0, 'REFLECT_MELEE', 'REFLECT_MELEE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 15, 'Yang Drop', 'PASSIVE', 0, 'GOLD_DROP', 'GOLD_DOUBLE_BONUS', '10.8 + (k*3.402 + lv*1.215)', '10.8 + (k*3.402 + lv*1.215)', '11.2 + (k*3.528 + lv*1.26)', '11.2 + (k*3.528 + lv*1.26)', '11.6 + (k*3.654 + lv*1.305)', '11.6 + (k*3.654 + lv*1.305)', '11.6 + (k*3.654 + lv*1.305)', '11.6 + (k*3.654 + lv*1.305)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 16, 'Range', 'PASSIVE', 0, 'BOW_DISTANCE', 'BOW_DISTANCE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 17, 'Immortal', 'AUTO', 600, 'INVINCIBILITY', '', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '53', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 18, 'Panacea', 'AUTO', 480, 'REMOVAL', '', '0', '0', '0', '0', '0', '0', '0', '0', '41', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 19, 'Master Brewer', 'PASSIVE', 0, 'POTION', 'POTION_BONUS', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 20, 'Monster Hunter', 'PASSIVE', 0, 'MOB_BONUS', 'ATTBONUS_MONSTER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 21, 'Eagle Eyes', 'PASSIVE', 0, 'EXP', 'EXP_DOUBLE_BONUS', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 22, 'Life Drain', 'PASSIVE', 0, 'HP_RECOVER', 'KILL_HP_RECOVERY', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55709, 23, 'Light as a Feather', 'AUTO', 180, 'FEATHER', '', '187.5 + (k*6.5625 + lv*2.34375)', '187.5 + (k*6.5625 + lv*2.34375)', '287.5 + (k*10.0625 + lv*3.59375)', '287.5 + (k*10.0625 + lv*3.59375)', '287.5 + (k*10.0625 + lv*3.59375)', '387.5 + (k*13.5625 + lv*4.84375)', '387.5 + (k*13.5625 + lv*4.84375)', '387.5 + (k*13.5625 + lv*4.84375)', '44+ (k*0.455 + lv*0.1625)', '50 + (k*2.8 + lv*1)');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 1, 'Resistance (Warrior)', 'PASSIVE', 0, 'JIJOONG_WARRIOR', 'RESIST_WARRIOR', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 2, 'Resistance (Sura)', 'PASSIVE', 0, 'JIJOONG_SURA', 'RESIST_SURA', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 3, 'Resistance (Ninja)', 'PASSIVE', 0, 'JIJOONG_ASSASSIN', 'RESIST_ASSASSIN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 4, 'Resistance (Shaman)', 'PASSIVE', 0, 'JIJOONG_SHAMAN', 'RESIST_SHAMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 5, 'Resistance (Lycan)', 'PASSIVE', 0, 'JIJOONG_WOLFMAN', 'RESIST_WOLFMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 6, 'Berserker', 'PASSIVE', 0, 'PACHEON', 'MELEE_MAGIC_ATT_BONUS_PER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 7, 'Anti-Magic', 'PASSIVE', 0, 'BANYA', 'RESIST_MAGIC_REDUCTION', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 8, 'Haste', 'PASSIVE', 0, 'CHEONRYEONG', 'CASTING_SPEED', '1 + (k*0.63 + lv*0.225)', '1 + (k*0.63 + lv*0.225)', '1 + (k*0.665 + lv*0.2375)', '1 + (k*0.665 + lv*0.2375)', '1 + (k*0.735 + lv*0.2625)', '1 + (k*0.735 + lv*0.2625)', '1 + (k*0.735 + lv*0.2625)', '1 + (k*0.735 + lv*0.2625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 9, 'Drill', 'PASSIVE', 0, 'CHOEHOENBIMU', 'PENETRATE_PCT', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 10, 'Restoration', 'AUTO', 480, 'HEAL', '', '713.3 + (k*224.689 + lv*80.2463)', '713.3 + (k*224.689 + lv*80.2463)', '720 + (k*226.8 + lv*81)', '720 + (k*226.8 + lv*81)', '733.3 + (k*230.99 + lv*82.4963)', '720 + (k*226.8 + lv*81)', '733.3 + (k*230.99 + lv*82.4963)', '720 + (k*226.8 + lv*81)', '58', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 11, 'Vampirism', 'PASSIVE', 0, 'STEALHP', 'STEAL_HP', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 12, 'Spiritualism', 'PASSIVE', 0, 'STEALMP', 'STEAL_SP', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 13, 'Bulwark', 'PASSIVE', 0, 'BLOCK', 'BLOCK', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.49 + lv*0.175)', '1 + (k*0.49 + lv*0.175)', '1 + (k*0.49 + lv*0.175)', '1 + (k*0.49 + lv*0.175)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 14, 'Reflection', 'PASSIVE', 0, 'REFLECT_MELEE', 'REFLECT_MELEE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 15, 'Yang Drop', 'PASSIVE', 0, 'GOLD_DROP', 'GOLD_DOUBLE_BONUS', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '10.6 + (k*3.339 + lv*1.1925)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 16, 'Range', 'PASSIVE', 0, 'BOW_DISTANCE', 'BOW_DISTANCE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 17, 'Immortal', 'AUTO', 600, 'INVINCIBILITY', '', '10 + (k*0.63 + lv*0.225)', '10 + (k*0.63 + lv*0.225)', '10 + (k*0.665 + lv*0.2375)', '10 + (k*0.665 + lv*0.2375)', '10 + (k*0.7 + lv*0.25)', '10 + (k*0.7 + lv*0.25)', '10 + (k*0.7 + lv*0.25)', '10 + (k*0.7 + lv*0.25)', '53', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 18, 'Panacea', 'AUTO', 480, 'REMOVAL', '', '0', '0', '0', '0', '0', '0', '0', '0', '41', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 19, 'Master Brewer', 'PASSIVE', 0, 'POTION', 'POTION_BONUS', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 20, 'Monster Hunter', 'PASSIVE', 0, 'MOB_BONUS', 'ATTBONUS_MONSTER', '1 + (k*0.28 + lv*0.1)', '1 + (k*0.28 + lv*0.1)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 21, 'Eagle Eyes', 'PASSIVE', 0, 'EXP', 'EXP_DOUBLE_BONUS', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 22, 'Life Drain', 'PASSIVE', 0, 'HP_RECOVER', 'KILL_HP_RECOVERY', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55710, 23, 'Light as a Feather', 'AUTO', 180, 'FEATHER', '', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '150 + (k*5.25 + lv*1.875)', '44+ (k*0.455 + lv*0.1625)', '50 + (k*2.8 + lv*1)');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 1, 'Resistance (Warrior)', 'PASSIVE', 0, 'JIJOONG_WARRIOR', 'RESIST_WARRIOR', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 2, 'Resistance (Sura)', 'PASSIVE', 0, 'JIJOONG_SURA', 'RESIST_SURA', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 3, 'Resistance (Ninja)', 'PASSIVE', 0, 'JIJOONG_ASSASSIN', 'RESIST_ASSASSIN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 4, 'Resistance (Shaman)', 'PASSIVE', 0, 'JIJOONG_SHAMAN', 'RESIST_SHAMAN', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 5, 'Resistance (Lycan)', 'PASSIVE', 0, 'JIJOONG_WOLFMAN', 'RESIST_WOLFMAN', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '1 + (k*0.455 + lv*0.1625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 6, 'Berserker', 'PASSIVE', 0, 'PACHEON', 'MELEE_MAGIC_ATT_BONUS_PER', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.35 + lv*0.125)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '1 + (k*0.42 + lv*0.15)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 7, 'Anti-Magic', 'PASSIVE', 0, 'BANYA', 'RESIST_MAGIC_REDUCTION', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 8, 'Haste', 'PASSIVE', 0, 'CHEONRYEONG', 'CASTING_SPEED', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '1 + (k*0.595 + lv*0.2125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 9, 'Drill', 'PASSIVE', 0, 'CHOEHOENBIMU', 'PENETRATE_PCT', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 10, 'Restoration', 'AUTO', 480, 'HEAL', '', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '700 + (k*220.5 + lv*78.75)', '58', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 11, 'Vampirism', 'PASSIVE', 0, 'STEALHP', 'STEAL_HP', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 12, 'Spiritualism', 'PASSIVE', 0, 'STEALMP', 'STEAL_SP', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.21 + lv*0.075)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 13, 'Bulwark', 'PASSIVE', 0, 'BLOCK', 'BLOCK', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '1 + (k*0.385 + lv*0.1375)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 14, 'Reflection', 'PASSIVE', 0, 'REFLECT_MELEE', 'REFLECT_MELEE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 15, 'Yang Drop', 'PASSIVE', 0, 'GOLD_DROP', 'GOLD_DOUBLE_BONUS', '10.8 + (k*3.402 + lv*1.215)', '10.8 + (k*3.402 + lv*1.215)', '11.2 + (k*3.528 + lv*1.26)', '11.2 + (k*3.528 + lv*1.26)', '11.6 + (k*3.654 + lv*1.305)', '11.6 + (k*3.654 + lv*1.305)', '11.6 + (k*3.654 + lv*1.305)', '11.6 + (k*3.654 + lv*1.305)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 16, 'Range', 'PASSIVE', 0, 'BOW_DISTANCE', 'BOW_DISTANCE', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 17, 'Immortal', 'AUTO', 600, 'INVINCIBILITY', '', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '10 + (k*0.595 + lv*0.2125)', '53', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 18, 'Panacea', 'AUTO', 480, 'REMOVAL', '', '0', '0', '0', '0', '0', '0', '0', '0', '41', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 19, 'Master Brewer', 'PASSIVE', 0, 'POTION', 'POTION_BONUS', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '1 + (k*0.315 + lv*0.1125)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 20, 'Monster Hunter', 'PASSIVE', 0, 'MOB_BONUS', 'ATTBONUS_MONSTER', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '1 + (k*0.245 + lv*0.0875)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 21, 'Eagle Eyes', 'PASSIVE', 0, 'EXP', 'EXP_DOUBLE_BONUS', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 22, 'Life Drain', 'PASSIVE', 0, 'HP_RECOVER', 'KILL_HP_RECOVERY', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '1 + (k*0.175 + lv*0.0625)', '0', '0');
+INSERT INTO `growth_pet_skill_proto` VALUES (55711, 23, 'Light as a Feather', 'AUTO', 180, 'FEATHER', '', '187.5 + (k*6.5625 + lv*2.34375)', '187.5 + (k*6.5625 + lv*2.34375)', '287.5 + (k*10.0625 + lv*3.59375)', '287.5 + (k*10.0625 + lv*3.59375)', '287.5 + (k*10.0625 + lv*3.59375)', '387.5 + (k*13.5625 + lv*4.84375)', '387.5 + (k*13.5625 + lv*4.84375)', '387.5 + (k*13.5625 + lv*4.84375)', '44+ (k*0.455 + lv*0.1625)', '50 + (k*2.8 + lv*1)');
+
+SET FOREIGN_KEY_CHECKS = 1;
