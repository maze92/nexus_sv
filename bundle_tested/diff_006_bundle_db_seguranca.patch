--- a/server/metin2/Source/Server/db/src/ClientManager.cpp
+++ b/server/metin2/Source/Server/db/src/ClientManager.cpp
@@ -1,3 +1,4 @@
+#include <string>

 #include "stdafx.h"

 

 #include "../../common/building.h"

@@ -23,6 +24,7 @@
 #include <sstream>

 #if defined(__SHOP_SEARCH__)

 	#include "ShopSearchManager.h"

+#include <string.h>

 #endif

 

 extern int g_iPlayerCacheFlushSeconds;

@@ -202,7 +204,7 @@
 	LoadGuildEventFlag();

 #endif

 

-	// database character-setÀ» °­Á¦·Î ¸ÂÃã

+	// database character-set  

 	if (g_stLocale == "big5" || g_stLocale == "sjis")

 		CDBManager::instance().QueryLocaleSet();

 

@@ -215,7 +217,7 @@
 

 	sys_log(0, "ClientManager pointer is %p", this);

 

-	// ¸ÞÀÎ·çÇÁ

+	// η

 	while (!m_bShutdowned)

 	{

 		while ((tmp = CDBManager::instance().PopResult()))

@@ -231,7 +233,7 @@
 	}

 

 	//

-	// ¸ÞÀÎ·çÇÁ Á¾·áÃ³¸®

+	// η ó

 	//

 	sys_log(0, "MainLoop exited, Starting cache flushing");

 

@@ -250,7 +252,7 @@
 

 	signal_timer_disable();

 

-	// ÇÃ·¹ÀÌ¾î Å×ÀÌºí Ä³½¬ ÇÃ·¯½¬

+	// ÷̾ ̺ ĳ ÷

 	auto it = m_map_playerCache.begin();

 	while (it != m_map_playerCache.end())

 	{

@@ -261,7 +263,7 @@
 	}

 	m_map_playerCache.clear();

 

-	// ¾ÆÀÌÅÛ ÇÃ·¯½¬

+	//  ÷

 	auto it2 = m_map_itemCache.begin();

 	while (it2 != m_map_itemCache.end())

 	{

@@ -274,7 +276,7 @@
 

 	// MYSHOP_PRICE_LIST

 	//

-	// °³ÀÎ»óÁ¡ ¾ÆÀÌÅÛ °¡°Ý ¸®½ºÆ® Flush

+	// λ   Ʈ Flush

 	//

 	for (auto itPriceList = m_mapItemPriceListCache.begin(); itPriceList != m_mapItemPriceListCache.end(); ++itPriceList)

 	{

@@ -311,7 +313,7 @@
 

 void CClientManager::QUERY_BOOT(CPeer* peer, TPacketGDBoot* p)

 {

-	const BYTE bPacketVersion = 6; // BOOT ÆÐÅ¶ÀÌ ¹Ù²ð¶§¸¶´Ù ¹øÈ£¸¦ ¿Ã¸®µµ·Ï ÇÑ´Ù.

+	const BYTE bPacketVersion = 6; // BOOT Ŷ ٲ𶧸 ȣ ø Ѵ.

 

 	std::vector<tAdminInfo> vAdmin;

 	std::vector<std::string> vHost;

@@ -528,7 +530,7 @@
 	pkPeer->SetUserCount(pPacket->dwCount);

 }

 

-void CClientManager::QUERY_QUEST_SAVE(CPeer* pkPeer, TQuestTable* pTable, DWORD dwLen)

+void CClientManager::QUERY_QUEST_SAVE(LPPEER pPeer, TQuestTable* pTable, DWORD dwLen)

 {

 	if (0 != (dwLen % sizeof(TQuestTable)))

 	{

@@ -542,15 +544,24 @@
 

 	for (int i = 0; i < iSize; ++i, ++pTable)

 	{

+		char escName[sizeof(pTable->szName) * 2 + 1];

+		char escState[sizeof(pTable->szState) * 2 + 1];

+

+		const size_t nameLen = strnlen(pTable->szName, sizeof(pTable->szName));

+		const size_t stateLen = strnlen(pTable->szState, sizeof(pTable->szState));

+

+		CDBManager::instance().EscapeString(escName, pTable->szName, static_cast<unsigned long>(nameLen));

+		CDBManager::instance().EscapeString(escState, pTable->szState, static_cast<unsigned long>(stateLen));

+

 		if (pTable->lValue == 0)

 		{

 			snprintf(szQuery, sizeof(szQuery), "DELETE FROM quest%s WHERE `dwPID` = %d AND `szName` = '%s' AND `szState` ='%s'",

-				GetTablePostfix(), pTable->dwPID, pTable->szName, pTable->szState);

+				GetTablePostfix(), pTable->dwPID, escName, escState);

 		}

 		else

 		{

 			snprintf(szQuery, sizeof(szQuery), "REPLACE INTO quest%s (`dwPID`, `szName`, `szState`, `lValue`) VALUES(%d, '%s', '%s', %ld)",

-				GetTablePostfix(), pTable->dwPID, pTable->szName, pTable->szState, pTable->lValue);

+				GetTablePostfix(), pTable->dwPID, escName, escState, pTable->lValue);

 		}

 

 		CDBManager::instance().ReturnQuery(szQuery, QID_QUEST_SAVE, pkPeer->GetHandle(), NULL);

@@ -567,6 +578,13 @@
 	strlcpy(pi->login, packet->szLogin, sizeof(pi->login));

 

 	char szQuery[QUERY_MAX_LEN];

+

+	// Hardening: Escape name/state to prevent SQL break / injection via quotes.

+	char escName[(CHARACTER_NAME_MAX_LEN + 1) * 2 + 1];

+	char escState[64 * 2 + 1];

+

+	DBManager::instance().EscapeString(escName, sizeof(escName), pTable->szName, strnlen(pTable->szName, sizeof(pTable->szName)));

+	DBManager::instance().EscapeString(escState, sizeof(escState), pTable->szState, strnlen(pTable->szState, sizeof(pTable->szState)));

 	snprintf(szQuery, sizeof(szQuery),

 		"SELECT `account_id`, `size`, `password` FROM safebox%s WHERE `account_id` = %u",

 		GetTablePostfix(), packet->dwID);

@@ -585,9 +603,9 @@
 	ClientHandleInfo* pi = (ClientHandleInfo*)qi->pvData;

 	DWORD dwHandle = pi->dwHandle;

 

-	// ¿©±â¿¡¼­ »ç¿ëÇÏ´Â account_index´Â Äõ¸® ¼ø¼­¸¦ ¸»ÇÑ´Ù.

-	// Ã¹¹øÂ° ÆÐ½º¿öµå ¾Ë¾Æ³»±â À§ÇØ ÇÏ´Â Äõ¸®°¡ 0

-	// µÎ¹øÂ° ½ÇÁ¦ µ¥ÀÌÅÍ¸¦ ¾ò¾î³õ´Â Äõ¸®°¡ 1

+	// ⿡ ϴ account_index   Ѵ.

+	// ù° н ˾Ƴ  ϴ  0

+	// ι°  ͸   1

 

 	if (pi->account_index == 0)

 	{

@@ -617,7 +635,7 @@
 

 			MYSQL_ROW row = mysql_fetch_row(res->pSQLResult);

 

-			// ºñ¹Ð¹øÈ£°¡ Æ²¸®¸é..

+			// йȣ Ʋ..

 			if (((!row[2] || !*row[2]) && strcmp("000000", szSafeboxPassword)) ||

 				((row[2] && *row[2]) && strcmp(row[2], szSafeboxPassword)))

 			{

@@ -713,8 +731,8 @@
 			return;

 		}

 

-		// Äõ¸®¿¡ ¿¡·¯°¡ ÀÖ¾úÀ¸¹Ç·Î ÀÀ´äÇÒ °æ¿ì Ã¢°í°¡ ºñ¾îÀÖ´Â °Í Ã³·³

-		// º¸ÀÌ±â ¶§¹®¿¡ Ã¢°í°¡ ¾Æ¾ê ¾È¿­¸®´Â°Ô ³ªÀ½

+		//   ־Ƿ   â ִ  ó

+		// ̱  â ƾ ȿ° 

 		if (!msg->Get()->pSQLResult)

 		{

 			sys_err("null safebox result");

@@ -839,8 +857,8 @@
 						{

 							case 72723: case 72724: case 72725: case 72726:

 							case 72727: case 72728: case 72729: case 72730:

-								// ¹«½Ã¹«½ÃÇÏÁö¸¸ ÀÌÀü¿¡ ÇÏ´ø °É °íÄ¡±â´Â ¹«¼·°í...

-								// ±×·¡¼­ ±×³É ÇÏµå ÄÚµù. ¼±¹° »óÀÚ¿ë ÀÚµ¿¹°¾à ¾ÆÀÌÅÛµé.

+								// ù  ϴ  ġ ...

+								// ׷ ׳ ϵ ڵ.  ڿ ڵ ۵.

 							case 76004: case 76005: case 76021: case 76022:

 							case 79012: case 79013:

 								if (pItemAward->dwSocket2 == 0)

@@ -1104,7 +1122,7 @@
 void CClientManager::QUERY_SAFEBOX_CHANGE_SIZE(CPeer* pkPeer, DWORD dwHandle, TSafeboxChangeSizePacket* p)

 {

 	ClientHandleInfo* pi = new ClientHandleInfo(dwHandle);

-	pi->account_index = p->bSize; // account_index¸¦ »çÀÌÁî·Î ÀÓ½Ã·Î »ç¿ë

+	pi->account_index = p->bSize; // account_index  ӽ÷ 

 

 	char szQuery[QUERY_MAX_LEN];

 

@@ -1192,7 +1210,7 @@
 	TItemPricelistReqInfo* pReqInfo = (TItemPricelistReqInfo*)static_cast<CQueryInfo*>(pMsg->pvUserData)->pvData;

 

 	//

-	// DB ¿¡¼­ ·ÎµåÇÑ Á¤º¸¸¦ Cache ¿¡ ÀúÀå

+	// DB  ε  Cache  

 	//

 

 	TItemPriceListTable table;

@@ -1214,7 +1232,7 @@
 	PutItemPriceListCache(&table);

 

 	//

-	// ·ÎµåÇÑ µ¥ÀÌÅÍ¸¦ Game server ¿¡ Àü¼Û

+	// ε ͸ Game server  

 	//

 

 	TPacketMyshopPricelistHeader header;

@@ -1238,7 +1256,7 @@
 	TItemPriceListTable* pUpdateTable = (TItemPriceListTable*)static_cast<CQueryInfo*>(pMsg->pvUserData)->pvData;

 

 	//

-	// DB ¿¡¼­ ·ÎµåÇÑ Á¤º¸¸¦ Cache ¿¡ ÀúÀå

+	// DB  ε  Cache  

 	//

 

 	TItemPriceListTable table{};

@@ -1310,18 +1328,18 @@
 			UINT g_start_map[4] =

 			{

 				0, // reserved

-				1, // ½Å¼ö±¹

-				21, // ÃµÁ¶±¹

-				41 // Áø³ë±¹

+				1, // ż

+				21, // õ

+				41 // 뱹

 			};

 

 			// FIXME share with game

 			DWORD g_start_position[4][2] =

 			{

 				{ 0, 0 },

-				{ 469300, 964200 }, // ½Å¼ö±¹

-				{ 55700, 157900 }, // ÃµÁ¶±¹

-				{ 969600, 278400 } // Áø³ë±¹

+				{ 469300, 964200 }, // ż

+				{ 55700, 157900 }, // õ

+				{ 969600, 278400 } // 뱹

 			};

 

 			for (int i = 0; i < 3; ++i)

@@ -1371,7 +1389,7 @@
 	peer->SetMaps(p->alMaps);

 

 	//

-	// ¾î¶² ¸ÊÀÌ ¾î¶² ¼­¹ö¿¡ ÀÖ´ÂÁö º¸³»±â

+	//     ִ 

 	//

 	TMapLocation kMapLocations;

 

@@ -1481,7 +1499,7 @@
 	peer->Encode(&vec_kMapLocations[0], sizeof(TMapLocation) * vec_kMapLocations.size());

 

 	//

-	// ¼Â¾÷ : Á¢¼ÓÇÑ ÇÇ¾î¿¡ ´Ù¸¥ ÇÇ¾îµéÀÌ Á¢¼ÓÇÏ°Ô ¸¸µç´Ù. (P2P ÄÁ³Ø¼Ç »ý¼º)

+	// ¾ :  Ǿ ٸ Ǿ ϰ . (P2P ؼ )

 	//

 	sys_log(0, "SETUP: channel %u listen %u p2p %u count %u", peer->GetChannel(), p->wListenPort, p->wP2PPort, bMapCount);

 

@@ -1498,7 +1516,7 @@
 		if (tmp == peer)

 			continue;

 

-		// Ã¤³ÎÀÌ 0ÀÌ¶ó¸é ¾ÆÁ÷ SETUP ÆÐÅ¶ÀÌ ¿ÀÁö ¾ÊÀº ÇÇ¾î ¶Ç´Â auth¶ó°í °£ÁÖÇÒ ¼ö ÀÖÀ½

+		// ä 0̶  SETUP Ŷ   Ǿ Ǵ auth   

 		if (0 == tmp->GetChannel())

 			continue;

 

@@ -1507,7 +1525,7 @@
 	}

 

 	//

-	// ·Î±×ÀÎ ¹× ºô¸µÁ¤º¸ º¸³»±â

+	// α   

 	//

 	TPacketLoginOnSetup* pck = (TPacketLoginOnSetup*)c_pData;

 

@@ -1570,7 +1588,7 @@
 {

 	TPlayerItem* p = (TPlayerItem*)c_pData;

 

-	// Ã¢°í¸é Ä³½¬ÇÏÁö ¾Ê°í, Ä³½¬¿¡ ÀÖ´ø °Íµµ »©¹ö·Á¾ß ÇÑ´Ù.

+	// â ĳ ʰ, ĳ ִ ͵  Ѵ.

 

 	if (p->bWindow == SAFEBOX || p->bWindow == MALL

 	)

@@ -1783,7 +1801,7 @@
 

 	c = GetItemCache(pNew->dwID);

 

-	// ¾ÆÀÌÅÛ »õ·Î »ý¼º

+	//   

 	if (!c)

 	{

 		if (g_log)

@@ -1792,16 +1810,16 @@
 		c = new CItemCache;

 		m_map_itemCache.insert(TItemCacheMap::value_type(pNew->dwID, c));

 	}

-	// ÀÖÀ»½Ã

+	// 

 	else

 	{

 		if (g_log)

 			sys_log(0, "ITEM_CACHE: PutItemCache ==> Have Cache");

 

-		// ¼ÒÀ¯ÀÚ°¡ Æ²¸®¸é

+		// ڰ Ʋ

 		if (pNew->dwOwner != c->Get()->dwOwner)

 		{

-			// ÀÌ¹Ì ÀÌ ¾ÆÀÌÅÛÀ» °¡Áö°í ÀÖ¾ú´ø À¯Àú·Î ºÎÅÍ ¾ÆÀÌÅÛÀ» »èÁ¦ÇÑ´Ù.

+			// ̹    ־    Ѵ.

 			TItemCacheSetPtrMap::iterator it = m_map_pkItemCacheSetPtr.find(c->Get()->dwOwner);

 

 			if (it != m_map_pkItemCacheSetPtr.end())

@@ -1813,7 +1831,7 @@
 		}

 	}

 

-	// »õ·Î¿î Á¤º¸ ¾÷µ¥ÀÌÆ®

+	// ο  Ʈ

 	c->Put(pNew, bSkipQuery);

 

 	TItemCacheSetPtrMap::iterator it = m_map_pkItemCacheSetPtr.find(c->Get()->dwOwner);

@@ -1828,8 +1846,8 @@
 	}

 	else

 	{

-		// ÇöÀç ¼ÒÀ¯ÀÚ°¡ ¾øÀ¸¹Ç·Î ¹Ù·Î ÀúÀåÇØ¾ß ´ÙÀ½ Á¢¼ÓÀÌ ¿Ã ¶§ SQL¿¡ Äõ¸®ÇÏ¿©

-		// ¹ÞÀ» ¼ö ÀÖÀ¸¹Ç·Î ¹Ù·Î ÀúÀåÇÑ´Ù.

+		//  ڰ Ƿ ٷ ؾ     SQL Ͽ

+		//   Ƿ ٷ Ѵ.

 		if (g_log)

 			sys_log(0, "ITEM_CACHE: direct save %u id %u", c->Get()->dwOwner, c->Get()->dwID);

 		else

@@ -1889,7 +1907,7 @@
 

 			c->Flush();

 

-			// Item Cacheµµ ¾÷µ¥ÀÌÆ®

+			// Item Cache Ʈ

 			UpdateItemCacheSet(c->Get()->id);

 #ifdef __GROWTH_PET_SYSTEM__

 			UpdateGrowthPetCacheSet(c->Get()->id);

@@ -1918,7 +1936,7 @@
 	{

 		CItemCache* c = (it++)->second;

 

-		// ¾ÆÀÌÅÛÀº Flush¸¸ ÇÑ´Ù.

+		//  Flush Ѵ.

 		if (c->CheckFlushTimeout())

 		{

 			if (g_test_server)

@@ -1965,7 +1983,7 @@
 		if (g_log)

 			sys_log(0, "HEADER_GD_ITEM_DESTROY: PID %u ID %u", dwPID, dwID);

 

-		if (dwPID == 0) // ¾Æ¹«µµ °¡Áø »ç¶÷ÀÌ ¾ø¾ú´Ù¸é, ºñµ¿±â Äõ¸®

+		if (dwPID == 0) // ƹ   ٸ, 񵿱 

 			CDBManager::instance().AsyncQuery(szQuery);

 		else

 			CDBManager::instance().ReturnQuery(szQuery, QID_ITEM_DESTROY, pkPeer->GetHandle(), NULL);

@@ -2042,7 +2060,7 @@
 

 // ADD_GUILD_PRIV_TIME

 /**

-* @version 05/06/08 Bang2ni - Áö¼Ó½Ã°£ Ãß°¡

+* @version 05/06/08 Bang2ni - ӽð ߰

 **/

 void CClientManager::AddGuildPriv(TPacketGiveGuildPriv* p)

 {

@@ -2302,10 +2320,16 @@
 {

 	char szQuery[256];

 

+	char escName[sizeof(p->szName) * 2 + 1];

+	const size_t nameLen = strnlen(p->szName, sizeof(p->szName));

+	CDBManager::instance().EscapeString(escName, p->szName, static_cast<unsigned long>(nameLen));

+

 	if (g_stLocale == "sjis")

-		snprintf(szQuery, sizeof(szQuery), "SELECT `id `FROM player%s WHERE `name` = '%s' COLLATE sjis_japanese_ci", GetTablePostfix(), p->szName);

+		snprintf(szQuery, sizeof(szQuery), "SELECT `id `FROM player%s WHERE `name` = '%s' COLLATE sjis_japanese_ci",

+			GetTablePostfix(), escName);

 	else

-		snprintf(szQuery, sizeof(szQuery), "SELECT `id` FROM player%s WHERE `name` = '%s'", GetTablePostfix(), p->szName);

+		snprintf(szQuery, sizeof(szQuery), "SELECT `id` FROM player%s WHERE `name` = '%s'",

+			GetTablePostfix(), escName);

 	std::unique_ptr<SQLMsg> pmsg(CDBManager::instance().DirectQuery(szQuery));

 	SQLResult* pRes = pmsg->Get();

 

@@ -2370,8 +2394,8 @@
 }

 

 //

-// Ä³½Ã¿¡ °¡°ÝÁ¤º¸°¡ ÀÖÀ¸¸é Ä³½Ã¸¦ ¾÷µ¥ÀÌÆ® ÇÏ°í Ä³½Ã¿¡ °¡°ÝÁ¤º¸°¡ ¾ø´Ù¸é

-// ¿ì¼± ±âÁ¸ÀÇ µ¥ÀÌÅÍ¸¦ ·ÎµåÇÑ µÚ¿¡ ±âÁ¸ÀÇ Á¤º¸·Î Ä³½Ã¸¦ ¸¸µé°í »õ·Î ¹ÞÀº °¡°ÝÁ¤º¸¸¦ ¾÷µ¥ÀÌÆ® ÇÑ´Ù.

+// ĳÿ   ĳø Ʈ ϰ ĳÿ  ٸ

+// 켱  ͸ ε ڿ   ĳø     Ʈ Ѵ.

 //

 void CClientManager::MyshopPricelistUpdate(const TItemPriceListTable* pPacket)

 {

@@ -2415,7 +2439,7 @@
 }

 

 // MYSHOP_PRICE_LIST

-// Ä³½ÃµÈ °¡°ÝÁ¤º¸°¡ ÀÖÀ¸¸é Ä³½Ã¸¦ ÀÐ¾î ¹Ù·Î Àü¼ÛÇÏ°í Ä³½Ã¿¡ Á¤º¸°¡ ¾øÀ¸¸é DB ¿¡ Äõ¸®¸¦ ÇÑ´Ù.

+// ĳõ   ĳø о ٷ ϰ ĳÿ   DB   Ѵ.

 //

 void CClientManager::MyshopPricelistRequest(CPeer* peer, DWORD dwHandle, DWORD dwPlayerID)

 {

@@ -2821,15 +2845,15 @@
 				ComeToVote(peer, dwHandle, data);

 				break;

 

-			case HEADER_GD_RMCANDIDACY: ///< ÈÄº¸ Á¦°Å (¿î¿µÀÚ)

+			case HEADER_GD_RMCANDIDACY: ///< ĺ  ()

 				RMCandidacy(peer, dwHandle, data);

 				break;

 

-			case HEADER_GD_SETMONARCH: ///< ±ºÁÖ¼³Á¤ (¿î¿µÀÚ)

+			case HEADER_GD_SETMONARCH: ///< ּ ()

 				SetMonarch(peer, dwHandle, data);

 				break;

 

-			case HEADER_GD_RMMONARCH: ///< ±ºÁÖ»èÁ¦

+			case HEADER_GD_RMMONARCH: ///< ֻ

 				RMMonarch(peer, dwHandle, data);

 				break;

 				// END_MONARCH

@@ -3109,9 +3133,9 @@
 	return m_peerList.front();

 }

 

-// DB ¸Å´ÏÀú·Î ºÎÅÍ ¹ÞÀº °á°ú¸¦ Ã³¸®ÇÑ´Ù.

+// DB Ŵ    óѴ.

 //

-// @version	05/06/10 Bang2ni - °¡°ÝÁ¤º¸ °ü·Ã Äõ¸®(QID_ITEMPRICE_XXX) Ãß°¡

+// @version	05/06/10 Bang2ni -   (QID_ITEMPRICE_XXX) ߰

 int CClientManager::AnalyzeQueryResult(SQLMsg* msg)

 {

 	CQueryInfo* qi = (CQueryInfo*)msg->pvUserData;

@@ -3240,7 +3264,7 @@
 	char* time_s;

 	struct tm lt;

 

-	int avg = g_dwUsageAvg / 3600; // 60 ÃÊ * 60 ºÐ

+	int avg = g_dwUsageAvg / 3600; // 60  * 60 

 

 	fp = fopen("usage.txt", "a+");

 

@@ -3273,7 +3297,7 @@
 		++thecore_heart->pulse;

 

 		/*

-		// 30ºÐ¸¶´Ù º¯°æ

+		// 30и 

 		if (((thecore_pulse() % (60 * 30 * 10)) == 0))

 		{

 			g_iPlayerCacheFlushSeconds = MAX(60, rand() % 180);

@@ -3364,11 +3388,11 @@
 

 			m_iCacheFlushCount = 0;

 

-			// ÇÃ·¹ÀÌ¾î ÇÃ·¯½¬

+			// ÷̾ ÷

 			UpdatePlayerCache();

-			// ¾ÆÀÌÅÛ ÇÃ·¯½¬

+			//  ÷

 			UpdateItemCache();

-			//·Î±×¾Æ¿ô½Ã Ã³¸®- Ä³½¬¼Â ÇÃ·¯½¬

+			//α׾ƿ ó- ĳ ÷

 			UpdateLogoutPlayer();

 

 			// MYSHOP_PRICE_LIST

@@ -3446,13 +3470,13 @@
 			/////////////////////////////////////////////////////////////////

 		}

 

-		if (!(thecore_heart->pulse % (thecore_heart->passes_per_sec * 60))) // 60ÃÊ¿¡ ÇÑ¹ø

-		{

-			// À¯´ÏÅ© ¾ÆÀÌÅÛÀ» À§ÇÑ ½Ã°£À» º¸³½´Ù.

+		if (!(thecore_heart->pulse % (thecore_heart->passes_per_sec * 60))) // 60ʿ ѹ

+		{

+			// ũ   ð .

 			CClientManager::instance().SendTime();

 		}

 

-		if (!(thecore_heart->pulse % (thecore_heart->passes_per_sec * 3600))) // ÇÑ½Ã°£¿¡ ÇÑ¹ø

+		if (!(thecore_heart->pulse % (thecore_heart->passes_per_sec * 3600))) // ѽð ѹ

 		{

 			CMoneyLog::instance().Save();

 		}

@@ -3471,7 +3495,7 @@
 	int idx;

 	CPeer* peer;

 

-	for (idx = 0; idx < num_events; ++idx) // ÀÎÇ²

+	for (idx = 0; idx < num_events; ++idx) // ǲ

 	{

 		peer = (CPeer*)fdwatch_get_client_data(m_fdWatcher, idx);

 

@@ -3552,7 +3576,7 @@
 

 DWORD CClientManager::GetUserCount()

 {

-	// ´Ü¼øÈ÷ ·Î±×ÀÎ Ä«¿îÆ®¸¦ ¼¾´Ù.. --;

+	// ܼ α īƮ .. --;

 	return m_map_kLogonAccount.size();

 }

 

@@ -3613,7 +3637,7 @@
 {

 	DWORD dwMin, dwMax;

 

-	// ¾ÆÀÌÅÛ ID¸¦ ÃÊ±âÈ­ ÇÑ´Ù.

+	//  ID ʱȭ Ѵ.

 	if (!CConfig::instance().GetTwoValue("ITEM_ID_RANGE", &dwMin, &dwMax))

 	{

 		sys_err("config.txt: Cannot find ITEM_ID_RANGE [start_item_id] [end_item_id]");

@@ -4053,7 +4077,7 @@
 // ADMIN_MANAGER

 bool CClientManager::__GetAdminInfo(const char* szIP, std::vector<tAdminInfo>& rAdminVec)

 {

-	// szIP == NULL ÀÏ°æ¿ì ¸ðµç¼­¹ö¿¡ ¿î¿µÀÚ ±ÇÇÑÀ» °®´Â´Ù.

+	// szIP == NULL ϰ 缭   ´.

 	char szQuery[512];

 	snprintf(szQuery, sizeof(szQuery),

 		"SELECT `mID`, `mAccount`, `mName`, `mContactIP`, `mServerIP`, `mAuthority` FROM `gmlist` WHERE `mServerIP` = 'ALL' OR `mServerIP` = '%s'",

@@ -4603,6 +4627,12 @@
 {

 	sys_log(0, "[BLOCK_EXCEPTION] CMD(%d) login(%s)", data->cmd, data->login);

 

+	char login[LOGIN_MAX_LEN + 1] = {0};

+	trim_and_lower(data->login, login, sizeof(login));

+

+	char loginEsc[LOGIN_MAX_LEN * 2 + 1] = {0};

+	CDBManager::instance().EscapeString(loginEsc, login, strlen(login), SQL_ACCOUNT);

+

 	// save sql

 	{

 		char buf[1024];

@@ -4610,14 +4640,18 @@
 		switch (data->cmd)

 		{

 			case BLOCK_EXCEPTION_CMD_ADD:

-				snprintf(buf, sizeof(buf), "INSERT INTO `block_exception` VALUES('%s')", data->login);

+				snprintf(buf, sizeof(buf),

+					"INSERT INTO `block_exception` (`login`) VALUES ('%s')",

+					loginEsc);

 				CDBManager::instance().AsyncQuery(buf, SQL_ACCOUNT);

-				CBlockCountry::instance().AddBlockException(data->login);

+				CBlockCountry::instance().AddBlockException(login);

 				break;

 			case BLOCK_EXCEPTION_CMD_DEL:

-				snprintf(buf, sizeof(buf), "DELETE FROM `block_exception` WHERE `login` = %s", data->login);

+				snprintf(buf, sizeof(buf),

+					"DELETE FROM `block_exception` WHERE `login` = '%s'",

+					loginEsc);

 				CDBManager::instance().AsyncQuery(buf, SQL_ACCOUNT);

-				CBlockCountry::instance().DelBlockException(data->login);

+				CBlockCountry::instance().DelBlockException(login);

 				break;

 			default:

 				return;

@@ -4632,7 +4666,7 @@
 		if (!peer->GetChannel())

 			continue;

 

-		CBlockCountry::instance().SendBlockExceptionOne(peer, data->login, data->cmd);

+		CBlockCountry::instance().SendBlockExceptionOne(peer, login, data->cmd);

 	}

 }

 

@@ -4642,7 +4676,7 @@
 }

 

 //

-// Login Key¸¸ ¸Ê¿¡¼­ Áö¿î´Ù.

+// Login Key ʿ .

 //

 void CClientManager::DeleteLoginKey(TPacketDC* data)

 {

@@ -4719,9 +4753,9 @@
 	char szQuery[512];

 

 	if (ERequestCharge_Cash == packet->eChargeType)

-		sprintf(szQuery, "update account set `cash` = `cash` + %d where id = %d limit 1", packet->dwAmount, packet->dwAID);

+		snprintf(szQuery, sizeof(szQuery), "update account set `cash` = `cash` + %d where id = %d limit 1", packet->dwAmount, packet->dwAID);

 	else if (ERequestCharge_Mileage == packet->eChargeType)

-		sprintf(szQuery, "update account set `mileage` = `mileage` + %d where id = %d limit 1", packet->dwAmount, packet->dwAID);

+		snprintf(szQuery, sizeof(szQuery), "update account set `mileage` = `mileage` + %d where id = %d limit 1", packet->dwAmount, packet->dwAID);

 	else

 	{

 		sys_err("Invalid request charge type (type : %d, amount : %d, aid : %d)", packet->eChargeType, packet->dwAmount, packet->dwAID);

@@ -4808,7 +4842,7 @@
 			if ((it != m_map_lEventFlag.end() && it->second == val) == false)

 			{

 				TPacketSetEventFlag p;

-				std::strcpy(p.szFlagName, flag);

+				strlcpy(p.szFlagName, flag, sizeof(p.szFlagName));

 				p.lValue = val;

 				SetEventFlag(&p);

 			}

@@ -5011,9 +5045,15 @@
 

 	if (bFound == false)

 	{

-		char s_szQuery[128];

+		char escName[sizeof(p->szName) * 2 + 1];

+		const size_t nameLen = strnlen(p->szName, sizeof(p->szName));

+		CDBManager::instance().EscapeString(escName, p->szName, static_cast<unsigned long>(nameLen));

+

+		char s_szQuery[256];

 		//snprintf(s_szQuery, sizeof(s_szQuery), "SELECT * FROM player%s WHERE `name` = '%s' LIMIT 1", GetTablePostfix(), p->szName);

-		snprintf(s_szQuery, sizeof(s_szQuery), "SELECT * FROM player%s WHERE `name` = convert('%s' using utf8mb4) collate utf8mb4_bin LIMIT 1", GetTablePostfix(), p->szName);

+		snprintf(s_szQuery, sizeof(s_szQuery),

+			"SELECT * FROM player%s WHERE `name` = convert('%s' using utf8mb4) collate utf8mb4_bin LIMIT 1",

+			GetTablePostfix(), escName);

 		std::unique_ptr<SQLMsg> pMsg(CDBManager::instance().DirectQuery(s_szQuery));

 		bFound = pMsg->Get()->uiNumRows > 0;

 	}

@@ -5924,3 +5964,4 @@
 	}

 }

 #endif

+


--- a/server/metin2/Source/Server/db/src/ClientManager.h
+++ b/server/metin2/Source/Server/db/src/ClientManager.h
@@ -59,10 +59,10 @@
 #endif

 

 	// MYSHOP_PRICE_LIST

-	/// ¾ÆÀÌÅÛ °¡°ÝÁ¤º¸ ¸®½ºÆ® ¿äÃ» Á¤º¸

+	///   Ʈ û 

 	/**

 	* first: Peer handle

-	* second: ¿äÃ»ÇÑ ÇÃ·¹ÀÌ¾îÀÇ ID

+	* second: û ÷̾ ID

 	**/

 	typedef std::pair< DWORD, DWORD > TItemPricelistReqInfo;

 	// END_OF_MYSHOP_PRICE_LIST

@@ -89,7 +89,7 @@
 			player_id = dwPID;

 		};

 

-		// µ¶ÀÏ¼±¹°±â´É¿ë »ý¼ºÀÚ

+		// ϼɿ 

 		ClientHandleInfo(DWORD argHandle, DWORD dwPID, DWORD accountId)

 		{

 			dwHandle = argHandle;

@@ -128,7 +128,7 @@
 	void SetChinaEventServer(bool flag) { m_bChinaEventServer = flag; }

 	bool IsChinaEventServer() { return m_bChinaEventServer; }

 

-	DWORD GetUserCount(); // Á¢¼ÓµÈ »ç¿ëÀÚ ¼ö¸¦ ¸®ÅÏ ÇÑ´Ù.

+	DWORD GetUserCount(); // ӵ    Ѵ.

 

 	void SendAllGuildSkillRechargePacket();

 	void SendTime();

@@ -168,22 +168,22 @@
 #endif

 

 	// MYSHOP_PRICE_LIST

-	/// °¡°ÝÁ¤º¸ ¸®½ºÆ® Ä³½Ã¸¦ °¡Á®¿Â´Ù.

+	///  Ʈ ĳø ´.

 	/**

-	* @param [in] dwID °¡°ÝÁ¤º¸ ¸®½ºÆ®ÀÇ ¼ÒÀ¯ÀÚ.(ÇÃ·¹ÀÌ¾î ID)

-	* @return °¡°ÝÁ¤º¸ ¸®½ºÆ® Ä³½ÃÀÇ Æ÷ÀÎÅÍ

+	* @param [in] dwID  Ʈ .(÷̾ ID)

+	* @return  Ʈ ĳ 

 	**/

 	CItemPriceListTableCache* GetItemPriceListCache(DWORD dwID);

 

-	/// °¡°ÝÁ¤º¸ ¸®½ºÆ® Ä³½Ã¸¦ ³Ö´Â´Ù.

+	///  Ʈ ĳø ִ´.

 	/**

-	* @param [in] pItemPriceList Ä³½Ã¿¡ ³ÖÀ» ¾ÆÀÌÅÛ °¡°ÝÁ¤º¸ ¸®½ºÆ®

+	* @param [in] pItemPriceList ĳÿ    Ʈ

 	*

-	* Ä³½Ã°¡ ÀÌ¹Ì ÀÖÀ¸¸é Update °¡ ¾Æ´Ñ replace ÇÑ´Ù.

+	* ĳð ̹  Update  ƴ replace Ѵ.

 	**/

 	void PutItemPriceListCache(const TItemPriceListTable* pItemPriceList);

 

-	/// Flush ½Ã°£ÀÌ ¸¸·áµÈ ¾ÆÀÌÅÛ °¡°ÝÁ¤º¸ ¸®½ºÆ® Ä³½Ã¸¦ Flush ÇØÁÖ°í Ä³½Ã¿¡¼­ »èÁ¦ÇÑ´Ù.

+	/// Flush ð    Ʈ ĳø Flush ְ ĳÿ Ѵ.

 	void UpdateItemPriceListCache(void);

 	// END_OF_MYSHOP_PRICE_LIST

 

@@ -200,8 +200,16 @@
 

 	void SendNotice(const char* c_pszFormat, ...);

 

-	char* GetCommand(char* str, char* command); // µ¶ÀÏ¼±¹°±â´É¿¡¼­ ¸í·É¾î ¾ò´Â ÇÔ¼ö

-	void ItemAward(CPeer* peer, char* login); // µ¶ÀÏ ¼±¹° ±â´É

+

+    // Safe parser: extracts command token from a string like "[COMMAND] rest..."

+    // Writes at most commandSize bytes (including NUL). Returns command.

+    char* GetCommand(char* str, char* command, size_t commandSize);

+

+    // Backward-compatible wrapper (legacy signature). Prefer the sized overload above.

+    char* GetCommand(char* str, char* command);

+

+	char* GetCommand(char* str, char* command); // ϼɿ ɾ  Լ

+	void ItemAward(CPeer* peer, char* login); //   

 

 protected:

 	void Destroy();

@@ -293,20 +301,20 @@
 	// END_PLAYER_INDEX_CREATE_BUG_FIX

 

 	// MYSHOP_PRICE_LIST

-	/// °¡°ÝÁ¤º¸ ·Îµå Äõ¸®¿¡ ´ëÇÑ Result Ã³¸®

+	///  ε   Result ó

 	/**

-	* @param peer °¡°ÝÁ¤º¸¸¦ ¿äÃ»ÇÑ Game server ÀÇ peer °´Ã¼ Æ÷ÀÎÅÍ

-	* @param pMsg Äõ¸®ÀÇ Result ·Î ¹ÞÀº °´Ã¼ÀÇ Æ÷ÀÎÅÍ

+	* @param peer  û Game server  peer ü 

+	* @param pMsg  Result   ü 

 	*

-	* ·ÎµåµÈ °¡°ÝÁ¤º¸ ¸®½ºÆ®¸¦ Ä³½Ã¿¡ ÀúÀåÇÏ°í peer ¿¡°Ô ¸®½ºÆ®¸¦ º¸³»ÁØ´Ù.

+	* ε  Ʈ ĳÿ ϰ peer  Ʈ ش.

 	**/

 	void RESULT_PRICELIST_LOAD(CPeer* peer, SQLMsg* pMsg);

 

-	/// °¡°ÝÁ¤º¸ ¾÷µ¥ÀÌÆ®¸¦ À§ÇÑ ·Îµå Äõ¸®¿¡ ´ëÇÑ Result Ã³¸®

+	///  Ʈ  ε   Result ó

 	/**

-	* @param pMsg Äõ¸®ÀÇ Result ·Î ¹ÞÀº °´Ã¼ÀÇ Æ÷ÀÎÅÍ

+	* @param pMsg  Result   ü 

 	*

-	* ·ÎµåµÈ Á¤º¸·Î °¡°ÝÁ¤º¸ ¸®½ºÆ® Ä³½Ã¸¦ ¸¸µé°í ¾÷µ¥ÀÌÆ® ¹ÞÀº °¡°ÝÁ¤º¸·Î ¾÷µ¥ÀÌÆ® ÇÑ´Ù.

+	* ε   Ʈ ĳø  Ʈ   Ʈ Ѵ.

 	**/

 	void RESULT_PRICELIST_LOAD_FOR_UPDATE(SQLMsg* pMsg);

 	// END_OF_MYSHOP_PRICE_LIST

@@ -384,7 +392,7 @@
 	void SendGuildEventFlagsOnSetup(CPeer* pPeer);

 #endif

 

-	// °áÈ¥

+	// ȥ

 	void MarriageAdd(TPacketMarriageAdd* p);

 	void MarriageUpdate(TPacketMarriageUpdate* p);

 	void MarriageRemove(TPacketMarriageRemove* p);

@@ -398,19 +406,19 @@
 #endif

 

 	// MYSHOP_PRICE_LIST

-	// °³ÀÎ»óÁ¡ °¡°ÝÁ¤º¸

-

-	/// ¾ÆÀÌÅÛ °¡°ÝÁ¤º¸ ¸®½ºÆ® ¾÷µ¥ÀÌÆ® ÆÐÅ¶(HEADER_GD_MYSHOP_PRICELIST_UPDATE) Ã³¸®ÇÔ¼ö

+	// λ 

+

+	///   Ʈ Ʈ Ŷ(HEADER_GD_MYSHOP_PRICELIST_UPDATE) óԼ

 	/**

-	* @param [in] pPacket ÆÐÅ¶ µ¥ÀÌÅÍÀÇ Æ÷ÀÎÅÍ

+	* @param [in] pPacket Ŷ  

 	**/

 	void MyshopPricelistUpdate(const TItemPriceListTable* pPacket);

 

-	/// ¾ÆÀÌÅÛ °¡°ÝÁ¤º¸ ¸®½ºÆ® ¿äÃ» ÆÐÅ¶(HEADER_GD_MYSHOP_PRICELIST_REQ) Ã³¸®ÇÔ¼ö

+	///   Ʈ û Ŷ(HEADER_GD_MYSHOP_PRICELIST_REQ) óԼ

 	/**

-	* @param peer ÆÐÅ¶À» º¸³½ Game server ÀÇ peer °´Ã¼ÀÇ Æ÷ÀÎÅÍ

-	* @param [in] dwHandle °¡°ÝÁ¤º¸¸¦ ¿äÃ»ÇÑ peer ÀÇ ÇÚµé

-	* @param [in] dwPlayerID °¡°ÝÁ¤º¸ ¸®½ºÆ®¸¦ ¿äÃ»ÇÑ ÇÃ·¹ÀÌ¾îÀÇ ID

+	* @param peer Ŷ  Game server  peer ü 

+	* @param [in] dwHandle  û peer  ڵ

+	* @param [in] dwPlayerID  Ʈ û ÷̾ ID

 	**/

 	void MyshopPricelistRequest(CPeer* peer, DWORD dwHandle, DWORD dwPlayerID);

 	// END_OF_MYSHOP_PRICE_LIST

@@ -443,7 +451,7 @@
 

 private:

 	int m_looping;

-	socket_t m_fdAccept; // Á¢¼Ó ¹Þ´Â ¼ÒÄÏ

+	socket_t m_fdAccept; //  ޴ 

 	TPeerList m_peerList;

 

 	CPeer* m_pkAuthPeer;

@@ -460,7 +468,7 @@
 	typedef std::unordered_map<DWORD, CLoginData*> TLoginDataByAID;

 	TLoginDataByAID m_map_pkLoginDataByAID;

 

-	// Login LoginData pair (½ÇÁ¦ ·Î±×ÀÎ µÇ¾îÀÖ´Â °èÁ¤)

+	// Login LoginData pair ( α Ǿִ )

 	typedef std::unordered_map<std::string, CLoginData*> TLogonAccountMap;

 	TLogonAccountMap m_map_kLogonAccount;

 

@@ -500,14 +508,14 @@
 #endif

 	bool m_bShutdowned;

 

-	TPlayerTableCacheMap m_map_playerCache; // ÇÃ·¹ÀÌ¾î id°¡ key

-

-	TItemCacheMap m_map_itemCache; // ¾ÆÀÌÅÛ id°¡ key

-	TItemCacheSetPtrMap m_map_pkItemCacheSetPtr; // ÇÃ·¹ÀÌ¾î id°¡ key, ÀÌ ÇÃ·¹ÀÌ¾î°¡ ¾î¶² ¾ÆÀÌÅÛ Ä³½¬¸¦ °¡Áö°í ÀÖ³ª?

+	TPlayerTableCacheMap m_map_playerCache; // ÷̾ id key

+

+	TItemCacheMap m_map_itemCache; //  id key

+	TItemCacheSetPtrMap m_map_pkItemCacheSetPtr; // ÷̾ id key,  ÷̾   ĳ  ֳ?

 

 	// MYSHOP_PRICE_LIST

-	/// ÇÃ·¹ÀÌ¾îº° ¾ÆÀÌÅÛ °¡°ÝÁ¤º¸ ¸®½ºÆ® map. key: ÇÃ·¹ÀÌ¾î ID, value: °¡°ÝÁ¤º¸ ¸®½ºÆ® Ä³½Ã

-	TItemPriceListCacheMap m_mapItemPriceListCache; ///< ÇÃ·¹ÀÌ¾îº° ¾ÆÀÌÅÛ °¡°ÝÁ¤º¸ ¸®½ºÆ®

+	/// ÷̾   Ʈ map. key: ÷̾ ID, value:  Ʈ ĳ

+	TItemPriceListCacheMap m_mapItemPriceListCache; ///< ÷̾   Ʈ

 	// END_OF_MYSHOP_PRICE_LIST

 

 	TChannelStatusMap m_mChannelStatus;

@@ -550,7 +558,7 @@
 

 	// BOOT_LOCALIZATION

 public:

-	/* ·ÎÄÃ Á¤º¸ ÃÊ±âÈ­ */

+	/*   ʱȭ */

 	bool InitializeLocalization();

 

 private:


--- a/server/metin2/Source/Server/db/src/ClientManagerBoot.cpp
+++ b/server/metin2/Source/Server/db/src/ClientManagerBoot.cpp
@@ -3,6 +3,22 @@
 #include "ClientManager.h"

 #include "Main.h"

 #include "Monarch.h"

+#include <cstdarg>

+

+// Safe query builder to prevent sprintf overflow in dynamic SELECT composition.

+static bool SafeAppend(char* buf, size_t cap, int& len, const char* fmt, ...)

+{

+	if (!buf || cap == 0) return false;

+	if (len < 0 || (size_t)len >= cap) return false;

+	va_list ap;

+	va_start(ap, fmt);

+	int n = vsnprintf(buf + len, cap - (size_t)len, fmt, ap);

+	va_end(ap);

+	if (n < 0) return false;

+	if ((size_t)n >= cap - (size_t)len) return false;

+	len += n;

+	return true;

+}

 #include "CsvReader.h"

 #include "ProtoReader.h"

 

@@ -1175,7 +1191,7 @@
 		return true;

 

 	char szQuery[1024];

-	sprintf(szQuery, "SELECT `pid`, `vnum`, UNIX_TIMESTAMP(`duration`) FROM emotions%s", GetTablePostfix());

+	snprintf(szQuery, sizeof(szQuery), "SELECT `pid`, `vnum`, UNIX_TIMESTAMP(`duration`) FROM emotions%s", GetTablePostfix());

 

 	std::unique_ptr<SQLMsg> pkMsg(CDBManager::instance().DirectQuery(szQuery));

 	const SQLResult* pkRes = pkMsg->Get();

@@ -1210,39 +1226,39 @@
 		return true;

 

 	char szQuery[QUERY_MAX_LEN];

-	int len = sprintf(szQuery, "SELECT `name`, `who`, `title`, `message`, `gm`, `confirm`, `send_time`, `delete_time`"

-		", `gold`, `won`, `vnum`, `count`"

-	);

+	int len = 0;

+		if (!SafeAppend(szQuery, sizeof(szQuery), len, "SELECT `name`, `who`, `title`, `message`, `gm`, `confirm`, `send_time`, `delete_time`"

+			", `gold`, `won`, `vnum`, `count`"))

+			return false;

 

 	for (BYTE i = 0; i < ITEM_SOCKET_MAX_NUM; i++)

-		len += sprintf(szQuery + len, ", `socket%u`", i);

+		if (!SafeAppend(szQuery, sizeof(szQuery), len, ", `socket%u`", i)) return false;

 

 	for (BYTE i = 0; i < ITEM_ATTRIBUTE_MAX_NUM; i++)

-		len += sprintf(szQuery + len, ", `attrtype%u`, `attrvalue%u`", i, i);

+		if (!SafeAppend(szQuery, sizeof(szQuery), len, ", `attrtype%u`, `attrvalue%u`", i, i)) return false;

 

 #if defined(__CHANGE_LOOK_SYSTEM__)

-	len += sprintf(szQuery + len, ", `changelookvnum`");

+	if (!SafeAppend(szQuery, sizeof(szQuery), len, ", `changelookvnum`")) return false;

 #endif

 

 #if defined(__REFINE_ELEMENT_SYSTEM__)

-	len += sprintf(szQuery + len,

+	if (!SafeAppend(szQuery, sizeof(szQuery), len,

 		", `refine_element_apply_type`"

 		", `refine_element_grade`"

 		", `refine_element_value0`, `refine_element_value1`, `refine_element_value2`"

-		", `refine_element_bonus_value0`, `refine_element_bonus_value1`, `refine_element_bonus_value2`"

-	);

+		", `refine_element_bonus_value0`, `refine_element_bonus_value1`, `refine_element_bonus_value2`")) return false;

 #endif

 

 #if defined(__ITEM_APPLY_RANDOM__)

 	for (BYTE i = 0; i < ITEM_APPLY_MAX_NUM; i++)

-		len += sprintf(szQuery + len, ", `apply_type%u`, `apply_value%u`, `apply_path%u`", i, i, i);

+		if (!SafeAppend(szQuery, sizeof(szQuery), len, ", `apply_type%u`, `apply_value%u`, `apply_path%u`", i, i, i)) return false;

 #endif

 

 #if defined(__SET_ITEM__)

-	len += sprintf(szQuery + len, ", `set_value`");

-#endif

-

-	len += sprintf(szQuery + len, " FROM `mailbox%s`", GetTablePostfix());

+	if (!SafeAppend(szQuery, sizeof(szQuery), len, ", `set_value`")) return false;

+#endif

+

+	if (!SafeAppend(szQuery, sizeof(szQuery), len, " FROM `mailbox%s`", GetTablePostfix())) return false;

 

 	std::unique_ptr<SQLMsg> pkMsg(CDBManager::instance().DirectQuery(szQuery));

 	const SQLResult* pRes = pkMsg->Get();

@@ -1260,10 +1276,13 @@
 		mail.AddData.bHeader = 0;

 		mail.AddData.Index = 0;

 

-		std::memcpy(mail.szName, name, sizeof(mail.szName));

-		std::memcpy(mail.AddData.szFrom, data[col++], sizeof(mail.AddData.szFrom));

-		std::memcpy(mail.Message.szTitle, data[col++], sizeof(mail.Message.szTitle));

-		std::memcpy(mail.AddData.szMessage, data[col++], sizeof(mail.AddData.szMessage));

+		strlcpy(mail.szName, name ? name : "", sizeof(mail.szName));

+		strlcpy(mail.AddData.szFrom, data[col] ? data[col] : "", sizeof(mail.AddData.szFrom));

+			col++;

+		strlcpy(mail.Message.szTitle, data[col] ? data[col] : "", sizeof(mail.Message.szTitle));

+			col++;

+		strlcpy(mail.AddData.szMessage, data[col] ? data[col] : "", sizeof(mail.AddData.szMessage));

+			col++;

 		str_to_number(mail.Message.bIsGMPost, data[col++]);

 		str_to_number(mail.Message.bIsConfirm, data[col++]);

 		str_to_number(mail.Message.SendTime, data[col++]);

@@ -1326,12 +1345,14 @@
 			return true;

 

 		char szQuery[1024];

-		int iLen = sprintf(szQuery, "SELECT `pid`, UNIX_TIMESTAMP(`refresh_time`), `enabled_slots`");

+		int iLen = 0;

+			if (!SafeAppend(szQuery, sizeof(szQuery), iLen, "SELECT `pid`, UNIX_TIMESTAMP(`refresh_time`), `enabled_slots`"))

+				return false;

 

 		for (BYTE i = 0; i < GEM_SHOP_SLOT_COUNT; i++)

-			iLen += sprintf(szQuery + iLen, ", `slot%d_enable`, `slot%d_vnum`, `slot%d_count`, `slot%d_price`", i, i, i, i);

-

-		iLen += sprintf(szQuery + iLen, " FROM `gem_shop%s`", GetTablePostfix());

+			if (!SafeAppend(szQuery, sizeof(szQuery), iLen, ", `slot%d_enable`, `slot%d_vnum`, `slot%d_count`, `slot%d_price`", i, i, i, i)) return false;

+

+		if (!SafeAppend(szQuery, sizeof(szQuery), iLen, " FROM `gem_shop%s`", GetTablePostfix())) return false;

 

 		std::unique_ptr<SQLMsg> pMsg(CDBManager::instance().DirectQuery(szQuery));

 		const SQLResult* c_pRes = pMsg->Get();

@@ -1368,12 +1389,14 @@
 			return true;

 

 		char szQuery[1024];

-		int iLen = sprintf(szQuery, "SELECT `pid`, UNIX_TIMESTAMP(`refresh_time`), `enabled_slots`");

+		int iLen = 0;

+			if (!SafeAppend(szQuery, sizeof(szQuery), iLen, "SELECT `pid`, UNIX_TIMESTAMP(`refresh_time`), `enabled_slots`"))

+				return false;

 

 		for (BYTE i = 0; i < GEM_SHOP_SLOT_COUNT; i++)

-			iLen += sprintf(szQuery + iLen, ", `slot%d_enable`, `slot%d_vnum`, `slot%d_count`, `slot%d_price`", i, i, i, i);

-

-		iLen += sprintf(szQuery + iLen, " FROM `gem_shop_port%s`", GetTablePostfix());

+			if (!SafeAppend(szQuery, sizeof(szQuery), iLen, ", `slot%d_enable`, `slot%d_vnum`, `slot%d_count`, `slot%d_price`", i, i, i, i)) return false;

+

+		if (!SafeAppend(szQuery, sizeof(szQuery), iLen, " FROM `gem_shop_port%s`", GetTablePostfix())) return false;

 

 		std::unique_ptr<SQLMsg> pMsg(CDBManager::instance().DirectQuery(szQuery));

 		const SQLResult* c_pRes = pMsg->Get();


--- a/server/metin2/Source/Server/db/src/ClientManagerPlayer.cpp
+++ b/server/metin2/Source/Server/db/src/ClientManagerPlayer.cpp
@@ -7,6 +7,7 @@
 #include "ItemAwardManager.h"

 #include "HB.h"

 #include "Cache.h"

+#include <string.h>

 

 extern bool g_bHotBackup;

 

@@ -31,7 +32,7 @@
 

 	int rows;

 

-	if ((rows = static_cast<int>(mysql_num_rows(res))) <= 0) // µ¥ÀÌÅÍ ¾øÀ½

+	if ((rows = static_cast<int>(mysql_num_rows(res))) <= 0) //  

 	{

 		pVec->clear();

 		return true;

@@ -239,7 +240,7 @@
 #endif

 	);

 

-	// Binary ·Î ¹Ù²Ù±â À§ÇÑ ÀÓ½Ã °ø°£

+	// Binary  ٲٱ  ӽ 

 	static char text[QUERY_MAX_LEN];

 

 	CDBManager::instance().EscapeString(text, pkTab->skills, sizeof(pkTab->skills));

@@ -291,7 +292,7 @@
 	TPlayerTable* pTab;

 

 	//

-	// ÇÑ °èÁ¤¿¡ ¼ÓÇÑ ¸ðµç Ä³¸¯ÅÍµé Ä³½¬Ã³¸®

+	//     ĳ͵ ĳó

 	//

 	CLoginData* pLoginData = GetLoginDataByAID(packet->account_id);

 

@@ -303,12 +304,12 @@
 	}

 

 	// ---------------------------------------------------------------

-	// 1. À¯ÀúÁ¤º¸°¡ DBCache ¿¡ Á¸Àç : DBCache¿¡¼­

-	// 2. À¯ÀúÁ¤º¸°¡ DBCache ¿¡ ¾øÀ½ : DB¿¡¼­

+	// 1.  DBCache   : DBCache

+	// 2.  DBCache   : DB

 	// ---------------------------------------------------------------

 

 	// ---------------------------------------------------------------

-	// 1. À¯ÀúÁ¤º¸°¡ DBCache ¿¡ Á¸Àç : DBCache¿¡¼­

+	// 1.  DBCache   : DBCache

 	// ---------------------------------------------------------------

 	if ((c = GetPlayerCache(packet->player_id)))

 	{

@@ -363,13 +364,13 @@
 		);

 

 		// ---------------------------------------------------------------

-		// ¾ÆÀÌÅÛ & AFFECT & QUEST ·Îµù :

+		//  & AFFECT & QUEST ε :

 		// ---------------------------------------------------------------

-		// 1) ¾ÆÀÌÅÛÀÌ DBCache ¿¡ Á¸Àç : DBCache ¿¡¼­ °¡Á®¿È

-		// 2) ¾ÆÀÌÅÛÀÌ DBCache ¿¡ ¾øÀ½ : DB ¿¡¼­ °¡Á®¿È

+		// 1)  DBCache   : DBCache  

+		// 2)  DBCache   : DB  

 

 		///////////////////////////////////////////////////////////////

-		// 1) ¾ÆÀÌÅÛÀÌ DBCache ¿¡ Á¸Àç : DBCache ¿¡¼­ °¡Á®¿È

+		// 1)  DBCache   : DBCache  

 		///////////////////////////////////////////////////////////////

 		if (pSet)

 		{

@@ -384,7 +385,7 @@
 				CItemCache* c = *it++;

 				TPlayerItem* p = c->Get();

 

-				if (p->dwVnum) // vnumÀÌ ¾øÀ¸¸é »èÁ¦µÈ ¾ÆÀÌÅÛÀÌ´Ù.

+				if (p->dwVnum) // vnum   ̴.

 					thecore_memcpy(&s_items[dwCount++], p, sizeof(TPlayerItem));

 			}

 

@@ -415,7 +416,7 @@
 			CDBManager::instance().ReturnQuery(szQuery, QID_AFFECT, peer->GetHandle(), new ClientHandleInfo(dwHandle, pTab->id));

 		}

 		///////////////////////////////////////////////////////////////

-		// 2) ¾ÆÀÌÅÛÀÌ DBCache ¿¡ ¾øÀ½ : DB ¿¡¼­ °¡Á®¿È

+		// 2)  DBCache   : DB  

 		///////////////////////////////////////////////////////////////

 		else

 		{

@@ -490,7 +491,7 @@
 		//return;

 	}

 	// ---------------------------------------------------------------

-	// 2. À¯ÀúÁ¤º¸°¡ DBCache ¿¡ ¾øÀ½ : DB¿¡¼­

+	// 2.  DBCache   : DB

 	// ---------------------------------------------------------------

 	else

 	{

@@ -499,7 +500,7 @@
 		char queryStr[QUERY_MAX_LEN];

 

 		// ---------------------------------------------------------------

-		// Ä³¸¯ÅÍ Á¤º¸ ¾ò¾î¿À±â : ¹«Á¶°Ç DB¿¡¼­

+		// ĳ   :  DB

 		// ---------------------------------------------------------------

 		snprintf(queryStr, sizeof(queryStr),

 			"SELECT "

@@ -558,7 +559,7 @@
 		CDBManager::instance().ReturnQuery(queryStr, QID_PLAYER, peer->GetHandle(), pkInfo);

 

 		// ---------------------------------------------------------------

-		// ¾ÆÀÌÅÛ °¡Á®¿À±â

+		//  

 		// ---------------------------------------------------------------

 		snprintf(queryStr, sizeof(queryStr),

 			"SELECT `id`, `window`+0, `pos`, `vnum`, `count`"

@@ -605,15 +606,15 @@
 		CDBManager::instance().ReturnQuery(queryStr, QID_ITEM, peer->GetHandle(), new ClientHandleInfo(dwHandle, packet->player_id));

 

 		// ---------------------------------------------------------------

-		// QUEST °¡Á®¿À±â

+		// QUEST 

 		// ---------------------------------------------------------------

 		snprintf(queryStr, sizeof(queryStr),

 			"SELECT `dwPID`, `szName`, `szState`, `lValue` FROM quest%s WHERE `dwPID` = %d",

 			GetTablePostfix(), packet->player_id);

 		CDBManager::instance().ReturnQuery(queryStr, QID_QUEST, peer->GetHandle(), new ClientHandleInfo(dwHandle, packet->player_id, packet->account_id));

-		// µ¶ÀÏ ¼±¹° ±â´É¿¡¼­ item_awardÅ×ÀÌºí¿¡¼­ login Á¤º¸¸¦ ¾ò±âÀ§ÇØ account idµµ ³Ñ°ÜÁØ´Ù

+		//   ɿ item_award̺ login   account id Ѱش

 		// ---------------------------------------------------------------

-		// AFFECT °¡Á®¿À±â 

+		// AFFECT  

 		// ---------------------------------------------------------------

 		snprintf(queryStr, sizeof(queryStr),

 			"SELECT `dwPID`, `dwType`, `wApplyOn`, `lApplyValue`, `dwFlag`, `lDuration`, `lSPCost`"

@@ -684,44 +685,32 @@
 	if (pSet == NULL)

 		return;

 

-	ItemAwardSet::iterator it = pSet->begin(); // taken_time ÀÌ NULL ÀÎ°Íµé ÀÐ¾î¿È

+	ItemAwardSet::iterator it = pSet->begin(); // taken_time  NULL ΰ͵ о

 	while (it != pSet->end())

 	{

 		TItemAward* pItemAward = *(it++);

-		char* whyStr = pItemAward->szWhy; // why ÄÝ·ë ÀÐ±â

-		char cmdStr[100] = ""; // whyÄÝ·ë¿¡¼­ ÀÐÀº °ªÀ» ÀÓ½Ã ¹®ÀÚ¿­¿¡ º¹»çÇØµÒ

-		strcpy(cmdStr, whyStr); // ¸í·É¾î ¾ò´Â °úÁ¤¿¡¼­ ÅäÅ«¾²¸é ¿øº»µµ ÅäÅ«È­ µÇ±â ¶§¹®

+		char* whyStr = pItemAward->szWhy; // why ݷ б

+		char cmdStr[100] = ""; // whyݷ뿡   ӽ ڿ ص

+		strlcpy(cmdStr, whyStr, sizeof(cmdStr)); // ɾ   ū  ūȭ Ǳ 

 		char command[20] = "";

-		GetCommand(cmdStr, command); // command ¾ò±â

-		if (!(strcmp(cmdStr, "GIFT"))) // command °¡ GIFT ÀÌ¸é

+		GetCommand(cmdStr, command, sizeof(command)); // command 

+		if (!(strcmp(cmdStr, "GIFT"))) // command  GIFT ̸

 		{

 			TPacketItemAwardInfromer giftData;

-			strcpy(giftData.login, pItemAward->szLogin); //·Î±×ÀÎ ¾ÆÀÌµð º¹»ç

-			strcpy(giftData.command, command); // ¸í·É¾î º¹»ç

-			giftData.vnum = pItemAward->dwVnum; // ¾ÆÀÌÅÛ vnum µµ º¹»ç

+			strlcpy(giftData.login, pItemAward->szLogin, sizeof(giftData.login)); //α ̵ 

+			strlcpy(giftData.command, command, sizeof(giftData.command)); // ɾ 

+			giftData.vnum = pItemAward->dwVnum; //  vnum  

 			ForwardPacket(HEADER_DG_ITEMAWARD_INFORMER, &giftData, sizeof(TPacketItemAwardInfromer));

 		}

 	}

 }

 

-char* CClientManager::GetCommand(char* str, char* command)

-{

-	// char* command = new char[20];

-	char* tok;

-

-	if (str[0] == '[')

-	{

-		tok = strtok(str, "]");

-		strcat(command, &tok[1]);

-	}

-

-	return command;

-	// free(command);

-}

+// [REMOVED] Duplicate GetCommand implementation removed to avoid ODR/link errors.

+

 

 bool CreatePlayerTableFromRes(MYSQL_RES* res, TPlayerTable* pkTab)

 {

-	if (mysql_num_rows(res) == 0) // µ¥ÀÌÅÍ ¾øÀ½

+	if (mysql_num_rows(res) == 0) //  

 		return false;

 

 	memset(pkTab, 0, sizeof(TPlayerTable));

@@ -822,11 +811,11 @@
 			int max_point = pkTab->level - 9;

 

 			int skill_point =

-				MIN(20, pkTab->skills[121].bLevel) + // SKILL_LEADERSHIP Åë¼Ö·Â

-				MIN(20, pkTab->skills[124].bLevel) + // SKILL_MINING Ã¤±¤

-				MIN(10, pkTab->skills[131].bLevel) + // SKILL_HORSE_SUMMON ¸»¼ÒÈ¯

-				MIN(20, pkTab->skills[141].bLevel) + // SKILL_ADD_HP HPº¸°­

-				MIN(20, pkTab->skills[142].bLevel) + // SKILL_RESIST_PENETRATE °üÅëÀúÇ×

+				MIN(20, pkTab->skills[121].bLevel) + // SKILL_LEADERSHIP ַ

+				MIN(20, pkTab->skills[124].bLevel) + // SKILL_MINING ä

+				MIN(10, pkTab->skills[131].bLevel) + // SKILL_HORSE_SUMMON ȯ

+				MIN(20, pkTab->skills[141].bLevel) + // SKILL_ADD_HP HP

+				MIN(20, pkTab->skills[142].bLevel) + // SKILL_RESIST_PENETRATE 

 #if defined(__PARTY_PROFICY__)

 				MIN(20, pkTab->skills[133].bLevel) + // SKILL_ROLE_PROFICIENCY

 #endif

@@ -873,13 +862,13 @@
 		sys_log(0, "QID_QUEST %u", info->dwHandle);

 		RESULT_QUEST_LOAD(peer, pSQLResult, info->dwHandle, info->player_id);

 

-		// aid¾ò±â

+		// aid

 		ClientHandleInfo* temp1 = info.get();

 		if (temp1 == NULL)

 			break;

 

 		CLoginData* pLoginData1 = GetLoginDataByAID(temp1->account_id);

-		// µ¶ÀÏ ¼±¹° ±â´É

+		//   

 		//if (pLoginData1->GetAccountRef().login == NULL)

 		//	break;

 

@@ -951,14 +940,14 @@
 void CClientManager::RESULT_ITEM_LOAD(CPeer* peer, MYSQL_RES* pRes, DWORD dwHandle, DWORD dwPID)

 {

 	static std::vector<TPlayerItem> s_items;

-	// DB¿¡¼­ ¾ÆÀÌÅÛ Á¤º¸¸¦ ÀÐ¾î¿Â´Ù.

+	// DB   о´.

 	CreateItemTableFromRes(pRes, &s_items, dwPID);

 	DWORD dwCount = s_items.size();

 

 	peer->EncodeHeader(HEADER_DG_ITEM_LOAD, dwHandle, sizeof(DWORD) + sizeof(TPlayerItem) * dwCount);

 	peer->EncodeDWORD(dwCount);

 

-	// CacheSetÀ» ¸¸µç´Ù

+	// CacheSet 

 	CreateItemCacheSet(dwPID);

 

 	// ITEM_LOAD_LOG_ATTACH_PID

@@ -970,7 +959,7 @@
 		peer->Encode(&s_items[0], sizeof(TPlayerItem) * dwCount);

 

 		for (DWORD i = 0; i < dwCount; ++i)

-			PutItemCache(&s_items[i], true); // ·ÎµåÇÑ °ÍÀº µû·Î ÀúÀåÇÒ ÇÊ¿ä ¾øÀ¸¹Ç·Î, ÀÎÀÚ bSkipQuery¿¡ true¸¦ ³Ö´Â´Ù.

+			PutItemCache(&s_items[i], true); // ε    ʿ Ƿ,  bSkipQuery true ִ´.

 	}

 }

 

@@ -978,7 +967,7 @@
 {

 	int iNumRows;

 

-	if ((iNumRows = static_cast<int>(mysql_num_rows(pRes))) == 0) // µ¥ÀÌÅÍ ¾øÀ½

+	if ((iNumRows = static_cast<int>(mysql_num_rows(pRes))) == 0) //  

 	{

 		static DWORD dwPID;

 		static DWORD dwCount = 0; //1;

@@ -1162,7 +1151,7 @@
 	int queryLen;

 	int player_id;

 

-	// ÇÑ °èÁ¤¿¡ XÃÊ ³»·Î Ä³¸¯ÅÍ »ý¼ºÀ» ÇÒ ¼ö ¾ø´Ù.

+	//   X  ĳ    .

 	time_by_id_map_t::iterator it = s_createTimeByAccountID.find(packet->account_id);

 

 	if (m_bDelayedCharacterCreation)

@@ -1208,13 +1197,17 @@
 		return;

 	}

 

+	char escPlayerName[sizeof(packet->player_table.name) * 2 + 1];

+	const size_t playerNameLen = strnlen(packet->player_table.name, sizeof(packet->player_table.name));

+	CDBManager::instance().EscapeString(escPlayerName, packet->player_table.name, static_cast<unsigned long>(playerNameLen));

+

 	if (g_stLocale == "sjis")

 		snprintf(queryStr, sizeof(queryStr),

 			"SELECT COUNT(*) AS count FROM player%s WHERE `name` = '%s' COLLATE sjis_japanese_ci",

-			GetTablePostfix(), packet->player_table.name);

+			GetTablePostfix(), escPlayerName);

 	else

 		snprintf(queryStr, sizeof(queryStr),

-			"SELECT COUNT(*) AS count FROM player%s WHERE `name` = '%s'", GetTablePostfix(), packet->player_table.name);

+			"SELECT COUNT(*) AS count FROM player%s WHERE `name` = '%s'", GetTablePostfix(), escPlayerName);

 

 	std::unique_ptr<SQLMsg> pMsg1(CDBManager::instance().DirectQuery(queryStr));

 

@@ -1263,7 +1256,7 @@
 		"`playtime`, `skill_level`, `quickslot`) "

 		"VALUES (0, "

 		"%u, "

-		"'%s', " // name

+		"'%s', " // name (escaped)

 		"%d, " // level

 		"%d, " // st

 		"%d, " // ht

@@ -1621,7 +1614,7 @@
 }

 

 //

-// @version	05/06/10 Bang2ni - ÇÃ·¹ÀÌ¾î »èÁ¦½Ã °¡°ÝÁ¤º¸ ¸®½ºÆ® »èÁ¦ Ãß°¡.

+// @version	05/06/10 Bang2ni - ÷̾   Ʈ  ߰.

 //

 void CClientManager::__RESULT_PLAYER_DELETE(CPeer* peer, SQLMsg* msg)

 {

@@ -1672,14 +1665,14 @@
 			return;

 		}

 

-		// »èÁ¦ ¼º°ø

+		//  

 		sys_log(0, "PLAYER_DELETE SUCCESS %u", dwPID);

 

 		// char account_index_string[16];

 

 		// snprintf(account_index_string, sizeof(account_index_string), "player_id%d", m_iPlayerIDStart + pi->account_index);

 

-		// ÇÃ·¹ÀÌ¾î Å×ÀÌºíÀ» Ä³½¬¿¡¼­ »èÁ¦ÇÑ´Ù.

+		// ÷̾ ̺ ĳ Ѵ.

 		CPlayerTableCache* pkPlayerCache = GetPlayerCache(pi->player_id);

 

 		if (pkPlayerCache)

@@ -1688,7 +1681,7 @@
 			delete pkPlayerCache;

 		}

 

-		// ¾ÆÀÌÅÛµéÀ» Ä³½¬¿¡¼­ »èÁ¦ÇÑ´Ù.

+		// ۵ ĳ Ѵ.

 		TItemCacheSet* pSet = GetItemCacheSet(pi->player_id);

 

 		if (pSet)

@@ -1748,7 +1741,12 @@
 		CDBManager::instance().AsyncQuery(queryStr);

 		// END_OF_MYSHOP_PRICE_LIST

 

-		snprintf(queryStr, sizeof(queryStr), "DELETE FROM `messenger_list%s` WHERE `account` = '%s' OR `companion` = '%s'", GetTablePostfix(), szName, szName);

+		char escName[sizeof(szName) * 2 + 1];

+		const size_t nameLen = strnlen(szName, sizeof(szName));

+		CDBManager::instance().EscapeString(escName, szName, static_cast<unsigned long>(nameLen));

+

+		snprintf(queryStr, sizeof(queryStr), "DELETE FROM `messenger_list%s` WHERE `account` = '%s' OR `companion` = '%s'",

+			GetTablePostfix(), escName, escName);

 		CDBManager::instance().AsyncQuery(queryStr);

 

 		peer->EncodeHeader(HEADER_DG_PLAYER_DELETE_SUCCESS, pi->dwHandle, 1);

@@ -1756,7 +1754,7 @@
 	}

 	else

 	{

-		// »èÁ¦ ½ÇÆÐ

+		//  

 		sys_log(0, "PLAYER_DELETE FAIL NO ROW");

 		peer->EncodeHeader(HEADER_DG_PLAYER_DELETE_FAILED, pi->dwHandle, 1);

 		peer->EncodeBYTE(pi->account_index);

@@ -1825,8 +1823,14 @@
 

 void CClientManager::QUERY_HIGHSCORE_REGISTER(CPeer* peer, TPacketGDHighscore* data)

 {

-	char szQuery[128];

-	snprintf(szQuery, sizeof(szQuery), "SELECT `value` FROM highscore%s WHERE `board` = '%s' AND `pid` = %u", GetTablePostfix(), data->szBoard, data->dwPID);

+	char escBoard[sizeof(data->szBoard) * 2 + 1];

+	const size_t boardLen = strnlen(data->szBoard, sizeof(data->szBoard));

+	CDBManager::instance().EscapeString(escBoard, data->szBoard, static_cast<unsigned long>(boardLen));

+

+	char szQuery[256];

+	snprintf(szQuery, sizeof(szQuery),

+		"SELECT `value` FROM highscore%s WHERE `board` = '%s' AND `pid` = %u",

+		GetTablePostfix(), escBoard, data->dwPID);

 

 	sys_log(0, "HEADER_GD_HIGHSCORE_REGISTER: PID %u", data->dwPID);

 

@@ -1853,9 +1857,14 @@
 

 	if (res->uiNumRows == 0)

 	{

-		// »õ·Î¿î ÇÏÀÌ½ºÄÚ¾î¸¦ »ðÀÔ

+		// \xbb\xf5\xb7ο\xee \xc7\xcf\xc0̽\xba\xc4ھ \xbb\xf0\xc0\xd4

 		char buf[256];

-		snprintf(buf, sizeof(buf), "INSERT INTO highscore%s VALUES('%s', %u, %d)", GetTablePostfix(), szBoard, pi->player_id, value);

+		char escBoard[sizeof(szBoard) * 2 + 1];

+		const size_t boardLen = strnlen(szBoard, sizeof(szBoard));

+		CDBManager::instance().EscapeString(escBoard, szBoard, static_cast<unsigned long>(boardLen));

+

+		snprintf(buf, sizeof(buf), "INSERT INTO highscore%s VALUES('%s', %u, %d)",

+			GetTablePostfix(), escBoard, pi->player_id, value);

 		CDBManager::instance().AsyncQuery(buf);

 	}

 	else

@@ -1888,7 +1897,7 @@
 			CDBManager::instance().AsyncQuery(buf);

 		}

 	}

-	// TODO: ÀÌ°÷¿¡¼­ ÇÏÀÌ½ºÄÚ¾î°¡ ¾÷µ¥ÀÌÆ® µÇ¾ú´ÂÁö Ã¼Å©ÇÏ¿© °øÁö¸¦ »Ñ·Á¾ßÇÑ´Ù.

+	// TODO: ̰ ̽ھ Ʈ Ǿ üũϿ  ѷѴ.

 	delete pi;

 }

 

@@ -1896,10 +1905,10 @@
 {

 	TLogoutPlayerMap::iterator it = m_map_logout.find(pid);

 

-	// Á¸ÀçÇÏÁö ¾ÊÀ»°æ¿ì Ãß°¡

+	//   ߰

 	if (it != m_map_logout.end())

 	{

-		// Á¸ÀçÇÒ°æ¿ì ½Ã°£¸¸ °»½Å

+		// Ұ ð 

 		if (g_log)

 			sys_log(0, "LOGOUT: Update player time pid(%d)", pid);

 


--- a/server/metin2/Source/Server/db/src/GuildManager.cpp
+++ b/server/metin2/Source/Server/db/src/GuildManager.cpp
@@ -240,7 +240,7 @@
 

 void CGuildManager::Update()

 {

-	ProcessReserveWar(); // ¿¹¾à ÀüÀï Ã³¸®

+	ProcessReserveWar(); //   ó

 

 	time_t now = CClientManager::instance().GetCurrentTime();

 

@@ -456,7 +456,7 @@
 }

 

 //

-// ±æµåÀü ºñÁ¤»ó Á¾·á ¹× ÇÊµåÀü Á¾·á

+//     ʵ 

 //

 void CGuildManager::WarEnd(DWORD GID1, DWORD GID2, bool bForceDraw)

 {

@@ -486,7 +486,7 @@
 

 	bool bDraw = false;

 

-	if (!bForceDraw) // °­Á¦ ¹«½ÂºÎ°¡ ¾Æ´Ò °æ¿ì¿¡´Â Á¡¼ö¸¦ Ã¼Å©ÇÑ´Ù.

+	if (!bForceDraw) //  ºΰ ƴ 쿡  üũѴ.

 	{

 		if (pData->iScore[0] > pData->iScore[1])

 		{

@@ -501,7 +501,7 @@
 		else

 			bDraw = true;

 	}

-	else // °­Á¦ ¹«½ÂºÎÀÏ °æ¿ì¿¡´Â ¹«Á¶°Ç ¹«½ÂºÎ

+	else //  º 쿡  º

 		bDraw = true;

 

 	if (bDraw)

@@ -509,14 +509,14 @@
 	else

 		ProcessWinLose(win_guild, lose_guild);

 

-	// DB ¼­¹ö¿¡¼­ ÀÚÃ¼ÀûÀ¸·Î ³¡³¾ ¶§µµ ÀÖ±â ¶§¹®¿¡ µû·Î ÆÐÅ¶À» º¸³»Áà¾ß ÇÑ´Ù.

+	// DB  ü   ֱ   Ŷ  Ѵ.

 	CClientManager::instance().for_each_peer(FSendPeerWar(0, GUILD_WAR_END, GID1, GID2));

 

 	RemoveWar(GID1, GID2);

 }

 

 //

-// ±æµåÀü Á¤»ó Á¾·á

+//   

 //

 void CGuildManager::RecvWarOver(DWORD dwGuildWinner, DWORD dwGuildLoser, bool bDraw, long lWarPrice)

 {

@@ -563,7 +563,7 @@
 void CGuildManager::RecvWarEnd(DWORD GID1, DWORD GID2)

 {

 	sys_log(0, "GuildWar: RecvWarEnded : %u vs %u", GID1, GID2);

-	WarEnd(GID1, GID2, true); // ¹«Á¶°Ç ºñÁ¤»ó Á¾·á ½ÃÄÑ¾ß ÇÑ´Ù.

+	WarEnd(GID1, GID2, true); //    Ѿ Ѵ.

 }

 

 void CGuildManager::StartWar(BYTE bType, DWORD GID1, DWORD GID2, CGuildWarReserve* pkReserve)

@@ -733,7 +733,7 @@
 	sys_log(0, "GuildManager::ChangeLadderPoint %u %d", GID, r.ladder_point);

 	sys_log(0, "%s", buf);

 

-	// Packet º¸³»±â

+	// Packet 

 	TPacketGuildLadder p;

 

 	p.dwGuild = GID;

@@ -794,7 +794,7 @@
 		return;

 	}

 

-	// µ·ÀÌÀÖÀ¸´Ï Ãâ±ÝÇÏ°í ¿Ã·ÁÁØ´Ù

+	//  ϰ ÷ش

 	if (it->second.gold >= iGold)

 	{

 		it->second.gold -= iGold;

@@ -824,7 +824,7 @@
 }

 

 //

-// ¿¹¾à ±æµåÀü(°üÀüÀÚ°¡ ¹èÆÃÇÒ ¼ö ÀÖ´Ù)

+//  (ڰ   ִ)

 //

 const int c_aiScoreByLevel[GUILD_MAX_LEVEL + 1] =

 {

@@ -854,7 +854,7 @@
 const int c_aiScoreByRanking[GUILD_RANK_MAX_NUM + 1] =

 {

 	0,

-	55000, // 1À§

+	55000, // 1

 	50000,

 	45000,

 	40000,

@@ -863,7 +863,7 @@
 	28000,

 	24000,

 	21000,

-	18000, // 10À§

+	18000, // 10

 	15000,

 	12000,

 	10000,

@@ -873,7 +873,7 @@
 	3000,

 	2000,

 	1000,

-	500 // 20À§

+	500 // 20

 };

 

 void CGuildManager::BootReserveWar()

@@ -917,8 +917,8 @@
 

 			char buf[512];

 			snprintf(buf, sizeof(buf), "GuildWar: BootReserveWar : step %d id %u GID1 %u GID2 %u", i, t.dwID, t.dwGuildFrom, t.dwGuildTo);

-			// i == 0 ÀÌ¸é ±æµåÀü µµÁß DB°¡ Æ¨±ä °ÍÀÌ¹Ç·Î ¹«½ÂºÎ Ã³¸®ÇÑ´Ù.

-			// ¶Ç´Â, 5ºÐ ÀÌÇÏ ³²Àº ¿¹¾à ±æµåÀüµµ ¹«½ÂºÎ Ã³¸®ÇÑ´Ù. (°¢ÀÚÀÇ ¹èÆÃ¾×À» µ¹·ÁÁØ´Ù)

+			// i == 0 ̸   DB ƨ ̹Ƿ º óѴ.

+			// Ǵ, 5     º óѴ. ( þ ش)

 			//if (i == 0 || (int) t.dwTime - CClientManager::instance().GetCurrentTime() < 60 * 5)

 			if (i == 0 || (int)t.dwTime - CClientManager::instance().GetCurrentTime() < 0)

 			{

@@ -995,7 +995,7 @@
 

 	int lvp, rkp, alv, mc;

 

-	// ÆÄ¿ö °è»ê

+	// Ŀ 

 	TGuild& k1 = TouchGuild(GID1);

 

 	lvp = c_aiScoreByLevel[MIN(GUILD_MAX_LEVEL, k1.level)];

@@ -1011,7 +1011,7 @@
 	t.lPowerFrom = (long)polyPower.Eval();

 	sys_log(0, "GuildWar: %u lvp %d rkp %d alv %d mc %d power %d", GID1, lvp, rkp, alv, mc, t.lPowerFrom);

 

-	// ÆÄ¿ö °è»ê

+	// Ŀ 

 	TGuild& k2 = TouchGuild(GID2);

 

 	lvp = c_aiScoreByLevel[MIN(GUILD_MAX_LEVEL, k2.level)];

@@ -1027,7 +1027,7 @@
 	t.lPowerTo = (long)polyPower.Eval();

 	sys_log(0, "GuildWar: %u lvp %d rkp %d alv %d mc %d power %d", GID2, lvp, rkp, alv, mc, t.lPowerTo);

 

-	// ÇÚµðÄ¸ °è»ê

+	// ڵĸ 

 	if (t.lPowerTo > t.lPowerFrom)

 	{

 		polyHandicap.SetVar("pA", t.lPowerTo);

@@ -1042,7 +1042,7 @@
 	t.lHandicap = (long)polyHandicap.Eval();

 	sys_log(0, "GuildWar: handicap %d", t.lHandicap);

 

-	// Äõ¸®

+	// 

 	char szQuery[512];

 

 	snprintf(szQuery, sizeof(szQuery),

@@ -1078,7 +1078,7 @@
 		CGuildWarReserve* pk = it2->second;

 		TGuildWarReserve& r = pk->GetDataRef();

 

-		if (!r.bStarted && r.dwTime - 1800 <= dwCurTime) // 30ºÐ ÀüºÎÅÍ ¾Ë¸°´Ù.

+		if (!r.bStarted && r.dwTime - 1800 <= dwCurTime) // 30  ˸.

 		{

 			int iMin = (int)ceil((int)(r.dwTime - dwCurTime) / 60.0);

 

@@ -1119,9 +1119,9 @@
 					pk->SetLastNoticeMin(iMin);

 

 					if (!g_stLocale.compare("euckr"))

-						CClientManager::instance().SendNotice("%s ±æµå¿Í %s ±æµåÀÇ ÀüÀïÀÌ ¾à %dºÐ ÈÄ ½ÃÀÛ µË´Ï´Ù!", r_1.szName, r_2.szName, iMin);

+						CClientManager::instance().SendNotice("%s  %s    %d   ˴ϴ!", r_1.szName, r_2.szName, iMin);

 					else if (!g_stLocale.compare("gb2312"))

-						CClientManager::instance().SendNotice("%s °ï»áºÍ %s °ï»áµÄ°ï»áÕ½Õù½«ÔÚ %d·ÖÖÓºó¿ªÊ¼!", r_1.szName, r_2.szName, iMin);

+						CClientManager::instance().SendNotice("%s  %s İս %dӺʼ!", r_1.szName, r_2.szName, iMin);

 				}

 			}

 		}

@@ -1221,7 +1221,7 @@
 

 void CGuildWarReserve::OnSetup(CPeer* peer)

 {

-	if (m_data.bStarted) // ÀÌ¹Ì ½ÃÀÛµÈ °ÍÀº º¸³»Áö ¾Ê´Â´Ù.

+	if (m_data.bStarted) // ̹ ۵   ʴ´.

 		return;

 

 	FSendPeerWar(m_data.bType, GUILD_WAR_RESERVE, m_data.dwGuildFrom, m_data.dwGuildTo) (peer);

@@ -1250,6 +1250,13 @@
 {

 	char szQuery[1024];

 

+	// SQLi hardening: login is a string, must be escaped before building SQL

+	char escLogin[LOGIN_MAX_LEN * 2 + 1];

+	{

+		const size_t len = strnlen(pszLogin, LOGIN_MAX_LEN);

+		CDBManager::instance().EscapeString(escLogin, pszLogin, static_cast<unsigned long>(len));

+	}

+

 	if (m_data.dwGuildFrom != dwGuild && m_data.dwGuildTo != dwGuild)

 	{

 		sys_log(0, "GuildWarReserve::Bet: invalid guild id");

@@ -1270,7 +1277,7 @@
 

 	snprintf(szQuery, sizeof(szQuery),

 		"INSERT INTO guild_war_bet%s (`war_id`, `login`, `gold`, `guild`) VALUES(%u, '%s', %u, %u)",

-		GetTablePostfix(), m_data.dwID, pszLogin, dwGold, dwGuild);

+		GetTablePostfix(), m_data.dwID, escLogin, dwGold, dwGuild);

 

 	std::unique_ptr<SQLMsg> pmsg(CDBManager::instance().DirectQuery(szQuery));

 

@@ -1306,8 +1313,8 @@
 }

 

 //

-// ¹«½ÂºÎ Ã³¸®: ´ëºÎºÐ ½ÂºÎ°¡ ³ª¾ß Á¤»óÀÌÁö¸¸, ¼­¹ö ¹®Á¦ µî Æ¯Á¤ »óÈ²ÀÏ °æ¿ì¿¡´Â

-// ¹«½ÂºÎ Ã³¸®°¡ ÀÖ¾î¾ß ÇÑ´Ù.

+// º ó: κ ºΰ  ,    Ư Ȳ 쿡

+// º ó ־ Ѵ.

 //

 void CGuildWarReserve::Draw()

 {

@@ -1439,7 +1446,7 @@
 

 			double ratio = (double)it->second.second / dwWinnerBet;

 

-			// 10% ¼¼±Ý °øÁ¦ ÈÄ ºÐ¹è

+			// 10%    й

 			sys_log(0, "WAR_REWARD: %s %u ratio %f", it->first.c_str(), it->second.second, ratio);

 

 			DWORD dwGold = (DWORD)(dwTotalBet * ratio * 0.9);


--- a/server/metin2/Source/Server/db/src/ItemAwardManager.cpp
+++ b/server/metin2/Source/Server/db/src/ItemAwardManager.cpp
@@ -9,6 +9,7 @@
 

 #if defined(__EXTENDED_ITEM_AWARD__)

 #include <float.h>

+#include <string.h>

 

 inline double uniform_random(const double a, const double b)

 {

@@ -119,19 +120,19 @@
 		if (row[col])

 		{

 			strlcpy(kData->szWhy, row[col], sizeof(kData->szWhy));

-			// °ÔÀÓ Áß¿¡ whyÄÝ·ë¿¡ º¯µ¿ÀÌ »ý±â¸é

-			char* whyStr = kData->szWhy; // why ÄÝ·ë ÀÐ±â

-			char cmdStr[100] = ""; // whyÄÝ·ë¿¡¼­ ÀÐÀº °ªÀ» ÀÓ½Ã ¹®ÀÚ¿­¿¡ º¹»çÇØµÒ

-			strcpy(cmdStr, whyStr); // ¸í·É¾î ¾ò´Â °úÁ¤¿¡¼­ ÅäÅ«¾²¸é ¿øº»µµ ÅäÅ«È­ µÇ±â ¶§¹®

+			//  ߿ whyݷ뿡  

+			char* whyStr = kData->szWhy; // why ݷ б

+			char cmdStr[100] = ""; // whyݷ뿡   ӽ ڿ ص

+			strlcpy(cmdStr, whyStr, sizeof(cmdStr)); // ɾ   ū  ūȭ Ǳ 

 			char command[20] = "";

-			CClientManager::instance().GetCommand(cmdStr, command); // command ¾ò±â

+			CClientManager::instance().GetCommand(cmdStr, command, sizeof(command)); // command 

 			//sys_err("%d, %s", pItemAward->dwID, command);

-			if (!(strcmp(cmdStr, "GIFT"))) // command °¡ GIFTÀÌ¸é

+			if (!(strcmp(cmdStr, "GIFT"))) // command  GIFT̸

 			{

 				TPacketItemAwardInfromer giftData;

-				strcpy(giftData.login, kData->szLogin); // ·Î±×ÀÎ ¾ÆÀÌµð º¹»ç

-				strcpy(giftData.command, command); // ¸í·É¾î º¹»ç

-				giftData.vnum = kData->dwVnum; // ¾ÆÀÌÅÛ vnumµµ º¹»ç

+				strlcpy(giftData.login, kData->szLogin, sizeof(giftData.login)); // α ̵ 

+				strlcpy(giftData.command, command, sizeof(giftData.command)); // ɾ 

+				giftData.vnum = kData->dwVnum; //  vnum 

 				CClientManager::instance().ForwardPacket(HEADER_DG_ITEMAWARD_INFORMER, &giftData, sizeof(TPacketItemAwardInfromer));

 			}

 		}


--- a/server/metin2/Source/Server/db/src/ProtoReader.cpp
+++ b/server/metin2/Source/Server/db/src/ProtoReader.cpp
@@ -25,23 +25,23 @@
 

 static string* StringSplit(string strOrigin, string strTok)

 {

-	int cutAt; // ÀÚ¸£´ÂÀ§Ä¡

-	int index = 0; // ¹®ÀÚ¿­ÀÎµ¦½º

-	string* strResult = new string[30]; //°á°úreturn ÇÒº¯¼ö

-

-	// strTokÀ»Ã£À»¶§±îÁö¹Ýº¹

+	int cutAt; // ڸġ

+	int index = 0; // ڿε

+	string* strResult = new string[30]; //return Һ

+

+	// strTokãݺ

 	while ((cutAt = strOrigin.find_first_of(strTok)) != strOrigin.npos)

 	{

-		if (cutAt > 0) // ÀÚ¸£´ÂÀ§Ä¡°¡0º¸´ÙÅ©¸é(¼º°ø½Ã)

-		{

-			strResult[index++] = strOrigin.substr(0, cutAt); // °á°ú¹è¿­¿¡Ãß°¡

-		}

-		strOrigin = strOrigin.substr(cutAt + 1); // ¿øº»ÀºÀÚ¸¥ºÎºÐÁ¦¿ÜÇÑ³ª¸ÓÁö

-	}

-

-	if (strOrigin.length() > 0) // ¿øº»ÀÌ¾ÆÁ÷³²¾ÒÀ¸¸é

-	{

-		strResult[index++] = strOrigin.substr(0, cutAt); // ³ª¸ÓÁö¸¦°á°ú¹è¿­¿¡Ãß°¡

+		if (cutAt > 0) // ڸġ0ũ()

+		{

+			strResult[index++] = strOrigin.substr(0, cutAt); // 迭߰

+		}

+		strOrigin = strOrigin.substr(cutAt + 1); // ڸκѳ

+	}

+

+	if (strOrigin.length() > 0) // ̾

+	{

+		strResult[index++] = strOrigin.substr(0, cutAt); // 迭߰

 	}

 

 	for (int i = 0; i < index; i++)

@@ -49,7 +49,7 @@
 		strResult[i] = trim(strResult[i]);

 	}

 

-	return strResult; // °á°úreturn

+	return strResult; // return

 }

 

 int get_Item_Type_Value(string inputString)

@@ -530,14 +530,14 @@
 

 	assert(_countof(arSubType) > type_value && "Subtype rule: Out of range!!");

 

-	// assert ¾È ¸ÔÈ÷´Â µí..

+	// assert   ..

 	if (_countof(arSubType) <= type_value)

 	{

 		sys_err("SubType : Out of range!! (type_value: %d, count of registered subtype: %d", type_value, _countof(arSubType));

 		return -1;

 	}

 

-	// ¾ÆÀÌÅÛ Å¸ÀÔÀÇ ¼­ºêÅ¸ÀÔ ¾î·¹ÀÌ°¡ Á¸ÀçÇÏ´ÂÁö ¾Ë¾Æº¸°í, ¾øÀ¸¸é 0 ¸®ÅÏ

+	//  Ÿ Ÿ ̰ ϴ ˾ƺ,  0 

 	if (arSubType[type_value] == 0)

 		return 0;

 	//

@@ -604,20 +604,17 @@
 	};

 

 	int retValue = 0;

-	string* arInputString = StringSplit(inputString, "|"); // ÇÁ·ÎÅä Á¤º¸ ³»¿ëÀ» ´Ü¾îº°·Î ÂÉ°µ ¹è¿­.

+	const std::vector<std::string> arInputString = StringSplit(inputString, '|');

 	for (int i = 0; i < sizeof(arAntiFlag) / sizeof(arAntiFlag[0]); i++)

 	{

 		string tempString = arAntiFlag[i];

-		for (int j = 0; j < 30; j++) // ÃÖ´ë 30°³ ´Ü¾î±îÁö. (ÇÏµåÄÚµù)

-		{

-			string tempString2 = arInputString[j];

-			if (tempString2.compare(tempString) == 0) // ÀÏÄ¡ÇÏ´ÂÁö È®ÀÎ.

+		for (size_t j = 0; j < arInputString.size(); j++)

+		{

+			const string& tempString2 = arInputString[j];

+			if (tempString2.compare(tempString) == 0)

 			{

 				retValue = retValue + static_cast<int>(pow((float)2, (float)i));

 			}

-

-			if (tempString2.compare("") == 0)

-				break;

 		}

 	}

 	delete[]arInputString;

@@ -646,14 +643,14 @@
 	};

 

 	int retValue = 0;

-	string* arInputString = StringSplit(inputString, "|"); // ÇÁ·ÎÅä Á¤º¸ ³»¿ëÀ» ´Ü¾îº°·Î ÂÉ°µ ¹è¿­.

+	string* arInputString = StringSplit(inputString, "|"); //    ܾ ɰ 迭.

 	for (int i = 0; i < sizeof(arFlag) / sizeof(arFlag[0]); i++)

 	{

 		string tempString = arFlag[i];

-		for (int j = 0; j < 30; j++) // ÃÖ´ë 30°³ ´Ü¾î±îÁö. (ÇÏµåÄÚµù)

+		for (int j = 0; j < 30; j++) // ִ 30 ܾ. (ϵڵ)

 		{

 			string tempString2 = arInputString[j];

-			if (tempString2.compare(tempString) == 0) // ÀÏÄ¡ÇÏ´ÂÁö È®ÀÎ.

+			if (tempString2.compare(tempString) == 0) // ġϴ Ȯ.

 			{

 				retValue = retValue + static_cast<int>(pow((float)2, (float)i));

 			}

@@ -692,14 +689,14 @@
 	};

 

 	int retValue = 0;

-	string* arInputString = StringSplit(inputString, "|"); // ÇÁ·ÎÅä Á¤º¸ ³»¿ëÀ» ´Ü¾îº°·Î ÂÉ°µ ¹è¿­.

+	string* arInputString = StringSplit(inputString, "|"); //    ܾ ɰ 迭.

 	for (int i = 0; i < sizeof(arWearrFlag) / sizeof(arWearrFlag[0]); i++)

 	{

 		string tempString = arWearrFlag[i];

-		for (int j = 0; j < 30; j++) // ÃÖ´ë 30°³ ´Ü¾î±îÁö. (ÇÏµåÄÚµù)

+		for (int j = 0; j < 30; j++) // ִ 30 ܾ. (ϵڵ)

 		{

 			string tempString2 = arInputString[j];

-			if (tempString2.compare(tempString) == 0) // ÀÏÄ¡ÇÏ´ÂÁö È®ÀÎ.

+			if (tempString2.compare(tempString) == 0) // ġϴ Ȯ.

 			{

 				retValue = retValue + static_cast<int>(pow((float)2, (float)i));

 			}

@@ -727,14 +724,14 @@
 	};

 

 	int retValue = 0;

-	string* arInputString = StringSplit(inputString, "|"); //ÇÁ·ÎÅä Á¤º¸ ³»¿ëÀ» ´Ü¾îº°·Î ÂÉ°µ ¹è¿­.

+	string* arInputString = StringSplit(inputString, "|"); //   ܾ ɰ 迭.

 	for (int i = 0; i < sizeof(arImmune) / sizeof(arImmune[0]); i++)

 	{

 		string tempString = arImmune[i];

-		for (int j = 0; j < 30; j++) // ÃÖ´ë 30°³ ´Ü¾î±îÁö. (ÇÏµåÄÚµù)

+		for (int j = 0; j < 30; j++) // ִ 30 ܾ. (ϵڵ)

 		{

 			string tempString2 = arInputString[j];

-			if (tempString2.compare(tempString) == 0) // ÀÏÄ¡ÇÏ´ÂÁö È®ÀÎ.

+			if (tempString2.compare(tempString) == 0) // ġϴ Ȯ.

 			{

 				retValue = retValue + static_cast<int>(pow((float)2, (float)i));

 			}

@@ -1099,7 +1096,7 @@
 	return retInt;

 }

 

-//¸ó½ºÅÍ ÇÁ·ÎÅäµµ ÀÐ´Â´Ù.

+// 䵵 д´.

 int get_Mob_Rank_Value(string inputString)

 {

 	string arRank[] = {

@@ -1251,14 +1248,14 @@
 	};

 

 	int retValue = 0;

-	string* arInputString = StringSplit(inputString, ","); // ÇÁ·ÎÅä Á¤º¸ ³»¿ëÀ» ´Ü¾îº°·Î ÂÉ°µ ¹è¿­.

+	string* arInputString = StringSplit(inputString, ","); //    ܾ ɰ 迭.

 	for (int i = 0; i < sizeof(arAIFlag) / sizeof(arAIFlag[0]); i++)

 	{

 		string tempString = arAIFlag[i];

-		for (int j = 0; j < 30; j++) // ÃÖ´ë 30°³ ´Ü¾î±îÁö. (ÇÏµåÄÚµù)

+		for (int j = 0; j < 30; j++) // ִ 30 ܾ. (ϵڵ)

 		{

 			string tempString2 = arInputString[j];

-			if (tempString2.compare(tempString) == 0) // ÀÏÄ¡ÇÏ´ÂÁö È®ÀÎ.

+			if (tempString2.compare(tempString) == 0) // ġϴ Ȯ.

 			{

 				retValue = retValue + static_cast<int>(pow((float)2, (float)i));

 			}

@@ -1294,14 +1291,14 @@
 	};

 

 	int retValue = 0;

-	string* arInputString = StringSplit(inputString, ","); // ÇÁ·ÎÅä Á¤º¸ ³»¿ëÀ» ´Ü¾îº°·Î ÂÉ°µ ¹è¿­.

+	string* arInputString = StringSplit(inputString, ","); //    ܾ ɰ 迭.

 	for (int i = 0; i < sizeof(arRaceFlag) / sizeof(arRaceFlag[0]); i++)

 	{

 		string tempString = arRaceFlag[i];

-		for (int j = 0; j < 30; j++) // ÃÖ´ë 30°³ ´Ü¾î±îÁö. (ÇÏµåÄÚµù)

+		for (int j = 0; j < 30; j++) // ִ 30 ܾ. (ϵڵ)

 		{

 			string tempString2 = arInputString[j];

-			if (tempString2.compare(tempString) == 0) // ÀÏÄ¡ÇÏ´ÂÁö È®ÀÎ.

+			if (tempString2.compare(tempString) == 0) // ġϴ Ȯ.

 			{

 				retValue = retValue + static_cast<int>(pow((float)2, (float)i));

 			}

@@ -1329,14 +1326,14 @@
 	};

 

 	int retValue = 0;

-	string* arInputString = StringSplit(inputString, ","); // ÇÁ·ÎÅä Á¤º¸ ³»¿ëÀ» ´Ü¾îº°·Î ÂÉ°µ ¹è¿­.

+	string* arInputString = StringSplit(inputString, ","); //    ܾ ɰ 迭.

 	for (int i = 0; i < sizeof(arImmuneFlag) / sizeof(arImmuneFlag[0]); i++)

 	{

 		string tempString = arImmuneFlag[i];

-		for (int j = 0; j < 30; j++) // ÃÖ´ë 30°³ ´Ü¾î±îÁö. (ÇÏµåÄÚµù)

+		for (int j = 0; j < 30; j++) // ִ 30 ܾ. (ϵڵ)

 		{

 			string tempString2 = arInputString[j];

-			if (tempString2.compare(tempString) == 0) // ÀÏÄ¡ÇÏ´ÂÁö È®ÀÎ.

+			if (tempString2.compare(tempString) == 0) // ġϴ Ȯ.

 			{

 				retValue = retValue + static_cast<int>(pow((float)2, (float)i));

 			}

@@ -1352,7 +1349,7 @@
 }

 

 #ifndef __DUMP_PROTO__

-// ¸÷ Å×ÀÌºíÀ» ¼ÂÆÃÇØÁØ´Ù.

+//  ̺ ش.

 bool Set_Proto_Mob_Table(TMobTable* mobTable, cCsvTable& csvTable, std::map<int, const char*>& nameMap)

 {

 	int col = 0;

@@ -1360,7 +1357,7 @@
 	str_to_number(mobTable->dwVnum, csvTable.AsStringByIndex(col++));

 	strlcpy(mobTable->szName, csvTable.AsStringByIndex(col++), sizeof(mobTable->szName));

 

-	// 3. Áö¿ªº° ÀÌ¸§ ³Ö¾îÁÖ±â.

+	// 3.  ̸ ־ֱ.

 	map<int, const char*>::iterator it;

 	it = nameMap.find(mobTable->dwVnum);

 	if (it != nameMap.end())

@@ -1493,11 +1490,11 @@
 

 bool Set_Proto_Item_Table(TItemTable* itemTable, cCsvTable& csvTable, std::map<int, const char*>& nameMap)

 {

-	// vnum ¹× vnum range ÀÐ±â.

+	// vnum  vnum range б.

 	{

 		std::string s(csvTable.AsStringByIndex(0));

 		int pos = s.find("~");

-		// vnum ÇÊµå¿¡ '~'°¡ ¾ø´Ù¸é ÆÐ½º

+		// vnum ʵ忡 '~' ٸ н

 		if (std::string::npos == pos)

 		{

 			itemTable->dwVnum = atoi(s.c_str());

@@ -1528,7 +1525,7 @@
 	int col = 1;

 

 	strlcpy(itemTable->szName, csvTable.AsStringByIndex(col++), sizeof(itemTable->szName));

-	// Áö¿ªº° ÀÌ¸§ ³Ö¾îÁÖ±â.

+	//  ̸ ־ֱ.

 	std::map<int, const char*>::iterator it;

 	it = nameMap.find(itemTable->dwVnum);

 	if (it != nameMap.end())


