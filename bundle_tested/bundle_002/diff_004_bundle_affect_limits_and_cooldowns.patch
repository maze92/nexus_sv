diff --git a/server/metin2/Source/Server/game/src/affect.h b/server/metin2/Source/Server/game/src/affect.h
index 280906d..00b222f 100644
--- a/server/metin2/Source/Server/game/src/affect.h
+++ b/server/metin2/Source/Server/game/src/affect.h
@@ -1,464 +1,468 @@
-#ifndef __INC_AFFECT_H__
-#define __INC_AFFECT_H__
-
-class CAffect
-{
-public:
-	DWORD dwType;
-	POINT_TYPE wApplyOn;
-	POINT_VALUE lApplyValue;
-	DWORD dwFlag;
-	long lDuration;
-	long lSPCost;
-#if defined(__AFFECT_RENEWAL__)
-	bool bRealTime;
-	bool bUpdate;
-#endif
-#if defined(__9TH_SKILL__)
-	long lValue;
-#endif
-
-	static CAffect* Acquire();
-	static void Release(CAffect* p);
-};
-
-enum EAffectTypes
-{
-	AFFECT_NONE,
-
-	//AFFECT_GUILD_SKILL_BLOOD = 152,
-	//AFFECT_GUILD_SKILL_BLESS = 153,
-	//AFFECT_GUILD_SKILL_SEONGHWI = 154,
-	//AFFECT_GUILD_SKILL_ACCEL = 155,
-	//AFFECT_GUILD_SKILL_BUNNO = 156,
-	//AFFECT_GUILD_SKILL_JUMUN = 157,
-
-	//AFFECT_SKILL_9_FINISH = 176,
-	//AFFECT_SKILL_9_ILGWANGPYO = 177,
-	//AFFECT_SKILL_9_PUNGLOEPO = 178,
-	//AFFECT_SKILL_9_GEOMAGGWI = 179,
-	//AFFECT_SKILL_9_MABEOBAGGWI = 180,
-	//AFFECT_SKILL_9_METEO = 181,
-#if defined(__9TH_SKILL__)
-	AFFECT_SKILL_9_CHEONUN = 182,
-#endif
-	//AFFECT_SKILL_9_ILIPUNGU = 183,
-
-	AFFECT_MOV_SPEED = 200,
-	AFFECT_ATT_SPEED,
-	AFFECT_ATT_GRADE,
-	AFFECT_INVISIBILITY,
-	AFFECT_STR,
-	AFFECT_DEX,
-	AFFECT_CON,
-	AFFECT_INT,
-	AFFECT_FISH_MIND_PILL,
-
-	AFFECT_POISON,
-	AFFECT_STUN,
-	AFFECT_SLOW,
-	AFFECT_DUNGEON_READY,
-	AFFECT_DUNGEON_UNIQUE,
-
-	AFFECT_BUILDING,
-	AFFECT_REVIVE_INVISIBLE,
-	AFFECT_FIRE,
-	AFFECT_CAST_SPEED,
-	AFFECT_HP_RECOVER_CONTINUE,
-	AFFECT_SP_RECOVER_CONTINUE,
-
-	AFFECT_POLYMORPH,
-	AFFECT_MOUNT,
-
-	AFFECT_WAR_FLAG,
-
-	AFFECT_BLOCK_CHAT,
-	AFFECT_CHINA_FIREWORK,
-
-	AFFECT_BOW_DISTANCE,
-	AFFECT_DEF_GRADE,
-
-	AFFECT_BLEEDING,
-
-	//AFFECT_SKILL_MONSTER_WIDE_AREA_DAMAGE_SUNGMA_STR = 274,
-	//AFFECT_SKILL_MONSTER_ATT_GRADE_DOWN = 279,
-	//AFFECT_SKILL_POSION_DAMAGE_SUNGMA_MOVE = 280,
-	//AFFECT_SKILL_CRUSH_DAMAGE_SUNGMA_STR = 281,
-
-	AFFECT_RAMADAN_ABILITY = 300,
-	AFFECT_RAMADAN_RING = 301, // ¶ó¸¶´Ü ÀÌº¥Æ®¿ë Æ¯¼ö¾ÆÀÌÅÛ ÃÊ½Â´ÞÀÇ ¹ÝÁö Âø¿ë À¯¹«
-
-	AFFECT_NOG_ABILITY = 302,
-	AFFECT_HOLLY_STONE_POWER = 303,
-
-	AFFECT_PREMIUM_START = 500,
-	AFFECT_EXP_BONUS = 500, // °æÇèÀÇ ¹ÝÁö
-	AFFECT_ITEM_BONUS = 501, // µµµÏÀÇ Àå°©
-	AFFECT_SAFEBOX = 502, // PREMIUM_SAFEBOX,
-	AFFECT_AUTOLOOT = 503, // PREMIUM_AUTOLOOT,
-	AFFECT_FISH_MIND = 504, // PREMIUM_FISH_MIND,
-	AFFECT_MARRIAGE_FAST = 505, // ¿ø¾ÓÀÇ ±êÅÐ
-	AFFECT_GOLD_BONUS = 506, // µ· µå·ÓÈ®·ü 50%Áõ°¡
-	AFFECT_AUTO_USE = 507, // ÀÚµ¿ »ç³É
-#if defined(__CONQUEROR_LEVEL__)
-	AFFECT_SUNGMA_BONUS = 508,
-#endif
-	AFFECT_PREMIUM_END = 509,
-
-	AFFECT_MALL = 510, // ¸ô ¾ÆÀÌÅÛ ¿¡ÆåÆ®
-	AFFECT_NO_DEATH_PENALTY = 511, // ¿ë½ÅÀÇ °¡È£ (°æÇèÄ¡°¡ ÆÐ³ÎÆ¼¸¦ ÇÑ¹ø ¸·¾ÆÁØ´Ù)
-	AFFECT_SKILL_BOOK_BONUS = 512, // ¼±ÀÎÀÇ ±³ÈÆ (Ã¥ ¼ö·Ã ¼º°ø È®·üÀÌ 50% Áõ°¡)
-	AFFECT_SKILL_NO_BOOK_DELAY = 513, // ÁÖ¾È¼ú¼­
-
-	AFFECT_HAIR = 514, // Çì¾î È¿°ú
-	AFFECT_COLLECT = 515, // ¼öÁýÄù½ºÆ® 
-
-	AFFECT_EXP_BONUS_EURO_FREE = 516, // °æÇèÀÇ ¹ÝÁö (À¯·´ ¹öÀü 14 ·¹º§ ÀÌÇÏ ±âº» È¿°ú)
-	AFFECT_EXP_BONUS_EURO_FREE_UNDER_15 = 517,
-	AFFECT_UNIQUE_ABILITY = 518,
-
-	AFFECT_BLEND,
-
-	AFFECT_HORSE_NAME,
-	AFFECT_MOUNT_BONUS,
-
-	AFFECT_AUTO_HP_RECOVERY = 534,
-	AFFECT_AUTO_SP_RECOVERY = 535,
-
-#if defined(__LOOT_FILTER_SYSTEM__) && defined(__PREMIUM_LOOT_FILTER__)
-	AFFECT_LOOTING_SYSTEM = 537,
-#endif
-
-	//AFFECT_UNKNOWN_538,
-	//AFFECT_UNKNOWN_539,
-
-	AFFECT_DRAGON_SOUL_QUALIFIED = 540,
-	AFFECT_DRAGON_SOUL_DECK_0 = 541,
-	AFFECT_DRAGON_SOUL_DECK_1 = 542,
-
-	//AFFECT_PVP_EXPBONUS = 543,
-	//AFFECT_IMPOSSIBLE_ATTACK = 544,
-	//AFFECT_PVP_ENTER = 545,
-
-#ifdef __GROWTH_PET_SYSTEM__
-	AFFECT_GROWTH_PET = 545,
-#endif
-
-#if defined(__SOUL_SYSTEM__)
-	AFFECT_SOUL = 546,
-#endif
-#ifdef __OFFLINE_SHOP__
-	AFFECT_OFFLINE_SHOP_DECORATION = 547,
-#endif
-
-	//AFFECT_UNKNOWN_549,
-
-#if defined(__SET_ITEM__)
-	AFFECT_SET_ITEM = 550,
-#endif
-	//AFFECT_EXP_BONUS_EVENT = 551,
-	//AFFECT_ATT_SPEED_SLOW = 552,
-	//AFFECT_PEPSI_EVENT = 553,
-	//AFFECT_SUMMER_EVENT = 554,
-
-	//AFFECT_BATTLE_FIELD = 555,
-	//AFFECT_BATTLE_POTION = 556,
-	//AFFECT_BATTLE_RANK = 557,
-
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-	AFFECT_RED_DRAGONLAIR_STONE = 558,
-#endif
-	//AFFECT_UNKNOWN_559,
-
-	//AFFECT_LUCKEY_EVENT_BUFF = 560,
-	AFFECT_MOUNT_FALL = 561,
-	//AFFECT_NO_RECOVERY = 562,
-	//AFFECT_REDUCE_CAST_SPEED = 563,
-	//AFFECT_UNKNOWN_564,
-
-	//AFFECT_ATT_GRADE_DOWN = 565,
-	//AFFECT_DEF_GRADE_DOWN = 566,
-
-	//AFFECT_CRITICAL_PCT_DOWN = 567,
-	//AFFECT_CZ_UNLIMIT_ENTER = 568,
-	//AFFECT_UNKNOWN_569,
-#if defined(__FLOWER_EVENT__)
-	AFFECT_FLOWER_EVENT = 570,
-#endif
-#if defined(__DS_SET__)
-	AFFECT_DS_SET = 571,
-#endif
-	AFFECT_RESEARCHER_ELIXIR = 572,
-#if defined(__DEFENSE_WAVE__)
-	AFFECT_DEFENSEWAVE_LASER = 573,
-#endif
-
-	//AFFECT_NO_DEATH_PENALTY_PLUS = 574,
-#if defined(__YUTNORI_EVENT_FLAG_RENEWAL__)
-	AFFECT_HALLOWEEN_EVENT = 575,
-#endif
-	//AFFECT_UNKNOWN_576,
-#if defined(__FISHING_GAME__)
-	AFFECT_FISHING_GOLD_TUNA = 577,
-	AFFECT_FISHING_MOVE_SPEED_DOWN = 578,
-#endif
-	//AFFECT_UNKNOWN_579,
-	AFFECT_SAFE_BOX_BUFF = 580,
-	//AFFECT_UNKNOWN_581,
-	//AFFECT_MALL_EXP_BONUS = 582,
-
-#if defined(__SUMMER_EVENT_ROULETTE__)
-	AFFECT_LATE_SUMMER_EVENT_BUFF = 583,
-	AFFECT_LATE_SUMMER_EVENT_PRIMIUM_BUFF = 584,
-#endif
-
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-	AFFECT_RED_DRAGONLAIR_BUFF = 585,
-#endif
-	//AFFECT_MISTS_ISLAND_BUFF = 586,
-
-	//AFFECT_SEASON_RANKING_BUFF = 587,
-	//AFFECT_SEASON_PVE_BUFF = 588,
-	//AFFECT_UNKNOWN_589,
-
-	//AFFECT_BATTLE_ROYALE_SLOW = 590,
-	//AFFECT_BATTLE_ROYALE_MOVE_SPEED = 591,
-	//AFFECT_UNKNOWN_592,
-
-	//AFFECT_PASSIVE_JOB_DECK = 593,
-#if defined(__ELEMENTAL_DUNGEON__)
-	AFFECT_CURSE_OF_ELEMENTAL = 594,
-	AFFECT_PROTECTION_OF_ELEMENTAL = 595,
-	AFFECT_POTION_OF_ELEMENTAL = 596,
-#endif
-	//AFFECT_UNKNOWN_597,
-	//AFFECT_UNKNOWN_598,
-	//AFFECT_UNKNOWN_599,
-	//AFFECT_BATTLE_ROYALE_INFINITE_STAMINA = 600,
-
-#if defined(__SET_ITEM__)
-	AFFECT_SET_ITEM_SET_VALUE_1 = 601,
-	AFFECT_SET_ITEM_SET_VALUE_2 = 602,
-	AFFECT_SET_ITEM_SET_VALUE_3 = 603,
-	AFFECT_SET_ITEM_SET_VALUE_4 = 604,
-	AFFECT_SET_ITEM_SET_VALUE_5 = 605,
-#endif
-	//AFFECT_UNKNOWN_606,
-	//AFFECT_UNKNOWN_607,
-
-#if defined(__9TH_SKILL__)
-	AFFECT_CHEONUN_INVINCIBILITY = 608,
-#endif
-
-	//AFFECT_WORLD_BOSS_REWARD = 609,
-	//AFFECT_WORLD_BOSS_DAILY_REWARD = 610,
-
-	//AFFECT_SUNGMAHEE_TOWER_BUFF = 611,
-	//AFFECT_SUNGMAHEE_TOWER_DEBUFF = 612,
-	//AFFECT_SUNGMAHEE_TOWER_CURSE = 613,
-	//AFFECT_UNKNOWN_614,
-	//AFFECT_GARRISON_DEBUFF = 615,
-	//AFFECT_GARRISON_BUFF = 616,
-
-	//AFFECT_UNKNOWN_617,
-	//AFFECT_UNKNOWN_618,
-	//AFFECT_UNKNOWN_619,
-	//AFFECT_UNKNOWN_620,
-	//AFFECT_UNKNOWN_621,
-	//AFFECT_UNKNOWN_622,
-
-#if defined(__CONQUEROR_LEVEL__)
-	AFFECT_SUNGMA_STR = 623,
-	AFFECT_SUNGMA_HP = 624,
-	AFFECT_SUNGMA_MOVE = 625,
-	AFFECT_SUNGMA_IMMUNE = 626,
-#endif
-
-	//AFFECT_UNKNOWN_627,
-	//AFFECT_UNKNOWN_628,
-	//AFFECT_SUBQUEST_NEWWORLD_5 = 629,
-	//AFFECT_WHITE_DRAGON_CAVE_CURSE = 630,
-
-	//AFFECT_SECRET_DUNGEON_BUFF_POINT_C = 631,
-	//AFFECT_SECRET_DUNGEON_BUFF_C = 632,
-	//AFFECT_SECRET_DUNGEON_BUFF_B = 633,
-	//AFFECT_SECRET_DUNGEON_BUFF_A = 634,
-
-	//AFFECT_OTHER_WORLD_DEAD_SOUL = 635,
-	//AFFECT_OTHER_WORLD_GOBLIN_PROTECTION = 636,
-	//AFFECT_OTHER_WORLD_YEOMWANG_CURSE = 637,
-	//AFFECT_OTHER_WORLD_NORTH_REAPER_ROOM_DEBUFF = 638,
-
-	//AFFECT_SKILL_MOUNT_UPGRADE_NIMBLE = 639,
-	//AFFECT_SKILL_MOUNT_UPGRADE_EXP = 640,
-	//AFFECT_SKILL_MOUNT_UPGRADE_SPEED = 641,
-	//AFFECT_SKILL_MOUNT_UPGRADE_GYENONGGONG = 642,
-	//AFFECT_SKILL_MOUNT_UPGRADE_INVINCIBLITIY = 643,
-	//AFFECT_SKILL_MOUNT_UPGRADE_KNOCKBACK = 644,
-	//AFFECT_SKILL_MOUNT_UPGRADE_TO_STRONG = 645,
-	//AFFECT_SKILL_MOUNT_UPGRADE_EFFECT_UP = 646,
-	//AFFECT_SKILL_MOUNT_UPGRADE_SUNGMA_STR = 647,
-	//AFFECT_SKILL_MOUNT_UPGRADE_SUNGMA_HP = 648,
-	//AFFECT_SKILL_MOUNT_UPGRADE_SUNGMA_MOVE = 649,
-	//AFFECT_SKILL_MOUNT_UPGRADE_SUNGMA_IMMUNE = 650,
-	//AFFECT_SKILL_MOUNT_UPGRADE_HIT_PCT = 651,
-
-	//AFFECT_MERCENARY_MISSION_MAX_ACTIVE_INCREASE = 652,
-	//AFFECT_SECRET_DUNGEON_BUFF_POINT_B = 653,
-	//AFFECT_SECRET_DUNGEON_BUFF_POINT_A = 654,
-	AFFECT_ELEMENT_BUFF_CRACK = 655,
-	//AFFECT_FLOWER_OF_GALE = 656,
-	//AFFECT_FLOWER_OF_DESTRUCTION = 657,
-	//AFFECT_UNKNOWN_658,
-	//AFFECT_UNKNOWN_659,
-	//AFFECT_UNKNOWN_660,
-	//AFFECT_UNKNOWN_661,
-	//AFFECT_IMMUNE_MINE_TOWER_SKILL = 662,
-#if defined(__SNOWFLAKE_STICK_EVENT__)
-	AFFECT_SNOWFLAKE_STICK_EVENT_RANK_BUFF = 663,
-	AFFECT_SNOWFLAKE_STICK_EVENT_SNOWFLAKE_BUFF = 664,
-#endif
-
-	AFFECT_QUEST_START_IDX = 1000,
-
-	AFFECT_MAX
-};
-
-enum EAffectBits
-{
-	AFF_NONE,
-
-	AFF_YMIR,
-	AFF_INVISIBILITY,
-	AFF_SPAWN,
-
-	AFF_POISON,
-	AFF_SLOW,
-	AFF_STUN,
-
-	AFF_DUNGEON_READY, // ´øÀü¿¡¼­ ÁØºñ »óÅÂ
-	AFF_DUNGEON_UNIQUE, // ´øÀü À¯´ÏÅ© (Å¬¶óÀÌ¾ðÆ®¿¡¼­ ÄÃ¸µµÇÁö¾ÊÀ½)
-
-	AFF_BUILDING_CONSTRUCTION_SMALL, // AFF_SHACKLE
-	AFF_BUILDING_CONSTRUCTION_LARGE,
-	AFF_BUILDING_UPGRADE,
-
-	AFF_MOV_SPEED_POTION,
-	AFF_ATT_SPEED_POTION,
-
-	AFF_FISH_MIND,
-
-	AFF_JEONGWIHON, // Àü±ÍÈ¥
-	AFF_GEOMGYEONG, // °Ë°æ
-	AFF_CHEONGEUN, // Ãµ±ÙÃß
-	AFF_GYEONGGONG, // °æ°ø¼ú
-	AFF_EUNHYUNG, // ÀºÇü¹ý
-	AFF_GWIGUM, // ±Í°Ë
-	AFF_TERROR, // °øÆ÷
-	AFF_JUMAGAP, // ÁÖ¸¶°©
-	AFF_HOSIN, // È£½Å
-	AFF_BOHO, // º¸È£
-	AFF_KWAESOK, // Äè¼Ó
-	AFF_MANASHIELD, // ¸¶³ª½¯µå
-	AFF_MUYEONG, // ¹«¿µÁø affect
-	AFF_REVIVE_INVISIBLE, // ºÎÈ°½Ã Àá½Ãµ¿¾È ¹«Àû
-	AFF_FIRE, // Áö¼Ó ºÒ µ¥¹ÌÁö
-	AFF_GICHEON, // ±âÃµ´ë°ø
-	AFF_JEUNGRYEOK, // Áõ·Â¼ú
-	AFF_TANHWAN_DASH, // ÅºÈ¯°Ý¿ë ´Þ¸®±â¾îÆåÆ®
-	AFF_PABEOP, // ÆÄ¹ý¼ú
-	AFF_CHEONGEUN_WITH_FALL, // Ãµ±ÙÃß
-
-	AFF_POLYMORPH, // Æú¸®¸ðÇÁ
-
-	AFF_WAR_FLAG1,
-	AFF_WAR_FLAG2,
-	AFF_WAR_FLAG3,
-
-	AFF_CHINA_FIREWORK,
-	AFF_CANNOT_ATTACK,
-	AFF_CANNOT_USE_SKILL,
-	AFF_DS,
-
-	AFF_BLEEDING,
-	AFF_RED_POSSESSION,
-	AFF_BLUE_POSSESSION,
-
-	AFF_UNK46,
-	AFF_UNK47,
-#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
-	AFF_UNBEATABLE,
-#endif
-
-	AFF_BATTLE_FIELD_RANK1,
-	AFF_BATTLE_FIELD_RANK2,
-	AFF_BATTLE_FIELD_RANK3,
-	AFF_TARGET_VICTIM,
-
-	AFF_UNK53,
-
-	AFF_ELECTRIC_SHOCK,
-	AFF_CONFUSION,
-
-#if defined(__SOUL_SYSTEM__)
-	AFF_SOUL_RED,
-	AFF_SOUL_BLUE,
-	AFF_SOUL_MIX,
-#endif
-
-	AFF_UNK59,
-	AFF_BATTLE_ROYALE_SLOW_1,
-	AFF_BATTLE_ROYALE_SLOW_2,
-	AFF_BATTLE_ROYALE_SLOW_3,
-
-	AFF_UNK63,
-	AFF_PASWAE,
-	AFF_UNK65,
-
-	AFF_ELEMENT_BUFF_CRACK_NONE,
-	AFF_ELEMENT_BUFF_CRACK_FIRE,
-	AFF_ELEMENT_BUFF_CRACK_ICE,
-	AFF_ELEMENT_BUFF_CRACK_ELECT,
-	AFF_ELEMENT_BUFF_CRACK_WIND,
-	AFF_ELEMENT_BUFF_CRACK_EARTH,
-	AFF_ELEMENT_BUFF_CRACK_DARK,
-
-	AFF_FLAG_UNK73, // guild_battle (blue)
-	AFF_FLAG_UNK74, // guild_battle (yellow)
-	AFF_FLAG_UNK75, // guild_battle (green)
-	AFF_FLAG_UNK76, // guild_battle (red)
-
-	AFF_FLAG_UNK77,
-	AFF_FLAG_UNK78,
-	AFF_FLAG_UNK79,
-	AFF_FLAG_UNK80,
-
-#if defined(__9TH_SKILL__)
-	AFF_CHEONUN_INVINCIBILITY,
-	AFF_CHEONUN_NORMAL,
-	AFF_CHEONUN_MASTER,
-	AFF_CHEONUN_GRAND_MASTER,
-	AFF_CHEONUN_PERFECT_MASTER,
-#endif
-
-	AFF_BITS_MAX,
-
-	AFF_HWAYEOM = AFF_GEOMGYEONG,
-};
-
-extern void SendAffectAddPacket(LPDESC d, CAffect* pkAff);
-
-// AFFECT_DURATION_BUG_FIX
-enum AffectVariable
-{
-	// Used when Affect should be set to infinity.
-	// Since time continues to decrease, infinity is emulated by using a very large value.
-	//// 24 bits are not enough, so 25 bits are used.
-	// ...Despite saying to use 25 bits, this is an enormous comment using 29 bits...
-	// In the collect quest, an infinite time of 60 years is used, so let's use 60 years here too.
-
-	INFINITE_AFFECT_DURATION = 60 * 365 * 24 * 60 * 60
-};
-// END_AFFECT_DURATION_BUG_FIX
-
-#endif // __INC_AFFECT_H__
+#ifndef __INC_AFFECT_H__
+#define __INC_AFFECT_H__
+
+
+#ifndef MAX_AFFECT_PER_CHARACTER
+#define MAX_AFFECT_PER_CHARACTER 128
+#endif
+class CAffect
+{
+public:
+	DWORD dwType;
+	POINT_TYPE wApplyOn;
+	POINT_VALUE lApplyValue;
+	DWORD dwFlag;
+	long lDuration;
+	long lSPCost;
+#if defined(__AFFECT_RENEWAL__)
+	bool bRealTime;
+	bool bUpdate;
+#endif
+#if defined(__9TH_SKILL__)
+	long lValue;
+#endif
+
+	static CAffect* Acquire();
+	static void Release(CAffect* p);
+};
+
+enum EAffectTypes
+{
+	AFFECT_NONE,
+
+	//AFFECT_GUILD_SKILL_BLOOD = 152,
+	//AFFECT_GUILD_SKILL_BLESS = 153,
+	//AFFECT_GUILD_SKILL_SEONGHWI = 154,
+	//AFFECT_GUILD_SKILL_ACCEL = 155,
+	//AFFECT_GUILD_SKILL_BUNNO = 156,
+	//AFFECT_GUILD_SKILL_JUMUN = 157,
+
+	//AFFECT_SKILL_9_FINISH = 176,
+	//AFFECT_SKILL_9_ILGWANGPYO = 177,
+	//AFFECT_SKILL_9_PUNGLOEPO = 178,
+	//AFFECT_SKILL_9_GEOMAGGWI = 179,
+	//AFFECT_SKILL_9_MABEOBAGGWI = 180,
+	//AFFECT_SKILL_9_METEO = 181,
+#if defined(__9TH_SKILL__)
+	AFFECT_SKILL_9_CHEONUN = 182,
+#endif
+	//AFFECT_SKILL_9_ILIPUNGU = 183,
+
+	AFFECT_MOV_SPEED = 200,
+	AFFECT_ATT_SPEED,
+	AFFECT_ATT_GRADE,
+	AFFECT_INVISIBILITY,
+	AFFECT_STR,
+	AFFECT_DEX,
+	AFFECT_CON,
+	AFFECT_INT,
+	AFFECT_FISH_MIND_PILL,
+
+	AFFECT_POISON,
+	AFFECT_STUN,
+	AFFECT_SLOW,
+	AFFECT_DUNGEON_READY,
+	AFFECT_DUNGEON_UNIQUE,
+
+	AFFECT_BUILDING,
+	AFFECT_REVIVE_INVISIBLE,
+	AFFECT_FIRE,
+	AFFECT_CAST_SPEED,
+	AFFECT_HP_RECOVER_CONTINUE,
+	AFFECT_SP_RECOVER_CONTINUE,
+
+	AFFECT_POLYMORPH,
+	AFFECT_MOUNT,
+
+	AFFECT_WAR_FLAG,
+
+	AFFECT_BLOCK_CHAT,
+	AFFECT_CHINA_FIREWORK,
+
+	AFFECT_BOW_DISTANCE,
+	AFFECT_DEF_GRADE,
+
+	AFFECT_BLEEDING,
+
+	//AFFECT_SKILL_MONSTER_WIDE_AREA_DAMAGE_SUNGMA_STR = 274,
+	//AFFECT_SKILL_MONSTER_ATT_GRADE_DOWN = 279,
+	//AFFECT_SKILL_POSION_DAMAGE_SUNGMA_MOVE = 280,
+	//AFFECT_SKILL_CRUSH_DAMAGE_SUNGMA_STR = 281,
+
+	AFFECT_RAMADAN_ABILITY = 300,
+	AFFECT_RAMADAN_RING = 301, // ï¿½ó¸¶´ï¿½ ï¿½Ìºï¿½Æ®ï¿½ï¿½ Æ¯ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½Ê½Â´ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½
+
+	AFFECT_NOG_ABILITY = 302,
+	AFFECT_HOLLY_STONE_POWER = 303,
+
+	AFFECT_PREMIUM_START = 500,
+	AFFECT_EXP_BONUS = 500, // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½
+	AFFECT_ITEM_BONUS = 501, // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½å°©
+	AFFECT_SAFEBOX = 502, // PREMIUM_SAFEBOX,
+	AFFECT_AUTOLOOT = 503, // PREMIUM_AUTOLOOT,
+	AFFECT_FISH_MIND = 504, // PREMIUM_FISH_MIND,
+	AFFECT_MARRIAGE_FAST = 505, // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½
+	AFFECT_GOLD_BONUS = 506, // ï¿½ï¿½ ï¿½ï¿½ï¿½È®ï¿½ï¿½ 50%ï¿½ï¿½ï¿½ï¿½
+	AFFECT_AUTO_USE = 507, // ï¿½Úµï¿½ ï¿½ï¿½ï¿½
+#if defined(__CONQUEROR_LEVEL__)
+	AFFECT_SUNGMA_BONUS = 508,
+#endif
+	AFFECT_PREMIUM_END = 509,
+
+	AFFECT_MALL = 510, // ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½Æ®
+	AFFECT_NO_DEATH_PENALTY = 511, // ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½È£ (ï¿½ï¿½ï¿½ï¿½Ä¡ï¿½ï¿½ ï¿½Ð³ï¿½Æ¼ï¿½ï¿½ ï¿½Ñ¹ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½Ø´ï¿½)
+	AFFECT_SKILL_BOOK_BONUS = 512, // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ (Ã¥ ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ È®ï¿½ï¿½ï¿½ï¿½ 50% ï¿½ï¿½ï¿½ï¿½)
+	AFFECT_SKILL_NO_BOOK_DELAY = 513, // ï¿½Ö¾È¼ï¿½ï¿½ï¿½
+
+	AFFECT_HAIR = 514, // ï¿½ï¿½ï¿½ È¿ï¿½ï¿½
+	AFFECT_COLLECT = 515, // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ® 
+
+	AFFECT_EXP_BONUS_EURO_FREE = 516, // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ (ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ 14 ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½âº» È¿ï¿½ï¿½)
+	AFFECT_EXP_BONUS_EURO_FREE_UNDER_15 = 517,
+	AFFECT_UNIQUE_ABILITY = 518,
+
+	AFFECT_BLEND,
+
+	AFFECT_HORSE_NAME,
+	AFFECT_MOUNT_BONUS,
+
+	AFFECT_AUTO_HP_RECOVERY = 534,
+	AFFECT_AUTO_SP_RECOVERY = 535,
+
+#if defined(__LOOT_FILTER_SYSTEM__) && defined(__PREMIUM_LOOT_FILTER__)
+	AFFECT_LOOTING_SYSTEM = 537,
+#endif
+
+	//AFFECT_UNKNOWN_538,
+	//AFFECT_UNKNOWN_539,
+
+	AFFECT_DRAGON_SOUL_QUALIFIED = 540,
+	AFFECT_DRAGON_SOUL_DECK_0 = 541,
+	AFFECT_DRAGON_SOUL_DECK_1 = 542,
+
+	//AFFECT_PVP_EXPBONUS = 543,
+	//AFFECT_IMPOSSIBLE_ATTACK = 544,
+	//AFFECT_PVP_ENTER = 545,
+
+#ifdef __GROWTH_PET_SYSTEM__
+	AFFECT_GROWTH_PET = 545,
+#endif
+
+#if defined(__SOUL_SYSTEM__)
+	AFFECT_SOUL = 546,
+#endif
+#ifdef __OFFLINE_SHOP__
+	AFFECT_OFFLINE_SHOP_DECORATION = 547,
+#endif
+
+	//AFFECT_UNKNOWN_549,
+
+#if defined(__SET_ITEM__)
+	AFFECT_SET_ITEM = 550,
+#endif
+	//AFFECT_EXP_BONUS_EVENT = 551,
+	//AFFECT_ATT_SPEED_SLOW = 552,
+	//AFFECT_PEPSI_EVENT = 553,
+	//AFFECT_SUMMER_EVENT = 554,
+
+	//AFFECT_BATTLE_FIELD = 555,
+	//AFFECT_BATTLE_POTION = 556,
+	//AFFECT_BATTLE_RANK = 557,
+
+#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
+	AFFECT_RED_DRAGONLAIR_STONE = 558,
+#endif
+	//AFFECT_UNKNOWN_559,
+
+	//AFFECT_LUCKEY_EVENT_BUFF = 560,
+	AFFECT_MOUNT_FALL = 561,
+	//AFFECT_NO_RECOVERY = 562,
+	//AFFECT_REDUCE_CAST_SPEED = 563,
+	//AFFECT_UNKNOWN_564,
+
+	//AFFECT_ATT_GRADE_DOWN = 565,
+	//AFFECT_DEF_GRADE_DOWN = 566,
+
+	//AFFECT_CRITICAL_PCT_DOWN = 567,
+	//AFFECT_CZ_UNLIMIT_ENTER = 568,
+	//AFFECT_UNKNOWN_569,
+#if defined(__FLOWER_EVENT__)
+	AFFECT_FLOWER_EVENT = 570,
+#endif
+#if defined(__DS_SET__)
+	AFFECT_DS_SET = 571,
+#endif
+	AFFECT_RESEARCHER_ELIXIR = 572,
+#if defined(__DEFENSE_WAVE__)
+	AFFECT_DEFENSEWAVE_LASER = 573,
+#endif
+
+	//AFFECT_NO_DEATH_PENALTY_PLUS = 574,
+#if defined(__YUTNORI_EVENT_FLAG_RENEWAL__)
+	AFFECT_HALLOWEEN_EVENT = 575,
+#endif
+	//AFFECT_UNKNOWN_576,
+#if defined(__FISHING_GAME__)
+	AFFECT_FISHING_GOLD_TUNA = 577,
+	AFFECT_FISHING_MOVE_SPEED_DOWN = 578,
+#endif
+	//AFFECT_UNKNOWN_579,
+	AFFECT_SAFE_BOX_BUFF = 580,
+	//AFFECT_UNKNOWN_581,
+	//AFFECT_MALL_EXP_BONUS = 582,
+
+#if defined(__SUMMER_EVENT_ROULETTE__)
+	AFFECT_LATE_SUMMER_EVENT_BUFF = 583,
+	AFFECT_LATE_SUMMER_EVENT_PRIMIUM_BUFF = 584,
+#endif
+
+#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
+	AFFECT_RED_DRAGONLAIR_BUFF = 585,
+#endif
+	//AFFECT_MISTS_ISLAND_BUFF = 586,
+
+	//AFFECT_SEASON_RANKING_BUFF = 587,
+	//AFFECT_SEASON_PVE_BUFF = 588,
+	//AFFECT_UNKNOWN_589,
+
+	//AFFECT_BATTLE_ROYALE_SLOW = 590,
+	//AFFECT_BATTLE_ROYALE_MOVE_SPEED = 591,
+	//AFFECT_UNKNOWN_592,
+
+	//AFFECT_PASSIVE_JOB_DECK = 593,
+#if defined(__ELEMENTAL_DUNGEON__)
+	AFFECT_CURSE_OF_ELEMENTAL = 594,
+	AFFECT_PROTECTION_OF_ELEMENTAL = 595,
+	AFFECT_POTION_OF_ELEMENTAL = 596,
+#endif
+	//AFFECT_UNKNOWN_597,
+	//AFFECT_UNKNOWN_598,
+	//AFFECT_UNKNOWN_599,
+	//AFFECT_BATTLE_ROYALE_INFINITE_STAMINA = 600,
+
+#if defined(__SET_ITEM__)
+	AFFECT_SET_ITEM_SET_VALUE_1 = 601,
+	AFFECT_SET_ITEM_SET_VALUE_2 = 602,
+	AFFECT_SET_ITEM_SET_VALUE_3 = 603,
+	AFFECT_SET_ITEM_SET_VALUE_4 = 604,
+	AFFECT_SET_ITEM_SET_VALUE_5 = 605,
+#endif
+	//AFFECT_UNKNOWN_606,
+	//AFFECT_UNKNOWN_607,
+
+#if defined(__9TH_SKILL__)
+	AFFECT_CHEONUN_INVINCIBILITY = 608,
+#endif
+
+	//AFFECT_WORLD_BOSS_REWARD = 609,
+	//AFFECT_WORLD_BOSS_DAILY_REWARD = 610,
+
+	//AFFECT_SUNGMAHEE_TOWER_BUFF = 611,
+	//AFFECT_SUNGMAHEE_TOWER_DEBUFF = 612,
+	//AFFECT_SUNGMAHEE_TOWER_CURSE = 613,
+	//AFFECT_UNKNOWN_614,
+	//AFFECT_GARRISON_DEBUFF = 615,
+	//AFFECT_GARRISON_BUFF = 616,
+
+	//AFFECT_UNKNOWN_617,
+	//AFFECT_UNKNOWN_618,
+	//AFFECT_UNKNOWN_619,
+	//AFFECT_UNKNOWN_620,
+	//AFFECT_UNKNOWN_621,
+	//AFFECT_UNKNOWN_622,
+
+#if defined(__CONQUEROR_LEVEL__)
+	AFFECT_SUNGMA_STR = 623,
+	AFFECT_SUNGMA_HP = 624,
+	AFFECT_SUNGMA_MOVE = 625,
+	AFFECT_SUNGMA_IMMUNE = 626,
+#endif
+
+	//AFFECT_UNKNOWN_627,
+	//AFFECT_UNKNOWN_628,
+	//AFFECT_SUBQUEST_NEWWORLD_5 = 629,
+	//AFFECT_WHITE_DRAGON_CAVE_CURSE = 630,
+
+	//AFFECT_SECRET_DUNGEON_BUFF_POINT_C = 631,
+	//AFFECT_SECRET_DUNGEON_BUFF_C = 632,
+	//AFFECT_SECRET_DUNGEON_BUFF_B = 633,
+	//AFFECT_SECRET_DUNGEON_BUFF_A = 634,
+
+	//AFFECT_OTHER_WORLD_DEAD_SOUL = 635,
+	//AFFECT_OTHER_WORLD_GOBLIN_PROTECTION = 636,
+	//AFFECT_OTHER_WORLD_YEOMWANG_CURSE = 637,
+	//AFFECT_OTHER_WORLD_NORTH_REAPER_ROOM_DEBUFF = 638,
+
+	//AFFECT_SKILL_MOUNT_UPGRADE_NIMBLE = 639,
+	//AFFECT_SKILL_MOUNT_UPGRADE_EXP = 640,
+	//AFFECT_SKILL_MOUNT_UPGRADE_SPEED = 641,
+	//AFFECT_SKILL_MOUNT_UPGRADE_GYENONGGONG = 642,
+	//AFFECT_SKILL_MOUNT_UPGRADE_INVINCIBLITIY = 643,
+	//AFFECT_SKILL_MOUNT_UPGRADE_KNOCKBACK = 644,
+	//AFFECT_SKILL_MOUNT_UPGRADE_TO_STRONG = 645,
+	//AFFECT_SKILL_MOUNT_UPGRADE_EFFECT_UP = 646,
+	//AFFECT_SKILL_MOUNT_UPGRADE_SUNGMA_STR = 647,
+	//AFFECT_SKILL_MOUNT_UPGRADE_SUNGMA_HP = 648,
+	//AFFECT_SKILL_MOUNT_UPGRADE_SUNGMA_MOVE = 649,
+	//AFFECT_SKILL_MOUNT_UPGRADE_SUNGMA_IMMUNE = 650,
+	//AFFECT_SKILL_MOUNT_UPGRADE_HIT_PCT = 651,
+
+	//AFFECT_MERCENARY_MISSION_MAX_ACTIVE_INCREASE = 652,
+	//AFFECT_SECRET_DUNGEON_BUFF_POINT_B = 653,
+	//AFFECT_SECRET_DUNGEON_BUFF_POINT_A = 654,
+	AFFECT_ELEMENT_BUFF_CRACK = 655,
+	//AFFECT_FLOWER_OF_GALE = 656,
+	//AFFECT_FLOWER_OF_DESTRUCTION = 657,
+	//AFFECT_UNKNOWN_658,
+	//AFFECT_UNKNOWN_659,
+	//AFFECT_UNKNOWN_660,
+	//AFFECT_UNKNOWN_661,
+	//AFFECT_IMMUNE_MINE_TOWER_SKILL = 662,
+#if defined(__SNOWFLAKE_STICK_EVENT__)
+	AFFECT_SNOWFLAKE_STICK_EVENT_RANK_BUFF = 663,
+	AFFECT_SNOWFLAKE_STICK_EVENT_SNOWFLAKE_BUFF = 664,
+#endif
+
+	AFFECT_QUEST_START_IDX = 1000,
+
+	AFFECT_MAX
+};
+
+enum EAffectBits
+{
+	AFF_NONE,
+
+	AFF_YMIR,
+	AFF_INVISIBILITY,
+	AFF_SPAWN,
+
+	AFF_POISON,
+	AFF_SLOW,
+	AFF_STUN,
+
+	AFF_DUNGEON_READY, // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½Øºï¿½ ï¿½ï¿½ï¿½ï¿½
+	AFF_DUNGEON_UNIQUE, // ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½Å© (Å¬ï¿½ï¿½ï¿½Ì¾ï¿½Æ®ï¿½ï¿½ï¿½ï¿½ ï¿½Ã¸ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½)
+
+	AFF_BUILDING_CONSTRUCTION_SMALL, // AFF_SHACKLE
+	AFF_BUILDING_CONSTRUCTION_LARGE,
+	AFF_BUILDING_UPGRADE,
+
+	AFF_MOV_SPEED_POTION,
+	AFF_ATT_SPEED_POTION,
+
+	AFF_FISH_MIND,
+
+	AFF_JEONGWIHON, // ï¿½ï¿½ï¿½ï¿½È¥
+	AFF_GEOMGYEONG, // ï¿½Ë°ï¿½
+	AFF_CHEONGEUN, // Ãµï¿½ï¿½ï¿½ï¿½
+	AFF_GYEONGGONG, // ï¿½ï¿½ï¿½ï¿½ï¿½
+	AFF_EUNHYUNG, // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
+	AFF_GWIGUM, // ï¿½Í°ï¿½
+	AFF_TERROR, // ï¿½ï¿½ï¿½ï¿½
+	AFF_JUMAGAP, // ï¿½Ö¸ï¿½ï¿½ï¿½
+	AFF_HOSIN, // È£ï¿½ï¿½
+	AFF_BOHO, // ï¿½ï¿½È£
+	AFF_KWAESOK, // ï¿½ï¿½ï¿½
+	AFF_MANASHIELD, // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
+	AFF_MUYEONG, // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ affect
+	AFF_REVIVE_INVISIBLE, // ï¿½ï¿½È°ï¿½ï¿½ ï¿½ï¿½Ãµï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½
+	AFF_FIRE, // ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
+	AFF_GICHEON, // ï¿½ï¿½Ãµï¿½ï¿½ï¿½
+	AFF_JEUNGRYEOK, // ï¿½ï¿½ï¿½Â¼ï¿½
+	AFF_TANHWAN_DASH, // ÅºÈ¯ï¿½Ý¿ï¿½ ï¿½Þ¸ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Æ®
+	AFF_PABEOP, // ï¿½Ä¹ï¿½ï¿½ï¿½
+	AFF_CHEONGEUN_WITH_FALL, // Ãµï¿½ï¿½ï¿½ï¿½
+
+	AFF_POLYMORPH, // ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
+
+	AFF_WAR_FLAG1,
+	AFF_WAR_FLAG2,
+	AFF_WAR_FLAG3,
+
+	AFF_CHINA_FIREWORK,
+	AFF_CANNOT_ATTACK,
+	AFF_CANNOT_USE_SKILL,
+	AFF_DS,
+
+	AFF_BLEEDING,
+	AFF_RED_POSSESSION,
+	AFF_BLUE_POSSESSION,
+
+	AFF_UNK46,
+	AFF_UNK47,
+#if defined(__GUILD_DRAGONLAIR_SYSTEM__)
+	AFF_UNBEATABLE,
+#endif
+
+	AFF_BATTLE_FIELD_RANK1,
+	AFF_BATTLE_FIELD_RANK2,
+	AFF_BATTLE_FIELD_RANK3,
+	AFF_TARGET_VICTIM,
+
+	AFF_UNK53,
+
+	AFF_ELECTRIC_SHOCK,
+	AFF_CONFUSION,
+
+#if defined(__SOUL_SYSTEM__)
+	AFF_SOUL_RED,
+	AFF_SOUL_BLUE,
+	AFF_SOUL_MIX,
+#endif
+
+	AFF_UNK59,
+	AFF_BATTLE_ROYALE_SLOW_1,
+	AFF_BATTLE_ROYALE_SLOW_2,
+	AFF_BATTLE_ROYALE_SLOW_3,
+
+	AFF_UNK63,
+	AFF_PASWAE,
+	AFF_UNK65,
+
+	AFF_ELEMENT_BUFF_CRACK_NONE,
+	AFF_ELEMENT_BUFF_CRACK_FIRE,
+	AFF_ELEMENT_BUFF_CRACK_ICE,
+	AFF_ELEMENT_BUFF_CRACK_ELECT,
+	AFF_ELEMENT_BUFF_CRACK_WIND,
+	AFF_ELEMENT_BUFF_CRACK_EARTH,
+	AFF_ELEMENT_BUFF_CRACK_DARK,
+
+	AFF_FLAG_UNK73, // guild_battle (blue)
+	AFF_FLAG_UNK74, // guild_battle (yellow)
+	AFF_FLAG_UNK75, // guild_battle (green)
+	AFF_FLAG_UNK76, // guild_battle (red)
+
+	AFF_FLAG_UNK77,
+	AFF_FLAG_UNK78,
+	AFF_FLAG_UNK79,
+	AFF_FLAG_UNK80,
+
+#if defined(__9TH_SKILL__)
+	AFF_CHEONUN_INVINCIBILITY,
+	AFF_CHEONUN_NORMAL,
+	AFF_CHEONUN_MASTER,
+	AFF_CHEONUN_GRAND_MASTER,
+	AFF_CHEONUN_PERFECT_MASTER,
+#endif
+
+	AFF_BITS_MAX,
+
+	AFF_HWAYEOM = AFF_GEOMGYEONG,
+};
+
+extern void SendAffectAddPacket(LPDESC d, CAffect* pkAff);
+
+// AFFECT_DURATION_BUG_FIX
+enum AffectVariable
+{
+	// Used when Affect should be set to infinity.
+	// Since time continues to decrease, infinity is emulated by using a very large value.
+	//// 24 bits are not enough, so 25 bits are used.
+	// ...Despite saying to use 25 bits, this is an enormous comment using 29 bits...
+	// In the collect quest, an infinite time of 60 years is used, so let's use 60 years here too.
+
+	INFINITE_AFFECT_DURATION = 60 * 365 * 24 * 60 * 60
+};
+// END_AFFECT_DURATION_BUG_FIX
+
+#endif // __INC_AFFECT_H__
diff --git a/server/metin2/Source/Server/game/src/char_affect.cpp b/server/metin2/Source/Server/game/src/char_affect.cpp
index 7726ef5..e7781d0 100644
--- a/server/metin2/Source/Server/game/src/char_affect.cpp
+++ b/server/metin2/Source/Server/game/src/char_affect.cpp
@@ -1,1061 +1,1067 @@
-#include "stdafx.h"
-
-#include "config.h"
-#include "char.h"
-#include "char_manager.h"
-#include "affect.h"
-#include "packet.h"
-#include "buffer_manager.h"
-#include "desc_client.h"
-#include "battle.h"
-#include "guild.h"
-#include "utils.h"
-#include "locale_service.h"
-#include "lua_incl.h"
-#include "arena.h"
-#include "horsename_manager.h"
-#include "item.h"
-#include "DragonSoul.h"
-#if defined(__SNOWFLAKE_STICK_EVENT__)
-#	include "xmas_event.h"
-#endif
-
-#define IS_NO_SAVE_AFFECT(type) ((type) == AFFECT_WAR_FLAG || (type) == AFFECT_REVIVE_INVISIBLE || ((type) >= AFFECT_PREMIUM_START && (type) <= AFFECT_PREMIUM_END)/* || ((type) == AFFECT_OFFLINE_SHOP_DECORATION)*/ || (type) == AFFECT_MOUNT_BONUS)
-#define IS_NO_CLEAR_ON_DEATH_AFFECT(type) ((type) == AFFECT_BLOCK_CHAT || ((type) >= 500 && (type) < 600))
-#if defined(__SET_ITEM__)
-#	define IS_NO_CLEAR_SET_ITEM(type) ((type) == AFFECT_SET_ITEM || ((type) >= AFFECT_SET_ITEM_SET_VALUE_1 && (type) <= AFFECT_SET_ITEM_SET_VALUE_5))
-#endif
-
-void SendAffectRemovePacket(LPDESC pDesc, DWORD dwPID, DWORD dwType, POINT_TYPE wApplyOn)
-{
-	TPacketGCAffectRemove ptoc;
-	ptoc.bHeader = HEADER_GC_AFFECT_REMOVE;
-	ptoc.dwType = dwType;
-	ptoc.wApplyOn = wApplyOn;
-	pDesc->Packet(&ptoc, sizeof(TPacketGCAffectRemove));
-
-	TPacketGDRemoveAffect ptod;
-	ptod.dwPID = dwPID;
-	ptod.dwType = dwType;
-	ptod.wApplyOn = wApplyOn;
-	db_clientdesc->DBPacket(HEADER_GD_REMOVE_AFFECT, 0, &ptod, sizeof(ptod));
-}
-
-void SendAffectAddPacket(LPDESC pDesc, CAffect* pkAff)
-{
-	TPacketGCAffectAdd ptoc;
-	ptoc.bHeader = HEADER_GC_AFFECT_ADD;
-	ptoc.elem.dwType = pkAff->dwType;
-	ptoc.elem.wApplyOn = pkAff->wApplyOn;
-	ptoc.elem.lApplyValue = pkAff->lApplyValue;
-	ptoc.elem.dwFlag = pkAff->dwFlag;
-	ptoc.elem.lDuration = pkAff->lDuration;
-	ptoc.elem.lSPCost = pkAff->lSPCost;
-#if defined(__AFFECT_RENEWAL__)
-	ptoc.elem.bRealTime = pkAff->bRealTime;
-	ptoc.elem.bUpdate = pkAff->bUpdate;
-#endif
-	pDesc->Packet(&ptoc, sizeof(TPacketGCAffectAdd));
-}
-
-////////////////////////////////////////////////////////////////////
-// Affect
-CAffect* CHARACTER::FindAffect(DWORD dwType, POINT_TYPE wApplyType) const
-{
-	for (const auto& it : m_list_pkAffect)
-	{
-		CAffect* pkAffect = it;
-		if (pkAffect && (pkAffect->dwType == dwType && (wApplyType == APPLY_NONE || wApplyType == pkAffect->wApplyOn)))
-			return pkAffect;
-	}
-
-	return NULL;
-}
-
-EVENTFUNC(affect_event)
-{
-	char_event_info* info = dynamic_cast<char_event_info*>(event->info);
-
-	if (info == NULL)
-	{
-		sys_err("affect_event> <Factor> Null pointer");
-		return 0;
-	}
-
-	LPCHARACTER ch = info->ch;
-
-	if (ch == NULL) // <Factor>
-		return 0;
-
-	if (!ch->UpdateAffect())
-		return 0;
-	else
-		return passes_per_sec; // 1ÃÊ
-}
-
-bool CHARACTER::UpdateAffect()
-{
-	// affect_event ¿¡¼­ Ã³¸®ÇÒ ÀÏÀº ¾Æ´ÏÁö¸¸, 1ÃÊÂ¥¸® ÀÌº¥Æ®¿¡¼­ Ã³¸®ÇÏ´Â °ÍÀÌ
-	// ÀÌ°Í »ÓÀÌ¶ó ¿©±â¼­ ¹°¾à Ã³¸®¸¦ ÇÑ´Ù.
-	if (GetPoint(POINT_HP_RECOVERY) > 0)
-	{
-		if (GetMaxHP() <= GetHP())
-		{
-			PointChange(POINT_HP_RECOVERY, -GetPoint(POINT_HP_RECOVERY));
-		}
-		else
-		{
-			int iVal = MIN(GetPoint(POINT_HP_RECOVERY), GetMaxHP() * 9 / 100);
-
-			PointChange(POINT_HP, iVal);
-			PointChange(POINT_HP_RECOVERY, -iVal);
-		}
-	}
-
-	if (GetPoint(POINT_SP_RECOVERY) > 0)
-	{
-		if (GetMaxSP() <= GetSP())
-		{
-			PointChange(POINT_SP_RECOVERY, -GetPoint(POINT_SP_RECOVERY));
-		}
-		else
-		{
-			int iVal = MIN(GetPoint(POINT_SP_RECOVERY), GetMaxSP() * 7 / 100);
-
-			PointChange(POINT_SP, iVal);
-			PointChange(POINT_SP_RECOVERY, -iVal);
-		}
-	}
-
-	if (GetPoint(POINT_HP_RECOVER_CONTINUE) > 0)
-	{
-		PointChange(POINT_HP, GetPoint(POINT_HP_RECOVER_CONTINUE));
-	}
-
-	if (GetPoint(POINT_SP_RECOVER_CONTINUE) > 0)
-	{
-		PointChange(POINT_SP, GetPoint(POINT_SP_RECOVER_CONTINUE));
-	}
-
-	AutoRecoveryItemProcess(AFFECT_AUTO_HP_RECOVERY);
-	AutoRecoveryItemProcess(AFFECT_AUTO_SP_RECOVERY);
-
-	// ½ºÅ×¹Ì³ª È¸º¹
-	if (GetMaxStamina() > GetStamina())
-	{
-		int iSec = (get_dword_time() - GetStopTime()) / 3000;
-		if (iSec)
-			PointChange(POINT_STAMINA, GetMaxStamina() / 1);
-	}
-
-	// ProcessAffect´Â affect°¡ ¾øÀ¸¸é true¸¦ ¸®ÅÏÇÑ´Ù.
-	if (ProcessAffect())
-	{
-		if (GetPoint(POINT_HP_RECOVERY) == 0 && GetPoint(POINT_SP_RECOVERY) == 0 && GetStamina() == GetMaxStamina())
-		{
-			m_pkAffectEvent = NULL;
-			return false;
-		}
-	}
-
-	return true;
-}
-
-void CHARACTER::StartAffectEvent()
-{
-	if (m_pkAffectEvent)
-		return;
-
-	char_event_info* info = AllocEventInfo<char_event_info>();
-	info->ch = this;
-	m_pkAffectEvent = event_create(affect_event, info, passes_per_sec);
-	sys_log(1, "StartAffectEvent %s %p %p", GetName(), this, get_pointer(m_pkAffectEvent));
-}
-
-void CHARACTER::ClearAffect(bool bSave)
-{
-	TAffectFlag afOld = m_afAffectFlag;
-	long lMovSpd = GetPoint(POINT_MOV_SPEED);
-	long lAttSpd = GetPoint(POINT_ATT_SPEED);
-
-	AffectContainerList::iterator it = m_list_pkAffect.begin();
-	while (it != m_list_pkAffect.end())
-	{
-		CAffect* pkAff = *it;
-		if (pkAff == nullptr)
-			continue;
-
-		if (bSave)
-		{
-			if (IS_NO_CLEAR_ON_DEATH_AFFECT(pkAff->dwType) || IS_NO_SAVE_AFFECT(pkAff->dwType))
-			{
-				++it;
-				continue;
-			}
-
-#if defined(__SOUL_SYSTEM__)
-			if (pkAff->dwType == AFFECT_SOUL)
-			{
-				++it;
-				continue;
-			}
-#endif
-
-#if defined(__SET_ITEM__)
-			if (IS_NO_CLEAR_SET_ITEM(pkAff->dwType))
-			{
-				++it;
-				continue;
-			}
-#endif
-
-#if defined(__SNOWFLAKE_STICK_EVENT__)
-			if (pkAff->dwType == AFFECT_SNOWFLAKE_STICK_EVENT_RANK_BUFF
-				|| pkAff->dwType == AFFECT_SNOWFLAKE_STICK_EVENT_SNOWFLAKE_BUFF)
-			{
-				++it;
-				continue;
-			}
-#endif
-
-			if (IsPC())
-			{
-				SendAffectRemovePacket(GetDesc(), GetPlayerID(), pkAff->dwType, pkAff->wApplyOn);
-			}
-		}
-
-		ComputeAffect(pkAff, false);
-
-		it = m_list_pkAffect.erase(it);
-		CAffect::Release(pkAff);
-	}
-
-	if (afOld != m_afAffectFlag || lMovSpd != GetPoint(POINT_MOV_SPEED) || lAttSpd != GetPoint(POINT_ATT_SPEED))
-		UpdatePacket();
-
-	CheckMaximumPoints();
-
-	if (m_list_pkAffect.empty())
-		event_cancel(&m_pkAffectEvent);
-}
-
-int CHARACTER::ProcessAffect()
-{
-	bool bDiff = false;
-	CAffect* pkAff = NULL;
-
-	//
-	// ÇÁ¸®¹Ì¾ö Ã³¸®
-	//
-	for (BYTE i = 0; i <= PREMIUM_MAX_NUM; ++i)
-	{
-		int aff_idx = i + AFFECT_PREMIUM_START;
-
-		pkAff = FindAffect(aff_idx);
-		if (!pkAff)
-			continue;
-
-		int remain = GetPremiumRemainSeconds(i);
-		if (remain < 0)
-		{
-			RemoveAffect(aff_idx);
-			bDiff = true;
-		}
-		else
-			pkAff->lDuration = remain + 1;
-	}
-
-#ifdef __OFFLINE_SHOP__
-	if (FindAffect(AFFECT_OFFLINE_SHOP_DECORATION))
-	{
-		pkAff = FindAffect(AFFECT_OFFLINE_SHOP_DECORATION);
-
-		if (pkAff)
-		{
-			int decorationRemain = GetQuestFlag("decoration.limit_time");
-			if (decorationRemain > 0)
-			{
-				decorationRemain = decorationRemain - get_global_time();
-			}
-			if (decorationRemain < 0)
-			{
-				RemoveAffect(AFFECT_OFFLINE_SHOP_DECORATION);
-				bDiff = true;
-			}
-			else
-				pkAff->lDuration = decorationRemain + 1;
-		}
-	}
-#endif
-
-	////////// HAIR_AFFECT
-	pkAff = FindAffect(AFFECT_HAIR);
-	if (pkAff)
-	{
-		// IF HAIR_LIMIT_TIME() < CURRENT_TIME()
-		if (this->GetQuestFlag("hair.limit_time") < get_global_time())
-		{
-			// SET HAIR NORMAL
-			this->SetPart(PART_HAIR, 0);
-			// REMOVE HAIR AFFECT
-			RemoveAffect(AFFECT_HAIR);
-		}
-		else
-		{
-			// INCREASE AFFECT DURATION
-			++(pkAff->lDuration);
-		}
-	}
-	////////// HAIR_AFFECT
-
-	CHorseNameManager::instance().Validate(this);
-
-	TAffectFlag afOld = m_afAffectFlag;
-	long lMovSpd = GetPoint(POINT_MOV_SPEED);
-	long lAttSpd = GetPoint(POINT_ATT_SPEED);
-
-	AffectContainerList::iterator it = m_list_pkAffect.begin();
-	while (it != m_list_pkAffect.end())
-	{
-		pkAff = *it;
-		if (pkAff == nullptr)
-			continue;
-
-		bool bEnd = false;
-
-		if (pkAff->dwType >= GUILD_SKILL_START && pkAff->dwType <= GUILD_SKILL_END)
-		{
-			if (!GetGuild() || !GetGuild()->UnderAnyWar())
-				bEnd = true;
-		}
-
-		if (pkAff->lSPCost > 0)
-		{
-			if (GetSP() < pkAff->lSPCost)
-				bEnd = true;
-			else
-				PointChange(POINT_SP, -pkAff->lSPCost);
-		}
-
-		// AFFECT_DURATION_BUG_FIX
-		// ¹«ÇÑ È¿°ú ¾ÆÀÌÅÛµµ ½Ã°£À» ÁÙÀÎ´Ù.
-		// ½Ã°£À» ¸Å¿ì Å©°Ô Àâ±â ¶§¹®¿¡ »ó°ü ¾øÀ» °ÍÀÌ¶ó »ý°¢µÊ.
-#if defined(__AFFECT_RENEWAL__)
-		if (pkAff->bRealTime)
-		{
-			if (pkAff->lDuration < get_global_time())
-				bEnd = true;
-		}
-		else
-		{
-			if (--pkAff->lDuration <= 0)
-				bEnd = true;
-		}
-#else
-		if (--pkAff->lDuration <= 0)
-		{
-			bEnd = true;
-		}
-#endif
-		// END_AFFECT_DURATION_BUG_FIX
-
-		if (bEnd)
-		{
-			it = m_list_pkAffect.erase(it);
-			ComputeAffect(pkAff, false);
-			bDiff = true;
-
-			if (IsPC())
-				SendAffectRemovePacket(GetDesc(), GetPlayerID(), pkAff->dwType, pkAff->wApplyOn);
-
-			CAffect::Release(pkAff);
-			continue;
-		}
-
-		++it;
-	}
-
-	if (bDiff)
-	{
-		if (afOld != m_afAffectFlag || lMovSpd != GetPoint(POINT_MOV_SPEED) || lAttSpd != GetPoint(POINT_ATT_SPEED))
-			UpdatePacket();
-
-		CheckMaximumPoints();
-	}
-
-	if (m_list_pkAffect.empty())
-		return true;
-
-	return false;
-}
-
-void CHARACTER::SaveAffect()
-{
-	TPacketGDAddAffect p = {};
-
-	AffectContainerList::iterator it = m_list_pkAffect.begin();
-	while (it != m_list_pkAffect.end())
-	{
-		CAffect* pkAff = *it++;
-		if (pkAff == nullptr)
-			continue;
-
-		if (IS_NO_SAVE_AFFECT(pkAff->dwType))
-			continue;
-
-		sys_log(1, "AFFECT_SAVE: %u %u %ld %d", pkAff->dwType, pkAff->wApplyOn, pkAff->lApplyValue, pkAff->lDuration);
-
-		p.dwPID = GetPlayerID();
-		p.elem.dwType = pkAff->dwType;
-		p.elem.wApplyOn = pkAff->wApplyOn;
-		p.elem.lApplyValue = pkAff->lApplyValue;
-		p.elem.dwFlag = pkAff->dwFlag;
-		p.elem.lDuration = pkAff->lDuration;
-		p.elem.lSPCost = pkAff->lSPCost;
-#if defined(__AFFECT_RENEWAL__)
-		p.elem.bRealTime = pkAff->bRealTime;
-		p.elem.bUpdate = pkAff->bUpdate;
-#endif
-		db_clientdesc->DBPacket(HEADER_GD_ADD_AFFECT, 0, &p, sizeof(p));
-	}
-}
-
-EVENTINFO(load_affect_login_event_info)
-{
-	DWORD pid;
-	DWORD count;
-	char* data;
-
-	load_affect_login_event_info()
-		: pid(0)
-		, count(0)
-		, data(0)
-	{
-	}
-};
-
-EVENTFUNC(load_affect_login_event)
-{
-	load_affect_login_event_info* info = dynamic_cast<load_affect_login_event_info*>(event->info);
-
-	if (info == NULL)
-	{
-		sys_err("load_affect_login_event_info> <Factor> Null pointer");
-		return 0;
-	}
-
-	DWORD dwPID = info->pid;
-	LPCHARACTER ch = CHARACTER_MANAGER::instance().FindByPID(dwPID);
-
-	if (!ch)
-	{
-		M2_DELETE_ARRAY(info->data);
-		return 0;
-	}
-
-	LPDESC d = ch->GetDesc();
-
-	if (!d)
-	{
-		M2_DELETE_ARRAY(info->data);
-		return 0;
-	}
-
-	if (d->IsPhase(PHASE_HANDSHAKE) ||
-		d->IsPhase(PHASE_LOGIN) ||
-		d->IsPhase(PHASE_SELECT) ||
-		d->IsPhase(PHASE_DEAD) ||
-		d->IsPhase(PHASE_LOADING))
-	{
-		return PASSES_PER_SEC(1);
-	}
-	else if (d->IsPhase(PHASE_CLOSE))
-	{
-		M2_DELETE_ARRAY(info->data);
-		return 0;
-	}
-	else if (d->IsPhase(PHASE_GAME))
-	{
-		sys_log(1, "Affect Load by Event");
-		ch->LoadAffect(info->count, (TPacketAffectElement*)info->data);
-		M2_DELETE_ARRAY(info->data);
-		return 0;
-	}
-	else
-	{
-		sys_err("input_db.cpp:quest_login_event INVALID PHASE pid %d", ch->GetPlayerID());
-		M2_DELETE_ARRAY(info->data);
-		return 0;
-	}
-}
-
-void CHARACTER::LoadAffect(DWORD dwCount, TPacketAffectElement* pElements)
-{
-	m_bIsLoadedAffect = false;
-
-	if (!GetDesc()->IsPhase(PHASE_GAME))
-	{
-		if (test_server)
-			sys_log(0, "LOAD_AFFECT: Storing", GetName(), dwCount);
-
-		load_affect_login_event_info* info = AllocEventInfo<load_affect_login_event_info>();
-		info->pid = GetPlayerID();
-		info->count = dwCount;
-		info->data = M2_NEW char[sizeof(TPacketAffectElement) * dwCount];
-		thecore_memcpy(info->data, pElements, sizeof(TPacketAffectElement) * dwCount);
-
-		event_create(load_affect_login_event, info, PASSES_PER_SEC(1));
-
-		return;
-	}
-
-	ClearAffect(true);
-
-	if (test_server)
-		sys_log(0, "LOAD_AFFECT: %s count %d", GetName(), dwCount);
-
-	TAffectFlag afOld = m_afAffectFlag;
-
-	long lMovSpd = GetPoint(POINT_MOV_SPEED);
-	long lAttSpd = GetPoint(POINT_ATT_SPEED);
-
-	for (DWORD i = 0; i < dwCount; ++i, ++pElements)
-	{
-		// ¹«¿µÁøÀº ·ÎµåÇÏÁö¾Ê´Â´Ù.
-		if (pElements->dwType == SKILL_MUYEONG)
-			continue;
-
-		if (AFFECT_AUTO_HP_RECOVERY == pElements->dwType || AFFECT_AUTO_SP_RECOVERY == pElements->dwType)
-		{
-			LPITEM item = FindItemByID(pElements->dwFlag);
-
-			if (NULL == item)
-				continue;
-
-			item->Lock(true);
-		}
-
-#if defined(__LOOT_FILTER_SYSTEM__) && defined(__PREMIUM_LOOT_FILTER__)
-		if (AFFECT_LOOTING_SYSTEM == pElements->dwType)
-			SetLootFilter();
-#endif
-
-#if defined(__SOUL_SYSTEM__)
-		if (pElements->dwType == AFFECT_SOUL)
-		{
-			if (pElements->wApplyOn != AFF_SOUL_MIX)
-			{
-				LPITEM item = FindItemByID(pElements->lApplyValue);
-				if (item == nullptr)
-					continue;
-
-				item->Lock(true);
-			}
-		}
-#endif
-
-#if defined(__SET_ITEM__)
-		if (pElements->dwType == AFFECT_SET_ITEM)
-			RefreshItemSetBonus();
-
-		if (pElements->dwType >= AFFECT_SET_ITEM_SET_VALUE_1 && pElements->dwType <= AFFECT_SET_ITEM_SET_VALUE_5)
-			RefreshItemSetBonusByValue();
-#endif
-
-		if (pElements->wApplyOn >= POINT_MAX_NUM)
-		{
-			sys_err("invalid affect data %s ApplyOn %u ApplyValue %ld",
-				GetName(), pElements->wApplyOn, pElements->lApplyValue);
-			continue;
-		}
-
-		if (test_server)
-		{
-			sys_log(0, "Load Affect : Affect %s %u %u", GetName(), pElements->dwType, pElements->wApplyOn);
-		}
-
-		CAffect* pkAff = CAffect::Acquire();
-		m_list_pkAffect.push_back(pkAff);
-
-		pkAff->dwType = pElements->dwType;
-		pkAff->wApplyOn = pElements->wApplyOn;
-		pkAff->lApplyValue = pElements->lApplyValue;
-		pkAff->dwFlag = pElements->dwFlag;
-		pkAff->lDuration = pElements->lDuration;
-		pkAff->lSPCost = pElements->lSPCost;
-#if defined(__AFFECT_RENEWAL__)
-		pkAff->bRealTime = pElements->bRealTime;
-		pkAff->bUpdate = pElements->bUpdate;
-#endif
-#if defined(__9TH_SKILL__)
-		pkAff->lValue = 0;
-#endif
-
-		SendAffectAddPacket(GetDesc(), pkAff);
-
-		ComputeAffect(pkAff, true);
-	}
-
-	if (CArenaManager::instance().IsArenaMap(GetMapIndex()) == true)
-	{
-		RemoveGoodAffect();
-	}
-
-	if (afOld != m_afAffectFlag || lMovSpd != GetPoint(POINT_MOV_SPEED) || lAttSpd != GetPoint(POINT_ATT_SPEED))
-	{
-		UpdatePacket();
-	}
-
-	StartAffectEvent();
-
-	m_bIsLoadedAffect = true;
-
-#if defined(__DRAGON_SOUL_SYSTEM__)
-	// ¿ëÈ¥¼® ¼ÂÆÃ ·Îµå ¹× ÃÊ±âÈ­
-	DragonSoul_Initialize();
-#endif
-
-	if (!IsDead())
-	{
-		PointChange(POINT_HP, GetMaxHP() - GetHP());
-		PointChange(POINT_SP, GetMaxSP() - GetSP());
-	}
-}
-
-bool CHARACTER::AddAffect(DWORD dwType, POINT_TYPE wApplyOn, POINT_VALUE lApplyValue, DWORD dwFlag, long lDuration, long lSPCost, bool bOverride, bool IsCube
-#if defined(__AFFECT_RENEWAL__)
-	, bool bRealTime
-#endif
-#if defined(__9TH_SKILL__)
-	, long lValue /* Skill iAmount2 */
-#endif
-)
-{
-	// CHAT_BLOCK
-	if (dwType == AFFECT_BLOCK_CHAT && lDuration > 1)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("¿î¿µÀÚ Á¦Á¦·Î Ã¤ÆÃÀÌ ±ÝÁö µÇ¾ú½À´Ï´Ù."));
-	}
-	// END_OF_CHAT_BLOCK
-
-	if (IsDead())
-		return false;
-
-#if defined(__LOOT_FILTER_SYSTEM__) && defined(__PREMIUM_LOOT_FILTER__)
-	if (dwType == AFFECT_LOOTING_SYSTEM)
-		SetLootFilter();
-#endif
-
-#if defined(__SNOWFLAKE_STICK_EVENT__)
-	if (dwType == AFFECT_SNOWFLAKE_STICK_EVENT_SNOWFLAKE_BUFF)
-		CSnowflakeStickEvent::Process(this, SNOWFLAKE_STICK_EVENT_GC_SUBHEADER_MESSAGE_GET_SNOWFLAKE_BUFF);
-#endif
-
-	if (lDuration == 0)
-	{
-		sys_err("Character::AddAffect lDuration == 0 type %d", lDuration, dwType);
-		lDuration = 1;
-	}
-
-	CAffect* pkAff = NULL;
-
-	if (IsCube)
-		pkAff = FindAffect(dwType, wApplyOn);
-	else
-		pkAff = FindAffect(dwType);
-
-	if (dwFlag == AFF_STUN)
-	{
-		if (m_posDest.x != GetX() || m_posDest.y != GetY())
-		{
-			m_posDest.x = m_posStart.x = GetX();
-			m_posDest.y = m_posStart.y = GetY();
-			battle_end(this);
-
-			SyncPacket();
-		}
-	}
-
-	// ÀÌ¹Ì ÀÖ´Â È¿°ú¸¦ µ¤¾î ¾²´Â Ã³¸®
-	if (pkAff && bOverride)
-	{
-		ComputeAffect(pkAff, false); // ÀÏ´Ü È¿°ú¸¦ »èÁ¦ÇÏ°í
-
-		if (GetDesc())
-			SendAffectRemovePacket(GetDesc(), GetPlayerID(), pkAff->dwType, pkAff->wApplyOn);
-	}
-	else
-	{
-		//
-		// »õ ¿¡Æå¸¦ Ãß°¡
-		//
-		// NOTE: µû¶ó¼­ °°Àº type À¸·Îµµ ¿©·¯ ¿¡ÆåÆ®¸¦ ºÙÀ» ¼ö ÀÖ´Ù.
-		//
-		pkAff = CAffect::Acquire();
-		m_list_pkAffect.push_back(pkAff);
-	}
-
-#if defined(__AFFECT_RENEWAL__)
-	sys_log(0, "AddAffect %s type %u apply %u value %ld flag %u duration %ld real_time %d", GetName(), dwType, wApplyOn, lApplyValue, dwFlag, lDuration, (bRealTime ? 1 : 0));
-	sys_log(1, "AddAffect %s type %u apply %u value %ld flag %u duration %ld real_time %d", GetName(), dwType, wApplyOn, lApplyValue, dwFlag, lDuration, (bRealTime ? 1 : 0));
-#else
-	sys_log(0, "AddAffect %s type %u apply %u value %ld flag %u duration %ld", GetName(), dwType, wApplyOn, lApplyValue, dwFlag, lDuration);
-	sys_log(1, "AddAffect %s type %u apply %u value %ld flag %u duration %ld", GetName(), dwType, wApplyOn, lApplyValue, dwFlag, lDuration);
-#endif
-
-	pkAff->dwType = dwType;
-	pkAff->wApplyOn = wApplyOn;
-	pkAff->lApplyValue = lApplyValue;
-	pkAff->dwFlag = dwFlag;
-#if defined(__AFFECT_RENEWAL__)
-	pkAff->lDuration = bRealTime ? (get_global_time() + lDuration) : lDuration;
-	pkAff->bRealTime = bRealTime;
-	pkAff->bUpdate = false;
-#else
-	pkAff->lDuration = lDuration;
-#endif
-	pkAff->lSPCost = lSPCost;
-#if defined(__9TH_SKILL__)
-	pkAff->lValue = lValue;
-#endif
-
-	long lMovSpd = GetPoint(POINT_MOV_SPEED);
-	long lAttSpd = GetPoint(POINT_ATT_SPEED);
-
-	ComputeAffect(pkAff, true);
-
-	if (pkAff->dwFlag || lMovSpd != GetPoint(POINT_MOV_SPEED) || lAttSpd != GetPoint(POINT_ATT_SPEED))
-		UpdatePacket();
-
-	StartAffectEvent();
-
-	if (IsPC())
-	{
-		SendAffectAddPacket(GetDesc(), pkAff);
-
-		if (IS_NO_SAVE_AFFECT(pkAff->dwType))
-			return true;
-
-		TPacketGDAddAffect p;
-		p.dwPID = GetPlayerID();
-		p.elem.dwType = pkAff->dwType;
-		p.elem.wApplyOn = pkAff->wApplyOn;
-		p.elem.lApplyValue = pkAff->lApplyValue;
-		p.elem.dwFlag = pkAff->dwFlag;
-		p.elem.lDuration = pkAff->lDuration;
-		p.elem.lSPCost = pkAff->lSPCost;
-#if defined(__AFFECT_RENEWAL__)
-		p.elem.bRealTime = pkAff->bRealTime;
-		p.elem.bUpdate = pkAff->bUpdate;
-#endif
-		db_clientdesc->DBPacket(HEADER_GD_ADD_AFFECT, 0, &p, sizeof(p));
-	}
-
-	return true;
-}
-
-#if defined(__AFFECT_RENEWAL__)
-bool CHARACTER::AddRealTimeAffect(DWORD dwType, POINT_TYPE wApplyOn, POINT_VALUE lApplyValue, DWORD dwFlag, long lDuration, long lSPCost, bool bOverride, bool IsCube, bool bRealTime)
-{
-	return AddAffect(dwType, wApplyOn, lApplyValue, dwFlag, lDuration, lSPCost, bOverride, IsCube, bRealTime);
-}
-#endif
-
-void CHARACTER::RefreshAffect()
-{
-	for (CAffect* const& pAffect : m_list_pkAffect)
-		ComputeAffect(pAffect, true);
-}
-
-void CHARACTER::ComputeAffect(const CAffect* pkAff, bool bAdd)
-{
-	if (bAdd && pkAff->dwType >= GUILD_SKILL_START && pkAff->dwType <= GUILD_SKILL_END)
-	{
-		if (!GetGuild())
-			return;
-
-		if (!GetGuild()->UnderAnyWar())
-			return;
-	}
-
-	if (pkAff->dwFlag)
-	{
-		if (!bAdd)
-			m_afAffectFlag.Reset(pkAff->dwFlag);
-		else
-			m_afAffectFlag.Set(pkAff->dwFlag);
-	}
-
-#if defined(__SOUL_SYSTEM__)
-	if (pkAff->dwType == AFFECT_SOUL)
-		return;
-#endif
-
-	if (bAdd)
-		PointChange(pkAff->wApplyOn, pkAff->lApplyValue);
-	else
-		PointChange(pkAff->wApplyOn, -pkAff->lApplyValue);
-
-	if (pkAff->dwType == SKILL_MUYEONG)
-	{
-		if (bAdd)
-			StartMuyeongEvent();
-		else
-			StopMuyeongEvent();
-	}
-
-#if defined(__PVP_BALANCE_IMPROVING__)
-	if (pkAff->dwType == SKILL_GYEONGGONG)
-	{
-		if (bAdd)
-			StartGyeongGongEvent();
-		else
-			StopGyeongGongEvent();
-	}
-#endif
-
-#if defined(__9TH_SKILL__)
-	if (pkAff->dwType == SKILL_CHEONUN)
-	{
-		if (bAdd)
-			StartCheonunEvent(pkAff->lApplyValue, pkAff->lValue);
-		else
-			StopCheonunEvent();
-	}
-#endif
-
-	if (pkAff->dwType == AFFECT_MOUNT_FALL)
-	{
-		if (bAdd)
-		{
-			UnMount(false);
-		}
-		else
-		{
-			if (GetHorse())
-				StartRiding();
-			else if (GetWear(WEAR_COSTUME_MOUNT))
-				MountVnum(GetPoint(POINT_MOUNT));
-		}
-	}
-}
-
-bool CHARACTER::RemoveAffect(CAffect* pkAff)
-{
-	if (!pkAff)
-		return false;
-
-	// AFFECT_BUF_FIX
-	m_list_pkAffect.remove(pkAff);
-	// END_OF_AFFECT_BUF_FIX
-
-	ComputeAffect(pkAff, false);
-
-	// ¹é±â ¹ö±× ¼öÁ¤.
-	// ¹é±â ¹ö±×´Â ¹öÇÁ ½ºÅ³ ½ÃÀü->µÐ°©->¹é±â »ç¿ë(AFFECT_REVIVE_INVISIBLE) ÈÄ ¹Ù·Î °ø°Ý ÇÒ °æ¿ì¿¡ ¹ß»ýÇÑ´Ù.
-	// ¿øÀÎÀº µÐ°©À» ½ÃÀüÇÏ´Â ½ÃÁ¡¿¡, ¹öÇÁ ½ºÅ³ È¿°ú¸¦ ¹«½ÃÇÏ°í µÐ°© È¿°ú¸¸ Àû¿ëµÇ°Ô µÇ¾îÀÖ´Âµ¥,
-	// ¹é±â »ç¿ë ÈÄ ¹Ù·Î °ø°ÝÇÏ¸é RemoveAffect°¡ ºÒ¸®°Ô µÇ°í, ComputePointsÇÏ¸é¼­ µÐ°© È¿°ú + ¹öÇÁ ½ºÅ³ È¿°ú°¡ µÈ´Ù.
-	// ComputePoints¿¡¼­ µÐ°© »óÅÂ¸é ¹öÇÁ ½ºÅ³ È¿°ú ¾È ¸ÔÈ÷µµ·Ï ÇÏ¸é µÇ±ä ÇÏ´Âµ¥,
-	// ComputePoints´Â ±¤¹üÀ§ÇÏ°Ô »ç¿ëµÇ°í ÀÖ¾î¼­ Å« º¯È­¸¦ ÁÖ´Â °ÍÀÌ ²¨·ÁÁø´Ù.(¾î¶² side effect°¡ ¹ß»ýÇÒÁö ¾Ë±â Èûµé´Ù.)
-	// µû¶ó¼­ AFFECT_REVIVE_INVISIBLE°¡ RemoveAffect·Î »èÁ¦µÇ´Â °æ¿ì¸¸ ¼öÁ¤ÇÑ´Ù.
-	// ½Ã°£ÀÌ ´Ù µÇ¾î ¹é±â È¿°ú°¡ Ç®¸®´Â °æ¿ì´Â ¹ö±×°¡ ¹ß»ýÇÏÁö ¾ÊÀ¸¹Ç·Î ±×¿Í ¶È°°ÀÌ ÇÔ.
-	// (ProcessAffect¸¦ º¸¸é ½Ã°£ÀÌ ´Ù µÇ¾î¼­ Affect°¡ »èÁ¦µÇ´Â °æ¿ì, ComputePoints¸¦ ºÎ¸£Áö ¾Ê´Â´Ù.)
-#ifdef MOUNT_FIX
-	if (AFFECT_REVIVE_INVISIBLE != pkAff->dwType && AFFECT_MOUNT != pkAff->dwType
-#if defined(__SET_ITEM__)
-		&& (!IS_NO_CLEAR_SET_ITEM(pkAff->dwType))
-#endif
-		&& IsPC())
-#else
-	if (AFFECT_REVIVE_INVISIBLE != pkAff->dwType
-#if defined(__SET_ITEM__)
-		&& (!IS_NO_CLEAR_SET_ITEM(pkAff->dwType))
-#endif
-		&& IsPC())
-#endif
-		ComputePoints();
-	else
-		UpdatePacket();
-
-#if defined(__LOOT_FILTER_SYSTEM__) && defined(__PREMIUM_LOOT_FILTER__)
-	if (pkAff->dwType == AFFECT_LOOTING_SYSTEM)
-		ClearLootFilter();
-#endif
-
-	CheckMaximumPoints();
-
-	if (test_server)
-		sys_log(0, "AFFECT_REMOVE: %s (flag %u apply: %u)", GetName(), pkAff->dwFlag, pkAff->wApplyOn);
-
-	if (IsPC())
-	{
-		SendAffectRemovePacket(GetDesc(), GetPlayerID(), pkAff->dwType, pkAff->wApplyOn);
-	}
-
-	CAffect::Release(pkAff);
-	return true;
-}
-
-bool CHARACTER::RemoveAffect(DWORD dwType)
-{
-	// CHAT_BLOCK
-	if (dwType == AFFECT_BLOCK_CHAT)
-	{
-		ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ã¤ÆÃ ±ÝÁö°¡ Ç®·È½À´Ï´Ù."));
-	}
-	// END_OF_CHAT_BLOCK
-
-	bool flag = false;
-
-	CAffect* pkAff;
-	while ((pkAff = FindAffect(dwType)))
-	{
-		RemoveAffect(pkAff);
-		flag = true;
-	}
-
-	return flag;
-}
-
-#if defined(__SOUL_SYSTEM__)
-void CHARACTER::RemoveAffect(DWORD dwType, POINT_TYPE wApplyType)
-{
-	const CAffect* pkAff = nullptr;
-	for (const auto& it : m_list_pkAffect)
-	{
-		pkAff = it;
-
-		if (pkAff->dwType == dwType)
-		{
-			if (pkAff->wApplyOn == wApplyType || pkAff->wApplyOn == APPLY_NONE)
-			{
-				break;
-			}
-		}
-
-		pkAff = nullptr;
-	}
-
-	if (pkAff != nullptr)
-		RemoveAffect(const_cast<CAffect*>(pkAff));
-}
-#endif
-
-bool CHARACTER::IsAffectFlag(DWORD dwAff) const
-{
-	return m_afAffectFlag.IsSet(dwAff);
-}
-
-void CHARACTER::RemoveGoodAffect()
-{
-	RemoveAffect(AFFECT_MOV_SPEED);
-	RemoveAffect(AFFECT_ATT_SPEED);
-	RemoveAffect(AFFECT_STR);
-	RemoveAffect(AFFECT_DEX);
-	RemoveAffect(AFFECT_INT);
-	RemoveAffect(AFFECT_CON);
-	RemoveAffect(AFFECT_CHINA_FIREWORK);
-
-	RemoveAffect(SKILL_JEONGWI);
-	RemoveAffect(SKILL_GEOMKYUNG);
-	RemoveAffect(SKILL_CHUNKEON);
-	RemoveAffect(SKILL_EUNHYUNG);
-	RemoveAffect(SKILL_GYEONGGONG);
-	RemoveAffect(SKILL_GWIGEOM);
-	RemoveAffect(SKILL_TERROR);
-	RemoveAffect(SKILL_JUMAGAP);
-	RemoveAffect(SKILL_MANASHILED);
-	RemoveAffect(SKILL_HOSIN);
-	RemoveAffect(SKILL_REFLECT);
-	RemoveAffect(SKILL_KWAESOK);
-	RemoveAffect(SKILL_JEUNGRYEOK);
-	RemoveAffect(SKILL_GICHEON);
-
-	RemoveAffect(SKILL_JEOKRANG);
-	RemoveAffect(SKILL_CHEONGRANG);
-
-#if defined(__9TH_SKILL__)
-	RemoveAffect(SKILL_CHEONUN);
-#endif
-}
-
-bool CHARACTER::IsGoodAffect(BYTE bAffectType) const
-{
-	switch (bAffectType)
-	{
-		case AFFECT_MOV_SPEED:
-		case AFFECT_ATT_SPEED:
-		case AFFECT_STR:
-		case AFFECT_DEX:
-		case AFFECT_INT:
-		case AFFECT_CON:
-		case AFFECT_CHINA_FIREWORK:
-
-		case SKILL_JEONGWI:
-		case SKILL_GEOMKYUNG:
-		case SKILL_CHUNKEON:
-		case SKILL_EUNHYUNG:
-		case SKILL_GYEONGGONG:
-		case SKILL_GWIGEOM:
-		case SKILL_TERROR:
-		case SKILL_JUMAGAP:
-		case SKILL_MANASHILED:
-		case SKILL_HOSIN:
-		case SKILL_REFLECT:
-		case SKILL_KWAESOK:
-		case SKILL_JEUNGRYEOK:
-		case SKILL_GICHEON:
-
-		case SKILL_JEOKRANG:
-		case SKILL_CHEONGRANG:
-
-#if defined(__9TH_SKILL__)
-		case SKILL_CHEONUN:
-#endif
-			return true;
-	}
-
-	return false;
-}
-
-void CHARACTER::RemoveBadAffect()
-{
-	sys_log(0, "RemoveBadAffect %s", GetName());
-	// µ¶
-	RemovePoison();
-	RemoveFire();
-	RemoveBleeding();
-
-	// ½ºÅÏ : Value%·Î »ó´ë¹æÀ» 5ÃÊ°£ ¸Ó¸® À§¿¡ º°ÀÌ µ¹¾Æ°£´Ù. (¶§¸®¸é 1/2 È®·ü·Î Ç®¸²) AFF_STUN
-	RemoveAffect(AFFECT_STUN);
-
-	// ½½·Î¿ì : Value%·Î »ó´ë¹æÀÇ °ø¼Ó/ÀÌ¼Ó ¸ðµÎ ´À·ÁÁø´Ù. ¼ö·Ãµµ¿¡ µû¶ó ´Þ¶óÁü ±â¼ú·Î »ç¿ë ÇÑ °æ¿ì¿¡ AFF_SLOW
-	RemoveAffect(AFFECT_SLOW);
-
-	// Åõ¼Ó¸¶·É
-	RemoveAffect(SKILL_TUSOK);
-
-	// ÀúÁÖ
-	//RemoveAffect(SKILL_CURSE);
-
-	// ÆÄ¹ý¼ú
-	//RemoveAffect(SKILL_PABUP);
-
-	// ±âÀý : Value%·Î »ó´ë¹æÀ» ±âÀý½ÃÅ²´Ù. 2ÃÊ AFF_FAINT
-	//RemoveAffect(AFFECT_FAINT);
-
-	// ´Ù¸®¹­ÀÓ : Value%·Î »ó´ë¹æÀÇ ÀÌµ¿¼Óµµ¸¦ ¶³¾îÆ®¸°´Ù. 5ÃÊ°£ -40 AFF_WEB
-	//RemoveAffect(AFFECT_WEB);
-
-	// Àáµé±â : Value%·Î »ó´ë¹æÀ» 10ÃÊ°£ ÀáÀç¿î´Ù. (¶§¸®¸é Ç®¸²) AFF_SLEEP
-	//RemoveAffect(AFFECT_SLEEP);
-
-	// ÀúÁÖ : Value%·Î »ó´ë¹æÀÇ °øµî/¹æµî ¸ðµÎ ¶³¾îÆ®¸°´Ù. ¼ö·Ãµµ¿¡ µû¶ó ´Þ¶óÁü ±â¼ú·Î »ç¿ë ÇÑ °æ¿ì¿¡ AFF_CURSE
-	//RemoveAffect(AFFECT_CURSE);
-
-	// ¸¶ºñ : Value%·Î »ó´ë¹æÀ» 4ÃÊ°£ ¸¶ºñ½ÃÅ²´Ù. AFF_PARA
-	//RemoveAffect(AFFECT_PARALYZE);
-
-	// ºÎµ¿¹ÚºÎ : ¹«´ç ±â¼ú
-	//RemoveAffect(SKILL_BUDONG);
-}
+#include "stdafx.h"
+
+#include "config.h"
+#include "char.h"
+#include "char_manager.h"
+#include "affect.h"
+#include "packet.h"
+#include "buffer_manager.h"
+#include "desc_client.h"
+#include "battle.h"
+#include "guild.h"
+#include "utils.h"
+#include "locale_service.h"
+#include "lua_incl.h"
+#include "arena.h"
+#include "horsename_manager.h"
+#include "item.h"
+#include "DragonSoul.h"
+#if defined(__SNOWFLAKE_STICK_EVENT__)
+#	include "xmas_event.h"
+#endif
+
+#define IS_NO_SAVE_AFFECT(type) ((type) == AFFECT_WAR_FLAG || (type) == AFFECT_REVIVE_INVISIBLE || ((type) >= AFFECT_PREMIUM_START && (type) <= AFFECT_PREMIUM_END)/* || ((type) == AFFECT_OFFLINE_SHOP_DECORATION)*/ || (type) == AFFECT_MOUNT_BONUS)
+#define IS_NO_CLEAR_ON_DEATH_AFFECT(type) ((type) == AFFECT_BLOCK_CHAT || ((type) >= 500 && (type) < 600))
+#if defined(__SET_ITEM__)
+#	define IS_NO_CLEAR_SET_ITEM(type) ((type) == AFFECT_SET_ITEM || ((type) >= AFFECT_SET_ITEM_SET_VALUE_1 && (type) <= AFFECT_SET_ITEM_SET_VALUE_5))
+#endif
+
+void SendAffectRemovePacket(LPDESC pDesc, DWORD dwPID, DWORD dwType, POINT_TYPE wApplyOn)
+{
+	TPacketGCAffectRemove ptoc;
+	ptoc.bHeader = HEADER_GC_AFFECT_REMOVE;
+	ptoc.dwType = dwType;
+	ptoc.wApplyOn = wApplyOn;
+	pDesc->Packet(&ptoc, sizeof(TPacketGCAffectRemove));
+
+	TPacketGDRemoveAffect ptod;
+	ptod.dwPID = dwPID;
+	ptod.dwType = dwType;
+	ptod.wApplyOn = wApplyOn;
+	db_clientdesc->DBPacket(HEADER_GD_REMOVE_AFFECT, 0, &ptod, sizeof(ptod));
+}
+
+void SendAffectAddPacket(LPDESC pDesc, CAffect* pkAff)
+{
+	TPacketGCAffectAdd ptoc;
+	ptoc.bHeader = HEADER_GC_AFFECT_ADD;
+	ptoc.elem.dwType = pkAff->dwType;
+	ptoc.elem.wApplyOn = pkAff->wApplyOn;
+	ptoc.elem.lApplyValue = pkAff->lApplyValue;
+	ptoc.elem.dwFlag = pkAff->dwFlag;
+	ptoc.elem.lDuration = pkAff->lDuration;
+	ptoc.elem.lSPCost = pkAff->lSPCost;
+#if defined(__AFFECT_RENEWAL__)
+	ptoc.elem.bRealTime = pkAff->bRealTime;
+	ptoc.elem.bUpdate = pkAff->bUpdate;
+#endif
+	pDesc->Packet(&ptoc, sizeof(TPacketGCAffectAdd));
+}
+
+////////////////////////////////////////////////////////////////////
+// Affect
+CAffect* CHARACTER::FindAffect(DWORD dwType, POINT_TYPE wApplyType) const
+{
+	for (const auto& it : m_list_pkAffect)
+	{
+		CAffect* pkAffect = it;
+		if (pkAffect && (pkAffect->dwType == dwType && (wApplyType == APPLY_NONE || wApplyType == pkAffect->wApplyOn)))
+			return pkAffect;
+	}
+
+	return NULL;
+}
+
+EVENTFUNC(affect_event)
+{
+	char_event_info* info = dynamic_cast<char_event_info*>(event->info);
+
+	if (info == NULL)
+	{
+		sys_err("affect_event> <Factor> Null pointer");
+		return 0;
+	}
+
+	LPCHARACTER ch = info->ch;
+
+	if (ch == NULL) // <Factor>
+		return 0;
+
+	if (!ch->UpdateAffect())
+		return 0;
+	else
+		return passes_per_sec; // 1ï¿½ï¿½
+}
+
+bool CHARACTER::UpdateAffect()
+{
+	// affect_event ï¿½ï¿½ï¿½ï¿½ Ã³ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½Æ´ï¿½ï¿½ï¿½ï¿½ï¿½, 1ï¿½ï¿½Â¥ï¿½ï¿½ ï¿½Ìºï¿½Æ®ï¿½ï¿½ï¿½ï¿½ Ã³ï¿½ï¿½ï¿½Ï´ï¿½ ï¿½ï¿½ï¿½ï¿½
+	// ï¿½Ì°ï¿½ ï¿½ï¿½ï¿½Ì¶ï¿½ ï¿½ï¿½ï¿½â¼­ ï¿½ï¿½ï¿½ï¿½ Ã³ï¿½ï¿½ï¿½ï¿½ ï¿½Ñ´ï¿½.
+	if (GetPoint(POINT_HP_RECOVERY) > 0)
+	{
+		if (GetMaxHP() <= GetHP())
+		{
+			PointChange(POINT_HP_RECOVERY, -GetPoint(POINT_HP_RECOVERY));
+		}
+		else
+		{
+			int iVal = MIN(GetPoint(POINT_HP_RECOVERY), GetMaxHP() * 9 / 100);
+
+			PointChange(POINT_HP, iVal);
+			PointChange(POINT_HP_RECOVERY, -iVal);
+		}
+	}
+
+	if (GetPoint(POINT_SP_RECOVERY) > 0)
+	{
+		if (GetMaxSP() <= GetSP())
+		{
+			PointChange(POINT_SP_RECOVERY, -GetPoint(POINT_SP_RECOVERY));
+		}
+		else
+		{
+			int iVal = MIN(GetPoint(POINT_SP_RECOVERY), GetMaxSP() * 7 / 100);
+
+			PointChange(POINT_SP, iVal);
+			PointChange(POINT_SP_RECOVERY, -iVal);
+		}
+	}
+
+	if (GetPoint(POINT_HP_RECOVER_CONTINUE) > 0)
+	{
+		PointChange(POINT_HP, GetPoint(POINT_HP_RECOVER_CONTINUE));
+	}
+
+	if (GetPoint(POINT_SP_RECOVER_CONTINUE) > 0)
+	{
+		PointChange(POINT_SP, GetPoint(POINT_SP_RECOVER_CONTINUE));
+	}
+
+	AutoRecoveryItemProcess(AFFECT_AUTO_HP_RECOVERY);
+	AutoRecoveryItemProcess(AFFECT_AUTO_SP_RECOVERY);
+
+	// ï¿½ï¿½ï¿½×¹Ì³ï¿½ È¸ï¿½ï¿½
+	if (GetMaxStamina() > GetStamina())
+	{
+		int iSec = (get_dword_time() - GetStopTime()) / 3000;
+		if (iSec)
+			PointChange(POINT_STAMINA, GetMaxStamina() / 1);
+	}
+
+	// ProcessAffectï¿½ï¿½ affectï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ trueï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½Ñ´ï¿½.
+	if (ProcessAffect())
+	{
+		if (GetPoint(POINT_HP_RECOVERY) == 0 && GetPoint(POINT_SP_RECOVERY) == 0 && GetStamina() == GetMaxStamina())
+		{
+			m_pkAffectEvent = NULL;
+			return false;
+		}
+	}
+
+	return true;
+}
+
+void CHARACTER::StartAffectEvent()
+{
+	if (m_pkAffectEvent)
+		return;
+
+	char_event_info* info = AllocEventInfo<char_event_info>();
+	info->ch = this;
+	m_pkAffectEvent = event_create(affect_event, info, passes_per_sec);
+	sys_log(1, "StartAffectEvent %s %p %p", GetName(), this, get_pointer(m_pkAffectEvent));
+}
+
+void CHARACTER::ClearAffect(bool bSave)
+{
+	TAffectFlag afOld = m_afAffectFlag;
+	long lMovSpd = GetPoint(POINT_MOV_SPEED);
+	long lAttSpd = GetPoint(POINT_ATT_SPEED);
+
+	AffectContainerList::iterator it = m_list_pkAffect.begin();
+	size_t __affect_save_count = 0;
+	while (it != m_list_pkAffect.end())
+	{
+		if (++__affect_save_count > MAX_AFFECT_PER_CHARACTER)
+		{
+			sys_err(\"Affect save truncated: %s has %zu affects\", GetName(), m_list_pkAffect.size());
+			break;
+		}
+		CAffect* pkAff = *it;
+		if (pkAff == nullptr)
+			continue;
+
+		if (bSave)
+		{
+			if (IS_NO_CLEAR_ON_DEATH_AFFECT(pkAff->dwType) || IS_NO_SAVE_AFFECT(pkAff->dwType))
+			{
+				++it;
+				continue;
+			}
+
+#if defined(__SOUL_SYSTEM__)
+			if (pkAff->dwType == AFFECT_SOUL)
+			{
+				++it;
+				continue;
+			}
+#endif
+
+#if defined(__SET_ITEM__)
+			if (IS_NO_CLEAR_SET_ITEM(pkAff->dwType))
+			{
+				++it;
+				continue;
+			}
+#endif
+
+#if defined(__SNOWFLAKE_STICK_EVENT__)
+			if (pkAff->dwType == AFFECT_SNOWFLAKE_STICK_EVENT_RANK_BUFF
+				|| pkAff->dwType == AFFECT_SNOWFLAKE_STICK_EVENT_SNOWFLAKE_BUFF)
+			{
+				++it;
+				continue;
+			}
+#endif
+
+			if (IsPC())
+			{
+				SendAffectRemovePacket(GetDesc(), GetPlayerID(), pkAff->dwType, pkAff->wApplyOn);
+			}
+		}
+
+		ComputeAffect(pkAff, false);
+
+		it = m_list_pkAffect.erase(it);
+		CAffect::Release(pkAff);
+	}
+
+	if (afOld != m_afAffectFlag || lMovSpd != GetPoint(POINT_MOV_SPEED) || lAttSpd != GetPoint(POINT_ATT_SPEED))
+		UpdatePacket();
+
+	CheckMaximumPoints();
+
+	if (m_list_pkAffect.empty())
+		event_cancel(&m_pkAffectEvent);
+}
+
+int CHARACTER::ProcessAffect()
+{
+	bool bDiff = false;
+	CAffect* pkAff = NULL;
+
+	//
+	// ï¿½ï¿½ï¿½ï¿½ï¿½Ì¾ï¿½ Ã³ï¿½ï¿½
+	//
+	for (BYTE i = 0; i <= PREMIUM_MAX_NUM; ++i)
+	{
+		int aff_idx = i + AFFECT_PREMIUM_START;
+
+		pkAff = FindAffect(aff_idx);
+		if (!pkAff)
+			continue;
+
+		int remain = GetPremiumRemainSeconds(i);
+		if (remain < 0)
+		{
+			RemoveAffect(aff_idx);
+			bDiff = true;
+		}
+		else
+			pkAff->lDuration = remain + 1;
+	}
+
+#ifdef __OFFLINE_SHOP__
+	if (FindAffect(AFFECT_OFFLINE_SHOP_DECORATION))
+	{
+		pkAff = FindAffect(AFFECT_OFFLINE_SHOP_DECORATION);
+
+		if (pkAff)
+		{
+			int decorationRemain = GetQuestFlag("decoration.limit_time");
+			if (decorationRemain > 0)
+			{
+				decorationRemain = decorationRemain - get_global_time();
+			}
+			if (decorationRemain < 0)
+			{
+				RemoveAffect(AFFECT_OFFLINE_SHOP_DECORATION);
+				bDiff = true;
+			}
+			else
+				pkAff->lDuration = decorationRemain + 1;
+		}
+	}
+#endif
+
+	////////// HAIR_AFFECT
+	pkAff = FindAffect(AFFECT_HAIR);
+	if (pkAff)
+	{
+		// IF HAIR_LIMIT_TIME() < CURRENT_TIME()
+		if (this->GetQuestFlag("hair.limit_time") < get_global_time())
+		{
+			// SET HAIR NORMAL
+			this->SetPart(PART_HAIR, 0);
+			// REMOVE HAIR AFFECT
+			RemoveAffect(AFFECT_HAIR);
+		}
+		else
+		{
+			// INCREASE AFFECT DURATION
+			++(pkAff->lDuration);
+		}
+	}
+	////////// HAIR_AFFECT
+
+	CHorseNameManager::instance().Validate(this);
+
+	TAffectFlag afOld = m_afAffectFlag;
+	long lMovSpd = GetPoint(POINT_MOV_SPEED);
+	long lAttSpd = GetPoint(POINT_ATT_SPEED);
+
+	AffectContainerList::iterator it = m_list_pkAffect.begin();
+	while (it != m_list_pkAffect.end())
+	{
+		pkAff = *it;
+		if (pkAff == nullptr)
+			continue;
+
+		bool bEnd = false;
+
+		if (pkAff->dwType >= GUILD_SKILL_START && pkAff->dwType <= GUILD_SKILL_END)
+		{
+			if (!GetGuild() || !GetGuild()->UnderAnyWar())
+				bEnd = true;
+		}
+
+		if (pkAff->lSPCost > 0)
+		{
+			if (GetSP() < pkAff->lSPCost)
+				bEnd = true;
+			else
+				PointChange(POINT_SP, -pkAff->lSPCost);
+		}
+
+		// AFFECT_DURATION_BUG_FIX
+		// ï¿½ï¿½ï¿½ï¿½ È¿ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½Ûµï¿½ ï¿½Ã°ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½Î´ï¿½.
+		// ï¿½Ã°ï¿½ï¿½ï¿½ ï¿½Å¿ï¿½ Å©ï¿½ï¿½ ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½Ì¶ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½.
+#if defined(__AFFECT_RENEWAL__)
+		if (pkAff->bRealTime)
+		{
+			if (pkAff->lDuration < get_global_time())
+				bEnd = true;
+		}
+		else
+		{
+			if (--pkAff->lDuration <= 0)
+				bEnd = true;
+		}
+#else
+		if (--pkAff->lDuration <= 0)
+		{
+			bEnd = true;
+		}
+#endif
+		// END_AFFECT_DURATION_BUG_FIX
+
+		if (bEnd)
+		{
+			it = m_list_pkAffect.erase(it);
+			ComputeAffect(pkAff, false);
+			bDiff = true;
+
+			if (IsPC())
+				SendAffectRemovePacket(GetDesc(), GetPlayerID(), pkAff->dwType, pkAff->wApplyOn);
+
+			CAffect::Release(pkAff);
+			continue;
+		}
+
+		++it;
+	}
+
+	if (bDiff)
+	{
+		if (afOld != m_afAffectFlag || lMovSpd != GetPoint(POINT_MOV_SPEED) || lAttSpd != GetPoint(POINT_ATT_SPEED))
+			UpdatePacket();
+
+		CheckMaximumPoints();
+	}
+
+	if (m_list_pkAffect.empty())
+		return true;
+
+	return false;
+}
+
+void CHARACTER::SaveAffect()
+{
+	TPacketGDAddAffect p = {};
+
+	AffectContainerList::iterator it = m_list_pkAffect.begin();
+	while (it != m_list_pkAffect.end())
+	{
+		CAffect* pkAff = *it++;
+		if (pkAff == nullptr)
+			continue;
+
+		if (IS_NO_SAVE_AFFECT(pkAff->dwType))
+			continue;
+
+		sys_log(1, "AFFECT_SAVE: %u %u %ld %d", pkAff->dwType, pkAff->wApplyOn, pkAff->lApplyValue, pkAff->lDuration);
+
+		p.dwPID = GetPlayerID();
+		p.elem.dwType = pkAff->dwType;
+		p.elem.wApplyOn = pkAff->wApplyOn;
+		p.elem.lApplyValue = pkAff->lApplyValue;
+		p.elem.dwFlag = pkAff->dwFlag;
+		p.elem.lDuration = pkAff->lDuration;
+		p.elem.lSPCost = pkAff->lSPCost;
+#if defined(__AFFECT_RENEWAL__)
+		p.elem.bRealTime = pkAff->bRealTime;
+		p.elem.bUpdate = pkAff->bUpdate;
+#endif
+		db_clientdesc->DBPacket(HEADER_GD_ADD_AFFECT, 0, &p, sizeof(p));
+	}
+}
+
+EVENTINFO(load_affect_login_event_info)
+{
+	DWORD pid;
+	DWORD count;
+	char* data;
+
+	load_affect_login_event_info()
+		: pid(0)
+		, count(0)
+		, data(0)
+	{
+	}
+};
+
+EVENTFUNC(load_affect_login_event)
+{
+	load_affect_login_event_info* info = dynamic_cast<load_affect_login_event_info*>(event->info);
+
+	if (info == NULL)
+	{
+		sys_err("load_affect_login_event_info> <Factor> Null pointer");
+		return 0;
+	}
+
+	DWORD dwPID = info->pid;
+	LPCHARACTER ch = CHARACTER_MANAGER::instance().FindByPID(dwPID);
+
+	if (!ch)
+	{
+		M2_DELETE_ARRAY(info->data);
+		return 0;
+	}
+
+	LPDESC d = ch->GetDesc();
+
+	if (!d)
+	{
+		M2_DELETE_ARRAY(info->data);
+		return 0;
+	}
+
+	if (d->IsPhase(PHASE_HANDSHAKE) ||
+		d->IsPhase(PHASE_LOGIN) ||
+		d->IsPhase(PHASE_SELECT) ||
+		d->IsPhase(PHASE_DEAD) ||
+		d->IsPhase(PHASE_LOADING))
+	{
+		return PASSES_PER_SEC(1);
+	}
+	else if (d->IsPhase(PHASE_CLOSE))
+	{
+		M2_DELETE_ARRAY(info->data);
+		return 0;
+	}
+	else if (d->IsPhase(PHASE_GAME))
+	{
+		sys_log(1, "Affect Load by Event");
+		ch->LoadAffect(info->count, (TPacketAffectElement*)info->data);
+		M2_DELETE_ARRAY(info->data);
+		return 0;
+	}
+	else
+	{
+		sys_err("input_db.cpp:quest_login_event INVALID PHASE pid %d", ch->GetPlayerID());
+		M2_DELETE_ARRAY(info->data);
+		return 0;
+	}
+}
+
+void CHARACTER::LoadAffect(DWORD dwCount, TPacketAffectElement* pElements)
+{
+	m_bIsLoadedAffect = false;
+
+	if (!GetDesc()->IsPhase(PHASE_GAME))
+	{
+		if (test_server)
+			sys_log(0, "LOAD_AFFECT: Storing", GetName(), dwCount);
+
+		load_affect_login_event_info* info = AllocEventInfo<load_affect_login_event_info>();
+		info->pid = GetPlayerID();
+		info->count = dwCount;
+		info->data = M2_NEW char[sizeof(TPacketAffectElement) * dwCount];
+		thecore_memcpy(info->data, pElements, sizeof(TPacketAffectElement) * dwCount);
+
+		event_create(load_affect_login_event, info, PASSES_PER_SEC(1));
+
+		return;
+	}
+
+	ClearAffect(true);
+
+	if (test_server)
+		sys_log(0, "LOAD_AFFECT: %s count %d", GetName(), dwCount);
+
+	TAffectFlag afOld = m_afAffectFlag;
+
+	long lMovSpd = GetPoint(POINT_MOV_SPEED);
+	long lAttSpd = GetPoint(POINT_ATT_SPEED);
+
+	for (DWORD i = 0; i < dwCount; ++i, ++pElements)
+	{
+		// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½Îµï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ê´Â´ï¿½.
+		if (pElements->dwType == SKILL_MUYEONG)
+			continue;
+
+		if (AFFECT_AUTO_HP_RECOVERY == pElements->dwType || AFFECT_AUTO_SP_RECOVERY == pElements->dwType)
+		{
+			LPITEM item = FindItemByID(pElements->dwFlag);
+
+			if (NULL == item)
+				continue;
+
+			item->Lock(true);
+		}
+
+#if defined(__LOOT_FILTER_SYSTEM__) && defined(__PREMIUM_LOOT_FILTER__)
+		if (AFFECT_LOOTING_SYSTEM == pElements->dwType)
+			SetLootFilter();
+#endif
+
+#if defined(__SOUL_SYSTEM__)
+		if (pElements->dwType == AFFECT_SOUL)
+		{
+			if (pElements->wApplyOn != AFF_SOUL_MIX)
+			{
+				LPITEM item = FindItemByID(pElements->lApplyValue);
+				if (item == nullptr)
+					continue;
+
+				item->Lock(true);
+			}
+		}
+#endif
+
+#if defined(__SET_ITEM__)
+		if (pElements->dwType == AFFECT_SET_ITEM)
+			RefreshItemSetBonus();
+
+		if (pElements->dwType >= AFFECT_SET_ITEM_SET_VALUE_1 && pElements->dwType <= AFFECT_SET_ITEM_SET_VALUE_5)
+			RefreshItemSetBonusByValue();
+#endif
+
+		if (pElements->wApplyOn >= POINT_MAX_NUM)
+		{
+			sys_err("invalid affect data %s ApplyOn %u ApplyValue %ld",
+				GetName(), pElements->wApplyOn, pElements->lApplyValue);
+			continue;
+		}
+
+		if (test_server)
+		{
+			sys_log(0, "Load Affect : Affect %s %u %u", GetName(), pElements->dwType, pElements->wApplyOn);
+		}
+
+		CAffect* pkAff = CAffect::Acquire();
+		m_list_pkAffect.push_back(pkAff);
+
+		pkAff->dwType = pElements->dwType;
+		pkAff->wApplyOn = pElements->wApplyOn;
+		pkAff->lApplyValue = pElements->lApplyValue;
+		pkAff->dwFlag = pElements->dwFlag;
+		pkAff->lDuration = pElements->lDuration;
+		pkAff->lSPCost = pElements->lSPCost;
+#if defined(__AFFECT_RENEWAL__)
+		pkAff->bRealTime = pElements->bRealTime;
+		pkAff->bUpdate = pElements->bUpdate;
+#endif
+#if defined(__9TH_SKILL__)
+		pkAff->lValue = 0;
+#endif
+
+		SendAffectAddPacket(GetDesc(), pkAff);
+
+		ComputeAffect(pkAff, true);
+	}
+
+	if (CArenaManager::instance().IsArenaMap(GetMapIndex()) == true)
+	{
+		RemoveGoodAffect();
+	}
+
+	if (afOld != m_afAffectFlag || lMovSpd != GetPoint(POINT_MOV_SPEED) || lAttSpd != GetPoint(POINT_ATT_SPEED))
+	{
+		UpdatePacket();
+	}
+
+	StartAffectEvent();
+
+	m_bIsLoadedAffect = true;
+
+#if defined(__DRAGON_SOUL_SYSTEM__)
+	// ï¿½ï¿½È¥ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½Îµï¿½ ï¿½ï¿½ ï¿½Ê±ï¿½È­
+	DragonSoul_Initialize();
+#endif
+
+	if (!IsDead())
+	{
+		PointChange(POINT_HP, GetMaxHP() - GetHP());
+		PointChange(POINT_SP, GetMaxSP() - GetSP());
+	}
+}
+
+bool CHARACTER::AddAffect(DWORD dwType, POINT_TYPE wApplyOn, POINT_VALUE lApplyValue, DWORD dwFlag, long lDuration, long lSPCost, bool bOverride, bool IsCube
+#if defined(__AFFECT_RENEWAL__)
+	, bool bRealTime
+#endif
+#if defined(__9TH_SKILL__)
+	, long lValue /* Skill iAmount2 */
+#endif
+)
+{
+	// CHAT_BLOCK
+	if (dwType == AFFECT_BLOCK_CHAT && lDuration > 1)
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_STRING("ï¿½î¿µï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ Ã¤ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½Ç¾ï¿½ï¿½ï¿½ï¿½Ï´ï¿½."));
+	}
+	// END_OF_CHAT_BLOCK
+
+	if (IsDead())
+		return false;
+
+#if defined(__LOOT_FILTER_SYSTEM__) && defined(__PREMIUM_LOOT_FILTER__)
+	if (dwType == AFFECT_LOOTING_SYSTEM)
+		SetLootFilter();
+#endif
+
+#if defined(__SNOWFLAKE_STICK_EVENT__)
+	if (dwType == AFFECT_SNOWFLAKE_STICK_EVENT_SNOWFLAKE_BUFF)
+		CSnowflakeStickEvent::Process(this, SNOWFLAKE_STICK_EVENT_GC_SUBHEADER_MESSAGE_GET_SNOWFLAKE_BUFF);
+#endif
+
+	if (lDuration == 0)
+	{
+		sys_err("Character::AddAffect lDuration == 0 type %d", lDuration, dwType);
+		lDuration = 1;
+	}
+
+	CAffect* pkAff = NULL;
+
+	if (IsCube)
+		pkAff = FindAffect(dwType, wApplyOn);
+	else
+		pkAff = FindAffect(dwType);
+
+	if (dwFlag == AFF_STUN)
+	{
+		if (m_posDest.x != GetX() || m_posDest.y != GetY())
+		{
+			m_posDest.x = m_posStart.x = GetX();
+			m_posDest.y = m_posStart.y = GetY();
+			battle_end(this);
+
+			SyncPacket();
+		}
+	}
+
+	// ï¿½Ì¹ï¿½ ï¿½Ö´ï¿½ È¿ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ Ã³ï¿½ï¿½
+	if (pkAff && bOverride)
+	{
+		ComputeAffect(pkAff, false); // ï¿½Ï´ï¿½ È¿ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½Ï°ï¿½
+
+		if (GetDesc())
+			SendAffectRemovePacket(GetDesc(), GetPlayerID(), pkAff->dwType, pkAff->wApplyOn);
+	}
+	else
+	{
+		//
+		// ï¿½ï¿½ ï¿½ï¿½ï¿½å¸¦ ï¿½ß°ï¿½
+		//
+		// NOTE: ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ type ï¿½ï¿½ï¿½Îµï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½Æ®ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ ï¿½Ö´ï¿½.
+		//
+		pkAff = CAffect::Acquire();
+		m_list_pkAffect.push_back(pkAff);
+	}
+
+#if defined(__AFFECT_RENEWAL__)
+	sys_log(0, "AddAffect %s type %u apply %u value %ld flag %u duration %ld real_time %d", GetName(), dwType, wApplyOn, lApplyValue, dwFlag, lDuration, (bRealTime ? 1 : 0));
+	sys_log(1, "AddAffect %s type %u apply %u value %ld flag %u duration %ld real_time %d", GetName(), dwType, wApplyOn, lApplyValue, dwFlag, lDuration, (bRealTime ? 1 : 0));
+#else
+	sys_log(0, "AddAffect %s type %u apply %u value %ld flag %u duration %ld", GetName(), dwType, wApplyOn, lApplyValue, dwFlag, lDuration);
+	sys_log(1, "AddAffect %s type %u apply %u value %ld flag %u duration %ld", GetName(), dwType, wApplyOn, lApplyValue, dwFlag, lDuration);
+#endif
+
+	pkAff->dwType = dwType;
+	pkAff->wApplyOn = wApplyOn;
+	pkAff->lApplyValue = lApplyValue;
+	pkAff->dwFlag = dwFlag;
+#if defined(__AFFECT_RENEWAL__)
+	pkAff->lDuration = bRealTime ? (get_global_time() + lDuration) : lDuration;
+	pkAff->bRealTime = bRealTime;
+	pkAff->bUpdate = false;
+#else
+	pkAff->lDuration = lDuration;
+#endif
+	pkAff->lSPCost = lSPCost;
+#if defined(__9TH_SKILL__)
+	pkAff->lValue = lValue;
+#endif
+
+	long lMovSpd = GetPoint(POINT_MOV_SPEED);
+	long lAttSpd = GetPoint(POINT_ATT_SPEED);
+
+	ComputeAffect(pkAff, true);
+
+	if (pkAff->dwFlag || lMovSpd != GetPoint(POINT_MOV_SPEED) || lAttSpd != GetPoint(POINT_ATT_SPEED))
+		UpdatePacket();
+
+	StartAffectEvent();
+
+	if (IsPC())
+	{
+		SendAffectAddPacket(GetDesc(), pkAff);
+
+		if (IS_NO_SAVE_AFFECT(pkAff->dwType))
+			return true;
+
+		TPacketGDAddAffect p;
+		p.dwPID = GetPlayerID();
+		p.elem.dwType = pkAff->dwType;
+		p.elem.wApplyOn = pkAff->wApplyOn;
+		p.elem.lApplyValue = pkAff->lApplyValue;
+		p.elem.dwFlag = pkAff->dwFlag;
+		p.elem.lDuration = pkAff->lDuration;
+		p.elem.lSPCost = pkAff->lSPCost;
+#if defined(__AFFECT_RENEWAL__)
+		p.elem.bRealTime = pkAff->bRealTime;
+		p.elem.bUpdate = pkAff->bUpdate;
+#endif
+		db_clientdesc->DBPacket(HEADER_GD_ADD_AFFECT, 0, &p, sizeof(p));
+	}
+
+	return true;
+}
+
+#if defined(__AFFECT_RENEWAL__)
+bool CHARACTER::AddRealTimeAffect(DWORD dwType, POINT_TYPE wApplyOn, POINT_VALUE lApplyValue, DWORD dwFlag, long lDuration, long lSPCost, bool bOverride, bool IsCube, bool bRealTime)
+{
+	return AddAffect(dwType, wApplyOn, lApplyValue, dwFlag, lDuration, lSPCost, bOverride, IsCube, bRealTime);
+}
+#endif
+
+void CHARACTER::RefreshAffect()
+{
+	for (CAffect* const& pAffect : m_list_pkAffect)
+		ComputeAffect(pAffect, true);
+}
+
+void CHARACTER::ComputeAffect(const CAffect* pkAff, bool bAdd)
+{
+	if (bAdd && pkAff->dwType >= GUILD_SKILL_START && pkAff->dwType <= GUILD_SKILL_END)
+	{
+		if (!GetGuild())
+			return;
+
+		if (!GetGuild()->UnderAnyWar())
+			return;
+	}
+
+	if (pkAff->dwFlag)
+	{
+		if (!bAdd)
+			m_afAffectFlag.Reset(pkAff->dwFlag);
+		else
+			m_afAffectFlag.Set(pkAff->dwFlag);
+	}
+
+#if defined(__SOUL_SYSTEM__)
+	if (pkAff->dwType == AFFECT_SOUL)
+		return;
+#endif
+
+	if (bAdd)
+		PointChange(pkAff->wApplyOn, pkAff->lApplyValue);
+	else
+		PointChange(pkAff->wApplyOn, -pkAff->lApplyValue);
+
+	if (pkAff->dwType == SKILL_MUYEONG)
+	{
+		if (bAdd)
+			StartMuyeongEvent();
+		else
+			StopMuyeongEvent();
+	}
+
+#if defined(__PVP_BALANCE_IMPROVING__)
+	if (pkAff->dwType == SKILL_GYEONGGONG)
+	{
+		if (bAdd)
+			StartGyeongGongEvent();
+		else
+			StopGyeongGongEvent();
+	}
+#endif
+
+#if defined(__9TH_SKILL__)
+	if (pkAff->dwType == SKILL_CHEONUN)
+	{
+		if (bAdd)
+			StartCheonunEvent(pkAff->lApplyValue, pkAff->lValue);
+		else
+			StopCheonunEvent();
+	}
+#endif
+
+	if (pkAff->dwType == AFFECT_MOUNT_FALL)
+	{
+		if (bAdd)
+		{
+			UnMount(false);
+		}
+		else
+		{
+			if (GetHorse())
+				StartRiding();
+			else if (GetWear(WEAR_COSTUME_MOUNT))
+				MountVnum(GetPoint(POINT_MOUNT));
+		}
+	}
+}
+
+bool CHARACTER::RemoveAffect(CAffect* pkAff)
+{
+	if (!pkAff)
+		return false;
+
+	// AFFECT_BUF_FIX
+	m_list_pkAffect.remove(pkAff);
+	// END_OF_AFFECT_BUF_FIX
+
+	ComputeAffect(pkAff, false);
+
+	// ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½.
+	// ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½×´ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½Å³ ï¿½ï¿½ï¿½ï¿½->ï¿½Ð°ï¿½->ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½(AFFECT_REVIVE_INVISIBLE) ï¿½ï¿½ ï¿½Ù·ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ ï¿½ï¿½ì¿¡ ï¿½ß»ï¿½ï¿½Ñ´ï¿½.
+	// ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½Ð°ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½Ï´ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½, ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½Å³ È¿ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½Ï°ï¿½ ï¿½Ð°ï¿½ È¿ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½Ç°ï¿½ ï¿½Ç¾ï¿½ï¿½Ö´Âµï¿½,
+	// ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ ï¿½ï¿½ ï¿½Ù·ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½Ï¸ï¿½ RemoveAffectï¿½ï¿½ ï¿½Ò¸ï¿½ï¿½ï¿½ ï¿½Ç°ï¿½, ComputePointsï¿½Ï¸é¼­ ï¿½Ð°ï¿½ È¿ï¿½ï¿½ + ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½Å³ È¿ï¿½ï¿½ï¿½ï¿½ ï¿½È´ï¿½.
+	// ComputePointsï¿½ï¿½ï¿½ï¿½ ï¿½Ð°ï¿½ ï¿½ï¿½ï¿½Â¸ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½Å³ È¿ï¿½ï¿½ ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½Ï¸ï¿½ ï¿½Ç±ï¿½ ï¿½Ï´Âµï¿½,
+	// ComputePointsï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ï°ï¿½ ï¿½ï¿½ï¿½Ç°ï¿½ ï¿½Ö¾î¼­ Å« ï¿½ï¿½È­ï¿½ï¿½ ï¿½Ö´ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½.(ï¿½î¶² side effectï¿½ï¿½ ï¿½ß»ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½Ë±ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½.)
+	// ï¿½ï¿½ï¿½ï¿½ AFFECT_REVIVE_INVISIBLEï¿½ï¿½ RemoveAffectï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½Ç´ï¿½ ï¿½ï¿½ì¸¸ ï¿½ï¿½ï¿½ï¿½ï¿½Ñ´ï¿½.
+	// ï¿½Ã°ï¿½ï¿½ï¿½ ï¿½ï¿½ ï¿½Ç¾ï¿½ ï¿½ï¿½ï¿½ È¿ï¿½ï¿½ï¿½ï¿½ Ç®ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½×°ï¿½ ï¿½ß»ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½Ç·ï¿½ ï¿½×¿ï¿½ ï¿½È°ï¿½ï¿½ï¿½ ï¿½ï¿½.
+	// (ProcessAffectï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½Ã°ï¿½ï¿½ï¿½ ï¿½ï¿½ ï¿½Ç¾î¼­ Affectï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½Ç´ï¿½ ï¿½ï¿½ï¿½, ComputePointsï¿½ï¿½ ï¿½Î¸ï¿½ï¿½ï¿½ ï¿½Ê´Â´ï¿½.)
+#ifdef MOUNT_FIX
+	if (AFFECT_REVIVE_INVISIBLE != pkAff->dwType && AFFECT_MOUNT != pkAff->dwType
+#if defined(__SET_ITEM__)
+		&& (!IS_NO_CLEAR_SET_ITEM(pkAff->dwType))
+#endif
+		&& IsPC())
+#else
+	if (AFFECT_REVIVE_INVISIBLE != pkAff->dwType
+#if defined(__SET_ITEM__)
+		&& (!IS_NO_CLEAR_SET_ITEM(pkAff->dwType))
+#endif
+		&& IsPC())
+#endif
+		ComputePoints();
+	else
+		UpdatePacket();
+
+#if defined(__LOOT_FILTER_SYSTEM__) && defined(__PREMIUM_LOOT_FILTER__)
+	if (pkAff->dwType == AFFECT_LOOTING_SYSTEM)
+		ClearLootFilter();
+#endif
+
+	CheckMaximumPoints();
+
+	if (test_server)
+		sys_log(0, "AFFECT_REMOVE: %s (flag %u apply: %u)", GetName(), pkAff->dwFlag, pkAff->wApplyOn);
+
+	if (IsPC())
+	{
+		SendAffectRemovePacket(GetDesc(), GetPlayerID(), pkAff->dwType, pkAff->wApplyOn);
+	}
+
+	CAffect::Release(pkAff);
+	return true;
+}
+
+bool CHARACTER::RemoveAffect(DWORD dwType)
+{
+	// CHAT_BLOCK
+	if (dwType == AFFECT_BLOCK_CHAT)
+	{
+		ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ã¤ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ Ç®ï¿½È½ï¿½ï¿½Ï´ï¿½."));
+	}
+	// END_OF_CHAT_BLOCK
+
+	bool flag = false;
+
+	CAffect* pkAff;
+	while ((pkAff = FindAffect(dwType)))
+	{
+		RemoveAffect(pkAff);
+		flag = true;
+	}
+
+	return flag;
+}
+
+#if defined(__SOUL_SYSTEM__)
+void CHARACTER::RemoveAffect(DWORD dwType, POINT_TYPE wApplyType)
+{
+	const CAffect* pkAff = nullptr;
+	for (const auto& it : m_list_pkAffect)
+	{
+		pkAff = it;
+
+		if (pkAff->dwType == dwType)
+		{
+			if (pkAff->wApplyOn == wApplyType || pkAff->wApplyOn == APPLY_NONE)
+			{
+				break;
+			}
+		}
+
+		pkAff = nullptr;
+	}
+
+	if (pkAff != nullptr)
+		RemoveAffect(const_cast<CAffect*>(pkAff));
+}
+#endif
+
+bool CHARACTER::IsAffectFlag(DWORD dwAff) const
+{
+	return m_afAffectFlag.IsSet(dwAff);
+}
+
+void CHARACTER::RemoveGoodAffect()
+{
+	RemoveAffect(AFFECT_MOV_SPEED);
+	RemoveAffect(AFFECT_ATT_SPEED);
+	RemoveAffect(AFFECT_STR);
+	RemoveAffect(AFFECT_DEX);
+	RemoveAffect(AFFECT_INT);
+	RemoveAffect(AFFECT_CON);
+	RemoveAffect(AFFECT_CHINA_FIREWORK);
+
+	RemoveAffect(SKILL_JEONGWI);
+	RemoveAffect(SKILL_GEOMKYUNG);
+	RemoveAffect(SKILL_CHUNKEON);
+	RemoveAffect(SKILL_EUNHYUNG);
+	RemoveAffect(SKILL_GYEONGGONG);
+	RemoveAffect(SKILL_GWIGEOM);
+	RemoveAffect(SKILL_TERROR);
+	RemoveAffect(SKILL_JUMAGAP);
+	RemoveAffect(SKILL_MANASHILED);
+	RemoveAffect(SKILL_HOSIN);
+	RemoveAffect(SKILL_REFLECT);
+	RemoveAffect(SKILL_KWAESOK);
+	RemoveAffect(SKILL_JEUNGRYEOK);
+	RemoveAffect(SKILL_GICHEON);
+
+	RemoveAffect(SKILL_JEOKRANG);
+	RemoveAffect(SKILL_CHEONGRANG);
+
+#if defined(__9TH_SKILL__)
+	RemoveAffect(SKILL_CHEONUN);
+#endif
+}
+
+bool CHARACTER::IsGoodAffect(BYTE bAffectType) const
+{
+	switch (bAffectType)
+	{
+		case AFFECT_MOV_SPEED:
+		case AFFECT_ATT_SPEED:
+		case AFFECT_STR:
+		case AFFECT_DEX:
+		case AFFECT_INT:
+		case AFFECT_CON:
+		case AFFECT_CHINA_FIREWORK:
+
+		case SKILL_JEONGWI:
+		case SKILL_GEOMKYUNG:
+		case SKILL_CHUNKEON:
+		case SKILL_EUNHYUNG:
+		case SKILL_GYEONGGONG:
+		case SKILL_GWIGEOM:
+		case SKILL_TERROR:
+		case SKILL_JUMAGAP:
+		case SKILL_MANASHILED:
+		case SKILL_HOSIN:
+		case SKILL_REFLECT:
+		case SKILL_KWAESOK:
+		case SKILL_JEUNGRYEOK:
+		case SKILL_GICHEON:
+
+		case SKILL_JEOKRANG:
+		case SKILL_CHEONGRANG:
+
+#if defined(__9TH_SKILL__)
+		case SKILL_CHEONUN:
+#endif
+			return true;
+	}
+
+	return false;
+}
+
+void CHARACTER::RemoveBadAffect()
+{
+	sys_log(0, "RemoveBadAffect %s", GetName());
+	// ï¿½ï¿½
+	RemovePoison();
+	RemoveFire();
+	RemoveBleeding();
+
+	// ï¿½ï¿½ï¿½ï¿½ : Value%ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ 5ï¿½Ê°ï¿½ ï¿½Ó¸ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½Æ°ï¿½ï¿½ï¿½. (ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ 1/2 È®ï¿½ï¿½ï¿½ï¿½ Ç®ï¿½ï¿½) AFF_STUN
+	RemoveAffect(AFFECT_STUN);
+
+	// ï¿½ï¿½ï¿½Î¿ï¿½ : Value%ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½/ï¿½Ì¼ï¿½ ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½. ï¿½ï¿½ï¿½Ãµï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½Þ¶ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ ï¿½ï¿½ ï¿½ï¿½ì¿¡ AFF_SLOW
+	RemoveAffect(AFFECT_SLOW);
+
+	// ï¿½ï¿½ï¿½Ó¸ï¿½ï¿½ï¿½
+	RemoveAffect(SKILL_TUSOK);
+
+	// ï¿½ï¿½ï¿½ï¿½
+	//RemoveAffect(SKILL_CURSE);
+
+	// ï¿½Ä¹ï¿½ï¿½ï¿½
+	//RemoveAffect(SKILL_PABUP);
+
+	// ï¿½ï¿½ï¿½ï¿½ : Value%ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Å²ï¿½ï¿½. 2ï¿½ï¿½ AFF_FAINT
+	//RemoveAffect(AFFECT_FAINT);
+
+	// ï¿½Ù¸ï¿½ï¿½ï¿½ï¿½ï¿½ : Value%ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½Ìµï¿½ï¿½Óµï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½Æ®ï¿½ï¿½ï¿½ï¿½. 5ï¿½Ê°ï¿½ -40 AFF_WEB
+	//RemoveAffect(AFFECT_WEB);
+
+	// ï¿½ï¿½ï¿½ï¿½ : Value%ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ 10ï¿½Ê°ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½. (ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ Ç®ï¿½ï¿½) AFF_SLEEP
+	//RemoveAffect(AFFECT_SLEEP);
+
+	// ï¿½ï¿½ï¿½ï¿½ : Value%ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½/ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½Æ®ï¿½ï¿½ï¿½ï¿½. ï¿½ï¿½ï¿½Ãµï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½Þ¶ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ ï¿½ï¿½ ï¿½ï¿½ì¿¡ AFF_CURSE
+	//RemoveAffect(AFFECT_CURSE);
+
+	// ï¿½ï¿½ï¿½ï¿½ : Value%ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ 4ï¿½Ê°ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½Å²ï¿½ï¿½. AFF_PARA
+	//RemoveAffect(AFFECT_PARALYZE);
+
+	// ï¿½Îµï¿½ï¿½Úºï¿½ : ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½
+	//RemoveAffect(SKILL_BUDONG);
+}
diff --git a/server/metin2/Source/Server/game/src/cmd_general.cpp b/server/metin2/Source/Server/game/src/cmd_general.cpp
index bd41cf7..ae9f315 100644
--- a/server/metin2/Source/Server/game/src/cmd_general.cpp
+++ b/server/metin2/Source/Server/game/src/cmd_general.cpp
@@ -1,2791 +1,456 @@
-#include "stdafx.h"
-#ifdef __FreeBSD__
-#include <md5.h>
-#else
-#include "../../libthecore/include/xmd5.h"
-#endif
-
-#include "utils.h"
-#include "config.h"
-#include "desc_client.h"
-#include "desc_manager.h"
-#include "char.h"
-#include "char_manager.h"
-#include "motion.h"
-#include "packet.h"
-#include "affect.h"
-#include "pvp.h"
-#include "start_position.h"
-#include "party.h"
-#include "guild_manager.h"
-#include "p2p.h"
-#include "dungeon.h"
-#include "messenger_manager.h"
-#include "war_map.h"
-#include "questmanager.h"
-#include "item_manager.h"
-#include "monarch.h"
-#include "mob_manager.h"
-#include "dev_log.h"
-#include "item.h"
-#include "arena.h"
-#include "buffer_manager.h"
-#include "unique_item.h"
-#include "threeway_war.h"
-#include "log.h"
-#include "../../common/VnumHelper.h"
-#if defined(__OFFLINE_SHOP__)
-#include "OfflineShop.h"
-#endif
-#ifdef ENABLE_QUEEN_NETHIS
-#include "SnakeLair.h"
-#endif
-
-extern int g_server_id;
-
-extern int g_nPortalLimitTime;
-
-ACMD(do_user_horse_ride)
-{
-	if (ch->IsObserverMode())
-		return;
-
-	if (ch->IsDead() || ch->IsStun())
-		return;
-
-	if (ch->IsHorseRiding() == false)
-	{
-		// ¸»ÀÌ ¾Æ´Ñ ´Ù¸¥Å»°ÍÀ» Å¸°íÀÖ´Ù.
-		if (ch->GetMountVnum())
-		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ÀÌ¹Ì Å»°ÍÀ» ÀÌ¿ëÁßÀÔ´Ï´Ù."));
-			return;
-		}
-
-		if (ch->GetHorse() == NULL)
-		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("¸»À» ¸ÕÀú ¼ÒÈ¯ÇØÁÖ¼¼¿ä."));
-			return;
-		}
-
-		ch->StartRiding();
-	}
-	else
-	{
-		ch->StopRiding();
-	}
-}
-
-ACMD(do_user_horse_back)
-{
-	if (ch->GetHorse() != NULL)
-	{
-		ch->HorseSummon(false);
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("¸»À» µ¹·Áº¸³Â½À´Ï´Ù."));
-	}
-	else if (ch->IsHorseRiding() == true)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("¸»¿¡¼­ ¸ÕÀú ³»·Á¾ß ÇÕ´Ï´Ù."));
-	}
-	else
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("¸»À» ¸ÕÀú ¼ÒÈ¯ÇØÁÖ¼¼¿ä."));
-	}
-}
-
-ACMD(do_user_horse_feed)
-{
-	// °³ÀÎ»óÁ¡À» ¿¬ »óÅÂ¿¡¼­´Â ¸» ¸ÔÀÌ¸¦ ÁÙ ¼ö ¾ø´Ù.
-	if (ch->GetMyShop())
-		return;
-
-	if (!ch->GetHorse())
-	{
-		if (ch->IsHorseRiding() == false)
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("¸»À» ¸ÕÀú ¼ÒÈ¯ÇØÁÖ¼¼¿ä."));
-		else
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("¸»À» Åº »óÅÂ¿¡¼­´Â ¸ÔÀÌ¸¦ ÁÙ ¼ö ¾ø½À´Ï´Ù."));
-		return;
-	}
-
-	DWORD dwFood = ch->GetHorseGrade() + 50054 - 1;
-
-	if (ch->CountSpecifyItem(dwFood) > 0)
-	{
-		ch->RemoveSpecifyItem(dwFood, 1);
-		ch->FeedHorse();
-
-		const char* c_szConv = under_han(ITEM_MANAGER::instance().GetTable(dwFood)->szLocaleName) ? LC_STRING("À»") : LC_STRING("¸¦");
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("¸»¿¡°Ô %s%s ÁÖ¾ú½À´Ï´Ù.",
-			LC_ITEM(ITEM_MANAGER::instance().GetTable(dwFood)->dwVnum), c_szConv));
-	}
-	else
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s ¾ÆÀÌÅÛÀÌ ÇÊ¿äÇÕ´Ï´Ù", LC_ITEM(ITEM_MANAGER::instance().GetTable(dwFood)->dwVnum)));
-	}
-}
-
-#define MAX_REASON_LEN 128
-
-EVENTINFO(TimedEventInfo)
-{
-	DynamicCharacterPtr ch;
-	int subcmd;
-	int left_second;
-	char szReason[MAX_REASON_LEN];
-
-	TimedEventInfo()
-		: ch()
-		, subcmd(0)
-		, left_second(0)
-	{
-		::memset(szReason, 0, MAX_REASON_LEN);
-	}
-};
-
-struct SendDisconnectFunc
-{
-	void operator () (LPDESC d)
-	{
-		if (d->GetCharacter())
-		{
-			if (d->GetCharacter()->GetGMLevel() == GM_PLAYER)
-				d->GetCharacter()->ChatPacket(CHAT_TYPE_COMMAND, "quit Shutdown(SendDisconnectFunc)");
-		}
-	}
-};
-
-struct DisconnectFunc
-{
-	void operator () (LPDESC d)
-	{
-		if (d->GetType() == DESC_TYPE_CONNECTOR)
-			return;
-
-		if (d->IsPhase(PHASE_P2P))
-			return;
-
-		if (d->GetCharacter())
-			d->GetCharacter()->Disconnect("Shutdown(DisconnectFunc)");
-
-		d->SetPhase(PHASE_CLOSE);
-	}
-};
-
-EVENTINFO(shutdown_event_data)
-{
-	int seconds;
-
-	shutdown_event_data()
-		: seconds(0)
-	{
-	}
-};
-
-EVENTFUNC(shutdown_event)
-{
-	shutdown_event_data* info = dynamic_cast<shutdown_event_data*>(event->info);
-
-	if (info == NULL)
-	{
-		sys_err("shutdown_event> <Factor> Null pointer");
-		return 0;
-	}
-
-	int* pSec = &(info->seconds);
-
-	if (*pSec < 0)
-	{
-		sys_log(0, "shutdown_event sec %d", *pSec);
-
-		if (--*pSec == -10)
-		{
-			const DESC_MANAGER::DESC_SET& c_set_desc = DESC_MANAGER::instance().GetClientSet();
-			std::for_each(c_set_desc.begin(), c_set_desc.end(), DisconnectFunc());
-			return passes_per_sec;
-		}
-		else if (*pSec < -10)
-			return 0;
-
-		return passes_per_sec;
-	}
-	else if (*pSec == 0)
-	{
-		const DESC_MANAGER::DESC_SET& c_set_desc = DESC_MANAGER::instance().GetClientSet();
-		std::for_each(c_set_desc.begin(), c_set_desc.end(), SendDisconnectFunc());
-		g_bNoMoreClient = true;
-		--*pSec;
-		return passes_per_sec;
-	}
-	else
-	{
-		char buf[64];
-		snprintf(buf, sizeof(buf), LC_STRING("¼Ë´Ù¿îÀÌ %dÃÊ ³²¾Ò½À´Ï´Ù.", *pSec));
-		SendNotice(buf);
-
-		--*pSec;
-		return passes_per_sec;
-	}
-}
-
-void Shutdown(int iSec)
-{
-	if (g_bNoMoreClient)
-	{
-		thecore_shutdown();
-		return;
-	}
-
-	CWarMapManager::instance().OnShutdown();
-
-	char buf[64];
-	snprintf(buf, sizeof(buf), LC_STRING("%dÃÊ ÈÄ °ÔÀÓÀÌ ¼Ë´Ù¿î µË´Ï´Ù.", iSec));
-
-	SendNotice(buf);
-
-	shutdown_event_data* info = AllocEventInfo<shutdown_event_data>();
-	info->seconds = iSec;
-
-	event_create(shutdown_event, info, 1);
-}
-
-ACMD(do_shutdown)
-{
-	TPacketGGShutdown p;
-	p.bHeader = HEADER_GG_SHUTDOWN;
-	P2P_MANAGER::instance().Send(&p, sizeof(TPacketGGShutdown));
-
-	Shutdown(10);
-}
-
-EVENTFUNC(timed_event)
-{
-	TimedEventInfo* info = dynamic_cast<TimedEventInfo*>(event->info);
-
-	if (info == NULL)
-	{
-		sys_err("timed_event> <Factor> Null pointer");
-		return 0;
-	}
-
-	LPCHARACTER ch = info->ch;
-
-	if (ch == NULL) // <Factor>
-		return 0;
-
-	LPDESC d = ch->GetDesc();
-
-	if (info->left_second <= 0)
-	{
-		ch->m_pkTimedEvent = NULL;
-
-		if (true == LC_IsEurope() || true == LC_IsYMIR() || true == LC_IsKorea())
-		{
-			switch (info->subcmd)
-			{
-				case SCMD_LOGOUT:
-				case SCMD_QUIT:
-				case SCMD_PHASE_SELECT:
-#if defined(__LOCALE_CLIENT__)
-				case SCMD_LANGUAGE_CHANGE:
-#endif
-				{
-					TPacketNeedLoginLogInfo acc_info;
-					acc_info.dwPlayerID = ch->GetDesc()->GetAccountTable().id;
-					db_clientdesc->DBPacket(HEADER_GD_VALID_LOGOUT, 0, &acc_info, sizeof(acc_info));
-
-					LogManager::instance().DetailLoginLog(false, ch);
-				}
-				break;
-			}
-		}
-
-		switch (info->subcmd)
-		{
-			case SCMD_LOGOUT:
-				if (d)
-					d->SetPhase(PHASE_CLOSE);
-				break;
-
-			case SCMD_QUIT:
-				ch->ChatPacket(CHAT_TYPE_COMMAND, "quit");
-				break;
-
-			case SCMD_PHASE_SELECT:
-			{
-				ch->Disconnect("timed_event - SCMD_PHASE_SELECT");
-
-				if (d)
-				{
-					d->SetPhase(PHASE_SELECT);
-				}
-			}
-			break;
-
-#if defined(__LOCALE_CLIENT__)
-			case SCMD_LANGUAGE_CHANGE:
-			{
-				ch->ChatPacket(CHAT_TYPE_COMMAND, "language_change");
-				ch->Disconnect("timed_event - SCMD_LANGUAGE_CHANGE");
-
-				if (d)
-					d->SetPhase(PHASE_SELECT);
-			}
-
-			break;
-#endif
-		}
-
-		return 0;
-	}
-	else
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%dÃÊ ³²¾Ò½À´Ï´Ù.", info->left_second));
-		--info->left_second;
-	}
-
-	return PASSES_PER_SEC(1);
-}
-
-ACMD(do_cmd)
-{
-	// RECALL_DELAY
-	/*
-	if (ch->m_pkRecallEvent != NULL)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ãë¼Ò µÇ¾ú½À´Ï´Ù."));
-		event_cancel(&ch->m_pkRecallEvent);
-		return;
-	}
-	*/
-	// END_OF_RECALL_DELAY
-
-	if (ch->m_pkTimedEvent)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ãë¼Ò µÇ¾ú½À´Ï´Ù."));
-		event_cancel(&ch->m_pkTimedEvent);
-		return;
-	}
-
-	switch (subcmd)
-	{
-		case SCMD_LOGOUT:
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("·Î±×ÀÎ È­¸éÀ¸·Î µ¹¾Æ °©´Ï´Ù. Àá½Ã¸¸ ±â´Ù¸®¼¼¿ä."));
-			break;
-
-		case SCMD_QUIT:
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("°ÔÀÓÀ» Á¾·á ÇÕ´Ï´Ù. Àá½Ã¸¸ ±â´Ù¸®¼¼¿ä."));
-			break;
-
-		case SCMD_PHASE_SELECT:
-#if defined(__LOCALE_CLIENT__)
-		case SCMD_LANGUAGE_CHANGE:
-#endif
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ä³¸¯ÅÍ¸¦ ÀüÈ¯ ÇÕ´Ï´Ù. Àá½Ã¸¸ ±â´Ù¸®¼¼¿ä."));
-			break;
-	}
-
-	int nExitLimitTime = 10;
-
-	if (ch->IsHack(false, true, nExitLimitTime) &&
-		false == CThreeWayWar::instance().IsSungZiMapIndex(ch->GetMapIndex()) &&
-		(!ch->GetWarMap() || ch->GetWarMap()->GetType() == GUILD_WAR_TYPE_FLAG))
-	{
-		return;
-	}
-
-	switch (subcmd)
-	{
-		case SCMD_LOGOUT:
-		case SCMD_QUIT:
-		case SCMD_PHASE_SELECT:
-#if defined(__LOCALE_CLIENT__)
-		case SCMD_LANGUAGE_CHANGE:
-#endif
-		{
-			TimedEventInfo* info = AllocEventInfo<TimedEventInfo>();
-
-			{
-				if (ch->IsPosition(POS_FIGHTING))
-					info->left_second = 10;
-				else
-					info->left_second = 3;
-			}
-
-			info->ch = ch;
-			info->subcmd = subcmd;
-			strlcpy(info->szReason, argument, sizeof(info->szReason));
-
-			ch->m_pkTimedEvent = event_create(timed_event, info, 1);
-		}
-		break;
-	}
-}
-
-ACMD(do_mount)
-{
-	/*
-	char arg1[256];
-	struct action_mount_param param;
-
-	// ÀÌ¹Ì Å¸°í ÀÖÀ¸¸é
-	if (ch->GetMountingChr())
-	{
-		char arg2[256];
-		two_arguments(argument, arg1, sizeof(arg1), arg2, sizeof(arg2));
-
-		if (!*arg1 || !*arg2)
-			return;
-
-		param.x = atoi(arg1);
-		param.y = atoi(arg2);
-		param.vid = ch->GetMountingChr()->GetVID();
-		param.is_unmount = true;
-
-		float distance = DISTANCE_SQRT(param.x - (DWORD)ch->GetX(), param.y - (DWORD)ch->GetY());
-
-		if (distance > 600.0f)
-		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Á» ´õ °¡±îÀÌ °¡¼­ ³»¸®¼¼¿ä."));
-			return;
-		}
-
-		action_enqueue(ch, ACTION_TYPE_MOUNT, &param, 0.0f, true);
-		return;
-	}
-
-	one_argument(argument, arg1, sizeof(arg1));
-
-	if (!*arg1)
-		return;
-
-	LPCHARACTER tch = CHARACTER_MANAGER::instance().Find(atoi(arg1));
-
-	if (!tch->IsNPC() || !tch->IsMountable())
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("°Å±â¿¡´Â Å» ¼ö ¾ø¾î¿ä."));
-		return;
-	}
-
-	float distance = DISTANCE_SQRT(tch->GetX() - ch->GetX(), tch->GetY() - ch->GetY());
-
-	if (distance > 600.0f)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Á» ´õ °¡±îÀÌ °¡¼­ Å¸¼¼¿ä."));
-		return;
-	}
-
-	param.vid = tch->GetVID();
-	param.is_unmount = false;
-
-	action_enqueue(ch, ACTION_TYPE_MOUNT, &param, 0.0f, true);
-	*/
-}
-
-ACMD(do_fishing)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	if (!*arg1)
-		return;
-
-	ch->SetRotation(atof(arg1));
-	ch->fishing();
-}
-
-ACMD(do_console)
-{
-	ch->ChatPacket(CHAT_TYPE_COMMAND, "ConsoleEnable");
-}
-
-ACMD(do_restart)
-{
-	ch->Restart(subcmd);
-}
-
-ACMD(do_stat_reset)
-{
-	ch->PointChange(POINT_STAT_RESET_COUNT, 12 - ch->GetPoint(POINT_STAT_RESET_COUNT));
-}
-
-ACMD(do_stat_minus)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	if (!*arg1)
-		return;
-
-	if (ch->IsPolymorphed())
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("µÐ°© Áß¿¡´Â ´É·ÂÀ» ¿Ã¸± ¼ö ¾ø½À´Ï´Ù."));
-		return;
-	}
-
-	if (ch->GetPoint(POINT_STAT_RESET_COUNT) <= 0)
-		return;
-
-	if (!strcmp(arg1, "st"))
-	{
-		if (ch->GetRealPoint(POINT_ST) <= JobInitialPoints[ch->GetJob()].st)
-			return;
-
-		ch->SetRealPoint(POINT_ST, ch->GetRealPoint(POINT_ST) - 1);
-		ch->SetPoint(POINT_ST, ch->GetPoint(POINT_ST) - 1);
-		ch->ComputePoints();
-		ch->PointChange(POINT_ST, 0);
-	}
-	else if (!strcmp(arg1, "dx"))
-	{
-		if (ch->GetRealPoint(POINT_DX) <= JobInitialPoints[ch->GetJob()].dx)
-			return;
-
-		ch->SetRealPoint(POINT_DX, ch->GetRealPoint(POINT_DX) - 1);
-		ch->SetPoint(POINT_DX, ch->GetPoint(POINT_DX) - 1);
-		ch->ComputePoints();
-		ch->PointChange(POINT_DX, 0);
-	}
-	else if (!strcmp(arg1, "ht"))
-	{
-		if (ch->GetRealPoint(POINT_HT) <= JobInitialPoints[ch->GetJob()].ht)
-			return;
-
-		ch->SetRealPoint(POINT_HT, ch->GetRealPoint(POINT_HT) - 1);
-		ch->SetPoint(POINT_HT, ch->GetPoint(POINT_HT) - 1);
-		ch->ComputePoints();
-		ch->PointChange(POINT_HT, 0);
-		ch->PointChange(POINT_MAX_HP, 0);
-	}
-	else if (!strcmp(arg1, "iq"))
-	{
-		if (ch->GetRealPoint(POINT_IQ) <= JobInitialPoints[ch->GetJob()].iq)
-			return;
-
-		ch->SetRealPoint(POINT_IQ, ch->GetRealPoint(POINT_IQ) - 1);
-		ch->SetPoint(POINT_IQ, ch->GetPoint(POINT_IQ) - 1);
-		ch->ComputePoints();
-		ch->PointChange(POINT_IQ, 0);
-		ch->PointChange(POINT_MAX_SP, 0);
-	}
-	else
-		return;
-
-	ch->PointChange(POINT_STAT, +1);
-	ch->PointChange(POINT_STAT_RESET_COUNT, -1);
-	ch->ComputePoints();
-}
-
-ACMD(do_stat)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	if (!*arg1)
-		return;
-
-	if (ch->IsPolymorphed())
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("µÐ°© Áß¿¡´Â ´É·ÂÀ» ¿Ã¸± ¼ö ¾ø½À´Ï´Ù."));
-		return;
-	}
-
-	if (ch->GetPoint(POINT_STAT) <= 0)
-		return;
-
-	POINT_TYPE idx = 0;
-
-	if (!strcmp(arg1, "st"))
-		idx = POINT_ST;
-	else if (!strcmp(arg1, "dx"))
-		idx = POINT_DX;
-	else if (!strcmp(arg1, "ht"))
-		idx = POINT_HT;
-	else if (!strcmp(arg1, "iq"))
-		idx = POINT_IQ;
-	else
-		return;
-
-	if (ch->GetRealPoint(idx) >= gPlayerMaxLevelStats)
-		return;
-
-	ch->SetRealPoint(idx, ch->GetRealPoint(idx) + 1);
-	ch->SetPoint(idx, ch->GetPoint(idx) + 1);
-	ch->ComputePoints();
-	ch->PointChange(idx, 0);
-
-	if (idx == POINT_IQ)
-	{
-		ch->PointChange(POINT_MAX_HP, 0);
-	}
-	else if (idx == POINT_HT)
-	{
-		ch->PointChange(POINT_MAX_SP, 0);
-	}
-
-	ch->PointChange(POINT_STAT, -1);
-	ch->ComputePoints();
-}
-
-#if defined(__CONQUEROR_LEVEL__)
-ACMD(do_conqueror_point)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	if (!*arg1)
-		return;
-
-	if (ch->IsPolymorphed())
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("µÐ°© Áß¿¡´Â ´É·ÂÀ» ¿Ã¸± ¼ö ¾ø½À´Ï´Ù."));
-		return;
-	}
-
-	if (ch->GetPoint(POINT_CONQUEROR_POINT) <= 0)
-		return;
-
-	POINT_VALUE idx = 0;
-	if (!strcmp(arg1, "sstr"))
-		idx = POINT_SUNGMA_STR;
-	else if (!strcmp(arg1, "shp"))
-		idx = POINT_SUNGMA_HP;
-	else if (!strcmp(arg1, "smove"))
-		idx = POINT_SUNGMA_MOVE;
-	else if (!strcmp(arg1, "simmune"))
-		idx = POINT_SUNGMA_IMMUNE;
-	else
-		return;
-
-	if (ch->GetRealPoint(idx) >= gPlayerMaxLevelStats)
-		return;
-
-	ch->SetRealPoint(idx, ch->GetRealPoint(idx) + 1);
-	ch->SetPoint(idx, ch->GetPoint(idx) + 1);
-	ch->ComputePoints();
-	ch->PointChange(idx, 0);
-
-	ch->PointChange(POINT_CONQUEROR_POINT, -1);
-	ch->ComputePoints();
-
-	ch->PointsPacket(); // Refresh points.
-}
-#endif
-
-ACMD(do_pvp)
-{
-	if (ch->GetArena() != NULL || CArenaManager::instance().IsArenaMap(ch->GetMapIndex()) == true)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("´ë·ÃÀå¿¡¼­ »ç¿ëÇÏ½Ç ¼ö ¾ø½À´Ï´Ù."));
-		return;
-	}
-
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	DWORD vid = 0;
-	str_to_number(vid, arg1);
-
-	LPCHARACTER pkVictim = CHARACTER_MANAGER::instance().Find(vid);
-
-	if (!pkVictim)
-		return;
-
-	if (pkVictim->IsNPC())
-		return;
-
-#if defined(__MESSENGER_BLOCK_SYSTEM__)
-	if (CMessengerManager::instance().IsBlocked(ch->GetName(), pkVictim->GetName()))
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Unblock %s to continue.", pkVictim->GetName()));
-		return;
-	}
-	else if (CMessengerManager::instance().IsBlocked(pkVictim->GetName(), ch->GetName()))
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s has blocked you.", pkVictim->GetName()));
-		return;
-	}
-#endif
-
-	if (pkVictim->GetArena() != NULL)
-	{
-		pkVictim->ChatPacket(CHAT_TYPE_INFO, LC_STRING("»ó´ë¹æÀÌ ´ë·ÃÁßÀÔ´Ï´Ù."));
-		return;
-	}
-
-	CPVPManager::instance().Insert(ch, pkVictim);
-}
-
-ACMD(do_guildskillup)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	if (!*arg1)
-		return;
-
-	if (!ch->GetGuild())
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<±æµå> ±æµå¿¡ ¼ÓÇØÀÖÁö ¾Ê½À´Ï´Ù."));
-		return;
-	}
-
-	CGuild* g = ch->GetGuild();
-	TGuildMember* gm = g->GetMember(ch->GetPlayerID());
-	if (gm->grade == GUILD_LEADER_GRADE)
-	{
-		DWORD vnum = 0;
-		str_to_number(vnum, arg1);
-		g->SkillLevelUp(vnum);
-	}
-	else
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<±æµå> ±æµå ½ºÅ³ ·¹º§À» º¯°æÇÒ ±ÇÇÑÀÌ ¾ø½À´Ï´Ù."));
-	}
-}
-
-ACMD(do_skillup)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	if (!*arg1)
-		return;
-
-	DWORD vnum = 0;
-	str_to_number(vnum, arg1);
-
-	if (true == ch->CanUseSkill(vnum))
-	{
-		ch->SkillLevelUp(vnum);
-	}
-	else
-	{
-		switch (vnum)
-		{
-			case SKILL_HORSE_WILDATTACK:
-			case SKILL_HORSE_CHARGE:
-			case SKILL_HORSE_ESCAPE:
-			case SKILL_HORSE_WILDATTACK_RANGE:
-
-			case SKILL_7_A_ANTI_TANHWAN:
-			case SKILL_7_B_ANTI_AMSEOP:
-			case SKILL_7_C_ANTI_SWAERYUNG:
-			case SKILL_7_D_ANTI_YONGBI:
-
-			case SKILL_8_A_ANTI_GIGONGCHAM:
-			case SKILL_8_B_ANTI_YEONSA:
-			case SKILL_8_C_ANTI_MAHWAN:
-			case SKILL_8_D_ANTI_BYEURAK:
-
-			case SKILL_ADD_HP:
-			case SKILL_RESIST_PENETRATE:
-
-#if defined(__7AND8TH_SKILLS__)
-			case SKILL_ANTI_PALBANG:
-			case SKILL_ANTI_AMSEOP:
-			case SKILL_ANTI_SWAERYUNG:
-			case SKILL_ANTI_YONGBI:
-			case SKILL_ANTI_GIGONGCHAM:
-			case SKILL_ANTI_HWAJO:
-			case SKILL_ANTI_MARYUNG:
-			case SKILL_ANTI_BYEURAK:
-			case SKILL_ANTI_SALPOONG:
-			case SKILL_HELP_PALBANG:
-			case SKILL_HELP_AMSEOP:
-			case SKILL_HELP_SWAERYUNG:
-			case SKILL_HELP_YONGBI:
-			case SKILL_HELP_GIGONGCHAM:
-			case SKILL_HELP_HWAJO:
-			case SKILL_HELP_MARYUNG:
-			case SKILL_HELP_BYEURAK:
-			case SKILL_HELP_SALPOONG:
-#endif
-				ch->SkillLevelUp(vnum);
-				break;
-		}
-	}
-}
-
-//
-// @version 05/06/20 Bang2ni - Ä¿¸Çµå Ã³¸® Delegate to CHARACTER class
-//
-ACMD(do_safebox_close)
-{
-	ch->CloseSafebox();
-}
-
-//
-// @version 05/06/20 Bang2ni - Ä¿¸Çµå Ã³¸® Delegate to CHARACTER class
-//
-ACMD(do_safebox_password)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-	ch->ReqSafeboxLoad(arg1);
-}
-
-ACMD(do_safebox_change_password)
-{
-	char arg1[256];
-	char arg2[256];
-
-	two_arguments(argument, arg1, sizeof(arg1), arg2, sizeof(arg2));
-
-	if (!*arg1 || strlen(arg1) > 6)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ã¢°í> Àß¸øµÈ ¾ÏÈ£¸¦ ÀÔ·ÂÇÏ¼Ì½À´Ï´Ù."));
-		return;
-	}
-
-	if (!*arg2 || strlen(arg2) > 6)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ã¢°í> Àß¸øµÈ ¾ÏÈ£¸¦ ÀÔ·ÂÇÏ¼Ì½À´Ï´Ù."));
-		return;
-	}
-
-	if (LC_IsBrazil() == true)
-	{
-		for (int i = 0; i < 6; ++i)
-		{
-			if (arg2[i] == '\0')
-				break;
-
-			if (isalpha(arg2[i]) == false)
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ã¢°í> ºñ¹Ð¹øÈ£´Â ¿µ¹®ÀÚ¸¸ °¡´ÉÇÕ´Ï´Ù."));
-				return;
-			}
-		}
-	}
-
-	TSafeboxChangePasswordPacket p;
-
-	p.dwID = ch->GetDesc()->GetAccountTable().id;
-	strlcpy(p.szOldPassword, arg1, sizeof(p.szOldPassword));
-	strlcpy(p.szNewPassword, arg2, sizeof(p.szNewPassword));
-
-	db_clientdesc->DBPacket(HEADER_GD_SAFEBOX_CHANGE_PASSWORD, ch->GetDesc()->GetHandle(), &p, sizeof(p));
-}
-
-ACMD(do_mall_password)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	if (!*arg1 || strlen(arg1) > 6)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ã¢°í> Àß¸øµÈ ¾ÏÈ£¸¦ ÀÔ·ÂÇÏ¼Ì½À´Ï´Ù."));
-		return;
-	}
-
-	int iPulse = thecore_pulse();
-
-	if (ch->GetMall())
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ã¢°í> Ã¢°í°¡ ÀÌ¹Ì ¿­·ÁÀÖ½À´Ï´Ù."));
-		return;
-	}
-
-	if (iPulse - ch->GetMallLoadTime() < passes_per_sec * 10) // 10ÃÊ¿¡ ÇÑ¹ø¸¸ ¿äÃ» °¡´É
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<Ã¢°í> Ã¢°í¸¦ ´ÝÀºÁö 10ÃÊ ¾È¿¡´Â ¿­ ¼ö ¾ø½À´Ï´Ù."));
-		return;
-	}
-
-	ch->SetMallLoadTime(iPulse);
-
-	TSafeboxLoadPacket p;
-	p.dwID = ch->GetDesc()->GetAccountTable().id;
-	strlcpy(p.szLogin, ch->GetDesc()->GetAccountTable().login, sizeof(p.szLogin));
-	strlcpy(p.szPassword, arg1, sizeof(p.szPassword));
-
-	db_clientdesc->DBPacket(HEADER_GD_MALL_LOAD, ch->GetDesc()->GetHandle(), &p, sizeof(p));
-}
-
-ACMD(do_mall_close)
-{
-	if (ch->GetMall())
-	{
-		ch->SetMallLoadTime(thecore_pulse());
-		ch->CloseMall();
-		ch->Save();
-	}
-}
-
-ACMD(do_ungroup)
-{
-	if (!ch->GetParty())
-		return;
-
-	if (!CPartyManager::instance().IsEnablePCParty())
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<ÆÄÆ¼> ¼­¹ö ¹®Á¦·Î ÆÄÆ¼ °ü·Ã Ã³¸®¸¦ ÇÒ ¼ö ¾ø½À´Ï´Ù."));
-		return;
-	}
-
-	if (ch->GetDungeon()
-#if defined(__GUILD_DRAGONLAIR_PARTY_SYSTEM__)
-		|| ch->GetGuildDragonLair()
-#endif
-#if defined(__DEFENSE_WAVE__)
-		|| ch->GetDefenseWave()
-#endif
-		)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<ÆÄÆ¼> ´øÀü ¾È¿¡¼­´Â ÆÄÆ¼¿¡¼­ ³ª°¥ ¼ö ¾ø½À´Ï´Ù."));
-		return;
-	}
-
-#ifdef ENABLE_QUEEN_NETHIS
-	if (SnakeLair::CSnk::instance().IsSnakeMap(ch->GetMapIndex()))
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<ÆÄÆ¼> ´øÀü ¾È¿¡¼­´Â ÆÄÆ¼¿¡¼­ ³ª°¥ ¼ö ¾ø½À´Ï´Ù."));
-		return;
-	}
-#endif
-
-	LPPARTY pParty = ch->GetParty();
-
-	if (pParty->GetMemberCount() == 2)
-	{
-		// party disband
-		CPartyManager::instance().DeleteParty(pParty);
-	}
-	else
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<ÆÄÆ¼> ÆÄÆ¼¿¡¼­ ³ª°¡¼Ì½À´Ï´Ù."));
-		//pParty->SendPartyRemoveOneToAll(ch);
-		pParty->Quit(ch->GetPlayerID());
-		//pParty->SendPartyRemoveAllToOne(ch);
-	}
-}
-
-ACMD(do_close_shop)
-{
-	if (ch->GetMyShop())
-	{
-		ch->CloseMyShop();
-		return;
-	}
-}
-
-ACMD(do_set_walk_mode)
-{
-	ch->SetNowWalking(true);
-	ch->SetWalking(true);
-}
-
-ACMD(do_set_run_mode)
-{
-	ch->SetNowWalking(false);
-	ch->SetWalking(false);
-}
-
-ACMD(do_war)
-{
-	// ³» ±æµå Á¤º¸¸¦ ¾ò¾î¿À°í
-	CGuild* g = ch->GetGuild();
-
-	if (!g)
-		return;
-
-	// ÀüÀïÁßÀÎÁö Ã¼Å©ÇÑ¹ø!
-	if (g->UnderAnyWar())
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<±æµå> ÀÌ¹Ì ´Ù¸¥ ÀüÀï¿¡ ÂüÀü Áß ÀÔ´Ï´Ù."));
-		return;
-	}
-
-	// ÆÄ¶ó¸ÞÅÍ¸¦ µÎ¹è·Î ³ª´©°í
-	char arg1[256], arg2[256];
-	int type = GUILD_WAR_TYPE_FIELD;
-	two_arguments(argument, arg1, sizeof(arg1), arg2, sizeof(arg2));
-
-	if (!*arg1)
-		return;
-
-	if (*arg2)
-	{
-		str_to_number(type, arg2);
-
-		if (type < 0 || type >= GUILD_WAR_TYPE_MAX_NUM)
-			type = GUILD_WAR_TYPE_FIELD;
-	}
-
-	// ±æµåÀÇ ¸¶½ºÅÍ ¾ÆÀÌµð¸¦ ¾ò¾î¿ÂµÚ
-	DWORD gm_pid = g->GetMasterPID();
-
-	// ¸¶½ºÅÍÀÎÁö Ã¼Å©(±æÀüÀº ±æµåÀå¸¸ÀÌ °¡´É)
-	if (gm_pid != ch->GetPlayerID())
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<±æµå> ±æµåÀü¿¡ ´ëÇÑ ±ÇÇÑÀÌ ¾ø½À´Ï´Ù."));
-		return;
-	}
-
-	// »ó´ë ±æµå¸¦ ¾ò¾î¿À°í
-	CGuild* opp_g = CGuildManager::instance().FindGuildByName(arg1);
-
-	if (!opp_g)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<±æµå> ±×·± ±æµå°¡ ¾ø½À´Ï´Ù."));
-		return;
-	}
-
-	// »ó´ë±æµå¿ÍÀÇ »óÅÂ Ã¼Å©
-	switch (g->GetGuildWarState(opp_g->GetID()))
-	{
-		case GUILD_WAR_NONE:
-		{
-			if (opp_g->UnderAnyWar())
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<±æµå> »ó´ë¹æ ±æµå°¡ ÀÌ¹Ì ÀüÀï Áß ÀÔ´Ï´Ù."));
-				return;
-			}
-
-			int iWarPrice = KOR_aGuildWarInfo[type].iWarPrice;
-
-			if (g->GetGuildMoney() < iWarPrice)
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<±æµå> Àüºñ°¡ ºÎÁ·ÇÏ¿© ±æµåÀüÀ» ÇÒ ¼ö ¾ø½À´Ï´Ù."));
-				return;
-			}
-
-			if (opp_g->GetGuildMoney() < iWarPrice)
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<±æµå> »ó´ë¹æ ±æµåÀÇ Àüºñ°¡ ºÎÁ·ÇÏ¿© ±æµåÀüÀ» ÇÒ ¼ö ¾ø½À´Ï´Ù."));
-				return;
-			}
-		}
-		break;
-
-		case GUILD_WAR_SEND_DECLARE:
-		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ÀÌ¹Ì ¼±ÀüÆ÷°í ÁßÀÎ ±æµåÀÔ´Ï´Ù."));
-			return;
-		}
-		break;
-
-		case GUILD_WAR_RECV_DECLARE:
-		{
-			if (opp_g->UnderAnyWar())
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<±æµå> »ó´ë¹æ ±æµå°¡ ÀÌ¹Ì ÀüÀï Áß ÀÔ´Ï´Ù."));
-				g->RequestRefuseWar(opp_g->GetID());
-				return;
-			}
-		}
-		break;
-
-		case GUILD_WAR_RESERVE:
-		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<±æµå> ÀÌ¹Ì ÀüÀïÀÌ ¿¹¾àµÈ ±æµå ÀÔ´Ï´Ù."));
-			return;
-		}
-		break;
-
-		case GUILD_WAR_END:
-			return;
-
-		default:
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<±æµå> ÀÌ¹Ì ÀüÀï ÁßÀÎ ±æµåÀÔ´Ï´Ù."));
-			g->RequestRefuseWar(opp_g->GetID());
-			return;
-	}
-
-	if (!g->CanStartWar(type))
-	{
-		// ±æµåÀüÀ» ÇÒ ¼ö ÀÖ´Â Á¶°ÇÀ» ¸¸Á·ÇÏÁö¾Ê´Â´Ù.
-		if (g->GetLadderPoint() == 0)
-		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<±æµå> ·¹´õ Á¡¼ö°¡ ¸ðÀÚ¶ó¼­ ±æµåÀüÀ» ÇÒ ¼ö ¾ø½À´Ï´Ù."));
-			sys_log(0, "GuildWar.StartError.NEED_LADDER_POINT");
-		}
-		else if (g->GetMemberCount() < GUILD_WAR_MIN_MEMBER_COUNT)
-		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<±æµå> ±æµåÀüÀ» ÇÏ±â À§ÇØ¼± ÃÖ¼ÒÇÑ %d¸íÀÌ ÀÖ¾î¾ß ÇÕ´Ï´Ù.", GUILD_WAR_MIN_MEMBER_COUNT));
-			sys_log(0, "GuildWar.StartError.NEED_MINIMUM_MEMBER[%d]", GUILD_WAR_MIN_MEMBER_COUNT);
-		}
-		else
-		{
-			sys_log(0, "GuildWar.StartError.UNKNOWN_ERROR");
-		}
-		return;
-	}
-
-	// ÇÊµåÀü Ã¼Å©¸¸ ÇÏ°í ¼¼¼¼ÇÑ Ã¼Å©´Â »ó´ë¹æÀÌ ½Â³«ÇÒ¶§ ÇÑ´Ù.
-	if (!opp_g->CanStartWar(GUILD_WAR_TYPE_FIELD))
-	{
-		if (opp_g->GetLadderPoint() == 0)
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<±æµå> »ó´ë¹æ ±æµåÀÇ ·¹´õ Á¡¼ö°¡ ¸ðÀÚ¶ó¼­ ±æµåÀüÀ» ÇÒ ¼ö ¾ø½À´Ï´Ù."));
-		else if (opp_g->GetMemberCount() < GUILD_WAR_MIN_MEMBER_COUNT)
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<±æµå> »ó´ë¹æ ±æµåÀÇ ±æµå¿ø ¼ö°¡ ºÎÁ·ÇÏ¿© ±æµåÀüÀ» ÇÒ ¼ö ¾ø½À´Ï´Ù."));
-		return;
-	}
-
-	do
-	{
-		if (g->GetMasterCharacter() != NULL)
-			break;
-
-		CCI* pCCI = P2P_MANAGER::instance().FindByPID(g->GetMasterPID());
-
-		if (pCCI != NULL)
-			break;
-
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<±æµå> »ó´ë¹æ ±æµåÀÇ ±æµåÀåÀÌ Á¢¼ÓÁßÀÌ ¾Æ´Õ´Ï´Ù."));
-		g->RequestRefuseWar(opp_g->GetID());
-		return;
-
-	} while (false);
-
-	do
-	{
-		if (opp_g->GetMasterCharacter() != NULL)
-			break;
-
-		CCI* pCCI = P2P_MANAGER::instance().FindByPID(opp_g->GetMasterPID());
-
-		if (pCCI != NULL)
-			break;
-
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<±æµå> »ó´ë¹æ ±æµåÀÇ ±æµåÀåÀÌ Á¢¼ÓÁßÀÌ ¾Æ´Õ´Ï´Ù."));
-		g->RequestRefuseWar(opp_g->GetID());
-		return;
-
-	} while (false);
-
-	g->RequestDeclareWar(opp_g->GetID(), type);
-}
-
-ACMD(do_nowar)
-{
-	CGuild* g = ch->GetGuild();
-	if (!g)
-		return;
-
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	if (!*arg1)
-		return;
-
-	DWORD gm_pid = g->GetMasterPID();
-
-	if (gm_pid != ch->GetPlayerID())
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<±æµå> ±æµåÀü¿¡ ´ëÇÑ ±ÇÇÑÀÌ ¾ø½À´Ï´Ù."));
-		return;
-	}
-
-	CGuild* opp_g = CGuildManager::instance().FindGuildByName(arg1);
-
-	if (!opp_g)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("<±æµå> ±×·± ±æµå°¡ ¾ø½À´Ï´Ù."));
-		return;
-	}
-
-	g->RequestRefuseWar(opp_g->GetID());
-}
-
-ACMD(do_detaillog)
-{
-	ch->DetailLog();
-}
-
-ACMD(do_monsterlog)
-{
-	ch->ToggleMonsterLog();
-}
-
-ACMD(do_pkmode)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	if (!*arg1)
-		return;
-
-	BYTE mode = 0;
-	str_to_number(mode, arg1);
-
-	if (mode == PK_MODE_PROTECT)
-		return;
-
-	if (ch->GetLevel() < PK_PROTECT_LEVEL && mode != 0)
-		return;
-
-	ch->SetPKMode(mode);
-}
-
-ACMD(do_messenger_auth)
-{
-	if (ch->GetArena())
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("´ë·ÃÀå¿¡¼­ »ç¿ëÇÏ½Ç ¼ö ¾ø½À´Ï´Ù."));
-		return;
-	}
-
-	char arg1[256], arg2[256];
-	two_arguments(argument, arg1, sizeof(arg1), arg2, sizeof(arg2));
-
-	if (!*arg1 || !*arg2)
-		return;
-
-	char answer = LOWER(*arg1);
-
-	if (answer != 'y')
-	{
-		LPCHARACTER tch = CHARACTER_MANAGER::instance().FindPC(arg2);
-
-		if (tch)
-			tch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s ´ÔÀ¸·Î ºÎÅÍ Ä£±¸ µî·ÏÀ» °ÅºÎ ´çÇß½À´Ï´Ù.", ch->GetName()));
-	}
-
-	CMessengerManager::instance().AuthToAdd(ch->GetName(), arg2, answer == 'y' ? false : true); // DENY
-}
-
-ACMD(do_setblockmode)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	if (*arg1)
-	{
-		BYTE flag = 0;
-		str_to_number(flag, arg1);
-		ch->SetBlockMode(flag);
-	}
-}
-
-ACMD(do_unmount)
-{
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-	if (const LPITEM pCostumeMount = ch->GetWear(WEAR_COSTUME_MOUNT))
-		if (ch->UnequipItem(pCostumeMount) == false)
-			return;
-#endif
-	ch->UnMount(true);
-}
-
-ACMD(do_observer_exit)
-{
-	if (ch->IsObserverMode())
-	{
-		if (ch->GetWarMap())
-			ch->SetWarMap(NULL);
-
-		if (ch->GetArena() != NULL || ch->GetArenaObserverMode() == true)
-		{
-			ch->SetArenaObserverMode(false);
-
-			if (ch->GetArena() != NULL)
-				ch->GetArena()->RemoveObserver(ch->GetPlayerID());
-
-			ch->SetArena(NULL);
-			ch->WarpSet(ARENA_RETURN_POINT_X(ch->GetEmpire()), ARENA_RETURN_POINT_Y(ch->GetEmpire()));
-		}
-		else
-		{
-			ch->ExitToSavedLocation();
-		}
-		ch->SetObserverMode(false);
-	}
-#ifdef ENABLE_QUEEN_NETHIS
-	if (ch->IsSnakeMap())
-	{
-		switch (subcmd)
-		{
-			case SCMD_RESTART_TOWN:
-				sys_log(0, "do_restart: restart town");
-				PIXEL_POSITION pos;
-
-				ch->RestartAtSamePos();
-
-				ch->PointChange(POINT_HP, ch->GetMaxHP() - ch->GetHP());
-				ch->PointChange(POINT_SP, ch->GetMaxSP() - ch->GetSP());
-				ch->ReviveInvisible(3);
-				break;
-
-			case SCMD_RESTART_HERE:
-				sys_log(0, "do_restart: restart here");
-				ch->RestartAtSamePos();
-				ch->PointChange(POINT_HP, ch->GetMaxHP() - ch->GetHP());
-				ch->PointChange(POINT_SP, ch->GetMaxSP() - ch->GetSP());
-				ch->ReviveInvisible(3);
-				break;
-		}
-
-		return;
-	}
-#endif
-}
-
-ACMD(do_party_request)
-{
-	if (ch->GetArena())
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("´ë·ÃÀå¿¡¼­ »ç¿ëÇÏ½Ç ¼ö ¾ø½À´Ï´Ù."));
-		return;
-	}
-
-	if (ch->GetParty())
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ÀÌ¹Ì ÆÄÆ¼¿¡ ¼ÓÇØ ÀÖÀ¸¹Ç·Î °¡ÀÔ½ÅÃ»À» ÇÒ ¼ö ¾ø½À´Ï´Ù."));
-		return;
-	}
-
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	if (!*arg1)
-		return;
-
-	DWORD vid = 0;
-	str_to_number(vid, arg1);
-	LPCHARACTER tch = CHARACTER_MANAGER::instance().Find(vid);
-
-	if (tch)
-		if (!ch->RequestToParty(tch))
-			ch->ChatPacket(CHAT_TYPE_COMMAND, "PartyRequestDenied");
-}
-
-ACMD(do_party_request_accept)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	if (!*arg1)
-		return;
-
-	DWORD vid = 0;
-	str_to_number(vid, arg1);
-	LPCHARACTER tch = CHARACTER_MANAGER::instance().Find(vid);
-
-	if (tch)
-		ch->AcceptToParty(tch);
-}
-
-ACMD(do_party_request_deny)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	if (!*arg1)
-		return;
-
-	DWORD vid = 0;
-	str_to_number(vid, arg1);
-	LPCHARACTER tch = CHARACTER_MANAGER::instance().Find(vid);
-
-	if (tch)
-		ch->DenyToParty(tch);
-}
-
-ACMD(do_monarch_warpto)
-{
-	if (true == LC_IsYMIR() || true == LC_IsKorea())
-		return;
-
-	if (!CMonarch::instance().IsMonarch(ch->GetPlayerID(), ch->GetEmpire()))
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("±ºÁÖ¸¸ÀÌ »ç¿ë °¡´ÉÇÑ ±â´ÉÀÔ´Ï´Ù"));
-		return;
-	}
-
-	//±ºÁÖ ÄðÅ¸ÀÓ °Ë»ç
-	if (!ch->IsMCOK(CHARACTER::MI_WARP))
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%d ÃÊ°£ ÄðÅ¸ÀÓÀÌ Àû¿ëÁßÀÔ´Ï´Ù.", ch->GetMCLTime(CHARACTER::MI_WARP)));
-		return;
-	}
-
-	//±ºÁÖ ¸÷ ¼ÒÈ¯ ºñ¿ë 
-	const int WarpPrice = 10000;
-
-	//±ºÁÖ ±¹°í °Ë»ç 
-	if (!CMonarch::instance().IsMoneyOk(WarpPrice, ch->GetEmpire()))
-	{
-		int NationMoney = CMonarch::instance().GetMoney(ch->GetEmpire());
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("±¹°í¿¡ µ·ÀÌ ºÎÁ·ÇÕ´Ï´Ù. ÇöÀç : %u ÇÊ¿ä±Ý¾× : %u", NationMoney, WarpPrice));
-		return;
-	}
-
-	int x = 0, y = 0;
-	char arg1[256];
-
-	one_argument(argument, arg1, sizeof(arg1));
-
-	if (!*arg1)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("»ç¿ë¹ý: warpto <character name>"));
-		return;
-	}
-
-	LPCHARACTER tch = CHARACTER_MANAGER::instance().FindPC(arg1);
-
-	if (!tch)
-	{
-		CCI* pkCCI = P2P_MANAGER::instance().Find(arg1);
-
-		if (pkCCI)
-		{
-			if (pkCCI->bEmpire != ch->GetEmpire())
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Å¸Á¦±¹ À¯Àú¿¡°Ô´Â ÀÌµ¿ÇÒ¼ö ¾ø½À´Ï´Ù"));
-				return;
-			}
-
-			if (pkCCI->bChannel != g_bChannel)
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ÇØ´ç À¯Àú´Â %d Ã¤³Î¿¡ ÀÖ½À´Ï´Ù. (ÇöÀç Ã¤³Î %d)", pkCCI->bChannel, g_bChannel));
-				return;
-			}
-			if (!IsMonarchWarpZone(pkCCI->lMapIndex))
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ÇØ´ç Áö¿ªÀ¸·Î ÀÌµ¿ÇÒ ¼ö ¾ø½À´Ï´Ù."));
-				return;
-			}
-
-			PIXEL_POSITION pos;
-
-			if (!SECTREE_MANAGER::instance().GetCenterPositionOfMap(pkCCI->lMapIndex, pos))
-				ch->ChatPacket(CHAT_TYPE_INFO, "Cannot find map (index %d)", pkCCI->lMapIndex);
-			else
-			{
-				//ch->ChatPacket(CHAT_TYPE_INFO, "You warp to (%d, %d)", pos.x, pos.y);
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s ¿¡°Ô·Î ÀÌµ¿ÇÕ´Ï´Ù", arg1));
-				ch->WarpSet(pos.x, pos.y);
-
-				//±ºÁÖ µ· »è°¨
-				CMonarch::instance().SendtoDBDecMoney(WarpPrice, ch->GetEmpire(), ch);
-
-				//ÄðÅ¸ÀÓ ÃÊ±âÈ­
-				ch->SetMC(CHARACTER::MI_WARP);
-			}
-		}
-		else if (NULL == CHARACTER_MANAGER::instance().FindPC(arg1))
-		{
-			ch->ChatPacket(CHAT_TYPE_INFO, "There is no one by that name");
-		}
-
-		return;
-	}
-	else
-	{
-		if (tch->GetEmpire() != ch->GetEmpire())
-		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Å¸Á¦±¹ À¯Àú¿¡°Ô´Â ÀÌµ¿ÇÒ¼ö ¾ø½À´Ï´Ù"));
-			return;
-		}
-		if (!IsMonarchWarpZone(tch->GetMapIndex()))
-		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ÇØ´ç Áö¿ªÀ¸·Î ÀÌµ¿ÇÒ ¼ö ¾ø½À´Ï´Ù."));
-			return;
-		}
-		x = tch->GetX();
-		y = tch->GetY();
-	}
-
-	ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s ¿¡°Ô·Î ÀÌµ¿ÇÕ´Ï´Ù", arg1));
-	ch->WarpSet(x, y);
-	ch->Stop();
-
-	//±ºÁÖ µ· »è°¨
-	CMonarch::instance().SendtoDBDecMoney(WarpPrice, ch->GetEmpire(), ch);
-
-	//ÄðÅ¸ÀÓ ÃÊ±âÈ­
-	ch->SetMC(CHARACTER::MI_WARP);
-}
-
-ACMD(do_monarch_transfer)
-{
-	if (true == LC_IsYMIR() || true == LC_IsKorea())
-		return;
-
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	if (!*arg1)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("»ç¿ë¹ý: transfer <name>"));
-		return;
-	}
-
-	if (!CMonarch::instance().IsMonarch(ch->GetPlayerID(), ch->GetEmpire()))
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("±ºÁÖ¸¸ÀÌ »ç¿ë °¡´ÉÇÑ ±â´ÉÀÔ´Ï´Ù"));
-		return;
-	}
-
-	//±ºÁÖ ÄðÅ¸ÀÓ °Ë»ç
-	if (!ch->IsMCOK(CHARACTER::MI_TRANSFER))
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%d ÃÊ°£ ÄðÅ¸ÀÓÀÌ Àû¿ëÁßÀÔ´Ï´Ù.", ch->GetMCLTime(CHARACTER::MI_TRANSFER)));
-		return;
-	}
-
-	//±ºÁÖ ¿öÇÁ ºñ¿ë 
-	const int WarpPrice = 10000;
-
-	//±ºÁÖ ±¹°í °Ë»ç 
-	if (!CMonarch::instance().IsMoneyOk(WarpPrice, ch->GetEmpire()))
-	{
-		int NationMoney = CMonarch::instance().GetMoney(ch->GetEmpire());
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("±¹°í¿¡ µ·ÀÌ ºÎÁ·ÇÕ´Ï´Ù. ÇöÀç : %u ÇÊ¿ä±Ý¾× : %u", NationMoney, WarpPrice));
-		return;
-	}
-
-	LPCHARACTER tch = CHARACTER_MANAGER::instance().FindPC(arg1);
-
-	if (!tch)
-	{
-		CCI* pkCCI = P2P_MANAGER::instance().Find(arg1);
-
-		if (pkCCI)
-		{
-			if (pkCCI->bEmpire != ch->GetEmpire())
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("´Ù¸¥ Á¦±¹ À¯Àú´Â ¼ÒÈ¯ÇÒ ¼ö ¾ø½À´Ï´Ù."));
-				return;
-			}
-			if (pkCCI->bChannel != g_bChannel)
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s ´ÔÀº %d Ã¤³Î¿¡ Á¢¼Ó Áß ÀÔ´Ï´Ù. (ÇöÀç Ã¤³Î: %d)", arg1, pkCCI->bChannel, g_bChannel));
-				return;
-			}
-			if (!IsMonarchWarpZone(pkCCI->lMapIndex))
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ÇØ´ç Áö¿ªÀ¸·Î ÀÌµ¿ÇÒ ¼ö ¾ø½À´Ï´Ù."));
-				return;
-			}
-			if (!IsMonarchWarpZone(ch->GetMapIndex()))
-			{
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ÇØ´ç Áö¿ªÀ¸·Î ¼ÒÈ¯ÇÒ ¼ö ¾ø½À´Ï´Ù."));
-				return;
-			}
-
-			TPacketGGTransfer pgg;
-
-			pgg.bHeader = HEADER_GG_TRANSFER;
-			strlcpy(pgg.szName, arg1, sizeof(pgg.szName));
-			pgg.lX = ch->GetX();
-			pgg.lY = ch->GetY();
-
-			P2P_MANAGER::instance().Send(&pgg, sizeof(TPacketGGTransfer));
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s ´ÔÀ» ¼ÒÈ¯ÇÏ¿´½À´Ï´Ù.", arg1));
-
-			//±ºÁÖ µ· »è°¨
-			CMonarch::instance().SendtoDBDecMoney(WarpPrice, ch->GetEmpire(), ch);
-			//ÄðÅ¸ÀÓ ÃÊ±âÈ­
-			ch->SetMC(CHARACTER::MI_TRANSFER);
-		}
-		else
-		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ÀÔ·ÂÇÏ½Å ÀÌ¸§À» °¡Áø »ç¿ëÀÚ°¡ ¾ø½À´Ï´Ù."));
-		}
-
-		return;
-	}
-
-	if (ch == tch)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ÀÚ½ÅÀ» ¼ÒÈ¯ÇÒ ¼ö ¾ø½À´Ï´Ù."));
-		return;
-	}
-
-	if (tch->GetEmpire() != ch->GetEmpire())
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("´Ù¸¥ Á¦±¹ À¯Àú´Â ¼ÒÈ¯ÇÒ ¼ö ¾ø½À´Ï´Ù."));
-		return;
-	}
-	if (!IsMonarchWarpZone(tch->GetMapIndex()))
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ÇØ´ç Áö¿ªÀ¸·Î ÀÌµ¿ÇÒ ¼ö ¾ø½À´Ï´Ù."));
-		return;
-	}
-	if (!IsMonarchWarpZone(ch->GetMapIndex()))
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ÇØ´ç Áö¿ªÀ¸·Î ¼ÒÈ¯ÇÒ ¼ö ¾ø½À´Ï´Ù."));
-		return;
-	}
-
-	//tch->Show(ch->GetMapIndex(), ch->GetX(), ch->GetY(), ch->GetZ());
-	tch->WarpSet(ch->GetX(), ch->GetY(), ch->GetMapIndex());
-
-	//±ºÁÖ µ· »è°¨
-	CMonarch::instance().SendtoDBDecMoney(WarpPrice, ch->GetEmpire(), ch);
-	//ÄðÅ¸ÀÓ ÃÊ±âÈ­
-	ch->SetMC(CHARACTER::MI_TRANSFER);
-}
-
-ACMD(do_monarch_info)
-{
-	if (CMonarch::instance().IsMonarch(ch->GetPlayerID(), ch->GetEmpire()))
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("³ªÀÇ ±ºÁÖ Á¤º¸"));
-		TMonarchInfo* p = CMonarch::instance().GetMonarch();
-		for (int n = 1; n < 4; ++n)
-		{
-			if (n == ch->GetEmpire())
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("[%s±ºÁÖ] : %s  º¸À¯±Ý¾× %lld ", EMPIRE_NAME(n), p->name[n], p->money[n]));
-			else
-				ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("[%s±ºÁÖ] : %s  ", EMPIRE_NAME(n), p->name[n]));
-
-		}
-	}
-	else
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("±ºÁÖ Á¤º¸"));
-		TMonarchInfo* p = CMonarch::instance().GetMonarch();
-		for (int n = 1; n < 4; ++n)
-		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("[%s±ºÁÖ] : %s  ", EMPIRE_NAME(n), p->name[n]));
-
-		}
-	}
-
-}
-
-ACMD(do_elect)
-{
-	db_clientdesc->DBPacketHeader(HEADER_GD_COME_TO_VOTE, ch->GetDesc()->GetHandle(), 0);
-}
-
-// LUA_ADD_GOTO_INFO
-struct GotoInfo
-{
-	std::string st_name;
-
-	BYTE empire;
-	int mapIndex;
-	DWORD x, y;
-
-	GotoInfo()
-	{
-		st_name = "";
-		empire = 0;
-		mapIndex = 0;
-
-		x = 0;
-		y = 0;
-	}
-
-	GotoInfo(const GotoInfo& c_src)
-	{
-		__copy__(c_src);
-	}
-
-	void operator = (const GotoInfo& c_src)
-	{
-		__copy__(c_src);
-	}
-
-	void __copy__(const GotoInfo& c_src)
-	{
-		st_name = c_src.st_name;
-		empire = c_src.empire;
-		mapIndex = c_src.mapIndex;
-
-		x = c_src.x;
-		y = c_src.y;
-	}
-};
-
-extern void BroadcastNotice(const char* c_pszBuf, const bool c_bBigFont);
-
-ACMD(do_monarch_tax)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	if (!*arg1)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, "Usage: monarch_tax <1-50>");
-		return;
-	}
-
-	// ±ºÁÖ °Ë»ç
-	if (!ch->IsMonarch())
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("±ºÁÖ¸¸ÀÌ »ç¿ëÇÒ¼ö ÀÖ´Â ±â´ÉÀÔ´Ï´Ù"));
-		return;
-	}
-
-	// ¼¼±Ý¼³Á¤ 
-	int tax = 0;
-	str_to_number(tax, arg1);
-
-	if (tax < 1 || tax > 50)
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("1-50 »çÀÌÀÇ ¼öÄ¡¸¦ ¼±ÅÃÇØÁÖ¼¼¿ä"));
-
-	quest::CQuestManager::instance().SetEventFlag("trade_tax", tax);
-
-	// ±ºÁÖ¿¡°Ô ¸Þ¼¼Áö ÇÏ³ª
-	ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("¼¼±ÝÀÌ %d %·Î ¼³Á¤µÇ¾ú½À´Ï´Ù"));
-
-	// °øÁö 
-	char szMsg[1024];
-
-	snprintf(szMsg, sizeof(szMsg), "±ºÁÖÀÇ ¸íÀ¸·Î ¼¼±ÝÀÌ %d %% ·Î º¯°æµÇ¾ú½À´Ï´Ù", tax);
-	BroadcastNotice(szMsg);
-
-	snprintf(szMsg, sizeof(szMsg), "¾ÕÀ¸·Î´Â °Å·¡ ±Ý¾×ÀÇ %d %% °¡ ±¹°í·Î µé¾î°¡°ÔµË´Ï´Ù.", tax);
-	BroadcastNotice(szMsg);
-
-	// ÄðÅ¸ÀÓ ÃÊ±âÈ­ 
-	ch->SetMC(CHARACTER::MI_TAX);
-}
-
-static const DWORD cs_dwMonarchMobVnums[] =
-{
-	191, // »ê°ß½Å
-	192, // Àú½Å
-	193, // ¿õ½Å
-	194, // È£½Å
-	391, // ¹ÌÁ¤
-	392, // ÀºÁ¤
-	393, // ¼¼¶û
-	394, // ÁøÈñ
-	491, // ¸ÍÈ¯
-	492, // º¸¿ì
-	493, // ±¸ÆÐ
-	494, // ÃßÈç
-	591, // ºñ·ù´Ü´ëÀå
-	691, // ¿õ±Í Á·Àå
-	791, // ¹Ð±³±³ÁÖ
-	1304, // ´©··¹ü±Í
-	1901, // ±¸¹ÌÈ£
-	2091, // ¿©¿Õ°Å¹Ì
-	2191, // °Å´ë»ç¸·°ÅºÏ
-	2206, // È­¿°¿Õi
-	0,
-};
-
-ACMD(do_monarch_mob)
-{
-	char arg1[256];
-	LPCHARACTER tch;
-
-	one_argument(argument, arg1, sizeof(arg1));
-
-	if (!ch->IsMonarch())
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("±ºÁÖ¸¸ÀÌ »ç¿ëÇÒ¼ö ÀÖ´Â ±â´ÉÀÔ´Ï´Ù"));
-		return;
-	}
-
-	if (!*arg1)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, "Usage: mmob <mob name>");
-		return;
-	}
-
-	BYTE pcEmpire = ch->GetEmpire();
-	BYTE mapEmpire = SECTREE_MANAGER::instance().GetEmpireFromMapIndex(ch->GetMapIndex());
-
-	if (LC_IsYMIR() == true || LC_IsKorea() == true)
-	{
-		if (mapEmpire != pcEmpire && mapEmpire != 0)
-		{
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ÀÚ±¹ ¿µÅä¿¡¼­¸¸ »ç¿ëÇÒ ¼ö ÀÖ´Â ±â´ÉÀÔ´Ï´Ù"));
-			return;
-		}
-	}
-
-	// ±ºÁÖ ¸÷ ¼ÒÈ¯ ºñ¿ë 
-	const int SummonPrice = 5000000;
-
-	// ±ºÁÖ ÄðÅ¸ÀÓ °Ë»ç
-	if (!ch->IsMCOK(CHARACTER::MI_SUMMON))
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%d ÃÊ°£ ÄðÅ¸ÀÓÀÌ Àû¿ëÁßÀÔ´Ï´Ù.", ch->GetMCLTime(CHARACTER::MI_SUMMON)));
-		return;
-	}
-
-	// ±ºÁÖ ±¹°í °Ë»ç 
-	if (!CMonarch::instance().IsMoneyOk(SummonPrice, ch->GetEmpire()))
-	{
-		int NationMoney = CMonarch::instance().GetMoney(ch->GetEmpire());
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("±¹°í¿¡ µ·ÀÌ ºÎÁ·ÇÕ´Ï´Ù. ÇöÀç : %u ÇÊ¿ä±Ý¾× : %u", NationMoney, SummonPrice));
-		return;
-	}
-
-	const CMob* pkMob = nullptr;
-	DWORD vnum = 0;
-
-	if (isdigit(*arg1))
-	{
-		str_to_number(vnum, arg1);
-
-		if ((pkMob = CMobManager::instance().Get(vnum)) == NULL)
-			vnum = 0;
-	}
-	else
-	{
-		pkMob = CMobManager::Instance().Get(arg1, true);
-
-		if (pkMob)
-			vnum = pkMob->m_table.dwVnum;
-	}
-
-	if (pkMob == nullptr)
-		return;
-
-	DWORD count;
-
-	// ¼ÒÈ¯ °¡´É ¸÷ °Ë»ç
-	for (count = 0; cs_dwMonarchMobVnums[count] != 0; ++count)
-		if (cs_dwMonarchMobVnums[count] == vnum)
-			break;
-
-	if (0 == cs_dwMonarchMobVnums[count])
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("¼ÒÈ¯ÇÒ¼ö ¾ø´Â ¸ó½ºÅÍ ÀÔ´Ï´Ù. ¼ÒÈ¯°¡´ÉÇÑ ¸ó½ºÅÍ´Â È¨ÆäÀÌÁö¸¦ ÂüÁ¶ÇÏ¼¼¿ä"));
-		return;
-	}
-
-	tch = CHARACTER_MANAGER::instance().SpawnMobRange(vnum,
-		ch->GetMapIndex(),
-		ch->GetX() - number(200, 750),
-		ch->GetY() - number(200, 750),
-		ch->GetX() + number(200, 750),
-		ch->GetY() + number(200, 750),
-		true,
-		pkMob->m_table.bType == CHAR_TYPE_STONE,
-		true);
-
-	if (tch)
-	{
-		// ±ºÁÖ µ· »è°¨
-		CMonarch::instance().SendtoDBDecMoney(SummonPrice, ch->GetEmpire(), ch);
-
-		// ÄðÅ¸ÀÓ ÃÊ±âÈ­
-		ch->SetMC(CHARACTER::MI_SUMMON);
-	}
-}
-
-static const char* FN_point_string(DWORD dwApplyType)
-{
-	switch (dwApplyType)
-	{
-		case POINT_MAX_HP: return LC_STRING("ÃÖ´ë »ý¸í·Â +%d");
-		case POINT_MAX_SP: return LC_STRING("ÃÖ´ë Á¤½Å·Â +%d");
-		case POINT_HT: return LC_STRING("Ã¼·Â +%d");
-		case POINT_IQ: return LC_STRING("Áö´É +%d");
-		case POINT_ST: return LC_STRING("±Ù·Â +%d");
-		case POINT_DX: return LC_STRING("¹ÎÃ¸ +%d");
-		case POINT_ATT_SPEED: return LC_STRING("°ø°Ý¼Óµµ +%d");
-		case POINT_MOV_SPEED: return LC_STRING("ÀÌµ¿¼Óµµ %d");
-		case POINT_CASTING_SPEED: return LC_STRING("ÄðÅ¸ÀÓ -%d");
-		case POINT_HP_REGEN: return LC_STRING("»ý¸í·Â È¸º¹ +%d");
-		case POINT_SP_REGEN: return LC_STRING("Á¤½Å·Â È¸º¹ +%d");
-		case POINT_POISON_PCT: return LC_STRING("µ¶°ø°Ý %d");
-		case POINT_BLEEDING_PCT: return LC_STRING("µ¶°ø°Ý %d");
-		case POINT_STUN_PCT: return LC_STRING("½ºÅÏ +%d");
-		case POINT_SLOW_PCT: return LC_STRING("½½·Î¿ì +%d");
-		case POINT_CRITICAL_PCT: return LC_STRING("%d%% È®·ü·Î Ä¡¸íÅ¸ °ø°Ý");
-		case POINT_RESIST_CRITICAL: return LC_STRING("»ó´ëÀÇ Ä¡¸íÅ¸ È®·ü %d%% °¨¼Ò");
-		case POINT_PENETRATE_PCT: return LC_STRING("%d%% È®·ü·Î °üÅë °ø°Ý");
-		case POINT_RESIST_PENETRATE: return LC_STRING("»ó´ëÀÇ °üÅë °ø°Ý È®·ü %d%% °¨¼Ò");
-		case POINT_ATTBONUS_HUMAN: return LC_STRING("ÀÎ°£·ù ¸ó½ºÅÍ Å¸°ÝÄ¡ +%d%%");
-		case POINT_ATTBONUS_ANIMAL: return LC_STRING("µ¿¹°·ù ¸ó½ºÅÍ Å¸°ÝÄ¡ +%d%%");
-		case POINT_ATTBONUS_ORC: return LC_STRING("¿õ±ÍÁ· Å¸°ÝÄ¡ +%d%%");
-		case POINT_ATTBONUS_MILGYO: return LC_STRING("¹Ð±³·ù Å¸°ÝÄ¡ +%d%%");
-		case POINT_ATTBONUS_UNDEAD: return LC_STRING("½ÃÃ¼·ù Å¸°ÝÄ¡ +%d%%");
-		case POINT_ATTBONUS_DEVIL: return LC_STRING("¾Ç¸¶·ù Å¸°ÝÄ¡ +%d%%");
-		case POINT_STEAL_HP: return LC_STRING("Å¸°ÝÄ¡ %d%% ¸¦ »ý¸í·ÂÀ¸·Î Èí¼ö");
-		case POINT_STEAL_SP: return LC_STRING("Å¸·ÂÄ¡ %d%% ¸¦ Á¤½Å·ÂÀ¸·Î Èí¼ö");
-		case POINT_MANA_BURN_PCT: return LC_STRING("%d%% È®·ü·Î Å¸°Ý½Ã »ó´ë Àü½Å·Â ¼Ò¸ð");
-		case POINT_DAMAGE_SP_RECOVER: return LC_STRING("%d%% È®·ü·Î ÇÇÇØ½Ã Á¤½Å·Â È¸º¹");
-		case POINT_BLOCK: return LC_STRING("¹°¸®Å¸°Ý½Ã ºí·° È®·ü %d%%");
-		case POINT_DODGE: return LC_STRING("È° °ø°Ý È¸ÇÇ È®·ü %d%%");
-		case POINT_RESIST_SWORD: return LC_STRING("ÇÑ¼Õ°Ë ¹æ¾î %d%%");
-		case POINT_RESIST_TWOHAND: return LC_STRING("¾ç¼Õ°Ë ¹æ¾î %d%%");
-		case POINT_RESIST_DAGGER: return LC_STRING("µÎ¼Õ°Ë ¹æ¾î %d%%");
-		case POINT_RESIST_BELL: return LC_STRING("¹æ¿ï ¹æ¾î %d%%");
-		case POINT_RESIST_FAN: return LC_STRING("ºÎÃ¤ ¹æ¾î %d%%");
-		case POINT_RESIST_BOW: return LC_STRING("È°°ø°Ý ÀúÇ× %d%%");
-		case POINT_RESIST_CLAW: return LC_STRING("µÎ¼Õ°Ë ¹æ¾î %d%%");
-		case POINT_RESIST_FIRE: return LC_STRING("È­¿° ÀúÇ× %d%%");
-		case POINT_RESIST_ELEC: return LC_STRING("Àü±â ÀúÇ× %d%%");
-		case POINT_RESIST_MAGIC: return LC_STRING("¸¶¹ý ÀúÇ× %d%%");
-#if defined(__MAGIC_REDUCTION__)
-		case POINT_RESIST_MAGIC_REDUCTION:	return LC_STRING("¸¶¹ý ÀúÇ× %d%%");
-#endif
-		case POINT_RESIST_WIND: return LC_STRING("¹Ù¶÷ ÀúÇ× %d%%");
-		case POINT_RESIST_ICE: return LC_STRING("³Ã±â ÀúÇ× %d%%");
-		case POINT_RESIST_EARTH: return LC_STRING("´ëÁö ÀúÇ× %d%%");
-		case POINT_RESIST_DARK: return LC_STRING("¾îµÒ ÀúÇ× %d%%");
-		case POINT_REFLECT_MELEE: return LC_STRING("Á÷Á¢ Å¸°ÝÄ¡ ¹Ý»ç È®·ü : %d%%");
-		case POINT_REFLECT_CURSE: return LC_STRING("ÀúÁÖ µÇµ¹¸®±â È®·ü %d%%");
-		case POINT_POISON_REDUCE: return LC_STRING("µ¶ ÀúÇ× %d%%");
-		case POINT_BLEEDING_REDUCE:	return LC_STRING("µ¶ ÀúÇ× %d%%");
-		case POINT_KILL_SP_RECOVER: return LC_STRING("%d%% È®·ü·Î ÀûÅðÄ¡½Ã Á¤½Å·Â È¸º¹");
-		case POINT_EXP_DOUBLE_BONUS: return LC_STRING("%d%% È®·ü·Î ÀûÅðÄ¡½Ã °æÇèÄ¡ Ãß°¡ »ó½Â");
-		case POINT_GOLD_DOUBLE_BONUS: return LC_STRING("%d%% È®·ü·Î ÀûÅðÄ¡½Ã µ· 2¹è µå·Ó");
-		case POINT_ITEM_DROP_BONUS: return LC_STRING("%d%% È®·ü·Î ÀûÅðÄ¡½Ã ¾ÆÀÌÅÛ 2¹è µå·Ó");
-		case POINT_POTION_BONUS: return LC_STRING("¹°¾à »ç¿ë½Ã %d%% ¼º´É Áõ°¡");
-		case POINT_KILL_HP_RECOVERY: return LC_STRING("%d%% È®·ü·Î ÀûÅðÄ¡½Ã »ý¸í·Â È¸º¹");
-			//case POINT_IMMUNE_STUN: return LC_STRING("±âÀýÇÏÁö ¾ÊÀ½ %d%%");
-			//case POINT_IMMUNE_SLOW: return LC_STRING("´À·ÁÁöÁö ¾ÊÀ½ %d%%");
-			//case POINT_IMMUNE_FALL: return LC_STRING("³Ñ¾îÁöÁö ¾ÊÀ½ %d%%");
-			//case POINT_SKILL: return LC_STRING("");
-			//case POINT_BOW_DISTANCE: return LC_STRING("");
-		case POINT_ATT_GRADE_BONUS: return LC_STRING("°ø°Ý·Â +%d");
-		case POINT_DEF_GRADE_BONUS: return LC_STRING("¹æ¾î·Â +%d");
-		case POINT_MAGIC_ATT_GRADE: return LC_STRING("¸¶¹ý °ø°Ý·Â +%d");
-		case POINT_MAGIC_DEF_GRADE: return LC_STRING("¸¶¹ý ¹æ¾î·Â +%d");
-			//case POINT_CURSE_PCT: return LC_STRING("");
-		case POINT_MAX_STAMINA: return LC_STRING("ÃÖ´ë Áö±¸·Â +%d");
-		case POINT_ATTBONUS_WARRIOR: return LC_STRING("¹«»ç¿¡°Ô °­ÇÔ +%d%%");
-		case POINT_ATTBONUS_ASSASSIN: return LC_STRING("ÀÚ°´¿¡°Ô °­ÇÔ +%d%%");
-		case POINT_ATTBONUS_SURA: return LC_STRING("¼ö¶ó¿¡°Ô °­ÇÔ +%d%%");
-		case POINT_ATTBONUS_SHAMAN: return LC_STRING("¹«´ç¿¡°Ô °­ÇÔ +%d%%");
-		case POINT_ATTBONUS_WOLFMAN: return LC_STRING("¹«´ç¿¡°Ô °­ÇÔ +%d%%");
-		case POINT_ATTBONUS_MONSTER: return LC_STRING("¸ó½ºÅÍ¿¡°Ô °­ÇÔ +%d%%");
-		case POINT_MALL_ATTBONUS: return LC_STRING("°ø°Ý·Â +%d%%");
-		case POINT_MALL_DEFBONUS: return LC_STRING("¹æ¾î·Â +%d%%");
-		case POINT_MALL_EXPBONUS: return LC_STRING("°æÇèÄ¡ %d%%");
-		case POINT_MALL_ITEMBONUS: return LC_STRING("¾ÆÀÌÅÛ µå·ÓÀ² %.1f¹è");
-		case POINT_MALL_GOLDBONUS: return LC_STRING("µ· µå·ÓÀ² %.1f¹è");
-		case POINT_MAX_HP_PCT: return LC_STRING("ÃÖ´ë »ý¸í·Â +%d%%");
-		case POINT_MAX_SP_PCT: return LC_STRING("ÃÖ´ë Á¤½Å·Â +%d%%");
-		case POINT_SKILL_DAMAGE_BONUS: return LC_STRING("½ºÅ³ µ¥¹ÌÁö %d%%");
-		case POINT_NORMAL_HIT_DAMAGE_BONUS: return LC_STRING("ÆòÅ¸ µ¥¹ÌÁö %d%%");
-		case POINT_SKILL_DEFEND_BONUS: return LC_STRING("½ºÅ³ µ¥¹ÌÁö ÀúÇ× %d%%");
-		case POINT_NORMAL_HIT_DEFEND_BONUS: return LC_STRING("ÆòÅ¸ µ¥¹ÌÁö ÀúÇ× %d%%");
-			//case POINT_PC_BANG_EXP_BONUS: return LC_STRING("");
-			//case POINT_PC_BANG_DROP_BONUS: return LC_STRING("");
-			//case POINT_EXTRACT_HP_PCT: return LC_STRING("");
-		case POINT_RESIST_WARRIOR: return LC_STRING("¹«»ç°ø°Ý¿¡ %d%% ÀúÇ×");
-		case POINT_RESIST_ASSASSIN: return LC_STRING("ÀÚ°´°ø°Ý¿¡ %d%% ÀúÇ×");
-		case POINT_RESIST_SURA: return LC_STRING("¼ö¶ó°ø°Ý¿¡ %d%% ÀúÇ×");
-		case POINT_RESIST_SHAMAN: return LC_STRING("¹«´ç°ø°Ý¿¡ %d%% ÀúÇ×");
-		case POINT_RESIST_WOLFMAN: return LC_STRING("¹«´ç°ø°Ý¿¡ %d%% ÀúÇ×");
-#if defined(__ELEMENT_SYSTEM__)
-		case POINT_ENCHANT_ELECT: return LC_STRING("Lightning Power + %d%%");
-		case POINT_ENCHANT_FIRE: return LC_STRING("Fire Power + %d%%");
-		case POINT_ENCHANT_ICE: return LC_STRING("Ice Power + %d%%");
-		case POINT_ENCHANT_WIND: return LC_STRING("Wind Power + %d%%");
-		case POINT_ENCHANT_EARTH: return LC_STRING("Earth Power + %d%%");
-		case POINT_ENCHANT_DARK: return LC_STRING("Dark Power + %d%%");
-		case POINT_ATTBONUS_CZ: return LC_STRING("Strong against Zodiac Monsters + %d%%");
-		case POINT_ATTBONUS_INSECT: return LC_STRING("Strong against Insects + %d%%");
-		case POINT_ATTBONUS_DESERT: return LC_STRING("Strong against Desert Monsters + %d%%");
-#endif
-		case POINT_ATTBONUS_STONE: return LC_STRING("Strong against Metin Stones +%d%%");
-		default:
-			return LC_STRING("Unkown apply_number %d", dwApplyType);
-	}
-}
-
-static bool FN_hair_affect_string(LPCHARACTER ch, char* buf, size_t bufsiz)
-{
-	if (NULL == ch || NULL == buf)
-		return false;
-
-	CAffect* aff = NULL;
-	time_t expire = 0;
-	struct tm ltm;
-	int year, mon, day;
-	int offset = 0;
-
-	aff = ch->FindAffect(AFFECT_HAIR);
-
-	if (NULL == aff)
-		return false;
-
-	expire = ch->GetQuestFlag("hair.limit_time");
-
-	if (expire < get_global_time())
-		return false;
-
-	// set apply string
-	offset = snprintf(buf, bufsiz, FN_point_string(aff->wApplyOn), aff->lApplyValue);
-
-	if (offset < 0 || offset >= (int)bufsiz)
-		offset = bufsiz - 1;
-
-	localtime_r(&expire, &ltm);
-
-	year = ltm.tm_year + 1900;
-	mon = ltm.tm_mon + 1;
-	day = ltm.tm_mday;
-
-	snprintf(buf + offset, bufsiz - offset, LC_STRING(" (¸¸·áÀÏ : %d³â %d¿ù %dÀÏ)", year, mon, day));
-
-	return true;
-}
-
-ACMD(do_costume)
-{
-	char buf[1024];
-	const size_t bufferSize = sizeof(buf);
-
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	ch->ChatPacket(CHAT_TYPE_INFO, "COSTUME status:");
-
-	CItem* pBody = ch->GetWear(WEAR_COSTUME_BODY);
-	if (pBody)
-	{
-		const char* itemName = pBody->GetName();
-
-		ch->ChatPacket(CHAT_TYPE_INFO, "   BODY : %s", itemName);
-
-		if (pBody->IsEquipped() && arg1[0] == 'b')
-			ch->UnequipItem(pBody);
-	}
-
-	CItem* pHair = ch->GetWear(WEAR_COSTUME_HAIR);
-	if (pHair)
-	{
-		const char* itemName = pHair->GetName();
-
-		ch->ChatPacket(CHAT_TYPE_INFO, "   HAIR : %s", itemName);
-
-		for (int i = 0; i < pHair->GetAttributeCount(); ++i)
-		{
-			const TPlayerItemAttribute& attr = pHair->GetAttribute(i);
-			if (0 < attr.wType)
-			{
-				snprintf(buf, bufferSize, FN_point_string(attr.wType), attr.lValue);
-				ch->ChatPacket(CHAT_TYPE_INFO, "     %s", buf);
-			}
-		}
-
-		if (pHair->IsEquipped() && arg1[0] == 'h')
-			ch->UnequipItem(pHair);
-	}
-
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-	CItem* pMount = ch->GetWear(WEAR_COSTUME_MOUNT);
-	if (pMount)
-	{
-		const char* itemName = pMount->GetName();
-
-		ch->ChatPacket(CHAT_TYPE_INFO, "   MOUNT : %s", itemName);
-
-		if (pMount->IsEquipped() && arg1[0] == 'm')
-			ch->UnequipItem(pMount);
-	}
-#endif
-
-#if defined(__ACCE_COSTUME_SYSTEM__)
-	CItem* pAcce = ch->GetWear(WEAR_COSTUME_ACCE);
-	if (pAcce)
-	{
-		const char* itemName = pAcce->GetName();
-
-		ch->ChatPacket(CHAT_TYPE_INFO, "   ACCE : %s", itemName);
-
-		if (pAcce->IsEquipped() && arg1[0] == 'a')
-			ch->UnequipItem(pAcce);
-	}
-#endif
-
-#if defined(__WEAPON_COSTUME_SYSTEM__)
-	CItem* pWeapon = ch->GetWear(WEAR_COSTUME_WEAPON);
-	if (pWeapon)
-	{
-		const char* itemName = pWeapon->GetName();
-		ch->ChatPacket(CHAT_TYPE_INFO, "   WEAPON : %s", itemName);
-		if (pWeapon->IsEquipped() && arg1[0] == 'w')
-			ch->UnequipItem(pWeapon);
-	}
-#endif
-
-#if defined(__AURA_COSTUME_SYSTEM__)
-	CItem* pAura = ch->GetWear(WEAR_COSTUME_AURA);
-	if (pAura)
-	{
-		const char* itemName = pAura->GetName();
-		ch->ChatPacket(CHAT_TYPE_INFO, "  AURA : %s", itemName);
-		if (pAura->IsEquipped() && arg1[0] == 'a')
-			ch->UnequipItem(pAura);
-	}
-#endif
-}
-
-ACMD(do_hair)
-{
-	char buf[256];
-
-	if (false == FN_hair_affect_string(ch, buf, sizeof(buf)))
-		return;
-
-	ch->ChatPacket(CHAT_TYPE_INFO, buf);
-}
-
-ACMD(do_inventory)
-{
-	int index = 0;
-	int count = 1;
-
-	char arg1[256];
-	char arg2[256];
-
-	LPITEM item;
-
-	two_arguments(argument, arg1, sizeof(arg1), arg2, sizeof(arg2));
-
-	if (!*arg1)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, "Usage: inventory <start_index> <count>");
-		return;
-	}
-
-	if (!*arg2)
-	{
-		index = 0;
-		str_to_number(count, arg1);
-	}
-	else
-	{
-		str_to_number(index, arg1); index = MIN(index, INVENTORY_MAX_NUM);
-		str_to_number(count, arg2); count = MIN(count, INVENTORY_MAX_NUM);
-	}
-
-	for (int i = 0; i < count; ++i)
-	{
-#if defined(__EXTEND_INVEN_SYSTEM__)
-		if (index >= ch->GetExtendInvenMax())
-#else
-		if (index >= INVENTORY_MAX_NUM)
-#endif
-			break;
-
-		item = ch->GetInventoryItem(index);
-
-		ch->ChatPacket(CHAT_TYPE_INFO, "inventory [%d] = %s", index, item ? item->GetName() : "<NONE>");
-		++index;
-	}
-}
-
-// gift notify quest command
-ACMD(do_gift)
-{
-	ch->ChatPacket(CHAT_TYPE_COMMAND, "gift");
-}
-
-#if !defined(__CUBE_RENEWAL__)
-ACMD(do_cube)
-{
-	if (!ch->CanDoCube())
-		return;
-
-	dev_log(LOG_DEB0, "CUBE COMMAND <%s>: %s", ch->GetName(), argument);
-	int cube_index = 0, inven_index = 0;
-	const char* line;
-
-	char arg1[256], arg2[256], arg3[256];
-
-	line = two_arguments(argument, arg1, sizeof(arg1), arg2, sizeof(arg2));
-	one_argument(line, arg3, sizeof(arg3));
-
-	if (0 == arg1[0])
-	{
-		// print usage
-		ch->ChatPacket(CHAT_TYPE_INFO, "Usage: cube open");
-		ch->ChatPacket(CHAT_TYPE_INFO, "       cube close");
-		ch->ChatPacket(CHAT_TYPE_INFO, "       cube add <inveltory_index>");
-		ch->ChatPacket(CHAT_TYPE_INFO, "       cube delete <cube_index>");
-		ch->ChatPacket(CHAT_TYPE_INFO, "       cube list");
-		ch->ChatPacket(CHAT_TYPE_INFO, "       cube cancel");
-		ch->ChatPacket(CHAT_TYPE_INFO, "       cube make [all]");
-		return;
-	}
-
-	const std::string& strArg1 = std::string(arg1);
-
-	// r_info (request information)
-	// /cube r_info ==> (Client -> Server) ÇöÀç NPC°¡ ¸¸µé ¼ö ÀÖ´Â ·¹½ÃÇÇ ¿äÃ»
-	//					(Server -> Client) /cube r_list npcVNUM resultCOUNT 123,1/125,1/128,1/130,5
-	//
-	// /cube r_info 3 ==> (Client -> Server) ÇöÀç NPC°¡ ¸¸µé¼ö ÀÖ´Â ·¹½ÃÇÇ Áß 3¹øÂ° ¾ÆÀÌÅÛÀ» ¸¸µå´Â µ¥ ÇÊ¿äÇÑ Á¤º¸¸¦ ¿äÃ»
-	// /cube r_info 3 5 ==> (Client -> Server) ÇöÀç NPC°¡ ¸¸µé¼ö ÀÖ´Â ·¹½ÃÇÇ Áß 3¹øÂ° ¾ÆÀÌÅÛºÎÅÍ ÀÌÈÄ 5°³ÀÇ ¾ÆÀÌÅÛÀ» ¸¸µå´Â µ¥ ÇÊ¿äÇÑ Àç·á Á¤º¸¸¦ ¿äÃ»
-	//					(Server -> Client) /cube m_info startIndex count 125,1|126,2|127,2|123,5&555,5&555,4/120000@125,1|126,2|127,2|123,5&555,5&555,4/120000
-	//
-	if (strArg1 == "r_info")
-	{
-		if (0 == arg2[0])
-			Cube_request_result_list(ch);
-		else
-		{
-			if (isdigit(*arg2))
-			{
-				int listIndex = 0, requestCount = 1;
-				str_to_number(listIndex, arg2);
-
-				if (0 != arg3[0] && isdigit(*arg3))
-					str_to_number(requestCount, arg3);
-
-				Cube_request_material_info(ch, listIndex, requestCount);
-			}
-		}
-
-		return;
-	}
-
-	switch (LOWER(arg1[0]))
-	{
-		case 'o': // open
-			Cube_open(ch);
-			break;
-
-		case 'c': // close
-			Cube_close(ch);
-			break;
-
-		case 'l': // list
-			Cube_show_list(ch);
-			break;
-
-		case 'a': // add cue_index inven_index
-		{
-			if (0 == arg2[0] || !isdigit(*arg2) ||
-				0 == arg3[0] || !isdigit(*arg3))
-				return;
-
-			str_to_number(cube_index, arg2);
-			str_to_number(inven_index, arg3);
-			Cube_add_item(ch, cube_index, inven_index);
-		}
-		break;
-
-		case 'd': // delete
-		{
-			if (0 == arg2[0] || !isdigit(*arg2))
-				return;
-
-			str_to_number(cube_index, arg2);
-			Cube_delete_item(ch, cube_index);
-		}
-		break;
-
-		case 'm': // make
-			if (0 != arg2[0])
-			{
-				while (true == Cube_make(ch))
-					dev_log(LOG_DEB0, "cube make success");
-			}
-			else
-				Cube_make(ch);
-			break;
-
-		default:
-			return;
-	}
-}
-#endif
-
-ACMD(do_in_game_mall)
-{
-	if (LC_IsYMIR() == true || LC_IsKorea() == true)
-	{
-		ch->ChatPacket(CHAT_TYPE_COMMAND, "mall http://metin2.co.kr/04_mall/mall/login.htm");
-		return;
-	}
-
-	if (true == LC_IsTaiwan())
-	{
-		ch->ChatPacket(CHAT_TYPE_COMMAND, "mall http://203.69.141.203/mall/mall/item_main.htm");
-		return;
-	}
-
-	if (LC_IsJapan() == true)
-	{
-		ch->ChatPacket(CHAT_TYPE_COMMAND, "mall http://mt2.oge.jp/itemmall/itemList.php");
-		return;
-	}
-
-	if (LC_IsNewCIBN() == true && test_server)
-	{
-		ch->ChatPacket(CHAT_TYPE_COMMAND, "mall http://218.99.6.51/04_mall/mall/login.htm");
-		return;
-	}
-
-	if (LC_IsSingapore() == true)
-	{
-		ch->ChatPacket(CHAT_TYPE_COMMAND, "mall http://www.metin2.sg/ishop.php");
-		return;
-	}
-
-	/*
-	if (LC_IsCanada() == true)
-	{
-		ch->ChatPacket(CHAT_TYPE_COMMAND, "mall http://mall.z8games.com/mall_entry.aspx?tb=m2");
-		return;
-	}
-	*/
-
-	if (LC_IsEurope() == true)
-	{
-		char country_code[3];
-
-		switch (LC_GetLocalType())
-		{
-			case LC_GERMANY: country_code[0] = 'd'; country_code[1] = 'e'; country_code[2] = '\0'; break;
-			case LC_FRANCE: country_code[0] = 'f'; country_code[1] = 'r'; country_code[2] = '\0'; break;
-			case LC_ITALY: country_code[0] = 'i'; country_code[1] = 't'; country_code[2] = '\0'; break;
-			case LC_SPAIN: country_code[0] = 'e'; country_code[1] = 's'; country_code[2] = '\0'; break;
-			case LC_UK: country_code[0] = 'e'; country_code[1] = 'n'; country_code[2] = '\0'; break;
-			case LC_TURKEY: country_code[0] = 't'; country_code[1] = 'r'; country_code[2] = '\0'; break;
-			case LC_POLAND: country_code[0] = 'p'; country_code[1] = 'l'; country_code[2] = '\0'; break;
-			case LC_PORTUGAL: country_code[0] = 'p'; country_code[1] = 't'; country_code[2] = '\0'; break;
-			case LC_GREEK: country_code[0] = 'g'; country_code[1] = 'r'; country_code[2] = '\0'; break;
-			case LC_RUSSIA: country_code[0] = 'r'; country_code[1] = 'u'; country_code[2] = '\0'; break;
-			case LC_DENMARK: country_code[0] = 'd'; country_code[1] = 'k'; country_code[2] = '\0'; break;
-			case LC_BULGARIA: country_code[0] = 'b'; country_code[1] = 'g'; country_code[2] = '\0'; break;
-			case LC_CROATIA: country_code[0] = 'h'; country_code[1] = 'r'; country_code[2] = '\0'; break;
-			case LC_MEXICO: country_code[0] = 'm'; country_code[1] = 'x'; country_code[2] = '\0'; break;
-			case LC_ARABIA: country_code[0] = 'a'; country_code[1] = 'e'; country_code[2] = '\0'; break;
-			case LC_CZECH: country_code[0] = 'c'; country_code[1] = 'z'; country_code[2] = '\0'; break;
-			case LC_ROMANIA: country_code[0] = 'r'; country_code[1] = 'o'; country_code[2] = '\0'; break;
-			case LC_HUNGARY: country_code[0] = 'h'; country_code[1] = 'u'; country_code[2] = '\0'; break;
-			case LC_NETHERLANDS: country_code[0] = 'n'; country_code[1] = 'l'; country_code[2] = '\0'; break;
-			case LC_USA: country_code[0] = 'u'; country_code[1] = 's'; country_code[2] = '\0'; break;
-			case LC_CANADA: country_code[0] = 'c'; country_code[1] = 'a'; country_code[2] = '\0'; break;
-			default:
-			{
-				if (test_server)
-				{
-					country_code[0] = 'u'; country_code[1] = 's'; country_code[2] = '\0';
-				}
-				break;
-			}
-		}
-
-#if defined(__LOCALE_CLIENT__)
-		snprintf(country_code, sizeof(country_code),
-			"%s", LocaleService_GetCountry(ch->GetCountry()));
-#endif
-
-		char buf[512 + 1];
-		char sas[33];
-		MD5_CTX ctx;
-		const char sas_key[] = "GF9001";
-
-		snprintf(buf, sizeof(buf), "%u%u%s", ch->GetPlayerID(), ch->GetAID(), sas_key);
-
-		MD5Init(&ctx);
-		MD5Update(&ctx, (const unsigned char*)buf, strlen(buf));
-#ifdef __FreeBSD__
-		MD5End(&ctx, sas);
-#else
-		static const char hex[] = "0123456789abcdef";
-		unsigned char digest[16];
-		MD5Final(digest, &ctx);
-		int i;
-		for (i = 0; i < 16; ++i)
-		{
-			sas[i + i] = hex[digest[i] >> 4];
-			sas[i + i + 1] = hex[digest[i] & 0x0f];
-		}
-		sas[i + i] = '\0';
-#endif
-
-		snprintf(buf, sizeof(buf), "mall http://%s/ishop?pid=%u&c=%s&sid=%d&sas=%s",
-			g_strWebMallURL.c_str(), ch->GetPlayerID(), country_code, g_server_id, sas);
-
-		ch->ChatPacket(CHAT_TYPE_COMMAND, buf);
-	}
-}
-
-// ÁÖ»çÀ§
-ACMD(do_dice)
-{
-	char arg1[256], arg2[256];
-	int start = 1, end = 100;
-
-	two_arguments(argument, arg1, sizeof(arg1), arg2, sizeof(arg2));
-
-	if (*arg1 && *arg2)
-	{
-		start = atoi(arg1);
-		end = atoi(arg2);
-	}
-	else if (*arg1 && !*arg2)
-	{
-		start = 1;
-		end = atoi(arg1);
-	}
-
-	end = MAX(start, end);
-	start = MIN(start, end);
-
-	int n = number(start, end);
-
-#if defined(__DICE_SYSTEM__)
-	if (ch->GetParty())
-		ch->GetParty()->ChatPacketToAllMember(CHAT_TYPE_INFO, LC_STRING("%s´ÔÀÌ ÁÖ»çÀ§¸¦ ±¼·Á %d°¡ ³ª¿Ô½À´Ï´Ù. (%d-%d)", ch->GetName(), n, start, end));
-	else
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("´ç½ÅÀÌ ÁÖ»çÀ§¸¦ ±¼·Á %d°¡ ³ª¿Ô½À´Ï´Ù. (%d-%d)", n, start, end));
-#else
-	if (ch->GetParty())
-		ch->GetParty()->ChatPacketToAllMember(CHAT_TYPE_INFO, LC_STRING("%s´ÔÀÌ ÁÖ»çÀ§¸¦ ±¼·Á %d°¡ ³ª¿Ô½À´Ï´Ù. (%d-%d)", ch->GetName(), n, start, end));
-	else
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("´ç½ÅÀÌ ÁÖ»çÀ§¸¦ ±¼·Á %d°¡ ³ª¿Ô½À´Ï´Ù. (%d-%d)", n, start, end));
-#endif
-}
-
-ACMD(do_click_mall)
-{
-	ch->ChatPacket(CHAT_TYPE_COMMAND, "ShowMeMallPassword");
-}
-
-ACMD(do_ride)
-{
-	dev_log(LOG_DEB0, "[DO_RIDE] start");
-	if (ch->IsDead() || ch->IsStun())
-		return;
-
-	if (ch->IsFishing())
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot carry out this action while fishing."));
-		return;
-	}
-
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-	if (SECTREE_MANAGER::Instance().IsBlockFilterMapIndex(SECTREE_MANAGER::MOUNT_BLOCK_MAP_INDEX, ch->GetMapIndex()))
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot summon your mount/pet right now."));
-		return;
-	}
-#endif
-
-	if (ch->IsWearingDress())
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot ride while you are wearing a Wedding Dress or a Tuxedo."));
-		return;
-	}
-
-	// ³»¸®±â
-	{
-		if (ch->IsHorseRiding())
-		{
-			dev_log(LOG_DEB0, "[DO_RIDE] stop riding");
-			ch->StopRiding();
-			return;
-		}
-
-		if (ch->GetMountVnum())
-		{
-			dev_log(LOG_DEB0, "[DO_RIDE] unmount");
-			do_unmount(ch, NULL, 0, 0);
-			return;
-		}
-	}
-
-	// Å¸±â
-	{
-		if (ch->GetHorse() != NULL)
-		{
-			dev_log(LOG_DEB0, "[DO_RIDE] start riding");
-			ch->StartRiding();
-			return;
-		}
-
-		for (BYTE i = 0; i < INVENTORY_MAX_NUM; ++i)
-		{
-			LPITEM item = ch->GetInventoryItem(i);
-			if (NULL == item)
-				continue;
-
-			// À¯´ÏÅ© Å»°Í ¾ÆÀÌÅÛ
-			if (item->IsRideItem())
-			{
-				if (NULL == ch->GetWear(WEAR_UNIQUE1)
-					|| NULL == ch->GetWear(WEAR_UNIQUE2)
-#if defined(__MOUNT_COSTUME_SYSTEM__)
-					|| NULL == ch->GetWear(WEAR_COSTUME_MOUNT)
-#endif
-					)
-				{
-					dev_log(LOG_DEB0, "[DO_RIDE] USE UNIQUE ITEM");
-					//ch->EquipItem(item);
-					ch->UseItem(TItemPos(INVENTORY, i));
-					return;
-				}
-			}
-
-			// ÀÏ¹Ý Å»°Í ¾ÆÀÌÅÛ
-			// TODO : Å»°Í¿ë SubType Ãß°¡
-			switch (item->GetVnum())
-			{
-				case 71114: // Àú½ÅÀÌ¿ë±Ç
-				case 71116: // »ê°ß½ÅÀÌ¿ë±Ç
-				case 71118: // ÅõÁö¹üÀÌ¿ë±Ç
-				case 71120: // »çÀÚ¿ÕÀÌ¿ë±Ç
-					dev_log(LOG_DEB0, "[DO_RIDE] USE QUEST ITEM");
-					ch->UseItem(TItemPos(INVENTORY, i));
-					return;
-			}
-
-			// GF mantis #113524, 52001~52090 ¹ø Å»°Í
-			if ((item->GetVnum() > 52000) && (item->GetVnum() < 52091))
-			{
-				dev_log(LOG_DEB0, "[DO_RIDE] USE QUEST ITEM");
-				ch->UseItem(TItemPos(INVENTORY, i));
-				return;
-			}
-		}
-	}
-
-	// Å¸°Å³ª ³»¸± ¼ö ¾øÀ»¶§
-	ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("¸»À» ¸ÕÀú ¼ÒÈ¯ÇØÁÖ¼¼¿ä."));
-}
-
-#if defined(__MOVE_CHANNEL__)
-ACMD(do_move_channel)
-{
-	if (!ch)
-		return;
-
-	if (ch->m_pkTimedEvent)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ãë¼Ò µÇ¾ú½À´Ï´Ù."));
-		event_cancel(&ch->m_pkTimedEvent);
-		return;
-	}
-
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	if (!*arg1)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Usage: channel <new channel>"));
-		return;
-	}
-
-	short channel;
-	str_to_number(channel, arg1);
-
-	if (channel < 1 || channel > 4)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Please enter a valid channel."));
-		return;
-	}
-
-	if (channel == g_bChannel)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You are already on channel %d.", g_bChannel));
-		return;
-	}
-
-	if (g_bChannel == 99)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot change your channel."));
-		return;
-	}
-
-	if (ch->GetDungeon() || ch->GetMapIndex() >= 10000)
-	{
-		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You cannot change your channel."));
-		return;
-	}
-
-	TPacketChangeChannel p;
-	p.iChannel = channel;
-	p.lMapIndex = ch->GetMapIndex();
-
-	db_clientdesc->DBPacket(HEADER_GD_FIND_CHANNEL, ch->GetDesc()->GetHandle(), &p, sizeof(p));
-}
-#endif
-
-#if defined(__POPUP_NOTICE__)
-ACMD(do_popup_notice_check)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	if (!*arg1)
-		return;
-
-	int enable;
-	str_to_number(enable, arg1);
-
-	ch->SetQuestFlag("popup_notice.checkbox", enable);
-}
-#endif
-
-#if defined(__GAME_OPTION_ESCAPE__)
-ACMD(do_escape)
-{
-	if (ch->IsDead() || ch->IsPolymorphed())
-		return;
-
-	if (ch->GetEscapeCooltime() > thecore_pulse() && !ch->IsGM())
-		return;
-
-	const BYTE bEmpire = ch->GetEmpire();
-	const long lMapIndex = ch->GetMapIndex();
-	const PIXEL_POSITION& rkPos = ch->GetXYZ();
-
-	const LPSECTREE_MAP pSectreeMap = SECTREE_MANAGER::instance().GetMap(lMapIndex);
-	if (pSectreeMap == nullptr)
-	{
-		ch->WarpSet(g_start_position[bEmpire][0], g_start_position[bEmpire][1]);
-		return;
-	}
-
-	const LPSECTREE pSectree = pSectreeMap->Find(rkPos.x, rkPos.y);
-	const DWORD dwAttr = pSectree->GetAttribute(rkPos.x, rkPos.y);
-
-	int iEscapeDistance = quest::CQuestManager::instance().GetEventFlag("escape_distance");
-	iEscapeDistance = (iEscapeDistance > 0) ? iEscapeDistance : 300;
-
-	int iEscapeCooltime = quest::CQuestManager::instance().GetEventFlag("escape_cooltime");
-	iEscapeCooltime = (iEscapeCooltime > 0) ? iEscapeCooltime : 10;
-
-	if (IS_SET(dwAttr, ATTR_BLOCK /*| ATTR_OBJECT*/))
-	{
-		/*
-		* NOTE : If an object doesn't have a blocked area, players can still be blocked if they get inside it.
-		* The problem is that bridges are treated as objects too, and we don't want players to use the escape feature through them.
-		* The tricky part is figuring out whether a specific object is a bridge or not.
-		* In the current state, we are only checking blocked areas.
-		*
-		* 20240117.Owsap
-		*/
-
-		PIXEL_POSITION kNewPos;
-		if (SECTREE_MANAGER::instance().GetRandomLocation(lMapIndex, kNewPos, rkPos.x, rkPos.y, iEscapeDistance))
-		{
-			char szBuf[255 + 1];
-			snprintf(szBuf, sizeof(szBuf), "%ld, (%d, %d) -> (%d, %d)",
-				lMapIndex, rkPos.x, rkPos.y, kNewPos.x, kNewPos.y);
-			LogManager::instance().CharLog(ch, lMapIndex, "ESCAPE", szBuf);
-
-			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("You have successfully freed yourself."));
-			ch->Show(lMapIndex, kNewPos.x, kNewPos.y, rkPos.z);
-		}
-		else
-		{
-			char szBuf[255 + 1];
-			snprintf(szBuf, sizeof(szBuf), "%ld, (%d, %d) -> EMPIRE START POSITION",
-				lMapIndex, rkPos.x, rkPos.y);
-			LogManager::instance().CharLog(ch, lMapIndex, "ESCAPE", szBuf);
-
-			ch->WarpSet(g_start_position[bEmpire][0], g_start_position[bEmpire][1]);
-		}
-	}
-
-	ch->SetEscapeCooltime(thecore_pulse() + PASSES_PER_SEC(10));
-}
-#endif
-
-#if defined(__HIDE_COSTUME_SYSTEM__)
-ACMD(do_hide_costume_part)
-{
-	char szArg1[256], szArg2[256];
-	two_arguments(argument, szArg1, sizeof(szArg1), szArg2, sizeof(szArg2));
-
-	if (!*szArg1 || !*szArg2)
-		return;
-
-	BYTE bCostumeSubType = 0, bHidden = 0;
-	str_to_number(bCostumeSubType, szArg1);
-	str_to_number(bHidden, szArg2);
-
-	ch->SetHiddenCostumePart(bCostumeSubType, bHidden);
-}
-#endif
-
-#ifdef __OFFLINE_SHOP__
-ACMD(do_create_offline_shop)
-{
-	if (ch->IsOpeningOfflineShop())
-		return;
-	
-	ch->SetOpeningOfflineShopState(true);
-
-	ch->ChatPacket(CHAT_TYPE_COMMAND, 
-		"StartOpeningOfflineShop %d %d %d %d %d %d %d %d"
-		" %d %d %d %d %d",
-		ch->GetQuestFlag("shop_decoration.shop_skin_0"),
-		ch->GetQuestFlag("shop_decoration.shop_skin_1"),
-		ch->GetQuestFlag("shop_decoration.shop_skin_2"),
-		ch->GetQuestFlag("shop_decoration.shop_skin_3"),
-		ch->GetQuestFlag("shop_decoration.shop_skin_4"),
-		ch->GetQuestFlag("shop_decoration.shop_skin_5"),
-		ch->GetQuestFlag("shop_decoration.shop_skin_6"),
-		ch->GetQuestFlag("shop_decoration.shop_skin_7"),
-		ch->GetQuestFlag("shop_decoration.shop_banner_0"),
-		ch->GetQuestFlag("shop_decoration.shop_banner_1"),
-		ch->GetQuestFlag("shop_decoration.shop_banner_2"),
-		ch->GetQuestFlag("shop_decoration.shop_banner_3"),
-		ch->GetQuestFlag("shop_decoration.shop_banner_4"));
-}
-
-ACMD(do_cancel_opening_offline_shop)
-{
-	if (!ch->IsOpeningOfflineShop()) {
-		return;
-	}
-
-	ch->SetOpeningOfflineShopState(false);
-	if (ch->GetOfflineShopOpeningItem()) {
-		ch->GetOfflineShopOpeningItem()->Lock(false);
-		ch->SetOfflineShopOpeningItem(nullptr);
-	}
-
-	ch->ChatPacket(CHAT_TYPE_COMMAND, "CancelOpeningOfflineShop");
-}
-
-ACMD(do_open_offline_shop)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	if (!*arg1) {
-		return;
-	}
-
-	uint32_t id = std::atoi(arg1);
-
-	auto shopPtr = COfflineShop::Get(id);
-	if (shopPtr) {
-		shopPtr->get()->AddViewer(ch);
-	}
-}
-
-ACMD(do_close_offline_shop)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	if (!*arg1) {
-		return;
-	}
-
-	uint32_t id = std::atoi(arg1);
-
-	auto shopPtr = COfflineShop::Get(id);
-	if (shopPtr) {
-		auto shop = shopPtr->get();
-
-		if (shop->GetOwnerPid() != ch->GetPlayerID()) {
-			return;
-		}
-
-		shop->RequestClose();
-	}
-}
-ACMD(do_sell_history)
-{
-	char arg1[256];
-	one_argument(argument, arg1, sizeof(arg1));
-
-	BYTE bPage = 1;
-	str_to_number(bPage, arg1);
-	
-	if (bPage < 1 || bPage > 10)
-		return;
-	
-	ch->RequestSellHistory(bPage);
-}
-#endif
+#include "stdafx.h"
+#ifdef __FreeBSD__
+#include <md5.h>
+#else
+#include "../../libthecore/include/xmd5.h"
+#endif
+
+#include "utils.h"
+#include "config.h"
+#include "desc_client.h"
+#include "desc_manager.h"
+#include "char.h"
+#include "char_manager.h"
+#include "motion.h"
+#include "packet.h"
+#include "affect.h"
+#include "pvp.h"
+#include "start_position.h"
+#include "party.h"
+#include "guild_manager.h"
+#include "p2p.h"
+#include "dungeon.h"
+#include "messenger_manager.h"
+#include "war_map.h"
+#include "questmanager.h"
+#include "item_manager.h"
+#include "monarch.h"
+#include "mob_manager.h"
+#include "dev_log.h"
+#include "item.h"
+#include "arena.h"
+#include "buffer_manager.h"
+#include "unique_item.h"
+#include "threeway_war.h"
+#include "log.h"
+#include "../../common/VnumHelper.h"
+#if defined(__OFFLINE_SHOP__)
+#include "OfflineShop.h"
+#endif
+#ifdef ENABLE_QUEEN_NETHIS
+#include "SnakeLair.h"
+#endif
+
+extern int g_server_id;
+
+extern int g_nPortalLimitTime;
+
+ACMD(do_dice)
+{
+	// Anti-spam: /dice can be abused to spam chat + packets. Use wrap-safe cooldown tracking.
+	const DWORD DICE_COOLDOWN_MS = 7000;
+	const DWORD dwNow = get_dword_time();
+
+	if ((int)(dwNow - ch->GetLastDiceTime()) < (int)DICE_COOLDOWN_MS)
+	{
+		const int iSecLeft = (int)(((DICE_COOLDOWN_MS - (DWORD)(dwNow - ch->GetLastDiceTime())) + 999) / 1000);
+		ch->ChatPacket(CHAT_TYPE_INFO, "Please wait %d second(s) before using /dice again.", iSecLeft);
+		return;
+	}
+
+	ch->SetLastDiceTime(dwNow);
+
+	const int roll = number(1, 100);
+	ch->ChatPacket(CHAT_TYPE_INFO, "Dice: %d", roll);
+	ch->ChatPacket(CHAT_TYPE_DICE_INFO, "%s rolled %d (1-100).", ch->GetName(), roll);
+}
+
+
+ACMD(do_user_horse_ride)
+{
+	if (ch->IsObserverMode())
+		return;
+
+	if (ch->IsDead() || ch->IsStun())
+		return;
+
+	if (ch->IsHorseRiding() == false)
+	{
+		// ï¿½ï¿½ï¿½ï¿½ ï¿½Æ´ï¿½ ï¿½Ù¸ï¿½Å»ï¿½ï¿½ï¿½ï¿½ Å¸ï¿½ï¿½ï¿½Ö´ï¿½.
+		if (ch->GetMountVnum())
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ï¿½Ì¹ï¿½ Å»ï¿½ï¿½ï¿½ï¿½ ï¿½Ì¿ï¿½ï¿½ï¿½ï¿½Ô´Ï´ï¿½."));
+			return;
+		}
+
+		if (ch->GetHorse() == NULL)
+		{
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½È¯ï¿½ï¿½ï¿½Ö¼ï¿½ï¿½ï¿½."));
+			return;
+		}
+
+		ch->StartRiding();
+	}
+	else
+	{
+		ch->StopRiding();
+	}
+}
+
+ACMD(do_user_horse_back)
+{
+	if (ch->GetHorse() != NULL)
+	{
+		ch->HorseSummon(false);
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Â½ï¿½ï¿½Ï´ï¿½."));
+	}
+	else if (ch->IsHorseRiding() == true)
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½Õ´Ï´ï¿½."));
+	}
+	else
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½È¯ï¿½ï¿½ï¿½Ö¼ï¿½ï¿½ï¿½."));
+	}
+}
+
+ACMD(do_user_horse_feed)
+{
+	// ï¿½ï¿½ï¿½Î»ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ ï¿½ï¿½ï¿½Â¿ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ ï¿½ï¿½ï¿½Ì¸ï¿½ ï¿½ï¿½ ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½.
+	if (ch->GetMyShop())
+		return;
+
+	if (!ch->GetHorse())
+	{
+		if (ch->IsHorseRiding() == false)
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½È¯ï¿½ï¿½ï¿½Ö¼ï¿½ï¿½ï¿½."));
+		else
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ï¿½ï¿½ï¿½ï¿½ Åº ï¿½ï¿½ï¿½Â¿ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½Ì¸ï¿½ ï¿½ï¿½ ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½Ï´ï¿½."));
+		return;
+	}
+
+	DWORD dwFood = ch->GetHorseGrade() + 50054 - 1;
+
+	if (ch->CountSpecifyItem(dwFood) > 0)
+	{
+		ch->RemoveSpecifyItem(dwFood, 1);
+		ch->FeedHorse();
+
+		const char* c_szConv = under_han(ITEM_MANAGER::instance().GetTable(dwFood)->szLocaleName) ? LC_STRING("ï¿½ï¿½") : LC_STRING("ï¿½ï¿½");
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ %s%s ï¿½Ö¾ï¿½ï¿½ï¿½ï¿½Ï´ï¿½.",
+			LC_ITEM(ITEM_MANAGER::instance().GetTable(dwFood)->dwVnum), c_szConv));
+	}
+	else
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%s ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½Ê¿ï¿½ï¿½Õ´Ï´ï¿½", LC_ITEM(ITEM_MANAGER::instance().GetTable(dwFood)->dwVnum)));
+	}
+}
+
+#define MAX_REASON_LEN 128
+
+EVENTINFO(TimedEventInfo)
+{
+	DynamicCharacterPtr ch;
+	int subcmd;
+	int left_second;
+	char szReason[MAX_REASON_LEN];
+
+	TimedEventInfo()
+		: ch()
+		, subcmd(0)
+		, left_second(0)
+	{
+		::memset(szReason, 0, MAX_REASON_LEN);
+	}
+};
+
+struct SendDisconnectFunc
+{
+	void operator () (LPDESC d)
+	{
+		if (d->GetCharacter())
+		{
+			if (d->GetCharacter()->GetGMLevel() == GM_PLAYER)
+				d->GetCharacter()->ChatPacket(CHAT_TYPE_COMMAND, "quit Shutdown(SendDisconnectFunc)");
+		}
+	}
+};
+
+struct DisconnectFunc
+{
+	void operator () (LPDESC d)
+	{
+		if (d->GetType() == DESC_TYPE_CONNECTOR)
+			return;
+
+		if (d->IsPhase(PHASE_P2P))
+			return;
+
+		if (d->GetCharacter())
+			d->GetCharacter()->Disconnect("Shutdown(DisconnectFunc)");
+
+		d->SetPhase(PHASE_CLOSE);
+	}
+};
+
+EVENTINFO(shutdown_event_data)
+{
+	int seconds;
+
+	shutdown_event_data()
+		: seconds(0)
+	{
+	}
+};
+
+EVENTFUNC(shutdown_event)
+{
+	shutdown_event_data* info = dynamic_cast<shutdown_event_data*>(event->info);
+
+	if (info == NULL)
+	{
+		sys_err("shutdown_event> <Factor> Null pointer");
+		return 0;
+	}
+
+	int* pSec = &(info->seconds);
+
+	if (*pSec < 0)
+	{
+		sys_log(0, "shutdown_event sec %d", *pSec);
+
+		if (--*pSec == -10)
+		{
+			const DESC_MANAGER::DESC_SET& c_set_desc = DESC_MANAGER::instance().GetClientSet();
+			std::for_each(c_set_desc.begin(), c_set_desc.end(), DisconnectFunc());
+			return passes_per_sec;
+		}
+		else if (*pSec < -10)
+			return 0;
+
+		return passes_per_sec;
+	}
+	else if (*pSec == 0)
+	{
+		const DESC_MANAGER::DESC_SET& c_set_desc = DESC_MANAGER::instance().GetClientSet();
+		std::for_each(c_set_desc.begin(), c_set_desc.end(), SendDisconnectFunc());
+		g_bNoMoreClient = true;
+		--*pSec;
+		return passes_per_sec;
+	}
+	else
+	{
+		char buf[64];
+		snprintf(buf, sizeof(buf), LC_STRING("ï¿½Ë´Ù¿ï¿½ï¿½ï¿½ %dï¿½ï¿½ ï¿½ï¿½ï¿½Ò½ï¿½ï¿½Ï´ï¿½.", *pSec));
+		SendNotice(buf);
+
+		--*pSec;
+		return passes_per_sec;
+	}
+}
+
+void Shutdown(int iSec)
+{
+	if (g_bNoMoreClient)
+	{
+		thecore_shutdown();
+		return;
+	}
+
+	CWarMapManager::instance().OnShutdown();
+
+	char buf[64];
+	snprintf(buf, sizeof(buf), LC_STRING("%dï¿½ï¿½ ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½Ë´Ù¿ï¿½ ï¿½Ë´Ï´ï¿½.", iSec));
+
+	SendNotice(buf);
+
+	shutdown_event_data* info = AllocEventInfo<shutdown_event_data>();
+	info->seconds = iSec;
+
+	event_create(shutdown_event, info, 1);
+}
+
+ACMD(do_shutdown)
+{
+	TPacketGGShutdown p;
+	p.bHeader = HEADER_GG_SHUTDOWN;
+	P2P_MANAGER::instance().Send(&p, sizeof(TPacketGGShutdown));
+
+	Shutdown(10);
+}
+
+EVENTFUNC(timed_event)
+{
+	TimedEventInfo* info = dynamic_cast<TimedEventInfo*>(event->info);
+
+	if (info == NULL)
+	{
+		sys_err("timed_event> <Factor> Null pointer");
+		return 0;
+	}
+
+	LPCHARACTER ch = info->ch;
+
+	if (ch == NULL) // <Factor>
+		return 0;
+
+	LPDESC d = ch->GetDesc();
+
+	if (info->left_second <= 0)
+	{
+		ch->m_pkTimedEvent = NULL;
+
+		if (true == LC_IsEurope() || true == LC_IsYMIR() || true == LC_IsKorea())
+		{
+			switch (info->subcmd)
+			{
+				case SCMD_LOGOUT:
+				case SCMD_QUIT:
+				case SCMD_PHASE_SELECT:
+#if defined(__LOCALE_CLIENT__)
+				case SCMD_LANGUAGE_CHANGE:
+#endif
+				{
+					TPacketNeedLoginLogInfo acc_info;
+					acc_info.dwPlayerID = ch->GetDesc()->GetAccountTable().id;
+					db_clientdesc->DBPacket(HEADER_GD_VALID_LOGOUT, 0, &acc_info, sizeof(acc_info));
+
+					LogManager::instance().DetailLoginLog(false, ch);
+				}
+				break;
+			}
+		}
+
+		switch (info->subcmd)
+		{
+			case SCMD_LOGOUT:
+				if (d)
+					d->SetPhase(PHASE_CLOSE);
+				break;
+
+			case SCMD_QUIT:
+				ch->ChatPacket(CHAT_TYPE_COMMAND, "quit");
+				break;
+
+			case SCMD_PHASE_SELECT:
+			{
+				ch->Disconnect("timed_event - SCMD_PHASE_SELECT");
+
+				if (d)
+				{
+					d->SetPhase(PHASE_SELECT);
+				}
+			}
+			break;
+
+#if defined(__LOCALE_CLIENT__)
+			case SCMD_LANGUAGE_CHANGE:
+			{
+				ch->ChatPacket(CHAT_TYPE_COMMAND, "language_change");
+				ch->Disconnect("timed_event - SCMD_LANGUAGE_CHANGE");
+
+				if (d)
+					d->SetPhase(PHASE_SELECT);
+			}
+
+			break;
+#endif
+		}
+
+		return 0;
+	}
+	else
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("%dï¿½ï¿½ ï¿½ï¿½ï¿½Ò½ï¿½ï¿½Ï´ï¿½.", info->left_second));
+		--info->left_second;
+	}
+
+	return PASSES_PER_SEC(1);
+}
+
+ACMD(do_cmd)
+{
+	// RECALL_DELAY
+	/*
+	if (ch->m_pkRecallEvent != NULL)
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ï¿½ï¿½ï¿½ ï¿½Ç¾ï¿½ï¿½ï¿½ï¿½Ï´ï¿½."));
+		event_cancel(&ch->m_pkRecallEvent);
+		return;
+	}
+	*/
+	// END_OF_RECALL_DELAY
+
+	if (ch->m_pkTimedEvent)
+	{
+		ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ï¿½ï¿½ï¿½ ï¿½Ç¾ï¿½ï¿½ï¿½ï¿½Ï´ï¿½."));
+		event_cancel(&ch->m_pkTimedEvent);
+		return;
+	}
+
+	switch (subcmd)
+	{
+		case SCMD_LOGOUT:
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ï¿½Î±ï¿½ï¿½ï¿½ È­ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½Ï´ï¿½. ï¿½ï¿½Ã¸ï¿½ ï¿½ï¿½Ù¸ï¿½ï¿½ï¿½ï¿½ï¿½."));
+			break;
+
+		case SCMD_QUIT:
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ ï¿½Õ´Ï´ï¿½. ï¿½ï¿½Ã¸ï¿½ ï¿½ï¿½Ù¸ï¿½ï¿½ï¿½ï¿½ï¿½."));
+			break;
+
+		case SCMD_PHASE_SELECT:
+#if defined(__LOCALE_CLIENT__)
+		case SCMD_LANGUAGE_CHANGE:
+#endif
+			ch->ChatPacket(CHAT_TYPE_INFO, LC_STRING("Ä³ï¿½ï¿½ï¿½Í¸ï¿½ ï¿½ï¿½È¯ ï¿½Õ´Ï´ï¿½. ï¿½ï¿½Ã¸ï¿½ ï¿½ï¿½Ù¸ï¿½ï¿½ï¿½ï¿½ï¿½."));
+			break;
+	}
+
+	int nExitLimitTime = 10;
+
+	if (ch->IsHack(false, true, nExitLimitTime) &&
+		false == CThreeWayWar::instance().IsSungZiMapIndex(ch->GetMapIndex()) &&
+		(!ch->GetWarMap() || ch->GetWarMap()->GetType() == GUILD_WAR_TYPE_FLAG))
+	{
+		return;
+	}
+
+	switch (subcmd)
+	{
+		case SCMD_LOGOUT:
+		case SCMD_QUIT:
+		case SCMD_PHASE_SELECT:
+#if defined(__LOCALE_CLIENT__)
+		case SCMD_LANGUAGE_CHANGE:
+#endif
+		{
+			TimedEventInfo* info = AllocEventInfo<TimedEventInfo>();
+
+			{
+				if (ch->IsPosition(POS_FIGHTING))
+					info->left_second = 10;
+				else
+					info->left_second = 3;
+			}
+
+			info->ch = ch;
+			info->subcmd = subcmd;
+			strlcpy(info->szReason, argument, sizeof(info->szReason));
+
+			ch->m_pkTimedEvent = event_create(timed_event, info, 1);
+		}
+		break;
+	}
+}
+
+ACMD(do_mount)
+{
+	/*
+	char arg1[256];
+	struct action_mount_param param;
+
+	// ï¿½Ì¹ï¿½ Å¸ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
+	if (ch->GetMountingChr())
+	{
+		char arg2[256];
+		
\ No newline at end of file
