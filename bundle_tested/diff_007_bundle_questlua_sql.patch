--- a/server/metin2/Source/Server/game/src/minigame_catchking.cpp
+++ b/server/metin2/Source/Server/game/src/minigame_catchking.cpp
@@ -512,10 +512,13 @@
 	if (!pkChar->GetDesc())

 		return;

 

+	char szNameEsc[(CHARACTER_NAME_MAX_LEN + 1) * 2 + 1];

+	DBManager::instance().EscapeString(szNameEsc, sizeof(szNameEsc), pkChar->GetName(), strlen(pkChar->GetName()));

+

 	char querySelect[256];

 

 	snprintf(querySelect, sizeof(querySelect),

-		"SELECT max_score FROM log.catck_king_event WHERE name = '%s' LIMIT 1;", pkChar->GetName());

+		"SELECT max_score FROM log.catck_king_event WHERE name = '%s' LIMIT 1;", szNameEsc);

 

 	std::unique_ptr<SQLMsg> pSelectMsg(DBManager::instance().DirectQuery(querySelect));

 	SQLResult* resSelect = pSelectMsg->Get();

@@ -527,14 +530,14 @@
 		str_to_number(maxScore, row[0]);

 

 		if (dwScore > maxScore)

-			DBManager::instance().DirectQuery("UPDATE log.catck_king_event SET max_score = %d, total_score = total_score + %d WHERE name = '%s';", dwScore, dwScore, pkChar->GetName());

+			DBManager::instance().DirectQuery("UPDATE log.catck_king_event SET max_score = %d, total_score = total_score + %d WHERE name = '%s';", dwScore, dwScore, szNameEsc);

 		else

-			DBManager::instance().DirectQuery("UPDATE log.catck_king_event SET total_score = total_score + %d WHERE name = '%s';", dwScore, pkChar->GetName());

+			DBManager::instance().DirectQuery("UPDATE log.catck_king_event SET total_score = total_score + %d WHERE name = '%s';", dwScore, szNameEsc);

 	}

 	else

 	{

 		DBManager::instance().DirectQuery("REPLACE INTO log.catck_king_event (name, empire, max_score, total_score) VALUES ('%s', %d, %d, %d);",

-			pkChar->GetName(), pkChar->GetEmpire(), dwScore, dwScore);

+			szNameEsc, pkChar->GetEmpire(), dwScore, dwScore);

 	}

 }

 


--- a/server/metin2/Source/Server/game/src/minigame_roulette.cpp
+++ b/server/metin2/Source/Server/game/src/minigame_roulette.cpp
@@ -1,3 +1,20 @@
+#include <cstdarg>

+

+static bool SafeAppendQuery(char* buf, size_t cap, size_t& len, const char* fmt, ...)

+{

+	if (!buf || cap == 0 || len >= cap)

+		return false;

+	va_list ap;

+	va_start(ap, fmt);

+	int n = vsnprintf(buf + len, cap - len, fmt, ap);

+	va_end(ap);

+	if (n < 0)

+		return false;

+	if ((size_t)n >= cap - len)

+		return false;

+	len += (size_t)n;

+	return true;

+}

 /**

 * Filename: minigame_roulette.cpp

 * Author: Owsap

@@ -19,6 +36,24 @@
 #include "utils.h"

 #include "db.h"

 #include "log.h"

+#include <cstdarg>

+

+// Safe query builder: prevents buffer overflows when composing SQL.

+static bool SafeAppendQuery(char* buf, size_t bufSize, int& len, const char* fmt, ...)

+{

+	if (!buf || bufSize == 0 || len < 0 || (size_t)len >= bufSize)

+		return false;

+	va_list args;

+	va_start(args, fmt);

+	const int written = vsnprintf(buf + len, bufSize - (size_t)len, fmt, args);

+	va_end(args);

+	if (written < 0)

+		return false;

+	if ((size_t)written >= bufSize - (size_t)len)

+		return false;

+	len += written;

+	return true;

+}

 

 #if defined(__MAILBOX__)

 #	include "MailBox.h"

@@ -397,11 +432,14 @@
 	char szQuery[2048 + 1];

 	int iLen = 0;

 

-	iLen += sprintf(szQuery + iLen, "SELECT `player`.`name`, `score` FROM `minigame_roulette%s` ", get_table_postfix());

-	iLen += sprintf(szQuery + iLen,

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "SELECT `player`.`name`, `score` FROM `minigame_roulette%s` ", get_table_postfix()))

+		return;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen,

 		"LEFT JOIN (SELECT `id`, `name` AS `name` FROM `player%s`) AS `player` ON `player`.`id` = `minigame_roulette%s`.`pid` ",

-		get_table_postfix(), get_table_postfix());

-	iLen += sprintf(szQuery + iLen, "ORDER BY `score` DESC LIMIT 10");

+		get_table_postfix(), get_table_postfix()))

+		return;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "ORDER BY `score` DESC LIMIT 10"))

+		return;

 

 	std::unique_ptr<SQLMsg> pMsg(DBManager::instance().DirectQuery(szQuery));

 	const SQLResult* pRes = pMsg->Get();

@@ -439,8 +477,9 @@
 	char szQuery[2048 + 1];

 	int iLen = 0;

 

-	iLen += sprintf(szQuery + iLen,

-		"SELECT `score` FROM `minigame_roulette%s` WHERE `pid` = %u ", get_table_postfix(), dwPID);

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen,

+		"SELECT `score` FROM `minigame_roulette%s` WHERE `pid` = %u ", get_table_postfix(), dwPID))

+		return 0;

 

 	std::unique_ptr<SQLMsg> pMsg(DBManager::instance().DirectQuery(szQuery));

 	const SQLResult* pRes = pMsg->Get();

@@ -767,9 +806,13 @@
 void CMiniGameRoulette::UpdateMyScore(DWORD dwPID)

 {

 	char szQuery[2048 + 1];

-	int iLen = sprintf(szQuery, "INSERT INTO `minigame_roulette%s` (`pid`, `score`, `last_play`) ", get_table_postfix());

-	iLen += sprintf(szQuery + iLen, "VALUES (%u, %u, FROM_UNIXTIME(%d)) ", dwPID, m_iSoulCount, std::time(nullptr));

-	iLen += sprintf(szQuery + iLen, "ON DUPLICATE KEY UPDATE `score` = `score` + %d", m_iSoulCount);

+	int iLen = 0;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "INSERT INTO `minigame_roulette%s` (`pid`, `score`, `last_play`) ", get_table_postfix()))

+		return;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "VALUES (%u, %u, FROM_UNIXTIME(%d)) ", dwPID, m_iSoulCount, std::time(nullptr)))

+		return;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "ON DUPLICATE KEY UPDATE `score` = `score` + %d", m_iSoulCount))

+		return;

 	DBManager::instance().DirectQuery(szQuery);

 }

 #endif // __SUMMER_EVENT_ROULETTE__


--- a/server/metin2/Source/Server/game/src/minigame_rumi.cpp
+++ b/server/metin2/Source/Server/game/src/minigame_rumi.cpp
@@ -1,3 +1,23 @@
+#include <cstdarg>

+

+static bool SafeAppendQuery(char* buf, size_t cap, size_t& len, const char* fmt, ...)

+{

+	if (!buf || cap == 0 || len >= cap)

+		return false;

+	va_list ap;

+	va_start(ap, fmt);

+	int n = vsnprintf(buf + len, cap - len, fmt, ap);

+	va_end(ap);

+	if (n < 0)

+		return false;

+	if ((size_t)n >= cap - len)

+	{

+		// would overflow/truncate; abort building query

+		return false;

+	}

+	len += (size_t)n;

+	return true;

+}

 /**

 * Filename: minigame_rumi.cpp

 * Author: Owsap

@@ -15,6 +35,24 @@
 #include "char_manager.h"

 #include "sectree_manager.h"

 #include "questmanager.h"

+#include <cstdarg>

+

+// Safe query builder: prevents buffer overflows when composing SQL.

+static bool SafeAppendQuery(char* buf, size_t bufSize, int& len, const char* fmt, ...)

+{

+	if (!buf || bufSize == 0 || len < 0 || (size_t)len >= bufSize)

+		return false;

+	va_list args;

+	va_start(args, fmt);

+	const int written = vsnprintf(buf + len, bufSize - (size_t)len, fmt, args);

+	va_end(args);

+	if (written < 0)

+		return false;

+	if ((size_t)written >= bufSize - (size_t)len)

+		return false;

+	len += written;

+	return true;

+}

 

 CMiniGameRumi::CMiniGameRumi(LPCHARACTER pChar) : m_pChar(pChar)

 {

@@ -280,11 +318,17 @@
 void CMiniGameRumi::UpdateMyScore(DWORD dwPID)

 {

 	char szQuery[2048 + 1];

-	int iLen = sprintf(szQuery, "INSERT INTO `minigame_rumi%s` (`pid`, `best_score`, `total_score`, `last_play`) ", get_table_postfix());

-	iLen += sprintf(szQuery + iLen, "VALUES (%u, %u, %u, FROM_UNIXTIME(%d)) ", dwPID, m_wScore, m_wScore, std::time(nullptr));

-	iLen += sprintf(szQuery + iLen, "ON DUPLICATE KEY UPDATE ");

-	iLen += sprintf(szQuery + iLen, "`total_score` = `total_score` + %d, ", m_wScore);

-	iLen += sprintf(szQuery + iLen, "`best_score` = if (%d > `best_score`, %d, `best_score`) ", m_wScore, m_wScore);

+	int iLen = 0;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "INSERT INTO `minigame_rumi%s` (`pid`, `best_score`, `total_score`, `last_play`) ", get_table_postfix()))

+		return;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "VALUES (%u, %u, %u, FROM_UNIXTIME(%d)) ", dwPID, m_wScore, m_wScore, std::time(nullptr)))

+		return;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "ON DUPLICATE KEY UPDATE "))

+		return;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "`total_score` = `total_score` + %d, ", m_wScore))

+		return;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "`best_score` = if (%d > `best_score`, %d, `best_score`) ", m_wScore, m_wScore))

+		return;

 	DBManager::instance().DirectQuery(szQuery);

 }

 

@@ -716,13 +760,20 @@
 	char szQuery[2048 + 1];

 	int iLen = 0;

 

-	iLen += sprintf(szQuery + iLen, "SELECT ");

-	iLen += sprintf(szQuery + iLen, "`player`.`name`, ");

-	iLen += bTotal ? sprintf(szQuery + iLen, "`total_score` ") : sprintf(szQuery + iLen, "`best_score` ");

-	iLen += sprintf(szQuery + iLen, "FROM `minigame_rumi` ");

-	iLen += sprintf(szQuery + iLen, "LEFT JOIN (SELECT `id`, `name` AS `name` FROM `player`) AS `player` ON `player`.`id` = `minigame_rumi`.`pid` ");

-	iLen += bTotal ? sprintf(szQuery + iLen, "ORDER BY `total_score` DESC ") : sprintf(szQuery + iLen, "ORDER BY `best_score` DESC ");

-	iLen += sprintf(szQuery + iLen, "LIMIT 10 ");

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "SELECT "))

+		return;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "`player`.`name`, "))

+		return;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, bTotal ? "`total_score` " : "`best_score` "))

+		return;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "FROM `minigame_rumi` "))

+		return;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "LEFT JOIN (SELECT `id`, `name` AS `name` FROM `player`) AS `player` ON `player`.`id` = `minigame_rumi`.`pid` "))

+		return;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, bTotal ? "ORDER BY `total_score` DESC " : "ORDER BY `best_score` DESC "))

+		return;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "LIMIT 10 "))

+		return;

 

 	if (iLen >= sizeof(szQuery))

 		return;

@@ -766,9 +817,12 @@
 	char szQuery[2048 + 1];

 	int iLen = 0;

 

-	iLen += sprintf(szQuery + iLen, "SELECT ");

-	iLen += bTotal ? sprintf(szQuery + iLen, "`total_score` ") : sprintf(szQuery + iLen, "`best_score` ");

-	iLen += sprintf(szQuery + iLen, "FROM `minigame_rumi` WHERE `pid` = %u ", dwPID);

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "SELECT "))

+		return 0;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, bTotal ? "`total_score` " : "`best_score` "))

+		return 0;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "FROM `minigame_rumi` WHERE `pid` = %u ", dwPID))

+		return 0;

 

 	std::unique_ptr<SQLMsg> pMsg(DBManager::instance().DirectQuery(szQuery));

 	const SQLResult* pkRes = pMsg->Get();


--- a/server/metin2/Source/Server/game/src/minigame_yutnori.cpp
+++ b/server/metin2/Source/Server/game/src/minigame_yutnori.cpp
@@ -1,3 +1,20 @@
+#include <cstdarg>

+

+static bool SafeAppendQuery(char* buf, size_t cap, size_t& len, const char* fmt, ...)

+{

+	if (!buf || cap == 0 || len >= cap)

+		return false;

+	va_list ap;

+	va_start(ap, fmt);

+	int n = vsnprintf(buf + len, cap - len, fmt, ap);

+	va_end(ap);

+	if (n < 0)

+		return false;

+	if ((size_t)n >= cap - len)

+		return false;

+	len += (size_t)n;

+	return true;

+}

 /**

 * Filename: minigame_yutnori.cpp

 * Author: Owsap

@@ -16,6 +33,24 @@
 #include "unique_item.h"

 #include "db.h"

 #include "config.h"

+#include <cstdarg>

+

+// Safe query builder: prevents buffer overflows when composing SQL.

+static bool SafeAppendQuery(char* buf, size_t bufSize, int& len, const char* fmt, ...)

+{

+	if (!buf || bufSize == 0 || len < 0 || (size_t)len >= bufSize)

+		return false;

+	va_list args;

+	va_start(args, fmt);

+	const int written = vsnprintf(buf + len, bufSize - (size_t)len, fmt, args);

+	va_end(args);

+	if (written < 0)

+		return false;

+	if ((size_t)written >= bufSize - (size_t)len)

+		return false;

+	len += written;

+	return true;

+}

 

 CMiniGameYutnori::CMiniGameYutnori(LPCHARACTER pChar) : m_pChar(pChar)

 {

@@ -847,11 +882,17 @@
 void CMiniGameYutnori::__UpdateMyScore(DWORD dwPID)

 {

 	char szQuery[2048 + 1];

-	int iLen = sprintf(szQuery, "INSERT INTO `player`.`minigame_yutnori` (`pid`, `best_score`, `total_score`, `last_play`) ");

-	iLen += sprintf(szQuery + iLen, "VALUES (%u, %u, %u, FROM_UNIXTIME(%d)) ", dwPID, m_wScore, m_wScore, std::time(nullptr));

-	iLen += sprintf(szQuery + iLen, "ON DUPLICATE KEY UPDATE ");

-	iLen += sprintf(szQuery + iLen, "`total_score` = `total_score` + %d,", m_wScore);

-	iLen += sprintf(szQuery + iLen, "`best_score` = if (%d > `best_score`, %d, `best_score`) ", m_wScore, m_wScore);

+	int iLen = 0;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "INSERT INTO `player`.`minigame_yutnori` (`pid`, `best_score`, `total_score`, `last_play`) "))

+		return;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "VALUES (%u, %u, %u, FROM_UNIXTIME(%d)) ", dwPID, m_wScore, m_wScore, std::time(nullptr)))

+		return;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "ON DUPLICATE KEY UPDATE "))

+		return;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "`total_score` = `total_score` + %d,", m_wScore))

+		return;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "`best_score` = if (%d > `best_score`, %d, `best_score`) ", m_wScore, m_wScore))

+		return;

 	std::unique_ptr<SQLMsg> pMsg(DBManager::instance().DirectQuery(szQuery));

 }

 

@@ -1048,13 +1089,20 @@
 	char szQuery[2048 + 1];

 	int iLen = 0;

 

-	iLen += sprintf(szQuery + iLen, "SELECT ");

-	iLen += sprintf(szQuery + iLen, " `player`.`name`, ");

-	iLen += bTotal ? sprintf(szQuery + iLen, "`total_score` ") : sprintf(szQuery + iLen, "`best_score` ");

-	iLen += sprintf(szQuery + iLen, "FROM `minigame_yutnori` ");

-	iLen += sprintf(szQuery + iLen, "LEFT JOIN (SELECT `id`, `name` AS `name` FROM `player`) AS `player` ON `player`.`id` = `minigame_yutnori`.`pid` ");

-	iLen += bTotal ? sprintf(szQuery + iLen, "ORDER BY `total_score` DESC ") : sprintf(szQuery + iLen, "ORDER BY `best_score` DESC ");

-	iLen += sprintf(szQuery + iLen, "LIMIT 10 ");

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "SELECT "))

+		return;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, " `player`.`name`, "))

+		return;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, bTotal ? "`total_score` " : "`best_score` "))

+		return;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "FROM `minigame_yutnori` "))

+		return;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "LEFT JOIN (SELECT `id`, `name` AS `name` FROM `player`) AS `player` ON `player`.`id` = `minigame_yutnori`.`pid` "))

+		return;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, bTotal ? "ORDER BY `total_score` DESC " : "ORDER BY `best_score` DESC "))

+		return;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "LIMIT 10 "))

+		return;

 

 	std::unique_ptr<SQLMsg> pMsg(DBManager::instance().DirectQuery(szQuery));

 	const SQLResult* pkRes = pMsg->Get();

@@ -1092,9 +1140,12 @@
 	char szQuery[2048 + 1];

 	int iLen = 0;

 

-	iLen += sprintf(szQuery + iLen, "SELECT");

-	iLen += bTotal ? sprintf(szQuery + iLen, "`total_score` ") : sprintf(szQuery + iLen, "`best_score` ");

-	iLen += sprintf(szQuery + iLen, "FROM `minigame_yutnori` WHERE `pid` = %u", dwPID);

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "SELECT"))

+		return 0;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, bTotal ? "`total_score` " : "`best_score` "))

+		return 0;

+	if (!SafeAppendQuery(szQuery, sizeof(szQuery), iLen, "FROM `minigame_yutnori` WHERE `pid` = %u", dwPID))

+		return 0;

 

 	std::unique_ptr<SQLMsg> pMsg(DBManager::instance().DirectQuery(szQuery));

 	const SQLResult* pkRes = pMsg->Get();


--- a/server/metin2/Source/Server/game/src/questlua.cpp
+++ b/server/metin2/Source/Server/game/src/questlua.cpp
@@ -1,3 +1,14 @@
+static void EscapeLuaSQLString(char* out, size_t outSize, const char* in)

+{

+	if (!out || outSize == 0)

+		return;

+	if (!in)

+	{

+		out[0] = '\0';

+		return;

+	}

+	DBManager::instance().EscapeString(out, outSize, in, strlen(in));

+}

 #include "stdafx.h"

 

 #include <sstream>

@@ -234,12 +245,14 @@
 	{

 		CQuestManager& q = CQuestManager::instance();

 		const char* pszBoardName = lua_tostring(L, 1);

+		char szBoardEsc[512];

+		DBManager::instance().EscapeString(szBoardEsc, pszBoardName ? pszBoardName : "", pszBoardName ? strlen(pszBoardName) : 0);

 		DWORD mypid = q.GetCurrentCharacterPtr()->GetPlayerID();

 		bool bOrder = (int)lua_tonumber(L, 2) != 0 ? true : false;

 

 		DBManager::instance().ReturnQuery(QID_HIGHSCORE_SHOW, mypid, NULL,

 			"SELECT h.pid, p.name, h.value FROM highscore%s as h, player%s as p WHERE h.board = '%s' AND h.pid = p.id ORDER BY h.value %s LIMIT 10",

-			get_table_postfix(), get_table_postfix(), pszBoardName, bOrder ? "DESC" : "");

+			get_table_postfix(), get_table_postfix(), szBoardEsc, bOrder ? "DESC" : "");

 		return 0;

 	}

 

@@ -250,12 +263,14 @@
 		THighscoreRegisterQueryInfo* qi = M2_NEW THighscoreRegisterQueryInfo;

 

 		strlcpy(qi->szBoard, lua_tostring(L, 1), sizeof(qi->szBoard));

+		char szBoardEsc[sizeof(qi->szBoard) * 2 + 1];

+		DBManager::instance().EscapeString(szBoardEsc, qi->szBoard, strnlen(qi->szBoard, sizeof(qi->szBoard)));

 		qi->dwPID = q.GetCurrentCharacterPtr()->GetPlayerID();

 		qi->iValue = (int)lua_tonumber(L, 2);

 		qi->bOrder = (int)lua_tonumber(L, 3);

 

 		DBManager::instance().ReturnQuery(QID_HIGHSCORE_REGISTER, qi->dwPID, qi,

-			"SELECT value FROM highscore%s WHERE board='%s' AND pid=%u", get_table_postfix(), qi->szBoard, qi->dwPID);

+			"SELECT value FROM highscore%s WHERE board='%s' AND pid=%u", get_table_postfix(), szBoardEsc, qi->dwPID);

 		return 1;

 	}

 

@@ -518,7 +533,7 @@
 	}

 

 	/**

-	* @version 05/06/08 Bang2ni - __get_guildid_byname ½ºÅ©¸³Æ® ÇÔ¼ö µî·Ï

+	* @version 05/06/08 Bang2ni - __get_guildid_byname ũƮ Լ 

 	**/

 	bool CQuestManager::InitializeLua()

 	{

@@ -776,7 +791,7 @@
 

 		if (chReply)

 		{

-			// ½Ã°£ Áö³ª¸é ¾Ë¾Æ¼­ ´ÝÈû

+			// ð  ˾Ƽ 

 		}

 

 		if (chWait)

@@ -796,12 +811,12 @@
 

 		sys_log(0, "GotoConfirmState vid %u msg '%s', timeout %d", dwVID, szMsg, iTimeout);

 

-		// 1. »ó´ë¹æ¿¡°Ô È®ÀÎÃ¢ ¶ç¿ò

-		// 2. ³ª¿¡°Ô È®ÀÎ ±â´Ù¸°´Ù°í Ç¥½ÃÇÏ´Â Ã¢ ¶ç¿ò

-		// 3. Å¸ÀÓ¾Æ¿ô ¼³Á¤ (Å¸ÀÓ¾Æ¿ô µÇ¸é »ó´ë¹æ Ã¢ ´Ý°í ³ª¿¡°Ôµµ Ã¢ ´ÝÀ¸¶ó°í º¸³¿)

+		// 1. 濡 Ȯâ 

+		// 2.  Ȯ ٸٰ ǥϴ â 

+		// 3. ŸӾƿ  (ŸӾƿ Ǹ  â ݰ Ե â  )

 

 		// 1

-		// »ó´ë¹æÀÌ ¾ø´Â °æ¿ì´Â ±×³É »ó´ë¹æ¿¡°Ô º¸³»Áö ¾Ê´Â´Ù. Å¸ÀÓ¾Æ¿ô¿¡ ÀÇÇØ¼­ ³Ñ¾î°¡°ÔµÊ

+		//    ׳ 濡  ʴ´. ŸӾƿ ؼ ѾԵ

 		LPCHARACTER ch = CHARACTER_MANAGER::instance().Find(dwVID);

 		if (ch && ch->IsPC())

 		{

@@ -837,7 +852,7 @@
 		AddScript("[INPUT]");

 		SendScript();

 

-		// ½Ã°£ Á¦ÇÑÀ» °Ë

+		// ð  

 		//event_create(input_timeout_event, dwEI, PASSES_PER_SEC(iTimeout));

 	}

 


--- a/server/metin2/Source/Server/game/src/questlua_horse.cpp
+++ b/server/metin2/Source/Server/game/src/questlua_horse.cpp
@@ -68,10 +68,10 @@
 	{

 		LPCHARACTER ch = CQuestManager::instance().GetCurrentCharacterPtr();

 

-		// ¼ÒÈ¯ÇÏ¸é ¸Ö¸®¼­ºÎÅÍ ´Þ·Á¿À´ÂÁö ¿©ºÎ

+		// ȯϸ ָ ޷ 

 		bool bFromFar = lua_isboolean(L, 1) ? lua_toboolean(L, 1) : false;

 

-		// ¼ÒÈ¯¼öÀÇ vnum

+		// ȯ vnum

 		DWORD horseVnum = lua_isnumber(L, 2) ? lua_tonumber(L, 2) : 0;

 

 		const char* name = lua_isstring(L, 3) ? lua_tostring(L, 3) : 0;

@@ -219,10 +219,10 @@
 

 	int horse_set_name(lua_State* L)

 	{

-		// ¸®ÅÏ°ª

-		// 0 : ¼ÒÀ¯ÇÑ ¸»ÀÌ ¾ø´Ù

-		// 1 : Àß¸øµÈ ÀÌ¸§ÀÌ´Ù

-		// 2 : ÀÌ¸§ ¹Ù²Ù±â ¼º°ø

+		// ϰ

+		// 0 :   

+		// 1 : ߸ ̸̴

+		// 2 : ̸ ٲٱ 

 

 		if (!lua_isstring(L, -1)) return 0;

 

@@ -231,6 +231,13 @@
 		if (ch->GetHorseLevel() > 0)

 		{

 			const char* pHorseName = lua_tostring(L, -1);

+

+			// [Security] Prevent format-string / crash vectors (e.g. '%' sequences)

+			if (pHorseName && strchr(pHorseName, '%'))

+			{

+				lua_pushnumber(L, 1);

+				return 1;

+			}

 

 			if (pHorseName == NULL || check_name(pHorseName) == 0)

 			{


--- a/server/metin2/Source/Server/game/src/questlua_pc.cpp
+++ b/server/metin2/Source/Server/game/src/questlua_pc.cpp
@@ -264,15 +264,15 @@
 		int iPulse = thecore_pulse();

 		if ( pkChr->GetExchange() || pkChr->GetMyShop() || pkChr->GetShopOwner() || pkChr->IsOpenSafebox() )

 		{

-			pkChr->ChatPacket( CHAT_TYPE_INFO, LC_STRING("°Å·¡Ã¢,Ã¢°í µîÀ» ¿¬ »óÅÂ¿¡¼­´Â ´Ù¸¥°÷À¸·Î ÀÌµ¿ÇÒ¼ö ¾ø½À´Ï´Ù" ));

+			pkChr->ChatPacket( CHAT_TYPE_INFO, LC_STRING("ŷâ,â   ¿ ٸ ̵Ҽ ϴ" ));

 

 			return;

 		}

 		//PREVENT_PORTAL_AFTER_EXCHANGE

-		//±³È¯ ÈÄ ½Ã°£Ã¼Å©

+		//ȯ  ðüũ

 		if ( iPulse - pkChr->GetExchangeTime() < PASSES_PER_SEC(60) )

 		{

-			pkChr->ChatPacket( CHAT_TYPE_INFO, LC_STRING("°Å·¡ ÈÄ 1ºÐ ÀÌ³»¿¡´Â ´Ù¸¥Áö¿ªÀ¸·Î ÀÌµ¿ ÇÒ ¼ö ¾ø½À´Ï´Ù." ) );

+			pkChr->ChatPacket( CHAT_TYPE_INFO, LC_STRING("ŷ  1 ̳ ٸ ̵   ϴ." ) );

 			return;

 		}

 		//END_PREVENT_PORTAL_AFTER_EXCHANGE

@@ -280,7 +280,7 @@
 		{

 			if ( iPulse - pkChr->GetMyShopTime() < PASSES_PER_SEC(60) )

 			{

-				pkChr->ChatPacket( CHAT_TYPE_INFO, LC_STRING("°Å·¡ ÈÄ 1ºÐ ÀÌ³»¿¡´Â ´Ù¸¥Áö¿ªÀ¸·Î ÀÌµ¿ ÇÒ ¼ö ¾ø½À´Ï´Ù." ) );

+				pkChr->ChatPacket( CHAT_TYPE_INFO, LC_STRING("ŷ  1 ̳ ٸ ̵   ϴ." ) );

 				return;

 			}

 

@@ -727,7 +727,7 @@
 

 		DWORD dwVnum;

 

-		if (lua_isnumber(L, 2)) // ¹øÈ£ÀÎ°æ¿ì ¹øÈ£·Î ÁØ´Ù.

+		if (lua_isnumber(L, 2)) // ȣΰ ȣ ش.

 			dwVnum = (int)lua_tonumber(L, 2);

 		else if (!ITEM_MANAGER::instance().GetVnum(lua_tostring(L, 2), dwVnum))

 		{

@@ -767,7 +767,7 @@
 

 		DWORD dwVnum;

 

-		if (lua_isnumber(L, 1)) // ¹øÈ£ÀÎ°æ¿ì ¹øÈ£·Î ÁØ´Ù.

+		if (lua_isnumber(L, 1)) // ȣΰ ȣ ش.

 		{

 			dwVnum = (int)lua_tonumber(L, 1);

 		}

@@ -887,7 +887,7 @@
 

 		DWORD dwVnum;

 

-		if (lua_isnumber(L, 1)) // ¹øÈ£ÀÎ°æ¿ì ¹øÈ£·Î ÁØ´Ù.

+		if (lua_isnumber(L, 1)) // ȣΰ ȣ ش.

 		{

 			dwVnum = (int)lua_tonumber(L, 1);

 		}

@@ -1152,7 +1152,7 @@
 

 		LPCHARACTER ch = CQuestManager::instance().GetCurrentCharacterPtr();

 

-		if (val > 0) // Áõ°¡½ÃÅ°´Â °ÍÀÌ¹Ç·Î ¹«Á¶°Ç ¼º°ø ¸®ÅÏ

+		if (val > 0) // Ű ̹Ƿ   

 			ch->PointChange(POINT_SP, val);

 		else if (val < 0)

 		{

@@ -1204,17 +1204,17 @@
 			PC* pPC = CQuestManager::instance().GetCurrentPC();

 			LogManager::instance().QuestRewardLog(pPC->GetCurrentQuestName().c_str(), ch->GetPlayerID(), ch->GetLevel(), newLevel, 0);

 

-			// Æ÷ÀÎÆ® : ½ºÅ³, ¼­ºê½ºÅ³, ½ºÅÈ

+			// Ʈ : ų, 꽺ų, 

 			ch->PointChange(POINT_SKILL, newLevel - ch->GetLevel());

 			ch->PointChange(POINT_SUB_SKILL, newLevel < 10 ? 0 : newLevel - MAX(ch->GetLevel(), 9));

 			ch->PointChange(POINT_STAT, ((MINMAX(1, newLevel, gPlayerMaxLevel) - ch->GetLevel()) * 3) + ch->GetPoint(POINT_LEVEL_STEP));

-			//·¹º§

+			//

 			ch->PointChange(POINT_LEVEL, newLevel - ch->GetLevel(), false, true);

 			//HP, SP

 			ch->SetRandomHP((newLevel - 1) * number(JobInitialPoints[ch->GetJob()].hp_per_lv_begin, JobInitialPoints[ch->GetJob()].hp_per_lv_end));

 			ch->SetRandomSP((newLevel - 1) * number(JobInitialPoints[ch->GetJob()].sp_per_lv_begin, JobInitialPoints[ch->GetJob()].sp_per_lv_end));

 

-			// È¸º¹

+			// ȸ

 			ch->PointChange(POINT_HP, ch->GetMaxHP() - ch->GetHP());

 			ch->PointChange(POINT_SP, ch->GetMaxSP() - ch->GetSP());

 

@@ -1292,8 +1292,8 @@
 	}

 #endif

 

-	// 20050725.myevan.ÀºµÐÀÇ ¸ÁÅä »ç¿ëÁß È¥¼® ¼ö·Ã½Ã ¼±¾ÇÄ¡°¡ µÎ¹è ¼Ò¸ðµÇ´Â ¹ö±×°¡ ¹ß»ýÇØ

-	// ½ÇÁ¦ ¼±¾ÇÄ¡¸¦ ÀÌ¿ëÇØ °è»êÀ» ÇÏ°Ô ÇÑ´Ù.

+	// 20050725.myevan.   ȥ ý ġ ι ҸǴ װ ߻

+	//  ġ ̿  ϰ Ѵ.

 	int pc_get_real_alignment(lua_State* L)

 	{

 		lua_pushnumber(L, CQuestManager::instance().GetCurrentCharacterPtr()->GetRealAlignment() / 10);

@@ -1668,7 +1668,7 @@
 		ch->RemoveAffect(AFFECT_MOUNT);

 		ch->RemoveAffect(AFFECT_MOUNT_BONUS);

 

-		// ¸»ÀÌ ¼ÒÈ¯µÇ¾î µû¶ó´Ù´Ï´Â »óÅÂ¶ó¸é ¸»ºÎÅÍ ¾ø¾Ú

+		//  ȯǾ ٴϴ ¶  

 		if (ch->GetHorse())

 			ch->HorseSummon(false);

 

@@ -1946,7 +1946,7 @@
 

 		if (pct == 100 || number(1, 100) <= pct)

 		{

-			// °³·® ¼º°ø

+			//  

 			lua_pushboolean(L, 1);

 

 			LPITEM pkNewItem = ITEM_MANAGER::instance().CreateItem(item->GetRefinedVnum(), 1, 0, false);

@@ -1986,7 +1986,7 @@
 		}

 		else

 		{

-			// °³·® ½ÇÆÐ

+			//  

 			lua_pushboolean(L, 0);

 		}

 

@@ -2023,7 +2023,7 @@
 		pdw[1] = 1;

 		pdw[2] = q.GetEventFlag("lotto_round");

 

-		// ÃßÃ·¼­´Â ¼ÒÄÏÀ» ¼³Á¤ÇÑ´Ù

+		// ÷  Ѵ

 		DBManager::instance().ReturnQuery(QID_LOTTO, ch->GetPlayerID(), pdw,

 			"INSERT INTO lotto_list VALUES(0, 'server%s', %u, NOW())",

 			get_table_postfix(), ch->GetPlayerID());

@@ -2272,14 +2272,14 @@
 		return 0;

 	}

 

-	//ÅÚ·¹Æ÷Æ®

+	//ڷƮ

 	int pc_teleport(lua_State* L)

 	{

 		LPCHARACTER ch = CQuestManager::instance().GetCurrentCharacterPtr();

 		int x = 0, y = 0;

 		if (lua_isnumber(L, 1))

 		{

-			// Áö¿ª¸í ¿öÇÁ

+			//  

 			const int TOWN_NUM = 10;

 			struct warp_by_town_name

 			{

@@ -2288,16 +2288,16 @@
 				DWORD y;

 			} ws[TOWN_NUM] =

 			{

-				{ "¿µ¾ÈÀ¾¼º", 4743, 9548 },

-				{ "ÀÓÁö°î", 3235, 9086 },

-				{ "ÀÚ¾çÇö", 3531, 8829 },

-				{ "Á¶¾ÈÀ¾¼º", 638, 1664 },

-				{ "½Â·æ°î", 1745, 1909 },

-				{ "º¹Á¤Çö", 1455, 2400 },

-				{ "Æò¹«À¾¼º", 9599, 2692 },

-				{ "¹æ»ê°î", 8036, 2984 },

-				{ "¹Ú¶óÇö", 8639, 2460 },

-				{ "¼­ÇÑ»ê", 4350, 2143 },

+				{ "", 4743, 9548 },

+				{ "", 3235, 9086 },

+				{ "ھ", 3531, 8829 },

+				{ "", 638, 1664 },

+				{ "·", 1745, 1909 },

+				{ "", 1455, 2400 },

+				{ "", 9599, 2692 },

+				{ "", 8036, 2984 },

+				{ "ڶ", 8639, 2460 },

+				{ "ѻ", 4350, 2143 },

 			};

 			int idx = (int)lua_tonumber(L, 1);

 

@@ -2480,13 +2480,13 @@
 

 	int pc_change_name(lua_State* L)

 	{

-		// ¸®ÅÏ°ª

-		// 0 : »õÀÌ¸§À» ¼³Á¤ÇÑ µÚ ·Î±×¾Æ¿ôÀ» ¾ÈÇßÀ½

-		// 1 : ½ºÅ©¸³Æ®¿¡¼­ ¹®ÀÚ¿­ÀÌ ³Ñ¾î¿ÀÁö ¾Ê¾ÒÀ½

-		// 2 : check_name À» Åë°úÇÏÁö ¸øÇßÀ½

-		// 3 : ÀÌ¹Ì °°Àº ÀÌ¸§ÀÌ »ç¿ëÁß

-		// 4 : ¼º°ø

-		// 5 : ÇØ´ç ±â´É Áö¿øÇÏÁö ¾ÊÀ½

+		// ϰ

+		// 0 : ̸   α׾ƿ 

+		// 1 : ũƮ ڿ Ѿ ʾ

+		// 2 : check_name   

+		// 3 : ̹  ̸ 

+		// 4 : 

+		// 5 : ش   

 

 		LPCHARACTER ch = CQuestManager::instance().GetCurrentCharacterPtr();

 

@@ -2504,6 +2504,9 @@
 

 		const char* szName = lua_tostring(L, 1);

 

+	char szNameEsc[(CHARACTER_NAME_MAX_LEN + 1) * 2 + 1];

+	DBManager::instance().EscapeString(szNameEsc, sizeof(szNameEsc), szName ? szName : "", szName ? strlen(szName) : 0);

+

 		if (check_name(szName) == false)

 		{

 			lua_pushnumber(L, 2);

@@ -2511,7 +2514,7 @@
 		}

 

 		char szQuery[1024];

-		snprintf(szQuery, sizeof(szQuery), "SELECT COUNT(*) FROM player%s WHERE name='%s'", get_table_postfix(), szName);

+		snprintf(szQuery, sizeof(szQuery), "SELECT COUNT(*) FROM player%s WHERE name='%s'", get_table_postfix(), szNameEsc);

 		std::unique_ptr<SQLMsg> pmsg(DBManager::instance().DirectQuery(szQuery));

 

 		if (pmsg->Get()->uiNumRows > 0)

@@ -2521,7 +2524,7 @@
 			int count = 0;

 			str_to_number(count, row[0]);

 

-			// ÀÌ¹Ì ÇØ´ç ÀÌ¸§À» °¡Áø Ä³¸¯ÅÍ°¡ ÀÖÀ½

+			// ̹ ش ̸  ĳͰ 

 			if (count != 0)

 			{

 				lua_pushnumber(L, 3);

@@ -2870,8 +2873,8 @@
 

 		int idx = 1;

 

-		// ¿ëÈ¥¼® ½½·ÔÀº ÇÒ ÇÊ¿ä ¾øÀ» µí.

-		// ÀÌ ÇÔ¼ö´Â Å»¼®¼­¿ë ÇÔ¼öÀÎ µí ÇÏ´Ù.

+		// ȥ   ʿ  .

+		//  Լ Ż Լ  ϴ.

 		for (int i = 0; i < WEAR_MAX_NUM; i++)

 		{

 			LPITEM pItem = pChar->GetInventoryItem(i);

@@ -3289,7 +3292,7 @@
 		return 1;

 	}

 

-	int pc_get_informer_type(lua_State* L) // µ¶ÀÏ ¼±¹° ±â´É

+	int pc_get_informer_type(lua_State* L) //   

 	{

 		LPCHARACTER pChar = CQuestManager::instance().GetCurrentCharacterPtr();

 

@@ -3646,8 +3649,8 @@
 				case JOB_SHAMAN:

 				case JOB_WOLFMAN:

 				{

-					// ¹«»ç ¸ö»§ ¼ÂÆÃ.

-					// ÀÌ°Í¸¸ ³ª¿Í ÀÖ¾î¼­ ÀÓ½Ã·Î ¸ðµç Á÷±º ´Ù ÀÌ·± ¼Ó¼º µû¸§.

+					//   .

+					// ̰͸  ־ ӽ÷    ̷ Ӽ .

 					item = ch->GetWear(WEAR_HEAD);

 					if (item != NULL)

 					{

@@ -4081,17 +4084,17 @@
 

 			{ "charge_cash", pc_charge_cash },

 

-			{ "get_informer_type", pc_get_informer_type }, // µ¶ÀÏ ¼±¹° ±â´É

+			{ "get_informer_type", pc_get_informer_type }, //   

 			{ "get_informer_item", pc_get_informer_item },

 

-			{ "give_award", pc_give_award }, // ÀÏº» °èÁ¤´ç ÇÑ¹ø¾¿ ±Ý±« Áö±Þ

-			{ "give_award_socket", pc_give_award_socket }, // ¸ô ÀÎº¥Åä¸®¿¡ ¾ÆÀÌÅÛ Áö±Þ. ¼ÒÄÏ ¼³Á¤À» À§ÇÑ ÇÔ¼ö.

-

-			{ "get_killee_drop_pct", pc_get_killee_drop_pct }, /* mob_vnum.kill ÀÌº¥Æ®¿¡¼­ killee¿Í pc¿ÍÀÇ level Â÷ÀÌ, pcÀÇ ÇÁ¸®¹Ì¾ö µå¶ø·ü µîµîÀ» °í·ÁÇÑ ¾ÆÀÌÅÛ µå¶ø È®·ü.

-			* return °ªÀº (ºÐÀÚ, ºÐ¸ð).

-			* (¸»ÀÌ º¹ÀâÇÑµ¥, CreateDropItemÀÇ GetDropPctÀÇ iDeltaPercent, iRandRange¸¦ returnÇÑ´Ù°í º¸¸é µÊ.)

-			* (ÀÌ ¸»ÀÌ ´õ ¾î·Á¿ï¶ó³ª ¤Ð¤Ð)

-			* ÁÖÀÇ»çÇ× : kill event¿¡¼­¸¸ »ç¿ëÇÒ °Í!

+			{ "give_award", pc_give_award }, // Ϻ  ѹ ݱ 

+			{ "give_award_socket", pc_give_award_socket }, //  κ丮  .    Լ.

+

+			{ "get_killee_drop_pct", pc_get_killee_drop_pct }, /* mob_vnum.kill ̺Ʈ killee pc level , pc ̾      Ȯ.

+			* return  (, и).

+			* ( ѵ, CreateDropItem GetDropPct iDeltaPercent, iRandRange returnѴٰ  .)

+			* (    Ф)

+			* ǻ : kill event  !

 			*/

 

 #if defined(__DICE_SYSTEM__)


